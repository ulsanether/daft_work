var dwcVersion = "1.22.5";
!function(e,t){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=e.document?t(e,!0):function(e){if(!e.document)throw new Error("jQuery requires a window with a document");return t(e)}:t(e)}("undefined"!=typeof window?window:this,function(C,e){"use strict";var t=[],S=C.document,r=Object.getPrototypeOf,s=t.slice,g=t.concat,u=t.push,i=t.indexOf,n={},o=n.toString,h=n.hasOwnProperty,a=h.toString,l=a.call(Object),m={};function DOMEval(e,t){var n=(t=t||S).createElement("script");n.text=e,t.head.appendChild(n).parentNode.removeChild(n)}var c="3.1.0",k=function(e,t){return new k.fn.init(e,t)},f=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,d=/^-ms-/,p=/-([a-z])/g,v=function(e,t){return t.toUpperCase()};function isArrayLike(e){var t=!!e&&"length"in e&&e.length,n=k.type(e);return"function"!==n&&!k.isWindow(e)&&("array"===n||0===t||"number"==typeof t&&0<t&&t-1 in e)}k.fn=k.prototype={jquery:c,constructor:k,length:0,toArray:function(){return s.call(this)},get:function(e){return null!=e?e<0?this[e+this.length]:this[e]:s.call(this)},pushStack:function(e){var t=k.merge(this.constructor(),e);return t.prevObject=this,t},each:function(e){return k.each(this,e)},map:function(n){return this.pushStack(k.map(this,function(e,t){return n.call(e,t,e)}))},slice:function(){return this.pushStack(s.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(e){var t=this.length,n=+e+(e<0?t:0);return this.pushStack(0<=n&&n<t?[this[n]]:[])},end:function(){return this.prevObject||this.constructor()},push:u,sort:t.sort,splice:t.splice},k.extend=k.fn.extend=function(){var e,t,n,r,i,o,a=arguments[0]||{},s=1,u=arguments.length,l=!1;for("boolean"==typeof a&&(l=a,a=arguments[s]||{},s++),"object"==typeof a||k.isFunction(a)||(a={}),s===u&&(a=this,s--);s<u;s++)if(null!=(e=arguments[s]))for(t in e)n=a[t],a!==(r=e[t])&&(l&&r&&(k.isPlainObject(r)||(i=k.isArray(r)))?(o=i?(i=!1,n&&k.isArray(n)?n:[]):n&&k.isPlainObject(n)?n:{},a[t]=k.extend(l,o,r)):void 0!==r&&(a[t]=r));return a},k.extend({expando:"jQuery"+(c+Math.random()).replace(/\D/g,""),isReady:!0,error:function(e){throw new Error(e)},noop:function(){},isFunction:function(e){return"function"===k.type(e)},isArray:Array.isArray,isWindow:function(e){return null!=e&&e===e.window},isNumeric:function(e){var t=k.type(e);return("number"===t||"string"===t)&&!isNaN(e-parseFloat(e))},isPlainObject:function(e){var t,n;return!(!e||"[object Object]"!==o.call(e))&&(!(t=r(e))||"function"==typeof(n=h.call(t,"constructor")&&t.constructor)&&a.call(n)===l)},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},type:function(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?n[o.call(e)]||"object":typeof e},globalEval:function(e){DOMEval(e)},camelCase:function(e){return e.replace(d,"ms-").replace(p,v)},nodeName:function(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()},each:function(e,t){var n,r=0;if(isArrayLike(e))for(n=e.length;r<n&&!1!==t.call(e[r],r,e[r]);r++);else for(r in e)if(!1===t.call(e[r],r,e[r]))break;return e},trim:function(e){return null==e?"":(e+"").replace(f,"")},makeArray:function(e,t){var n=t||[];return null!=e&&(isArrayLike(Object(e))?k.merge(n,"string"==typeof e?[e]:e):u.call(n,e)),n},inArray:function(e,t,n){return null==t?-1:i.call(t,e,n)},merge:function(e,t){for(var n=+t.length,r=0,i=e.length;r<n;r++)e[i++]=t[r];return e.length=i,e},grep:function(e,t,n){for(var r=[],i=0,o=e.length,a=!n;i<o;i++)!t(e[i],i)!==a&&r.push(e[i]);return r},map:function(e,t,n){var r,i,o=0,a=[];if(isArrayLike(e))for(r=e.length;o<r;o++)null!=(i=t(e[o],o,n))&&a.push(i);else for(o in e)null!=(i=t(e[o],o,n))&&a.push(i);return g.apply([],a)},guid:1,proxy:function(e,t){var n,r,i;if("string"==typeof t&&(n=e[t],t=e,e=n),k.isFunction(e))return r=s.call(arguments,2),(i=function(){return e.apply(t||this,r.concat(s.call(arguments)))}).guid=e.guid=e.guid||k.guid++,i},now:Date.now,support:m}),"function"==typeof Symbol&&(k.fn[Symbol.iterator]=t[Symbol.iterator]),k.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(e,t){n["[object "+t+"]"]=t.toLowerCase()});var y=function(n){var e,p,b,o,i,h,f,g,w,u,l,T,C,a,S,m,s,c,v,k="sizzle"+1*new Date,y=n.document,E=0,r=0,d=createCache(),x=createCache(),A=createCache(),N=function(e,t){return e===t&&(l=!0),0},D={}.hasOwnProperty,t=[],j=t.pop,F=t.push,q=t.push,H=t.slice,L=function(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1},P="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",O="[\\x20\\t\\r\\n\\f]",M="(?:\\\\.|[\\w-]|[^\0-\\xa0])+",z="\\["+O+"*("+M+")(?:"+O+"*([*^$|!~]?=)"+O+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+M+"))|)"+O+"*\\]",I=":("+M+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+z+")*)|.*)\\)|)",R=new RegExp(O+"+","g"),W=new RegExp("^"+O+"+|((?:^|[^\\\\])(?:\\\\.)*)"+O+"+$","g"),$=new RegExp("^"+O+"*,"+O+"*"),B=new RegExp("^"+O+"*([>+~]|"+O+")"+O+"*"),_=new RegExp("="+O+"*([^\\]'\"]*?)"+O+"*\\]","g"),X=new RegExp(I),U=new RegExp("^"+M+"$"),G={ID:new RegExp("^#("+M+")"),CLASS:new RegExp("^\\.("+M+")"),TAG:new RegExp("^("+M+"|[*])"),ATTR:new RegExp("^"+z),PSEUDO:new RegExp("^"+I),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+O+"*(even|odd|(([+-]|)(\\d*)n|)"+O+"*(?:([+-]|)"+O+"*(\\d+)|))"+O+"*\\)|)","i"),bool:new RegExp("^(?:"+P+")$","i"),needsContext:new RegExp("^"+O+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+O+"*((?:-\\d)?\\d*)"+O+"*\\)|)(?=[^-]|$)","i")},V=/^(?:input|select|textarea|button)$/i,Y=/^h\d$/i,Q=/^[^{]+\{\s*\[native \w/,J=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,K=/[+~]/,Z=new RegExp("\\\\([\\da-f]{1,6}"+O+"?|("+O+")|.)","ig"),ee=function(e,t,n){var r="0x"+t-65536;return r!=r||n?t:r<0?String.fromCharCode(r+65536):String.fromCharCode(r>>10|55296,1023&r|56320)},te=/([\0-\x1f\x7f]|^-?\d)|^-$|[^\x80-\uFFFF\w-]/g,ne=function(e,t){return t?"\0"===e?"ï¿½":e.slice(0,-1)+"\\"+e.charCodeAt(e.length-1).toString(16)+" ":"\\"+e},re=function(){T()},ie=addCombinator(function(e){return!0===e.disabled},{dir:"parentNode",next:"legend"});try{q.apply(t=H.call(y.childNodes),y.childNodes),t[y.childNodes.length].nodeType}catch(e){q={apply:t.length?function(e,t){F.apply(e,H.call(t))}:function(e,t){for(var n=e.length,r=0;e[n++]=t[r++];);e.length=n-1}}}function Sizzle(e,t,n,r){var i,o,a,s,u,l,c,f=t&&t.ownerDocument,d=t?t.nodeType:9;if(n=n||[],"string"!=typeof e||!e||1!==d&&9!==d&&11!==d)return n;if(!r&&((t?t.ownerDocument||t:y)!==C&&T(t),t=t||C,S)){if(11!==d&&(u=J.exec(e)))if(i=u[1]){if(9===d){if(!(a=t.getElementById(i)))return n;if(a.id===i)return n.push(a),n}else if(f&&(a=f.getElementById(i))&&v(t,a)&&a.id===i)return n.push(a),n}else{if(u[2])return q.apply(n,t.getElementsByTagName(e)),n;if((i=u[3])&&p.getElementsByClassName&&t.getElementsByClassName)return q.apply(n,t.getElementsByClassName(i)),n}if(p.qsa&&!A[e+" "]&&(!m||!m.test(e))){if(1!==d)f=t,c=e;else if("object"!==t.nodeName.toLowerCase()){for((s=t.getAttribute("id"))?s=s.replace(te,ne):t.setAttribute("id",s=k),o=(l=h(e)).length;o--;)l[o]="#"+s+" "+toSelector(l[o]);c=l.join(","),f=K.test(e)&&testContext(t.parentNode)||t}if(c)try{return q.apply(n,f.querySelectorAll(c)),n}catch(e){}finally{s===k&&t.removeAttribute("id")}}}return g(e.replace(W,"$1"),t,n,r)}function createCache(){var n=[];return function cache(e,t){return n.push(e+" ")>b.cacheLength&&delete cache[n.shift()],cache[e+" "]=t}}function markFunction(e){return e[k]=!0,e}function assert(e){var t=C.createElement("fieldset");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function addHandle(e,t){for(var n=e.split("|"),r=n.length;r--;)b.attrHandle[n[r]]=t}function siblingCheck(e,t){var n=t&&e,r=n&&1===e.nodeType&&1===t.nodeType&&e.sourceIndex-t.sourceIndex;if(r)return r;if(n)for(;n=n.nextSibling;)if(n===t)return-1;return e?1:-1}function createInputPseudo(t){return function(e){return"input"===e.nodeName.toLowerCase()&&e.type===t}}function createButtonPseudo(n){return function(e){var t=e.nodeName.toLowerCase();return("input"===t||"button"===t)&&e.type===n}}function createDisabledPseudo(t){return function(e){return"label"in e&&e.disabled===t||"form"in e&&e.disabled===t||"form"in e&&!1===e.disabled&&(e.isDisabled===t||e.isDisabled!==!t&&("label"in e||!ie(e))!==t)}}function createPositionalPseudo(a){return markFunction(function(o){return o=+o,markFunction(function(e,t){for(var n,r=a([],e.length,o),i=r.length;i--;)e[n=r[i]]&&(e[n]=!(t[n]=e[n]))})})}function testContext(e){return e&&void 0!==e.getElementsByTagName&&e}for(e in p=Sizzle.support={},i=Sizzle.isXML=function(e){var t=e&&(e.ownerDocument||e).documentElement;return!!t&&"HTML"!==t.nodeName},T=Sizzle.setDocument=function(e){var t,n,r=e?e.ownerDocument||e:y;return r!==C&&9===r.nodeType&&r.documentElement&&(a=(C=r).documentElement,S=!i(C),y!==C&&(n=C.defaultView)&&n.top!==n&&(n.addEventListener?n.addEventListener("unload",re,!1):n.attachEvent&&n.attachEvent("onunload",re)),p.attributes=assert(function(e){return e.className="i",!e.getAttribute("className")}),p.getElementsByTagName=assert(function(e){return e.appendChild(C.createComment("")),!e.getElementsByTagName("*").length}),p.getElementsByClassName=Q.test(C.getElementsByClassName),p.getById=assert(function(e){return a.appendChild(e).id=k,!C.getElementsByName||!C.getElementsByName(k).length}),p.getById?(b.find.ID=function(e,t){if(void 0!==t.getElementById&&S){var n=t.getElementById(e);return n?[n]:[]}},b.filter.ID=function(e){var t=e.replace(Z,ee);return function(e){return e.getAttribute("id")===t}}):(delete b.find.ID,b.filter.ID=function(e){var n=e.replace(Z,ee);return function(e){var t=void 0!==e.getAttributeNode&&e.getAttributeNode("id");return t&&t.value===n}}),b.find.TAG=p.getElementsByTagName?function(e,t){return void 0!==t.getElementsByTagName?t.getElementsByTagName(e):p.qsa?t.querySelectorAll(e):void 0}:function(e,t){var n,r=[],i=0,o=t.getElementsByTagName(e);if("*"!==e)return o;for(;n=o[i++];)1===n.nodeType&&r.push(n);return r},b.find.CLASS=p.getElementsByClassName&&function(e,t){if(void 0!==t.getElementsByClassName&&S)return t.getElementsByClassName(e)},s=[],m=[],(p.qsa=Q.test(C.querySelectorAll))&&(assert(function(e){a.appendChild(e).innerHTML="<a id='"+k+"'></a><select id='"+k+"-\r\\' msallowcapture=''><option selected=''></option></select>",e.querySelectorAll("[msallowcapture^='']").length&&m.push("[*^$]="+O+"*(?:''|\"\")"),e.querySelectorAll("[selected]").length||m.push("\\["+O+"*(?:value|"+P+")"),e.querySelectorAll("[id~="+k+"-]").length||m.push("~="),e.querySelectorAll(":checked").length||m.push(":checked"),e.querySelectorAll("a#"+k+"+*").length||m.push(".#.+[+~]")}),assert(function(e){e.innerHTML="<a href='' disabled='disabled'></a><select disabled='disabled'><option/></select>";var t=C.createElement("input");t.setAttribute("type","hidden"),e.appendChild(t).setAttribute("name","D"),e.querySelectorAll("[name=d]").length&&m.push("name"+O+"*[*^$|!~]?="),2!==e.querySelectorAll(":enabled").length&&m.push(":enabled",":disabled"),a.appendChild(e).disabled=!0,2!==e.querySelectorAll(":disabled").length&&m.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),m.push(",.*:")})),(p.matchesSelector=Q.test(c=a.matches||a.webkitMatchesSelector||a.mozMatchesSelector||a.oMatchesSelector||a.msMatchesSelector))&&assert(function(e){p.disconnectedMatch=c.call(e,"*"),c.call(e,"[s!='']:x"),s.push("!=",I)}),m=m.length&&new RegExp(m.join("|")),s=s.length&&new RegExp(s.join("|")),t=Q.test(a.compareDocumentPosition),v=t||Q.test(a.contains)?function(e,t){var n=9===e.nodeType?e.documentElement:e,r=t&&t.parentNode;return e===r||!(!r||1!==r.nodeType||!(n.contains?n.contains(r):e.compareDocumentPosition&&16&e.compareDocumentPosition(r)))}:function(e,t){if(t)for(;t=t.parentNode;)if(t===e)return!0;return!1},N=t?function(e,t){if(e===t)return l=!0,0;var n=!e.compareDocumentPosition-!t.compareDocumentPosition;return n||(1&(n=(e.ownerDocument||e)===(t.ownerDocument||t)?e.compareDocumentPosition(t):1)||!p.sortDetached&&t.compareDocumentPosition(e)===n?e===C||e.ownerDocument===y&&v(y,e)?-1:t===C||t.ownerDocument===y&&v(y,t)?1:u?L(u,e)-L(u,t):0:4&n?-1:1)}:function(e,t){if(e===t)return l=!0,0;var n,r=0,i=e.parentNode,o=t.parentNode,a=[e],s=[t];if(!i||!o)return e===C?-1:t===C?1:i?-1:o?1:u?L(u,e)-L(u,t):0;if(i===o)return siblingCheck(e,t);for(n=e;n=n.parentNode;)a.unshift(n);for(n=t;n=n.parentNode;)s.unshift(n);for(;a[r]===s[r];)r++;return r?siblingCheck(a[r],s[r]):a[r]===y?-1:s[r]===y?1:0}),C},Sizzle.matches=function(e,t){return Sizzle(e,null,null,t)},Sizzle.matchesSelector=function(e,t){if((e.ownerDocument||e)!==C&&T(e),t=t.replace(_,"='$1']"),p.matchesSelector&&S&&!A[t+" "]&&(!s||!s.test(t))&&(!m||!m.test(t)))try{var n=c.call(e,t);if(n||p.disconnectedMatch||e.document&&11!==e.document.nodeType)return n}catch(e){}return 0<Sizzle(t,C,null,[e]).length},Sizzle.contains=function(e,t){return(e.ownerDocument||e)!==C&&T(e),v(e,t)},Sizzle.attr=function(e,t){(e.ownerDocument||e)!==C&&T(e);var n=b.attrHandle[t.toLowerCase()],r=n&&D.call(b.attrHandle,t.toLowerCase())?n(e,t,!S):void 0;return void 0!==r?r:p.attributes||!S?e.getAttribute(t):(r=e.getAttributeNode(t))&&r.specified?r.value:null},Sizzle.escape=function(e){return(e+"").replace(te,ne)},Sizzle.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},Sizzle.uniqueSort=function(e){var t,n=[],r=0,i=0;if(l=!p.detectDuplicates,u=!p.sortStable&&e.slice(0),e.sort(N),l){for(;t=e[i++];)t===e[i]&&(r=n.push(i));for(;r--;)e.splice(n[r],1)}return u=null,e},o=Sizzle.getText=function(e){var t,n="",r=0,i=e.nodeType;if(i){if(1===i||9===i||11===i){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)n+=o(e)}else if(3===i||4===i)return e.nodeValue}else for(;t=e[r++];)n+=o(t);return n},(b=Sizzle.selectors={cacheLength:50,createPseudo:markFunction,match:G,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(Z,ee),e[3]=(e[3]||e[4]||e[5]||"").replace(Z,ee),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||Sizzle.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&Sizzle.error(e[0]),e},PSEUDO:function(e){var t,n=!e[6]&&e[2];return G.CHILD.test(e[0])?null:(e[3]?e[2]=e[4]||e[5]||"":n&&X.test(n)&&(t=h(n,!0))&&(t=n.indexOf(")",n.length-t)-n.length)&&(e[0]=e[0].slice(0,t),e[2]=n.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(Z,ee).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=d[e+" "];return t||(t=new RegExp("(^|"+O+")"+e+"("+O+"|$)"))&&d(e,function(e){return t.test("string"==typeof e.className&&e.className||void 0!==e.getAttribute&&e.getAttribute("class")||"")})},ATTR:function(n,r,i){return function(e){var t=Sizzle.attr(e,n);return null==t?"!="===r:!r||(t+="","="===r?t===i:"!="===r?t!==i:"^="===r?i&&0===t.indexOf(i):"*="===r?i&&-1<t.indexOf(i):"$="===r?i&&t.slice(-i.length)===i:"~="===r?-1<(" "+t.replace(R," ")+" ").indexOf(i):"|="===r&&(t===i||t.slice(0,i.length+1)===i+"-"))}},CHILD:function(h,e,t,g,m){var v="nth"!==h.slice(0,3),y="last"!==h.slice(-4),x="of-type"===e;return 1===g&&0===m?function(e){return!!e.parentNode}:function(e,t,n){var r,i,o,a,s,u,l=v!==y?"nextSibling":"previousSibling",c=e.parentNode,f=x&&e.nodeName.toLowerCase(),d=!n&&!x,p=!1;if(c){if(v){for(;l;){for(a=e;a=a[l];)if(x?a.nodeName.toLowerCase()===f:1===a.nodeType)return!1;u=l="only"===h&&!u&&"nextSibling"}return!0}if(u=[y?c.firstChild:c.lastChild],y&&d){for(p=(s=(r=(i=(o=(a=c)[k]||(a[k]={}))[a.uniqueID]||(o[a.uniqueID]={}))[h]||[])[0]===E&&r[1])&&r[2],a=s&&c.childNodes[s];a=++s&&a&&a[l]||(p=s=0)||u.pop();)if(1===a.nodeType&&++p&&a===e){i[h]=[E,s,p];break}}else if(d&&(p=s=(r=(i=(o=(a=e)[k]||(a[k]={}))[a.uniqueID]||(o[a.uniqueID]={}))[h]||[])[0]===E&&r[1]),!1===p)for(;(a=++s&&a&&a[l]||(p=s=0)||u.pop())&&((x?a.nodeName.toLowerCase()!==f:1!==a.nodeType)||!++p||(d&&((i=(o=a[k]||(a[k]={}))[a.uniqueID]||(o[a.uniqueID]={}))[h]=[E,p]),a!==e)););return(p-=m)===g||p%g==0&&0<=p/g}}},PSEUDO:function(e,o){var t,a=b.pseudos[e]||b.setFilters[e.toLowerCase()]||Sizzle.error("unsupported pseudo: "+e);return a[k]?a(o):1<a.length?(t=[e,e,"",o],b.setFilters.hasOwnProperty(e.toLowerCase())?markFunction(function(e,t){for(var n,r=a(e,o),i=r.length;i--;)e[n=L(e,r[i])]=!(t[n]=r[i])}):function(e){return a(e,0,t)}):a}},pseudos:{not:markFunction(function(e){var r=[],i=[],s=f(e.replace(W,"$1"));return s[k]?markFunction(function(e,t,n,r){for(var i,o=s(e,null,r,[]),a=e.length;a--;)(i=o[a])&&(e[a]=!(t[a]=i))}):function(e,t,n){return r[0]=e,s(r,null,n,i),r[0]=null,!i.pop()}}),has:markFunction(function(t){return function(e){return 0<Sizzle(t,e).length}}),contains:markFunction(function(t){return t=t.replace(Z,ee),function(e){return-1<(e.textContent||e.innerText||o(e)).indexOf(t)}}),lang:markFunction(function(n){return U.test(n||"")||Sizzle.error("unsupported lang: "+n),n=n.replace(Z,ee).toLowerCase(),function(e){var t;do{if(t=S?e.lang:e.getAttribute("xml:lang")||e.getAttribute("lang"))return(t=t.toLowerCase())===n||0===t.indexOf(n+"-")}while((e=e.parentNode)&&1===e.nodeType);return!1}}),target:function(e){var t=n.location&&n.location.hash;return t&&t.slice(1)===e.id},root:function(e){return e===a},focus:function(e){return e===C.activeElement&&(!C.hasFocus||C.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:createDisabledPseudo(!1),disabled:createDisabledPseudo(!0),checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,!0===e.selected},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeType<6)return!1;return!0},parent:function(e){return!b.pseudos.empty(e)},header:function(e){return Y.test(e.nodeName)},input:function(e){return V.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||"text"===t.toLowerCase())},first:createPositionalPseudo(function(){return[0]}),last:createPositionalPseudo(function(e,t){return[t-1]}),eq:createPositionalPseudo(function(e,t,n){return[n<0?n+t:n]}),even:createPositionalPseudo(function(e,t){for(var n=0;n<t;n+=2)e.push(n);return e}),odd:createPositionalPseudo(function(e,t){for(var n=1;n<t;n+=2)e.push(n);return e}),lt:createPositionalPseudo(function(e,t,n){for(var r=n<0?n+t:n;0<=--r;)e.push(r);return e}),gt:createPositionalPseudo(function(e,t,n){for(var r=n<0?n+t:n;++r<t;)e.push(r);return e})}}).pseudos.nth=b.pseudos.eq,{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})b.pseudos[e]=createInputPseudo(e);for(e in{submit:!0,reset:!0})b.pseudos[e]=createButtonPseudo(e);function setFilters(){}function toSelector(e){for(var t=0,n=e.length,r="";t<n;t++)r+=e[t].value;return r}function addCombinator(s,e,t){var u=e.dir,l=e.next,c=l||u,f=t&&"parentNode"===c,d=r++;return e.first?function(e,t,n){for(;e=e[u];)if(1===e.nodeType||f)return s(e,t,n)}:function(e,t,n){var r,i,o,a=[E,d];if(n){for(;e=e[u];)if((1===e.nodeType||f)&&s(e,t,n))return!0}else for(;e=e[u];)if(1===e.nodeType||f)if(i=(o=e[k]||(e[k]={}))[e.uniqueID]||(o[e.uniqueID]={}),l&&l===e.nodeName.toLowerCase())e=e[u]||e;else{if((r=i[c])&&r[0]===E&&r[1]===d)return a[2]=r[2];if((i[c]=a)[2]=s(e,t,n))return!0}}}function elementMatcher(i){return 1<i.length?function(e,t,n){for(var r=i.length;r--;)if(!i[r](e,t,n))return!1;return!0}:i[0]}function condense(e,t,n,r,i){for(var o,a=[],s=0,u=e.length,l=null!=t;s<u;s++)(o=e[s])&&(n&&!n(o,r,i)||(a.push(o),l&&t.push(s)));return a}function setMatcher(p,h,g,m,v,e){return m&&!m[k]&&(m=setMatcher(m)),v&&!v[k]&&(v=setMatcher(v,e)),markFunction(function(e,t,n,r){var i,o,a,s=[],u=[],l=t.length,c=e||function multipleContexts(e,t,n){for(var r=0,i=t.length;r<i;r++)Sizzle(e,t[r],n);return n}(h||"*",n.nodeType?[n]:n,[]),f=!p||!e&&h?c:condense(c,s,p,n,r),d=g?v||(e?p:l||m)?[]:t:f;if(g&&g(f,d,n,r),m)for(i=condense(d,u),m(i,[],n,r),o=i.length;o--;)(a=i[o])&&(d[u[o]]=!(f[u[o]]=a));if(e){if(v||p){if(v){for(i=[],o=d.length;o--;)(a=d[o])&&i.push(f[o]=a);v(null,d=[],i,r)}for(o=d.length;o--;)(a=d[o])&&-1<(i=v?L(e,a):s[o])&&(e[i]=!(t[i]=a))}}else d=condense(d===t?d.splice(l,d.length):d),v?v(null,t,d,r):q.apply(t,d)})}function matcherFromTokens(e){for(var i,t,n,r=e.length,o=b.relative[e[0].type],a=o||b.relative[" "],s=o?1:0,u=addCombinator(function(e){return e===i},a,!0),l=addCombinator(function(e){return-1<L(i,e)},a,!0),c=[function(e,t,n){var r=!o&&(n||t!==w)||((i=t).nodeType?u(e,t,n):l(e,t,n));return i=null,r}];s<r;s++)if(t=b.relative[e[s].type])c=[addCombinator(elementMatcher(c),t)];else{if((t=b.filter[e[s].type].apply(null,e[s].matches))[k]){for(n=++s;n<r&&!b.relative[e[n].type];n++);return setMatcher(1<s&&elementMatcher(c),1<s&&toSelector(e.slice(0,s-1).concat({value:" "===e[s-2].type?"*":""})).replace(W,"$1"),t,s<n&&matcherFromTokens(e.slice(s,n)),n<r&&matcherFromTokens(e=e.slice(n)),n<r&&toSelector(e))}c.push(t)}return elementMatcher(c)}return setFilters.prototype=b.filters=b.pseudos,b.setFilters=new setFilters,h=Sizzle.tokenize=function(e,t){var n,r,i,o,a,s,u,l=x[e+" "];if(l)return t?0:l.slice(0);for(a=e,s=[],u=b.preFilter;a;){for(o in n&&!(r=$.exec(a))||(r&&(a=a.slice(r[0].length)||a),s.push(i=[])),n=!1,(r=B.exec(a))&&(n=r.shift(),i.push({value:n,type:r[0].replace(W," ")}),a=a.slice(n.length)),b.filter)!(r=G[o].exec(a))||u[o]&&!(r=u[o](r))||(n=r.shift(),i.push({value:n,type:o,matches:r}),a=a.slice(n.length));if(!n)break}return t?a.length:a?Sizzle.error(e):x(e,s).slice(0)},f=Sizzle.compile=function(e,t){var n,r=[],i=[],o=A[e+" "];if(!o){for(t||(t=h(e)),n=t.length;n--;)(o=matcherFromTokens(t[n]))[k]?r.push(o):i.push(o);(o=A(e,function matcherFromGroupMatchers(m,v){var y=0<v.length,x=0<m.length,e=function(e,t,n,r,i){var o,a,s,u=0,l="0",c=e&&[],f=[],d=w,p=e||x&&b.find.TAG("*",i),h=E+=null==d?1:Math.random()||.1,g=p.length;for(i&&(w=t===C||t||i);l!==g&&null!=(o=p[l]);l++){if(x&&o){for(a=0,t||o.ownerDocument===C||(T(o),n=!S);s=m[a++];)if(s(o,t||C,n)){r.push(o);break}i&&(E=h)}y&&((o=!s&&o)&&u--,e&&c.push(o))}if(u+=l,y&&l!==u){for(a=0;s=v[a++];)s(c,f,t,n);if(e){if(0<u)for(;l--;)c[l]||f[l]||(f[l]=j.call(r));f=condense(f)}q.apply(r,f),i&&!e&&0<f.length&&1<u+v.length&&Sizzle.uniqueSort(r)}return i&&(E=h,w=d),c};return y?markFunction(e):e}(i,r))).selector=e}return o},g=Sizzle.select=function(e,t,n,r){var i,o,a,s,u,l="function"==typeof e&&e,c=!r&&h(e=l.selector||e);if(n=n||[],1===c.length){if(2<(o=c[0]=c[0].slice(0)).length&&"ID"===(a=o[0]).type&&p.getById&&9===t.nodeType&&S&&b.relative[o[1].type]){if(!(t=(b.find.ID(a.matches[0].replace(Z,ee),t)||[])[0]))return n;l&&(t=t.parentNode),e=e.slice(o.shift().value.length)}for(i=G.needsContext.test(e)?0:o.length;i--&&(a=o[i],!b.relative[s=a.type]);)if((u=b.find[s])&&(r=u(a.matches[0].replace(Z,ee),K.test(o[0].type)&&testContext(t.parentNode)||t))){if(o.splice(i,1),!(e=r.length&&toSelector(o)))return q.apply(n,r),n;break}}return(l||f(e,c))(r,t,!S,n,!t||K.test(e)&&testContext(t.parentNode)||t),n},p.sortStable=k.split("").sort(N).join("")===k,p.detectDuplicates=!!l,T(),p.sortDetached=assert(function(e){return 1&e.compareDocumentPosition(C.createElement("fieldset"))}),assert(function(e){return e.innerHTML="<a href='#'></a>","#"===e.firstChild.getAttribute("href")})||addHandle("type|href|height|width",function(e,t,n){if(!n)return e.getAttribute(t,"type"===t.toLowerCase()?1:2)}),p.attributes&&assert(function(e){return e.innerHTML="<input/>",e.firstChild.setAttribute("value",""),""===e.firstChild.getAttribute("value")})||addHandle("value",function(e,t,n){if(!n&&"input"===e.nodeName.toLowerCase())return e.defaultValue}),assert(function(e){return null==e.getAttribute("disabled")})||addHandle(P,function(e,t,n){var r;if(!n)return!0===e[t]?t.toLowerCase():(r=e.getAttributeNode(t))&&r.specified?r.value:null}),Sizzle}(C);k.find=y,k.expr=y.selectors,k.expr[":"]=k.expr.pseudos,k.uniqueSort=k.unique=y.uniqueSort,k.text=y.getText,k.isXMLDoc=y.isXML,k.contains=y.contains,k.escapeSelector=y.escape;var x=function(e,t,n){for(var r=[],i=void 0!==n;(e=e[t])&&9!==e.nodeType;)if(1===e.nodeType){if(i&&k(e).is(n))break;r.push(e)}return r},b=function(e,t){for(var n=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&n.push(e);return n},w=k.expr.match.needsContext,T=/^<([a-z][^\/\0>:\x20\t\r\n\f]*)[\x20\t\r\n\f]*\/?>(?:<\/\1>|)$/i,E=/^.[^:#\[\.,]*$/;function winnow(e,n,r){if(k.isFunction(n))return k.grep(e,function(e,t){return!!n.call(e,t,e)!==r});if(n.nodeType)return k.grep(e,function(e){return e===n!==r});if("string"==typeof n){if(E.test(n))return k.filter(n,e,r);n=k.filter(n,e)}return k.grep(e,function(e){return-1<i.call(n,e)!==r&&1===e.nodeType})}k.filter=function(e,t,n){var r=t[0];return n&&(e=":not("+e+")"),1===t.length&&1===r.nodeType?k.find.matchesSelector(r,e)?[r]:[]:k.find.matches(e,k.grep(t,function(e){return 1===e.nodeType}))},k.fn.extend({find:function(e){var t,n,r=this.length,i=this;if("string"!=typeof e)return this.pushStack(k(e).filter(function(){for(t=0;t<r;t++)if(k.contains(i[t],this))return!0}));for(n=this.pushStack([]),t=0;t<r;t++)k.find(e,i[t],n);return 1<r?k.uniqueSort(n):n},filter:function(e){return this.pushStack(winnow(this,e||[],!1))},not:function(e){return this.pushStack(winnow(this,e||[],!0))},is:function(e){return!!winnow(this,"string"==typeof e&&w.test(e)?k(e):e||[],!1).length}});var A,N=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/;(k.fn.init=function(e,t,n){var r,i;if(!e)return this;if(n=n||A,"string"!=typeof e)return e.nodeType?(this[0]=e,this.length=1,this):k.isFunction(e)?void 0!==n.ready?n.ready(e):e(k):k.makeArray(e,this);if(!(r="<"===e[0]&&">"===e[e.length-1]&&3<=e.length?[null,e,null]:N.exec(e))||!r[1]&&t)return!t||t.jquery?(t||n).find(e):this.constructor(t).find(e);if(r[1]){if(t=t instanceof k?t[0]:t,k.merge(this,k.parseHTML(r[1],t&&t.nodeType?t.ownerDocument||t:S,!0)),T.test(r[1])&&k.isPlainObject(t))for(r in t)k.isFunction(this[r])?this[r](t[r]):this.attr(r,t[r]);return this}return(i=S.getElementById(r[2]))&&(this[0]=i,this.length=1),this}).prototype=k.fn,A=k(S);var D=/^(?:parents|prev(?:Until|All))/,j={children:!0,contents:!0,next:!0,prev:!0};function sibling(e,t){for(;(e=e[t])&&1!==e.nodeType;);return e}k.fn.extend({has:function(e){var t=k(e,this),n=t.length;return this.filter(function(){for(var e=0;e<n;e++)if(k.contains(this,t[e]))return!0})},closest:function(e,t){var n,r=0,i=this.length,o=[],a="string"!=typeof e&&k(e);if(!w.test(e))for(;r<i;r++)for(n=this[r];n&&n!==t;n=n.parentNode)if(n.nodeType<11&&(a?-1<a.index(n):1===n.nodeType&&k.find.matchesSelector(n,e))){o.push(n);break}return this.pushStack(1<o.length?k.uniqueSort(o):o)},index:function(e){return e?"string"==typeof e?i.call(k(e),this[0]):i.call(this,e.jquery?e[0]:e):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){return this.pushStack(k.uniqueSort(k.merge(this.get(),k(e,t))))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),k.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return x(e,"parentNode")},parentsUntil:function(e,t,n){return x(e,"parentNode",n)},next:function(e){return sibling(e,"nextSibling")},prev:function(e){return sibling(e,"previousSibling")},nextAll:function(e){return x(e,"nextSibling")},prevAll:function(e){return x(e,"previousSibling")},nextUntil:function(e,t,n){return x(e,"nextSibling",n)},prevUntil:function(e,t,n){return x(e,"previousSibling",n)},siblings:function(e){return b((e.parentNode||{}).firstChild,e)},children:function(e){return b(e.firstChild)},contents:function(e){return e.contentDocument||k.merge([],e.childNodes)}},function(r,i){k.fn[r]=function(e,t){var n=k.map(this,i,e);return"Until"!==r.slice(-5)&&(t=e),t&&"string"==typeof t&&(n=k.filter(t,n)),1<this.length&&(j[r]||k.uniqueSort(n),D.test(r)&&n.reverse()),this.pushStack(n)}});var F=/\S+/g;function Identity(e){return e}function Thrower(e){throw e}function adoptValue(e,t,n){var r;try{e&&k.isFunction(r=e.promise)?r.call(e).done(t).fail(n):e&&k.isFunction(r=e.then)?r.call(e,t,n):t.call(void 0,e)}catch(e){n.call(void 0,e)}}k.Callbacks=function(n){n="string"==typeof n?function createOptions(e){var n={};return k.each(e.match(F)||[],function(e,t){n[t]=!0}),n}(n):k.extend({},n);var r,e,t,i,o=[],a=[],s=-1,u=function(){for(i=n.once,t=r=!0;a.length;s=-1)for(e=a.shift();++s<o.length;)!1===o[s].apply(e[0],e[1])&&n.stopOnFalse&&(s=o.length,e=!1);n.memory||(e=!1),r=!1,i&&(o=e?[]:"")},l={add:function(){return o&&(e&&!r&&(s=o.length-1,a.push(e)),function add(e){k.each(e,function(e,t){k.isFunction(t)?n.unique&&l.has(t)||o.push(t):t&&t.length&&"string"!==k.type(t)&&add(t)})}(arguments),e&&!r&&u()),this},remove:function(){return k.each(arguments,function(e,t){for(var n;-1<(n=k.inArray(t,o,n));)o.splice(n,1),n<=s&&s--}),this},has:function(e){return e?-1<k.inArray(e,o):0<o.length},empty:function(){return o&&(o=[]),this},disable:function(){return i=a=[],o=e="",this},disabled:function(){return!o},lock:function(){return i=a=[],e||r||(o=e=""),this},locked:function(){return!!i},fireWith:function(e,t){return i||(t=[e,(t=t||[]).slice?t.slice():t],a.push(t),r||u()),this},fire:function(){return l.fireWith(this,arguments),this},fired:function(){return!!t}};return l},k.extend({Deferred:function(e){var o=[["notify","progress",k.Callbacks("memory"),k.Callbacks("memory"),2],["resolve","done",k.Callbacks("once memory"),k.Callbacks("once memory"),0,"resolved"],["reject","fail",k.Callbacks("once memory"),k.Callbacks("once memory"),1,"rejected"]],i="pending",a={state:function(){return i},always:function(){return s.done(arguments).fail(arguments),this},catch:function(e){return a.then(null,e)},pipe:function(){var i=arguments;return k.Deferred(function(r){k.each(o,function(e,t){var n=k.isFunction(i[t[4]])&&i[t[4]];s[t[1]](function(){var e=n&&n.apply(this,arguments);e&&k.isFunction(e.promise)?e.promise().progress(r.notify).done(r.resolve).fail(r.reject):r[t[0]+"With"](this,n?[e]:arguments)})}),i=null}).promise()},then:function(t,n,r){var u=0;function resolve(i,o,a,s){return function(){var n=this,r=arguments,e=function(){var e,t;if(!(i<u)){if((e=a.apply(n,r))===o.promise())throw new TypeError("Thenable self-resolution");t=e&&("object"==typeof e||"function"==typeof e)&&e.then,k.isFunction(t)?s?t.call(e,resolve(u,o,Identity,s),resolve(u,o,Thrower,s)):(u++,t.call(e,resolve(u,o,Identity,s),resolve(u,o,Thrower,s),resolve(u,o,Identity,o.notifyWith))):(a!==Identity&&(n=void 0,r=[e]),(s||o.resolveWith)(n,r))}},t=s?e:function(){try{e()}catch(e){k.Deferred.exceptionHook&&k.Deferred.exceptionHook(e,t.stackTrace),u<=i+1&&(a!==Thrower&&(n=void 0,r=[e]),o.rejectWith(n,r))}};i?t():(k.Deferred.getStackHook&&(t.stackTrace=k.Deferred.getStackHook()),C.setTimeout(t))}}return k.Deferred(function(e){o[0][3].add(resolve(0,e,k.isFunction(r)?r:Identity,e.notifyWith)),o[1][3].add(resolve(0,e,k.isFunction(t)?t:Identity)),o[2][3].add(resolve(0,e,k.isFunction(n)?n:Thrower))}).promise()},promise:function(e){return null!=e?k.extend(e,a):a}},s={};return k.each(o,function(e,t){var n=t[2],r=t[5];a[t[1]]=n.add,r&&n.add(function(){i=r},o[3-e][2].disable,o[0][2].lock),n.add(t[3].fire),s[t[0]]=function(){return s[t[0]+"With"](this===s?void 0:this,arguments),this},s[t[0]+"With"]=n.fireWith}),a.promise(s),e&&e.call(s,s),s},when:function(e){var n=arguments.length,t=n,r=Array(t),i=s.call(arguments),o=k.Deferred(),a=function(t){return function(e){r[t]=this,i[t]=1<arguments.length?s.call(arguments):e,--n||o.resolveWith(r,i)}};if(n<=1&&(adoptValue(e,o.done(a(t)).resolve,o.reject),"pending"===o.state()||k.isFunction(i[t]&&i[t].then)))return o.then();for(;t--;)adoptValue(i[t],a(t),o.reject);return o.promise()}});var q=/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;k.Deferred.exceptionHook=function(e,t){C.console&&C.console.warn&&e&&q.test(e.name)&&C.console.warn("jQuery.Deferred exception: "+e.message,e.stack,t)},k.readyException=function(e){C.setTimeout(function(){throw e})};var H=k.Deferred();function completed(){S.removeEventListener("DOMContentLoaded",completed),C.removeEventListener("load",completed),k.ready()}k.fn.ready=function(e){return H.then(e).catch(function(e){k.readyException(e)}),this},k.extend({isReady:!1,readyWait:1,holdReady:function(e){e?k.readyWait++:k.ready(!0)},ready:function(e){(!0===e?--k.readyWait:k.isReady)||(k.isReady=!0)!==e&&0<--k.readyWait||H.resolveWith(S,[k])}}),k.ready.then=H.then,"complete"===S.readyState||"loading"!==S.readyState&&!S.documentElement.doScroll?C.setTimeout(k.ready):(S.addEventListener("DOMContentLoaded",completed),C.addEventListener("load",completed));var L=function(e,t,n,r,i,o,a){var s=0,u=e.length,l=null==n;if("object"===k.type(n))for(s in i=!0,n)L(e,t,s,n[s],!0,o,a);else if(void 0!==r&&(i=!0,k.isFunction(r)||(a=!0),l&&(t=a?(t.call(e,r),null):(l=t,function(e,t,n){return l.call(k(e),n)})),t))for(;s<u;s++)t(e[s],n,a?r:r.call(e[s],s,t(e[s],n)));return i?e:l?t.call(e):u?t(e[0],n):o},P=function(e){return 1===e.nodeType||9===e.nodeType||!+e.nodeType};function Data(){this.expando=k.expando+Data.uid++}Data.uid=1,Data.prototype={cache:function(e){var t=e[this.expando];return t||(t={},P(e)&&(e.nodeType?e[this.expando]=t:Object.defineProperty(e,this.expando,{value:t,configurable:!0}))),t},set:function(e,t,n){var r,i=this.cache(e);if("string"==typeof t)i[k.camelCase(t)]=n;else for(r in t)i[k.camelCase(r)]=t[r];return i},get:function(e,t){return void 0===t?this.cache(e):e[this.expando]&&e[this.expando][k.camelCase(t)]},access:function(e,t,n){return void 0===t||t&&"string"==typeof t&&void 0===n?this.get(e,t):(this.set(e,t,n),void 0!==n?n:t)},remove:function(e,t){var n,r=e[this.expando];if(void 0!==r){if(void 0!==t){n=(t=k.isArray(t)?t.map(k.camelCase):(t=k.camelCase(t))in r?[t]:t.match(F)||[]).length;for(;n--;)delete r[t[n]]}(void 0===t||k.isEmptyObject(r))&&(e.nodeType?e[this.expando]=void 0:delete e[this.expando])}},hasData:function(e){var t=e[this.expando];return void 0!==t&&!k.isEmptyObject(t)}};var O=new Data,M=new Data,z=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,I=/[A-Z]/g;function dataAttr(e,t,n){var r;if(void 0===n&&1===e.nodeType)if(r="data-"+t.replace(I,"-$&").toLowerCase(),"string"==typeof(n=e.getAttribute(r))){try{n="true"===n||"false"!==n&&("null"===n?null:+n+""===n?+n:z.test(n)?JSON.parse(n):n)}catch(e){}M.set(e,t,n)}else n=void 0;return n}k.extend({hasData:function(e){return M.hasData(e)||O.hasData(e)},data:function(e,t,n){return M.access(e,t,n)},removeData:function(e,t){M.remove(e,t)},_data:function(e,t,n){return O.access(e,t,n)},_removeData:function(e,t){O.remove(e,t)}}),k.fn.extend({data:function(n,e){var t,r,i,o=this[0],a=o&&o.attributes;if(void 0!==n)return"object"==typeof n?this.each(function(){M.set(this,n)}):L(this,function(e){var t;if(o&&void 0===e)return void 0!==(t=M.get(o,n))?t:void 0!==(t=dataAttr(o,n))?t:void 0;this.each(function(){M.set(this,n,e)})},null,e,1<arguments.length,null,!0);if(this.length&&(i=M.get(o),1===o.nodeType&&!O.get(o,"hasDataAttrs"))){for(t=a.length;t--;)a[t]&&0===(r=a[t].name).indexOf("data-")&&(r=k.camelCase(r.slice(5)),dataAttr(o,r,i[r]));O.set(o,"hasDataAttrs",!0)}return i},removeData:function(e){return this.each(function(){M.remove(this,e)})}}),k.extend({queue:function(e,t,n){var r;if(e)return t=(t||"fx")+"queue",r=O.get(e,t),n&&(!r||k.isArray(n)?r=O.access(e,t,k.makeArray(n)):r.push(n)),r||[]},dequeue:function(e,t){t=t||"fx";var n=k.queue(e,t),r=n.length,i=n.shift(),o=k._queueHooks(e,t);"inprogress"===i&&(i=n.shift(),r--),i&&("fx"===t&&n.unshift("inprogress"),delete o.stop,i.call(e,function(){k.dequeue(e,t)},o)),!r&&o&&o.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return O.get(e,n)||O.access(e,n,{empty:k.Callbacks("once memory").add(function(){O.remove(e,[t+"queue",n])})})}}),k.fn.extend({queue:function(t,n){var e=2;return"string"!=typeof t&&(n=t,t="fx",e--),arguments.length<e?k.queue(this[0],t):void 0===n?this:this.each(function(){var e=k.queue(this,t,n);k._queueHooks(this,t),"fx"===t&&"inprogress"!==e[0]&&k.dequeue(this,t)})},dequeue:function(e){return this.each(function(){k.dequeue(this,e)})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,t){var n,r=1,i=k.Deferred(),o=this,a=this.length,s=function(){--r||i.resolveWith(o,[o])};for("string"!=typeof e&&(t=e,e=void 0),e=e||"fx";a--;)(n=O.get(o[a],e+"queueHooks"))&&n.empty&&(r++,n.empty.add(s));return s(),i.promise(t)}});var R=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,W=new RegExp("^(?:([+-])=|)("+R+")([a-z%]*)$","i"),$=["Top","Right","Bottom","Left"],B=function(e,t){return"none"===(e=t||e).style.display||""===e.style.display&&k.contains(e.ownerDocument,e)&&"none"===k.css(e,"display")},_=function(e,t,n,r){var i,o,a={};for(o in t)a[o]=e.style[o],e.style[o]=t[o];for(o in i=n.apply(e,r||[]),t)e.style[o]=a[o];return i};function adjustCSS(e,t,n,r){var i,o=1,a=20,s=r?function(){return r.cur()}:function(){return k.css(e,t,"")},u=s(),l=n&&n[3]||(k.cssNumber[t]?"":"px"),c=(k.cssNumber[t]||"px"!==l&&+u)&&W.exec(k.css(e,t));if(c&&c[3]!==l)for(l=l||c[3],n=n||[],c=+u||1;c/=o=o||".5",k.style(e,t,c+l),o!==(o=s()/u)&&1!==o&&--a;);return n&&(c=+c||+u||0,i=n[1]?c+(n[1]+1)*n[2]:+n[2],r&&(r.unit=l,r.start=c,r.end=i)),i}var X={};function showHide(e,t){for(var n,r,i,o,a,s,u,l=[],c=0,f=e.length;c<f;c++)(r=e[c]).style&&(n=r.style.display,t?("none"===n&&(l[c]=O.get(r,"display")||null,l[c]||(r.style.display="")),""===r.style.display&&B(r)&&(l[c]=(u=a=o=void 0,a=(i=r).ownerDocument,s=i.nodeName,(u=X[s])||(o=a.body.appendChild(a.createElement(s)),u=k.css(o,"display"),o.parentNode.removeChild(o),"none"===u&&(u="block"),X[s]=u)))):"none"!==n&&(l[c]="none",O.set(r,"display",n)));for(c=0;c<f;c++)null!=l[c]&&(e[c].style.display=l[c]);return e}k.fn.extend({show:function(){return showHide(this,!0)},hide:function(){return showHide(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each(function(){B(this)?k(this).show():k(this).hide()})}});var U=/^(?:checkbox|radio)$/i,G=/<([a-z][^\/\0>\x20\t\r\n\f]+)/i,V=/^$|\/(?:java|ecma)script/i,Y={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};function getAll(e,t){var n=void 0!==e.getElementsByTagName?e.getElementsByTagName(t||"*"):void 0!==e.querySelectorAll?e.querySelectorAll(t||"*"):[];return void 0===t||t&&k.nodeName(e,t)?k.merge([e],n):n}function setGlobalEval(e,t){for(var n=0,r=e.length;n<r;n++)O.set(e[n],"globalEval",!t||O.get(t[n],"globalEval"))}Y.optgroup=Y.option,Y.tbody=Y.tfoot=Y.colgroup=Y.caption=Y.thead,Y.th=Y.td;var Q,J,K=/<|&#?\w+;/;function buildFragment(e,t,n,r,i){for(var o,a,s,u,l,c,f=t.createDocumentFragment(),d=[],p=0,h=e.length;p<h;p++)if((o=e[p])||0===o)if("object"===k.type(o))k.merge(d,o.nodeType?[o]:o);else if(K.test(o)){for(a=a||f.appendChild(t.createElement("div")),s=(G.exec(o)||["",""])[1].toLowerCase(),u=Y[s]||Y._default,a.innerHTML=u[1]+k.htmlPrefilter(o)+u[2],c=u[0];c--;)a=a.lastChild;k.merge(d,a.childNodes),(a=f.firstChild).textContent=""}else d.push(t.createTextNode(o));for(f.textContent="",p=0;o=d[p++];)if(r&&-1<k.inArray(o,r))i&&i.push(o);else if(l=k.contains(o.ownerDocument,o),a=getAll(f.appendChild(o),"script"),l&&setGlobalEval(a),n)for(c=0;o=a[c++];)V.test(o.type||"")&&n.push(o);return f}Q=S.createDocumentFragment().appendChild(S.createElement("div")),(J=S.createElement("input")).setAttribute("type","radio"),J.setAttribute("checked","checked"),J.setAttribute("name","t"),Q.appendChild(J),m.checkClone=Q.cloneNode(!0).cloneNode(!0).lastChild.checked,Q.innerHTML="<textarea>x</textarea>",m.noCloneChecked=!!Q.cloneNode(!0).lastChild.defaultValue;var Z=S.documentElement,ee=/^key/,te=/^(?:mouse|pointer|contextmenu|drag|drop)|click/,ne=/^([^.]*)(?:\.(.+)|)/;function returnTrue(){return!0}function returnFalse(){return!1}function safeActiveElement(){try{return S.activeElement}catch(e){}}function on(e,t,n,r,i,o){var a,s;if("object"==typeof t){for(s in"string"!=typeof n&&(r=r||n,n=void 0),t)on(e,s,n,r,t[s],o);return e}if(null==r&&null==i?(i=n,r=n=void 0):null==i&&("string"==typeof n?(i=r,r=void 0):(i=r,r=n,n=void 0)),!1===i)i=returnFalse;else if(!i)return e;return 1===o&&(a=i,(i=function(e){return k().off(e),a.apply(this,arguments)}).guid=a.guid||(a.guid=k.guid++)),e.each(function(){k.event.add(this,t,i,r,n)})}k.event={global:{},add:function(t,e,n,r,i){var o,a,s,u,l,c,f,d,p,h,g,m=O.get(t);if(m)for(n.handler&&(n=(o=n).handler,i=o.selector),i&&k.find.matchesSelector(Z,i),n.guid||(n.guid=k.guid++),(u=m.events)||(u=m.events={}),(a=m.handle)||(a=m.handle=function(e){return void 0!==k&&k.event.triggered!==e.type?k.event.dispatch.apply(t,arguments):void 0}),l=(e=(e||"").match(F)||[""]).length;l--;)p=g=(s=ne.exec(e[l])||[])[1],h=(s[2]||"").split(".").sort(),p&&(f=k.event.special[p]||{},p=(i?f.delegateType:f.bindType)||p,f=k.event.special[p]||{},c=k.extend({type:p,origType:g,data:r,handler:n,guid:n.guid,selector:i,needsContext:i&&k.expr.match.needsContext.test(i),namespace:h.join(".")},o),(d=u[p])||((d=u[p]=[]).delegateCount=0,f.setup&&!1!==f.setup.call(t,r,h,a)||t.addEventListener&&t.addEventListener(p,a)),f.add&&(f.add.call(t,c),c.handler.guid||(c.handler.guid=n.guid)),i?d.splice(d.delegateCount++,0,c):d.push(c),k.event.global[p]=!0)},remove:function(e,t,n,r,i){var o,a,s,u,l,c,f,d,p,h,g,m=O.hasData(e)&&O.get(e);if(m&&(u=m.events)){for(l=(t=(t||"").match(F)||[""]).length;l--;)if(p=g=(s=ne.exec(t[l])||[])[1],h=(s[2]||"").split(".").sort(),p){for(f=k.event.special[p]||{},d=u[p=(r?f.delegateType:f.bindType)||p]||[],s=s[2]&&new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"),a=o=d.length;o--;)c=d[o],!i&&g!==c.origType||n&&n.guid!==c.guid||s&&!s.test(c.namespace)||r&&r!==c.selector&&("**"!==r||!c.selector)||(d.splice(o,1),c.selector&&d.delegateCount--,f.remove&&f.remove.call(e,c));a&&!d.length&&(f.teardown&&!1!==f.teardown.call(e,h,m.handle)||k.removeEvent(e,p,m.handle),delete u[p])}else for(p in u)k.event.remove(e,p+t[l],n,r,!0);k.isEmptyObject(u)&&O.remove(e,"handle events")}},dispatch:function(e){var t,n,r,i,o,a,s=k.event.fix(e),u=new Array(arguments.length),l=(O.get(this,"events")||{})[s.type]||[],c=k.event.special[s.type]||{};for(u[0]=s,t=1;t<arguments.length;t++)u[t]=arguments[t];if(s.delegateTarget=this,!c.preDispatch||!1!==c.preDispatch.call(this,s)){for(a=k.event.handlers.call(this,s,l),t=0;(i=a[t++])&&!s.isPropagationStopped();)for(s.currentTarget=i.elem,n=0;(o=i.handlers[n++])&&!s.isImmediatePropagationStopped();)s.rnamespace&&!s.rnamespace.test(o.namespace)||(s.handleObj=o,s.data=o.data,void 0!==(r=((k.event.special[o.origType]||{}).handle||o.handler).apply(i.elem,u))&&!1===(s.result=r)&&(s.preventDefault(),s.stopPropagation()));return c.postDispatch&&c.postDispatch.call(this,s),s.result}},handlers:function(e,t){var n,r,i,o,a=[],s=t.delegateCount,u=e.target;if(s&&u.nodeType&&("click"!==e.type||isNaN(e.button)||e.button<1))for(;u!==this;u=u.parentNode||this)if(1===u.nodeType&&(!0!==u.disabled||"click"!==e.type)){for(r=[],n=0;n<s;n++)void 0===r[i=(o=t[n]).selector+" "]&&(r[i]=o.needsContext?-1<k(i,this).index(u):k.find(i,this,null,[u]).length),r[i]&&r.push(o);r.length&&a.push({elem:u,handlers:r})}return s<t.length&&a.push({elem:this,handlers:t.slice(s)}),a},addProp:function(t,e){Object.defineProperty(k.Event.prototype,t,{enumerable:!0,configurable:!0,get:k.isFunction(e)?function(){if(this.originalEvent)return e(this.originalEvent)}:function(){if(this.originalEvent)return this.originalEvent[t]},set:function(e){Object.defineProperty(this,t,{enumerable:!0,configurable:!0,writable:!0,value:e})}})},fix:function(e){return e[k.expando]?e:new k.Event(e)},special:{load:{noBubble:!0},focus:{trigger:function(){if(this!==safeActiveElement()&&this.focus)return this.focus(),!1},delegateType:"focusin"},blur:{trigger:function(){if(this===safeActiveElement()&&this.blur)return this.blur(),!1},delegateType:"focusout"},click:{trigger:function(){if("checkbox"===this.type&&this.click&&k.nodeName(this,"input"))return this.click(),!1},_default:function(e){return k.nodeName(e.target,"a")}},beforeunload:{postDispatch:function(e){void 0!==e.result&&e.originalEvent&&(e.originalEvent.returnValue=e.result)}}}},k.removeEvent=function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n)},k.Event=function(e,t){if(!(this instanceof k.Event))return new k.Event(e,t);e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||void 0===e.defaultPrevented&&!1===e.returnValue?returnTrue:returnFalse,this.target=e.target&&3===e.target.nodeType?e.target.parentNode:e.target,this.currentTarget=e.currentTarget,this.relatedTarget=e.relatedTarget):this.type=e,t&&k.extend(this,t),this.timeStamp=e&&e.timeStamp||k.now(),this[k.expando]=!0},k.Event.prototype={constructor:k.Event,isDefaultPrevented:returnFalse,isPropagationStopped:returnFalse,isImmediatePropagationStopped:returnFalse,isSimulated:!1,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=returnTrue,e&&!this.isSimulated&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=returnTrue,e&&!this.isSimulated&&e.stopPropagation()},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=returnTrue,e&&!this.isSimulated&&e.stopImmediatePropagation(),this.stopPropagation()}},k.each({altKey:!0,bubbles:!0,cancelable:!0,changedTouches:!0,ctrlKey:!0,detail:!0,eventPhase:!0,metaKey:!0,pageX:!0,pageY:!0,shiftKey:!0,view:!0,char:!0,charCode:!0,key:!0,keyCode:!0,button:!0,buttons:!0,clientX:!0,clientY:!0,offsetX:!0,offsetY:!0,pointerId:!0,pointerType:!0,screenX:!0,screenY:!0,targetTouches:!0,toElement:!0,touches:!0,which:function(e){var t=e.button;return null==e.which&&ee.test(e.type)?null!=e.charCode?e.charCode:e.keyCode:!e.which&&void 0!==t&&te.test(e.type)?1&t?1:2&t?3:4&t?2:0:e.which}},k.event.addProp),k.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(e,i){k.event.special[e]={delegateType:i,bindType:i,handle:function(e){var t,n=e.relatedTarget,r=e.handleObj;return n&&(n===this||k.contains(this,n))||(e.type=r.origType,t=r.handler.apply(this,arguments),e.type=i),t}}}),k.fn.extend({on:function(e,t,n,r){return on(this,e,t,n,r)},one:function(e,t,n,r){return on(this,e,t,n,r,1)},off:function(e,t,n){var r,i;if(e&&e.preventDefault&&e.handleObj)return r=e.handleObj,k(e.delegateTarget).off(r.namespace?r.origType+"."+r.namespace:r.origType,r.selector,r.handler),this;if("object"!=typeof e)return!1!==t&&"function"!=typeof t||(n=t,t=void 0),!1===n&&(n=returnFalse),this.each(function(){k.event.remove(this,e,n,t)});for(i in e)this.off(i,t,e[i]);return this}});var re=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([a-z][^\/\0>\x20\t\r\n\f]*)[^>]*)\/>/gi,ie=/<script|<style|<link/i,oe=/checked\s*(?:[^=]|=\s*.checked.)/i,ae=/^true\/(.*)/,se=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g;function manipulationTarget(e,t){return k.nodeName(e,"table")&&k.nodeName(11!==t.nodeType?t:t.firstChild,"tr")&&e.getElementsByTagName("tbody")[0]||e}function disableScript(e){return e.type=(null!==e.getAttribute("type"))+"/"+e.type,e}function restoreScript(e){var t=ae.exec(e.type);return t?e.type=t[1]:e.removeAttribute("type"),e}function cloneCopyEvent(e,t){var n,r,i,o,a,s,u,l;if(1===t.nodeType){if(O.hasData(e)&&(o=O.access(e),a=O.set(t,o),l=o.events))for(i in delete a.handle,a.events={},l)for(n=0,r=l[i].length;n<r;n++)k.event.add(t,i,l[i][n]);M.hasData(e)&&(s=M.access(e),u=k.extend({},s),M.set(t,u))}}function domManip(n,r,i,o){r=g.apply([],r);var e,t,a,s,u,l,c=0,f=n.length,d=f-1,p=r[0],h=k.isFunction(p);if(h||1<f&&"string"==typeof p&&!m.checkClone&&oe.test(p))return n.each(function(e){var t=n.eq(e);h&&(r[0]=p.call(this,e,t.html())),domManip(t,r,i,o)});if(f&&(t=(e=buildFragment(r,n[0].ownerDocument,!1,n,o)).firstChild,1===e.childNodes.length&&(e=t),t||o)){for(s=(a=k.map(getAll(e,"script"),disableScript)).length;c<f;c++)u=e,c!==d&&(u=k.clone(u,!0,!0),s&&k.merge(a,getAll(u,"script"))),i.call(n[c],u,c);if(s)for(l=a[a.length-1].ownerDocument,k.map(a,restoreScript),c=0;c<s;c++)u=a[c],V.test(u.type||"")&&!O.access(u,"globalEval")&&k.contains(l,u)&&(u.src?k._evalUrl&&k._evalUrl(u.src):DOMEval(u.textContent.replace(se,""),l))}return n}function remove(e,t,n){for(var r,i=t?k.filter(t,e):e,o=0;null!=(r=i[o]);o++)n||1!==r.nodeType||k.cleanData(getAll(r)),r.parentNode&&(n&&k.contains(r.ownerDocument,r)&&setGlobalEval(getAll(r,"script")),r.parentNode.removeChild(r));return e}k.extend({htmlPrefilter:function(e){return e.replace(re,"<$1></$2>")},clone:function(e,t,n){var r,i,o,a,s,u,l,c=e.cloneNode(!0),f=k.contains(e.ownerDocument,e);if(!(m.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||k.isXMLDoc(e)))for(a=getAll(c),r=0,i=(o=getAll(e)).length;r<i;r++)s=o[r],u=a[r],void 0,"input"===(l=u.nodeName.toLowerCase())&&U.test(s.type)?u.checked=s.checked:"input"!==l&&"textarea"!==l||(u.defaultValue=s.defaultValue);if(t)if(n)for(o=o||getAll(e),a=a||getAll(c),r=0,i=o.length;r<i;r++)cloneCopyEvent(o[r],a[r]);else cloneCopyEvent(e,c);return 0<(a=getAll(c,"script")).length&&setGlobalEval(a,!f&&getAll(e,"script")),c},cleanData:function(e){for(var t,n,r,i=k.event.special,o=0;void 0!==(n=e[o]);o++)if(P(n)){if(t=n[O.expando]){if(t.events)for(r in t.events)i[r]?k.event.remove(n,r):k.removeEvent(n,r,t.handle);n[O.expando]=void 0}n[M.expando]&&(n[M.expando]=void 0)}}}),k.fn.extend({detach:function(e){return remove(this,e,!0)},remove:function(e){return remove(this,e)},text:function(e){return L(this,function(e){return void 0===e?k.text(this):this.empty().each(function(){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(this.textContent=e)})},null,e,arguments.length)},append:function(){return domManip(this,arguments,function(e){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||manipulationTarget(this,e).appendChild(e)})},prepend:function(){return domManip(this,arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=manipulationTarget(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return domManip(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return domManip(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},empty:function(){for(var e,t=0;null!=(e=this[t]);t++)1===e.nodeType&&(k.cleanData(getAll(e,!1)),e.textContent="");return this},clone:function(e,t){return e=null!=e&&e,t=null==t?e:t,this.map(function(){return k.clone(this,e,t)})},html:function(e){return L(this,function(e){var t=this[0]||{},n=0,r=this.length;if(void 0===e&&1===t.nodeType)return t.innerHTML;if("string"==typeof e&&!ie.test(e)&&!Y[(G.exec(e)||["",""])[1].toLowerCase()]){e=k.htmlPrefilter(e);try{for(;n<r;n++)1===(t=this[n]||{}).nodeType&&(k.cleanData(getAll(t,!1)),t.innerHTML=e);t=0}catch(e){}}t&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var n=[];return domManip(this,arguments,function(e){var t=this.parentNode;k.inArray(this,n)<0&&(k.cleanData(getAll(this)),t&&t.replaceChild(e,this))},n)}}),k.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,a){k.fn[e]=function(e){for(var t,n=[],r=k(e),i=r.length-1,o=0;o<=i;o++)t=o===i?this:this.clone(!0),k(r[o])[a](t),u.apply(n,t.get());return this.pushStack(n)}});var ue=/^margin/,le=new RegExp("^("+R+")(?!px)[a-z%]+$","i"),ce=function(e){var t=e.ownerDocument.defaultView;return t&&t.opener||(t=C),t.getComputedStyle(e)};function curCSS(e,t,n){var r,i,o,a,s=e.style;return(n=n||ce(e))&&(""!==(a=n.getPropertyValue(t)||n[t])||k.contains(e.ownerDocument,e)||(a=k.style(e,t)),!m.pixelMarginRight()&&le.test(a)&&ue.test(t)&&(r=s.width,i=s.minWidth,o=s.maxWidth,s.minWidth=s.maxWidth=s.width=a,a=n.width,s.width=r,s.minWidth=i,s.maxWidth=o)),void 0!==a?a+"":a}function addGetHookIf(e,t){return{get:function(){if(!e())return(this.get=t).apply(this,arguments);delete this.get}}}!function(){function computeStyleTests(){if(a){a.style.cssText="box-sizing:border-box;position:relative;display:block;margin:auto;border:1px;padding:1px;top:1%;width:50%",a.innerHTML="",Z.appendChild(o);var e=C.getComputedStyle(a);t="1%"!==e.top,i="2px"===e.marginLeft,n="4px"===e.width,a.style.marginRight="50%",r="4px"===e.marginRight,Z.removeChild(o),a=null}}var t,n,r,i,o=S.createElement("div"),a=S.createElement("div");a.style&&(a.style.backgroundClip="content-box",a.cloneNode(!0).style.backgroundClip="",m.clearCloneStyle="content-box"===a.style.backgroundClip,o.style.cssText="border:0;width:8px;height:0;top:0;left:-9999px;padding:0;margin-top:1px;position:absolute",o.appendChild(a),k.extend(m,{pixelPosition:function(){return computeStyleTests(),t},boxSizingReliable:function(){return computeStyleTests(),n},pixelMarginRight:function(){return computeStyleTests(),r},reliableMarginLeft:function(){return computeStyleTests(),i}}))}();var fe=/^(none|table(?!-c[ea]).+)/,de={position:"absolute",visibility:"hidden",display:"block"},pe={letterSpacing:"0",fontWeight:"400"},he=["Webkit","Moz","ms"],ge=S.createElement("div").style;function vendorPropName(e){if(e in ge)return e;for(var t=e[0].toUpperCase()+e.slice(1),n=he.length;n--;)if((e=he[n]+t)in ge)return e}function setPositiveNumber(e,t,n){var r=W.exec(t);return r?Math.max(0,r[2]-(n||0))+(r[3]||"px"):t}function augmentWidthOrHeight(e,t,n,r,i){for(var o=n===(r?"border":"content")?4:"width"===t?1:0,a=0;o<4;o+=2)"margin"===n&&(a+=k.css(e,n+$[o],!0,i)),r?("content"===n&&(a-=k.css(e,"padding"+$[o],!0,i)),"margin"!==n&&(a-=k.css(e,"border"+$[o]+"Width",!0,i))):(a+=k.css(e,"padding"+$[o],!0,i),"padding"!==n&&(a+=k.css(e,"border"+$[o]+"Width",!0,i)));return a}function getWidthOrHeight(e,t,n){var r,i=!0,o=ce(e),a="border-box"===k.css(e,"boxSizing",!1,o);if(e.getClientRects().length&&(r=e.getBoundingClientRect()[t]),r<=0||null==r){if(((r=curCSS(e,t,o))<0||null==r)&&(r=e.style[t]),le.test(r))return r;i=a&&(m.boxSizingReliable()||r===e.style[t]),r=parseFloat(r)||0}return r+augmentWidthOrHeight(e,t,n||(a?"border":"content"),i,o)+"px"}function Tween(e,t,n,r,i){return new Tween.prototype.init(e,t,n,r,i)}k.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=curCSS(e,"opacity");return""===n?"1":n}}}},cssNumber:{animationIterationCount:!0,columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{float:"cssFloat"},style:function(e,t,n,r){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var i,o,a,s=k.camelCase(t),u=e.style;if(t=k.cssProps[s]||(k.cssProps[s]=vendorPropName(s)||s),a=k.cssHooks[t]||k.cssHooks[s],void 0===n)return a&&"get"in a&&void 0!==(i=a.get(e,!1,r))?i:u[t];"string"===(o=typeof n)&&(i=W.exec(n))&&i[1]&&(n=adjustCSS(e,t,i),o="number"),null!=n&&n==n&&("number"===o&&(n+=i&&i[3]||(k.cssNumber[s]?"":"px")),m.clearCloneStyle||""!==n||0!==t.indexOf("background")||(u[t]="inherit"),a&&"set"in a&&void 0===(n=a.set(e,n,r))||(u[t]=n))}},css:function(e,t,n,r){var i,o,a,s=k.camelCase(t);return t=k.cssProps[s]||(k.cssProps[s]=vendorPropName(s)||s),(a=k.cssHooks[t]||k.cssHooks[s])&&"get"in a&&(i=a.get(e,!0,n)),void 0===i&&(i=curCSS(e,t,r)),"normal"===i&&t in pe&&(i=pe[t]),""===n||n?(o=parseFloat(i),!0===n||isFinite(o)?o||0:i):i}}),k.each(["height","width"],function(e,a){k.cssHooks[a]={get:function(e,t,n){if(t)return!fe.test(k.css(e,"display"))||e.getClientRects().length&&e.getBoundingClientRect().width?getWidthOrHeight(e,a,n):_(e,de,function(){return getWidthOrHeight(e,a,n)})},set:function(e,t,n){var r,i=n&&ce(e),o=n&&augmentWidthOrHeight(e,a,n,"border-box"===k.css(e,"boxSizing",!1,i),i);return o&&(r=W.exec(t))&&"px"!==(r[3]||"px")&&(e.style[a]=t,t=k.css(e,a)),setPositiveNumber(0,t,o)}}}),k.cssHooks.marginLeft=addGetHookIf(m.reliableMarginLeft,function(e,t){if(t)return(parseFloat(curCSS(e,"marginLeft"))||e.getBoundingClientRect().left-_(e,{marginLeft:0},function(){return e.getBoundingClientRect().left}))+"px"}),k.each({margin:"",padding:"",border:"Width"},function(i,o){k.cssHooks[i+o]={expand:function(e){for(var t=0,n={},r="string"==typeof e?e.split(" "):[e];t<4;t++)n[i+$[t]+o]=r[t]||r[t-2]||r[0];return n}},ue.test(i)||(k.cssHooks[i+o].set=setPositiveNumber)}),k.fn.extend({css:function(e,t){return L(this,function(e,t,n){var r,i,o={},a=0;if(k.isArray(t)){for(r=ce(e),i=t.length;a<i;a++)o[t[a]]=k.css(e,t[a],!1,r);return o}return void 0!==n?k.style(e,t,n):k.css(e,t)},e,t,1<arguments.length)}}),((k.Tween=Tween).prototype={constructor:Tween,init:function(e,t,n,r,i,o){this.elem=e,this.prop=n,this.easing=i||k.easing._default,this.options=t,this.start=this.now=this.cur(),this.end=r,this.unit=o||(k.cssNumber[n]?"":"px")},cur:function(){var e=Tween.propHooks[this.prop];return e&&e.get?e.get(this):Tween.propHooks._default.get(this)},run:function(e){var t,n=Tween.propHooks[this.prop];return this.options.duration?this.pos=t=k.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):this.pos=t=e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):Tween.propHooks._default.set(this),this}}).init.prototype=Tween.prototype,(Tween.propHooks={_default:{get:function(e){var t;return 1!==e.elem.nodeType||null!=e.elem[e.prop]&&null==e.elem.style[e.prop]?e.elem[e.prop]:(t=k.css(e.elem,e.prop,""))&&"auto"!==t?t:0},set:function(e){k.fx.step[e.prop]?k.fx.step[e.prop](e):1!==e.elem.nodeType||null==e.elem.style[k.cssProps[e.prop]]&&!k.cssHooks[e.prop]?e.elem[e.prop]=e.now:k.style(e.elem,e.prop,e.now+e.unit)}}}).scrollTop=Tween.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},k.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2},_default:"swing"},k.fx=Tween.prototype.init,k.fx.step={};var me,ve,ye,xe,be=/^(?:toggle|show|hide)$/,we=/queueHooks$/;function raf(){ve&&(C.requestAnimationFrame(raf),k.fx.tick())}function createFxNow(){return C.setTimeout(function(){me=void 0}),me=k.now()}function genFx(e,t){var n,r=0,i={height:e};for(t=t?1:0;r<4;r+=2-t)i["margin"+(n=$[r])]=i["padding"+n]=e;return t&&(i.opacity=i.width=e),i}function createTween(e,t,n){for(var r,i=(Animation.tweeners[t]||[]).concat(Animation.tweeners["*"]),o=0,a=i.length;o<a;o++)if(r=i[o].call(n,t,e))return r}function Animation(o,e,t){var n,a,r=0,i=Animation.prefilters.length,s=k.Deferred().always(function(){delete u.elem}),u=function(){if(a)return!1;for(var e=me||createFxNow(),t=Math.max(0,l.startTime+l.duration-e),n=1-(t/l.duration||0),r=0,i=l.tweens.length;r<i;r++)l.tweens[r].run(n);return s.notifyWith(o,[l,n,t]),n<1&&i?t:(s.resolveWith(o,[l]),!1)},l=s.promise({elem:o,props:k.extend({},e),opts:k.extend(!0,{specialEasing:{},easing:k.easing._default},t),originalProperties:e,originalOptions:t,startTime:me||createFxNow(),duration:t.duration,tweens:[],createTween:function(e,t){var n=k.Tween(o,l.opts,e,t,l.opts.specialEasing[e]||l.opts.easing);return l.tweens.push(n),n},stop:function(e){var t=0,n=e?l.tweens.length:0;if(a)return this;for(a=!0;t<n;t++)l.tweens[t].run(1);return e?(s.notifyWith(o,[l,1,0]),s.resolveWith(o,[l,e])):s.rejectWith(o,[l,e]),this}}),c=l.props;for(!function propFilter(e,t){var n,r,i,o,a;for(n in e)if(i=t[r=k.camelCase(n)],o=e[n],k.isArray(o)&&(i=o[1],o=e[n]=o[0]),n!==r&&(e[r]=o,delete e[n]),(a=k.cssHooks[r])&&"expand"in a)for(n in o=a.expand(o),delete e[r],o)n in e||(e[n]=o[n],t[n]=i);else t[r]=i}(c,l.opts.specialEasing);r<i;r++)if(n=Animation.prefilters[r].call(l,o,c,l.opts))return k.isFunction(n.stop)&&(k._queueHooks(l.elem,l.opts.queue).stop=k.proxy(n.stop,n)),n;return k.map(c,createTween,l),k.isFunction(l.opts.start)&&l.opts.start.call(o,l),k.fx.timer(k.extend(u,{elem:o,anim:l,queue:l.opts.queue})),l.progress(l.opts.progress).done(l.opts.done,l.opts.complete).fail(l.opts.fail).always(l.opts.always)}k.Animation=k.extend(Animation,{tweeners:{"*":[function(e,t){var n=this.createTween(e,t);return adjustCSS(n.elem,e,W.exec(t),n),n}]},tweener:function(e,t){for(var n,r=0,i=(e=k.isFunction(e)?(t=e,["*"]):e.match(F)).length;r<i;r++)n=e[r],Animation.tweeners[n]=Animation.tweeners[n]||[],Animation.tweeners[n].unshift(t)},prefilters:[function defaultPrefilter(e,t,n){var r,i,o,a,s,u,l,c,f="width"in t||"height"in t,d=this,p={},h=e.style,g=e.nodeType&&B(e),m=O.get(e,"fxshow");for(r in n.queue||(null==(a=k._queueHooks(e,"fx")).unqueued&&(a.unqueued=0,s=a.empty.fire,a.empty.fire=function(){a.unqueued||s()}),a.unqueued++,d.always(function(){d.always(function(){a.unqueued--,k.queue(e,"fx").length||a.empty.fire()})})),t)if(i=t[r],be.test(i)){if(delete t[r],o=o||"toggle"===i,i===(g?"hide":"show")){if("show"!==i||!m||void 0===m[r])continue;g=!0}p[r]=m&&m[r]||k.style(e,r)}if((u=!k.isEmptyObject(t))||!k.isEmptyObject(p))for(r in f&&1===e.nodeType&&(n.overflow=[h.overflow,h.overflowX,h.overflowY],null==(l=m&&m.display)&&(l=O.get(e,"display")),"none"===(c=k.css(e,"display"))&&(l?c=l:(showHide([e],!0),l=e.style.display||l,c=k.css(e,"display"),showHide([e]))),("inline"===c||"inline-block"===c&&null!=l)&&"none"===k.css(e,"float")&&(u||(d.done(function(){h.display=l}),null==l&&(c=h.display,l="none"===c?"":c)),h.display="inline-block")),n.overflow&&(h.overflow="hidden",d.always(function(){h.overflow=n.overflow[0],h.overflowX=n.overflow[1],h.overflowY=n.overflow[2]})),u=!1,p)u||(m?"hidden"in m&&(g=m.hidden):m=O.access(e,"fxshow",{display:l}),o&&(m.hidden=!g),g&&showHide([e],!0),d.done(function(){for(r in g||showHide([e]),O.remove(e,"fxshow"),p)k.style(e,r,p[r])})),u=createTween(g?m[r]:0,r,d),r in m||(m[r]=u.start,g&&(u.end=u.start,u.start=0))}],prefilter:function(e,t){t?Animation.prefilters.unshift(e):Animation.prefilters.push(e)}}),k.speed=function(e,t,n){var r=e&&"object"==typeof e?k.extend({},e):{complete:n||!n&&t||k.isFunction(e)&&e,duration:e,easing:n&&t||t&&!k.isFunction(t)&&t};return k.fx.off||S.hidden?r.duration=0:r.duration="number"==typeof r.duration?r.duration:r.duration in k.fx.speeds?k.fx.speeds[r.duration]:k.fx.speeds._default,null!=r.queue&&!0!==r.queue||(r.queue="fx"),r.old=r.complete,r.complete=function(){k.isFunction(r.old)&&r.old.call(this),r.queue&&k.dequeue(this,r.queue)},r},k.fn.extend({fadeTo:function(e,t,n,r){return this.filter(B).css("opacity",0).show().end().animate({opacity:t},e,n,r)},animate:function(t,e,n,r){var i=k.isEmptyObject(t),o=k.speed(e,n,r),a=function(){var e=Animation(this,k.extend({},t),o);(i||O.get(this,"finish"))&&e.stop(!0)};return a.finish=a,i||!1===o.queue?this.each(a):this.queue(o.queue,a)},stop:function(i,e,o){var a=function(e){var t=e.stop;delete e.stop,t(o)};return"string"!=typeof i&&(o=e,e=i,i=void 0),e&&!1!==i&&this.queue(i||"fx",[]),this.each(function(){var e=!0,t=null!=i&&i+"queueHooks",n=k.timers,r=O.get(this);if(t)r[t]&&r[t].stop&&a(r[t]);else for(t in r)r[t]&&r[t].stop&&we.test(t)&&a(r[t]);for(t=n.length;t--;)n[t].elem!==this||null!=i&&n[t].queue!==i||(n[t].anim.stop(o),e=!1,n.splice(t,1));!e&&o||k.dequeue(this,i)})},finish:function(a){return!1!==a&&(a=a||"fx"),this.each(function(){var e,t=O.get(this),n=t[a+"queue"],r=t[a+"queueHooks"],i=k.timers,o=n?n.length:0;for(t.finish=!0,k.queue(this,a,[]),r&&r.stop&&r.stop.call(this,!0),e=i.length;e--;)i[e].elem===this&&i[e].queue===a&&(i[e].anim.stop(!0),i.splice(e,1));for(e=0;e<o;e++)n[e]&&n[e].finish&&n[e].finish.call(this);delete t.finish})}}),k.each(["toggle","show","hide"],function(e,r){var i=k.fn[r];k.fn[r]=function(e,t,n){return null==e||"boolean"==typeof e?i.apply(this,arguments):this.animate(genFx(r,!0),e,t,n)}}),k.each({slideDown:genFx("show"),slideUp:genFx("hide"),slideToggle:genFx("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,r){k.fn[e]=function(e,t,n){return this.animate(r,e,t,n)}}),k.timers=[],k.fx.tick=function(){var e,t=0,n=k.timers;for(me=k.now();t<n.length;t++)(e=n[t])()||n[t]!==e||n.splice(t--,1);n.length||k.fx.stop(),me=void 0},k.fx.timer=function(e){k.timers.push(e),e()?k.fx.start():k.timers.pop()},k.fx.interval=13,k.fx.start=function(){ve||(ve=C.requestAnimationFrame?C.requestAnimationFrame(raf):C.setInterval(k.fx.tick,k.fx.interval))},k.fx.stop=function(){C.cancelAnimationFrame?C.cancelAnimationFrame(ve):C.clearInterval(ve),ve=null},k.fx.speeds={slow:600,fast:200,_default:400},k.fn.delay=function(r,e){return r=k.fx&&k.fx.speeds[r]||r,e=e||"fx",this.queue(e,function(e,t){var n=C.setTimeout(e,r);t.stop=function(){C.clearTimeout(n)}})},ye=S.createElement("input"),xe=S.createElement("select").appendChild(S.createElement("option")),ye.type="checkbox",m.checkOn=""!==ye.value,m.optSelected=xe.selected,(ye=S.createElement("input")).value="t",ye.type="radio",m.radioValue="t"===ye.value;var Te,Ce=k.expr.attrHandle;k.fn.extend({attr:function(e,t){return L(this,k.attr,e,t,1<arguments.length)},removeAttr:function(e){return this.each(function(){k.removeAttr(this,e)})}}),k.extend({attr:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return void 0===e.getAttribute?k.prop(e,t,n):(1===o&&k.isXMLDoc(e)||(i=k.attrHooks[t.toLowerCase()]||(k.expr.match.bool.test(t)?Te:void 0)),void 0!==n?null===n?void k.removeAttr(e,t):i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:(e.setAttribute(t,n+""),n):i&&"get"in i&&null!==(r=i.get(e,t))?r:null==(r=k.find.attr(e,t))?void 0:r)},attrHooks:{type:{set:function(e,t){if(!m.radioValue&&"radio"===t&&k.nodeName(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}}},removeAttr:function(e,t){var n,r=0,i=t&&t.match(F);if(i&&1===e.nodeType)for(;n=i[r++];)e.removeAttribute(n)}}),Te={set:function(e,t,n){return!1===t?k.removeAttr(e,n):e.setAttribute(n,n),n}},k.each(k.expr.match.bool.source.match(/\w+/g),function(e,t){var a=Ce[t]||k.find.attr;Ce[t]=function(e,t,n){var r,i,o=t.toLowerCase();return n||(i=Ce[o],Ce[o]=r,r=null!=a(e,t,n)?o:null,Ce[o]=i),r}});var Se=/^(?:input|select|textarea|button)$/i,ke=/^(?:a|area)$/i;k.fn.extend({prop:function(e,t){return L(this,k.prop,e,t,1<arguments.length)},removeProp:function(e){return this.each(function(){delete this[k.propFix[e]||e]})}}),k.extend({prop:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return 1===o&&k.isXMLDoc(e)||(t=k.propFix[t]||t,i=k.propHooks[t]),void 0!==n?i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:e[t]=n:i&&"get"in i&&null!==(r=i.get(e,t))?r:e[t]},propHooks:{tabIndex:{get:function(e){var t=k.find.attr(e,"tabindex");return t?parseInt(t,10):Se.test(e.nodeName)||ke.test(e.nodeName)&&e.href?0:-1}}},propFix:{for:"htmlFor",class:"className"}}),m.optSelected||(k.propHooks.selected={get:function(e){var t=e.parentNode;return t&&t.parentNode&&t.parentNode.selectedIndex,null},set:function(e){var t=e.parentNode;t&&(t.selectedIndex,t.parentNode&&t.parentNode.selectedIndex)}}),k.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){k.propFix[this.toLowerCase()]=this});var Ee=/[\t\r\n\f]/g;function getClass(e){return e.getAttribute&&e.getAttribute("class")||""}k.fn.extend({addClass:function(t){var e,n,r,i,o,a,s,u=0;if(k.isFunction(t))return this.each(function(e){k(this).addClass(t.call(this,e,getClass(this)))});if("string"==typeof t&&t)for(e=t.match(F)||[];n=this[u++];)if(i=getClass(n),r=1===n.nodeType&&(" "+i+" ").replace(Ee," ")){for(a=0;o=e[a++];)r.indexOf(" "+o+" ")<0&&(r+=o+" ");i!==(s=k.trim(r))&&n.setAttribute("class",s)}return this},removeClass:function(t){var e,n,r,i,o,a,s,u=0;if(k.isFunction(t))return this.each(function(e){k(this).removeClass(t.call(this,e,getClass(this)))});if(!arguments.length)return this.attr("class","");if("string"==typeof t&&t)for(e=t.match(F)||[];n=this[u++];)if(i=getClass(n),r=1===n.nodeType&&(" "+i+" ").replace(Ee," ")){for(a=0;o=e[a++];)for(;-1<r.indexOf(" "+o+" ");)r=r.replace(" "+o+" "," ");i!==(s=k.trim(r))&&n.setAttribute("class",s)}return this},toggleClass:function(i,t){var o=typeof i;return"boolean"==typeof t&&"string"===o?t?this.addClass(i):this.removeClass(i):k.isFunction(i)?this.each(function(e){k(this).toggleClass(i.call(this,e,getClass(this),t),t)}):this.each(function(){var e,t,n,r;if("string"===o)for(t=0,n=k(this),r=i.match(F)||[];e=r[t++];)n.hasClass(e)?n.removeClass(e):n.addClass(e);else void 0!==i&&"boolean"!==o||((e=getClass(this))&&O.set(this,"__className__",e),this.setAttribute&&this.setAttribute("class",e||!1===i?"":O.get(this,"__className__")||""))})},hasClass:function(e){var t,n,r=0;for(t=" "+e+" ";n=this[r++];)if(1===n.nodeType&&-1<(" "+getClass(n)+" ").replace(Ee," ").indexOf(t))return!0;return!1}});var Ae=/\r/g,Ne=/[\x20\t\r\n\f]+/g;k.fn.extend({val:function(n){var r,e,i,t=this[0];return arguments.length?(i=k.isFunction(n),this.each(function(e){var t;1===this.nodeType&&(null==(t=i?n.call(this,e,k(this).val()):n)?t="":"number"==typeof t?t+="":k.isArray(t)&&(t=k.map(t,function(e){return null==e?"":e+""})),(r=k.valHooks[this.type]||k.valHooks[this.nodeName.toLowerCase()])&&"set"in r&&void 0!==r.set(this,t,"value")||(this.value=t))})):t?(r=k.valHooks[t.type]||k.valHooks[t.nodeName.toLowerCase()])&&"get"in r&&void 0!==(e=r.get(t,"value"))?e:"string"==typeof(e=t.value)?e.replace(Ae,""):null==e?"":e:void 0}}),k.extend({valHooks:{option:{get:function(e){var t=k.find.attr(e,"value");return null!=t?t:k.trim(k.text(e)).replace(Ne," ")}},select:{get:function(e){for(var t,n,r=e.options,i=e.selectedIndex,o="select-one"===e.type,a=o?null:[],s=o?i+1:r.length,u=i<0?s:o?i:0;u<s;u++)if(((n=r[u]).selected||u===i)&&!n.disabled&&(!n.parentNode.disabled||!k.nodeName(n.parentNode,"optgroup"))){if(t=k(n).val(),o)return t;a.push(t)}return a},set:function(e,t){for(var n,r,i=e.options,o=k.makeArray(t),a=i.length;a--;)((r=i[a]).selected=-1<k.inArray(k.valHooks.option.get(r),o))&&(n=!0);return n||(e.selectedIndex=-1),o}}}}),k.each(["radio","checkbox"],function(){k.valHooks[this]={set:function(e,t){if(k.isArray(t))return e.checked=-1<k.inArray(k(e).val(),t)}},m.checkOn||(k.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})});var De=/^(?:focusinfocus|focusoutblur)$/;k.extend(k.event,{trigger:function(e,t,n,r){var i,o,a,s,u,l,c,f=[n||S],d=h.call(e,"type")?e.type:e,p=h.call(e,"namespace")?e.namespace.split("."):[];if(o=a=n=n||S,3!==n.nodeType&&8!==n.nodeType&&!De.test(d+k.event.triggered)&&(-1<d.indexOf(".")&&(d=(p=d.split(".")).shift(),p.sort()),u=d.indexOf(":")<0&&"on"+d,(e=e[k.expando]?e:new k.Event(d,"object"==typeof e&&e)).isTrigger=r?2:3,e.namespace=p.join("."),e.rnamespace=e.namespace?new RegExp("(^|\\.)"+p.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,e.result=void 0,e.target||(e.target=n),t=null==t?[e]:k.makeArray(t,[e]),c=k.event.special[d]||{},r||!c.trigger||!1!==c.trigger.apply(n,t))){if(!r&&!c.noBubble&&!k.isWindow(n)){for(s=c.delegateType||d,De.test(s+d)||(o=o.parentNode);o;o=o.parentNode)f.push(o),a=o;a===(n.ownerDocument||S)&&f.push(a.defaultView||a.parentWindow||C)}for(i=0;(o=f[i++])&&!e.isPropagationStopped();)e.type=1<i?s:c.bindType||d,(l=(O.get(o,"events")||{})[e.type]&&O.get(o,"handle"))&&l.apply(o,t),(l=u&&o[u])&&l.apply&&P(o)&&(e.result=l.apply(o,t),!1===e.result&&e.preventDefault());return e.type=d,r||e.isDefaultPrevented()||c._default&&!1!==c._default.apply(f.pop(),t)||!P(n)||u&&k.isFunction(n[d])&&!k.isWindow(n)&&((a=n[u])&&(n[u]=null),n[k.event.triggered=d](),k.event.triggered=void 0,a&&(n[u]=a)),e.result}},simulate:function(e,t,n){var r=k.extend(new k.Event,n,{type:e,isSimulated:!0});k.event.trigger(r,null,t)}}),k.fn.extend({trigger:function(e,t){return this.each(function(){k.event.trigger(e,t,this)})},triggerHandler:function(e,t){var n=this[0];if(n)return k.event.trigger(e,t,n,!0)}}),k.each("blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu".split(" "),function(e,n){k.fn[n]=function(e,t){return 0<arguments.length?this.on(n,null,e,t):this.trigger(n)}}),k.fn.extend({hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)}}),m.focusin="onfocusin"in C,m.focusin||k.each({focus:"focusin",blur:"focusout"},function(n,r){var i=function(e){k.event.simulate(r,e.target,k.event.fix(e))};k.event.special[r]={setup:function(){var e=this.ownerDocument||this,t=O.access(e,r);t||e.addEventListener(n,i,!0),O.access(e,r,(t||0)+1)},teardown:function(){var e=this.ownerDocument||this,t=O.access(e,r)-1;t?O.access(e,r,t):(e.removeEventListener(n,i,!0),O.remove(e,r))}}});var je=C.location,Fe=k.now(),qe=/\?/;k.parseXML=function(e){var t;if(!e||"string"!=typeof e)return null;try{t=(new C.DOMParser).parseFromString(e,"text/xml")}catch(e){t=void 0}return t&&!t.getElementsByTagName("parsererror").length||k.error("Invalid XML: "+e),t};var He=/\[\]$/,Le=/\r?\n/g,Pe=/^(?:submit|button|image|reset|file)$/i,Oe=/^(?:input|select|textarea|keygen)/i;function buildParams(n,e,r,i){var t;if(k.isArray(e))k.each(e,function(e,t){r||He.test(n)?i(n,t):buildParams(n+"["+("object"==typeof t&&null!=t?e:"")+"]",t,r,i)});else if(r||"object"!==k.type(e))i(n,e);else for(t in e)buildParams(n+"["+t+"]",e[t],r,i)}k.param=function(e,t){var n,r=[],i=function(e,t){var n=k.isFunction(t)?t():t;r[r.length]=encodeURIComponent(e)+"="+encodeURIComponent(null==n?"":n)};if(k.isArray(e)||e.jquery&&!k.isPlainObject(e))k.each(e,function(){i(this.name,this.value)});else for(n in e)buildParams(n,e[n],t,i);return r.join("&")},k.fn.extend({serialize:function(){return k.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=k.prop(this,"elements");return e?k.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!k(this).is(":disabled")&&Oe.test(this.nodeName)&&!Pe.test(e)&&(this.checked||!U.test(e))}).map(function(e,t){var n=k(this).val();return null==n?null:k.isArray(n)?k.map(n,function(e){return{name:t.name,value:e.replace(Le,"\r\n")}}):{name:t.name,value:n.replace(Le,"\r\n")}}).get()}});var Me=/%20/g,ze=/#.*$/,Ie=/([?&])_=[^&]*/,Re=/^(.*?):[ \t]*([^\r\n]*)$/gm,We=/^(?:GET|HEAD)$/,$e=/^\/\//,Be={},_e={},Xe="*/".concat("*"),Ue=S.createElement("a");function addToPrefiltersOrTransports(o){return function(e,t){"string"!=typeof e&&(t=e,e="*");var n,r=0,i=e.toLowerCase().match(F)||[];if(k.isFunction(t))for(;n=i[r++];)"+"===n[0]?(n=n.slice(1)||"*",(o[n]=o[n]||[]).unshift(t)):(o[n]=o[n]||[]).push(t)}}function inspectPrefiltersOrTransports(t,i,o,a){var s={},u=t===_e;function inspect(e){var r;return s[e]=!0,k.each(t[e]||[],function(e,t){var n=t(i,o,a);return"string"!=typeof n||u||s[n]?u?!(r=n):void 0:(i.dataTypes.unshift(n),inspect(n),!1)}),r}return inspect(i.dataTypes[0])||!s["*"]&&inspect("*")}function ajaxExtend(e,t){var n,r,i=k.ajaxSettings.flatOptions||{};for(n in t)void 0!==t[n]&&((i[n]?e:r||(r={}))[n]=t[n]);return r&&k.extend(!0,e,r),e}Ue.href=je.href,k.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:je.href,type:"GET",isLocal:/^(?:about|app|app-storage|.+-extension|file|res|widget):$/.test(je.protocol),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":Xe,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":JSON.parse,"text xml":k.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?ajaxExtend(ajaxExtend(e,k.ajaxSettings),t):ajaxExtend(k.ajaxSettings,e)},ajaxPrefilter:addToPrefiltersOrTransports(Be),ajaxTransport:addToPrefiltersOrTransports(_e),ajax:function(e,t){"object"==typeof e&&(t=e,e=void 0),t=t||{};var c,f,d,n,p,r,h,g,i,o,m=k.ajaxSetup({},t),v=m.context||m,y=m.context&&(v.nodeType||v.jquery)?k(v):k.event,x=k.Deferred(),b=k.Callbacks("once memory"),w=m.statusCode||{},a={},s={},u="canceled",T={readyState:0,getResponseHeader:function(e){var t;if(h){if(!n)for(n={};t=Re.exec(d);)n[t[1].toLowerCase()]=t[2];t=n[e.toLowerCase()]}return null==t?null:t},getAllResponseHeaders:function(){return h?d:null},setRequestHeader:function(e,t){return null==h&&(e=s[e.toLowerCase()]=s[e.toLowerCase()]||e,a[e]=t),this},overrideMimeType:function(e){return null==h&&(m.mimeType=e),this},statusCode:function(e){var t;if(e)if(h)T.always(e[T.status]);else for(t in e)w[t]=[w[t],e[t]];return this},abort:function(e){var t=e||u;return c&&c.abort(t),done(0,t),this}};if(x.promise(T),m.url=((e||m.url||je.href)+"").replace($e,je.protocol+"//"),m.type=t.method||t.type||m.method||m.type,m.dataTypes=(m.dataType||"*").toLowerCase().match(F)||[""],null==m.crossDomain){r=S.createElement("a");try{r.href=m.url,r.href=r.href,m.crossDomain=Ue.protocol+"//"+Ue.host!=r.protocol+"//"+r.host}catch(e){m.crossDomain=!0}}if(m.data&&m.processData&&"string"!=typeof m.data&&(m.data=k.param(m.data,m.traditional)),inspectPrefiltersOrTransports(Be,m,t,T),h)return T;for(i in(g=k.event&&m.global)&&0==k.active++&&k.event.trigger("ajaxStart"),m.type=m.type.toUpperCase(),m.hasContent=!We.test(m.type),f=m.url.replace(ze,""),m.hasContent?m.data&&m.processData&&0===(m.contentType||"").indexOf("application/x-www-form-urlencoded")&&(m.data=m.data.replace(Me,"+")):(o=m.url.slice(f.length),m.data&&(f+=(qe.test(f)?"&":"?")+m.data,delete m.data),!1===m.cache&&(f=f.replace(Ie,""),o=(qe.test(f)?"&":"?")+"_="+Fe+++o),m.url=f+o),m.ifModified&&(k.lastModified[f]&&T.setRequestHeader("If-Modified-Since",k.lastModified[f]),k.etag[f]&&T.setRequestHeader("If-None-Match",k.etag[f])),(m.data&&m.hasContent&&!1!==m.contentType||t.contentType)&&T.setRequestHeader("Content-Type",m.contentType),T.setRequestHeader("Accept",m.dataTypes[0]&&m.accepts[m.dataTypes[0]]?m.accepts[m.dataTypes[0]]+("*"!==m.dataTypes[0]?", "+Xe+"; q=0.01":""):m.accepts["*"]),m.headers)T.setRequestHeader(i,m.headers[i]);if(m.beforeSend&&(!1===m.beforeSend.call(v,T,m)||h))return T.abort();if(u="abort",b.add(m.complete),T.done(m.success),T.fail(m.error),c=inspectPrefiltersOrTransports(_e,m,t,T)){if(T.readyState=1,g&&y.trigger("ajaxSend",[T,m]),h)return T;m.async&&0<m.timeout&&(p=C.setTimeout(function(){T.abort("timeout")},m.timeout));try{h=!1,c.send(a,done)}catch(e){if(h)throw e;done(-1,e)}}else done(-1,"No Transport");function done(e,t,n,r){var i,o,a,s,u,l=t;h||(h=!0,p&&C.clearTimeout(p),c=void 0,d=r||"",T.readyState=0<e?4:0,i=200<=e&&e<300||304===e,n&&(s=function ajaxHandleResponses(e,t,n){for(var r,i,o,a,s=e.contents,u=e.dataTypes;"*"===u[0];)u.shift(),void 0===r&&(r=e.mimeType||t.getResponseHeader("Content-Type"));if(r)for(i in s)if(s[i]&&s[i].test(r)){u.unshift(i);break}if(u[0]in n)o=u[0];else{for(i in n){if(!u[0]||e.converters[i+" "+u[0]]){o=i;break}a||(a=i)}o=o||a}if(o)return o!==u[0]&&u.unshift(o),n[o]}(m,T,n)),s=function ajaxConvert(e,t,n,r){var i,o,a,s,u,l={},c=e.dataTypes.slice();if(c[1])for(a in e.converters)l[a.toLowerCase()]=e.converters[a];for(o=c.shift();o;)if(e.responseFields[o]&&(n[e.responseFields[o]]=t),!u&&r&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),u=o,o=c.shift())if("*"===o)o=u;else if("*"!==u&&u!==o){if(!(a=l[u+" "+o]||l["* "+o]))for(i in l)if((s=i.split(" "))[1]===o&&(a=l[u+" "+s[0]]||l["* "+s[0]])){!0===a?a=l[i]:!0!==l[i]&&(o=s[0],c.unshift(s[1]));break}if(!0!==a)if(a&&e.throws)t=a(t);else try{t=a(t)}catch(e){return{state:"parsererror",error:a?e:"No conversion from "+u+" to "+o}}}return{state:"success",data:t}}(m,s,T,i),i?(m.ifModified&&((u=T.getResponseHeader("Last-Modified"))&&(k.lastModified[f]=u),(u=T.getResponseHeader("etag"))&&(k.etag[f]=u)),204===e||"HEAD"===m.type?l="nocontent":304===e?l="notmodified":(l=s.state,o=s.data,i=!(a=s.error))):(a=l,!e&&l||(l="error",e<0&&(e=0))),T.status=e,T.statusText=(t||l)+"",i?x.resolveWith(v,[o,l,T]):x.rejectWith(v,[T,l,a]),T.statusCode(w),w=void 0,g&&y.trigger(i?"ajaxSuccess":"ajaxError",[T,m,i?o:a]),b.fireWith(v,[T,l]),g&&(y.trigger("ajaxComplete",[T,m]),--k.active||k.event.trigger("ajaxStop")))}return T},getJSON:function(e,t,n){return k.get(e,t,n,"json")},getScript:function(e,t){return k.get(e,void 0,t,"script")}}),k.each(["get","post"],function(e,i){k[i]=function(e,t,n,r){return k.isFunction(t)&&(r=r||n,n=t,t=void 0),k.ajax(k.extend({url:e,type:i,dataType:r,data:t,success:n},k.isPlainObject(e)&&e))}}),k._evalUrl=function(e){return k.ajax({url:e,type:"GET",dataType:"script",cache:!0,async:!1,global:!1,throws:!0})},k.fn.extend({wrapAll:function(e){var t;return this[0]&&(k.isFunction(e)&&(e=e.call(this[0])),t=k(e,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){for(var e=this;e.firstElementChild;)e=e.firstElementChild;return e}).append(this)),this},wrapInner:function(n){return k.isFunction(n)?this.each(function(e){k(this).wrapInner(n.call(this,e))}):this.each(function(){var e=k(this),t=e.contents();t.length?t.wrapAll(n):e.append(n)})},wrap:function(t){var n=k.isFunction(t);return this.each(function(e){k(this).wrapAll(n?t.call(this,e):t)})},unwrap:function(e){return this.parent(e).not("body").each(function(){k(this).replaceWith(this.childNodes)}),this}}),k.expr.pseudos.hidden=function(e){return!k.expr.pseudos.visible(e)},k.expr.pseudos.visible=function(e){return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)},k.ajaxSettings.xhr=function(){try{return new C.XMLHttpRequest}catch(e){}};var Ge={0:200,1223:204},Ve=k.ajaxSettings.xhr();m.cors=!!Ve&&"withCredentials"in Ve,m.ajax=Ve=!!Ve,k.ajaxTransport(function(i){var o,a;if(m.cors||Ve&&!i.crossDomain)return{send:function(e,t){var n,r=i.xhr();if(r.open(i.type,i.url,i.async,i.username,i.password),i.xhrFields)for(n in i.xhrFields)r[n]=i.xhrFields[n];for(n in i.mimeType&&r.overrideMimeType&&r.overrideMimeType(i.mimeType),i.crossDomain||e["X-Requested-With"]||(e["X-Requested-With"]="XMLHttpRequest"),e)r.setRequestHeader(n,e[n]);o=function(e){return function(){o&&(o=a=r.onload=r.onerror=r.onabort=r.onreadystatechange=null,"abort"===e?r.abort():"error"===e?"number"!=typeof r.status?t(0,"error"):t(r.status,r.statusText):t(Ge[r.status]||r.status,r.statusText,"text"!==(r.responseType||"text")||"string"!=typeof r.responseText?{binary:r.response}:{text:r.responseText},r.getAllResponseHeaders()))}},r.onload=o(),a=r.onerror=o("error"),void 0!==r.onabort?r.onabort=a:r.onreadystatechange=function(){4===r.readyState&&C.setTimeout(function(){o&&a()})},o=o("abort");try{r.send(i.hasContent&&i.data||null)}catch(e){if(o)throw e}},abort:function(){o&&o()}}}),k.ajaxPrefilter(function(e){e.crossDomain&&(e.contents.script=!1)}),k.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(e){return k.globalEval(e),e}}}),k.ajaxPrefilter("script",function(e){void 0===e.cache&&(e.cache=!1),e.crossDomain&&(e.type="GET")}),k.ajaxTransport("script",function(n){var r,i;if(n.crossDomain)return{send:function(e,t){r=k("<script>").prop({charset:n.scriptCharset,src:n.url}).on("load error",i=function(e){r.remove(),i=null,e&&t("error"===e.type?404:200,e.type)}),S.head.appendChild(r[0])},abort:function(){i&&i()}}});var Ye,Qe=[],Je=/(=)\?(?=&|$)|\?\?/;function getWindow(e){return k.isWindow(e)?e:9===e.nodeType&&e.defaultView}k.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=Qe.pop()||k.expando+"_"+Fe++;return this[e]=!0,e}}),k.ajaxPrefilter("json jsonp",function(e,t,n){var r,i,o,a=!1!==e.jsonp&&(Je.test(e.url)?"url":"string"==typeof e.data&&0===(e.contentType||"").indexOf("application/x-www-form-urlencoded")&&Je.test(e.data)&&"data");if(a||"jsonp"===e.dataTypes[0])return r=e.jsonpCallback=k.isFunction(e.jsonpCallback)?e.jsonpCallback():e.jsonpCallback,a?e[a]=e[a].replace(Je,"$1"+r):!1!==e.jsonp&&(e.url+=(qe.test(e.url)?"&":"?")+e.jsonp+"="+r),e.converters["script json"]=function(){return o||k.error(r+" was not called"),o[0]},e.dataTypes[0]="json",i=C[r],C[r]=function(){o=arguments},n.always(function(){void 0===i?k(C).removeProp(r):C[r]=i,e[r]&&(e.jsonpCallback=t.jsonpCallback,Qe.push(r)),o&&k.isFunction(i)&&i(o[0]),o=i=void 0}),"script"}),m.createHTMLDocument=((Ye=S.implementation.createHTMLDocument("").body).innerHTML="<form></form><form></form>",2===Ye.childNodes.length),k.parseHTML=function(e,t,n){return"string"!=typeof e?[]:("boolean"==typeof t&&(n=t,t=!1),t||(m.createHTMLDocument?((r=(t=S.implementation.createHTMLDocument("")).createElement("base")).href=S.location.href,t.head.appendChild(r)):t=S),o=!n&&[],(i=T.exec(e))?[t.createElement(i[1])]:(i=buildFragment([e],t,o),o&&o.length&&k(o).remove(),k.merge([],i.childNodes)));var r,i,o},k.fn.load=function(e,t,n){var r,i,o,a=this,s=e.indexOf(" ");return-1<s&&(r=k.trim(e.slice(s)),e=e.slice(0,s)),k.isFunction(t)?(n=t,t=void 0):t&&"object"==typeof t&&(i="POST"),0<a.length&&k.ajax({url:e,type:i||"GET",dataType:"html",data:t}).done(function(e){o=arguments,a.html(r?k("<div>").append(k.parseHTML(e)).find(r):e)}).always(n&&function(e,t){a.each(function(){n.apply(this,o||[e.responseText,t,e])})}),this},k.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){k.fn[t]=function(e){return this.on(t,e)}}),k.expr.pseudos.animated=function(t){return k.grep(k.timers,function(e){return t===e.elem}).length},k.offset={setOffset:function(e,t,n){var r,i,o,a,s,u,l=k.css(e,"position"),c=k(e),f={};"static"===l&&(e.style.position="relative"),s=c.offset(),o=k.css(e,"top"),u=k.css(e,"left"),i=("absolute"===l||"fixed"===l)&&-1<(o+u).indexOf("auto")?(a=(r=c.position()).top,r.left):(a=parseFloat(o)||0,parseFloat(u)||0),k.isFunction(t)&&(t=t.call(e,n,k.extend({},s))),null!=t.top&&(f.top=t.top-s.top+a),null!=t.left&&(f.left=t.left-s.left+i),"using"in t?t.using.call(e,f):c.css(f)}},k.fn.extend({offset:function(t){if(arguments.length)return void 0===t?this:this.each(function(e){k.offset.setOffset(this,t,e)});var e,n,r,i,o=this[0];return o?o.getClientRects().length?(r=o.getBoundingClientRect()).width||r.height?(n=getWindow(i=o.ownerDocument),e=i.documentElement,{top:r.top+n.pageYOffset-e.clientTop,left:r.left+n.pageXOffset-e.clientLeft}):r:{top:0,left:0}:void 0},position:function(){if(this[0]){var e,t,n=this[0],r={top:0,left:0};return"fixed"===k.css(n,"position")?t=n.getBoundingClientRect():(e=this.offsetParent(),t=this.offset(),k.nodeName(e[0],"html")||(r=e.offset()),r={top:r.top+k.css(e[0],"borderTopWidth",!0),left:r.left+k.css(e[0],"borderLeftWidth",!0)}),{top:t.top-r.top-k.css(n,"marginTop",!0),left:t.left-r.left-k.css(n,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var e=this.offsetParent;e&&"static"===k.css(e,"position");)e=e.offsetParent;return e||Z})}}),k.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(t,i){var o="pageYOffset"===i;k.fn[t]=function(e){return L(this,function(e,t,n){var r=getWindow(e);if(void 0===n)return r?r[i]:e[t];r?r.scrollTo(o?r.pageXOffset:n,o?n:r.pageYOffset):e[t]=n},t,e,arguments.length)}}),k.each(["top","left"],function(e,n){k.cssHooks[n]=addGetHookIf(m.pixelPosition,function(e,t){if(t)return t=curCSS(e,n),le.test(t)?k(e).position()[n]+"px":t})}),k.each({Height:"height",Width:"width"},function(a,s){k.each({padding:"inner"+a,content:s,"":"outer"+a},function(r,o){k.fn[o]=function(e,t){var n=arguments.length&&(r||"boolean"!=typeof e),i=r||(!0===e||!0===t?"margin":"border");return L(this,function(e,t,n){var r;return k.isWindow(e)?0===o.indexOf("outer")?e["inner"+a]:e.document.documentElement["client"+a]:9===e.nodeType?(r=e.documentElement,Math.max(e.body["scroll"+a],r["scroll"+a],e.body["offset"+a],r["offset"+a],r["client"+a])):void 0===n?k.css(e,t,i):k.style(e,t,n,i)},s,n?e:void 0,n)}})}),k.fn.extend({bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",n)}}),k.parseJSON=JSON.parse,"function"==typeof define&&define.amd&&define("jquery",[],function(){return k});var Ke=C.jQuery,Ze=C.$;return k.noConflict=function(e){return C.$===k&&(C.$=Ze),e&&C.jQuery===k&&(C.jQuery=Ke),k},e||(C.jQuery=C.$=k),k});
!function(a){a.color={},a.color.make=function(t,e,i,o){var n={};return n.r=t||0,n.g=e||0,n.b=i||0,n.a=null!=o?o:1,n.add=function(t,e){for(var i=0;i<t.length;++i)n[t.charAt(i)]+=e;return n.normalize()},n.scale=function(t,e){for(var i=0;i<t.length;++i)n[t.charAt(i)]*=e;return n.normalize()},n.toString=function(){return 1<=n.a?"rgb("+[n.r,n.g,n.b].join(",")+")":"rgba("+[n.r,n.g,n.b,n.a].join(",")+")"},n.normalize=function(){function clamp(t,e,i){return e<t?t:i<e?i:e}return n.r=clamp(0,parseInt(n.r),255),n.g=clamp(0,parseInt(n.g),255),n.b=clamp(0,parseInt(n.b),255),n.a=clamp(0,n.a,1),n},n.clone=function(){return a.color.make(n.r,n.b,n.g,n.a)},n.normalize()},a.color.extract=function(t,e){var i;do{if(""!=(i=t.css(e).toLowerCase())&&"transparent"!=i)break;t=t.parent()}while(t.length&&!a.nodeName(t.get(0),"body"));return"rgba(0, 0, 0, 0)"==i&&(i="transparent"),a.color.parse(i)},a.color.parse=function(t){var e,i=a.color.make;if(e=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(t))return i(parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10));if(e=/rgba\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]+(?:\.[0-9]+)?)\s*\)/.exec(t))return i(parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10),parseFloat(e[4]));if(e=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(t))return i(2.55*parseFloat(e[1]),2.55*parseFloat(e[2]),2.55*parseFloat(e[3]));if(e=/rgba\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\s*\)/.exec(t))return i(2.55*parseFloat(e[1]),2.55*parseFloat(e[2]),2.55*parseFloat(e[3]),parseFloat(e[4]));if(e=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(t))return i(parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16));if(e=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(t))return i(parseInt(e[1]+e[1],16),parseInt(e[2]+e[2],16),parseInt(e[3]+e[3],16));var o=a.trim(t).toLowerCase();return"transparent"==o?i(255,255,255,0):i((e=n[o]||[0,0,0])[0],e[1],e[2])};var n={aqua:[0,255,255],azure:[240,255,255],beige:[245,245,220],black:[0,0,0],blue:[0,0,255],brown:[165,42,42],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgrey:[169,169,169],darkgreen:[0,100,0],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkviolet:[148,0,211],fuchsia:[255,0,255],gold:[255,215,0],green:[0,128,0],indigo:[75,0,130],khaki:[240,230,140],lightblue:[173,216,230],lightcyan:[224,255,255],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightyellow:[255,255,224],lime:[0,255,0],magenta:[255,0,255],maroon:[128,0,0],navy:[0,0,128],olive:[128,128,0],orange:[255,165,0],pink:[255,192,203],purple:[128,0,128],violet:[128,0,128],red:[255,0,0],silver:[192,192,192],white:[255,255,255],yellow:[255,255,0]}}(jQuery),function(z){var f=Object.prototype.hasOwnProperty;function Canvas(t,e){var i=e.children("."+t)[0];if(null==i&&((i=document.createElement("canvas")).className=t,z(i).css({direction:"ltr",position:"absolute",left:0,top:0}).appendTo(e),!i.getContext)){if(!window.G_vmlCanvasManager)throw new Error("Canvas is not available. If you're using IE with a fall-back such as Excanvas, then there's either a mistake in your conditional include, or the page has no DOCTYPE and is rendering in Quirks Mode.");i=window.G_vmlCanvasManager.initElement(i)}this.element=i;var o=this.context=i.getContext("2d"),n=window.devicePixelRatio||1,a=o.webkitBackingStorePixelRatio||o.mozBackingStorePixelRatio||o.msBackingStorePixelRatio||o.oBackingStorePixelRatio||o.backingStorePixelRatio||1;this.pixelRatio=n/a,this.resize(e.width(),e.height()),this.textContainer=null,this.text={},this._textCache={}}function Plot(x,t,e,o){var T=[],S={colors:["#edc240","#afd8f8","#cb4b4b","#4da74d","#9440ed"],legend:{show:!0,noColumns:1,labelFormatter:null,labelBoxBorderColor:"#ccc",container:null,position:"ne",margin:5,backgroundColor:null,backgroundOpacity:.85,sorted:null},xaxis:{show:null,position:"bottom",mode:null,font:null,color:null,tickColor:null,transform:null,inverseTransform:null,min:null,max:null,autoscaleMargin:null,ticks:null,tickFormatter:null,labelWidth:null,labelHeight:null,reserveSpace:null,tickLength:null,alignTicksWithAxis:null,tickDecimals:null,tickSize:null,minTickSize:null},yaxis:{autoscaleMargin:.02,position:"left"},xaxes:[],yaxes:[],series:{points:{show:!1,radius:3,lineWidth:2,fill:!0,fillColor:"#ffffff",symbol:"circle"},lines:{lineWidth:2,fill:!1,fillColor:null,steps:!1},bars:{show:!1,lineWidth:2,barWidth:1,fill:!0,fillColor:null,align:"left",horizontal:!1,zero:!0},shadowSize:3,highlightColor:null},grid:{show:!0,aboveData:!1,color:"#545454",backgroundColor:null,borderColor:null,tickColor:null,margin:0,labelMargin:5,axisMargin:8,borderWidth:2,minBorderMargin:null,markings:null,markingsColor:"#f4f4f4",markingsLineWidth:2,clickable:!1,hoverable:!1,autoHighlight:!0,mouseActiveRadius:10},interaction:{redrawOverlayInterval:1e3/60},hooks:{}},f=null,i=null,h=null,y=null,c=null,p=[],g=[],w={left:0,right:0,top:0,bottom:0},C=0,M=0,A={processOptions:[],processRawData:[],processDatapoints:[],processOffset:[],drawBackground:[],drawSeries:[],draw:[],bindEvents:[],drawOverlay:[],shutdown:[]},W=this;function executeHooks(t,e){e=[W].concat(e);for(var i=0;i<t.length;++i)t[i].apply(this,e)}function setData(t){T=function parseData(t){for(var e=[],i=0;i<t.length;++i){var o=z.extend(!0,{},S.series);null!=t[i].data?(o.data=t[i].data,delete t[i].data,z.extend(!0,o,t[i]),t[i].data=o.data):o.data=t[i],e.push(o)}return e}(t),function fillInSeriesOptions(){var t,e=T.length,i=-1;for(t=0;t<T.length;++t){var o=T[t].color;null!=o&&(e--,"number"==typeof o&&i<o&&(i=o))}e<=i&&(e=i+1);var n,a=[],r=S.colors,l=r.length,s=0;for(t=0;t<e;t++)n=z.color.parse(r[t%l]||"#666"),t%l==0&&t&&(s=0<=s?s<.5?-s-.2:0:-s),a[t]=n.scale("rgb",1+s);var c,h=0;for(t=0;t<T.length;++t){if(null==(c=T[t]).color?(c.color=a[h].toString(),++h):"number"==typeof c.color&&(c.color=a[c.color].toString()),null==c.lines.show){var u,d=!0;for(u in c)if(c[u]&&c[u].show){d=!1;break}d&&(c.lines.show=!0)}null==c.lines.zero&&(c.lines.zero=!!c.lines.fill),c.xaxis=getOrCreateAxis(p,axisNumber(c,"x")),c.yaxis=getOrCreateAxis(g,axisNumber(c,"y"))}}(),function processData(){var t,e,i,o,n,a,r,l,s,c,h,u,d=Number.POSITIVE_INFINITY,f=Number.NEGATIVE_INFINITY,p=Number.MAX_VALUE;function updateAxis(t,e,i){e<t.datamin&&e!=-p&&(t.datamin=e),i>t.datamax&&i!=p&&(t.datamax=i)}for(z.each(allAxes(),function(t,e){e.datamin=d,e.datamax=f,e.used=!1}),t=0;t<T.length;++t)(n=T[t]).datapoints={points:[]},executeHooks(A.processRawData,[n,n.data,n.datapoints]);for(t=0;t<T.length;++t){if(n=T[t],h=n.data,!(u=n.datapoints.format)){if((u=[]).push({x:!0,number:!0,required:!0}),u.push({y:!0,number:!0,required:!0}),n.bars.show||n.lines.show&&n.lines.fill){var g=!!(n.bars.show&&n.bars.zero||n.lines.show&&n.lines.zero);u.push({y:!0,number:!0,required:!1,defaultValue:0,autoscale:g}),n.bars.horizontal&&(delete u[u.length-1].y,u[u.length-1].x=!0)}n.datapoints.format=u}if(null==n.datapoints.pointsize){n.datapoints.pointsize=u.length,r=n.datapoints.pointsize,a=n.datapoints.points;var x=n.lines.show&&n.lines.steps;for(n.xaxis.used=n.yaxis.used=!0,e=i=0;e<h.length;++e,i+=r){var m=null==(c=h[e]);if(!m)for(o=0;o<r;++o)l=c[o],(s=u[o])&&(s.number&&null!=l&&(l=+l,isNaN(l)?l=null:l==1/0?l=p:l==-1/0&&(l=-p)),null==l&&(s.required&&(m=!0),null!=s.defaultValue&&(l=s.defaultValue))),a[i+o]=l;if(m)for(o=0;o<r;++o)null!=(l=a[i+o])&&!1!==(s=u[o]).autoscale&&(s.x&&updateAxis(n.xaxis,l,l),s.y&&updateAxis(n.yaxis,l,l)),a[i+o]=null;else if(x&&0<i&&null!=a[i-r]&&a[i-r]!=a[i]&&a[i-r+1]!=a[i+1]){for(o=0;o<r;++o)a[i+r+o]=a[i+o];a[i+1]=a[i-r+1],i+=r}}}}for(t=0;t<T.length;++t)n=T[t],executeHooks(A.processDatapoints,[n,n.datapoints]);for(t=0;t<T.length;++t){n=T[t],a=n.datapoints.points,r=n.datapoints.pointsize,u=n.datapoints.format;var v=d,b=d,k=f,y=f;for(e=0;e<a.length;e+=r)if(null!=a[e])for(o=0;o<r;++o)l=a[e+o],(s=u[o])&&!1!==s.autoscale&&l!=p&&l!=-p&&(s.x&&(l<v&&(v=l),k<l&&(k=l)),s.y&&(l<b&&(b=l),y<l&&(y=l)));if(n.bars.show){var w;switch(n.bars.align){case"left":w=0;break;case"right":w=-n.bars.barWidth;break;default:w=-n.bars.barWidth/2}n.bars.horizontal?(b+=w,y+=w+n.bars.barWidth):(v+=w,k+=w+n.bars.barWidth)}updateAxis(n.xaxis,v,k),updateAxis(n.yaxis,b,y)}z.each(allAxes(),function(t,e){e.datamin==d&&(e.datamin=null),e.datamax==f&&(e.datamax=null)})}()}function axisNumber(t,e){var i=t[e+"axis"];return"object"==typeof i&&(i=i.n),"number"!=typeof i&&(i=1),i}function allAxes(){return z.grep(p.concat(g),function(t){return t})}function canvasToAxisCoords(t){var e,i,o={};for(e=0;e<p.length;++e)(i=p[e])&&i.used&&(o["x"+i.n]=i.c2p(t.left));for(e=0;e<g.length;++e)(i=g[e])&&i.used&&(o["y"+i.n]=i.c2p(t.top));return void 0!==o.x1&&(o.x=o.x1),void 0!==o.y1&&(o.y=o.y1),o}function getOrCreateAxis(t,e){return t[e-1]||(t[e-1]={n:e,direction:t==p?"x":"y",options:z.extend(!0,{},t==p?S.xaxis:S.yaxis)}),t[e-1]}function shutdown(){n&&clearTimeout(n),h.unbind("mousemove",onMouseMove),h.unbind("mouseleave",onMouseLeave),h.unbind("click",onClick),executeHooks(A.shutdown,[h])}function allocateAxisBoxFirstPhase(i){var t=i.labelWidth,e=i.labelHeight,o=i.options.position,n="x"===i.direction,a=i.options.tickLength,r=S.grid.axisMargin,l=S.grid.labelMargin,s=!0,c=!0,h=!0,u=!1;z.each(n?p:g,function(t,e){e&&(e.show||e.reserveSpace)&&(e===i?u=!0:e.options.position===o&&(u?c=!1:s=!1),u||(h=!1))}),c&&(r=0),null==a&&(a=h?"full":5),isNaN(+a)||(l+=+a),n?(e+=l,"bottom"==o?(w.bottom+=e+r,i.box={top:f.height-w.bottom,height:e}):(i.box={top:w.top+r,height:e},w.top+=e+r)):(t+=l,"left"==o?(i.box={left:w.left+r,width:t},w.left+=t+r):(w.right+=t+r,i.box={left:f.width-w.right,width:t})),i.position=o,i.tickLength=a,i.box.padding=l,i.innermost=s}function setupGrid(){var t,e=allAxes(),i=S.grid.show;for(var o in w){var n=S.grid.margin||0;w[o]="number"==typeof n?n:n[o]||0}for(var o in executeHooks(A.processOffset,[w]),w)"object"==typeof S.grid.borderWidth?w[o]+=i?S.grid.borderWidth[o]:0:w[o]+=i?S.grid.borderWidth:0;if(z.each(e,function(t,e){var i=e.options;e.show=null==i.show?e.used:i.show,e.reserveSpace=null==i.reserveSpace?e.show:i.reserveSpace,function setRange(t){var e=t.options,i=+(null!=e.min?e.min:t.datamin),o=+(null!=e.max?e.max:t.datamax),n=o-i;if(0==n){var a=0==o?1:.01;null==e.min&&(i-=a),null!=e.max&&null==e.min||(o+=a)}else{var r=e.autoscaleMargin;null!=r&&(null==e.min&&(i-=n*r)<0&&null!=t.datamin&&0<=t.datamin&&(i=0),null==e.max&&0<(o+=n*r)&&null!=t.datamax&&t.datamax<=0&&(o=0))}t.min=i,t.max=o}(e)}),i){var a=z.grep(e,function(t){return t.show||t.reserveSpace});for(z.each(a,function(t,e){!function setupTickGeneration(t){var e,i=t.options;e="number"==typeof i.ticks&&0<i.ticks?i.ticks:.3*Math.sqrt("x"==t.direction?f.width:f.height);var o=(t.max-t.min)/e,n=-Math.floor(Math.log(o)/Math.LN10),a=i.tickDecimals;null!=a&&a<n&&(n=a);var r,l=Math.pow(10,-n),s=o/l;s<1.5?r=1:s<3?(r=2,2.25<s&&(null==a||n+1<=a)&&(r=2.5,++n)):r=s<7.5?5:10;r*=l,null!=i.minTickSize&&r<i.minTickSize&&(r=i.minTickSize);if(t.delta=o,t.tickDecimals=Math.max(0,null!=a?a:n),t.tickSize=i.tickSize||r,"time"==i.mode&&!t.tickGenerator)throw new Error("Time mode requires the flot.time plugin.");t.tickGenerator||(t.tickGenerator=function(t){for(var e,i=[],o=function floorInBase(t,e){return e*Math.floor(t/e)}(t.min,t.tickSize),n=0,a=Number.NaN;e=a,a=o+n*t.tickSize,i.push(a),++n,a<t.max&&a!=e;);return i},t.tickFormatter=function(t,e){var i=e.tickDecimals?Math.pow(10,e.tickDecimals):1,o=""+Math.round(t*i)/i;if(null!=e.tickDecimals){var n=o.indexOf("."),a=-1==n?0:o.length-n-1;if(a<e.tickDecimals)return(a?o:o+".")+(""+i).substr(1,e.tickDecimals-a)}return o});z.isFunction(i.tickFormatter)&&(t.tickFormatter=function(t,e){return""+i.tickFormatter(t,e)});if(null!=i.alignTicksWithAxis){var c=("x"==t.direction?p:g)[i.alignTicksWithAxis-1];if(c&&c.used&&c!=t){var h=t.tickGenerator(t);if(0<h.length&&(null==i.min&&(t.min=Math.min(t.min,h[0])),null==i.max&&1<h.length&&(t.max=Math.max(t.max,h[h.length-1]))),t.tickGenerator=function(t){var e,i,o=[];for(i=0;i<c.ticks.length;++i)e=(c.ticks[i].v-c.min)/(c.max-c.min),e=t.min+e*(t.max-t.min),o.push(e);return o},!t.mode&&null==i.tickDecimals){var u=Math.max(0,1-Math.floor(Math.log(t.delta)/Math.LN10)),d=t.tickGenerator(t);1<d.length&&/\..*0$/.test((d[1]-d[0]).toFixed(u))||(t.tickDecimals=u)}}}}(e),function setTicks(t){var e,i,o=t.options.ticks,n=[];null==o||"number"==typeof o&&0<o?n=t.tickGenerator(t):o&&(n=z.isFunction(o)?o(t):o);for(t.ticks=[],e=0;e<n.length;++e){var a=null,r=n[e];"object"==typeof r?(i=+r[0],1<r.length&&(a=r[1])):i=+r,null==a&&(a=t.tickFormatter(i,t)),isNaN(i)||t.ticks.push({v:i,label:a})}}(e),function snapRangeToTicks(t,e){t.options.autoscaleMargin&&0<e.length&&(null==t.options.min&&(t.min=Math.min(t.min,e[0].v)),null==t.options.max&&1<e.length&&(t.max=Math.max(t.max,e[e.length-1].v)))}(e,e.ticks),function measureTickLabels(t){for(var e=t.options,i=t.ticks||[],o=e.labelWidth||0,n=e.labelHeight||0,a=o||("x"==t.direction?Math.floor(f.width/(i.length||1)):null),r=t.direction+"Axis "+t.direction+t.n+"Axis",l="flot-"+t.direction+"-axis flot-"+t.direction+t.n+"-axis "+r,s=e.font||"flot-tick-label tickLabel",c=0;c<i.length;++c){var h=i[c];if(h.label){var u=f.getTextInfo(l,h.label,s,null,a);o=Math.max(o,u.width),n=Math.max(n,u.height)}}t.labelWidth=e.labelWidth||o,t.labelHeight=e.labelHeight||n}(e)}),t=a.length-1;0<=t;--t)allocateAxisBoxFirstPhase(a[t]);!function adjustLayoutForThingsStickingOut(){var t,e=S.grid.minBorderMargin;if(null==e)for(t=e=0;t<T.length;++t)e=Math.max(e,2*(T[t].points.radius+T[t].points.lineWidth/2));var i={left:e,right:e,top:e,bottom:e};z.each(allAxes(),function(t,e){e.reserveSpace&&e.ticks&&e.ticks.length&&("x"===e.direction?(i.left=Math.max(i.left,e.labelWidth/2),i.right=Math.max(i.right,e.labelWidth/2)):(i.bottom=Math.max(i.bottom,e.labelHeight/2),i.top=Math.max(i.top,e.labelHeight/2)))}),w.left=Math.ceil(Math.max(i.left,w.left)),w.right=Math.ceil(Math.max(i.right,w.right)),w.top=Math.ceil(Math.max(i.top,w.top)),w.bottom=Math.ceil(Math.max(i.bottom,w.bottom))}(),z.each(a,function(t,e){!function allocateAxisBoxSecondPhase(t){"x"==t.direction?(t.box.left=w.left-t.labelWidth/2,t.box.width=f.width-w.left-w.right+t.labelWidth):(t.box.top=w.top-t.labelHeight/2,t.box.height=f.height-w.bottom-w.top+t.labelHeight)}(e)})}C=f.width-w.left-w.right,M=f.height-w.bottom-w.top,z.each(e,function(t,e){!function setTransformationHelpers(t){function identity(t){return t}var e,i,o=t.options.transform||identity,n=t.options.inverseTransform;i="x"==t.direction?(e=t.scale=C/Math.abs(o(t.max)-o(t.min)),Math.min(o(t.max),o(t.min))):(e=-(e=t.scale=M/Math.abs(o(t.max)-o(t.min))),Math.max(o(t.max),o(t.min))),t.p2c=o==identity?function(t){return(t-i)*e}:function(t){return(o(t)-i)*e},t.c2p=n?function(t){return n(i+t/e)}:function(t){return i+t/e}}(e)}),i&&function drawAxisLabels(){z.each(allAxes(),function(t,e){var i,o,n,a,r,l=e.box,s=e.direction+"Axis "+e.direction+e.n+"Axis",c="flot-"+e.direction+"-axis flot-"+e.direction+e.n+"-axis "+s,h=e.options.font||"flot-tick-label tickLabel";if(f.removeText(c),e.show&&0!=e.ticks.length)for(var u=0;u<e.ticks.length;++u)!(i=e.ticks[u]).label||i.v<e.min||i.v>e.max||("x"==e.direction?(a="center",o=w.left+e.p2c(i.v),"bottom"==e.position?n=l.top+l.padding:(n=l.top+l.height-l.padding,r="bottom")):(r="middle",n=w.top+e.p2c(i.v),"left"==e.position?(o=l.left+l.width-l.padding,a="right"):o=l.left+l.padding),f.addText(c,o,n,i.label,h,null,null,a,r))})}(),function insertLegend(){null!=S.legend.container?z(S.legend.container).html(""):x.find(".legend").remove();if(!S.legend.show)return;for(var t,e,i=[],o=[],n=!1,a=S.legend.labelFormatter,r=0;r<T.length;++r)(t=T[r]).label&&(e=a?a(t.label,t):t.label)&&o.push({label:e,color:t.color});if(S.legend.sorted)if(z.isFunction(S.legend.sorted))o.sort(S.legend.sorted);else if("reverse"==S.legend.sorted)o.reverse();else{var l="descending"!=S.legend.sorted;o.sort(function(t,e){return t.label==e.label?0:t.label<e.label!=l?1:-1})}for(var r=0;r<o.length;++r){var s=o[r];r%S.legend.noColumns==0&&(n&&i.push("</tr>"),i.push("<tr>"),n=!0),i.push('<td class="legendColorBox"><div style="border:1px solid '+S.legend.labelBoxBorderColor+';padding:1px"><div style="width:4px;height:0;border:5px solid '+s.color+';overflow:hidden"></div></div></td><td class="legendLabel">'+s.label+"</td>")}n&&i.push("</tr>");if(0==i.length)return;var c='<table style="font-size:smaller;color:'+S.grid.color+'">'+i.join("")+"</table>";if(null!=S.legend.container)z(S.legend.container).html(c);else{var h="",u=S.legend.position,d=S.legend.margin;null==d[0]&&(d=[d,d]),"n"==u.charAt(0)?h+="top:"+(d[1]+w.top)+"px;":"s"==u.charAt(0)&&(h+="bottom:"+(d[1]+w.bottom)+"px;"),"e"==u.charAt(1)?h+="right:"+(d[0]+w.right)+"px;":"w"==u.charAt(1)&&(h+="left:"+(d[0]+w.left)+"px;");var f=z('<div class="legend">'+c.replace('style="','style="position:absolute;'+h+";")+"</div>").appendTo(x);if(0!=S.legend.backgroundOpacity){var p=S.legend.backgroundColor;null==p&&((p=(p=S.grid.backgroundColor)&&"string"==typeof p?z.color.parse(p):z.color.extract(f,"background-color")).a=1,p=p.toString());var g=f.children();z('<div style="position:absolute;width:'+g.width()+"px;height:"+g.height()+"px;"+h+"background-color:"+p+';"> </div>').prependTo(f).css("opacity",S.legend.backgroundOpacity)}}}()}function draw(){f.clear(),executeHooks(A.drawBackground,[y]);var t=S.grid;t.show&&t.backgroundColor&&function drawBackground(){y.save(),y.translate(w.left,w.top),y.fillStyle=getColorOrGradient(S.grid.backgroundColor,M,0,"rgba(255, 255, 255, 0)"),y.fillRect(0,0,C,M),y.restore()}(),t.show&&!t.aboveData&&drawGrid();for(var e=0;e<T.length;++e)executeHooks(A.drawSeries,[y,T[e]]),drawSeries(T[e]);executeHooks(A.draw,[y]),t.show&&t.aboveData&&drawGrid(),f.render(),triggerRedrawOverlay()}function extractRange(t,e){for(var i,o,n,a,r=allAxes(),l=0;l<r.length;++l)if((i=r[l]).direction==e&&(t[a=e+i.n+"axis"]||1!=i.n||(a=e+"axis"),t[a])){o=t[a].from,n=t[a].to;break}if(t[a]||(i="x"==e?p[0]:g[0],o=t[e+"1"],n=t[e+"2"]),null!=o&&null!=n&&n<o){var s=o;o=n,n=s}return{from:o,to:n,axis:i}}function drawGrid(){var t,e,i,o;y.save(),y.translate(w.left,w.top);var n=S.grid.markings;if(n)for(z.isFunction(n)&&((e=W.getAxes()).xmin=e.xaxis.min,e.xmax=e.xaxis.max,e.ymin=e.yaxis.min,e.ymax=e.yaxis.max,n=n(e)),t=0;t<n.length;++t){var a=n[t],r=extractRange(a,"x"),l=extractRange(a,"y");if(null==r.from&&(r.from=r.axis.min),null==r.to&&(r.to=r.axis.max),null==l.from&&(l.from=l.axis.min),null==l.to&&(l.to=l.axis.max),!(r.to<r.axis.min||r.from>r.axis.max||l.to<l.axis.min||l.from>l.axis.max)){r.from=Math.max(r.from,r.axis.min),r.to=Math.min(r.to,r.axis.max),l.from=Math.max(l.from,l.axis.min),l.to=Math.min(l.to,l.axis.max);var s=r.from===r.to,c=l.from===l.to;if(!s||!c)if(r.from=Math.floor(r.axis.p2c(r.from)),r.to=Math.floor(r.axis.p2c(r.to)),l.from=Math.floor(l.axis.p2c(l.from)),l.to=Math.floor(l.axis.p2c(l.to)),s||c){var h=a.lineWidth||S.grid.markingsLineWidth,u=h%2?.5:0;y.beginPath(),y.strokeStyle=a.color||S.grid.markingsColor,y.lineWidth=h,s?(y.moveTo(r.to+u,l.from),y.lineTo(r.to+u,l.to)):(y.moveTo(r.from,l.to+u),y.lineTo(r.to,l.to+u)),y.stroke()}else y.fillStyle=a.color||S.grid.markingsColor,y.fillRect(r.from,l.to,r.to-r.from,l.from-l.to)}}e=allAxes(),i=S.grid.borderWidth;for(var d=0;d<e.length;++d){var f,p,g,x,m=e[d],v=m.box,b=m.tickLength;if(m.show&&0!=m.ticks.length){for(y.lineWidth=1,"x"==m.direction?(f=0,p="full"==b?"top"==m.position?0:M:v.top-w.top+("top"==m.position?v.height:0)):(p=0,f="full"==b?"left"==m.position?0:C:v.left-w.left+("left"==m.position?v.width:0)),m.innermost||(y.strokeStyle=m.options.color,y.beginPath(),g=x=0,"x"==m.direction?g=C+1:x=M+1,1==y.lineWidth&&("x"==m.direction?p=Math.floor(p)+.5:f=Math.floor(f)+.5),y.moveTo(f,p),y.lineTo(f+g,p+x),y.stroke()),y.strokeStyle=m.options.tickColor,y.beginPath(),t=0;t<m.ticks.length;++t){var k=m.ticks[t].v;g=x=0,isNaN(k)||k<m.min||k>m.max||"full"==b&&("object"==typeof i&&0<i[m.position]||0<i)&&(k==m.min||k==m.max)||("x"==m.direction?(f=m.p2c(k),x="full"==b?-M:b,"top"==m.position&&(x=-x)):(p=m.p2c(k),g="full"==b?-C:b,"left"==m.position&&(g=-g)),1==y.lineWidth&&("x"==m.direction?f=Math.floor(f)+.5:p=Math.floor(p)+.5),y.moveTo(f,p),y.lineTo(f+g,p+x))}y.stroke()}}i&&(o=S.grid.borderColor,"object"==typeof i||"object"==typeof o?("object"!=typeof i&&(i={top:i,right:i,bottom:i,left:i}),"object"!=typeof o&&(o={top:o,right:o,bottom:o,left:o}),0<i.top&&(y.strokeStyle=o.top,y.lineWidth=i.top,y.beginPath(),y.moveTo(0-i.left,0-i.top/2),y.lineTo(C,0-i.top/2),y.stroke()),0<i.right&&(y.strokeStyle=o.right,y.lineWidth=i.right,y.beginPath(),y.moveTo(C+i.right/2,0-i.top),y.lineTo(C+i.right/2,M),y.stroke()),0<i.bottom&&(y.strokeStyle=o.bottom,y.lineWidth=i.bottom,y.beginPath(),y.moveTo(C+i.right,M+i.bottom/2),y.lineTo(0,M+i.bottom/2),y.stroke()),0<i.left&&(y.strokeStyle=o.left,y.lineWidth=i.left,y.beginPath(),y.moveTo(0-i.left/2,M+i.bottom),y.lineTo(0-i.left/2,0),y.stroke())):(y.lineWidth=i,y.strokeStyle=S.grid.borderColor,y.strokeRect(-i/2,-i/2,C+i,M+i))),y.restore()}function drawSeries(t){t.lines.show&&function drawSeriesLines(t){function plotLine(t,e,i,o,n){var a=t.points,r=t.pointsize,l=null,s=null;y.beginPath();for(var c=r;c<a.length;c+=r){var h=a[c-r],u=a[c-r+1],d=a[c],f=a[c+1];if(null!=h&&null!=d){if(u<=f&&u<n.min){if(f<n.min)continue;h=(n.min-u)/(f-u)*(d-h)+h,u=n.min}else if(f<=u&&f<n.min){if(u<n.min)continue;d=(n.min-u)/(f-u)*(d-h)+h,f=n.min}if(f<=u&&u>n.max){if(f>n.max)continue;h=(n.max-u)/(f-u)*(d-h)+h,u=n.max}else if(u<=f&&f>n.max){if(u>n.max)continue;d=(n.max-u)/(f-u)*(d-h)+h,f=n.max}if(h<=d&&h<o.min){if(d<o.min)continue;u=(o.min-h)/(d-h)*(f-u)+u,h=o.min}else if(d<=h&&d<o.min){if(h<o.min)continue;f=(o.min-h)/(d-h)*(f-u)+u,d=o.min}if(d<=h&&h>o.max){if(d>o.max)continue;u=(o.max-h)/(d-h)*(f-u)+u,h=o.max}else if(h<=d&&d>o.max){if(h>o.max)continue;f=(o.max-h)/(d-h)*(f-u)+u,d=o.max}h==l&&u==s||y.moveTo(o.p2c(h)+e,n.p2c(u)+i),l=d,s=f,y.lineTo(o.p2c(d)+e,n.p2c(f)+i)}}y.stroke()}y.save(),y.translate(w.left,w.top),y.lineJoin="round";var e=t.lines.lineWidth,i=t.shadowSize;if(0<e&&0<i){y.lineWidth=i,y.strokeStyle="rgba(0,0,0,0.1)";var o=Math.PI/18;plotLine(t.datapoints,Math.sin(o)*(e/2+i/2),Math.cos(o)*(e/2+i/2),t.xaxis,t.yaxis),y.lineWidth=i/2,plotLine(t.datapoints,Math.sin(o)*(e/2+i/4),Math.cos(o)*(e/2+i/4),t.xaxis,t.yaxis)}y.lineWidth=e,y.strokeStyle=t.color;var n=getFillStyle(t.lines,t.color,0,M);n&&(y.fillStyle=n,function plotLineArea(t,e,i){var o=t.points,n=t.pointsize,a=Math.min(Math.max(0,i.min),i.max),r=0,l=!1,s=1,c=0,h=0;for(;!(0<n&&r>o.length+n);){var u=o[(r+=n)-n],d=o[r-n+s],f=o[r],p=o[r+s];if(l){if(0<n&&null!=u&&null==f){h=r,n=-n,s=2;continue}if(n<0&&r==c+n){y.fill(),l=!1,s=1,r=c=h+(n=-n);continue}}if(null!=u&&null!=f){if(u<=f&&u<e.min){if(f<e.min)continue;d=(e.min-u)/(f-u)*(p-d)+d,u=e.min}else if(f<=u&&f<e.min){if(u<e.min)continue;p=(e.min-u)/(f-u)*(p-d)+d,f=e.min}if(f<=u&&u>e.max){if(f>e.max)continue;d=(e.max-u)/(f-u)*(p-d)+d,u=e.max}else if(u<=f&&f>e.max){if(u>e.max)continue;p=(e.max-u)/(f-u)*(p-d)+d,f=e.max}if(l||(y.beginPath(),y.moveTo(e.p2c(u),i.p2c(a)),l=!0),d>=i.max&&p>=i.max)y.lineTo(e.p2c(u),i.p2c(i.max)),y.lineTo(e.p2c(f),i.p2c(i.max));else if(d<=i.min&&p<=i.min)y.lineTo(e.p2c(u),i.p2c(i.min)),y.lineTo(e.p2c(f),i.p2c(i.min));else{var g=u,x=f;d<=p&&d<i.min&&p>=i.min?(u=(i.min-d)/(p-d)*(f-u)+u,d=i.min):p<=d&&p<i.min&&d>=i.min&&(f=(i.min-d)/(p-d)*(f-u)+u,p=i.min),p<=d&&d>i.max&&p<=i.max?(u=(i.max-d)/(p-d)*(f-u)+u,d=i.max):d<=p&&p>i.max&&d<=i.max&&(f=(i.max-d)/(p-d)*(f-u)+u,p=i.max),u!=g&&y.lineTo(e.p2c(g),i.p2c(d)),y.lineTo(e.p2c(u),i.p2c(d)),y.lineTo(e.p2c(f),i.p2c(p)),f!=x&&(y.lineTo(e.p2c(f),i.p2c(p)),y.lineTo(e.p2c(x),i.p2c(p)))}}}}(t.datapoints,t.xaxis,t.yaxis));0<e&&plotLine(t.datapoints,0,0,t.xaxis,t.yaxis);y.restore()}(t),t.bars.show&&function drawSeriesBars(c){var t;switch(y.save(),y.translate(w.left,w.top),y.lineWidth=c.bars.lineWidth,y.strokeStyle=c.color,c.bars.align){case"left":t=0;break;case"right":t=-c.bars.barWidth;break;default:t=-c.bars.barWidth/2}var e=c.bars.fill?function(t,e){return getFillStyle(c.bars,c.color,t,e)}:null;(function plotBars(t,e,i,o,n,a){for(var r=t.points,l=t.pointsize,s=0;s<r.length;s+=l)null!=r[s]&&drawBar(r[s],r[s+1],r[s+2],e,i,o,n,a,y,c.bars.horizontal,c.bars.lineWidth)})(c.datapoints,t,t+c.bars.barWidth,e,c.xaxis,c.yaxis),y.restore()}(t),t.points.show&&function drawSeriesPoints(t){function plotPoints(t,e,i,o,n,a,r,l){for(var s=t.points,c=t.pointsize,h=0;h<s.length;h+=c){var u=s[h],d=s[h+1];null==u||u<a.min||u>a.max||d<r.min||d>r.max||(y.beginPath(),u=a.p2c(u),d=r.p2c(d)+o,"circle"==l?y.arc(u,d,e,0,n?Math.PI:2*Math.PI,!1):l(y,u,d,e,n),y.closePath(),i&&(y.fillStyle=i,y.fill()),y.stroke())}}y.save(),y.translate(w.left,w.top);var e=t.points.lineWidth,i=t.shadowSize,o=t.points.radius,n=t.points.symbol;0==e&&(e=1e-4);if(0<e&&0<i){var a=i/2;y.lineWidth=a,y.strokeStyle="rgba(0,0,0,0.1)",plotPoints(t.datapoints,o,null,a+a/2,!0,t.xaxis,t.yaxis,n),y.strokeStyle="rgba(0,0,0,0.2)",plotPoints(t.datapoints,o,null,a/2,!0,t.xaxis,t.yaxis,n)}y.lineWidth=e,y.strokeStyle=t.color,plotPoints(t.datapoints,o,getFillStyle(t.points,t.color),0,!1,t.xaxis,t.yaxis,n),y.restore()}(t)}function drawBar(t,e,i,o,n,a,r,l,s,c,h){var u,d,f,p,g,x,m,v,b;c?(v=x=m=!0,g=!1,p=e+o,f=e+n,(d=t)<(u=i)&&(b=d,d=u,u=b,x=!(g=!0))):(g=x=m=!0,v=!1,u=t+o,d=t+n,(p=e)<(f=i)&&(b=p,p=f,f=b,m=!(v=!0))),d<r.min||u>r.max||p<l.min||f>l.max||(u<r.min&&(u=r.min,g=!1),d>r.max&&(d=r.max,x=!1),f<l.min&&(f=l.min,v=!1),p>l.max&&(p=l.max,m=!1),u=r.p2c(u),f=l.p2c(f),d=r.p2c(d),p=l.p2c(p),a&&(s.fillStyle=a(f,p),s.fillRect(u,p,d-u,f-p)),0<h&&(g||x||m||v)&&(s.beginPath(),s.moveTo(u,f),g?s.lineTo(u,p):s.moveTo(u,p),m?s.lineTo(d,p):s.moveTo(d,p),x?s.lineTo(d,f):s.moveTo(d,f),v?s.lineTo(u,f):s.moveTo(u,f),s.stroke()))}function getFillStyle(t,e,i,o){var n=t.fill;if(!n)return null;if(t.fillColor)return getColorOrGradient(t.fillColor,i,o,e);var a=z.color.parse(e);return a.a="number"==typeof n?n:.4,a.normalize(),a.toString()}W.setData=setData,W.setupGrid=setupGrid,W.draw=draw,W.getPlaceholder=function(){return x},W.getCanvas=function(){return f.element},W.getPlotOffset=function(){return w},W.width=function(){return C},W.height=function(){return M},W.offset=function(){var t=h.offset();return t.left+=w.left,t.top+=w.top,t},W.getData=function(){return T},W.getAxes=function(){var i={};return z.each(p.concat(g),function(t,e){e&&(i[e.direction+(1!=e.n?e.n:"")+"axis"]=e)}),i},W.getXAxes=function(){return p},W.getYAxes=function(){return g},W.c2p=canvasToAxisCoords,W.p2c=function axisToCanvasCoords(t){var e,i,o,n={};for(e=0;e<p.length;++e)if((i=p[e])&&i.used&&(o="x"+i.n,null==t[o]&&1==i.n&&(o="x"),null!=t[o])){n.left=i.p2c(t[o]);break}for(e=0;e<g.length;++e)if((i=g[e])&&i.used&&(o="y"+i.n,null==t[o]&&1==i.n&&(o="y"),null!=t[o])){n.top=i.p2c(t[o]);break}return n},W.getOptions=function(){return S},W.highlight=highlight,W.unhighlight=unhighlight,W.triggerRedrawOverlay=triggerRedrawOverlay,W.pointOffset=function(t){return{left:parseInt(p[axisNumber(t,"x")-1].p2c(+t.x)+w.left,10),top:parseInt(g[axisNumber(t,"y")-1].p2c(+t.y)+w.top,10)}},W.shutdown=shutdown,W.destroy=function(){shutdown(),x.removeData("plot").empty(),T=[],p=[],g=[],u=[],W=A=c=y=h=i=f=S=null},W.resize=function(){var t=x.width(),e=x.height();f.resize(t,e),i.resize(t,e)},W.hooks=A,function initPlugins(){for(var t={Canvas:Canvas},e=0;e<o.length;++e){var i=o[e];i.init(W,t),i.options&&z.extend(!0,S,i.options)}}(),function parseOptions(t){z.extend(!0,S,t),t&&t.colors&&(S.colors=t.colors);null==S.xaxis.color&&(S.xaxis.color=z.color.parse(S.grid.color).scale("a",.22).toString());null==S.yaxis.color&&(S.yaxis.color=z.color.parse(S.grid.color).scale("a",.22).toString());null==S.xaxis.tickColor&&(S.xaxis.tickColor=S.grid.tickColor||S.xaxis.color);null==S.yaxis.tickColor&&(S.yaxis.tickColor=S.grid.tickColor||S.yaxis.color);null==S.grid.borderColor&&(S.grid.borderColor=S.grid.color);null==S.grid.tickColor&&(S.grid.tickColor=z.color.parse(S.grid.color).scale("a",.22).toString());var e,i,o,n=x.css("font-size"),a=n?+n.replace("px",""):13,r={style:x.css("font-style"),size:Math.round(.8*a),variant:x.css("font-variant"),weight:x.css("font-weight"),family:x.css("font-family")};for(o=S.xaxes.length||1,e=0;e<o;++e)(i=S.xaxes[e])&&!i.tickColor&&(i.tickColor=i.color),i=z.extend(!0,{},S.xaxis,i),(S.xaxes[e]=i).font&&(i.font=z.extend({},r,i.font),i.font.color||(i.font.color=i.color),i.font.lineHeight||(i.font.lineHeight=Math.round(1.15*i.font.size)));for(o=S.yaxes.length||1,e=0;e<o;++e)(i=S.yaxes[e])&&!i.tickColor&&(i.tickColor=i.color),i=z.extend(!0,{},S.yaxis,i),(S.yaxes[e]=i).font&&(i.font=z.extend({},r,i.font),i.font.color||(i.font.color=i.color),i.font.lineHeight||(i.font.lineHeight=Math.round(1.15*i.font.size)));S.xaxis.noTicks&&null==S.xaxis.ticks&&(S.xaxis.ticks=S.xaxis.noTicks);S.yaxis.noTicks&&null==S.yaxis.ticks&&(S.yaxis.ticks=S.yaxis.noTicks);S.x2axis&&(S.xaxes[1]=z.extend(!0,{},S.xaxis,S.x2axis),S.xaxes[1].position="top",null==S.x2axis.min&&(S.xaxes[1].min=null),null==S.x2axis.max&&(S.xaxes[1].max=null));S.y2axis&&(S.yaxes[1]=z.extend(!0,{},S.yaxis,S.y2axis),S.yaxes[1].position="right",null==S.y2axis.min&&(S.yaxes[1].min=null),null==S.y2axis.max&&(S.yaxes[1].max=null));S.grid.coloredAreas&&(S.grid.markings=S.grid.coloredAreas);S.grid.coloredAreasColor&&(S.grid.markingsColor=S.grid.coloredAreasColor);S.lines&&z.extend(!0,S.series.lines,S.lines);S.points&&z.extend(!0,S.series.points,S.points);S.bars&&z.extend(!0,S.series.bars,S.bars);null!=S.shadowSize&&(S.series.shadowSize=S.shadowSize);null!=S.highlightColor&&(S.series.highlightColor=S.highlightColor);for(e=0;e<S.xaxes.length;++e)getOrCreateAxis(p,e+1).options=S.xaxes[e];for(e=0;e<S.yaxes.length;++e)getOrCreateAxis(g,e+1).options=S.yaxes[e];for(var l in A)S.hooks[l]&&S.hooks[l].length&&(A[l]=A[l].concat(S.hooks[l]));executeHooks(A.processOptions,[S])}(e),function setupCanvases(){x.css("padding",0).children().filter(function(){return!z(this).hasClass("flot-overlay")&&!z(this).hasClass("flot-base")}).remove(),"static"==x.css("position")&&x.css("position","relative");f=new Canvas("flot-base",x),i=new Canvas("flot-overlay",x),y=f.context,c=i.context,h=z(i.element).unbind();var t=x.data("plot");t&&(t.shutdown(),i.clear());x.data("plot",W)}(),setData(t),setupGrid(),draw(),function bindEvents(){S.grid.hoverable&&(h.mousemove(onMouseMove),h.bind("mouseleave",onMouseLeave));S.grid.clickable&&h.click(onClick);executeHooks(A.bindEvents,[h])}();var u=[],n=null;function onMouseMove(t){S.grid.hoverable&&triggerClickHoverEvent("plothover",t,function(t){return 0!=t.hoverable})}function onMouseLeave(t){S.grid.hoverable&&triggerClickHoverEvent("plothover",t,function(t){return!1})}function onClick(t){triggerClickHoverEvent("plotclick",t,function(t){return 0!=t.clickable})}function triggerClickHoverEvent(t,e,i){var o=h.offset(),n=e.pageX-o.left-w.left,a=e.pageY-o.top-w.top,r=canvasToAxisCoords({left:n,top:a});r.pageX=e.pageX,r.pageY=e.pageY;var l=function findNearbyItem(t,e,i){var o,n,a,r=S.grid.mouseActiveRadius,l=r*r+1,s=null;for(o=T.length-1;0<=o;--o)if(i(T[o])){var c=T[o],h=c.xaxis,u=c.yaxis,d=c.datapoints.points,f=h.c2p(t),p=u.c2p(e),g=r/h.scale,x=r/u.scale;if(a=c.datapoints.pointsize,h.options.inverseTransform&&(g=Number.MAX_VALUE),u.options.inverseTransform&&(x=Number.MAX_VALUE),c.lines.show||c.points.show)for(n=0;n<d.length;n+=a){var m=d[n],v=d[n+1];if(null!=m&&!(g<m-f||m-f<-g||x<v-p||v-p<-x)){var b=Math.abs(h.p2c(m)-t),k=Math.abs(u.p2c(v)-e),y=b*b+k*k;y<l&&(l=y,s=[o,n/a])}}if(c.bars.show&&!s){var w,C;switch(c.bars.align){case"left":w=0;break;case"right":w=-c.bars.barWidth;break;default:w=-c.bars.barWidth/2}for(C=w+c.bars.barWidth,n=0;n<d.length;n+=a){m=d[n],v=d[n+1];var M=d[n+2];null!=m&&(T[o].bars.horizontal?f<=Math.max(M,m)&&f>=Math.min(M,m)&&v+w<=p&&p<=v+C:m+w<=f&&f<=m+C&&p>=Math.min(M,v)&&p<=Math.max(M,v))&&(s=[o,n/a])}}}return s?(o=s[0],n=s[1],a=T[o].datapoints.pointsize,{datapoint:T[o].datapoints.points.slice(n*a,(n+1)*a),dataIndex:n,series:T[o],seriesIndex:o}):null}(n,a,i);if(l&&(l.pageX=parseInt(l.series.xaxis.p2c(l.datapoint[0])+o.left+w.left,10),l.pageY=parseInt(l.series.yaxis.p2c(l.datapoint[1])+o.top+w.top,10)),S.grid.autoHighlight){for(var s=0;s<u.length;++s){var c=u[s];c.auto!=t||l&&c.series==l.series&&c.point[0]==l.datapoint[0]&&c.point[1]==l.datapoint[1]||unhighlight(c.series,c.point)}l&&highlight(l.series,l.datapoint,t)}x.trigger(t,[r,l])}function triggerRedrawOverlay(){var t=S.interaction.redrawOverlayInterval;-1!=t?n||(n=setTimeout(drawOverlay,t)):drawOverlay()}function drawOverlay(){if((n=null)!=c){var t,e;for(c.save(),i.clear(),c.translate(w.left,w.top),t=0;t<u.length;++t)(e=u[t]).series.bars.show?drawBarHighlight(e.series,e.point):drawPointHighlight(e.series,e.point);c.restore(),executeHooks(A.drawOverlay,[c])}}function highlight(t,e,i){if("number"==typeof t&&(t=T[t]),"number"==typeof e){var o=t.datapoints.pointsize;e=t.datapoints.points.slice(o*e,o*(e+1))}var n=indexOfHighlight(t,e);-1==n?(u.push({series:t,point:e,auto:i}),triggerRedrawOverlay()):i||(u[n].auto=!1)}function unhighlight(t,e){if(null==t&&null==e)return u=[],void triggerRedrawOverlay();if("number"==typeof t&&(t=T[t]),"number"==typeof e){var i=t.datapoints.pointsize;e=t.datapoints.points.slice(i*e,i*(e+1))}var o=indexOfHighlight(t,e);-1!=o&&(u.splice(o,1),triggerRedrawOverlay())}function indexOfHighlight(t,e){for(var i=0;i<u.length;++i){var o=u[i];if(o.series==t&&o.point[0]==e[0]&&o.point[1]==e[1])return i}return-1}function drawPointHighlight(t,e){var i=e[0],o=e[1],n=t.xaxis,a=t.yaxis,r="string"==typeof t.highlightColor?t.highlightColor:z.color.parse(t.color).scale("a",.5).toString();if(!(i<n.min||i>n.max||o<a.min||o>a.max)){var l=t.points.radius+t.points.lineWidth/2;c.lineWidth=l,c.strokeStyle=r;var s=1.5*l;i=n.p2c(i),o=a.p2c(o),c.beginPath(),"circle"==t.points.symbol?c.arc(i,o,s,0,2*Math.PI,!1):t.points.symbol(c,i,o,s,!1),c.closePath(),c.stroke()}}function drawBarHighlight(t,e){var i,o="string"==typeof t.highlightColor?t.highlightColor:z.color.parse(t.color).scale("a",.5).toString(),n=o;switch(t.bars.align){case"left":i=0;break;case"right":i=-t.bars.barWidth;break;default:i=-t.bars.barWidth/2}c.lineWidth=t.bars.lineWidth,c.strokeStyle=o,drawBar(e[0],e[1],e[2]||0,i,i+t.bars.barWidth,function(){return n},t.xaxis,t.yaxis,c,t.bars.horizontal,t.bars.lineWidth)}function getColorOrGradient(t,e,i,o){if("string"==typeof t)return t;for(var n=y.createLinearGradient(0,i,0,e),a=0,r=t.colors.length;a<r;++a){var l=t.colors[a];if("string"!=typeof l){var s=z.color.parse(o);null!=l.brightness&&(s=s.scale("rgb",l.brightness)),null!=l.opacity&&(s.a*=l.opacity),l=s.toString()}n.addColorStop(a/(r-1),l)}return n}}z.fn.detach||(z.fn.detach=function(){return this.each(function(){this.parentNode&&this.parentNode.removeChild(this)})}),Canvas.prototype.resize=function(t,e){if(t<=0||e<=0)throw new Error("Invalid dimensions for plot, width = "+t+", height = "+e);var i=this.element,o=this.context,n=this.pixelRatio;this.width!=t&&(i.width=t*n,i.style.width=t+"px",this.width=t),this.height!=e&&(i.height=e*n,i.style.height=e+"px",this.height=e),o.restore(),o.save(),o.scale(n,n)},Canvas.prototype.clear=function(){this.context.clearRect(0,0,this.width,this.height)},Canvas.prototype.render=function(){var t=this._textCache;for(var e in t)if(f.call(t,e)){var i=this.getTextLayer(e),o=t[e];for(var n in i.hide(),o)if(f.call(o,n)){var a=o[n];for(var r in a)if(f.call(a,r)){for(var l,s=a[r].positions,c=0;l=s[c];c++)l.active?l.rendered||(i.append(l.element),l.rendered=!0):(s.splice(c--,1),l.rendered&&l.element.detach());0==s.length&&delete a[r]}}i.show()}},Canvas.prototype.getTextLayer=function(t){var e=this.text[t];return null==e&&(null==this.textContainer&&(this.textContainer=z("<div class='flot-text'></div>").css({position:"absolute",top:0,left:0,bottom:0,right:0,"font-size":"smaller",color:"#545454"}).insertAfter(this.element)),e=this.text[t]=z("<div></div>").addClass(t).css({position:"absolute",top:0,left:0,bottom:0,right:0}).appendTo(this.textContainer)),e},Canvas.prototype.getTextInfo=function(t,e,i,o,n){var a,r,l,s;if(e=""+e,a="object"==typeof i?i.style+" "+i.variant+" "+i.weight+" "+i.size+"px/"+i.lineHeight+"px "+i.family:i,null==(r=this._textCache[t])&&(r=this._textCache[t]={}),null==(l=r[a])&&(l=r[a]={}),null==(s=l[e])){var c=z("<div></div>").html(e).css({position:"absolute","max-width":n,top:-9999}).appendTo(this.getTextLayer(t));"object"==typeof i?c.css({font:a,color:i.color}):"string"==typeof i&&c.addClass(i),s=l[e]={width:c.outerWidth(!0),height:c.outerHeight(!0),element:c,positions:[]},c.detach()}return s},Canvas.prototype.addText=function(t,e,i,o,n,a,r,l,s){var c=this.getTextInfo(t,o,n,a,r),h=c.positions;"center"==l?e-=c.width/2:"right"==l&&(e-=c.width),"middle"==s?i-=c.height/2:"bottom"==s&&(i-=c.height);for(var u,d=0;u=h[d];d++)if(u.x==e&&u.y==i)return void(u.active=!0);u={active:!0,rendered:!1,element:h.length?c.element.clone():c.element,x:e,y:i},h.push(u),u.element.css({top:Math.round(i),left:Math.round(e),"text-align":l})},Canvas.prototype.removeText=function(t,e,i,o,n,a){if(null==o){var r=this._textCache[t];if(null!=r)for(var l in r)if(f.call(r,l)){var s=r[l];for(var c in s)if(f.call(s,c))for(var h=s[c].positions,u=0;d=h[u];u++)d.active=!1}}else{var d;for(h=this.getTextInfo(t,o,n,a).positions,u=0;d=h[u];u++)d.x==e&&d.y==i&&(d.active=!1)}},z.plot=function(t,e,i){return new Plot(z(t),e,i,z.plot.plugins)},z.plot.version="0.8.3",z.plot.plugins=[],z.fn.plot=function(t,e){return this.each(function(){z.plot(this,t,e)})}}(jQuery);
jQuery.plot.plugins.push({init:function init(e){e.hooks.drawSeries.push(function(e,w,L){if(L.dashes.show){var a=e.getPlotOffset(),S=L.xaxis,X=L.yaxis;w.save(),w.translate(a.left,a.top),w.lineJoin="round";var t=L.dashes.lineWidth,i=L.shadowSize;if(0<t&&0<i){w.lineWidth=i,w.strokeStyle="rgba(0,0,0,0.1)";var n=Math.PI/18;plotDashes(Math.sin(n)*(t/2+i/2),Math.cos(n)*(t/2+i/2)),w.lineWidth=i/2,plotDashes(Math.sin(n)*(t/2+i/4),Math.cos(n)*(t/2+i/4))}w.lineWidth=t,w.strokeStyle=L.color,0<t&&plotDashes(0,0),w.restore()}function plotDashes(e,a){var t,i,n=L.datapoints.points,s=L.datapoints.pointsize,o=null,h=null,l=0,d=!0;i=L.dashes.dashLength[0]?(t=L.dashes.dashLength[0],L.dashes.dashLength[1]?L.dashes.dashLength[1]:t):t=L.dashes.dashLength,w.beginPath();for(var m=s;m<n.length;m+=s){var r=n[m-s],f=n[m-s+1],p=n[m],c=n[m+1];if(null!=r&&null!=p){if(f<=c&&f<X.min){if(c<X.min)continue;r=(X.min-f)/(c-f)*(p-r)+r,f=X.min}else if(c<=f&&c<X.min){if(f<X.min)continue;p=(X.min-f)/(c-f)*(p-r)+r,c=X.min}if(c<=f&&f>X.max){if(c>X.max)continue;r=(X.max-f)/(c-f)*(p-r)+r,f=X.max}else if(f<=c&&c>X.max){if(f>X.max)continue;p=(X.max-f)/(c-f)*(p-r)+r,c=X.max}if(r<=p&&r<S.min){if(p<S.min)continue;f=(S.min-r)/(p-r)*(c-f)+f,r=S.min}else if(p<=r&&p<S.min){if(r<S.min)continue;c=(S.min-r)/(p-r)*(c-f)+f,p=S.min}if(p<=r&&r>S.max){if(p>S.max)continue;f=(S.max-r)/(p-r)*(c-f)+f,r=S.max}else if(r<=p&&p>S.max){if(r>S.max)continue;c=(S.max-r)/(p-r)*(c-f)+f,p=S.max}r==o&&f==h||w.moveTo(S.p2c(r)+e,X.p2c(f)+a);for(var u,x=S.p2c(r)+e,M=X.p2c(f)+a,g=S.p2c(p)+e,v=X.p2c(c)+a;0==(u=lineSegmentOffset(0<l?l:d?t:i)).deltaX&&0==u.deltaY||(d?w.lineTo(x+u.deltaX,M+u.deltaY):w.moveTo(x+u.deltaX,M+u.deltaY)),d=!d,l=u.remainder,x+=u.deltaX,M+=u.deltaY,0<u.distance;);o=p,h=c}function lineSegmentOffset(e){var a=Math.sqrt(Math.pow(g-x,2)+Math.pow(v-M,2));if(a<=e)return{deltaX:g-x,deltaY:v-M,distance:a,remainder:e-a};var t=M<v?1:-1;return{deltaX:(x<g?1:-1)*Math.sqrt(Math.pow(e,2)/(1+Math.pow((v-M)/(g-x),2))),deltaY:t*Math.sqrt(Math.pow(e,2)-Math.pow(e,2)/(1+Math.pow((v-M)/(g-x),2))),distance:e,remainder:0}}}w.stroke()}})},options:{series:{dashes:{show:!1,lineWidth:2,dashLength:10}}},name:"dashes",version:"0.1"});
!function(o,s,u){var m,l=[],c=o.resize=o.extend(o.resize,{}),d=!1,t="setTimeout",f="resize",v=f+"-special-event",w="pendingDelay",n="activeDelay",g="throttleWindow";function h(e){!0===d&&(d=e||1);for(var i=l.length-1;0<=i;i--){var t=o(l[i]);if(t[0]==s||t.is(":visible")){var n=t.width(),a=t.height(),r=t.data(v);!r||n===r.w&&a===r.h||(t.trigger(f,[r.w=n,r.h=a]),d=e||!0)}else(r=t.data(v)).w=0,r.h=0}null!==m&&(d&&(null==e||e-d<1e3)?m=s.requestAnimationFrame(h):(m=setTimeout(h,c[w]),d=!1))}c[w]=200,c[n]=20,c[g]=!0,o.event.special[f]={setup:function(){if(!c[g]&&this[t])return!1;var e=o(this);l.push(this),e.data(v,{w:e.width(),h:e.height()}),1===l.length&&(m=u,h())},teardown:function(){if(!c[g]&&this[t])return!1;for(var e=o(this),i=l.length-1;0<=i;i--)if(l[i]==this){l.splice(i,1);break}e.removeData(v),l.length||(d?cancelAnimationFrame(m):clearTimeout(m),m=null)},add:function(e){if(!c[g]&&this[t])return!1;var r;function a(e,i,t){var n=o(this),a=n.data(v)||{};a.w=i!==u?i:n.width(),a.h=t!==u?t:n.height(),r.apply(this,arguments)}if(o.isFunction(e))return r=e,a;r=e.handler,e.handler=a}},s.requestAnimationFrame||(s.requestAnimationFrame=s.webkitRequestAnimationFrame||s.mozRequestAnimationFrame||s.oRequestAnimationFrame||s.msRequestAnimationFrame||function(e,i){return s.setTimeout(function(){e((new Date).getTime())},c[n])}),s.cancelAnimationFrame||(s.cancelAnimationFrame=s.webkitCancelRequestAnimationFrame||s.mozCancelRequestAnimationFrame||s.oCancelRequestAnimationFrame||s.msCancelRequestAnimationFrame||clearTimeout)}(jQuery,this),jQuery.plot.plugins.push({init:function init(i){function onResize(){var e=i.getPlaceholder();0!=e.width()&&0!=e.height()&&(i.resize(),i.setupGrid(),i.draw())}i.hooks.bindEvents.push(function bindEvents(e,i){e.getPlaceholder().resize(onResize)}),i.hooks.shutdown.push(function shutdown(e,i){e.getPlaceholder().unbind("resize",onResize)})},options:{},name:"resize",version:"1.0"});
!function(r){function e(t){var n,o=this,a=t.data||{};if(a.elem)o=t.dragTarget=a.elem,t.dragProxy=l.proxy||o,t.cursorOffsetX=a.pageX-a.left,t.cursorOffsetY=a.pageY-a.top,t.offsetX=t.pageX-t.cursorOffsetX,t.offsetY=t.pageY-t.cursorOffsetY;else if(l.dragging||0<a.which&&t.which!=a.which||r(t.target).is(a.not))return;switch(t.type){case"mousedown":return r.extend(a,r(o).offset(),{elem:o,target:t.target,pageX:t.pageX,pageY:t.pageY}),s.add(document,"mousemove mouseup",e,a),i(o,!1),l.dragging=null,!1;case!l.dragging&&"mousemove":if(g(t.pageX-a.pageX)+g(t.pageY-a.pageY)<a.distance)break;t.target=a.target,!1!==(n=f(t,"dragstart",o))&&(l.dragging=o,l.proxy=t.dragProxy=r(n||o)[0]);case"mousemove":if(l.dragging){if(n=f(t,"drag",o),u.drop&&(u.drop.allowed=!1!==n,u.drop.handler(t)),!1!==n)break;t.type="mouseup"}case"mouseup":s.remove(document,"mousemove mouseup",e),l.dragging&&(u.drop&&u.drop.handler(t),f(t,"dragend",o)),i(o,!0),l.dragging=l.proxy=a.elem=!1}return!0}function f(e,t,n){e.type=t;var o=r.event.dispatch.call(n,e);return!1!==o&&(o||e.result)}function g(e){return Math.pow(e,2)}function h(){return!1===l.dragging}function i(e,t){e&&(e.unselectable=t?"off":"on",e.onselectstart=function(){return t},e.style&&(e.style.MozUserSelect=t?"":"none"))}r.fn.drag=function(e,t,n){return t&&this.bind("dragstart",e),n&&this.bind("dragend",n),e?this.bind("drag",t||e):this.trigger("drag")};var s=r.event,u=s.special,l=u.drag={not:":input",distance:0,which:1,dragging:!1,setup:function(t){(t=r.extend({distance:l.distance,which:l.which,not:l.not},t||{})).distance=g(t.distance),s.add(this,"mousedown",e,t),this.attachEvent&&this.attachEvent("ondragstart",h)},teardown:function(){s.remove(this,"mousedown",e),this===l.dragging&&(l.dragging=l.proxy=!1),i(this,!0),this.detachEvent&&this.detachEvent("ondragstart",h)}};u.dragstart=u.dragend={setup:function(){},teardown:function(){}}}(jQuery),function(i){function e(e){var t=e||window.event,n=[].slice.call(arguments,1),o=0,a=0,r=0;return(e=i.event.fix(t)).type="mousewheel",t.wheelDelta&&(o=t.wheelDelta/120),t.detail&&(o=-t.detail/3),r=o,void 0!==t.axis&&t.axis===t.HORIZONTAL_AXIS&&(r=0,a=-1*o),void 0!==t.wheelDeltaY&&(r=t.wheelDeltaY/120),void 0!==t.wheelDeltaX&&(a=-1*t.wheelDeltaX/120),n.unshift(e,o,a,r),(i.event.dispatch||i.event.handle).apply(this,n)}var n=["DOMMouseScroll","mousewheel"];if(i.event.fixHooks)for(var t=n.length;t;)i.event.fixHooks[n[--t]]=i.event.mouseHooks;i.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var t=n.length;t;)this.addEventListener(n[--t],e,!1);else this.onmousewheel=e},teardown:function(){if(this.removeEventListener)for(var t=n.length;t;)this.removeEventListener(n[--t],e,!1);else this.onmousewheel=null}},i.fn.extend({mousewheel:function(e){return e?this.bind("mousewheel",e):this.trigger("mousewheel")},unmousewheel:function(e){return this.unbind("mousewheel",e)}})}(jQuery),function(u){u.plot.plugins.push({init:function init(i){function onZoomClick(e,t){var n=i.offset();n.left=e.pageX-n.left,n.top=e.pageY-n.top,t?i.zoomOut({center:n}):i.zoom({center:n})}function onMouseWheel(e,t){return e.preventDefault(),onZoomClick(e,t<0),!1}var n="default",o=0,a=0,r=null;function onDragStart(e){if(1!=e.which)return!1;var t=i.getPlaceholder().css("cursor");t&&(n=t),i.getPlaceholder().css("cursor",i.getOptions().pan.cursor),o=e.pageX,a=e.pageY}function onDrag(e){var t=i.getOptions().pan.frameRate;!r&&t&&(r=setTimeout(function(){i.pan({left:o-e.pageX,top:a-e.pageY}),o=e.pageX,a=e.pageY,r=null},1/t*1e3))}function onDragEnd(e){r&&(clearTimeout(r),r=null),i.getPlaceholder().css("cursor",n),i.pan({left:o-e.pageX,top:a-e.pageY})}i.zoomOut=function(e){e||(e={}),e.amount||(e.amount=i.getOptions().zoom.amount),e.amount=1/e.amount,i.zoom(e)},i.zoom=function(e){e||(e={});var t=e.center,g=e.amount||i.getOptions().zoom.amount,n=i.width(),o=i.height();t||(t={left:n/2,top:o/2});var a=t.left/n,r=t.top/o,l={x:{min:t.left-a*n/g,max:t.left+(1-a)*n/g},y:{min:t.top-r*o/g,max:t.top+(1-r)*o/g}};u.each(i.getAxes(),function(e,t){var n=t.options,o=l[t.direction].min,a=l[t.direction].max,r=n.zoomRange,i=n.panRange;if(!1!==r){if(o=t.c2p(o),(a=t.c2p(a))<o){var s=o;o=a,a=s}i&&(null!=i[0]&&o<i[0]&&(o=i[0]),null!=i[1]&&a>i[1]&&(a=i[1]));var u=a-o;r&&(null!=r[0]&&u<r[0]&&1<g||null!=r[1]&&u>r[1]&&g<1)||(n.min=o,n.max=a)}}),i.setupGrid(),i.draw(),e.preventEvent||i.getPlaceholder().trigger("plotzoom",[i,e])},i.pan=function(e){var s={x:+e.left,y:+e.top};isNaN(s.x)&&(s.x=0),isNaN(s.y)&&(s.y=0),u.each(i.getAxes(),function(e,t){var n,o,a=t.options,r=s[t.direction];n=t.c2p(t.p2c(t.min)+r),o=t.c2p(t.p2c(t.max)+r);var i=a.panRange;!1!==i&&(i&&(null!=i[0]&&i[0]>n&&(n+=r=i[0]-n,o+=r),null!=i[1]&&i[1]<o&&(n+=r=i[1]-o,o+=r)),a.min=n,a.max=o)}),i.setupGrid(),i.draw(),e.preventEvent||i.getPlaceholder().trigger("plotpan",[i,e])},i.hooks.bindEvents.push(function bindEvents(e,t){var n=e.getOptions();n.zoom.interactive&&(t[n.zoom.trigger](onZoomClick),t.mousewheel(onMouseWheel)),n.pan.interactive&&(t.bind("dragstart",{distance:10},onDragStart),t.bind("drag",onDrag),t.bind("dragend",onDragEnd))}),i.hooks.shutdown.push(function shutdown(e,t){t.unbind(e.getOptions().zoom.trigger,onZoomClick),t.unbind("mousewheel",onMouseWheel),t.unbind("dragstart",onDragStart),t.unbind("drag",onDrag),t.unbind("dragend",onDragEnd),r&&clearTimeout(r)})},options:{xaxis:{zoomRange:null,panRange:null},zoom:{interactive:!1,trigger:"dblclick",amount:1.5},pan:{interactive:!1,cursor:"move",frameRate:20}},name:"navigate",version:"1.3"})}(jQuery);
if("undefined"==typeof jQuery)throw new Error("Bootstrap's JavaScript requires jQuery");!function(t){"use strict";var e=jQuery.fn.jquery.split(" ")[0].split(".");if(e[0]<2&&e[1]<9||1==e[0]&&9==e[1]&&e[2]<1||3<e[0])throw new Error("Bootstrap's JavaScript requires jQuery version 1.9.1 or higher, but lower than version 4")}(),function(o){"use strict";o.fn.emulateTransitionEnd=function(t){var e=!1,i=this;o(this).one("bsTransitionEnd",function(){e=!0});return setTimeout(function(){e||o(i).trigger(o.support.transition.end)},t),this},o(function(){o.support.transition=function transitionEnd(){var t=document.createElement("bootstrap"),e={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",transition:"transitionend"};for(var i in e)if(void 0!==t.style[i])return{end:e[i]};return!1}(),o.support.transition&&(o.event.special.bsTransitionEnd={bindType:o.support.transition.end,delegateType:o.support.transition.end,handle:function(t){if(o(t.target).is(this))return t.handleObj.handler.apply(this,arguments)}})})}(jQuery),function(n){"use strict";var e='[data-dismiss="alert"]',s=function(t){n(t).on("click",e,this.close)};s.VERSION="3.3.7",s.TRANSITION_DURATION=150,s.prototype.close=function(t){var e=n(this),i=e.attr("data-target");i||(i=(i=e.attr("href"))&&i.replace(/.*(?=#[^\s]*$)/,""));var o=n("#"===i?[]:i);function removeElement(){o.detach().trigger("closed.bs.alert").remove()}t&&t.preventDefault(),o.length||(o=e.closest(".alert")),o.trigger(t=n.Event("close.bs.alert")),t.isDefaultPrevented()||(o.removeClass("in"),n.support.transition&&o.hasClass("fade")?o.one("bsTransitionEnd",removeElement).emulateTransitionEnd(s.TRANSITION_DURATION):removeElement())};var t=n.fn.alert;n.fn.alert=function Plugin(i){return this.each(function(){var t=n(this),e=t.data("bs.alert");e||t.data("bs.alert",e=new s(this)),"string"==typeof i&&e[i].call(t)})},n.fn.alert.Constructor=s,n.fn.alert.noConflict=function(){return n.fn.alert=t,this},n(document).on("click.bs.alert.data-api",e,s.prototype.close)}(jQuery),function(s){"use strict";var n=function(t,e){this.$element=s(t),this.options=s.extend({},n.DEFAULTS,e),this.isLoading=!1};function Plugin(o){return this.each(function(){var t=s(this),e=t.data("bs.button"),i="object"==typeof o&&o;e||t.data("bs.button",e=new n(this,i)),"toggle"==o?e.toggle():o&&e.setState(o)})}n.VERSION="3.3.7",n.DEFAULTS={loadingText:"loading..."},n.prototype.setState=function(t){var e="disabled",i=this.$element,o=i.is("input")?"val":"html",n=i.data();t+="Text",null==n.resetText&&i.data("resetText",i[o]()),setTimeout(s.proxy(function(){i[o](null==n[t]?this.options[t]:n[t]),"loadingText"==t?(this.isLoading=!0,i.addClass(e).attr(e,e).prop(e,!0)):this.isLoading&&(this.isLoading=!1,i.removeClass(e).removeAttr(e).prop(e,!1))},this),0)},n.prototype.toggle=function(){var t=!0,e=this.$element.closest('[data-toggle="buttons"]');if(e.length){var i=this.$element.find("input");"radio"==i.prop("type")?(i.prop("checked")&&(t=!1),e.find(".active").removeClass("active"),this.$element.addClass("active")):"checkbox"==i.prop("type")&&(i.prop("checked")!==this.$element.hasClass("active")&&(t=!1),this.$element.toggleClass("active")),i.prop("checked",this.$element.hasClass("active")),t&&i.trigger("change")}else this.$element.attr("aria-pressed",!this.$element.hasClass("active")),this.$element.toggleClass("active")};var t=s.fn.button;s.fn.button=Plugin,s.fn.button.Constructor=n,s.fn.button.noConflict=function(){return s.fn.button=t,this},s(document).on("click.bs.button.data-api",'[data-toggle^="button"]',function(t){var e=s(t.target).closest(".btn");Plugin.call(e,"toggle"),s(t.target).is('input[type="radio"], input[type="checkbox"]')||(t.preventDefault(),e.is("input,button")?e.trigger("focus"):e.find("input:visible,button:visible").first().trigger("focus"))}).on("focus.bs.button.data-api blur.bs.button.data-api",'[data-toggle^="button"]',function(t){s(t.target).closest(".btn").toggleClass("focus",/^focus(in)?$/.test(t.type))})}(jQuery),function(p){"use strict";var c=function(t,e){this.$element=p(t),this.$indicators=this.$element.find(".carousel-indicators"),this.options=e,this.paused=null,this.sliding=null,this.interval=null,this.$active=null,this.$items=null,this.options.keyboard&&this.$element.on("keydown.bs.carousel",p.proxy(this.keydown,this)),"hover"==this.options.pause&&!("ontouchstart"in document.documentElement)&&this.$element.on("mouseenter.bs.carousel",p.proxy(this.pause,this)).on("mouseleave.bs.carousel",p.proxy(this.cycle,this))};function Plugin(n){return this.each(function(){var t=p(this),e=t.data("bs.carousel"),i=p.extend({},c.DEFAULTS,t.data(),"object"==typeof n&&n),o="string"==typeof n?n:i.slide;e||t.data("bs.carousel",e=new c(this,i)),"number"==typeof n?e.to(n):o?e[o]():i.interval&&e.pause().cycle()})}c.VERSION="3.3.7",c.TRANSITION_DURATION=600,c.DEFAULTS={interval:5e3,pause:"hover",wrap:!0,keyboard:!0},c.prototype.keydown=function(t){if(!/input|textarea/i.test(t.target.tagName)){switch(t.which){case 37:this.prev();break;case 39:this.next();break;default:return}t.preventDefault()}},c.prototype.cycle=function(t){return t||(this.paused=!1),this.interval&&clearInterval(this.interval),this.options.interval&&!this.paused&&(this.interval=setInterval(p.proxy(this.next,this),this.options.interval)),this},c.prototype.getItemIndex=function(t){return this.$items=t.parent().children(".item"),this.$items.index(t||this.$active)},c.prototype.getItemForDirection=function(t,e){var i=this.getItemIndex(e);if(("prev"==t&&0===i||"next"==t&&i==this.$items.length-1)&&!this.options.wrap)return e;var o=(i+("prev"==t?-1:1))%this.$items.length;return this.$items.eq(o)},c.prototype.to=function(t){var e=this,i=this.getItemIndex(this.$active=this.$element.find(".item.active"));if(!(t>this.$items.length-1||t<0))return this.sliding?this.$element.one("slid.bs.carousel",function(){e.to(t)}):i==t?this.pause().cycle():this.slide(i<t?"next":"prev",this.$items.eq(t))},c.prototype.pause=function(t){return t||(this.paused=!0),this.$element.find(".next, .prev").length&&p.support.transition&&(this.$element.trigger(p.support.transition.end),this.cycle(!0)),this.interval=clearInterval(this.interval),this},c.prototype.next=function(){if(!this.sliding)return this.slide("next")},c.prototype.prev=function(){if(!this.sliding)return this.slide("prev")},c.prototype.slide=function(t,e){var i=this.$element.find(".item.active"),o=e||this.getItemForDirection(t,i),n=this.interval,s="next"==t?"left":"right",r=this;if(o.hasClass("active"))return this.sliding=!1;var a=o[0],l=p.Event("slide.bs.carousel",{relatedTarget:a,direction:s});if(this.$element.trigger(l),!l.isDefaultPrevented()){if(this.sliding=!0,n&&this.pause(),this.$indicators.length){this.$indicators.find(".active").removeClass("active");var h=p(this.$indicators.children()[this.getItemIndex(o)]);h&&h.addClass("active")}var d=p.Event("slid.bs.carousel",{relatedTarget:a,direction:s});return p.support.transition&&this.$element.hasClass("slide")?(o.addClass(t),o[0].offsetWidth,i.addClass(s),o.addClass(s),i.one("bsTransitionEnd",function(){o.removeClass([t,s].join(" ")).addClass("active"),i.removeClass(["active",s].join(" ")),r.sliding=!1,setTimeout(function(){r.$element.trigger(d)},0)}).emulateTransitionEnd(c.TRANSITION_DURATION)):(i.removeClass("active"),o.addClass("active"),this.sliding=!1,this.$element.trigger(d)),n&&this.cycle(),this}};var t=p.fn.carousel;p.fn.carousel=Plugin,p.fn.carousel.Constructor=c,p.fn.carousel.noConflict=function(){return p.fn.carousel=t,this};var e=function(t){var e,i=p(this),o=p(i.attr("data-target")||(e=i.attr("href"))&&e.replace(/.*(?=#[^\s]+$)/,""));if(o.hasClass("carousel")){var n=p.extend({},o.data(),i.data()),s=i.attr("data-slide-to");s&&(n.interval=!1),Plugin.call(o,n),s&&o.data("bs.carousel").to(s),t.preventDefault()}};p(document).on("click.bs.carousel.data-api","[data-slide]",e).on("click.bs.carousel.data-api","[data-slide-to]",e),p(window).on("load",function(){p('[data-ride="carousel"]').each(function(){var t=p(this);Plugin.call(t,t.data())})})}(jQuery),function(r){"use strict";var a=function(t,e){this.$element=r(t),this.options=r.extend({},a.DEFAULTS,e),this.$trigger=r('[data-toggle="collapse"][href="#'+t.id+'"],[data-toggle="collapse"][data-target="#'+t.id+'"]'),this.transitioning=null,this.options.parent?this.$parent=this.getParent():this.addAriaAndCollapsedClass(this.$element,this.$trigger),this.options.toggle&&this.toggle()};function getTargetFromTrigger(t){var e,i=t.attr("data-target")||(e=t.attr("href"))&&e.replace(/.*(?=#[^\s]+$)/,"");return r(i)}function Plugin(o){return this.each(function(){var t=r(this),e=t.data("bs.collapse"),i=r.extend({},a.DEFAULTS,t.data(),"object"==typeof o&&o);!e&&i.toggle&&/show|hide/.test(o)&&(i.toggle=!1),e||t.data("bs.collapse",e=new a(this,i)),"string"==typeof o&&e[o]()})}a.VERSION="3.3.7",a.TRANSITION_DURATION=350,a.DEFAULTS={toggle:!0},a.prototype.dimension=function(){return this.$element.hasClass("width")?"width":"height"},a.prototype.show=function(){if(!this.transitioning&&!this.$element.hasClass("in")){var t,e=this.$parent&&this.$parent.children(".panel").children(".in, .collapsing");if(!(e&&e.length&&(t=e.data("bs.collapse"))&&t.transitioning)){var i=r.Event("show.bs.collapse");if(this.$element.trigger(i),!i.isDefaultPrevented()){e&&e.length&&(Plugin.call(e,"hide"),t||e.data("bs.collapse",null));var o=this.dimension();this.$element.removeClass("collapse").addClass("collapsing")[o](0).attr("aria-expanded",!0),this.$trigger.removeClass("collapsed").attr("aria-expanded",!0),this.transitioning=1;var n=function(){this.$element.removeClass("collapsing").addClass("collapse in")[o](""),this.transitioning=0,this.$element.trigger("shown.bs.collapse")};if(!r.support.transition)return n.call(this);var s=r.camelCase(["scroll",o].join("-"));this.$element.one("bsTransitionEnd",r.proxy(n,this)).emulateTransitionEnd(a.TRANSITION_DURATION)[o](this.$element[0][s])}}}},a.prototype.hide=function(){if(!this.transitioning&&this.$element.hasClass("in")){var t=r.Event("hide.bs.collapse");if(this.$element.trigger(t),!t.isDefaultPrevented()){var e=this.dimension();this.$element[e](this.$element[e]())[0].offsetHeight,this.$element.addClass("collapsing").removeClass("collapse in").attr("aria-expanded",!1),this.$trigger.addClass("collapsed").attr("aria-expanded",!1),this.transitioning=1;var i=function(){this.transitioning=0,this.$element.removeClass("collapsing").addClass("collapse").trigger("hidden.bs.collapse")};if(!r.support.transition)return i.call(this);this.$element[e](0).one("bsTransitionEnd",r.proxy(i,this)).emulateTransitionEnd(a.TRANSITION_DURATION)}}},a.prototype.toggle=function(){this[this.$element.hasClass("in")?"hide":"show"]()},a.prototype.getParent=function(){return r(this.options.parent).find('[data-toggle="collapse"][data-parent="'+this.options.parent+'"]').each(r.proxy(function(t,e){var i=r(e);this.addAriaAndCollapsedClass(getTargetFromTrigger(i),i)},this)).end()},a.prototype.addAriaAndCollapsedClass=function(t,e){var i=t.hasClass("in");t.attr("aria-expanded",i),e.toggleClass("collapsed",!i).attr("aria-expanded",i)};var t=r.fn.collapse;r.fn.collapse=Plugin,r.fn.collapse.Constructor=a,r.fn.collapse.noConflict=function(){return r.fn.collapse=t,this},r(document).on("click.bs.collapse.data-api",'[data-toggle="collapse"]',function(t){var e=r(this);e.attr("data-target")||t.preventDefault();var i=getTargetFromTrigger(e),o=i.data("bs.collapse")?"toggle":e.data();Plugin.call(i,o)})}(jQuery),function(r){"use strict";var a='[data-toggle="dropdown"]',o=function(t){r(t).on("click.bs.dropdown",this.toggle)};function getParent(t){var e=t.attr("data-target");e||(e=(e=t.attr("href"))&&/#[A-Za-z]/.test(e)&&e.replace(/.*(?=#[^\s]*$)/,""));var i=e&&r(e);return i&&i.length?i:t.parent()}function clearMenus(o){o&&3===o.which||(r(".dropdown-backdrop").remove(),r(a).each(function(){var t=r(this),e=getParent(t),i={relatedTarget:this};e.hasClass("open")&&(o&&"click"==o.type&&/input|textarea/i.test(o.target.tagName)&&r.contains(e[0],o.target)||(e.trigger(o=r.Event("hide.bs.dropdown",i)),o.isDefaultPrevented()||(t.attr("aria-expanded","false"),e.removeClass("open").trigger(r.Event("hidden.bs.dropdown",i)))))}))}o.VERSION="3.3.7",o.prototype.toggle=function(t){var e=r(this);if(!e.is(".disabled, :disabled")){var i=getParent(e),o=i.hasClass("open");if(clearMenus(),!o){"ontouchstart"in document.documentElement&&!i.closest(".navbar-nav").length&&r(document.createElement("div")).addClass("dropdown-backdrop").insertAfter(r(this)).on("click",clearMenus);var n={relatedTarget:this};if(i.trigger(t=r.Event("show.bs.dropdown",n)),t.isDefaultPrevented())return;e.trigger("focus").attr("aria-expanded","true"),i.toggleClass("open").trigger(r.Event("shown.bs.dropdown",n))}return!1}},o.prototype.keydown=function(t){if(/(38|40|27|32)/.test(t.which)&&!/input|textarea/i.test(t.target.tagName)){var e=r(this);if(t.preventDefault(),t.stopPropagation(),!e.is(".disabled, :disabled")){var i=getParent(e),o=i.hasClass("open");if(!o&&27!=t.which||o&&27==t.which)return 27==t.which&&i.find(a).trigger("focus"),e.trigger("click");var n=i.find(".dropdown-menu li:not(.disabled):visible a");if(n.length){var s=n.index(t.target);38==t.which&&0<s&&s--,40==t.which&&s<n.length-1&&s++,~s||(s=0),n.eq(s).trigger("focus")}}}};var t=r.fn.dropdown;r.fn.dropdown=function Plugin(i){return this.each(function(){var t=r(this),e=t.data("bs.dropdown");e||t.data("bs.dropdown",e=new o(this)),"string"==typeof i&&e[i].call(t)})},r.fn.dropdown.Constructor=o,r.fn.dropdown.noConflict=function(){return r.fn.dropdown=t,this},r(document).on("click.bs.dropdown.data-api",clearMenus).on("click.bs.dropdown.data-api",".dropdown form",function(t){t.stopPropagation()}).on("click.bs.dropdown.data-api",a,o.prototype.toggle).on("keydown.bs.dropdown.data-api",a,o.prototype.keydown).on("keydown.bs.dropdown.data-api",".dropdown-menu",o.prototype.keydown)}(jQuery),function(s){"use strict";var r=function(t,e){this.options=e,this.$body=s(document.body),this.$element=s(t),this.$dialog=this.$element.find(".modal-dialog"),this.$backdrop=null,this.isShown=null,this.originalBodyPad=null,this.scrollbarWidth=0,this.ignoreBackdropClick=!1,this.options.remote&&this.$element.find(".modal-content").load(this.options.remote,s.proxy(function(){this.$element.trigger("loaded.bs.modal")},this))};function Plugin(o,n){return this.each(function(){var t=s(this),e=t.data("bs.modal"),i=s.extend({},r.DEFAULTS,t.data(),"object"==typeof o&&o);e||t.data("bs.modal",e=new r(this,i)),"string"==typeof o?e[o](n):i.show&&e.show(n)})}r.VERSION="3.3.7",r.TRANSITION_DURATION=300,r.BACKDROP_TRANSITION_DURATION=150,r.DEFAULTS={backdrop:!0,keyboard:!0,show:!0},r.prototype.toggle=function(t){return this.isShown?this.hide():this.show(t)},r.prototype.show=function(i){var o=this,t=s.Event("show.bs.modal",{relatedTarget:i});this.$element.trigger(t),this.isShown||t.isDefaultPrevented()||(this.isShown=!0,this.checkScrollbar(),this.setScrollbar(),this.$body.addClass("modal-open"),this.escape(),this.resize(),this.$element.on("click.dismiss.bs.modal",'[data-dismiss="modal"]',s.proxy(this.hide,this)),this.$dialog.on("mousedown.dismiss.bs.modal",function(){o.$element.one("mouseup.dismiss.bs.modal",function(t){s(t.target).is(o.$element)&&(o.ignoreBackdropClick=!0)})}),this.backdrop(function(){var t=s.support.transition&&o.$element.hasClass("fade");o.$element.parent().length||o.$element.appendTo(o.$body),o.$element.show().scrollTop(0),o.adjustDialog(),t&&o.$element[0].offsetWidth,o.$element.addClass("in"),o.enforceFocus();var e=s.Event("shown.bs.modal",{relatedTarget:i});t?o.$dialog.one("bsTransitionEnd",function(){o.$element.trigger("focus").trigger(e)}).emulateTransitionEnd(r.TRANSITION_DURATION):o.$element.trigger("focus").trigger(e)}))},r.prototype.hide=function(t){t&&t.preventDefault(),t=s.Event("hide.bs.modal"),this.$element.trigger(t),this.isShown&&!t.isDefaultPrevented()&&(this.isShown=!1,this.escape(),this.resize(),s(document).off("focusin.bs.modal"),this.$element.removeClass("in").off("click.dismiss.bs.modal").off("mouseup.dismiss.bs.modal"),this.$dialog.off("mousedown.dismiss.bs.modal"),s.support.transition&&this.$element.hasClass("fade")?this.$element.one("bsTransitionEnd",s.proxy(this.hideModal,this)).emulateTransitionEnd(r.TRANSITION_DURATION):this.hideModal())},r.prototype.enforceFocus=function(){s(document).off("focusin.bs.modal").on("focusin.bs.modal",s.proxy(function(t){document===t.target||this.$element[0]===t.target||this.$element.has(t.target).length||this.$element.trigger("focus")},this))},r.prototype.escape=function(){this.isShown&&this.options.keyboard?this.$element.on("keydown.dismiss.bs.modal",s.proxy(function(t){27==t.which&&this.hide()},this)):this.isShown||this.$element.off("keydown.dismiss.bs.modal")},r.prototype.resize=function(){this.isShown?s(window).on("resize.bs.modal",s.proxy(this.handleUpdate,this)):s(window).off("resize.bs.modal")},r.prototype.hideModal=function(){var t=this;this.$element.hide(),this.backdrop(function(){t.$body.removeClass("modal-open"),t.resetAdjustments(),t.resetScrollbar(),t.$element.trigger("hidden.bs.modal")})},r.prototype.removeBackdrop=function(){this.$backdrop&&this.$backdrop.remove(),this.$backdrop=null},r.prototype.backdrop=function(t){var e=this,i=this.$element.hasClass("fade")?"fade":"";if(this.isShown&&this.options.backdrop){var o=s.support.transition&&i;if(this.$backdrop=s(document.createElement("div")).addClass("modal-backdrop "+i).appendTo(this.$body),this.$element.on("click.dismiss.bs.modal",s.proxy(function(t){this.ignoreBackdropClick?this.ignoreBackdropClick=!1:t.target===t.currentTarget&&("static"==this.options.backdrop?this.$element[0].focus():this.hide())},this)),o&&this.$backdrop[0].offsetWidth,this.$backdrop.addClass("in"),!t)return;o?this.$backdrop.one("bsTransitionEnd",t).emulateTransitionEnd(r.BACKDROP_TRANSITION_DURATION):t()}else if(!this.isShown&&this.$backdrop){this.$backdrop.removeClass("in");var n=function(){e.removeBackdrop(),t&&t()};s.support.transition&&this.$element.hasClass("fade")?this.$backdrop.one("bsTransitionEnd",n).emulateTransitionEnd(r.BACKDROP_TRANSITION_DURATION):n()}else t&&t()},r.prototype.handleUpdate=function(){this.adjustDialog()},r.prototype.adjustDialog=function(){var t=this.$element[0].scrollHeight>document.documentElement.clientHeight;this.$element.css({paddingLeft:!this.bodyIsOverflowing&&t?this.scrollbarWidth:"",paddingRight:this.bodyIsOverflowing&&!t?this.scrollbarWidth:""})},r.prototype.resetAdjustments=function(){this.$element.css({paddingLeft:"",paddingRight:""})},r.prototype.checkScrollbar=function(){var t=window.innerWidth;if(!t){var e=document.documentElement.getBoundingClientRect();t=e.right-Math.abs(e.left)}this.bodyIsOverflowing=document.body.clientWidth<t,this.scrollbarWidth=this.measureScrollbar()},r.prototype.setScrollbar=function(){var t=parseInt(this.$body.css("padding-right")||0,10);this.originalBodyPad=document.body.style.paddingRight||"",this.bodyIsOverflowing&&this.$body.css("padding-right",t+this.scrollbarWidth)},r.prototype.resetScrollbar=function(){this.$body.css("padding-right",this.originalBodyPad)},r.prototype.measureScrollbar=function(){var t=document.createElement("div");t.className="modal-scrollbar-measure",this.$body.append(t);var e=t.offsetWidth-t.clientWidth;return this.$body[0].removeChild(t),e};var t=s.fn.modal;s.fn.modal=Plugin,s.fn.modal.Constructor=r,s.fn.modal.noConflict=function(){return s.fn.modal=t,this},s(document).on("click.bs.modal.data-api",'[data-toggle="modal"]',function(t){var e=s(this),i=e.attr("href"),o=s(e.attr("data-target")||i&&i.replace(/.*(?=#[^\s]+$)/,"")),n=o.data("bs.modal")?"toggle":s.extend({remote:!/#/.test(i)&&i},o.data(),e.data());e.is("a")&&t.preventDefault(),o.one("show.bs.modal",function(t){t.isDefaultPrevented()||o.one("hidden.bs.modal",function(){e.is(":visible")&&e.trigger("focus")})}),Plugin.call(o,n,this)})}(jQuery),function(g){"use strict";var m=function(t,e){this.type=null,this.options=null,this.enabled=null,this.timeout=null,this.hoverState=null,this.$element=null,this.inState=null,this.init("tooltip",t,e)};m.VERSION="3.3.7",m.TRANSITION_DURATION=150,m.DEFAULTS={animation:!0,placement:"top",selector:!1,template:'<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>',trigger:"hover focus",title:"",delay:0,html:!1,container:!1,viewport:{selector:"body",padding:0}},m.prototype.init=function(t,e,i){if(this.enabled=!0,this.type=t,this.$element=g(e),this.options=this.getOptions(i),this.$viewport=this.options.viewport&&g(g.isFunction(this.options.viewport)?this.options.viewport.call(this,this.$element):this.options.viewport.selector||this.options.viewport),this.inState={click:!1,hover:!1,focus:!1},this.$element[0]instanceof document.constructor&&!this.options.selector)throw new Error("`selector` option must be specified when initializing "+this.type+" on the window.document object!");for(var o=this.options.trigger.split(" "),n=o.length;n--;){var s=o[n];if("click"==s)this.$element.on("click."+this.type,this.options.selector,g.proxy(this.toggle,this));else if("manual"!=s){var r="hover"==s?"mouseenter":"focusin",a="hover"==s?"mouseleave":"focusout";this.$element.on(r+"."+this.type,this.options.selector,g.proxy(this.enter,this)),this.$element.on(a+"."+this.type,this.options.selector,g.proxy(this.leave,this))}}this.options.selector?this._options=g.extend({},this.options,{trigger:"manual",selector:""}):this.fixTitle()},m.prototype.getDefaults=function(){return m.DEFAULTS},m.prototype.getOptions=function(t){return(t=g.extend({},this.getDefaults(),this.$element.data(),t)).delay&&"number"==typeof t.delay&&(t.delay={show:t.delay,hide:t.delay}),t},m.prototype.getDelegateOptions=function(){var i={},o=this.getDefaults();return this._options&&g.each(this._options,function(t,e){o[t]!=e&&(i[t]=e)}),i},m.prototype.enter=function(t){var e=t instanceof this.constructor?t:g(t.currentTarget).data("bs."+this.type);if(e||(e=new this.constructor(t.currentTarget,this.getDelegateOptions()),g(t.currentTarget).data("bs."+this.type,e)),t instanceof g.Event&&(e.inState["focusin"==t.type?"focus":"hover"]=!0),e.tip().hasClass("in")||"in"==e.hoverState)e.hoverState="in";else{if(clearTimeout(e.timeout),e.hoverState="in",!e.options.delay||!e.options.delay.show)return e.show();e.timeout=setTimeout(function(){"in"==e.hoverState&&e.show()},e.options.delay.show)}},m.prototype.isInStateTrue=function(){for(var t in this.inState)if(this.inState[t])return!0;return!1},m.prototype.leave=function(t){var e=t instanceof this.constructor?t:g(t.currentTarget).data("bs."+this.type);if(e||(e=new this.constructor(t.currentTarget,this.getDelegateOptions()),g(t.currentTarget).data("bs."+this.type,e)),t instanceof g.Event&&(e.inState["focusout"==t.type?"focus":"hover"]=!1),!e.isInStateTrue()){if(clearTimeout(e.timeout),e.hoverState="out",!e.options.delay||!e.options.delay.hide)return e.hide();e.timeout=setTimeout(function(){"out"==e.hoverState&&e.hide()},e.options.delay.hide)}},m.prototype.show=function(){var t=g.Event("show.bs."+this.type);if(this.hasContent()&&this.enabled){this.$element.trigger(t);var e=g.contains(this.$element[0].ownerDocument.documentElement,this.$element[0]);if(t.isDefaultPrevented()||!e)return;var i=this,o=this.tip(),n=this.getUID(this.type);this.setContent(),o.attr("id",n),this.$element.attr("aria-describedby",n),this.options.animation&&o.addClass("fade");var s="function"==typeof this.options.placement?this.options.placement.call(this,o[0],this.$element[0]):this.options.placement,r=/\s?auto?\s?/i,a=r.test(s);a&&(s=s.replace(r,"")||"top"),o.detach().css({top:0,left:0,display:"block"}).addClass(s).data("bs."+this.type,this),this.options.container?o.appendTo(this.options.container):o.insertAfter(this.$element),this.$element.trigger("inserted.bs."+this.type);var l=this.getPosition(),h=o[0].offsetWidth,d=o[0].offsetHeight;if(a){var p=s,c=this.getPosition(this.$viewport);s="bottom"==s&&l.bottom+d>c.bottom?"top":"top"==s&&l.top-d<c.top?"bottom":"right"==s&&l.right+h>c.width?"left":"left"==s&&l.left-h<c.left?"right":s,o.removeClass(p).addClass(s)}var f=this.getCalculatedOffset(s,l,h,d);this.applyPlacement(f,s);var u=function(){var t=i.hoverState;i.$element.trigger("shown.bs."+i.type),i.hoverState=null,"out"==t&&i.leave(i)};g.support.transition&&this.$tip.hasClass("fade")?o.one("bsTransitionEnd",u).emulateTransitionEnd(m.TRANSITION_DURATION):u()}},m.prototype.applyPlacement=function(t,e){var i=this.tip(),o=i[0].offsetWidth,n=i[0].offsetHeight,s=parseInt(i.css("margin-top"),10),r=parseInt(i.css("margin-left"),10);isNaN(s)&&(s=0),isNaN(r)&&(r=0),t.top+=s,t.left+=r,g.offset.setOffset(i[0],g.extend({using:function(t){i.css({top:Math.round(t.top),left:Math.round(t.left)})}},t),0),i.addClass("in");var a=i[0].offsetWidth,l=i[0].offsetHeight;"top"==e&&l!=n&&(t.top=t.top+n-l);var h=this.getViewportAdjustedDelta(e,t,a,l);h.left?t.left+=h.left:t.top+=h.top;var d=/top|bottom/.test(e),p=d?2*h.left-o+a:2*h.top-n+l,c=d?"offsetWidth":"offsetHeight";i.offset(t),this.replaceArrow(p,i[0][c],d)},m.prototype.replaceArrow=function(t,e,i){this.arrow().css(i?"left":"top",50*(1-t/e)+"%").css(i?"top":"left","")},m.prototype.setContent=function(){var t=this.tip(),e=this.getTitle();t.find(".tooltip-inner")[this.options.html?"html":"text"](e),t.removeClass("fade in top bottom left right")},m.prototype.hide=function(t){var e=this,i=g(this.$tip),o=g.Event("hide.bs."+this.type);function complete(){"in"!=e.hoverState&&i.detach(),e.$element&&e.$element.removeAttr("aria-describedby").trigger("hidden.bs."+e.type),t&&t()}if(this.$element.trigger(o),!o.isDefaultPrevented())return i.removeClass("in"),g.support.transition&&i.hasClass("fade")?i.one("bsTransitionEnd",complete).emulateTransitionEnd(m.TRANSITION_DURATION):complete(),this.hoverState=null,this},m.prototype.fixTitle=function(){var t=this.$element;(t.attr("title")||"string"!=typeof t.attr("data-original-title"))&&t.attr("data-original-title",t.attr("title")||"").attr("title","")},m.prototype.hasContent=function(){return this.getTitle()},m.prototype.getPosition=function(t){var e=(t=t||this.$element)[0],i="BODY"==e.tagName,o=e.getBoundingClientRect();null==o.width&&(o=g.extend({},o,{width:o.right-o.left,height:o.bottom-o.top}));var n=window.SVGElement&&e instanceof window.SVGElement,s=i?{top:0,left:0}:n?null:t.offset(),r={scroll:i?document.documentElement.scrollTop||document.body.scrollTop:t.scrollTop()},a=i?{width:g(window).width(),height:g(window).height()}:null;return g.extend({},o,r,a,s)},m.prototype.getCalculatedOffset=function(t,e,i,o){return"bottom"==t?{top:e.top+e.height,left:e.left+e.width/2-i/2}:"top"==t?{top:e.top-o,left:e.left+e.width/2-i/2}:"left"==t?{top:e.top+e.height/2-o/2,left:e.left-i}:{top:e.top+e.height/2-o/2,left:e.left+e.width}},m.prototype.getViewportAdjustedDelta=function(t,e,i,o){var n={top:0,left:0};if(!this.$viewport)return n;var s=this.options.viewport&&this.options.viewport.padding||0,r=this.getPosition(this.$viewport);if(/right|left/.test(t)){var a=e.top-s-r.scroll,l=e.top+s-r.scroll+o;a<r.top?n.top=r.top-a:l>r.top+r.height&&(n.top=r.top+r.height-l)}else{var h=e.left-s,d=e.left+s+i;h<r.left?n.left=r.left-h:d>r.right&&(n.left=r.left+r.width-d)}return n},m.prototype.getTitle=function(){var t=this.$element,e=this.options;return t.attr("data-original-title")||("function"==typeof e.title?e.title.call(t[0]):e.title)},m.prototype.getUID=function(t){for(;t+=~~(1e6*Math.random()),document.getElementById(t););return t},m.prototype.tip=function(){if(!this.$tip&&(this.$tip=g(this.options.template),1!=this.$tip.length))throw new Error(this.type+" `template` option must consist of exactly 1 top-level element!");return this.$tip},m.prototype.arrow=function(){return this.$arrow=this.$arrow||this.tip().find(".tooltip-arrow")},m.prototype.enable=function(){this.enabled=!0},m.prototype.disable=function(){this.enabled=!1},m.prototype.toggleEnabled=function(){this.enabled=!this.enabled},m.prototype.toggle=function(t){var e=this;t&&((e=g(t.currentTarget).data("bs."+this.type))||(e=new this.constructor(t.currentTarget,this.getDelegateOptions()),g(t.currentTarget).data("bs."+this.type,e))),t?(e.inState.click=!e.inState.click,e.isInStateTrue()?e.enter(e):e.leave(e)):e.tip().hasClass("in")?e.leave(e):e.enter(e)},m.prototype.destroy=function(){var t=this;clearTimeout(this.timeout),this.hide(function(){t.$element.off("."+t.type).removeData("bs."+t.type),t.$tip&&t.$tip.detach(),t.$tip=null,t.$arrow=null,t.$viewport=null,t.$element=null})};var t=g.fn.tooltip;g.fn.tooltip=function Plugin(o){return this.each(function(){var t=g(this),e=t.data("bs.tooltip"),i="object"==typeof o&&o;!e&&/destroy|hide/.test(o)||(e||t.data("bs.tooltip",e=new m(this,i)),"string"==typeof o&&e[o]())})},g.fn.tooltip.Constructor=m,g.fn.tooltip.noConflict=function(){return g.fn.tooltip=t,this}}(jQuery),function(n){"use strict";var s=function(t,e){this.init("popover",t,e)};if(!n.fn.tooltip)throw new Error("Popover requires tooltip.js");s.VERSION="3.3.7",s.DEFAULTS=n.extend({},n.fn.tooltip.Constructor.DEFAULTS,{placement:"right",trigger:"click",content:"",template:'<div class="popover" role="tooltip"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>'}),((s.prototype=n.extend({},n.fn.tooltip.Constructor.prototype)).constructor=s).prototype.getDefaults=function(){return s.DEFAULTS},s.prototype.setContent=function(){var t=this.tip(),e=this.getTitle(),i=this.getContent();t.find(".popover-title")[this.options.html?"html":"text"](e),t.find(".popover-content").children().detach().end()[this.options.html?"string"==typeof i?"html":"append":"text"](i),t.removeClass("fade top bottom left right in"),t.find(".popover-title").html()||t.find(".popover-title").hide()},s.prototype.hasContent=function(){return this.getTitle()||this.getContent()},s.prototype.getContent=function(){var t=this.$element,e=this.options;return t.attr("data-content")||("function"==typeof e.content?e.content.call(t[0]):e.content)},s.prototype.arrow=function(){return this.$arrow=this.$arrow||this.tip().find(".arrow")};var t=n.fn.popover;n.fn.popover=function Plugin(o){return this.each(function(){var t=n(this),e=t.data("bs.popover"),i="object"==typeof o&&o;!e&&/destroy|hide/.test(o)||(e||t.data("bs.popover",e=new s(this,i)),"string"==typeof o&&e[o]())})},n.fn.popover.Constructor=s,n.fn.popover.noConflict=function(){return n.fn.popover=t,this}}(jQuery),function(s){"use strict";function ScrollSpy(t,e){this.$body=s(document.body),this.$scrollElement=s(t).is(document.body)?s(window):s(t),this.options=s.extend({},ScrollSpy.DEFAULTS,e),this.selector=(this.options.target||"")+" .nav li > a",this.offsets=[],this.targets=[],this.activeTarget=null,this.scrollHeight=0,this.$scrollElement.on("scroll.bs.scrollspy",s.proxy(this.process,this)),this.refresh(),this.process()}function Plugin(o){return this.each(function(){var t=s(this),e=t.data("bs.scrollspy"),i="object"==typeof o&&o;e||t.data("bs.scrollspy",e=new ScrollSpy(this,i)),"string"==typeof o&&e[o]()})}ScrollSpy.VERSION="3.3.7",ScrollSpy.DEFAULTS={offset:10},ScrollSpy.prototype.getScrollHeight=function(){return this.$scrollElement[0].scrollHeight||Math.max(this.$body[0].scrollHeight,document.documentElement.scrollHeight)},ScrollSpy.prototype.refresh=function(){var t=this,o="offset",n=0;this.offsets=[],this.targets=[],this.scrollHeight=this.getScrollHeight(),s.isWindow(this.$scrollElement[0])||(o="position",n=this.$scrollElement.scrollTop()),this.$body.find(this.selector).map(function(){var t=s(this),e=t.data("target")||t.attr("href"),i=/^#./.test(e)&&s(e);return i&&i.length&&i.is(":visible")&&[[i[o]().top+n,e]]||null}).sort(function(t,e){return t[0]-e[0]}).each(function(){t.offsets.push(this[0]),t.targets.push(this[1])})},ScrollSpy.prototype.process=function(){var t,e=this.$scrollElement.scrollTop()+this.options.offset,i=this.getScrollHeight(),o=this.options.offset+i-this.$scrollElement.height(),n=this.offsets,s=this.targets,r=this.activeTarget;if(this.scrollHeight!=i&&this.refresh(),o<=e)return r!=(t=s[s.length-1])&&this.activate(t);if(r&&e<n[0])return this.activeTarget=null,this.clear();for(t=n.length;t--;)r!=s[t]&&e>=n[t]&&(void 0===n[t+1]||e<n[t+1])&&this.activate(s[t])},ScrollSpy.prototype.activate=function(t){this.activeTarget=t,this.clear();var e=this.selector+'[data-target="'+t+'"],'+this.selector+'[href="'+t+'"]',i=s(e).parents("li").addClass("active");i.parent(".dropdown-menu").length&&(i=i.closest("li.dropdown").addClass("active")),i.trigger("activate.bs.scrollspy")},ScrollSpy.prototype.clear=function(){s(this.selector).parentsUntil(this.options.target,".active").removeClass("active")};var t=s.fn.scrollspy;s.fn.scrollspy=Plugin,s.fn.scrollspy.Constructor=ScrollSpy,s.fn.scrollspy.noConflict=function(){return s.fn.scrollspy=t,this},s(window).on("load.bs.scrollspy.data-api",function(){s('[data-spy="scroll"]').each(function(){var t=s(this);Plugin.call(t,t.data())})})}(jQuery),function(a){"use strict";var s=function(t){this.element=a(t)};function Plugin(i){return this.each(function(){var t=a(this),e=t.data("bs.tab");e||t.data("bs.tab",e=new s(this)),"string"==typeof i&&e[i]()})}s.VERSION="3.3.7",s.TRANSITION_DURATION=150,s.prototype.show=function(){var t=this.element,e=t.closest("ul:not(.dropdown-menu)"),i=t.data("target");if(i||(i=(i=t.attr("href"))&&i.replace(/.*(?=#[^\s]*$)/,"")),!t.parent("li").hasClass("active")){var o=e.find(".active:last a"),n=a.Event("hide.bs.tab",{relatedTarget:t[0]}),s=a.Event("show.bs.tab",{relatedTarget:o[0]});if(o.trigger(n),t.trigger(s),!s.isDefaultPrevented()&&!n.isDefaultPrevented()){var r=a(i);this.activate(t.closest("li"),e),this.activate(r,r.parent(),function(){o.trigger({type:"hidden.bs.tab",relatedTarget:t[0]}),t.trigger({type:"shown.bs.tab",relatedTarget:o[0]})})}}},s.prototype.activate=function(t,e,i){var o=e.find("> .active"),n=i&&a.support.transition&&(o.length&&o.hasClass("fade")||!!e.find("> .fade").length);function next(){o.removeClass("active").find("> .dropdown-menu > .active").removeClass("active").end().find('[data-toggle="tab"]').attr("aria-expanded",!1),t.addClass("active").find('[data-toggle="tab"]').attr("aria-expanded",!0),n?(t[0].offsetWidth,t.addClass("in")):t.removeClass("fade"),t.parent(".dropdown-menu").length&&t.closest("li.dropdown").addClass("active").end().find('[data-toggle="tab"]').attr("aria-expanded",!0),i&&i()}o.length&&n?o.one("bsTransitionEnd",next).emulateTransitionEnd(s.TRANSITION_DURATION):next(),o.removeClass("in")};var t=a.fn.tab;a.fn.tab=Plugin,a.fn.tab.Constructor=s,a.fn.tab.noConflict=function(){return a.fn.tab=t,this};var e=function(t){t.preventDefault(),Plugin.call(a(this),"show")};a(document).on("click.bs.tab.data-api",'[data-toggle="tab"]',e).on("click.bs.tab.data-api",'[data-toggle="pill"]',e)}(jQuery),function(l){"use strict";var h=function(t,e){this.options=l.extend({},h.DEFAULTS,e),this.$target=l(this.options.target).on("scroll.bs.affix.data-api",l.proxy(this.checkPosition,this)).on("click.bs.affix.data-api",l.proxy(this.checkPositionWithEventLoop,this)),this.$element=l(t),this.affixed=null,this.unpin=null,this.pinnedOffset=null,this.checkPosition()};function Plugin(o){return this.each(function(){var t=l(this),e=t.data("bs.affix"),i="object"==typeof o&&o;e||t.data("bs.affix",e=new h(this,i)),"string"==typeof o&&e[o]()})}h.VERSION="3.3.7",h.RESET="affix affix-top affix-bottom",h.DEFAULTS={offset:0,target:window},h.prototype.getState=function(t,e,i,o){var n=this.$target.scrollTop(),s=this.$element.offset(),r=this.$target.height();if(null!=i&&"top"==this.affixed)return n<i&&"top";if("bottom"==this.affixed)return null!=i?!(n+this.unpin<=s.top)&&"bottom":!(n+r<=t-o)&&"bottom";var a=null==this.affixed,l=a?n:s.top;return null!=i&&n<=i?"top":null!=o&&t-o<=l+(a?r:e)&&"bottom"},h.prototype.getPinnedOffset=function(){if(this.pinnedOffset)return this.pinnedOffset;this.$element.removeClass(h.RESET).addClass("affix");var t=this.$target.scrollTop(),e=this.$element.offset();return this.pinnedOffset=e.top-t},h.prototype.checkPositionWithEventLoop=function(){setTimeout(l.proxy(this.checkPosition,this),1)},h.prototype.checkPosition=function(){if(this.$element.is(":visible")){var t=this.$element.height(),e=this.options.offset,i=e.top,o=e.bottom,n=Math.max(l(document).height(),l(document.body).height());"object"!=typeof e&&(o=i=e),"function"==typeof i&&(i=e.top(this.$element)),"function"==typeof o&&(o=e.bottom(this.$element));var s=this.getState(n,t,i,o);if(this.affixed!=s){null!=this.unpin&&this.$element.css("top","");var r="affix"+(s?"-"+s:""),a=l.Event(r+".bs.affix");if(this.$element.trigger(a),a.isDefaultPrevented())return;this.affixed=s,this.unpin="bottom"==s?this.getPinnedOffset():null,this.$element.removeClass(h.RESET).addClass(r).trigger(r.replace("affix","affixed")+".bs.affix")}"bottom"==s&&this.$element.offset({top:n-t-o})}};var t=l.fn.affix;l.fn.affix=Plugin,l.fn.affix.Constructor=h,l.fn.affix.noConflict=function(){return l.fn.affix=t,this},l(window).on("load",function(){l('[data-spy="affix"]').each(function(){var t=l(this),e=t.data();e.offset=e.offset||{},null!=e.offsetBottom&&(e.offset.bottom=e.offsetBottom),null!=e.offsetTop&&(e.offset.top=e.offsetTop),Plugin.call(t,e)})})}(jQuery);
!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):"object"==typeof exports?t(require("jquery")):t(jQuery)}(function(c){var n={element:"body",position:null,type:"info",allow_dismiss:!0,allow_duplicates:!0,newest_on_top:!1,showProgressbar:!1,placement:{from:"top",align:"right"},offset:20,spacing:10,z_index:1031,delay:5e3,timer:1e3,url_target:"_blank",mouse_over:null,animate:{enter:"animated fadeInDown",exit:"animated fadeOutUp"},onShow:null,onShown:null,onClose:null,onClosed:null,onClick:null,icon_type:"class",template:'<div data-notify="container" class="col-xs-11 col-sm-4 alert alert-{0}" role="alert"><button type="button" aria-hidden="true" class="close" data-notify="dismiss">&times;</button><span data-notify="icon"></span> <span data-notify="title">{1}</span> <span data-notify="message">{2}</span><div class="progress" data-notify="progressbar"><div class="progress-bar progress-bar-{0}" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div></div><a href="{3}" target="{4}" data-notify="url"></a></div>'};function Notify(t,i,s){var e={content:{message:"object"==typeof i?i.message:i,title:i.title?i.title:"",icon:i.icon?i.icon:"",url:i.url?i.url:"#",target:i.target?i.target:"-"}};s=c.extend(!0,{},e,s),this.settings=c.extend(!0,{},n,s),this._defaults=n,"-"===this.settings.content.target&&(this.settings.content.target=this.settings.url_target),this.animations={start:"webkitAnimationStart oanimationstart MSAnimationStart animationstart",end:"webkitAnimationEnd oanimationend MSAnimationEnd animationend"},"number"==typeof this.settings.offset&&(this.settings.offset={x:this.settings.offset,y:this.settings.offset}),(this.settings.allow_duplicates||!this.settings.allow_duplicates&&!function isDuplicateNotification(l){var d=!1;return c('[data-notify="container"]').each(function(t,i){var s=c(i),e=s.find('[data-notify="title"]').html().trim(),n=s.find('[data-notify="message"]').html().trim(),a=e===c("<div>"+l.settings.content.title+"</div>").html().trim(),o=n===c("<div>"+l.settings.content.message+"</div>").html().trim(),r=s.hasClass("alert-"+l.settings.type);return a&&o&&r&&(d=!0),!d}),d}(this))&&this.init()}String.format=function(){var s=arguments;return arguments[0].replace(/(\{\{\d\}\}|\{\d\})/g,function(t){if("{{"===t.substring(0,2))return t;var i=parseInt(t.match(/\d/)[0]);return s[i+1]})},c.extend(Notify.prototype,{init:function(){var r=this;this.buildNotify(),this.settings.content.icon&&this.setIcon(),"#"!=this.settings.content.url&&this.styleURL(),this.styleDismiss(),this.placement(),this.bind(),this.notify={$ele:this.$ele,update:function(t,i){var s={};for(var e in"string"==typeof t?s[t]=i:s=t,s)switch(e){case"type":this.$ele.removeClass("alert-"+r.settings.type),this.$ele.find('[data-notify="progressbar"] > .progress-bar').removeClass("progress-bar-"+r.settings.type),r.settings.type=s[e],this.$ele.addClass("alert-"+s[e]).find('[data-notify="progressbar"] > .progress-bar').addClass("progress-bar-"+s[e]);break;case"icon":var n=this.$ele.find('[data-notify="icon"]');"class"===r.settings.icon_type.toLowerCase()?n.removeClass(r.settings.content.icon).addClass(s[e]):(n.is("img")||n.find("img"),n.attr("src",s[e])),r.settings.content.icon=s[t];break;case"progress":var a=r.settings.delay-r.settings.delay*(s[e]/100);this.$ele.data("notify-delay",a),this.$ele.find('[data-notify="progressbar"] > div').attr("aria-valuenow",s[e]).css("width",s[e]+"%");break;case"url":this.$ele.find('[data-notify="url"]').attr("href",s[e]);break;case"target":this.$ele.find('[data-notify="url"]').attr("target",s[e]);break;default:this.$ele.find('[data-notify="'+e+'"]').html(s[e])}var o=this.$ele.outerHeight()+parseInt(r.settings.spacing)+parseInt(r.settings.offset.y);r.reposition(o)},close:function(){r.close()}}},buildNotify:function(){var t=this.settings.content;this.$ele=c(String.format(this.settings.template,this.settings.type,t.title,t.message,t.url,t.target)),this.$ele.attr("data-notify-position",this.settings.placement.from+"-"+this.settings.placement.align),this.settings.allow_dismiss||this.$ele.find('[data-notify="dismiss"]').css("display","none"),(this.settings.delay<=0&&!this.settings.showProgressbar||!this.settings.showProgressbar)&&this.$ele.find('[data-notify="progressbar"]').remove()},setIcon:function(){"class"===this.settings.icon_type.toLowerCase()?this.$ele.find('[data-notify="icon"]').addClass(this.settings.content.icon):this.$ele.find('[data-notify="icon"]').is("img")?this.$ele.find('[data-notify="icon"]').attr("src",this.settings.content.icon):this.$ele.find('[data-notify="icon"]').append('<img src="'+this.settings.content.icon+'" alt="Notify Icon" />')},styleDismiss:function(){this.$ele.find('[data-notify="dismiss"]').css({position:"absolute",right:"10px",top:"5px",zIndex:this.settings.z_index+2})},styleURL:function(){this.$ele.find('[data-notify="url"]').css({backgroundImage:"url(data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7)",height:"100%",left:0,position:"absolute",top:0,width:"100%",zIndex:this.settings.z_index+1})},placement:function(){var s=this,t=this.settings.offset.y,i={display:"inline-block",margin:"0px auto",position:this.settings.position?this.settings.position:"body"===this.settings.element?"fixed":"absolute",transition:"all .5s ease-in-out",zIndex:this.settings.z_index},e=!1,n=this.settings;switch(c('[data-notify-position="'+this.settings.placement.from+"-"+this.settings.placement.align+'"]:not([data-closing="true"])').each(function(){t=Math.max(t,parseInt(c(this).css(n.placement.from))+parseInt(c(this).outerHeight())+parseInt(n.spacing))}),!0===this.settings.newest_on_top&&(t=this.settings.offset.y),i[this.settings.placement.from]=t+"px",this.settings.placement.align){case"left":case"right":i[this.settings.placement.align]=this.settings.offset.x+"px";break;case"center":i.left=0,i.right=0}this.$ele.css(i).addClass(this.settings.animate.enter),c.each(Array("webkit-","moz-","o-","ms-",""),function(t,i){s.$ele[0].style[i+"AnimationIterationCount"]=1}),c(this.settings.element).append(this.$ele),!0===this.settings.newest_on_top&&(t=parseInt(t)+parseInt(this.settings.spacing)+this.$ele.outerHeight(),this.reposition(t)),c.isFunction(s.settings.onShow)&&s.settings.onShow.call(this.$ele),this.$ele.one(this.animations.start,function(){e=!0}).one(this.animations.end,function(){s.$ele.removeClass(s.settings.animate.enter),c.isFunction(s.settings.onShown)&&s.settings.onShown.call(this)}),setTimeout(function(){e||c.isFunction(s.settings.onShown)&&s.settings.onShown.call(this)},600)},bind:function(){var s=this;if(this.$ele.find('[data-notify="dismiss"]').on("click",function(){s.close()}),c.isFunction(s.settings.onClick)&&this.$ele.on("click",function(t){t.target!=s.$ele.find('[data-notify="dismiss"]')[0]&&s.settings.onClick.call(this,t)}),this.$ele.mouseover(function(){c(this).data("data-hover","true")}).mouseout(function(){c(this).data("data-hover","false")}),this.$ele.data("data-hover","false"),0<this.settings.delay){s.$ele.data("notify-delay",s.settings.delay);var e=setInterval(function(){var t=parseInt(s.$ele.data("notify-delay"))-s.settings.timer;if("false"===s.$ele.data("data-hover")&&"pause"===s.settings.mouse_over||"pause"!=s.settings.mouse_over){var i=(s.settings.delay-t)/s.settings.delay*100;s.$ele.data("notify-delay",t),s.$ele.find('[data-notify="progressbar"] > div').attr("aria-valuenow",i).css("width",i+"%")}t<=-s.settings.timer&&(clearInterval(e),s.close())},s.settings.timer)}},close:function(){var t=this,i=parseInt(this.$ele.css(this.settings.placement.from)),s=!1;this.$ele.attr("data-closing","true").addClass(this.settings.animate.exit),t.reposition(i),c.isFunction(t.settings.onClose)&&t.settings.onClose.call(this.$ele),this.$ele.one(this.animations.start,function(){s=!0}).one(this.animations.end,function(){c(this).remove(),c.isFunction(t.settings.onClosed)&&t.settings.onClosed.call(this)}),setTimeout(function(){s||(t.$ele.remove(),c.isFunction(t.settings.onClosed)&&t.settings.onClosed.call(this))},600)},reposition:function(t){var i=this,s='[data-notify-position="'+this.settings.placement.from+"-"+this.settings.placement.align+'"]:not([data-closing="true"])',e=this.$ele.nextAll(s);!0===this.settings.newest_on_top&&(e=this.$ele.prevAll(s)),e.each(function(){c(this).css(i.settings.placement.from,t),t=parseInt(t)+parseInt(i.settings.spacing)+c(this).outerHeight()})}}),c.notify=function(t,i){return new Notify(this,t,i).notify},c.notifyDefaults=function(t){return n=c.extend(!0,{},n,t)},c.notifyClose=function(t){void 0===t||"all"===t?c("[data-notify]").find('[data-notify="dismiss"]').trigger("click"):"success"===t||"info"===t||"warning"===t||"danger"===t?c(".alert-"+t+"[data-notify]").find('[data-notify="dismiss"]').trigger("click"):t?c(t+"[data-notify]").find('[data-notify="dismiss"]').trigger("click"):c('[data-notify-position="'+t+'"]').find('[data-notify="dismiss"]').trigger("click")},c.notifyCloseExcept=function(t){"success"===t||"info"===t||"warning"===t||"danger"===t?c("[data-notify]").not(".alert-"+t).find('[data-notify="dismiss"]').trigger("click"):c("[data-notify]").not(t).find('[data-notify="dismiss"]').trigger("click")}});
"use strict";function _typeof(t){return t&&"undefined"!=typeof Symbol&&t.constructor===Symbol?"symbol":typeof t}!function(t){if("function"==typeof define&&define.amd)define(["jquery"],t);else if("object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports){var i;try{i=require("jquery")}catch(t){i=null}module.exports=t(i)}else window&&(window.Slider=t(window.jQuery))}(function(t){var i;return function(t){var c=Array.prototype.slice;function noop(){}!function defineBridget(p){if(p){var d="undefined"==typeof console?noop:function(t){console.error(t)};return p.bridget=function(t,i){!function addOptionMethod(t){t.prototype.option||(t.prototype.option=function(t){p.isPlainObject(t)&&(this.options=p.extend(!0,this.options,t))})}(i),function bridge(l,r){p.fn[l]=function(i){if("string"==typeof i){for(var t=c.call(arguments,1),e=0,s=this.length;e<s;e++){var o=this[e],n=p.data(o,l);if(n)if(p.isFunction(n[i])&&"_"!==i.charAt(0)){var a=n[i].apply(n,t);if(void 0!==a&&a!==n)return a}else d("no such method '"+i+"' for "+l+" instance");else d("cannot call methods on "+l+" prior to initialization; attempted to call '"+i+"'")}return this}var h=this.map(function(){var t=p.data(this,l);return t?(t.option(i),t._init()):(t=new r(this,i),p.data(this,l,t)),p(this)});return!h||1<h.length?h:h[0]}}(t,i)},p.bridget}}(t)}(t),function(C){var s=function formatInvalidInputErrorMsg(t){return"Invalid input value '"+t+"' passed in"},w={linear:{toValue:function toValue(t){var i=t/100*(this.options.max-this.options.min),e=!0;if(0<this.options.ticks_positions.length){for(var s,o,n,a=0,h=1;h<this.options.ticks_positions.length;h++)if(t<=this.options.ticks_positions[h]){s=this.options.ticks[h-1],n=this.options.ticks_positions[h-1],o=this.options.ticks[h],a=this.options.ticks_positions[h];break}i=s+(t-n)/(a-n)*(o-s),e=!1}var l=(e?this.options.min:0)+Math.round(i/this.options.step)*this.options.step;return l<this.options.min?this.options.min:l>this.options.max?this.options.max:l},toPercentage:function toPercentage(t){if(this.options.max===this.options.min)return 0;if(0<this.options.ticks_positions.length){for(var i,e,s,o=0,n=0;n<this.options.ticks.length;n++)if(t<=this.options.ticks[n]){i=0<n?this.options.ticks[n-1]:0,s=0<n?this.options.ticks_positions[n-1]:0,e=this.options.ticks[n],o=this.options.ticks_positions[n];break}if(0<n)return s+(t-i)/(e-i)*(o-s)}return 100*(t-this.options.min)/(this.options.max-this.options.min)}},logarithmic:{toValue:function toValue(t){var i=0===this.options.min?0:Math.log(this.options.min),e=Math.log(this.options.max),s=Math.exp(i+(e-i)*t/100);return(s=this.options.min+Math.round((s-this.options.min)/this.options.step)*this.options.step)<this.options.min?this.options.min:s>this.options.max?this.options.max:s},toPercentage:function toPercentage(t){if(this.options.max===this.options.min)return 0;var i=Math.log(this.options.max),e=0===this.options.min?0:Math.log(this.options.min);return 100*((0===t?0:Math.log(t))-e)/(i-e)}}};function createNewSlider(t,i){this._state={value:null,enabled:null,offset:null,size:null,percentage:null,inDrag:!1,over:!1},"string"==typeof t?this.element=document.querySelector(t):t instanceof HTMLElement&&(this.element=t),i=i||{};for(var e=Object.keys(this.defaultOptions),s=0;s<e.length;s++){var o=e[s],n=i[o];n=null!==(n=void 0!==n?n:getDataAttrib(this.element,o))?n:this.defaultOptions[o],this.options||(this.options={}),this.options[o]=n}function getDataAttrib(t,i){var e="data-slider-"+i.replace(/_/g,"-"),s=t.getAttribute(e);try{return JSON.parse(s)}catch(t){return s}}"vertical"!==this.options.orientation||"top"!==this.options.tooltip_position&&"bottom"!==this.options.tooltip_position?"horizontal"!==this.options.orientation||"left"!==this.options.tooltip_position&&"right"!==this.options.tooltip_position||(this.options.tooltip_position="top"):this.options.tooltip_position="right";var a,h,l,r,p,d=this.element.style.width,c=!1,u=this.element.parentNode;if(this.sliderElem)c=!0;else{this.sliderElem=document.createElement("div"),this.sliderElem.className="slider";var m=document.createElement("div");m.className="slider-track",(h=document.createElement("div")).className="slider-track-low",(a=document.createElement("div")).className="slider-selection",(l=document.createElement("div")).className="slider-track-high",(r=document.createElement("div")).className="slider-handle min-slider-handle",r.setAttribute("role","slider"),r.setAttribute("aria-valuemin",this.options.min),r.setAttribute("aria-valuemax",this.options.max),(p=document.createElement("div")).className="slider-handle max-slider-handle",p.setAttribute("role","slider"),p.setAttribute("aria-valuemin",this.options.min),p.setAttribute("aria-valuemax",this.options.max),m.appendChild(h),m.appendChild(a),m.appendChild(l);var _=Array.isArray(this.options.labelledby);if(_&&this.options.labelledby[0]&&r.setAttribute("aria-labelledby",this.options.labelledby[0]),_&&this.options.labelledby[1]&&p.setAttribute("aria-labelledby",this.options.labelledby[1]),!_&&this.options.labelledby&&(r.setAttribute("aria-labelledby",this.options.labelledby),p.setAttribute("aria-labelledby",this.options.labelledby)),this.ticks=[],Array.isArray(this.options.ticks)&&0<this.options.ticks.length){for(s=0;s<this.options.ticks.length;s++){var v=document.createElement("div");v.className="slider-tick",this.ticks.push(v),m.appendChild(v)}a.className+=" tick-slider-selection"}if(m.appendChild(r),m.appendChild(p),this.tickLabels=[],Array.isArray(this.options.ticks_labels)&&0<this.options.ticks_labels.length)for(this.tickLabelContainer=document.createElement("div"),this.tickLabelContainer.className="slider-tick-label-container",s=0;s<this.options.ticks_labels.length;s++){var f=document.createElement("div"),g=0===this.options.ticks_positions.length,y=this.options.reversed&&g?this.options.ticks_labels.length-(s+1):s;f.className="slider-tick-label",f.innerHTML=this.options.ticks_labels[y],this.tickLabels.push(f),this.tickLabelContainer.appendChild(f)}var b=function createAndAppendTooltipSubElements(t){var i=document.createElement("div");i.className="tooltip-arrow";var e=document.createElement("div");e.className="tooltip-inner",t.appendChild(i),t.appendChild(e)},E=document.createElement("div");E.className="tooltip tooltip-main",E.setAttribute("role","presentation"),b(E);var k=document.createElement("div");k.className="tooltip tooltip-min",k.setAttribute("role","presentation"),b(k);var x=document.createElement("div");x.className="tooltip tooltip-max",x.setAttribute("role","presentation"),b(x),this.sliderElem.appendChild(m),this.sliderElem.appendChild(E),this.sliderElem.appendChild(k),this.sliderElem.appendChild(x),this.tickLabelContainer&&this.sliderElem.appendChild(this.tickLabelContainer),u.insertBefore(this.sliderElem,this.element),this.element.style.display="none"}if(C&&(this.$element=C(this.element),this.$sliderElem=C(this.sliderElem)),this.eventToCallbackMap={},this.sliderElem.id=this.options.id,this.touchCapable="ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch,this.tooltip=this.sliderElem.querySelector(".tooltip-main"),this.tooltipInner=this.tooltip.querySelector(".tooltip-inner"),this.tooltip_min=this.sliderElem.querySelector(".tooltip-min"),this.tooltipInner_min=this.tooltip_min.querySelector(".tooltip-inner"),this.tooltip_max=this.sliderElem.querySelector(".tooltip-max"),this.tooltipInner_max=this.tooltip_max.querySelector(".tooltip-inner"),w[this.options.scale]&&(this.options.scale=w[this.options.scale]),!0===c&&(this._removeClass(this.sliderElem,"slider-horizontal"),this._removeClass(this.sliderElem,"slider-vertical"),this._removeClass(this.tooltip,"hide"),this._removeClass(this.tooltip_min,"hide"),this._removeClass(this.tooltip_max,"hide"),["left","top","width","height"].forEach(function(t){this._removeProperty(this.trackLow,t),this._removeProperty(this.trackSelection,t),this._removeProperty(this.trackHigh,t)},this),[this.handle1,this.handle2].forEach(function(t){this._removeProperty(t,"left"),this._removeProperty(t,"top")},this),[this.tooltip,this.tooltip_min,this.tooltip_max].forEach(function(t){this._removeProperty(t,"left"),this._removeProperty(t,"top"),this._removeProperty(t,"margin-left"),this._removeProperty(t,"margin-top"),this._removeClass(t,"right"),this._removeClass(t,"top")},this)),"vertical"===this.options.orientation?(this._addClass(this.sliderElem,"slider-vertical"),this.stylePos="top",this.mousePos="pageY",this.sizePos="offsetHeight"):(this._addClass(this.sliderElem,"slider-horizontal"),this.sliderElem.style.width=d,this.options.orientation="horizontal",this.stylePos="left",this.mousePos="pageX",this.sizePos="offsetWidth"),this._setTooltipPosition(),Array.isArray(this.options.ticks)&&0<this.options.ticks.length&&(this.options.max=Math.max.apply(Math,this.options.ticks),this.options.min=Math.min.apply(Math,this.options.ticks)),Array.isArray(this.options.value)?(this.options.range=!0,this._state.value=this.options.value):this.options.range?this._state.value=[this.options.value,this.options.max]:this._state.value=this.options.value,this.trackLow=h||this.trackLow,this.trackSelection=a||this.trackSelection,this.trackHigh=l||this.trackHigh,"none"===this.options.selection&&(this._addClass(this.trackLow,"hide"),this._addClass(this.trackSelection,"hide"),this._addClass(this.trackHigh,"hide")),this.handle1=r||this.handle1,this.handle2=p||this.handle2,!0===c)for(this._removeClass(this.handle1,"round triangle"),this._removeClass(this.handle2,"round triangle hide"),s=0;s<this.ticks.length;s++)this._removeClass(this.ticks[s],"round triangle hide");if(-1!==["round","triangle","custom"].indexOf(this.options.handle))for(this._addClass(this.handle1,this.options.handle),this._addClass(this.handle2,this.options.handle),s=0;s<this.ticks.length;s++)this._addClass(this.ticks[s],this.options.handle);this._state.offset=this._offset(this.sliderElem),this._state.size=this.sliderElem[this.sizePos],this.setValue(this._state.value),this.handle1Keydown=this._keydown.bind(this,0),this.handle1.addEventListener("keydown",this.handle1Keydown,!1),this.handle2Keydown=this._keydown.bind(this,1),this.handle2.addEventListener("keydown",this.handle2Keydown,!1),this.mousedown=this._mousedown.bind(this),this.touchCapable&&this.sliderElem.addEventListener("touchstart",this.mousedown,!1),this.sliderElem.addEventListener("mousedown",this.mousedown,!1),this.resize=this._resize.bind(this),window.addEventListener("resize",this.resize,!1),"hide"===this.options.tooltip?(this._addClass(this.tooltip,"hide"),this._addClass(this.tooltip_min,"hide"),this._addClass(this.tooltip_max,"hide")):"always"===this.options.tooltip?(this._showTooltip(),this._alwaysShowTooltip=!0):(this.showTooltip=this._showTooltip.bind(this),this.hideTooltip=this._hideTooltip.bind(this),this.sliderElem.addEventListener("mouseenter",this.showTooltip,!1),this.sliderElem.addEventListener("mouseleave",this.hideTooltip,!1),this.handle1.addEventListener("focus",this.showTooltip,!1),this.handle1.addEventListener("blur",this.hideTooltip,!1),this.handle2.addEventListener("focus",this.showTooltip,!1),this.handle2.addEventListener("blur",this.hideTooltip,!1)),this.options.enabled?this.enable():this.disable()}if((i=function(t,i){return createNewSlider.call(this,t,i),this}).prototype={_init:function _init(){},constructor:i,defaultOptions:{id:"",min:0,max:10,step:1,precision:0,orientation:"horizontal",value:5,range:!1,selection:"before",tooltip:"show",tooltip_split:!1,handle:"round",reversed:!1,enabled:!0,formatter:function formatter(t){return Array.isArray(t)?t[0]+" : "+t[1]:t},natural_arrow_keys:!1,ticks:[],ticks_positions:[],ticks_labels:[],ticks_snap_bounds:0,scale:"linear",focus:!1,tooltip_position:null,labelledby:null},getElement:function getElement(){return this.sliderElem},getValue:function getValue(){return this.options.range?this._state.value:this._state.value[0]},setValue:function setValue(t,i,e){t||(t=0);var s=this.getValue();this._state.value=this._validateInputValue(t);var o=this._applyPrecision.bind(this);this.options.range?(this._state.value[0]=o(this._state.value[0]),this._state.value[1]=o(this._state.value[1]),this._state.value[0]=Math.max(this.options.min,Math.min(this.options.max,this._state.value[0])),this._state.value[1]=Math.max(this.options.min,Math.min(this.options.max,this._state.value[1]))):(this._state.value=o(this._state.value),this._state.value=[Math.max(this.options.min,Math.min(this.options.max,this._state.value))],this._addClass(this.handle2,"hide"),"after"===this.options.selection?this._state.value[1]=this.options.max:this._state.value[1]=this.options.min),this.options.max>this.options.min?this._state.percentage=[this._toPercentage(this._state.value[0]),this._toPercentage(this._state.value[1]),100*this.options.step/(this.options.max-this.options.min)]:this._state.percentage=[0,0,100],this._layout();var n=this.options.range?this._state.value:this._state.value[0];return this._setDataVal(n),!0===i&&this._trigger("slide",n),s!==n&&!0===e&&this._trigger("change",{oldValue:s,newValue:n}),this},destroy:function destroy(){this._removeSliderEventHandlers(),this.sliderElem.parentNode.removeChild(this.sliderElem),this.element.style.display="",this._cleanUpEventCallbacksMap(),this.element.removeAttribute("data"),C&&(this._unbindJQueryEventHandlers(),this.$element.removeData("slider"))},disable:function disable(){return this._state.enabled=!1,this.handle1.removeAttribute("tabindex"),this.handle2.removeAttribute("tabindex"),this._addClass(this.sliderElem,"slider-disabled"),this._trigger("slideDisabled"),this},enable:function enable(){return this._state.enabled=!0,this.handle1.setAttribute("tabindex",0),this.handle2.setAttribute("tabindex",0),this._removeClass(this.sliderElem,"slider-disabled"),this._trigger("slideEnabled"),this},toggle:function toggle(){return this._state.enabled?this.disable():this.enable(),this},isEnabled:function isEnabled(){return this._state.enabled},on:function on(t,i){return this._bindNonQueryEventHandler(t,i),this},off:function off(t,i){C?(this.$element.off(t,i),this.$sliderElem.off(t,i)):this._unbindNonQueryEventHandler(t,i)},getAttribute:function getAttribute(t){return t?this.options[t]:this.options},setAttribute:function setAttribute(t,i){return this.options[t]=i,this},refresh:function refresh(){return this._removeSliderEventHandlers(),createNewSlider.call(this,this.element,this.options),C&&C.data(this.element,"slider",this),this},relayout:function relayout(){return this._layout(),this},_removeSliderEventHandlers:function _removeSliderEventHandlers(){this.handle1.removeEventListener("keydown",this.handle1Keydown,!1),this.handle2.removeEventListener("keydown",this.handle2Keydown,!1),this.showTooltip&&(this.handle1.removeEventListener("focus",this.showTooltip,!1),this.handle2.removeEventListener("focus",this.showTooltip,!1)),this.hideTooltip&&(this.handle1.removeEventListener("blur",this.hideTooltip,!1),this.handle2.removeEventListener("blur",this.hideTooltip,!1)),this.showTooltip&&this.sliderElem.removeEventListener("mouseenter",this.showTooltip,!1),this.hideTooltip&&this.sliderElem.removeEventListener("mouseleave",this.hideTooltip,!1),this.sliderElem.removeEventListener("touchstart",this.mousedown,!1),this.sliderElem.removeEventListener("mousedown",this.mousedown,!1),window.removeEventListener("resize",this.resize,!1)},_bindNonQueryEventHandler:function _bindNonQueryEventHandler(t,i){void 0===this.eventToCallbackMap[t]&&(this.eventToCallbackMap[t]=[]),this.eventToCallbackMap[t].push(i)},_unbindNonQueryEventHandler:function _unbindNonQueryEventHandler(t,i){var e=this.eventToCallbackMap[t];if(void 0!==e)for(var s=0;s<e.length;s++)if(e[s]===i){e.splice(s,1);break}},_cleanUpEventCallbacksMap:function _cleanUpEventCallbacksMap(){for(var t=Object.keys(this.eventToCallbackMap),i=0;i<t.length;i++){var e=t[i];this.eventToCallbackMap[e]=null}},_showTooltip:function _showTooltip(){!1===this.options.tooltip_split?(this._addClass(this.tooltip,"in"),this.tooltip_min.style.display="none",this.tooltip_max.style.display="none"):(this._addClass(this.tooltip_min,"in"),this._addClass(this.tooltip_max,"in"),this.tooltip.style.display="none"),this._state.over=!0},_hideTooltip:function _hideTooltip(){!1===this._state.inDrag&&!0!==this.alwaysShowTooltip&&(this._removeClass(this.tooltip,"in"),this._removeClass(this.tooltip_min,"in"),this._removeClass(this.tooltip_max,"in")),this._state.over=!1},_layout:function _layout(){var t,i;if(t=this.options.reversed?[100-this._state.percentage[0],this.options.range?100-this._state.percentage[1]:this._state.percentage[1]]:[this._state.percentage[0],this._state.percentage[1]],this.handle1.style[this.stylePos]=t[0]+"%",this.handle1.setAttribute("aria-valuenow",this._state.value[0]),this.handle2.style[this.stylePos]=t[1]+"%",this.handle2.setAttribute("aria-valuenow",this._state.value[1]),Array.isArray(this.options.ticks)&&0<this.options.ticks.length){var e="vertical"===this.options.orientation?"height":"width",s="vertical"===this.options.orientation?"marginTop":"marginLeft",o=this._state.size/(this.options.ticks.length-1);if(this.tickLabelContainer){var n=0;if(0===this.options.ticks_positions.length)"vertical"!==this.options.orientation&&(this.tickLabelContainer.style[s]=-o/2+"px"),n=this.tickLabelContainer.offsetHeight;else for(a=0;a<this.tickLabelContainer.childNodes.length;a++)this.tickLabelContainer.childNodes[a].offsetHeight>n&&(n=this.tickLabelContainer.childNodes[a].offsetHeight);"horizontal"===this.options.orientation&&(this.sliderElem.style.marginBottom=n+"px")}for(var a=0;a<this.options.ticks.length;a++){var h=this.options.ticks_positions[a]||this._toPercentage(this.options.ticks[a]);this.options.reversed&&(h=100-h),this.ticks[a].style[this.stylePos]=h+"%",this._removeClass(this.ticks[a],"in-selection"),this.options.range?h>=t[0]&&h<=t[1]&&this._addClass(this.ticks[a],"in-selection"):"after"===this.options.selection&&h>=t[0]?this._addClass(this.ticks[a],"in-selection"):"before"===this.options.selection&&h<=t[0]&&this._addClass(this.ticks[a],"in-selection"),this.tickLabels[a]&&(this.tickLabels[a].style[e]=o+"px","vertical"!==this.options.orientation&&void 0!==this.options.ticks_positions[a]?(this.tickLabels[a].style.position="absolute",this.tickLabels[a].style[this.stylePos]=h+"%",this.tickLabels[a].style[s]=-o/2+"px"):"vertical"===this.options.orientation&&(this.tickLabels[a].style.marginLeft=this.sliderElem.offsetWidth+"px",this.tickLabelContainer.style.marginTop=this.sliderElem.offsetWidth/2*-1+"px"))}}if(this.options.range){i=this.options.formatter(this._state.value),this._setText(this.tooltipInner,i),this.tooltip.style[this.stylePos]=(t[1]+t[0])/2+"%","vertical"===this.options.orientation?this._css(this.tooltip,"margin-top",-this.tooltip.offsetHeight/2+"px"):this._css(this.tooltip,"margin-left",-this.tooltip.offsetWidth/2+"px"),"vertical"===this.options.orientation?this._css(this.tooltip,"margin-top",-this.tooltip.offsetHeight/2+"px"):this._css(this.tooltip,"margin-left",-this.tooltip.offsetWidth/2+"px");var l=this.options.formatter(this._state.value[0]);this._setText(this.tooltipInner_min,l);var r=this.options.formatter(this._state.value[1]);this._setText(this.tooltipInner_max,r),this.tooltip_min.style[this.stylePos]=t[0]+"%","vertical"===this.options.orientation?this._css(this.tooltip_min,"margin-top",-this.tooltip_min.offsetHeight/2+"px"):this._css(this.tooltip_min,"margin-left",-this.tooltip_min.offsetWidth/2+"px"),this.tooltip_max.style[this.stylePos]=t[1]+"%","vertical"===this.options.orientation?this._css(this.tooltip_max,"margin-top",-this.tooltip_max.offsetHeight/2+"px"):this._css(this.tooltip_max,"margin-left",-this.tooltip_max.offsetWidth/2+"px")}else i=this.options.formatter(this._state.value[0]),this._setText(this.tooltipInner,i),this.tooltip.style[this.stylePos]=t[0]+"%","vertical"===this.options.orientation?this._css(this.tooltip,"margin-top",-this.tooltip.offsetHeight/2+"px"):this._css(this.tooltip,"margin-left",-this.tooltip.offsetWidth/2+"px");if("vertical"===this.options.orientation)this.trackLow.style.top="0",this.trackLow.style.height=Math.min(t[0],t[1])+"%",this.trackSelection.style.top=Math.min(t[0],t[1])+"%",this.trackSelection.style.height=Math.abs(t[0]-t[1])+"%",this.trackHigh.style.bottom="0",this.trackHigh.style.height=100-Math.min(t[0],t[1])-Math.abs(t[0]-t[1])+"%";else{this.trackLow.style.left="0",this.trackLow.style.width=Math.min(t[0],t[1])+"%",this.trackSelection.style.left=Math.min(t[0],t[1])+"%",this.trackSelection.style.width=Math.abs(t[0]-t[1])+"%",this.trackHigh.style.right="0",this.trackHigh.style.width=100-Math.min(t[0],t[1])-Math.abs(t[0]-t[1])+"%";var p=this.tooltip_min.getBoundingClientRect(),d=this.tooltip_max.getBoundingClientRect();"bottom"===this.options.tooltip_position?p.right>d.left?(this._removeClass(this.tooltip_max,"bottom"),this._addClass(this.tooltip_max,"top"),this.tooltip_max.style.top="",this.tooltip_max.style.bottom="22px"):(this._removeClass(this.tooltip_max,"top"),this._addClass(this.tooltip_max,"bottom"),this.tooltip_max.style.top=this.tooltip_min.style.top,this.tooltip_max.style.bottom=""):p.right>d.left?(this._removeClass(this.tooltip_max,"top"),this._addClass(this.tooltip_max,"bottom"),this.tooltip_max.style.top="18px"):(this._removeClass(this.tooltip_max,"bottom"),this._addClass(this.tooltip_max,"top"),this.tooltip_max.style.top=this.tooltip_min.style.top)}},_resize:function _resize(t){this._state.offset=this._offset(this.sliderElem),this._state.size=this.sliderElem[this.sizePos],this._layout()},_removeProperty:function _removeProperty(t,i){t.style.removeProperty?t.style.removeProperty(i):t.style.removeAttribute(i)},_mousedown:function _mousedown(t){if(!this._state.enabled)return!1;this._state.offset=this._offset(this.sliderElem),this._state.size=this.sliderElem[this.sizePos];var i=this._getPercentage(t);if(this.options.range){var e=Math.abs(this._state.percentage[0]-i),s=Math.abs(this._state.percentage[1]-i);this._state.dragged=e<s?0:1}else this._state.dragged=0;this._state.percentage[this._state.dragged]=i,this._layout(),this.touchCapable&&(document.removeEventListener("touchmove",this.mousemove,!1),document.removeEventListener("touchend",this.mouseup,!1)),this.mousemove&&document.removeEventListener("mousemove",this.mousemove,!1),this.mouseup&&document.removeEventListener("mouseup",this.mouseup,!1),this.mousemove=this._mousemove.bind(this),this.mouseup=this._mouseup.bind(this),this.touchCapable&&(document.addEventListener("touchmove",this.mousemove,!1),document.addEventListener("touchend",this.mouseup,!1)),document.addEventListener("mousemove",this.mousemove,!1),document.addEventListener("mouseup",this.mouseup,!1),this._state.inDrag=!0;var o=this._calculateValue();return this._trigger("slideStart",o),this._setDataVal(o),this.setValue(o,!1,!0),this._pauseEvent(t),this.options.focus&&this._triggerFocusOnHandle(this._state.dragged),!0},_triggerFocusOnHandle:function _triggerFocusOnHandle(t){0===t&&this.handle1.focus(),1===t&&this.handle2.focus()},_keydown:function _keydown(t,i){if(!this._state.enabled)return!1;var e;switch(i.keyCode){case 37:case 40:e=-1;break;case 39:case 38:e=1}if(e){if(this.options.natural_arrow_keys){var s="vertical"===this.options.orientation&&!this.options.reversed,o="horizontal"===this.options.orientation&&this.options.reversed;(s||o)&&(e=-e)}var n=this._state.value[t]+e*this.options.step;return this.options.range&&(n=[t?this._state.value[0]:n,t?n:this._state.value[1]]),this._trigger("slideStart",n),this._setDataVal(n),this.setValue(n,!0,!0),this._setDataVal(n),this._trigger("slideStop",n),this._layout(),this._pauseEvent(i),!1}},_pauseEvent:function _pauseEvent(t){t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault(),t.cancelBubble=!0,t.returnValue=!1},_mousemove:function _mousemove(t){if(!this._state.enabled)return!1;var i=this._getPercentage(t);this._adjustPercentageForRangeSliders(i),this._state.percentage[this._state.dragged]=i,this._layout();var e=this._calculateValue(!0);return this.setValue(e,!0,!0),!1},_adjustPercentageForRangeSliders:function _adjustPercentageForRangeSliders(t){if(this.options.range){var i=this._getNumDigitsAfterDecimalPlace(t);i=i?i-1:0;var e=this._applyToFixedAndParseFloat(t,i);0===this._state.dragged&&this._applyToFixedAndParseFloat(this._state.percentage[1],i)<e?(this._state.percentage[0]=this._state.percentage[1],this._state.dragged=1):1===this._state.dragged&&this._applyToFixedAndParseFloat(this._state.percentage[0],i)>e&&(this._state.percentage[1]=this._state.percentage[0],this._state.dragged=0)}},_mouseup:function _mouseup(){if(!this._state.enabled)return!1;this.touchCapable&&(document.removeEventListener("touchmove",this.mousemove,!1),document.removeEventListener("touchend",this.mouseup,!1)),document.removeEventListener("mousemove",this.mousemove,!1),document.removeEventListener("mouseup",this.mouseup,!1),(this._state.inDrag=!1)===this._state.over&&this._hideTooltip();var t=this._calculateValue(!0);return this._layout(),this._setDataVal(t),this._trigger("slideStop",t),!1},_calculateValue:function _calculateValue(t){var i;if(this.options.range?(i=[this.options.min,this.options.max],0!==this._state.percentage[0]&&(i[0]=this._toValue(this._state.percentage[0]),i[0]=this._applyPrecision(i[0])),100!==this._state.percentage[1]&&(i[1]=this._toValue(this._state.percentage[1]),i[1]=this._applyPrecision(i[1]))):(i=this._toValue(this._state.percentage[0]),i=parseFloat(i),i=this._applyPrecision(i)),t){for(var e=[i,1/0],s=0;s<this.options.ticks.length;s++){var o=Math.abs(this.options.ticks[s]-i);o<=e[1]&&(e=[this.options.ticks[s],o])}if(e[1]<=this.options.ticks_snap_bounds)return e[0]}return i},_applyPrecision:function _applyPrecision(t){var i=this.options.precision||this._getNumDigitsAfterDecimalPlace(this.options.step);return this._applyToFixedAndParseFloat(t,i)},_getNumDigitsAfterDecimalPlace:function _getNumDigitsAfterDecimalPlace(t){var i=(""+t).match(/(?:\.(\d+))?(?:[eE]([+-]?\d+))?$/);return i?Math.max(0,(i[1]?i[1].length:0)-(i[2]?+i[2]:0)):0},_applyToFixedAndParseFloat:function _applyToFixedAndParseFloat(t,i){var e=t.toFixed(i);return parseFloat(e)},_getPercentage:function _getPercentage(t){!this.touchCapable||"touchstart"!==t.type&&"touchmove"!==t.type||(t=t.touches[0]);var i=(t[this.mousePos]-this._state.offset[this.stylePos])/this._state.size*100;return i=Math.round(i/this._state.percentage[2])*this._state.percentage[2],this.options.reversed&&(i=100-i),Math.max(0,Math.min(100,i))},_validateInputValue:function _validateInputValue(t){if("number"==typeof t)return t;if(Array.isArray(t))return this._validateArray(t),t;throw new Error(s(t))},_validateArray:function _validateArray(t){for(var i=0;i<t.length;i++){var e=t[i];if("number"!=typeof e)throw new Error(s(e))}},_setDataVal:function _setDataVal(t){this.element.setAttribute("data-value",t),this.element.setAttribute("value",t),this.element.value=t},_trigger:function _trigger(t,i){i=i||0===i?i:void 0;var e=this.eventToCallbackMap[t];if(e&&e.length)for(var s=0;s<e.length;s++){(0,e[s])(i)}C&&this._triggerJQueryEvent(t,i)},_triggerJQueryEvent:function _triggerJQueryEvent(t,i){var e={type:t,value:i};this.$element.trigger(e),this.$sliderElem.trigger(e)},_unbindJQueryEventHandlers:function _unbindJQueryEventHandlers(){this.$element.off(),this.$sliderElem.off()},_setText:function _setText(t,i){void 0!==t.textContent?t.textContent=i:void 0!==t.innerText&&(t.innerText=i)},_removeClass:function _removeClass(t,i){for(var e=i.split(" "),s=t.className,o=0;o<e.length;o++){var n=e[o],a=new RegExp("(?:\\s|^)"+n+"(?:\\s|$)");s=s.replace(a," ")}t.className=s.trim()},_addClass:function _addClass(t,i){for(var e=i.split(" "),s=t.className,o=0;o<e.length;o++){var n=e[o];new RegExp("(?:\\s|^)"+n+"(?:\\s|$)").test(s)||(s+=" "+n)}t.className=s.trim()},_offsetLeft:function _offsetLeft(t){return t.getBoundingClientRect().left},_offsetTop:function _offsetTop(t){for(var i=t.offsetTop;(t=t.offsetParent)&&!isNaN(t.offsetTop);)i+=t.offsetTop,"BODY"!==t.tagName&&(i-=t.scrollTop);return i},_offset:function _offset(t){return{left:this._offsetLeft(t),top:this._offsetTop(t)}},_css:function _css(t,i,e){if(C)C.style(t,i,e);else{var s=i.replace(/^-ms-/,"ms-").replace(/-([\da-z])/gi,function(t,i){return i.toUpperCase()});t.style[s]=e}},_toValue:function _toValue(t){return this.options.scale.toValue.apply(this,[t])},_toPercentage:function _toPercentage(t){return this.options.scale.toPercentage.apply(this,[t])},_setTooltipPosition:function _setTooltipPosition(){var t=[this.tooltip,this.tooltip_min,this.tooltip_max];if("vertical"===this.options.orientation){var i=this.options.tooltip_position||"right",e="left"===i?"right":"left";t.forEach(function(t){this._addClass(t,i),t.style[e]="100%"}.bind(this))}else"bottom"===this.options.tooltip_position?t.forEach(function(t){this._addClass(t,"bottom"),t.style.top="22px"}.bind(this)):t.forEach(function(t){this._addClass(t,"top"),t.style.top=-this.tooltip.outerHeight-14+"px"}.bind(this))}},C){var t=C.fn.slider?"bootstrapSlider":"slider";C.bridget(t,i),C(function(){C("input[data-provide=slider]")[t]()})}}(t),i});
!function(t,e){"use strict";"undefined"!=typeof module&&module.exports?module.exports=e(require("jquery")):"function"==typeof define&&define.amd?define(["jquery"],function(t){return e(t)}):e(t.jQuery)}(this,function(r){"use strict";var n=function(t,e){this.$element=r(t),this.options=r.extend({},n.defaults,e),this.matcher=this.options.matcher||this.matcher,this.sorter=this.options.sorter||this.sorter,this.select=this.options.select||this.select,this.autoSelect="boolean"!=typeof this.options.autoSelect||this.options.autoSelect,this.highlighter=this.options.highlighter||this.highlighter,this.render=this.options.render||this.render,this.updater=this.options.updater||this.updater,this.displayText=this.options.displayText||this.displayText,this.itemLink=this.options.itemLink||this.itemLink,this.itemTitle=this.options.itemTitle||this.itemTitle,this.followLinkOnSelect=this.options.followLinkOnSelect||this.followLinkOnSelect,this.source=this.options.source,this.delay=this.options.delay,this.theme=this.options.theme&&this.options.themes&&this.options.themes[this.options.theme]||n.defaults.themes[n.defaults.theme],this.$menu=r(this.options.menu||this.theme.menu),this.$appendTo=this.options.appendTo?r(this.options.appendTo):null,this.fitToElement="boolean"==typeof this.options.fitToElement&&this.options.fitToElement,this.shown=!1,this.listen(),this.showHintOnFocus=("boolean"==typeof this.options.showHintOnFocus||"all"===this.options.showHintOnFocus)&&this.options.showHintOnFocus,this.afterSelect=this.options.afterSelect,this.afterEmptySelect=this.options.afterEmptySelect,this.addItem=!1,this.value=this.$element.val()||this.$element.text(),this.keyPressed=!1,this.focused=this.$element.is(":focus"),this.changeInputOnSelect=this.options.changeInputOnSelect||this.changeInputOnSelect,this.changeInputOnMove=this.options.changeInputOnMove||this.changeInputOnMove,this.openLinkInNewTab=this.options.openLinkInNewTab||this.openLinkInNewTab,this.selectOnBlur=this.options.selectOnBlur||this.selectOnBlur,this.showCategoryHeader=this.options.showCategoryHeader||this.showCategoryHeader};n.prototype={constructor:n,setDefault:function(t){if(this.$element.data("active",t),this.autoSelect||t){var e=this.updater(t);e||(e=""),this.$element.val(this.displayText(e)||e).text(this.displayText(e)||e).change(),this.afterSelect(e)}return this.hide()},select:function(){var t=this.$menu.find(".active").data("value");if(this.$element.data("active",t),this.autoSelect||t){var e=this.updater(t);e||(e=""),this.changeInputOnSelect&&this.$element.val(this.displayText(e)||e).text(this.displayText(e)||e).change(),this.followLinkOnSelect&&this.itemLink(t)?(this.openLinkInNewTab?window.open(this.itemLink(t),"_blank"):document.location=this.itemLink(t),this.afterSelect(e)):this.followLinkOnSelect&&!this.itemLink(t)?this.afterEmptySelect(e):this.afterSelect(e)}else this.afterEmptySelect();return this.hide()},updater:function(t){return t},setSource:function(t){this.source=t},show:function(){var t,e=r.extend({},this.$element.position(),{height:this.$element[0].offsetHeight}),s="function"==typeof this.options.scrollHeight?this.options.scrollHeight.call():this.options.scrollHeight;if(this.shown?t=this.$menu:this.$appendTo?(t=this.$menu.appendTo(this.$appendTo),this.hasSameParent=this.$appendTo.is(this.$element.parent())):(t=this.$menu.insertAfter(this.$element),this.hasSameParent=!0),!this.hasSameParent){t.css("position","fixed");var i=this.$element.offset();e.top=i.top,e.left=i.left}var o=r(t).parent().hasClass("dropup")?"auto":e.top+e.height+s,n=r(t).hasClass("dropdown-menu-right")?"auto":e.left;return t.css({top:o,left:n}).show(),!0===this.options.fitToElement&&t.css("width",this.$element.outerWidth()+"px"),this.shown=!0,this},hide:function(){return this.$menu.hide(),this.shown=!1,this},lookup:function(t){if(this.query=null!=t?t:this.$element.val(),this.query.length<this.options.minLength&&!this.options.showHintOnFocus)return this.shown?this.hide():this;var e=r.proxy(function(){r.isFunction(this.source)&&3===this.source.length?this.source(this.query,r.proxy(this.process,this),r.proxy(this.process,this)):r.isFunction(this.source)?this.source(this.query,r.proxy(this.process,this)):this.source&&this.process(this.source)},this);clearTimeout(this.lookupWorker),this.lookupWorker=setTimeout(e,this.delay)},process:function(t){var e=this;return t=r.grep(t,function(t){return e.matcher(t)}),(t=this.sorter(t)).length||this.options.addItem?(0<t.length?this.$element.data("active",t[0]):this.$element.data("active",null),"all"!=this.options.items&&(t=t.slice(0,this.options.items)),this.options.addItem&&t.push(this.options.addItem),this.render(t).show()):this.shown?this.hide():this},matcher:function(t){return~this.displayText(t).toLowerCase().indexOf(this.query.toLowerCase())},sorter:function(t){for(var e,s=[],i=[],o=[];e=t.shift();){var n=this.displayText(e);n.toLowerCase().indexOf(this.query.toLowerCase())?~n.indexOf(this.query)?i.push(e):o.push(e):s.push(e)}return s.concat(i,o)},highlighter:function(t){var e=this.query;if(""===e)return t;var s,i=t.match(/(>)([^<]*)(<)/g),o=[],n=[];if(i&&i.length)for(s=0;s<i.length;++s)2<i[s].length&&o.push(i[s]);else(o=[]).push(t);e=e.replace(/[\(\)\/\.\*\+\?\[\]]/g,function(t){return"\\"+t});var h,a=new RegExp(e,"g");for(s=0;s<o.length;++s)(h=o[s].match(a))&&0<h.length&&n.push(o[s]);for(s=0;s<n.length;++s)t=t.replace(n[s],n[s].replace(a,"<strong>$&</strong>"));return t},render:function(s){var i=this,o=this,n=!1,h=[],a=i.options.separator;return r.each(s,function(t,e){0<t&&e[a]!==s[t-1][a]&&h.push({__type:"divider"}),this.showCategoryHeader&&(!e[a]||0!==t&&e[a]===s[t-1][a]||h.push({__type:"category",name:e[a]})),h.push(e)}),s=r(h).map(function(t,e){if("category"==(e.__type||!1))return r(i.options.headerHtml||i.theme.headerHtml).text(e.name)[0];if("divider"==(e.__type||!1))return r(i.options.headerDivider||i.theme.headerDivider)[0];var s=o.displayText(e);return(t=r(i.options.item||i.theme.item).data("value",e)).find(i.options.itemContentSelector||i.theme.itemContentSelector).addBack(i.options.itemContentSelector||i.theme.itemContentSelector).html(i.highlighter(s,e)),i.options.followLinkOnSelect&&t.find("a").attr("href",o.itemLink(e)),t.find("a").attr("title",o.itemTitle(e)),s==o.$element.val()&&(t.addClass("active"),o.$element.data("active",e),n=!0),t[0]}),this.autoSelect&&!n&&(s.filter(":not(.dropdown-header)").first().addClass("active"),this.$element.data("active",s.first().data("value"))),this.$menu.html(s),this},displayText:function(t){return void 0!==t&&void 0!==t.name?t.name:t},itemLink:function(t){return null},itemTitle:function(t){return null},next:function(t){var e=this.$menu.find(".active").removeClass("active").next();for(e.length||(e=r(this.$menu.find(r(this.options.item||this.theme.item).prop("tagName"))[0]));e.hasClass("divider")||e.hasClass("dropdown-header");)e=e.next();e.addClass("active");var s=this.updater(e.data("value"));this.changeInputOnMove&&this.$element.val(this.displayText(s)||s)},prev:function(t){var e=this.$menu.find(".active").removeClass("active").prev();for(e.length||(e=this.$menu.find(r(this.options.item||this.theme.item).prop("tagName")).last());e.hasClass("divider")||e.hasClass("dropdown-header");)e=e.prev();e.addClass("active");var s=this.updater(e.data("value"));this.changeInputOnMove&&this.$element.val(this.displayText(s)||s)},listen:function(){this.$element.on("focus.bootstrap3Typeahead",r.proxy(this.focus,this)).on("blur.bootstrap3Typeahead",r.proxy(this.blur,this)).on("keypress.bootstrap3Typeahead",r.proxy(this.keypress,this)).on("propertychange.bootstrap3Typeahead input.bootstrap3Typeahead",r.proxy(this.input,this)).on("keyup.bootstrap3Typeahead",r.proxy(this.keyup,this)),this.eventSupported("keydown")&&this.$element.on("keydown.bootstrap3Typeahead",r.proxy(this.keydown,this));var t=r(this.options.item||this.theme.item).prop("tagName");"ontouchstart"in document.documentElement&&"onmousemove"in document.documentElement?this.$menu.on("touchstart",t,r.proxy(this.touchstart,this)).on("touchend",t,r.proxy(this.click,this)).on("click",r.proxy(this.click,this)).on("mouseenter",t,r.proxy(this.mouseenter,this)).on("mouseleave",t,r.proxy(this.mouseleave,this)).on("mousedown",r.proxy(this.mousedown,this)):"ontouchstart"in document.documentElement?this.$menu.on("touchstart",t,r.proxy(this.touchstart,this)).on("touchend",t,r.proxy(this.click,this)):this.$menu.on("click",r.proxy(this.click,this)).on("mouseenter",t,r.proxy(this.mouseenter,this)).on("mouseleave",t,r.proxy(this.mouseleave,this)).on("mousedown",r.proxy(this.mousedown,this))},destroy:function(){this.$element.data("typeahead",null),this.$element.data("active",null),this.$element.unbind("focus.bootstrap3Typeahead").unbind("blur.bootstrap3Typeahead").unbind("keypress.bootstrap3Typeahead").unbind("propertychange.bootstrap3Typeahead input.bootstrap3Typeahead").unbind("keyup.bootstrap3Typeahead"),this.eventSupported("keydown")&&this.$element.unbind("keydown.bootstrap3-typeahead"),this.$menu.remove(),this.destroyed=!0},eventSupported:function(t){var e=t in this.$element;return e||(this.$element.setAttribute(t,"return;"),e="function"==typeof this.$element[t]),e},move:function(t){if(this.shown)switch(t.keyCode){case 9:case 13:case 27:t.preventDefault();break;case 38:if(t.shiftKey)return;t.preventDefault(),this.prev();break;case 40:if(t.shiftKey)return;t.preventDefault(),this.next()}},keydown:function(t){17!==t.keyCode&&(this.keyPressed=!0,this.suppressKeyPressRepeat=~r.inArray(t.keyCode,[40,38,9,13,27]),this.shown||40!=t.keyCode?this.move(t):this.lookup())},keypress:function(t){this.suppressKeyPressRepeat||this.move(t)},input:function(t){var e=this.$element.val()||this.$element.text();this.value!==e&&(this.value=e,this.lookup())},keyup:function(t){if(!this.destroyed)switch(t.keyCode){case 40:case 38:case 16:case 17:case 18:break;case 9:if(!this.shown||this.showHintOnFocus&&!this.keyPressed)return;this.select();break;case 13:if(!this.shown)return;this.select();break;case 27:if(!this.shown)return;this.hide()}},focus:function(t){this.focused||(this.focused=!0,this.keyPressed=!1,this.options.showHintOnFocus&&!0!==this.skipShowHintOnFocus&&("all"===this.options.showHintOnFocus?this.lookup(""):this.lookup())),this.skipShowHintOnFocus&&(this.skipShowHintOnFocus=!1)},blur:function(t){this.mousedover||this.mouseddown||!this.shown?this.mouseddown&&(this.skipShowHintOnFocus=!0,this.$element.focus(),this.mouseddown=!1):(this.selectOnBlur&&this.select(),this.hide(),this.focused=!1,this.keyPressed=!1)},click:function(t){t.preventDefault(),this.skipShowHintOnFocus=!0,this.select(),this.$element.focus(),this.hide()},mouseenter:function(t){this.mousedover=!0,this.$menu.find(".active").removeClass("active"),r(t.currentTarget).addClass("active")},mouseleave:function(t){this.mousedover=!1,!this.focused&&this.shown&&this.hide()},mousedown:function(t){this.mouseddown=!0,this.$menu.one("mouseup",function(t){this.mouseddown=!1}.bind(this))},touchstart:function(t){t.preventDefault(),this.$menu.find(".active").removeClass("active"),r(t.currentTarget).addClass("active")},touchend:function(t){t.preventDefault(),this.select(),this.$element.focus()}};var t=r.fn.typeahead;r.fn.typeahead=function(i){var o=arguments;return"string"==typeof i&&"getActive"==i?this.data("active"):this.each(function(){var t=r(this),e=t.data("typeahead"),s="object"==typeof i&&i;e||t.data("typeahead",e=new n(this,s)),"string"==typeof i&&e[i]&&(1<o.length?e[i].apply(e,Array.prototype.slice.call(o,1)):e[i]())})},n.defaults={source:[],items:8,minLength:1,scrollHeight:0,autoSelect:!0,afterSelect:r.noop,afterEmptySelect:r.noop,addItem:!1,followLinkOnSelect:!1,delay:0,separator:"category",changeInputOnSelect:!0,changeInputOnMove:!0,openLinkInNewTab:!1,selectOnBlur:!0,showCategoryHeader:!0,theme:"bootstrap3",themes:{bootstrap3:{menu:'<ul class="typeahead dropdown-menu" role="listbox"></ul>',item:'<li><a class="dropdown-item" href="#" role="option"></a></li>',itemContentSelector:"a",headerHtml:'<li class="dropdown-header"></li>',headerDivider:'<li class="divider" role="separator"></li>'},bootstrap4:{menu:'<div class="typeahead dropdown-menu" role="listbox"></div>',item:'<button class="dropdown-item" role="option"></button>',itemContentSelector:".dropdown-item",headerHtml:'<h6 class="dropdown-header"></h6>',headerDivider:'<div class="dropdown-divider"></div>'}}},r.fn.typeahead.Constructor=n,r.fn.typeahead.noConflict=function(){return r.fn.typeahead=t,this},r(document).on("focus.typeahead.data-api",'[data-provide="typeahead"]',function(t){var e=r(this);e.data("typeahead")||e.typeahead(e.data())})});
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).JSZip=e()}}(function(){return function e(o,u,l){function s(r,t){if(!u[r]){if(!o[r]){var n="function"==typeof require&&require;if(!t&&n)return n(r,!0);if(h)return h(r,!0);var i=new Error("Cannot find module '"+r+"'");throw i.code="MODULE_NOT_FOUND",i}var a=u[r]={exports:{}};o[r][0].call(a.exports,function(e){var t=o[r][1][e];return s(t||e)},a,a.exports,e,o,u,l)}return u[r].exports}for(var h="function"==typeof require&&require,t=0;t<l.length;t++)s(l[t]);return s}({1:[function(e,t,r){"use strict";var c=e("./utils"),f=e("./support"),p="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";r.encode=function(e){for(var t,r,n,i,a,s,o,u=[],l=0,h=e.length,d=h,f="string"!==c.getTypeOf(e);l<e.length;)d=h-l,n=f?(t=e[l++],r=l<h?e[l++]:0,l<h?e[l++]:0):(t=e.charCodeAt(l++),r=l<h?e.charCodeAt(l++):0,l<h?e.charCodeAt(l++):0),i=t>>2,a=(3&t)<<4|r>>4,s=1<d?(15&r)<<2|n>>6:64,o=2<d?63&n:64,u.push(p.charAt(i)+p.charAt(a)+p.charAt(s)+p.charAt(o));return u.join("")},r.decode=function(e){var t,r,n,i,a,s,o=0,u=0,l="data:";if(e.substr(0,l.length)===l)throw new Error("Invalid base64 input, it looks like a data url.");var h,d=3*(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"")).length/4;if(e.charAt(e.length-1)===p.charAt(64)&&d--,e.charAt(e.length-2)===p.charAt(64)&&d--,d%1!=0)throw new Error("Invalid base64 input, bad content length.");for(h=f.uint8array?new Uint8Array(0|d):new Array(0|d);o<e.length;)t=p.indexOf(e.charAt(o++))<<2|(i=p.indexOf(e.charAt(o++)))>>4,r=(15&i)<<4|(a=p.indexOf(e.charAt(o++)))>>2,n=(3&a)<<6|(s=p.indexOf(e.charAt(o++))),h[u++]=t,64!==a&&(h[u++]=r),64!==s&&(h[u++]=n);return h}},{"./support":30,"./utils":32}],2:[function(e,t,r){"use strict";var n=e("./external"),i=e("./stream/DataWorker"),a=e("./stream/DataLengthProbe"),s=e("./stream/Crc32Probe");a=e("./stream/DataLengthProbe");function CompressedObject(e,t,r,n,i){this.compressedSize=e,this.uncompressedSize=t,this.crc32=r,this.compression=n,this.compressedContent=i}CompressedObject.prototype={getContentWorker:function(){var e=new i(n.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new a("data_length")),t=this;return e.on("end",function(){if(this.streamInfo.data_length!==t.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),e},getCompressedWorker:function(){return new i(n.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},CompressedObject.createWorkerFrom=function(e,t,r){return e.pipe(new s).pipe(new a("uncompressedSize")).pipe(t.compressWorker(r)).pipe(new a("compressedSize")).withStreamInfo("compression",t)},t.exports=CompressedObject},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,t,r){"use strict";var n=e("./stream/GenericWorker");r.STORE={magic:"\0\0",compressWorker:function(e){return new n("STORE compression")},uncompressWorker:function(){return new n("STORE decompression")}},r.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,t,r){"use strict";var n=e("./utils");var o=function makeTable(){for(var e,t=[],r=0;r<256;r++){e=r;for(var n=0;n<8;n++)e=1&e?3988292384^e>>>1:e>>>1;t[r]=e}return t}();t.exports=function crc32wrapper(e,t){return void 0!==e&&e.length?"string"!==n.getTypeOf(e)?function crc32(e,t,r,n){var i=o,a=n+r;e^=-1;for(var s=n;s<a;s++)e=e>>>8^i[255&(e^t[s])];return-1^e}(0|t,e,e.length,0):function crc32str(e,t,r,n){var i=o,a=n+r;e^=-1;for(var s=n;s<a;s++)e=e>>>8^i[255&(e^t.charCodeAt(s))];return-1^e}(0|t,e,e.length,0):0}},{"./utils":32}],5:[function(e,t,r){"use strict";r.base64=!1,r.binary=!1,r.dir=!1,r.createFolders=!0,r.date=null,r.compression=null,r.compressionOptions=null,r.comment=null,r.unixPermissions=null,r.dosPermissions=null},{}],6:[function(e,t,r){"use strict";var n=null;n="undefined"!=typeof Promise?Promise:e("lie"),t.exports={Promise:n}},{lie:58}],7:[function(e,t,r){"use strict";var n="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array,i=e("pako"),a=e("./utils"),s=e("./stream/GenericWorker"),o=n?"uint8array":"array";function FlateWorker(e,t){s.call(this,"FlateWorker/"+e),this._pako=new i[e]({raw:!0,level:t.level||-1}),this.meta={};var r=this;this._pako.onData=function(e){r.push({data:e,meta:r.meta})}}r.magic="\b\0",a.inherits(FlateWorker,s),FlateWorker.prototype.processChunk=function(e){this.meta=e.meta,this._pako.push(a.transformTo(o,e.data),!1)},FlateWorker.prototype.flush=function(){s.prototype.flush.call(this),this._pako.push([],!0)},FlateWorker.prototype.cleanUp=function(){s.prototype.cleanUp.call(this),this._pako=null},r.compressWorker=function(e){return new FlateWorker("Deflate",e)},r.uncompressWorker=function(){return new FlateWorker("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:59}],8:[function(e,t,r){"use strict";var T=e("../utils"),i=e("../stream/GenericWorker"),O=e("../utf8"),D=e("../crc32"),B=e("../signature"),F=function(e,t){var r,n="";for(r=0;r<t;r++)n+=String.fromCharCode(255&e),e>>>=8;return n},a=function(e,t,r,n,i,a){var s,o,u=e.file,l=e.compression,h=a!==O.utf8encode,d=T.transformTo("string",a(u.name)),f=T.transformTo("string",O.utf8encode(u.name)),c=u.comment,p=T.transformTo("string",a(c)),_=T.transformTo("string",O.utf8encode(c)),m=f.length!==u.name.length,g=_.length!==c.length,b="",y="",v="",w=u.dir,k=u.date,x={crc32:0,compressedSize:0,uncompressedSize:0};t&&!r||(x.crc32=e.crc32,x.compressedSize=e.compressedSize,x.uncompressedSize=e.uncompressedSize);var S=0;t&&(S|=8),h||!m&&!g||(S|=2048);var z,C,A,E=0,I=0;w&&(E|=16),"UNIX"===i?(I=798,E|=(z=u.unixPermissions,C=w,(A=z)||(A=C?16893:33204),(65535&A)<<16)):(I=20,E|=63&(u.dosPermissions||0)),s=k.getUTCHours(),s<<=6,s|=k.getUTCMinutes(),s<<=5,s|=k.getUTCSeconds()/2,o=k.getUTCFullYear()-1980,o<<=4,o|=k.getUTCMonth()+1,o<<=5,o|=k.getUTCDate(),m&&(y=F(1,1)+F(D(d),4)+f,b+="up"+F(y.length,2)+y),g&&(v=F(1,1)+F(D(p),4)+_,b+="uc"+F(v.length,2)+v);var R="";return R+="\n\0",R+=F(S,2),R+=l.magic,R+=F(s,2),R+=F(o,2),R+=F(x.crc32,4),R+=F(x.compressedSize,4),R+=F(x.uncompressedSize,4),R+=F(d.length,2),R+=F(b.length,2),{fileRecord:B.LOCAL_FILE_HEADER+R+d+b,dirRecord:B.CENTRAL_FILE_HEADER+F(I,2)+R+F(p.length,2)+"\0\0\0\0"+F(E,4)+F(n,4)+d+b+p}};function ZipFileWorker(e,t,r,n){i.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=t,this.zipPlatform=r,this.encodeFileName=n,this.streamFiles=e,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}T.inherits(ZipFileWorker,i),ZipFileWorker.prototype.push=function(e){var t=e.meta.percent||0,r=this.entriesCount,n=this._sources.length;this.accumulate?this.contentBuffer.push(e):(this.bytesWritten+=e.data.length,i.prototype.push.call(this,{data:e.data,meta:{currentFile:this.currentFile,percent:r?(t+100*(r-n-1))/r:100}}))},ZipFileWorker.prototype.openedSource=function(e){this.currentSourceOffset=this.bytesWritten,this.currentFile=e.file.name;var t=this.streamFiles&&!e.file.dir;if(t){var r=a(e,t,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:r.fileRecord,meta:{percent:0}})}else this.accumulate=!0},ZipFileWorker.prototype.closedSource=function(e){this.accumulate=!1;var t,r=this.streamFiles&&!e.file.dir,n=a(e,r,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(n.dirRecord),r)this.push({data:(t=e,B.DATA_DESCRIPTOR+F(t.crc32,4)+F(t.compressedSize,4)+F(t.uncompressedSize,4)),meta:{percent:100}});else for(this.push({data:n.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},ZipFileWorker.prototype.flush=function(){for(var e=this.bytesWritten,t=0;t<this.dirRecords.length;t++)this.push({data:this.dirRecords[t],meta:{percent:100}});var r,n,i,a,s,o,u=this.bytesWritten-e,l=(r=this.dirRecords.length,n=u,i=e,a=this.zipComment,s=this.encodeFileName,o=T.transformTo("string",s(a)),B.CENTRAL_DIRECTORY_END+"\0\0\0\0"+F(r,2)+F(r,2)+F(n,4)+F(i,4)+F(o.length,2)+o);this.push({data:l,meta:{percent:100}})},ZipFileWorker.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},ZipFileWorker.prototype.registerPrevious=function(e){this._sources.push(e);var t=this;return e.on("data",function(e){t.processChunk(e)}),e.on("end",function(){t.closedSource(t.previous.streamInfo),t._sources.length?t.prepareNextSource():t.end()}),e.on("error",function(e){t.error(e)}),this},ZipFileWorker.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},ZipFileWorker.prototype.error=function(e){var t=this._sources;if(!i.prototype.error.call(this,e))return!1;for(var r=0;r<t.length;r++)try{t[r].error(e)}catch(e){}return!0},ZipFileWorker.prototype.lock=function(){i.prototype.lock.call(this);for(var e=this._sources,t=0;t<e.length;t++)e[t].lock()},t.exports=ZipFileWorker},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,t,r){"use strict";var l=e("../compressions"),n=e("./ZipFileWorker");r.generateWorker=function(e,s,t){var o=new n(s.streamFiles,t,s.platform,s.encodeFileName),u=0;try{e.forEach(function(e,t){u++;var r=function(e,t){var r=e||t,n=l[r];if(!n)throw new Error(r+" is not a valid compression method !");return n}(t.options.compression,s.compression),n=t.options.compressionOptions||s.compressionOptions||{},i=t.dir,a=t.date;t._compressWorker(r,n).withStreamInfo("file",{name:e,dir:i,date:a,comment:t.comment||"",unixPermissions:t.unixPermissions,dosPermissions:t.dosPermissions}).pipe(o)}),o.entriesCount=u}catch(e){o.error(e)}return o}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,t,r){"use strict";function JSZip(){if(!(this instanceof JSZip))return new JSZip;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files={},this.comment=null,this.root="",this.clone=function(){var e=new JSZip;for(var t in this)"function"!=typeof this[t]&&(e[t]=this[t]);return e}}(JSZip.prototype=e("./object")).loadAsync=e("./load"),JSZip.support=e("./support"),JSZip.defaults=e("./defaults"),JSZip.version="3.1.3",JSZip.loadAsync=function(e,t){return(new JSZip).loadAsync(e,t)},JSZip.external=e("./external"),t.exports=JSZip},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,t,r){"use strict";var n=e("./utils"),i=e("./external"),o=e("./utf8"),u=(n=e("./utils"),e("./zipEntries")),a=e("./stream/Crc32Probe"),l=e("./nodejsUtils");function checkEntryCRC32(n){return new i.Promise(function(e,t){var r=n.decompressed.getContentWorker().pipe(new a);r.on("error",function(e){t(e)}).on("end",function(){r.streamInfo.crc32!==n.decompressed.crc32?t(new Error("Corrupted zip : CRC32 mismatch")):e()}).resume()})}t.exports=function(e,a){var s=this;return a=n.extend(a||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:o.utf8decode}),l.isNode&&l.isStream(e)?i.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):n.prepareContent("the loaded zip file",e,!0,a.optimizedBinaryString,a.base64).then(function(e){var t=new u(a);return t.load(e),t}).then(function checkCRC32(e){var t=[i.Promise.resolve(e)],r=e.files;if(a.checkCRC32)for(var n=0;n<r.length;n++)t.push(checkEntryCRC32(r[n]));return i.Promise.all(t)}).then(function addFiles(e){for(var t=e.shift(),r=t.files,n=0;n<r.length;n++){var i=r[n];s.file(i.fileNameStr,i.decompressed,{binary:!0,optimizedBinaryString:!0,date:i.date,dir:i.dir,comment:i.fileCommentStr.length?i.fileCommentStr:null,unixPermissions:i.unixPermissions,dosPermissions:i.dosPermissions,createFolders:a.createFolders})}return t.zipComment.length&&(s.comment=t.zipComment),s})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,t,r){"use strict";var n=e("../utils"),i=e("../stream/GenericWorker");function NodejsStreamInputAdapter(e,t){i.call(this,"Nodejs stream input adapter for "+e),this._upstreamEnded=!1,this._bindStream(t)}n.inherits(NodejsStreamInputAdapter,i),NodejsStreamInputAdapter.prototype._bindStream=function(e){var t=this;(this._stream=e).pause(),e.on("data",function(e){t.push({data:e,meta:{percent:0}})}).on("error",function(e){t.isPaused?this.generatedError=e:t.error(e)}).on("end",function(){t.isPaused?t._upstreamEnded=!0:t.end()})},NodejsStreamInputAdapter.prototype.pause=function(){return!!i.prototype.pause.call(this)&&(this._stream.pause(),!0)},NodejsStreamInputAdapter.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},t.exports=NodejsStreamInputAdapter},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,t,r){"use strict";var i=e("readable-stream").Readable;function NodejsStreamOutputAdapter(e,t,r){i.call(this,t),this._helper=e;var n=this;e.on("data",function(e,t){n.push(e)||n._helper.pause(),r&&r(t)}).on("error",function(e){n.emit("error",e)}).on("end",function(){n.push(null)})}e("util").inherits(NodejsStreamOutputAdapter,i),NodejsStreamOutputAdapter.prototype._read=function(){this._helper.resume()},t.exports=NodejsStreamOutputAdapter},{"readable-stream":16,util:void 0}],14:[function(e,t,r){"use strict";t.exports={isNode:"undefined"!=typeof Buffer,newBuffer:function(e,t){return new Buffer(e,t)},isBuffer:function(e){return Buffer.isBuffer(e)},isStream:function(e){return e&&"function"==typeof e.on&&"function"==typeof e.pause&&"function"==typeof e.resume}}},{}],15:[function(e,t,r){"use strict";var i=e("./utf8"),l=e("./utils"),h=e("./stream/GenericWorker"),a=e("./stream/StreamHelper"),d=e("./defaults"),f=e("./compressedObject"),c=e("./zipObject"),s=e("./generate"),p=e("./nodejsUtils"),_=e("./nodejs/NodejsStreamInputAdapter"),o=function(e,t,r){var n,i=l.getTypeOf(t),a=l.extend(r||{},d);a.date=a.date||new Date,null!==a.compression&&(a.compression=a.compression.toUpperCase()),"string"==typeof a.unixPermissions&&(a.unixPermissions=parseInt(a.unixPermissions,8)),a.unixPermissions&&16384&a.unixPermissions&&(a.dir=!0),a.dosPermissions&&16&a.dosPermissions&&(a.dir=!0),a.dir&&(e=g(e)),a.createFolders&&(n=m(e))&&b.call(this,n,!0);var s="string"===i&&!1===a.binary&&!1===a.base64;r&&void 0!==r.binary||(a.binary=!s),(t instanceof f&&0===t.uncompressedSize||a.dir||!t||0===t.length)&&(a.base64=!1,a.binary=!0,t="",a.compression="STORE",i="string");var o=null;o=t instanceof f||t instanceof h?t:p.isNode&&p.isStream(t)?new _(e,t):l.prepareContent(e,t,a.binary,a.optimizedBinaryString,a.base64);var u=new c(e,o,a);this.files[e]=u},m=function(e){"/"===e.slice(-1)&&(e=e.substring(0,e.length-1));var t=e.lastIndexOf("/");return 0<t?e.substring(0,t):""},g=function(e){return"/"!==e.slice(-1)&&(e+="/"),e},b=function(e,t){return t=void 0!==t?t:d.createFolders,e=g(e),this.files[e]||o.call(this,e,null,{dir:!0,createFolders:t}),this.files[e]};function isRegExp(e){return"[object RegExp]"===Object.prototype.toString.call(e)}var n={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(e){var t,r,n;for(t in this.files)this.files.hasOwnProperty(t)&&(n=this.files[t],(r=t.slice(this.root.length,t.length))&&t.slice(0,this.root.length)===this.root&&e(r,n))},filter:function(r){var n=[];return this.forEach(function(e,t){r(e,t)&&n.push(t)}),n},file:function(e,t,r){if(1!==arguments.length)return e=this.root+e,o.call(this,e,t,r),this;if(isRegExp(e)){var n=e;return this.filter(function(e,t){return!t.dir&&n.test(e)})}var i=this.files[this.root+e];return i&&!i.dir?i:null},folder:function(r){if(!r)return this;if(isRegExp(r))return this.filter(function(e,t){return t.dir&&r.test(e)});var e=this.root+r,t=b.call(this,e),n=this.clone();return n.root=t.name,n},remove:function(r){r=this.root+r;var e=this.files[r];if(e||("/"!==r.slice(-1)&&(r+="/"),e=this.files[r]),e&&!e.dir)delete this.files[r];else for(var t=this.filter(function(e,t){return t.name.slice(0,r.length)===r}),n=0;n<t.length;n++)delete this.files[t[n].name];return this},generate:function(e){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(e){var t,r={};try{if((r=l.extend(e||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:i.utf8encode})).type=r.type.toLowerCase(),r.compression=r.compression.toUpperCase(),"binarystring"===r.type&&(r.type="string"),!r.type)throw new Error("No output type specified.");l.checkSupport(r.type),"darwin"!==r.platform&&"freebsd"!==r.platform&&"linux"!==r.platform&&"sunos"!==r.platform||(r.platform="UNIX"),"win32"===r.platform&&(r.platform="DOS");var n=r.comment||this.comment||"";t=s.generateWorker(this,r,n)}catch(e){(t=new h("error")).error(e)}return new a(t,r.type||"string",r.mimeType)},generateAsync:function(e,t){return this.generateInternalStream(e).accumulate(t)},generateNodeStream:function(e,t){return(e=e||{}).type||(e.type="nodebuffer"),this.generateInternalStream(e).toNodejsStream(t)}};t.exports=n},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,t,r){t.exports=e("stream")},{stream:void 0}],17:[function(e,t,r){"use strict";var n=e("./DataReader");function ArrayReader(e){n.call(this,e);for(var t=0;t<this.data.length;t++)e[t]=255&e[t]}e("../utils").inherits(ArrayReader,n),ArrayReader.prototype.byteAt=function(e){return this.data[this.zero+e]},ArrayReader.prototype.lastIndexOfSignature=function(e){for(var t=e.charCodeAt(0),r=e.charCodeAt(1),n=e.charCodeAt(2),i=e.charCodeAt(3),a=this.length-4;0<=a;--a)if(this.data[a]===t&&this.data[a+1]===r&&this.data[a+2]===n&&this.data[a+3]===i)return a-this.zero;return-1},ArrayReader.prototype.readAndCheckSignature=function(e){var t=e.charCodeAt(0),r=e.charCodeAt(1),n=e.charCodeAt(2),i=e.charCodeAt(3),a=this.readData(4);return t===a[0]&&r===a[1]&&n===a[2]&&i===a[3]},ArrayReader.prototype.readData=function(e){if(this.checkOffset(e),0===e)return[];var t=this.data.slice(this.zero+this.index,this.zero+this.index+e);return this.index+=e,t},t.exports=ArrayReader},{"../utils":32,"./DataReader":18}],18:[function(e,t,r){"use strict";var n=e("../utils");function DataReader(e){this.data=e,this.length=e.length,this.index=0,this.zero=0}DataReader.prototype={checkOffset:function(e){this.checkIndex(this.index+e)},checkIndex:function(e){if(this.length<this.zero+e||e<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+e+"). Corrupted zip ?")},setIndex:function(e){this.checkIndex(e),this.index=e},skip:function(e){this.setIndex(this.index+e)},byteAt:function(e){},readInt:function(e){var t,r=0;for(this.checkOffset(e),t=this.index+e-1;t>=this.index;t--)r=(r<<8)+this.byteAt(t);return this.index+=e,r},readString:function(e){return n.transformTo("string",this.readData(e))},readData:function(e){},lastIndexOfSignature:function(e){},readAndCheckSignature:function(e){},readDate:function(){var e=this.readInt(4);return new Date(Date.UTC(1980+(e>>25&127),(e>>21&15)-1,e>>16&31,e>>11&31,e>>5&63,(31&e)<<1))}},t.exports=DataReader},{"../utils":32}],19:[function(e,t,r){"use strict";var n=e("./Uint8ArrayReader");function NodeBufferReader(e){n.call(this,e)}e("../utils").inherits(NodeBufferReader,n),NodeBufferReader.prototype.readData=function(e){this.checkOffset(e);var t=this.data.slice(this.zero+this.index,this.zero+this.index+e);return this.index+=e,t},t.exports=NodeBufferReader},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,t,r){"use strict";var n=e("./DataReader");function StringReader(e){n.call(this,e)}e("../utils").inherits(StringReader,n),StringReader.prototype.byteAt=function(e){return this.data.charCodeAt(this.zero+e)},StringReader.prototype.lastIndexOfSignature=function(e){return this.data.lastIndexOf(e)-this.zero},StringReader.prototype.readAndCheckSignature=function(e){return e===this.readData(4)},StringReader.prototype.readData=function(e){this.checkOffset(e);var t=this.data.slice(this.zero+this.index,this.zero+this.index+e);return this.index+=e,t},t.exports=StringReader},{"../utils":32,"./DataReader":18}],21:[function(e,t,r){"use strict";var n=e("./ArrayReader");function Uint8ArrayReader(e){n.call(this,e)}e("../utils").inherits(Uint8ArrayReader,n),Uint8ArrayReader.prototype.readData=function(e){if(this.checkOffset(e),0===e)return new Uint8Array(0);var t=this.data.subarray(this.zero+this.index,this.zero+this.index+e);return this.index+=e,t},t.exports=Uint8ArrayReader},{"../utils":32,"./ArrayReader":17}],22:[function(e,t,r){"use strict";var n=e("../utils"),i=e("../support"),a=e("./ArrayReader"),s=e("./StringReader"),o=e("./NodeBufferReader"),u=e("./Uint8ArrayReader");t.exports=function(e){var t=n.getTypeOf(e);return n.checkSupport(t),"string"!==t||i.uint8array?"nodebuffer"===t?new o(e):i.uint8array?new u(n.transformTo("uint8array",e)):new a(n.transformTo("array",e)):new s(e)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,t,r){"use strict";r.LOCAL_FILE_HEADER="PK",r.CENTRAL_FILE_HEADER="PK",r.CENTRAL_DIRECTORY_END="PK",r.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK",r.ZIP64_CENTRAL_DIRECTORY_END="PK",r.DATA_DESCRIPTOR="PK\b"},{}],24:[function(e,t,r){"use strict";var n=e("./GenericWorker"),i=e("../utils");function ConvertWorker(e){n.call(this,"ConvertWorker to "+e),this.destType=e}i.inherits(ConvertWorker,n),ConvertWorker.prototype.processChunk=function(e){this.push({data:i.transformTo(this.destType,e.data),meta:e.meta})},t.exports=ConvertWorker},{"../utils":32,"./GenericWorker":28}],25:[function(e,t,r){"use strict";var n=e("./GenericWorker"),i=e("../crc32");function Crc32Probe(){n.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}e("../utils").inherits(Crc32Probe,n),Crc32Probe.prototype.processChunk=function(e){this.streamInfo.crc32=i(e.data,this.streamInfo.crc32||0),this.push(e)},t.exports=Crc32Probe},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,t,r){"use strict";var n=e("../utils"),i=e("./GenericWorker");function DataLengthProbe(e){i.call(this,"DataLengthProbe for "+e),this.propName=e,this.withStreamInfo(e,0)}n.inherits(DataLengthProbe,i),DataLengthProbe.prototype.processChunk=function(e){if(e){var t=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=t+e.data.length}i.prototype.processChunk.call(this,e)},t.exports=DataLengthProbe},{"../utils":32,"./GenericWorker":28}],27:[function(e,t,r){"use strict";var n=e("../utils"),i=e("./GenericWorker");function DataWorker(e){i.call(this,"DataWorker");var t=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,e.then(function(e){t.dataIsReady=!0,t.data=e,t.max=e&&e.length||0,t.type=n.getTypeOf(e),t.isPaused||t._tickAndRepeat()},function(e){t.error(e)})}n.inherits(DataWorker,i),DataWorker.prototype.cleanUp=function(){i.prototype.cleanUp.call(this),this.data=null},DataWorker.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,n.delay(this._tickAndRepeat,[],this)),!0)},DataWorker.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(n.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},DataWorker.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var e=null,t=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":e=this.data.substring(this.index,t);break;case"uint8array":e=this.data.subarray(this.index,t);break;case"array":case"nodebuffer":e=this.data.slice(this.index,t)}return this.index=t,this.push({data:e,meta:{percent:this.max?this.index/this.max*100:0}})},t.exports=DataWorker},{"../utils":32,"./GenericWorker":28}],28:[function(e,t,r){"use strict";function GenericWorker(e){this.name=e||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}GenericWorker.prototype={push:function(e){this.emit("data",e)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(e){this.emit("error",e)}return!0},error:function(e){return!this.isFinished&&(this.isPaused?this.generatedError=e:(this.isFinished=!0,this.emit("error",e),this.previous&&this.previous.error(e),this.cleanUp()),!0)},on:function(e,t){return this._listeners[e].push(t),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(e,t){if(this._listeners[e])for(var r=0;r<this._listeners[e].length;r++)this._listeners[e][r].call(this,t)},pipe:function(e){return e.registerPrevious(this)},registerPrevious:function(e){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=e.streamInfo,this.mergeStreamInfo(),this.previous=e;var t=this;return e.on("data",function(e){t.processChunk(e)}),e.on("end",function(){t.end()}),e.on("error",function(e){t.error(e)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var e=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),e=!0),this.previous&&this.previous.resume(),!e},flush:function(){},processChunk:function(e){this.push(e)},withStreamInfo:function(e,t){return this.extraStreamInfo[e]=t,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var e in this.extraStreamInfo)this.extraStreamInfo.hasOwnProperty(e)&&(this.streamInfo[e]=this.extraStreamInfo[e])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var e="Worker "+this.name;return this.previous?this.previous+" -> "+e:e}},t.exports=GenericWorker},{}],29:[function(e,t,r){"use strict";var u=e("../utils"),i=e("./ConvertWorker"),a=e("./GenericWorker"),l=e("../base64"),n=e("../support"),s=e("../external"),o=null;if(n.nodestream)try{o=e("../nodejs/NodejsStreamOutputAdapter")}catch(e){}function concat(e,t){var r,n=0,i=null,a=0;for(r=0;r<t.length;r++)a+=t[r].length;switch(e){case"string":return t.join("");case"array":return Array.prototype.concat.apply([],t);case"uint8array":for(i=new Uint8Array(a),r=0;r<t.length;r++)i.set(t[r],n),n+=t[r].length;return i;case"nodebuffer":return Buffer.concat(t);default:throw new Error("concat : unsupported type '"+e+"'")}}function accumulate(e,o){return new s.Promise(function(t,r){var n=[],i=e._internalType,a=e._outputType,s=e._mimeType;e.on("data",function(e,t){n.push(e),o&&o(t)}).on("error",function(e){n=[],r(e)}).on("end",function(){try{var e=function transformZipOutput(e,t,r,n){var i=null;switch(e){case"blob":return u.newBlob(r,n);case"base64":return i=concat(t,r),l.encode(i);default:return i=concat(t,r),u.transformTo(e,i)}}(a,i,n,s);t(e)}catch(e){r(e)}n=[]}).resume()})}function StreamHelper(e,t,r){var n=t;switch(t){case"blob":n="arraybuffer";break;case"arraybuffer":n="uint8array";break;case"base64":n="string"}try{this._internalType=n,this._outputType=t,this._mimeType=r,u.checkSupport(n),this._worker=e.pipe(new i(n)),e.lock()}catch(e){this._worker=new a("error"),this._worker.error(e)}}StreamHelper.prototype={accumulate:function(e){return accumulate(this,e)},on:function(e,t){var r=this;return"data"===e?this._worker.on(e,function(e){t.call(r,e.data,e.meta)}):this._worker.on(e,function(){u.delay(t,arguments,r)}),this},resume:function(){return u.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(e){if(u.checkSupport("nodestream"),"nodebuffer"!==this._outputType)throw new Error(this._outputType+" is not supported by this method");return new o(this,{objectMode:"nodebuffer"!==this._outputType},e)}},t.exports=StreamHelper},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,t,r){"use strict";if(r.base64=!0,r.array=!0,r.string=!0,r.arraybuffer="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof Uint8Array,r.nodebuffer="undefined"!=typeof Buffer,r.uint8array="undefined"!=typeof Uint8Array,"undefined"==typeof ArrayBuffer)r.blob=!1;else{var n=new ArrayBuffer(0);try{r.blob=0===new Blob([n],{type:"application/zip"}).size}catch(e){try{var i=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder);i.append(n),r.blob=0===i.getBlob("application/zip").size}catch(e){r.blob=!1}}}try{r.nodestream=!!e("readable-stream").Readable}catch(e){r.nodestream=!1}},{"readable-stream":16}],31:[function(e,t,a){"use strict";for(var o=e("./utils"),u=e("./support"),r=e("./nodejsUtils"),n=e("./stream/GenericWorker"),l=new Array(256),i=0;i<256;i++)l[i]=252<=i?6:248<=i?5:240<=i?4:224<=i?3:192<=i?2:1;l[254]=l[254]=1;function Utf8DecodeWorker(){n.call(this,"utf-8 decode"),this.leftOver=null}function Utf8EncodeWorker(){n.call(this,"utf-8 encode")}a.utf8encode=function utf8encode(e){return u.nodebuffer?r.newBuffer(e,"utf-8"):function(e){var t,r,n,i,a,s=e.length,o=0;for(i=0;i<s;i++)55296==(64512&(r=e.charCodeAt(i)))&&i+1<s&&56320==(64512&(n=e.charCodeAt(i+1)))&&(r=65536+(r-55296<<10)+(n-56320),i++),o+=r<128?1:r<2048?2:r<65536?3:4;for(t=u.uint8array?new Uint8Array(o):new Array(o),i=a=0;a<o;i++)55296==(64512&(r=e.charCodeAt(i)))&&i+1<s&&56320==(64512&(n=e.charCodeAt(i+1)))&&(r=65536+(r-55296<<10)+(n-56320),i++),t[a++]=r<128?r:(t[a++]=r<2048?192|r>>>6:(t[a++]=r<65536?224|r>>>12:(t[a++]=240|r>>>18,128|r>>>12&63),128|r>>>6&63),128|63&r);return t}(e)},a.utf8decode=function utf8decode(e){return u.nodebuffer?o.transformTo("nodebuffer",e).toString("utf-8"):function(e){var t,r,n,i,a=e.length,s=new Array(2*a);for(t=r=0;t<a;)if((n=e[t++])<128)s[r++]=n;else if(4<(i=l[n]))s[r++]=65533,t+=i-1;else{for(n&=2===i?31:3===i?15:7;1<i&&t<a;)n=n<<6|63&e[t++],i--;s[r++]=1<i?65533:n<65536?n:(n-=65536,s[r++]=55296|n>>10&1023,56320|1023&n)}return s.length!==r&&(s.subarray?s=s.subarray(0,r):s.length=r),o.applyFromCharCode(s)}(e=o.transformTo(u.uint8array?"uint8array":"array",e))},o.inherits(Utf8DecodeWorker,n),Utf8DecodeWorker.prototype.processChunk=function(e){var t=o.transformTo(u.uint8array?"uint8array":"array",e.data);if(this.leftOver&&this.leftOver.length){if(u.uint8array){var r=t;(t=new Uint8Array(r.length+this.leftOver.length)).set(this.leftOver,0),t.set(r,this.leftOver.length)}else t=this.leftOver.concat(t);this.leftOver=null}var n=function(e,t){var r;for((t=t||e.length)>e.length&&(t=e.length),r=t-1;0<=r&&128==(192&e[r]);)r--;return r<0?t:0===r?t:r+l[e[r]]>t?r:t}(t),i=t;n!==t.length&&(u.uint8array?(i=t.subarray(0,n),this.leftOver=t.subarray(n,t.length)):(i=t.slice(0,n),this.leftOver=t.slice(n,t.length))),this.push({data:a.utf8decode(i),meta:e.meta})},Utf8DecodeWorker.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:a.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},a.Utf8DecodeWorker=Utf8DecodeWorker,o.inherits(Utf8EncodeWorker,n),Utf8EncodeWorker.prototype.processChunk=function(e){this.push({data:a.utf8encode(e.data),meta:e.meta})},a.Utf8EncodeWorker=Utf8EncodeWorker},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,t,s){"use strict";var o=e("./support"),u=e("./base64"),r=e("./nodejsUtils"),n=e("core-js/library/fn/set-immediate"),l=e("./external");function identity(e){return e}function stringToArrayLike(e,t){for(var r=0;r<e.length;++r)t[r]=255&e.charCodeAt(r);return t}s.newBlob=function(t,r){s.checkSupport("blob");try{return new Blob(t,{type:r})}catch(e){try{for(var n=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder),i=0;i<t.length;i++)n.append(t[i]);return n.getBlob(r)}catch(e){throw new Error("Bug : can't construct the Blob.")}}};var i={stringifyByChunk:function(e,t,r){var n=[],i=0,a=e.length;if(a<=r)return String.fromCharCode.apply(null,e);for(;i<a;)"array"===t||"nodebuffer"===t?n.push(String.fromCharCode.apply(null,e.slice(i,Math.min(i+r,a)))):n.push(String.fromCharCode.apply(null,e.subarray(i,Math.min(i+r,a)))),i+=r;return n.join("")},stringifyByChar:function(e){for(var t="",r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return t},applyCanBeUsed:{uint8array:function(){try{return o.uint8array&&1===String.fromCharCode.apply(null,new Uint8Array(1)).length}catch(e){return!1}}(),nodebuffer:function(){try{return o.nodebuffer&&1===String.fromCharCode.apply(null,r.newBuffer(1)).length}catch(e){return!1}}()}};function arrayLikeToString(e){var t=65536,r=s.getTypeOf(e),n=!0;if("uint8array"===r?n=i.applyCanBeUsed.uint8array:"nodebuffer"===r&&(n=i.applyCanBeUsed.nodebuffer),n)for(;1<t;)try{return i.stringifyByChunk(e,r,t)}catch(e){t=Math.floor(t/2)}return i.stringifyByChar(e)}function arrayLikeToArrayLike(e,t){for(var r=0;r<e.length;r++)t[r]=e[r];return t}s.applyFromCharCode=arrayLikeToString;var a={};a.string={string:identity,array:function(e){return stringToArrayLike(e,new Array(e.length))},arraybuffer:function(e){return a.string.uint8array(e).buffer},uint8array:function(e){return stringToArrayLike(e,new Uint8Array(e.length))},nodebuffer:function(e){return stringToArrayLike(e,r.newBuffer(e.length))}},a.array={string:arrayLikeToString,array:identity,arraybuffer:function(e){return new Uint8Array(e).buffer},uint8array:function(e){return new Uint8Array(e)},nodebuffer:function(e){return r.newBuffer(e)}},a.arraybuffer={string:function(e){return arrayLikeToString(new Uint8Array(e))},array:function(e){return arrayLikeToArrayLike(new Uint8Array(e),new Array(e.byteLength))},arraybuffer:identity,uint8array:function(e){return new Uint8Array(e)},nodebuffer:function(e){return r.newBuffer(new Uint8Array(e))}},a.uint8array={string:arrayLikeToString,array:function(e){return arrayLikeToArrayLike(e,new Array(e.length))},arraybuffer:function(e){var t=new Uint8Array(e.length);return e.length&&t.set(e,0),t.buffer},uint8array:identity,nodebuffer:function(e){return r.newBuffer(e)}},a.nodebuffer={string:arrayLikeToString,array:function(e){return arrayLikeToArrayLike(e,new Array(e.length))},arraybuffer:function(e){return a.nodebuffer.uint8array(e).buffer},uint8array:function(e){return arrayLikeToArrayLike(e,new Uint8Array(e.length))},nodebuffer:identity},s.transformTo=function(e,t){if(t||(t=""),!e)return t;s.checkSupport(e);var r=s.getTypeOf(t);return a[r][e](t)},s.getTypeOf=function(e){return"string"==typeof e?"string":"[object Array]"===Object.prototype.toString.call(e)?"array":o.nodebuffer&&r.isBuffer(e)?"nodebuffer":o.uint8array&&e instanceof Uint8Array?"uint8array":o.arraybuffer&&e instanceof ArrayBuffer?"arraybuffer":void 0},s.checkSupport=function(e){if(!o[e.toLowerCase()])throw new Error(e+" is not supported by this platform")},s.MAX_VALUE_16BITS=65535,s.MAX_VALUE_32BITS=-1,s.pretty=function(e){var t,r,n="";for(r=0;r<(e||"").length;r++)n+="\\x"+((t=e.charCodeAt(r))<16?"0":"")+t.toString(16).toUpperCase();return n},s.delay=function(e,t,r){n(function(){e.apply(r||null,t||[])})},s.inherits=function(e,t){var r=function(){};r.prototype=t.prototype,e.prototype=new r},s.extend=function(){var e,t,r={};for(e=0;e<arguments.length;e++)for(t in arguments[e])arguments[e].hasOwnProperty(t)&&void 0===r[t]&&(r[t]=arguments[e][t]);return r},s.prepareContent=function(r,e,n,i,a){return l.Promise.resolve(e).then(function(n){return o.blob&&(n instanceof Blob||-1!==["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(n)))&&"undefined"!=typeof FileReader?new l.Promise(function(t,r){var e=new FileReader;e.onload=function(e){t(e.target.result)},e.onerror=function(e){r(e.target.error)},e.readAsArrayBuffer(n)}):n}).then(function(e){var t=s.getTypeOf(e);return t?("arraybuffer"===t?e=s.transformTo("uint8array",e):"string"===t&&(a?e=u.decode(e):n&&!0!==i&&(e=function string2binary(e){return stringToArrayLike(e,o.uint8array?new Uint8Array(e.length):new Array(e.length))}(e))),e):l.Promise.reject(new Error("The data of '"+r+"' is in an unsupported format !"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,"core-js/library/fn/set-immediate":36}],33:[function(e,t,r){"use strict";var n=e("./reader/readerFor"),i=e("./utils"),a=e("./signature"),s=e("./zipEntry"),o=(e("./utf8"),e("./support"));function ZipEntries(e){this.files=[],this.loadOptions=e}ZipEntries.prototype={checkSignature:function(e){if(!this.reader.readAndCheckSignature(e)){this.reader.index-=4;var t=this.reader.readString(4);throw new Error("Corrupted zip or bug : unexpected signature ("+i.pretty(t)+", expected "+i.pretty(e)+")")}},isSignature:function(e,t){var r=this.reader.index;this.reader.setIndex(e);var n=this.reader.readString(4)===t;return this.reader.setIndex(r),n},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var e=this.reader.readData(this.zipCommentLength),t=o.uint8array?"uint8array":"array",r=i.transformTo(t,e);this.zipComment=this.loadOptions.decodeFileName(r)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var e,t,r,n=this.zip64EndOfCentralSize-44;0<n;)e=this.reader.readInt(2),t=this.reader.readInt(4),r=this.reader.readData(t),this.zip64ExtensibleData[e]={id:e,length:t,value:r}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var e,t;for(e=0;e<this.files.length;e++)t=this.files[e],this.reader.setIndex(t.localHeaderOffset),this.checkSignature(a.LOCAL_FILE_HEADER),t.readLocalPart(this.reader),t.handleUTF8(),t.processAttributes()},readCentralDir:function(){var e;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(a.CENTRAL_FILE_HEADER);)(e=new s({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(e);if(this.centralDirRecords!==this.files.length&&0!==this.centralDirRecords&&0===this.files.length)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var e=this.reader.lastIndexOfSignature(a.CENTRAL_DIRECTORY_END);if(e<0)throw!this.isSignature(0,a.LOCAL_FILE_HEADER)?new Error("Can't find end of central directory : is this a zip file ? If it is, see http://stuk.github.io/jszip/documentation/howto/read_zip.html"):new Error("Corrupted zip : can't find end of central directory");this.reader.setIndex(e);var t=e;if(this.checkSignature(a.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===i.MAX_VALUE_16BITS||this.diskWithCentralDirStart===i.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===i.MAX_VALUE_16BITS||this.centralDirRecords===i.MAX_VALUE_16BITS||this.centralDirSize===i.MAX_VALUE_32BITS||this.centralDirOffset===i.MAX_VALUE_32BITS){if(this.zip64=!0,(e=this.reader.lastIndexOfSignature(a.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip : can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(e),this.checkSignature(a.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,a.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(a.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip : can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(a.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var r=this.centralDirOffset+this.centralDirSize;this.zip64&&(r+=20,r+=12+this.zip64EndOfCentralSize);var n=t-r;if(0<n)this.isSignature(t,a.CENTRAL_FILE_HEADER)||(this.reader.zero=n);else if(n<0)throw new Error("Corrupted zip: missing "+Math.abs(n)+" bytes.")},prepareReader:function(e){this.reader=n(e)},load:function(e){this.prepareReader(e),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},t.exports=ZipEntries},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utf8":31,"./utils":32,"./zipEntry":34}],34:[function(e,t,r){"use strict";var n=e("./reader/readerFor"),a=e("./utils"),i=e("./compressedObject"),s=e("./crc32"),o=e("./utf8"),u=e("./compressions"),l=e("./support");function ZipEntry(e,t){this.options=e,this.loadOptions=t}ZipEntry.prototype={isEncrypted:function(){return 1==(1&this.bitFlag)},useUTF8:function(){return 2048==(2048&this.bitFlag)},readLocalPart:function(e){var t,r;if(e.skip(22),this.fileNameLength=e.readInt(2),r=e.readInt(2),this.fileName=e.readData(this.fileNameLength),e.skip(r),-1===this.compressedSize||-1===this.uncompressedSize)throw new Error("Bug or corrupted zip : didn't get enough informations from the central directory (compressedSize === -1 || uncompressedSize === -1)");if(null===(t=function(e){for(var t in u)if(u.hasOwnProperty(t)&&u[t].magic===e)return u[t];return null}(this.compressionMethod)))throw new Error("Corrupted zip : compression "+a.pretty(this.compressionMethod)+" unknown (inner file : "+a.transformTo("string",this.fileName)+")");this.decompressed=new i(this.compressedSize,this.uncompressedSize,this.crc32,t,e.readData(this.compressedSize))},readCentralPart:function(e){this.versionMadeBy=e.readInt(2),e.skip(2),this.bitFlag=e.readInt(2),this.compressionMethod=e.readString(2),this.date=e.readDate(),this.crc32=e.readInt(4),this.compressedSize=e.readInt(4),this.uncompressedSize=e.readInt(4);var t=e.readInt(2);if(this.extraFieldsLength=e.readInt(2),this.fileCommentLength=e.readInt(2),this.diskNumberStart=e.readInt(2),this.internalFileAttributes=e.readInt(2),this.externalFileAttributes=e.readInt(4),this.localHeaderOffset=e.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");e.skip(t),this.readExtraFields(e),this.parseZIP64ExtraField(e),this.fileComment=e.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var e=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),0===e&&(this.dosPermissions=63&this.externalFileAttributes),3===e&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||"/"!==this.fileNameStr.slice(-1)||(this.dir=!0)},parseZIP64ExtraField:function(e){if(this.extraFields[1]){var t=n(this.extraFields[1].value);this.uncompressedSize===a.MAX_VALUE_32BITS&&(this.uncompressedSize=t.readInt(8)),this.compressedSize===a.MAX_VALUE_32BITS&&(this.compressedSize=t.readInt(8)),this.localHeaderOffset===a.MAX_VALUE_32BITS&&(this.localHeaderOffset=t.readInt(8)),this.diskNumberStart===a.MAX_VALUE_32BITS&&(this.diskNumberStart=t.readInt(4))}},readExtraFields:function(e){var t,r,n,i=e.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});e.index<i;)t=e.readInt(2),r=e.readInt(2),n=e.readData(r),this.extraFields[t]={id:t,length:r,value:n}},handleUTF8:function(){var e=l.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=o.utf8decode(this.fileName),this.fileCommentStr=o.utf8decode(this.fileComment);else{var t=this.findExtraFieldUnicodePath();if(null!==t)this.fileNameStr=t;else{var r=a.transformTo(e,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(r)}var n=this.findExtraFieldUnicodeComment();if(null!==n)this.fileCommentStr=n;else{var i=a.transformTo(e,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(i)}}},findExtraFieldUnicodePath:function(){var e=this.extraFields[28789];if(e){var t=n(e.value);return 1!==t.readInt(1)?null:s(this.fileName)!==t.readInt(4)?null:o.utf8decode(t.readData(e.length-5))}return null},findExtraFieldUnicodeComment:function(){var e=this.extraFields[25461];if(e){var t=n(e.value);return 1!==t.readInt(1)?null:s(this.fileComment)!==t.readInt(4)?null:o.utf8decode(t.readData(e.length-5))}return null}},t.exports=ZipEntry},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(e,t,r){"use strict";var a=e("./stream/StreamHelper"),n=e("./stream/DataWorker"),s=e("./utf8"),i=e("./compressedObject"),o=e("./stream/GenericWorker"),u=function(e,t,r){this.name=e,this.dir=r.dir,this.date=r.date,this.comment=r.comment,this.unixPermissions=r.unixPermissions,this.dosPermissions=r.dosPermissions,this._data=t,this._dataBinary=r.binary,this.options={compression:r.compression,compressionOptions:r.compressionOptions}};u.prototype={internalStream:function(e){var t=e.toLowerCase(),r="string"===t||"text"===t;"binarystring"!==t&&"text"!==t||(t="string");var n=this._decompressWorker(),i=!this._dataBinary;return i&&!r&&(n=n.pipe(new s.Utf8EncodeWorker)),!i&&r&&(n=n.pipe(new s.Utf8DecodeWorker)),new a(n,t,"")},async:function(e,t){return this.internalStream(e).accumulate(t)},nodeStream:function(e,t){return this.internalStream(e||"nodebuffer").toNodejsStream(t)},_compressWorker:function(e,t){if(this._data instanceof i&&this._data.compression.magic===e.magic)return this._data.getCompressedWorker();var r=this._decompressWorker();return this._dataBinary||(r=r.pipe(new s.Utf8EncodeWorker)),i.createWorkerFrom(r,e,t)},_decompressWorker:function(){return this._data instanceof i?this._data.getContentWorker():this._data instanceof o?this._data:new n(this._data)}};for(var l=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],h=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},d=0;d<l.length;d++)u.prototype[l[d]]=h;t.exports=u},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(e,t,r){e("../modules/web.immediate"),t.exports=e("../modules/_core").setImmediate},{"../modules/_core":40,"../modules/web.immediate":56}],37:[function(e,t,r){t.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},{}],38:[function(e,t,r){var n=e("./_is-object");t.exports=function(e){if(!n(e))throw TypeError(e+" is not an object!");return e}},{"./_is-object":51}],39:[function(e,t,r){var n={}.toString;t.exports=function(e){return n.call(e).slice(8,-1)}},{}],40:[function(e,t,r){var n=t.exports={version:"2.3.0"};"number"==typeof __e&&(__e=n)},{}],41:[function(e,t,r){var a=e("./_a-function");t.exports=function(n,i,e){if(a(n),void 0===i)return n;switch(e){case 1:return function(e){return n.call(i,e)};case 2:return function(e,t){return n.call(i,e,t)};case 3:return function(e,t,r){return n.call(i,e,t,r)}}return function(){return n.apply(i,arguments)}}},{"./_a-function":37}],42:[function(e,t,r){t.exports=!e("./_fails")(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},{"./_fails":45}],43:[function(e,t,r){var n=e("./_is-object"),i=e("./_global").document,a=n(i)&&n(i.createElement);t.exports=function(e){return a?i.createElement(e):{}}},{"./_global":46,"./_is-object":51}],44:[function(e,t,r){var _=e("./_global"),m=e("./_core"),g=e("./_ctx"),b=e("./_hide"),y="prototype",v=function(e,t,r){var n,i,a,s=e&v.F,o=e&v.G,u=e&v.S,l=e&v.P,h=e&v.B,d=e&v.W,f=o?m:m[t]||(m[t]={}),c=f[y],p=o?_:u?_[t]:(_[t]||{})[y];for(n in o&&(r=t),r)(i=!s&&p&&void 0!==p[n])&&n in f||(a=i?p[n]:r[n],f[n]=o&&"function"!=typeof p[n]?r[n]:h&&i?g(a,_):d&&p[n]==a?function(n){var e=function(e,t,r){if(this instanceof n){switch(arguments.length){case 0:return new n;case 1:return new n(e);case 2:return new n(e,t)}return new n(e,t,r)}return n.apply(this,arguments)};return e[y]=n[y],e}(a):l&&"function"==typeof a?g(Function.call,a):a,l&&((f.virtual||(f.virtual={}))[n]=a,e&v.R&&c&&!c[n]&&b(c,n,a)))};v.F=1,v.G=2,v.S=4,v.P=8,v.B=16,v.W=32,v.U=64,v.R=128,t.exports=v},{"./_core":40,"./_ctx":41,"./_global":46,"./_hide":47}],45:[function(e,t,r){t.exports=function(e){try{return!!e()}catch(e){return!0}}},{}],46:[function(e,t,r){var n=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=n)},{}],47:[function(e,t,r){var n=e("./_object-dp"),i=e("./_property-desc");t.exports=e("./_descriptors")?function(e,t,r){return n.f(e,t,i(1,r))}:function(e,t,r){return e[t]=r,e}},{"./_descriptors":42,"./_object-dp":52,"./_property-desc":53}],48:[function(e,t,r){t.exports=e("./_global").document&&document.documentElement},{"./_global":46}],49:[function(e,t,r){t.exports=!e("./_descriptors")&&!e("./_fails")(function(){return 7!=Object.defineProperty(e("./_dom-create")("div"),"a",{get:function(){return 7}}).a})},{"./_descriptors":42,"./_dom-create":43,"./_fails":45}],50:[function(e,t,r){t.exports=function(e,t,r){var n=void 0===r;switch(t.length){case 0:return n?e():e.call(r);case 1:return n?e(t[0]):e.call(r,t[0]);case 2:return n?e(t[0],t[1]):e.call(r,t[0],t[1]);case 3:return n?e(t[0],t[1],t[2]):e.call(r,t[0],t[1],t[2]);case 4:return n?e(t[0],t[1],t[2],t[3]):e.call(r,t[0],t[1],t[2],t[3])}return e.apply(r,t)}},{}],51:[function(e,t,r){t.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},{}],52:[function(e,t,r){var n=e("./_an-object"),i=e("./_ie8-dom-define"),a=e("./_to-primitive"),s=Object.defineProperty;r.f=e("./_descriptors")?Object.defineProperty:function defineProperty(e,t,r){if(n(e),t=a(t,!0),n(r),i)try{return s(e,t,r)}catch(e){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(e[t]=r.value),e}},{"./_an-object":38,"./_descriptors":42,"./_ie8-dom-define":49,"./_to-primitive":55}],53:[function(e,t,r){t.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},{}],54:[function(e,t,r){var n,i,a,s=e("./_ctx"),o=e("./_invoke"),u=e("./_html"),l=e("./_dom-create"),h=e("./_global"),d=h.process,f=h.setImmediate,c=h.clearImmediate,p=h.MessageChannel,_=0,m={},g="onreadystatechange",b=function(){var e=+this;if(m.hasOwnProperty(e)){var t=m[e];delete m[e],t()}},y=function(e){b.call(e.data)};f&&c||(f=function setImmediate(e){for(var t=[],r=1;arguments.length>r;)t.push(arguments[r++]);return m[++_]=function(){o("function"==typeof e?e:Function(e),t)},n(_),_},c=function clearImmediate(e){delete m[e]},"process"==e("./_cof")(d)?n=function(e){d.nextTick(s(b,e,1))}:p?(a=(i=new p).port2,i.port1.onmessage=y,n=s(a.postMessage,a,1)):h.addEventListener&&"function"==typeof postMessage&&!h.importScripts?(n=function(e){h.postMessage(e+"","*")},h.addEventListener("message",y,!1)):n=g in l("script")?function(e){u.appendChild(l("script"))[g]=function(){u.removeChild(this),b.call(e)}}:function(e){setTimeout(s(b,e,1),0)}),t.exports={set:f,clear:c}},{"./_cof":39,"./_ctx":41,"./_dom-create":43,"./_global":46,"./_html":48,"./_invoke":50}],55:[function(e,t,r){var i=e("./_is-object");t.exports=function(e,t){if(!i(e))return e;var r,n;if(t&&"function"==typeof(r=e.toString)&&!i(n=r.call(e)))return n;if("function"==typeof(r=e.valueOf)&&!i(n=r.call(e)))return n;if(!t&&"function"==typeof(r=e.toString)&&!i(n=r.call(e)))return n;throw TypeError("Can't convert object to primitive value")}},{"./_is-object":51}],56:[function(e,t,r){var n=e("./_export"),i=e("./_task");n(n.G+n.B,{setImmediate:i.set,clearImmediate:i.clear})},{"./_export":44,"./_task":54}],57:[function(e,l,t){(function(t){"use strict";var r,n,e=t.MutationObserver||t.WebKitMutationObserver;if(e){var i=0,a=new e(nextTick),s=t.document.createTextNode("");a.observe(s,{characterData:!0}),r=function(){s.data=i=++i%2}}else if(t.setImmediate||void 0===t.MessageChannel)r="document"in t&&"onreadystatechange"in t.document.createElement("script")?function(){var e=t.document.createElement("script");e.onreadystatechange=function(){nextTick(),e.onreadystatechange=null,e.parentNode.removeChild(e),e=null},t.document.documentElement.appendChild(e)}:function(){setTimeout(nextTick,0)};else{var o=new t.MessageChannel;o.port1.onmessage=nextTick,r=function(){o.port2.postMessage(0)}}var u=[];function nextTick(){var e,t;n=!0;for(var r=u.length;r;){for(t=u,u=[],e=-1;++e<r;)t[e]();r=u.length}n=!1}l.exports=function immediate(e){1!==u.push(e)||n||r()}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],58:[function(e,t,r){"use strict";var i=e("immediate");function INTERNAL(){}var u={},a=["REJECTED"],s=["FULFILLED"],n=["PENDING"];function Promise(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=n,this.queue=[],this.outcome=void 0,e!==INTERNAL&&safelyResolveThenable(this,e)}function QueueItem(e,t,r){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof r&&(this.onRejected=r,this.callRejected=this.otherCallRejected)}function unwrap(t,r,n){i(function(){var e;try{e=r(n)}catch(e){return u.reject(t,e)}e===t?u.reject(t,new TypeError("Cannot resolve promise with itself")):u.resolve(t,e)})}function getThen(e){var t=e&&e.then;if(e&&"object"==typeof e&&"function"==typeof t)return function appyThen(){t.apply(e,arguments)}}function safelyResolveThenable(t,e){var r=!1;function onError(e){r||(r=!0,u.reject(t,e))}function onSuccess(e){r||(r=!0,u.resolve(t,e))}var n=tryCatch(function tryToUnwrap(){e(onSuccess,onError)});"error"===n.status&&onError(n.value)}function tryCatch(e,t){var r={};try{r.value=e(t),r.status="success"}catch(e){r.status="error",r.value=e}return r}(t.exports=Promise).prototype.catch=function(e){return this.then(null,e)},Promise.prototype.then=function(e,t){if("function"!=typeof e&&this.state===s||"function"!=typeof t&&this.state===a)return this;var r=new this.constructor(INTERNAL);this.state!==n?unwrap(r,this.state===s?e:t,this.outcome):this.queue.push(new QueueItem(r,e,t));return r},QueueItem.prototype.callFulfilled=function(e){u.resolve(this.promise,e)},QueueItem.prototype.otherCallFulfilled=function(e){unwrap(this.promise,this.onFulfilled,e)},QueueItem.prototype.callRejected=function(e){u.reject(this.promise,e)},QueueItem.prototype.otherCallRejected=function(e){unwrap(this.promise,this.onRejected,e)},u.resolve=function(e,t){var r=tryCatch(getThen,t);if("error"===r.status)return u.reject(e,r.value);var n=r.value;if(n)safelyResolveThenable(e,n);else{e.state=s,e.outcome=t;for(var i=-1,a=e.queue.length;++i<a;)e.queue[i].callFulfilled(t)}return e},u.reject=function(e,t){e.state=a,e.outcome=t;for(var r=-1,n=e.queue.length;++r<n;)e.queue[r].callRejected(t);return e},Promise.resolve=function resolve(e){if(e instanceof this)return e;return u.resolve(new this(INTERNAL),e)},Promise.reject=function reject(e){var t=new this(INTERNAL);return u.reject(t,e)},Promise.all=function all(e){var r=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var n=e.length,i=!1;if(!n)return this.resolve([]);var a=new Array(n),s=0,t=-1,o=new this(INTERNAL);for(;++t<n;)allResolver(e[t],t);return o;function allResolver(e,t){r.resolve(e).then(function resolveFromAll(e){a[t]=e,++s!==n||i||(i=!0,u.resolve(o,a))},function(e){i||(i=!0,u.reject(o,e))})}},Promise.race=function race(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var r=e.length,n=!1;if(!r)return this.resolve([]);var i=-1,a=new this(INTERNAL);for(;++i<r;)s=e[i],t.resolve(s).then(function(e){n||(n=!0,u.resolve(a,e))},function(e){n||(n=!0,u.reject(a,e))});var s;return a}},{immediate:57}],59:[function(e,t,r){"use strict";var n={};(0,e("./lib/utils/common").assign)(n,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),t.exports=n},{"./lib/deflate":60,"./lib/inflate":61,"./lib/utils/common":62,"./lib/zlib/constants":65}],60:[function(e,t,r){"use strict";var s=e("./zlib/deflate"),o=e("./utils/common"),u=e("./utils/strings"),i=e("./zlib/messages"),a=e("./zlib/zstream"),l=Object.prototype.toString,h=0,d=-1,f=0,c=8;function Deflate(e){if(!(this instanceof Deflate))return new Deflate(e);this.options=o.assign({level:d,method:c,chunkSize:16384,windowBits:15,memLevel:8,strategy:f,to:""},e||{});var t=this.options;t.raw&&0<t.windowBits?t.windowBits=-t.windowBits:t.gzip&&0<t.windowBits&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new a,this.strm.avail_out=0;var r=s.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(r!==h)throw new Error(i[r]);if(t.header&&s.deflateSetHeader(this.strm,t.header),t.dictionary){var n;if(n="string"==typeof t.dictionary?u.string2buf(t.dictionary):"[object ArrayBuffer]"===l.call(t.dictionary)?new Uint8Array(t.dictionary):t.dictionary,(r=s.deflateSetDictionary(this.strm,n))!==h)throw new Error(i[r]);this._dict_set=!0}}function deflate(e,t){var r=new Deflate(t);if(r.push(e,!0),r.err)throw r.msg;return r.result}Deflate.prototype.push=function(e,t){var r,n,i=this.strm,a=this.options.chunkSize;if(this.ended)return!1;n=t===~~t?t:!0===t?4:0,"string"==typeof e?i.input=u.string2buf(e):"[object ArrayBuffer]"===l.call(e)?i.input=new Uint8Array(e):i.input=e,i.next_in=0,i.avail_in=i.input.length;do{if(0===i.avail_out&&(i.output=new o.Buf8(a),i.next_out=0,i.avail_out=a),1!==(r=s.deflate(i,n))&&r!==h)return this.onEnd(r),!(this.ended=!0);0!==i.avail_out&&(0!==i.avail_in||4!==n&&2!==n)||("string"===this.options.to?this.onData(u.buf2binstring(o.shrinkBuf(i.output,i.next_out))):this.onData(o.shrinkBuf(i.output,i.next_out)))}while((0<i.avail_in||0===i.avail_out)&&1!==r);return 4===n?(r=s.deflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===h):2!==n||(this.onEnd(h),!(i.avail_out=0))},Deflate.prototype.onData=function(e){this.chunks.push(e)},Deflate.prototype.onEnd=function(e){e===h&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=o.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},r.Deflate=Deflate,r.deflate=deflate,r.deflateRaw=function deflateRaw(e,t){return(t=t||{}).raw=!0,deflate(e,t)},r.gzip=function gzip(e,t){return(t=t||{}).gzip=!0,deflate(e,t)}},{"./utils/common":62,"./utils/strings":63,"./zlib/deflate":67,"./zlib/messages":72,"./zlib/zstream":74}],61:[function(e,t,r){"use strict";var f=e("./zlib/inflate"),c=e("./utils/common"),p=e("./utils/strings"),_=e("./zlib/constants"),n=e("./zlib/messages"),i=e("./zlib/zstream"),a=e("./zlib/gzheader"),m=Object.prototype.toString;function Inflate(e){if(!(this instanceof Inflate))return new Inflate(e);this.options=c.assign({chunkSize:16384,windowBits:0,to:""},e||{});var t=this.options;t.raw&&0<=t.windowBits&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(0<=t.windowBits&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),15<t.windowBits&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new i,this.strm.avail_out=0;var r=f.inflateInit2(this.strm,t.windowBits);if(r!==_.Z_OK)throw new Error(n[r]);this.header=new a,f.inflateGetHeader(this.strm,this.header)}function inflate(e,t){var r=new Inflate(t);if(r.push(e,!0),r.err)throw r.msg;return r.result}Inflate.prototype.push=function(e,t){var r,n,i,a,s,o,u=this.strm,l=this.options.chunkSize,h=this.options.dictionary,d=!1;if(this.ended)return!1;n=t===~~t?t:!0===t?_.Z_FINISH:_.Z_NO_FLUSH,"string"==typeof e?u.input=p.binstring2buf(e):"[object ArrayBuffer]"===m.call(e)?u.input=new Uint8Array(e):u.input=e,u.next_in=0,u.avail_in=u.input.length;do{if(0===u.avail_out&&(u.output=new c.Buf8(l),u.next_out=0,u.avail_out=l),(r=f.inflate(u,_.Z_NO_FLUSH))===_.Z_NEED_DICT&&h&&(o="string"==typeof h?p.string2buf(h):"[object ArrayBuffer]"===m.call(h)?new Uint8Array(h):h,r=f.inflateSetDictionary(this.strm,o)),r===_.Z_BUF_ERROR&&!0===d&&(r=_.Z_OK,d=!1),r!==_.Z_STREAM_END&&r!==_.Z_OK)return this.onEnd(r),!(this.ended=!0);u.next_out&&(0!==u.avail_out&&r!==_.Z_STREAM_END&&(0!==u.avail_in||n!==_.Z_FINISH&&n!==_.Z_SYNC_FLUSH)||("string"===this.options.to?(i=p.utf8border(u.output,u.next_out),a=u.next_out-i,s=p.buf2string(u.output,i),u.next_out=a,u.avail_out=l-a,a&&c.arraySet(u.output,u.output,i,a,0),this.onData(s)):this.onData(c.shrinkBuf(u.output,u.next_out)))),0===u.avail_in&&0===u.avail_out&&(d=!0)}while((0<u.avail_in||0===u.avail_out)&&r!==_.Z_STREAM_END);return r===_.Z_STREAM_END&&(n=_.Z_FINISH),n===_.Z_FINISH?(r=f.inflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===_.Z_OK):n!==_.Z_SYNC_FLUSH||(this.onEnd(_.Z_OK),!(u.avail_out=0))},Inflate.prototype.onData=function(e){this.chunks.push(e)},Inflate.prototype.onEnd=function(e){e===_.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=c.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},r.Inflate=Inflate,r.inflate=inflate,r.inflateRaw=function inflateRaw(e,t){return(t=t||{}).raw=!0,inflate(e,t)},r.ungzip=inflate},{"./utils/common":62,"./utils/strings":63,"./zlib/constants":65,"./zlib/gzheader":68,"./zlib/inflate":70,"./zlib/messages":72,"./zlib/zstream":74}],62:[function(e,t,r){"use strict";var n="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;r.assign=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var r=t.shift();if(r){if("object"!=typeof r)throw new TypeError(r+"must be non-object");for(var n in r)r.hasOwnProperty(n)&&(e[n]=r[n])}}return e},r.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var i={arraySet:function(e,t,r,n,i){if(t.subarray&&e.subarray)e.set(t.subarray(r,r+n),i);else for(var a=0;a<n;a++)e[i+a]=t[r+a]},flattenChunks:function(e){var t,r,n,i,a,s;for(t=n=0,r=e.length;t<r;t++)n+=e[t].length;for(s=new Uint8Array(n),t=i=0,r=e.length;t<r;t++)a=e[t],s.set(a,i),i+=a.length;return s}},a={arraySet:function(e,t,r,n,i){for(var a=0;a<n;a++)e[i+a]=t[r+a]},flattenChunks:function(e){return[].concat.apply([],e)}};r.setTyped=function(e){e?(r.Buf8=Uint8Array,r.Buf16=Uint16Array,r.Buf32=Int32Array,r.assign(r,i)):(r.Buf8=Array,r.Buf16=Array,r.Buf32=Array,r.assign(r,a))},r.setTyped(n)},{}],63:[function(e,t,r){"use strict";var u=e("./common"),i=!0,a=!0;try{String.fromCharCode.apply(null,[0])}catch(e){i=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){a=!1}for(var l=new u.Buf8(256),n=0;n<256;n++)l[n]=252<=n?6:248<=n?5:240<=n?4:224<=n?3:192<=n?2:1;function buf2binstring(e,t){if(t<65537&&(e.subarray&&a||!e.subarray&&i))return String.fromCharCode.apply(null,u.shrinkBuf(e,t));for(var r="",n=0;n<t;n++)r+=String.fromCharCode(e[n]);return r}l[254]=l[254]=1,r.string2buf=function(e){var t,r,n,i,a,s=e.length,o=0;for(i=0;i<s;i++)55296==(64512&(r=e.charCodeAt(i)))&&i+1<s&&56320==(64512&(n=e.charCodeAt(i+1)))&&(r=65536+(r-55296<<10)+(n-56320),i++),o+=r<128?1:r<2048?2:r<65536?3:4;for(t=new u.Buf8(o),i=a=0;a<o;i++)55296==(64512&(r=e.charCodeAt(i)))&&i+1<s&&56320==(64512&(n=e.charCodeAt(i+1)))&&(r=65536+(r-55296<<10)+(n-56320),i++),t[a++]=r<128?r:(t[a++]=r<2048?192|r>>>6:(t[a++]=r<65536?224|r>>>12:(t[a++]=240|r>>>18,128|r>>>12&63),128|r>>>6&63),128|63&r);return t},r.buf2binstring=function(e){return buf2binstring(e,e.length)},r.binstring2buf=function(e){for(var t=new u.Buf8(e.length),r=0,n=t.length;r<n;r++)t[r]=e.charCodeAt(r);return t},r.buf2string=function(e,t){var r,n,i,a,s=t||e.length,o=new Array(2*s);for(r=n=0;r<s;)if((i=e[r++])<128)o[n++]=i;else if(4<(a=l[i]))o[n++]=65533,r+=a-1;else{for(i&=2===a?31:3===a?15:7;1<a&&r<s;)i=i<<6|63&e[r++],a--;o[n++]=1<a?65533:i<65536?i:(i-=65536,o[n++]=55296|i>>10&1023,56320|1023&i)}return buf2binstring(o,n)},r.utf8border=function(e,t){var r;for((t=t||e.length)>e.length&&(t=e.length),r=t-1;0<=r&&128==(192&e[r]);)r--;return r<0?t:0===r?t:r+l[e[r]]>t?r:t}},{"./common":62}],64:[function(e,t,r){"use strict";t.exports=function adler32(e,t,r,n){for(var i=65535&e|0,a=e>>>16&65535|0,s=0;0!==r;){for(r-=s=2e3<r?2e3:r;a=a+(i=i+t[n++]|0)|0,--s;);i%=65521,a%=65521}return i|a<<16|0}},{}],65:[function(e,t,r){"use strict";t.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],66:[function(e,t,r){"use strict";var o=function makeTable(){for(var e,t=[],r=0;r<256;r++){e=r;for(var n=0;n<8;n++)e=1&e?3988292384^e>>>1:e>>>1;t[r]=e}return t}();t.exports=function crc32(e,t,r,n){var i=o,a=n+r;e^=-1;for(var s=n;s<a;s++)e=e>>>8^i[255&(e^t[s])];return-1^e}},{}],67:[function(e,t,r){"use strict";var u,f=e("../utils/common"),l=e("./trees"),c=e("./adler32"),p=e("./crc32"),n=e("./messages"),h=0,d=4,_=0,m=-2,g=-1,b=4,i=2,y=8,v=9,a=286,s=30,o=19,w=2*a+1,k=15,x=3,S=258,z=S+x+1,C=42,A=113,E=1,I=2,R=3,T=4;function err(e,t){return e.msg=n[t],t}function rank(e){return(e<<1)-(4<e?9:0)}function zero(e){for(var t=e.length;0<=--t;)e[t]=0}function flush_pending(e){var t=e.state,r=t.pending;r>e.avail_out&&(r=e.avail_out),0!==r&&(f.arraySet(e.output,t.pending_buf,t.pending_out,r,e.next_out),e.next_out+=r,t.pending_out+=r,e.total_out+=r,e.avail_out-=r,t.pending-=r,0===t.pending&&(t.pending_out=0))}function flush_block_only(e,t){l._tr_flush_block(e,0<=e.block_start?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,flush_pending(e.strm)}function put_byte(e,t){e.pending_buf[e.pending++]=t}function putShortMSB(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function longest_match(e,t){var r,n,i=e.max_chain_length,a=e.strstart,s=e.prev_length,o=e.nice_match,u=e.strstart>e.w_size-z?e.strstart-(e.w_size-z):0,l=e.window,h=e.w_mask,d=e.prev,f=e.strstart+S,c=l[a+s-1],p=l[a+s];e.prev_length>=e.good_match&&(i>>=2),o>e.lookahead&&(o=e.lookahead);do{if(l[(r=t)+s]===p&&l[r+s-1]===c&&l[r]===l[a]&&l[++r]===l[a+1]){a+=2,r++;do{}while(l[++a]===l[++r]&&l[++a]===l[++r]&&l[++a]===l[++r]&&l[++a]===l[++r]&&l[++a]===l[++r]&&l[++a]===l[++r]&&l[++a]===l[++r]&&l[++a]===l[++r]&&a<f);if(n=S-(f-a),a=f-S,s<n){if(e.match_start=t,o<=(s=n))break;c=l[a+s-1],p=l[a+s]}}}while((t=d[t&h])>u&&0!=--i);return s<=e.lookahead?s:e.lookahead}function fill_window(e){var t,r,n,i,a,s,o,u,l,h,d=e.w_size;do{if(i=e.window_size-e.lookahead-e.strstart,e.strstart>=d+(d-z)){for(f.arraySet(e.window,e.window,d,d,0),e.match_start-=d,e.strstart-=d,e.block_start-=d,t=r=e.hash_size;n=e.head[--t],e.head[t]=d<=n?n-d:0,--r;);for(t=r=d;n=e.prev[--t],e.prev[t]=d<=n?n-d:0,--r;);i+=d}if(0===e.strm.avail_in)break;if(s=e.strm,o=e.window,u=e.strstart+e.lookahead,l=i,h=void 0,h=s.avail_in,l<h&&(h=l),r=0===h?0:(s.avail_in-=h,f.arraySet(o,s.input,s.next_in,h,u),1===s.state.wrap?s.adler=c(s.adler,o,h,u):2===s.state.wrap&&(s.adler=p(s.adler,o,h,u)),s.next_in+=h,s.total_in+=h,h),e.lookahead+=r,e.lookahead+e.insert>=x)for(a=e.strstart-e.insert,e.ins_h=e.window[a],e.ins_h=(e.ins_h<<e.hash_shift^e.window[a+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[a+x-1])&e.hash_mask,e.prev[a&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=a,a++,e.insert--,!(e.lookahead+e.insert<x)););}while(e.lookahead<z&&0!==e.strm.avail_in)}function deflate_fast(e,t){for(var r,n;;){if(e.lookahead<z){if(fill_window(e),e.lookahead<z&&t===h)return E;if(0===e.lookahead)break}if(r=0,e.lookahead>=x&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+x-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==r&&e.strstart-r<=e.w_size-z&&(e.match_length=longest_match(e,r)),e.match_length>=x)if(n=l._tr_tally(e,e.strstart-e.match_start,e.match_length-x),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=x){for(e.match_length--;e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+x-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart,0!=--e.match_length;);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else n=l._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(n&&(flush_block_only(e,!1),0===e.strm.avail_out))return E}return e.insert=e.strstart<x-1?e.strstart:x-1,t===d?(flush_block_only(e,!0),0===e.strm.avail_out?R:T):e.last_lit&&(flush_block_only(e,!1),0===e.strm.avail_out)?E:I}function deflate_slow(e,t){for(var r,n,i;;){if(e.lookahead<z){if(fill_window(e),e.lookahead<z&&t===h)return E;if(0===e.lookahead)break}if(r=0,e.lookahead>=x&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+x-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=x-1,0!==r&&e.prev_length<e.max_lazy_match&&e.strstart-r<=e.w_size-z&&(e.match_length=longest_match(e,r),e.match_length<=5&&(1===e.strategy||e.match_length===x&&4096<e.strstart-e.match_start)&&(e.match_length=x-1)),e.prev_length>=x&&e.match_length<=e.prev_length){for(i=e.strstart+e.lookahead-x,n=l._tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-x),e.lookahead-=e.prev_length-1,e.prev_length-=2;++e.strstart<=i&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+x-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!=--e.prev_length;);if(e.match_available=0,e.match_length=x-1,e.strstart++,n&&(flush_block_only(e,!1),0===e.strm.avail_out))return E}else if(e.match_available){if((n=l._tr_tally(e,0,e.window[e.strstart-1]))&&flush_block_only(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return E}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(n=l._tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<x-1?e.strstart:x-1,t===d?(flush_block_only(e,!0),0===e.strm.avail_out?R:T):e.last_lit&&(flush_block_only(e,!1),0===e.strm.avail_out)?E:I}function Config(e,t,r,n,i){this.good_length=e,this.max_lazy=t,this.nice_length=r,this.max_chain=n,this.func=i}function DeflateState(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=y,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new f.Buf16(2*w),this.dyn_dtree=new f.Buf16(2*(2*s+1)),this.bl_tree=new f.Buf16(2*(2*o+1)),zero(this.dyn_ltree),zero(this.dyn_dtree),zero(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new f.Buf16(k+1),this.heap=new f.Buf16(2*a+1),zero(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new f.Buf16(2*a+1),zero(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function deflateResetKeep(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=i,(t=e.state).pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?C:A,e.adler=2===t.wrap?0:1,t.last_flush=h,l._tr_init(t),_):err(e,m)}function deflateReset(e){var t=deflateResetKeep(e);return t===_&&function lm_init(e){e.window_size=2*e.w_size,zero(e.head),e.max_lazy_match=u[e.level].max_lazy,e.good_match=u[e.level].good_length,e.nice_match=u[e.level].nice_length,e.max_chain_length=u[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=x-1,e.match_available=0,e.ins_h=0}(e.state),t}function deflateInit2(e,t,r,n,i,a){if(!e)return m;var s=1;if(t===g&&(t=6),n<0?(s=0,n=-n):15<n&&(s=2,n-=16),i<1||v<i||r!==y||n<8||15<n||t<0||9<t||a<0||b<a)return err(e,m);8===n&&(n=9);var o=new DeflateState;return(e.state=o).strm=e,o.wrap=s,o.gzhead=null,o.w_bits=n,o.w_size=1<<o.w_bits,o.w_mask=o.w_size-1,o.hash_bits=i+7,o.hash_size=1<<o.hash_bits,o.hash_mask=o.hash_size-1,o.hash_shift=~~((o.hash_bits+x-1)/x),o.window=new f.Buf8(2*o.w_size),o.head=new f.Buf16(o.hash_size),o.prev=new f.Buf16(o.w_size),o.lit_bufsize=1<<i+6,o.pending_buf_size=4*o.lit_bufsize,o.pending_buf=new f.Buf8(o.pending_buf_size),o.d_buf=1*o.lit_bufsize,o.l_buf=3*o.lit_bufsize,o.level=t,o.strategy=a,o.method=r,deflateReset(e)}u=[new Config(0,0,0,0,function deflate_stored(e,t){var r=65535;for(r>e.pending_buf_size-5&&(r=e.pending_buf_size-5);;){if(e.lookahead<=1){if(fill_window(e),0===e.lookahead&&t===h)return E;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var n=e.block_start+r;if((0===e.strstart||e.strstart>=n)&&(e.lookahead=e.strstart-n,e.strstart=n,flush_block_only(e,!1),0===e.strm.avail_out))return E;if(e.strstart-e.block_start>=e.w_size-z&&(flush_block_only(e,!1),0===e.strm.avail_out))return E}return e.insert=0,t===d?(flush_block_only(e,!0),0===e.strm.avail_out?R:T):(e.strstart>e.block_start&&(flush_block_only(e,!1),e.strm.avail_out),E)}),new Config(4,4,8,4,deflate_fast),new Config(4,5,16,8,deflate_fast),new Config(4,6,32,32,deflate_fast),new Config(4,4,16,16,deflate_slow),new Config(8,16,32,32,deflate_slow),new Config(8,16,128,128,deflate_slow),new Config(8,32,128,256,deflate_slow),new Config(32,128,258,1024,deflate_slow),new Config(32,258,258,4096,deflate_slow)],r.deflateInit=function deflateInit(e,t){return deflateInit2(e,t,y,15,8,0)},r.deflateInit2=deflateInit2,r.deflateReset=deflateReset,r.deflateResetKeep=deflateResetKeep,r.deflateSetHeader=function deflateSetHeader(e,t){return e&&e.state?2!==e.state.wrap?m:(e.state.gzhead=t,_):m},r.deflate=function deflate(e,t){var r,n,i,a;if(!e||!e.state||5<t||t<0)return e?err(e,m):m;if(n=e.state,!e.output||!e.input&&0!==e.avail_in||666===n.status&&t!==d)return err(e,0===e.avail_out?-5:m);if(n.strm=e,r=n.last_flush,n.last_flush=t,n.status===C)if(2===n.wrap)e.adler=0,put_byte(n,31),put_byte(n,139),put_byte(n,8),n.gzhead?(put_byte(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),put_byte(n,255&n.gzhead.time),put_byte(n,n.gzhead.time>>8&255),put_byte(n,n.gzhead.time>>16&255),put_byte(n,n.gzhead.time>>24&255),put_byte(n,9===n.level?2:2<=n.strategy||n.level<2?4:0),put_byte(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&(put_byte(n,255&n.gzhead.extra.length),put_byte(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(e.adler=p(e.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=69):(put_byte(n,0),put_byte(n,0),put_byte(n,0),put_byte(n,0),put_byte(n,0),put_byte(n,9===n.level?2:2<=n.strategy||n.level<2?4:0),put_byte(n,3),n.status=A);else{var s=y+(n.w_bits-8<<4)<<8;s|=(2<=n.strategy||n.level<2?0:n.level<6?1:6===n.level?2:3)<<6,0!==n.strstart&&(s|=32),s+=31-s%31,n.status=A,putShortMSB(n,s),0!==n.strstart&&(putShortMSB(n,e.adler>>>16),putShortMSB(n,65535&e.adler)),e.adler=1}if(69===n.status)if(n.gzhead.extra){for(i=n.pending;n.gzindex<(65535&n.gzhead.extra.length)&&(n.pending!==n.pending_buf_size||(n.gzhead.hcrc&&n.pending>i&&(e.adler=p(e.adler,n.pending_buf,n.pending-i,i)),flush_pending(e),i=n.pending,n.pending!==n.pending_buf_size));)put_byte(n,255&n.gzhead.extra[n.gzindex]),n.gzindex++;n.gzhead.hcrc&&n.pending>i&&(e.adler=p(e.adler,n.pending_buf,n.pending-i,i)),n.gzindex===n.gzhead.extra.length&&(n.gzindex=0,n.status=73)}else n.status=73;if(73===n.status)if(n.gzhead.name){i=n.pending;do{if(n.pending===n.pending_buf_size&&(n.gzhead.hcrc&&n.pending>i&&(e.adler=p(e.adler,n.pending_buf,n.pending-i,i)),flush_pending(e),i=n.pending,n.pending===n.pending_buf_size)){a=1;break}put_byte(n,a=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0)}while(0!==a);n.gzhead.hcrc&&n.pending>i&&(e.adler=p(e.adler,n.pending_buf,n.pending-i,i)),0===a&&(n.gzindex=0,n.status=91)}else n.status=91;if(91===n.status)if(n.gzhead.comment){i=n.pending;do{if(n.pending===n.pending_buf_size&&(n.gzhead.hcrc&&n.pending>i&&(e.adler=p(e.adler,n.pending_buf,n.pending-i,i)),flush_pending(e),i=n.pending,n.pending===n.pending_buf_size)){a=1;break}put_byte(n,a=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0)}while(0!==a);n.gzhead.hcrc&&n.pending>i&&(e.adler=p(e.adler,n.pending_buf,n.pending-i,i)),0===a&&(n.status=103)}else n.status=103;if(103===n.status&&(n.gzhead.hcrc?(n.pending+2>n.pending_buf_size&&flush_pending(e),n.pending+2<=n.pending_buf_size&&(put_byte(n,255&e.adler),put_byte(n,e.adler>>8&255),e.adler=0,n.status=A)):n.status=A),0!==n.pending){if(flush_pending(e),0===e.avail_out)return n.last_flush=-1,_}else if(0===e.avail_in&&rank(t)<=rank(r)&&t!==d)return err(e,-5);if(666===n.status&&0!==e.avail_in)return err(e,-5);if(0!==e.avail_in||0!==n.lookahead||t!==h&&666!==n.status){var o=2===n.strategy?function deflate_huff(e,t){for(var r;;){if(0===e.lookahead&&(fill_window(e),0===e.lookahead)){if(t===h)return E;break}if(e.match_length=0,r=l._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,r&&(flush_block_only(e,!1),0===e.strm.avail_out))return E}return e.insert=0,t===d?(flush_block_only(e,!0),0===e.strm.avail_out?R:T):e.last_lit&&(flush_block_only(e,!1),0===e.strm.avail_out)?E:I}(n,t):3===n.strategy?function deflate_rle(e,t){for(var r,n,i,a,s=e.window;;){if(e.lookahead<=S){if(fill_window(e),e.lookahead<=S&&t===h)return E;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=x&&0<e.strstart&&(n=s[i=e.strstart-1])===s[++i]&&n===s[++i]&&n===s[++i]){a=e.strstart+S;do{}while(n===s[++i]&&n===s[++i]&&n===s[++i]&&n===s[++i]&&n===s[++i]&&n===s[++i]&&n===s[++i]&&n===s[++i]&&i<a);e.match_length=S-(a-i),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=x?(r=l._tr_tally(e,1,e.match_length-x),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(r=l._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),r&&(flush_block_only(e,!1),0===e.strm.avail_out))return E}return e.insert=0,t===d?(flush_block_only(e,!0),0===e.strm.avail_out?R:T):e.last_lit&&(flush_block_only(e,!1),0===e.strm.avail_out)?E:I}(n,t):u[n.level].func(n,t);if(o!==R&&o!==T||(n.status=666),o===E||o===R)return 0===e.avail_out&&(n.last_flush=-1),_;if(o===I&&(1===t?l._tr_align(n):5!==t&&(l._tr_stored_block(n,0,0,!1),3===t&&(zero(n.head),0===n.lookahead&&(n.strstart=0,n.block_start=0,n.insert=0))),flush_pending(e),0===e.avail_out))return n.last_flush=-1,_}return t!==d?_:n.wrap<=0?1:(2===n.wrap?(put_byte(n,255&e.adler),put_byte(n,e.adler>>8&255),put_byte(n,e.adler>>16&255),put_byte(n,e.adler>>24&255),put_byte(n,255&e.total_in),put_byte(n,e.total_in>>8&255),put_byte(n,e.total_in>>16&255),put_byte(n,e.total_in>>24&255)):(putShortMSB(n,e.adler>>>16),putShortMSB(n,65535&e.adler)),flush_pending(e),0<n.wrap&&(n.wrap=-n.wrap),0!==n.pending?_:1)},r.deflateEnd=function deflateEnd(e){var t;return e&&e.state?(t=e.state.status)!==C&&69!==t&&73!==t&&91!==t&&103!==t&&t!==A&&666!==t?err(e,m):(e.state=null,t===A?err(e,-3):_):m},r.deflateSetDictionary=function deflateSetDictionary(e,t){var r,n,i,a,s,o,u,l,h=t.length;if(!e||!e.state)return m;if(2===(a=(r=e.state).wrap)||1===a&&r.status!==C||r.lookahead)return m;for(1===a&&(e.adler=c(e.adler,t,h,0)),r.wrap=0,h>=r.w_size&&(0===a&&(zero(r.head),r.strstart=0,r.block_start=0,r.insert=0),l=new f.Buf8(r.w_size),f.arraySet(l,t,h-r.w_size,r.w_size,0),t=l,h=r.w_size),s=e.avail_in,o=e.next_in,u=e.input,e.avail_in=h,e.next_in=0,e.input=t,fill_window(r);r.lookahead>=x;){for(n=r.strstart,i=r.lookahead-(x-1);r.ins_h=(r.ins_h<<r.hash_shift^r.window[n+x-1])&r.hash_mask,r.prev[n&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=n,n++,--i;);r.strstart=n,r.lookahead=x-1,fill_window(r)}return r.strstart+=r.lookahead,r.block_start=r.strstart,r.insert=r.lookahead,r.lookahead=0,r.match_length=r.prev_length=x-1,r.match_available=0,e.next_in=o,e.input=u,e.avail_in=s,r.wrap=a,_},r.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":62,"./adler32":64,"./crc32":66,"./messages":72,"./trees":73}],68:[function(e,t,r){"use strict";t.exports=function GZheader(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],69:[function(e,t,r){"use strict";t.exports=function inflate_fast(e,t){var r,n,i,a,s,o,u,l,h,d,f,c,p,_,m,g,b,y,v,w,k,x,S,z,C;r=e.state,n=e.next_in,z=e.input,i=n+(e.avail_in-5),a=e.next_out,C=e.output,s=a-(t-e.avail_out),o=a+(e.avail_out-257),u=r.dmax,l=r.wsize,h=r.whave,d=r.wnext,f=r.window,c=r.hold,p=r.bits,_=r.lencode,m=r.distcode,g=(1<<r.lenbits)-1,b=(1<<r.distbits)-1;e:do{p<15&&(c+=z[n++]<<p,p+=8,c+=z[n++]<<p,p+=8),y=_[c&g];t:for(;;){if(c>>>=v=y>>>24,p-=v,0===(v=y>>>16&255))C[a++]=65535&y;else{if(!(16&v)){if(0==(64&v)){y=_[(65535&y)+(c&(1<<v)-1)];continue t}if(32&v){r.mode=12;break e}e.msg="invalid literal/length code",r.mode=30;break e}w=65535&y,(v&=15)&&(p<v&&(c+=z[n++]<<p,p+=8),w+=c&(1<<v)-1,c>>>=v,p-=v),p<15&&(c+=z[n++]<<p,p+=8,c+=z[n++]<<p,p+=8),y=m[c&b];r:for(;;){if(c>>>=v=y>>>24,p-=v,!(16&(v=y>>>16&255))){if(0==(64&v)){y=m[(65535&y)+(c&(1<<v)-1)];continue r}e.msg="invalid distance code",r.mode=30;break e}if(k=65535&y,p<(v&=15)&&(c+=z[n++]<<p,(p+=8)<v&&(c+=z[n++]<<p,p+=8)),u<(k+=c&(1<<v)-1)){e.msg="invalid distance too far back",r.mode=30;break e}if(c>>>=v,p-=v,(v=a-s)<k){if(h<(v=k-v)&&r.sane){e.msg="invalid distance too far back",r.mode=30;break e}if(S=f,(x=0)===d){if(x+=l-v,v<w){for(w-=v;C[a++]=f[x++],--v;);x=a-k,S=C}}else if(d<v){if(x+=l+d-v,(v-=d)<w){for(w-=v;C[a++]=f[x++],--v;);if(x=0,d<w){for(w-=v=d;C[a++]=f[x++],--v;);x=a-k,S=C}}}else if(x+=d-v,v<w){for(w-=v;C[a++]=f[x++],--v;);x=a-k,S=C}for(;2<w;)C[a++]=S[x++],C[a++]=S[x++],C[a++]=S[x++],w-=3;w&&(C[a++]=S[x++],1<w&&(C[a++]=S[x++]))}else{for(x=a-k;C[a++]=C[x++],C[a++]=C[x++],C[a++]=C[x++],2<(w-=3););w&&(C[a++]=C[x++],1<w&&(C[a++]=C[x++]))}break}}break}}while(n<i&&a<o);n-=w=p>>3,c&=(1<<(p-=w<<3))-1,e.next_in=n,e.next_out=a,e.avail_in=n<i?i-n+5:5-(n-i),e.avail_out=a<o?o-a+257:257-(a-o),r.hold=c,r.bits=p}},{}],70:[function(e,t,r){"use strict";var I=e("../utils/common"),R=e("./adler32"),T=e("./crc32"),O=e("./inffast"),D=e("./inftrees"),B=1,F=2,N=0,L=-2,P=1,n=852,i=592;function zswap32(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function InflateState(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new I.Buf16(320),this.work=new I.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function inflateResetKeep(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=P,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new I.Buf32(n),t.distcode=t.distdyn=new I.Buf32(i),t.sane=1,t.back=-1,N):L}function inflateReset(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,inflateResetKeep(e)):L}function inflateReset2(e,t){var r,n;return e&&e.state?(n=e.state,t<0?(r=0,t=-t):(r=1+(t>>4),t<48&&(t&=15)),t&&(t<8||15<t)?L:(null!==n.window&&n.wbits!==t&&(n.window=null),n.wrap=r,n.wbits=t,inflateReset(e))):L}function inflateInit2(e,t){var r,n;return e?(n=new InflateState,(e.state=n).window=null,(r=inflateReset2(e,t))!==N&&(e.state=null),r):L}var a,s,o=!0;function fixedtables(e){if(o){var t;for(a=new I.Buf32(512),s=new I.Buf32(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(D(B,e.lens,0,288,a,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;D(F,e.lens,0,32,s,0,e.work,{bits:5}),o=!1}e.lencode=a,e.lenbits=9,e.distcode=s,e.distbits=5}function updatewindow(e,t,r,n){var i,a=e.state;return null===a.window&&(a.wsize=1<<a.wbits,a.wnext=0,a.whave=0,a.window=new I.Buf8(a.wsize)),n>=a.wsize?(I.arraySet(a.window,t,r-a.wsize,a.wsize,0),a.wnext=0,a.whave=a.wsize):(n<(i=a.wsize-a.wnext)&&(i=n),I.arraySet(a.window,t,r-n,i,a.wnext),(n-=i)?(I.arraySet(a.window,t,r-n,n,0),a.wnext=n,a.whave=a.wsize):(a.wnext+=i,a.wnext===a.wsize&&(a.wnext=0),a.whave<a.wsize&&(a.whave+=i))),0}r.inflateReset=inflateReset,r.inflateReset2=inflateReset2,r.inflateResetKeep=inflateResetKeep,r.inflateInit=function inflateInit(e){return inflateInit2(e,15)},r.inflateInit2=inflateInit2,r.inflate=function inflate(e,t){var r,n,i,a,s,o,u,l,h,d,f,c,p,_,m,g,b,y,v,w,k,x,S,z,C=0,A=new I.Buf8(4),E=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return L;12===(r=e.state).mode&&(r.mode=13),s=e.next_out,i=e.output,u=e.avail_out,a=e.next_in,n=e.input,o=e.avail_in,l=r.hold,h=r.bits,d=o,f=u,x=N;e:for(;;)switch(r.mode){case P:if(0===r.wrap){r.mode=13;break}for(;h<16;){if(0===o)break e;o--,l+=n[a++]<<h,h+=8}if(2&r.wrap&&35615===l){A[r.check=0]=255&l,A[1]=l>>>8&255,r.check=T(r.check,A,2,0),h=l=0,r.mode=2;break}if(r.flags=0,r.head&&(r.head.done=!1),!(1&r.wrap)||(((255&l)<<8)+(l>>8))%31){e.msg="incorrect header check",r.mode=30;break}if(8!=(15&l)){e.msg="unknown compression method",r.mode=30;break}if(h-=4,k=8+(15&(l>>>=4)),0===r.wbits)r.wbits=k;else if(k>r.wbits){e.msg="invalid window size",r.mode=30;break}r.dmax=1<<k,e.adler=r.check=1,r.mode=512&l?10:12,h=l=0;break;case 2:for(;h<16;){if(0===o)break e;o--,l+=n[a++]<<h,h+=8}if(r.flags=l,8!=(255&r.flags)){e.msg="unknown compression method",r.mode=30;break}if(57344&r.flags){e.msg="unknown header flags set",r.mode=30;break}r.head&&(r.head.text=l>>8&1),512&r.flags&&(A[0]=255&l,A[1]=l>>>8&255,r.check=T(r.check,A,2,0)),h=l=0,r.mode=3;case 3:for(;h<32;){if(0===o)break e;o--,l+=n[a++]<<h,h+=8}r.head&&(r.head.time=l),512&r.flags&&(A[0]=255&l,A[1]=l>>>8&255,A[2]=l>>>16&255,A[3]=l>>>24&255,r.check=T(r.check,A,4,0)),h=l=0,r.mode=4;case 4:for(;h<16;){if(0===o)break e;o--,l+=n[a++]<<h,h+=8}r.head&&(r.head.xflags=255&l,r.head.os=l>>8),512&r.flags&&(A[0]=255&l,A[1]=l>>>8&255,r.check=T(r.check,A,2,0)),h=l=0,r.mode=5;case 5:if(1024&r.flags){for(;h<16;){if(0===o)break e;o--,l+=n[a++]<<h,h+=8}r.length=l,r.head&&(r.head.extra_len=l),512&r.flags&&(A[0]=255&l,A[1]=l>>>8&255,r.check=T(r.check,A,2,0)),h=l=0}else r.head&&(r.head.extra=null);r.mode=6;case 6:if(1024&r.flags&&(o<(c=r.length)&&(c=o),c&&(r.head&&(k=r.head.extra_len-r.length,r.head.extra||(r.head.extra=new Array(r.head.extra_len)),I.arraySet(r.head.extra,n,a,c,k)),512&r.flags&&(r.check=T(r.check,n,c,a)),o-=c,a+=c,r.length-=c),r.length))break e;r.length=0,r.mode=7;case 7:if(2048&r.flags){if(0===o)break e;for(c=0;k=n[a+c++],r.head&&k&&r.length<65536&&(r.head.name+=String.fromCharCode(k)),k&&c<o;);if(512&r.flags&&(r.check=T(r.check,n,c,a)),o-=c,a+=c,k)break e}else r.head&&(r.head.name=null);r.length=0,r.mode=8;case 8:if(4096&r.flags){if(0===o)break e;for(c=0;k=n[a+c++],r.head&&k&&r.length<65536&&(r.head.comment+=String.fromCharCode(k)),k&&c<o;);if(512&r.flags&&(r.check=T(r.check,n,c,a)),o-=c,a+=c,k)break e}else r.head&&(r.head.comment=null);r.mode=9;case 9:if(512&r.flags){for(;h<16;){if(0===o)break e;o--,l+=n[a++]<<h,h+=8}if(l!==(65535&r.check)){e.msg="header crc mismatch",r.mode=30;break}h=l=0}r.head&&(r.head.hcrc=r.flags>>9&1,r.head.done=!0),e.adler=r.check=0,r.mode=12;break;case 10:for(;h<32;){if(0===o)break e;o--,l+=n[a++]<<h,h+=8}e.adler=r.check=zswap32(l),h=l=0,r.mode=11;case 11:if(0===r.havedict)return e.next_out=s,e.avail_out=u,e.next_in=a,e.avail_in=o,r.hold=l,r.bits=h,2;e.adler=r.check=1,r.mode=12;case 12:if(5===t||6===t)break e;case 13:if(r.last){l>>>=7&h,h-=7&h,r.mode=27;break}for(;h<3;){if(0===o)break e;o--,l+=n[a++]<<h,h+=8}switch(r.last=1&l,h-=1,3&(l>>>=1)){case 0:r.mode=14;break;case 1:if(fixedtables(r),r.mode=20,6!==t)break;l>>>=2,h-=2;break e;case 2:r.mode=17;break;case 3:e.msg="invalid block type",r.mode=30}l>>>=2,h-=2;break;case 14:for(l>>>=7&h,h-=7&h;h<32;){if(0===o)break e;o--,l+=n[a++]<<h,h+=8}if((65535&l)!=(l>>>16^65535)){e.msg="invalid stored block lengths",r.mode=30;break}if(r.length=65535&l,h=l=0,r.mode=15,6===t)break e;case 15:r.mode=16;case 16:if(c=r.length){if(o<c&&(c=o),u<c&&(c=u),0===c)break e;I.arraySet(i,n,a,c,s),o-=c,a+=c,u-=c,s+=c,r.length-=c;break}r.mode=12;break;case 17:for(;h<14;){if(0===o)break e;o--,l+=n[a++]<<h,h+=8}if(r.nlen=257+(31&l),l>>>=5,h-=5,r.ndist=1+(31&l),l>>>=5,h-=5,r.ncode=4+(15&l),l>>>=4,h-=4,286<r.nlen||30<r.ndist){e.msg="too many length or distance symbols",r.mode=30;break}r.have=0,r.mode=18;case 18:for(;r.have<r.ncode;){for(;h<3;){if(0===o)break e;o--,l+=n[a++]<<h,h+=8}r.lens[E[r.have++]]=7&l,l>>>=3,h-=3}for(;r.have<19;)r.lens[E[r.have++]]=0;if(r.lencode=r.lendyn,r.lenbits=7,S={bits:r.lenbits},x=D(0,r.lens,0,19,r.lencode,0,r.work,S),r.lenbits=S.bits,x){e.msg="invalid code lengths set",r.mode=30;break}r.have=0,r.mode=19;case 19:for(;r.have<r.nlen+r.ndist;){for(;g=(C=r.lencode[l&(1<<r.lenbits)-1])>>>16&255,b=65535&C,!((m=C>>>24)<=h);){if(0===o)break e;o--,l+=n[a++]<<h,h+=8}if(b<16)l>>>=m,h-=m,r.lens[r.have++]=b;else{if(16===b){for(z=m+2;h<z;){if(0===o)break e;o--,l+=n[a++]<<h,h+=8}if(l>>>=m,h-=m,0===r.have){e.msg="invalid bit length repeat",r.mode=30;break}k=r.lens[r.have-1],c=3+(3&l),l>>>=2,h-=2}else if(17===b){for(z=m+3;h<z;){if(0===o)break e;o--,l+=n[a++]<<h,h+=8}h-=m,k=0,c=3+(7&(l>>>=m)),l>>>=3,h-=3}else{for(z=m+7;h<z;){if(0===o)break e;o--,l+=n[a++]<<h,h+=8}h-=m,k=0,c=11+(127&(l>>>=m)),l>>>=7,h-=7}if(r.have+c>r.nlen+r.ndist){e.msg="invalid bit length repeat",r.mode=30;break}for(;c--;)r.lens[r.have++]=k}}if(30===r.mode)break;if(0===r.lens[256]){e.msg="invalid code -- missing end-of-block",r.mode=30;break}if(r.lenbits=9,S={bits:r.lenbits},x=D(B,r.lens,0,r.nlen,r.lencode,0,r.work,S),r.lenbits=S.bits,x){e.msg="invalid literal/lengths set",r.mode=30;break}if(r.distbits=6,r.distcode=r.distdyn,S={bits:r.distbits},x=D(F,r.lens,r.nlen,r.ndist,r.distcode,0,r.work,S),r.distbits=S.bits,x){e.msg="invalid distances set",r.mode=30;break}if(r.mode=20,6===t)break e;case 20:r.mode=21;case 21:if(6<=o&&258<=u){e.next_out=s,e.avail_out=u,e.next_in=a,e.avail_in=o,r.hold=l,r.bits=h,O(e,f),s=e.next_out,i=e.output,u=e.avail_out,a=e.next_in,n=e.input,o=e.avail_in,l=r.hold,h=r.bits,12===r.mode&&(r.back=-1);break}for(r.back=0;g=(C=r.lencode[l&(1<<r.lenbits)-1])>>>16&255,b=65535&C,!((m=C>>>24)<=h);){if(0===o)break e;o--,l+=n[a++]<<h,h+=8}if(g&&0==(240&g)){for(y=m,v=g,w=b;g=(C=r.lencode[w+((l&(1<<y+v)-1)>>y)])>>>16&255,b=65535&C,!(y+(m=C>>>24)<=h);){if(0===o)break e;o--,l+=n[a++]<<h,h+=8}l>>>=y,h-=y,r.back+=y}if(l>>>=m,h-=m,r.back+=m,r.length=b,0===g){r.mode=26;break}if(32&g){r.back=-1,r.mode=12;break}if(64&g){e.msg="invalid literal/length code",r.mode=30;break}r.extra=15&g,r.mode=22;case 22:if(r.extra){for(z=r.extra;h<z;){if(0===o)break e;o--,l+=n[a++]<<h,h+=8}r.length+=l&(1<<r.extra)-1,l>>>=r.extra,h-=r.extra,r.back+=r.extra}r.was=r.length,r.mode=23;case 23:for(;g=(C=r.distcode[l&(1<<r.distbits)-1])>>>16&255,b=65535&C,!((m=C>>>24)<=h);){if(0===o)break e;o--,l+=n[a++]<<h,h+=8}if(0==(240&g)){for(y=m,v=g,w=b;g=(C=r.distcode[w+((l&(1<<y+v)-1)>>y)])>>>16&255,b=65535&C,!(y+(m=C>>>24)<=h);){if(0===o)break e;o--,l+=n[a++]<<h,h+=8}l>>>=y,h-=y,r.back+=y}if(l>>>=m,h-=m,r.back+=m,64&g){e.msg="invalid distance code",r.mode=30;break}r.offset=b,r.extra=15&g,r.mode=24;case 24:if(r.extra){for(z=r.extra;h<z;){if(0===o)break e;o--,l+=n[a++]<<h,h+=8}r.offset+=l&(1<<r.extra)-1,l>>>=r.extra,h-=r.extra,r.back+=r.extra}if(r.offset>r.dmax){e.msg="invalid distance too far back",r.mode=30;break}r.mode=25;case 25:if(0===u)break e;if(c=f-u,r.offset>c){if((c=r.offset-c)>r.whave&&r.sane){e.msg="invalid distance too far back",r.mode=30;break}p=c>r.wnext?(c-=r.wnext,r.wsize-c):r.wnext-c,c>r.length&&(c=r.length),_=r.window}else _=i,p=s-r.offset,c=r.length;for(u<c&&(c=u),u-=c,r.length-=c;i[s++]=_[p++],--c;);0===r.length&&(r.mode=21);break;case 26:if(0===u)break e;i[s++]=r.length,u--,r.mode=21;break;case 27:if(r.wrap){for(;h<32;){if(0===o)break e;o--,l|=n[a++]<<h,h+=8}if(f-=u,e.total_out+=f,r.total+=f,f&&(e.adler=r.check=r.flags?T(r.check,i,f,s-f):R(r.check,i,f,s-f)),f=u,(r.flags?l:zswap32(l))!==r.check){e.msg="incorrect data check",r.mode=30;break}h=l=0}r.mode=28;case 28:if(r.wrap&&r.flags){for(;h<32;){if(0===o)break e;o--,l+=n[a++]<<h,h+=8}if(l!==(4294967295&r.total)){e.msg="incorrect length check",r.mode=30;break}h=l=0}r.mode=29;case 29:x=1;break e;case 30:x=-3;break e;case 31:return-4;case 32:default:return L}return e.next_out=s,e.avail_out=u,e.next_in=a,e.avail_in=o,r.hold=l,r.bits=h,(r.wsize||f!==e.avail_out&&r.mode<30&&(r.mode<27||4!==t))&&updatewindow(e,e.output,e.next_out,f-e.avail_out)?(r.mode=31,-4):(d-=e.avail_in,f-=e.avail_out,e.total_in+=d,e.total_out+=f,r.total+=f,r.wrap&&f&&(e.adler=r.check=r.flags?T(r.check,i,f,e.next_out-f):R(r.check,i,f,e.next_out-f)),e.data_type=r.bits+(r.last?64:0)+(12===r.mode?128:0)+(20===r.mode||15===r.mode?256:0),(0===d&&0===f||4===t)&&x===N&&(x=-5),x)},r.inflateEnd=function inflateEnd(e){if(!e||!e.state)return L;var t=e.state;return t.window&&(t.window=null),e.state=null,N},r.inflateGetHeader=function inflateGetHeader(e,t){var r;return e&&e.state?0==(2&(r=e.state).wrap)?L:((r.head=t).done=!1,N):L},r.inflateSetDictionary=function inflateSetDictionary(e,t){var r,n=t.length;return e&&e.state?0!==(r=e.state).wrap&&11!==r.mode?L:11===r.mode&&R(1,t,n,0)!==r.check?-3:updatewindow(e,t,n,n)?(r.mode=31,-4):(r.havedict=1,N):L},r.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":62,"./adler32":64,"./crc32":66,"./inffast":69,"./inftrees":71}],71:[function(e,t,r){"use strict";var B=e("../utils/common"),F=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],N=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],L=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],P=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];t.exports=function inflate_table(e,t,r,n,i,a,s,o){var u,l,h,d,f,c,p,_,m,g=o.bits,b=0,y=0,v=0,w=0,k=0,x=0,S=0,z=0,C=0,A=0,E=null,I=0,R=new B.Buf16(16),T=new B.Buf16(16),O=null,D=0;for(b=0;b<=15;b++)R[b]=0;for(y=0;y<n;y++)R[t[r+y]]++;for(k=g,w=15;1<=w&&0===R[w];w--);if(w<k&&(k=w),0===w)return i[a++]=20971520,i[a++]=20971520,o.bits=1,0;for(v=1;v<w&&0===R[v];v++);for(k<v&&(k=v),b=z=1;b<=15;b++)if(z<<=1,(z-=R[b])<0)return-1;if(0<z&&(0===e||1!==w))return-1;for(T[1]=0,b=1;b<15;b++)T[b+1]=T[b]+R[b];for(y=0;y<n;y++)0!==t[r+y]&&(s[T[t[r+y]]++]=y);if(c=0===e?(E=O=s,19):1===e?(E=F,I-=257,O=N,D-=257,256):(E=L,O=P,-1),b=v,f=a,h=-1,d=(C=1<<(x=k))-1,1===e&&852<C||2===e&&592<C)return 1;for(S=y=A=0;;){for(0,p=b-S,m=s[y]<c?(_=0,s[y]):s[y]>c?(_=O[D+s[y]],E[I+s[y]]):(_=96,0),u=1<<b-S,v=l=1<<x;i[f+(A>>S)+(l-=u)]=p<<24|_<<16|m|0,0!==l;);for(u=1<<b-1;A&u;)u>>=1;if(0!==u?(A&=u-1,A+=u):A=0,y++,0==--R[b]){if(b===w)break;b=t[r+s[y]]}if(k<b&&(A&d)!==h){for(0===S&&(S=k),f+=v,z=1<<(x=b-S);x+S<w&&!((z-=R[x+S])<=0);)x++,z<<=1;if(C+=1<<x,1===e&&852<C||2===e&&592<C)return 1;i[h=A&d]=k<<24|x<<16|f-a|0}}return 0!==A&&(i[f+A]=b-S<<24|64<<16|0),o.bits=k,0}},{"../utils/common":62}],72:[function(e,t,r){"use strict";t.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],73:[function(e,t,r){"use strict";var i=e("../utils/common"),o=0,u=1;function zero(e){for(var t=e.length;0<=--t;)e[t]=0}var a=0,s=29,l=256,h=l+1+s,d=30,f=19,m=2*h+1,g=15,n=16,c=7,p=256,_=16,b=17,y=18,v=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],w=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],k=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],x=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],S=new Array(2*(h+2));zero(S);var z=new Array(2*d);zero(z);var C=new Array(512);zero(C);var A=new Array(256);zero(A);var E=new Array(s);zero(E);var I,R,T,O=new Array(d);function StaticTreeDesc(e,t,r,n,i){this.static_tree=e,this.extra_bits=t,this.extra_base=r,this.elems=n,this.max_length=i,this.has_stree=e&&e.length}function TreeDesc(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}function d_code(e){return e<256?C[e]:C[256+(e>>>7)]}function put_short(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function send_bits(e,t,r){e.bi_valid>n-r?(e.bi_buf|=t<<e.bi_valid&65535,put_short(e,e.bi_buf),e.bi_buf=t>>n-e.bi_valid,e.bi_valid+=r-n):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=r)}function send_code(e,t,r){send_bits(e,r[2*t],r[2*t+1])}function bi_reverse(e,t){for(var r=0;r|=1&e,e>>>=1,r<<=1,0<--t;);return r>>>1}function gen_codes(e,t,r){var n,i,a=new Array(g+1),s=0;for(n=1;n<=g;n++)a[n]=s=s+r[n-1]<<1;for(i=0;i<=t;i++){var o=e[2*i+1];0!==o&&(e[2*i]=bi_reverse(a[o]++,o))}}function init_block(e){var t;for(t=0;t<h;t++)e.dyn_ltree[2*t]=0;for(t=0;t<d;t++)e.dyn_dtree[2*t]=0;for(t=0;t<f;t++)e.bl_tree[2*t]=0;e.dyn_ltree[2*p]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function bi_windup(e){8<e.bi_valid?put_short(e,e.bi_buf):0<e.bi_valid&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function smaller(e,t,r,n){var i=2*t,a=2*r;return e[i]<e[a]||e[i]===e[a]&&n[t]<=n[r]}function pqdownheap(e,t,r){for(var n=e.heap[r],i=r<<1;i<=e.heap_len&&(i<e.heap_len&&smaller(t,e.heap[i+1],e.heap[i],e.depth)&&i++,!smaller(t,n,e.heap[i],e.depth));)e.heap[r]=e.heap[i],r=i,i<<=1;e.heap[r]=n}function compress_block(e,t,r){var n,i,a,s,o=0;if(0!==e.last_lit)for(;n=e.pending_buf[e.d_buf+2*o]<<8|e.pending_buf[e.d_buf+2*o+1],i=e.pending_buf[e.l_buf+o],o++,0===n?send_code(e,i,t):(send_code(e,(a=A[i])+l+1,t),0!==(s=v[a])&&send_bits(e,i-=E[a],s),send_code(e,a=d_code(--n),r),0!==(s=w[a])&&send_bits(e,n-=O[a],s)),o<e.last_lit;);send_code(e,p,t)}function build_tree(e,t){var r,n,i,a=t.dyn_tree,s=t.stat_desc.static_tree,o=t.stat_desc.has_stree,u=t.stat_desc.elems,l=-1;for(e.heap_len=0,e.heap_max=m,r=0;r<u;r++)0!==a[2*r]?(e.heap[++e.heap_len]=l=r,e.depth[r]=0):a[2*r+1]=0;for(;e.heap_len<2;)a[2*(i=e.heap[++e.heap_len]=l<2?++l:0)]=1,e.depth[i]=0,e.opt_len--,o&&(e.static_len-=s[2*i+1]);for(t.max_code=l,r=e.heap_len>>1;1<=r;r--)pqdownheap(e,a,r);for(i=u;r=e.heap[1],e.heap[1]=e.heap[e.heap_len--],pqdownheap(e,a,1),n=e.heap[1],e.heap[--e.heap_max]=r,e.heap[--e.heap_max]=n,a[2*i]=a[2*r]+a[2*n],e.depth[i]=(e.depth[r]>=e.depth[n]?e.depth[r]:e.depth[n])+1,a[2*r+1]=a[2*n+1]=i,e.heap[1]=i++,pqdownheap(e,a,1),2<=e.heap_len;);e.heap[--e.heap_max]=e.heap[1],function gen_bitlen(e,t){var r,n,i,a,s,o,u=t.dyn_tree,l=t.max_code,h=t.stat_desc.static_tree,d=t.stat_desc.has_stree,f=t.stat_desc.extra_bits,c=t.stat_desc.extra_base,p=t.stat_desc.max_length,_=0;for(a=0;a<=g;a++)e.bl_count[a]=0;for(u[2*e.heap[e.heap_max]+1]=0,r=e.heap_max+1;r<m;r++)p<(a=u[2*u[2*(n=e.heap[r])+1]+1]+1)&&(a=p,_++),u[2*n+1]=a,l<n||(e.bl_count[a]++,s=0,c<=n&&(s=f[n-c]),o=u[2*n],e.opt_len+=o*(a+s),d&&(e.static_len+=o*(h[2*n+1]+s)));if(0!==_){do{for(a=p-1;0===e.bl_count[a];)a--;e.bl_count[a]--,e.bl_count[a+1]+=2,e.bl_count[p]--,_-=2}while(0<_);for(a=p;0!==a;a--)for(n=e.bl_count[a];0!==n;)l<(i=e.heap[--r])||(u[2*i+1]!==a&&(e.opt_len+=(a-u[2*i+1])*u[2*i],u[2*i+1]=a),n--)}}(e,t),gen_codes(a,l,e.bl_count)}function scan_tree(e,t,r){var n,i,a=-1,s=t[1],o=0,u=7,l=4;for(0===s&&(u=138,l=3),t[2*(r+1)+1]=65535,n=0;n<=r;n++)i=s,s=t[2*(n+1)+1],++o<u&&i===s||(o<l?e.bl_tree[2*i]+=o:0!==i?(i!==a&&e.bl_tree[2*i]++,e.bl_tree[2*_]++):o<=10?e.bl_tree[2*b]++:e.bl_tree[2*y]++,a=i,l=(o=0)===s?(u=138,3):i===s?(u=6,3):(u=7,4))}function send_tree(e,t,r){var n,i,a=-1,s=t[1],o=0,u=7,l=4;for(0===s&&(u=138,l=3),n=0;n<=r;n++)if(i=s,s=t[2*(n+1)+1],!(++o<u&&i===s)){if(o<l)for(;send_code(e,i,e.bl_tree),0!=--o;);else 0!==i?(i!==a&&(send_code(e,i,e.bl_tree),o--),send_code(e,_,e.bl_tree),send_bits(e,o-3,2)):o<=10?(send_code(e,b,e.bl_tree),send_bits(e,o-3,3)):(send_code(e,y,e.bl_tree),send_bits(e,o-11,7));a=i,l=(o=0)===s?(u=138,3):i===s?(u=6,3):(u=7,4)}}zero(O);var D=!1;function _tr_stored_block(e,t,r,n){send_bits(e,(a<<1)+(n?1:0),3),function copy_block(e,t,r,n){bi_windup(e),n&&(put_short(e,r),put_short(e,~r)),i.arraySet(e.pending_buf,e.window,t,r,e.pending),e.pending+=r}(e,t,r,!0)}r._tr_init=function _tr_init(e){D||(function tr_static_init(){var e,t,r,n,i,a=new Array(g+1);for(n=r=0;n<s-1;n++)for(E[n]=r,e=0;e<1<<v[n];e++)A[r++]=n;for(A[r-1]=n,n=i=0;n<16;n++)for(O[n]=i,e=0;e<1<<w[n];e++)C[i++]=n;for(i>>=7;n<d;n++)for(O[n]=i<<7,e=0;e<1<<w[n]-7;e++)C[256+i++]=n;for(t=0;t<=g;t++)a[t]=0;for(e=0;e<=143;)S[2*e+1]=8,e++,a[8]++;for(;e<=255;)S[2*e+1]=9,e++,a[9]++;for(;e<=279;)S[2*e+1]=7,e++,a[7]++;for(;e<=287;)S[2*e+1]=8,e++,a[8]++;for(gen_codes(S,h+1,a),e=0;e<d;e++)z[2*e+1]=5,z[2*e]=bi_reverse(e,5);I=new StaticTreeDesc(S,v,l+1,h,g),R=new StaticTreeDesc(z,w,0,d,g),T=new StaticTreeDesc(new Array(0),k,0,f,c)}(),D=!0),e.l_desc=new TreeDesc(e.dyn_ltree,I),e.d_desc=new TreeDesc(e.dyn_dtree,R),e.bl_desc=new TreeDesc(e.bl_tree,T),e.bi_buf=0,e.bi_valid=0,init_block(e)},r._tr_stored_block=_tr_stored_block,r._tr_flush_block=function _tr_flush_block(e,t,r,n){var i,a,s=0;0<e.level?(2===e.strm.data_type&&(e.strm.data_type=function detect_data_type(e){var t,r=4093624447;for(t=0;t<=31;t++,r>>>=1)if(1&r&&0!==e.dyn_ltree[2*t])return o;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return u;for(t=32;t<l;t++)if(0!==e.dyn_ltree[2*t])return u;return o}(e)),build_tree(e,e.l_desc),build_tree(e,e.d_desc),s=function build_bl_tree(e){var t;for(scan_tree(e,e.dyn_ltree,e.l_desc.max_code),scan_tree(e,e.dyn_dtree,e.d_desc.max_code),build_tree(e,e.bl_desc),t=f-1;3<=t&&0===e.bl_tree[2*x[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}(e),i=e.opt_len+3+7>>>3,(a=e.static_len+3+7>>>3)<=i&&(i=a)):i=a=r+5,r+4<=i&&-1!==t?_tr_stored_block(e,t,r,n):4===e.strategy||a===i?(send_bits(e,2+(n?1:0),3),compress_block(e,S,z)):(send_bits(e,4+(n?1:0),3),function send_all_trees(e,t,r,n){var i;for(send_bits(e,t-257,5),send_bits(e,r-1,5),send_bits(e,n-4,4),i=0;i<n;i++)send_bits(e,e.bl_tree[2*x[i]+1],3);send_tree(e,e.dyn_ltree,t-1),send_tree(e,e.dyn_dtree,r-1)}(e,e.l_desc.max_code+1,e.d_desc.max_code+1,s+1),compress_block(e,e.dyn_ltree,e.dyn_dtree)),init_block(e),n&&bi_windup(e)},r._tr_tally=function _tr_tally(e,t,r){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&r,e.last_lit++,0===t?e.dyn_ltree[2*r]++:(e.matches++,t--,e.dyn_ltree[2*(A[r]+l+1)]++,e.dyn_dtree[2*d_code(t)]++),e.last_lit===e.lit_bufsize-1},r._tr_align=function _tr_align(e){send_bits(e,2,3),send_code(e,p,S),function bi_flush(e){16===e.bi_valid?(put_short(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):8<=e.bi_valid&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}(e)}},{"../utils/common":62}],74:[function(e,t,r){"use strict";t.exports=function ZStream(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}]},{},[10])(10)});
var saveAs=saveAs||function(d){"use strict";if(!(void 0===d||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var e=d.document,s=function(){return d.URL||d.webkitURL||d},f=e.createElementNS("http://www.w3.org/1999/xhtml","a"),u="download"in f,c=/constructor/i.test(d.HTMLElement)||d.safari,l=/CriOS\/[\d]+/.test(navigator.userAgent),p=function(e){(d.setImmediate||d.setTimeout)(function(){throw e},0)},v=function(e){setTimeout(function(){"string"==typeof e?s().revokeObjectURL(e):e.remove()},4e4)},w=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob([String.fromCharCode(65279),e],{type:e.type}):e},o=function(e,n,t){t||(e=w(e));var o,r=this,a="application/octet-stream"===e.type,i=function(){!function(e,t,n){for(var o=(t=[].concat(t)).length;o--;){var r=e["on"+t[o]];if("function"==typeof r)try{r.call(e,n||e)}catch(e){p(e)}}}(r,"writestart progress write writeend".split(" "))};if(r.readyState=r.INIT,u)return o=s().createObjectURL(e),void setTimeout(function(){var e,t;f.href=o,f.download=n,e=f,t=new MouseEvent("click"),e.dispatchEvent(t),i(),v(o),r.readyState=r.DONE});!function(){if((l||a&&c)&&d.FileReader){var t=new FileReader;return t.onloadend=function(){var e=l?t.result:t.result.replace(/^data:[^;]*;/,"data:attachment/file;");d.open(e,"_blank")||(d.location.href=e),e=void 0,r.readyState=r.DONE,i()},t.readAsDataURL(e),r.readyState=r.INIT}o||(o=s().createObjectURL(e)),a?d.location.href=o:d.open(o,"_blank")||(d.location.href=o);r.readyState=r.DONE,i(),v(o)}()},t=o.prototype;return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,n){return t=t||e.name||"download",n||(e=w(e)),navigator.msSaveOrOpenBlob(e,t)}:(t.abort=function(){},t.readyState=t.INIT=0,t.WRITING=1,t.DONE=2,t.error=t.onwritestart=t.onprogress=t.onwrite=t.onabort=t.onerror=t.onwriteend=null,function(e,t,n){return new o(e,t||e.name||"download",n)})}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!==define.amd&&define("FileSaver.js",function(){return saveAs});
!function(){var e,t={},a=null,r=null,h=null,i=null,l={},n={color:"#ff0084",background:"#bbb",shadow:"#fff",fallback:!1},o=1<window.devicePixelRatio,c=(e=navigator.userAgent.toLowerCase(),function(t){return-1!==e.indexOf(t)}),d=c("msie"),f=(c("chrome"),c("chrome")||c("safari"),c("safari")&&!c("chrome")),u=(c("mozilla")&&!c("chrome")&&c("safari"),function(t){!function(){for(var t=Array.prototype.slice.call(document.getElementsByTagName("link"),0),e=document.getElementsByTagName("head")[0],i=0,n=t.length;i<n;i++)"icon"!==t[i].getAttribute("rel")&&"shortcut icon"!==t[i].getAttribute("rel")||e.removeChild(t[i])}();var e=document.createElement("link");e.type="image/x-icon",e.rel="icon",e.href=t,document.getElementsByTagName("head")[0].appendChild(e)}),g=function(){return i||((i=document.createElement("canvas")).height=o?i.width=32:i.width=16),i},m=function(t){document.title=0<t?"("+t+"%) "+h:h};t.setOptions=function(t){for(var e in l={},n)l[e]=t.hasOwnProperty(e)?t[e]:n[e];return this},t.setProgress=function(t){if(h||(h=document.title),!r||!a){var e=function(){for(var t=document.getElementsByTagName("link"),e=0,i=t.length;e<i;e++)if("icon"===t[e].getAttribute("rel")||"shortcut icon"===t[e].getAttribute("rel"))return t[e];return!1}();r=a=e?e.getAttribute("href"):"/favicon.ico"}return!(isNaN(parseFloat(t))||!isFinite(t))&&(!g().getContext||d||f||!0===l.fallback?m(t):("force"===l.fallback&&m(t),i=t,n=g(),o=n.getContext("2d"),i=i||0,void(o&&(o.clearRect(0,0,n.width,n.height),o.beginPath(),o.moveTo(n.width/2,n.height/2),o.arc(n.width/2,n.height/2,Math.min(n.width/2,n.height/2),0,2*Math.PI,!1),o.fillStyle=l.shadow,o.fill(),o.beginPath(),o.moveTo(n.width/2,n.height/2),o.arc(n.width/2,n.height/2,Math.min(n.width/2,n.height/2)-2,0,2*Math.PI,!1),o.fillStyle=l.background,o.fill(),0<i&&(o.beginPath(),o.moveTo(n.width/2,n.height/2),o.arc(n.width/2,n.height/2,Math.min(n.width/2,n.height/2)-2,-.5*Math.PI,(2*i/100-.5)*Math.PI,!1),o.lineTo(n.width/2,n.height/2),o.fillStyle=l.color,o.fill()),u(n.toDataURL())))));var i,n,o},t.reset=function(){h&&(document.title=h),r&&u(a=r)},t.setOptions(n),"function"==typeof define&&define.amd?define(t):"undefined"!=typeof module?module.exports=t:window.Piecon=t}();
!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var e;"undefined"!=typeof window?e=window:"undefined"!=typeof global?e=global:"undefined"!=typeof self&&(e=self),e.Slideout=t()}}(function(){return function e(a,u,l){function s(n,t){if(!u[n]){if(!a[n]){var i="function"==typeof require&&require;if(!t&&i)return i(n,!0);if(c)return c(n,!0);var o=new Error("Cannot find module '"+n+"'");throw o.code="MODULE_NOT_FOUND",o}var r=u[n]={exports:{}};a[n][0].call(r.exports,function(t){var e=a[n][1][t];return s(e||t)},r,r.exports,e,a,u,l)}return u[n].exports}for(var c="function"==typeof require&&require,t=0;t<l.length;t++)s(l[t]);return s}({1:[function(t,e,n){"use strict";var i,s=t("decouple"),o=t("emitter"),r=!1,a=window.document,u=a.documentElement,l=window.navigator.msPointerEnabled,c={start:l?"MSPointerDown":"touchstart",move:l?"MSPointerMove":"touchmove",end:l?"MSPointerUp":"touchend"},h=function prefix(){var t=/^(Webkit|Khtml|Moz|ms|O)(?=[A-Z])/,e=a.getElementsByTagName("script")[0].style;for(var n in e)if(t.test(n))return"-"+n.match(t)[0].toLowerCase()+"-";return"WebkitOpacity"in e?"-webkit-":"KhtmlOpacity"in e?"-khtml-":""}();function Slideout(t){t=t||{},this._startOffsetX=0,this._currentOffsetX=0,this._opening=!1,this._moved=!1,this._opened=!1,this._preventOpen=!1,this._touch=void 0===t.touch||t.touch&&!0,this._side=t.side||"left",this.panel=t.panel,this.menu=t.menu,this.panel.classList.contains("slideout-panel")||this.panel.classList.add("slideout-panel"),this.panel.classList.contains("slideout-panel-"+this._side)||this.panel.classList.add("slideout-panel-"+this._side),this.menu.classList.contains("slideout-menu")||this.menu.classList.add("slideout-menu"),this.menu.classList.contains("slideout-menu-"+this._side)||this.menu.classList.add("slideout-menu-"+this._side),this._fx=t.fx||"ease",this._duration=parseInt(t.duration,10)||300,this._tolerance=parseInt(t.tolerance,10)||70,this._padding=this._translateTo=parseInt(t.padding,10)||256,this._orientation="right"===this._side?-1:1,this._translateTo*=this._orientation,this._touch&&this._initTouchEvents()}!function inherits(t,e){t.prototype=function extend(t,e){for(var n in e)e[n]&&(t[n]=e[n]);return t}(t.prototype||{},e.prototype)}(Slideout,o),Slideout.prototype.open=function(){var t=this;return this.emit("beforeopen"),u.classList.contains("slideout-open")||u.classList.add("slideout-open"),this._setTransition(),this._translateXTo(this._translateTo),this._opened=!0,setTimeout(function(){t.panel.style.transition=t.panel.style["-webkit-transition"]="",t.emit("open")},this._duration+50),this},Slideout.prototype.close=function(){var t=this;return(this.isOpen()||this._opening)&&(this.emit("beforeclose"),this._setTransition(),this._translateXTo(0),this._opened=!1,setTimeout(function(){u.classList.remove("slideout-open"),t.panel.style.transition=t.panel.style["-webkit-transition"]=t.panel.style[h+"transform"]=t.panel.style.transform="",t.emit("close")},this._duration+50)),this},Slideout.prototype.toggle=function(){return this.isOpen()?this.close():this.open()},Slideout.prototype.isOpen=function(){return this._opened},Slideout.prototype._translateXTo=function(t){return this._currentOffsetX=t,this.panel.style[h+"transform"]=this.panel.style.transform="translateX("+t+"px)",this},Slideout.prototype._setTransition=function(){return this.panel.style[h+"transition"]=this.panel.style.transition=h+"transform "+this._duration+"ms "+this._fx,this},Slideout.prototype._initTouchEvents=function(){var o=this;return this._onScrollFn=s(a,"scroll",function(){o._moved||(clearTimeout(i),r=!0,i=setTimeout(function(){r=!1},250))}),this._preventMove=function(t){o._moved&&t.preventDefault()},a.addEventListener(c.move,this._preventMove),this._resetTouchFn=function(t){void 0!==t.touches&&(o._moved=!1,o._opening=!1,o._startOffsetX=t.touches[0].pageX,o._preventOpen=!o._touch||!o.isOpen()&&0!==o.menu.clientWidth)},this.panel.addEventListener(c.start,this._resetTouchFn),this._onTouchCancelFn=function(){o._moved=!1,o._opening=!1},this.panel.addEventListener("touchcancel",this._onTouchCancelFn),this._onTouchEndFn=function(){o._moved&&(o.emit("translateend"),o._opening&&Math.abs(o._currentOffsetX)>o._tolerance?o.open():o.close()),o._moved=!1},this.panel.addEventListener(c.end,this._onTouchEndFn),this._onTouchMoveFn=function(t){if(!(r||o._preventOpen||void 0===t.touches||function hasIgnoredElements(t){for(;t.parentNode;){if(null!==t.getAttribute("data-slideout-ignore"))return t;t=t.parentNode}return null}(t.target))){var e=t.touches[0].clientX-o._startOffsetX,n=o._currentOffsetX=e;if(!(Math.abs(n)>o._padding)&&20<Math.abs(e)){o._opening=!0;var i=e*o._orientation;if(o._opened&&0<i||!o._opened&&i<0)return;o._moved||o.emit("translatestart"),i<=0&&(n=e+o._padding*o._orientation,o._opening=!1),o._moved&&u.classList.contains("slideout-open")||u.classList.add("slideout-open"),o.panel.style[h+"transform"]=o.panel.style.transform="translateX("+n+"px)",o.emit("translate",n),o._moved=!0}}},this.panel.addEventListener(c.move,this._onTouchMoveFn),this},Slideout.prototype.enableTouch=function(){return this._touch=!0,this},Slideout.prototype.disableTouch=function(){return this._touch=!1,this},Slideout.prototype.destroy=function(){return this.close(),a.removeEventListener(c.move,this._preventMove),this.panel.removeEventListener(c.start,this._resetTouchFn),this.panel.removeEventListener("touchcancel",this._onTouchCancelFn),this.panel.removeEventListener(c.end,this._onTouchEndFn),this.panel.removeEventListener(c.move,this._onTouchMoveFn),a.removeEventListener("scroll",this._onScrollFn),this.open=this.close=function(){},this},e.exports=Slideout},{decouple:2,emitter:3}],2:[function(t,e,n){"use strict";var s=window.requestAnimationFrame||window.webkitRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)};e.exports=function decouple(t,e,n){var i,o=!1;function captureEvent(t){i=t,function track(){o||(s(update),o=!0)}()}function update(){n.call(t,i),o=!1}return t.addEventListener(e,captureEvent,!1),captureEvent}},{}],3:[function(t,e,n){"use strict";n.__esModule=!0;var i=function(){function Emitter(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,Emitter)}return Emitter.prototype.on=function on(t,e){return this._eventCollection=this._eventCollection||{},this._eventCollection[t]=this._eventCollection[t]||[],this._eventCollection[t].push(e),this},Emitter.prototype.once=function once(t,e){var n=this;function fn(){n.off(t,fn),e.apply(this,arguments)}return fn.listener=e,this.on(t,fn),this},Emitter.prototype.off=function off(t,n){var i=void 0;return this._eventCollection&&(i=this._eventCollection[t])&&(i.forEach(function(t,e){t!==n&&t.listener!==n||i.splice(e,1)}),0===i.length&&delete this._eventCollection[t]),this},Emitter.prototype.emit=function emit(t){for(var e=this,n=arguments.length,i=Array(1<n?n-1:0),o=1;o<n;o++)i[o-1]=arguments[o];var s=void 0;return this._eventCollection&&(s=this._eventCollection[t])&&(s=s.slice(0)).forEach(function(t){return t.apply(e,i)}),this},Emitter}();n.default=i,e.exports=n.default},{}]},{},[1])(1)});
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.THREE=e.THREE||{})}(this,function(e){"use strict";function EventDispatcher(){}void 0===Number.EPSILON&&(Number.EPSILON=Math.pow(2,-52)),void 0===Number.isInteger&&(Number.isInteger=function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e}),void 0===Math.sign&&(Math.sign=function(e){return e<0?-1:0<e?1:+e}),"name"in Function.prototype==!1&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*([^\(\s]*)/)[1]}}),void 0===Object.assign&&(Object.assign=function(e){if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var t=Object(e),r=1;r<arguments.length;r++){var i=arguments[r];if(null!=i)for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(t[n]=i[n])}return t}),Object.assign(EventDispatcher.prototype,{addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});var r=this._listeners;void 0===r[e]&&(r[e]=[]),-1===r[e].indexOf(t)&&r[e].push(t)},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;var r=this._listeners;return void 0!==r[e]&&-1!==r[e].indexOf(t)},removeEventListener:function(e,t){if(void 0!==this._listeners){var r=this._listeners[e];if(void 0!==r){var i=r.indexOf(t);-1!==i&&r.splice(i,1)}}},dispatchEvent:function(e){if(void 0!==this._listeners){var t=this._listeners[e.type];if(void 0!==t){e.target=this;for(var r=t.slice(0),i=0,n=r.length;i<n;i++)r[i].call(this,e)}}}});var r,i,n,a,o,h,u,s,c,l,d,p,f,m,t,g,y,x,b,M,_,w,T,D=0,G=1,U=2,O=1,R=2,V=0,X=1,q=2,pe=0,E=2,F=0,N=1,z=2,H=3,k=4,j=5,S=100,A=101,L=102,C=103,P=104,B=200,I=201,W=202,Y=203,Z=204,Q=205,K=206,J=207,$=208,ee=209,te=210,re=0,ie=1,ne=2,ae=3,oe=4,se=5,ce=6,le=7,he=0,ue=1,de=2,fe=0,me=1,ge=2,ve=3,ye=4,xe=301,be=302,Me=303,_e=304,we=305,Te=306,Ee=307,Se=1e3,Ae=1001,Le=1002,Ce=1003,Pe=1004,Re=1005,Be=1006,Ie=1007,De=1008,Ge=1009,Ue=1010,Oe=1011,Ve=1012,Fe=1013,Ne=1014,ze=1015,He=1016,ke=1017,je=1018,We=1019,Xe=1020,qe=1021,Ye=1022,Ze=1023,Qe=1024,Ke=1025,Je=Ze,$e=1026,et=1027,tt=2001,rt=2002,it=2003,nt=2004,at=2100,ot=2101,st=2102,ct=2103,lt=2151,ht=2300,ut=2301,dt=2400,pt=2401,ft=2402,mt=0,gt=3e3,vt=3001,yt=3007,xt=3002,bt=3004,Mt=3005,_t=3006,wt=3200,Tt=3201,Et={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,generateUUID:(i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),n=0,function generateUUID(){for(var e="",t=0;t<36;t++)8===t||13===t||18===t||23===t?e+="-":14===t?e+="4":(n<=2&&(n=33554432+16777216*Math.random()|0),r=15&n,n>>=4,e+=i[19===t?3&r|8:r]);return e}),clamp:function(e,t,r){return Math.max(t,Math.min(r,e))},euclideanModulo:function(e,t){return(e%t+t)%t},mapLinear:function(e,t,r,i,n){return i+(e-t)*(n-i)/(r-t)},lerp:function(e,t,r){return(1-r)*e+r*t},smoothstep:function(e,t,r){return e<=t?0:r<=e?1:(e=(e-t)/(r-t))*e*(3-2*e)},smootherstep:function(e,t,r){return e<=t?0:r<=e?1:(e=(e-t)/(r-t))*e*e*(e*(6*e-15)+10)},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},degToRad:function(e){return e*Et.DEG2RAD},radToDeg:function(e){return e*Et.RAD2DEG},isPowerOfTwo:function(e){return 0==(e&e-1)&&0!==e},ceilPowerOfTwo:function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))},floorPowerOfTwo:function(e){return Math.pow(2,Math.floor(Math.log(e)/Math.LN2))}};function Vector2(e,t){this.x=e||0,this.y=t||0}function Matrix4(){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],0<arguments.length&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}function Quaternion(e,t,r,i){this._x=e||0,this._y=t||0,this._z=r||0,this._w=void 0!==i?i:1}function Vector3(e,t,r){this.x=e||0,this.y=t||0,this.z=r||0}function Matrix3(){this.elements=[1,0,0,0,1,0,0,0,1],0<arguments.length&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")}Object.defineProperties(Vector2.prototype,{width:{get:function(){return this.x},set:function(e){this.x=e}},height:{get:function(){return this.y},set:function(e){this.y=e}}}),Object.assign(Vector2.prototype,{isVector2:!0,set:function(e,t){return this.x=e,this.y=t,this},setScalar:function(e){return this.x=e,this.y=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y)},copy:function(e){return this.x=e.x,this.y=e.y,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector2: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this)},addScalar:function(e){return this.x+=e,this.y+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector2: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this)},subScalar:function(e){return this.x-=e,this.y-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this},multiply:function(e){return this.x*=e.x,this.y*=e.y,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this},divide:function(e){return this.x/=e.x,this.y/=e.y,this},divideScalar:function(e){return this.multiplyScalar(1/e)},applyMatrix3:function(e){var t=this.x,r=this.y,i=e.elements;return this.x=i[0]*t+i[3]*r+i[6],this.y=i[1]*t+i[4]*r+i[7],this},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this},clampScalar:(a=new Vector2,o=new Vector2,function clampScalar(e,t){return a.set(e,e),o.set(t,t),this.clamp(a,o)}),clampLength:function(e,t){var r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(e,Math.min(t,r)))},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this},negate:function(){return this.x=-this.x,this.y=-this.y,this},dot:function(e){return this.x*e.x+this.y*e.y},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},manhattanLength:function(){return Math.abs(this.x)+Math.abs(this.y)},normalize:function(){return this.divideScalar(this.length()||1)},angle:function(){var e=Math.atan2(this.y,this.x);return e<0&&(e+=2*Math.PI),e},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,r=this.y-e.y;return t*t+r*r},manhattanDistanceTo:function(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)},setLength:function(e){return this.normalize().multiplyScalar(e)},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this},lerpVectors:function(e,t,r){return this.subVectors(t,e).multiplyScalar(r).add(e)},equals:function(e){return e.x===this.x&&e.y===this.y},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e},fromBufferAttribute:function(e,t,r){return void 0!==r&&console.warn("THREE.Vector2: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this},rotateAround:function(e,t){var r=Math.cos(t),i=Math.sin(t),n=this.x-e.x,a=this.y-e.y;return this.x=n*r-a*i+e.x,this.y=n*i+a*r+e.y,this}}),Object.assign(Matrix4.prototype,{isMatrix4:!0,set:function(e,t,r,i,n,a,o,s,c,l,h,u,d,p,f,m){var g=this.elements;return g[0]=e,g[4]=t,g[8]=r,g[12]=i,g[1]=n,g[5]=a,g[9]=o,g[13]=s,g[2]=c,g[6]=l,g[10]=h,g[14]=u,g[3]=d,g[7]=p,g[11]=f,g[15]=m,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},clone:function(){return(new Matrix4).fromArray(this.elements)},copy:function(e){var t=this.elements,r=e.elements;return t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],t[4]=r[4],t[5]=r[5],t[6]=r[6],t[7]=r[7],t[8]=r[8],t[9]=r[9],t[10]=r[10],t[11]=r[11],t[12]=r[12],t[13]=r[13],t[14]=r[14],t[15]=r[15],this},copyPosition:function(e){var t=this.elements,r=e.elements;return t[12]=r[12],t[13]=r[13],t[14]=r[14],this},extractBasis:function(e,t,r){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),r.setFromMatrixColumn(this,2),this},makeBasis:function(e,t,r){return this.set(e.x,t.x,r.x,0,e.y,t.y,r.y,0,e.z,t.z,r.z,0,0,0,0,1),this},extractRotation:(p=new Vector3,function extractRotation(e){var t=this.elements,r=e.elements,i=1/p.setFromMatrixColumn(e,0).length(),n=1/p.setFromMatrixColumn(e,1).length(),a=1/p.setFromMatrixColumn(e,2).length();return t[0]=r[0]*i,t[1]=r[1]*i,t[2]=r[2]*i,t[4]=r[4]*n,t[5]=r[5]*n,t[6]=r[6]*n,t[8]=r[8]*a,t[9]=r[9]*a,t[10]=r[10]*a,this}),makeRotationFromEuler:function(e){e&&e.isEuler||console.error("THREE.Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");var t=this.elements,r=e.x,i=e.y,n=e.z,a=Math.cos(r),o=Math.sin(r),s=Math.cos(i),c=Math.sin(i),l=Math.cos(n),h=Math.sin(n);if("XYZ"===e.order){var u=a*l,d=a*h,p=o*l,f=o*h;t[0]=s*l,t[4]=-s*h,t[8]=c,t[1]=d+p*c,t[5]=u-f*c,t[9]=-o*s,t[2]=f-u*c,t[6]=p+d*c,t[10]=a*s}else if("YXZ"===e.order){var m=s*l,g=s*h,v=c*l,y=c*h;t[0]=m+y*o,t[4]=v*o-g,t[8]=a*c,t[1]=a*h,t[5]=a*l,t[9]=-o,t[2]=g*o-v,t[6]=y+m*o,t[10]=a*s}else if("ZXY"===e.order){m=s*l,g=s*h,v=c*l,y=c*h;t[0]=m-y*o,t[4]=-a*h,t[8]=v+g*o,t[1]=g+v*o,t[5]=a*l,t[9]=y-m*o,t[2]=-a*c,t[6]=o,t[10]=a*s}else if("ZYX"===e.order){u=a*l,d=a*h,p=o*l,f=o*h;t[0]=s*l,t[4]=p*c-d,t[8]=u*c+f,t[1]=s*h,t[5]=f*c+u,t[9]=d*c-p,t[2]=-c,t[6]=o*s,t[10]=a*s}else if("YZX"===e.order){var x=a*s,b=a*c,M=o*s,_=o*c;t[0]=s*l,t[4]=_-x*h,t[8]=M*h+b,t[1]=h,t[5]=a*l,t[9]=-o*l,t[2]=-c*l,t[6]=b*h+M,t[10]=x-_*h}else if("XZY"===e.order){x=a*s,b=a*c,M=o*s,_=o*c;t[0]=s*l,t[4]=-h,t[8]=c*l,t[1]=x*h+_,t[5]=a*l,t[9]=b*h-M,t[2]=M*h-b,t[6]=o*l,t[10]=_*h+x}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},makeRotationFromQuaternion:function(e){var t=this.elements,r=e._x,i=e._y,n=e._z,a=e._w,o=r+r,s=i+i,c=n+n,l=r*o,h=r*s,u=r*c,d=i*s,p=i*c,f=n*c,m=a*o,g=a*s,v=a*c;return t[0]=1-(d+f),t[4]=h-v,t[8]=u+g,t[1]=h+v,t[5]=1-(l+f),t[9]=p-m,t[2]=u-g,t[6]=p+m,t[10]=1-(l+d),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},lookAt:(c=new Vector3,l=new Vector3,d=new Vector3,function lookAt(e,t,r){var i=this.elements;return d.subVectors(e,t),0===d.lengthSq()&&(d.z=1),d.normalize(),c.crossVectors(r,d),0===c.lengthSq()&&(1===Math.abs(r.z)?d.x+=1e-4:d.z+=1e-4,d.normalize(),c.crossVectors(r,d)),c.normalize(),l.crossVectors(d,c),i[0]=c.x,i[4]=l.x,i[8]=d.x,i[1]=c.y,i[5]=l.y,i[9]=d.y,i[2]=c.z,i[6]=l.z,i[10]=d.z,this}),multiply:function(e,t){return void 0!==t?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(e,t)):this.multiplyMatrices(this,e)},premultiply:function(e){return this.multiplyMatrices(e,this)},multiplyMatrices:function(e,t){var r=e.elements,i=t.elements,n=this.elements,a=r[0],o=r[4],s=r[8],c=r[12],l=r[1],h=r[5],u=r[9],d=r[13],p=r[2],f=r[6],m=r[10],g=r[14],v=r[3],y=r[7],x=r[11],b=r[15],M=i[0],_=i[4],w=i[8],T=i[12],E=i[1],S=i[5],A=i[9],L=i[13],C=i[2],P=i[6],R=i[10],B=i[14],I=i[3],D=i[7],G=i[11],U=i[15];return n[0]=a*M+o*E+s*C+c*I,n[4]=a*_+o*S+s*P+c*D,n[8]=a*w+o*A+s*R+c*G,n[12]=a*T+o*L+s*B+c*U,n[1]=l*M+h*E+u*C+d*I,n[5]=l*_+h*S+u*P+d*D,n[9]=l*w+h*A+u*R+d*G,n[13]=l*T+h*L+u*B+d*U,n[2]=p*M+f*E+m*C+g*I,n[6]=p*_+f*S+m*P+g*D,n[10]=p*w+f*A+m*R+g*G,n[14]=p*T+f*L+m*B+g*U,n[3]=v*M+y*E+x*C+b*I,n[7]=v*_+y*S+x*P+b*D,n[11]=v*w+y*A+x*R+b*G,n[15]=v*T+y*L+x*B+b*U,this},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this},applyToBufferAttribute:(s=new Vector3,function applyToBufferAttribute(e){for(var t=0,r=e.count;t<r;t++)s.x=e.getX(t),s.y=e.getY(t),s.z=e.getZ(t),s.applyMatrix4(this),e.setXYZ(t,s.x,s.y,s.z);return e}),determinant:function(){var e=this.elements,t=e[0],r=e[4],i=e[8],n=e[12],a=e[1],o=e[5],s=e[9],c=e[13],l=e[2],h=e[6],u=e[10],d=e[14];return e[3]*(+n*s*h-i*c*h-n*o*u+r*c*u+i*o*d-r*s*d)+e[7]*(+t*s*d-t*c*u+n*a*u-i*a*d+i*c*l-n*s*l)+e[11]*(+t*c*h-t*o*d-n*a*h+r*a*d+n*o*l-r*c*l)+e[15]*(-i*o*l-t*s*h+t*o*u+i*a*h-r*a*u+r*s*l)},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},setPosition:function(e){var t=this.elements;return t[12]=e.x,t[13]=e.y,t[14]=e.z,this},getInverse:function(e,t){var r=this.elements,i=e.elements,n=i[0],a=i[1],o=i[2],s=i[3],c=i[4],l=i[5],h=i[6],u=i[7],d=i[8],p=i[9],f=i[10],m=i[11],g=i[12],v=i[13],y=i[14],x=i[15],b=p*y*u-v*f*u+v*h*m-l*y*m-p*h*x+l*f*x,M=g*f*u-d*y*u-g*h*m+c*y*m+d*h*x-c*f*x,_=d*v*u-g*p*u+g*l*m-c*v*m-d*l*x+c*p*x,w=g*p*h-d*v*h-g*l*f+c*v*f+d*l*y-c*p*y,T=n*b+a*M+o*_+s*w;if(0===T){var E="THREE.Matrix4: .getInverse() can't invert matrix, determinant is 0";if(!0===t)throw new Error(E);return console.warn(E),this.identity()}var S=1/T;return r[0]=b*S,r[1]=(v*f*s-p*y*s-v*o*m+a*y*m+p*o*x-a*f*x)*S,r[2]=(l*y*s-v*h*s+v*o*u-a*y*u-l*o*x+a*h*x)*S,r[3]=(p*h*s-l*f*s-p*o*u+a*f*u+l*o*m-a*h*m)*S,r[4]=M*S,r[5]=(d*y*s-g*f*s+g*o*m-n*y*m-d*o*x+n*f*x)*S,r[6]=(g*h*s-c*y*s-g*o*u+n*y*u+c*o*x-n*h*x)*S,r[7]=(c*f*s-d*h*s+d*o*u-n*f*u-c*o*m+n*h*m)*S,r[8]=_*S,r[9]=(g*p*s-d*v*s-g*a*m+n*v*m+d*a*x-n*p*x)*S,r[10]=(c*v*s-g*l*s+g*a*u-n*v*u-c*a*x+n*l*x)*S,r[11]=(d*l*s-c*p*s-d*a*u+n*p*u+c*a*m-n*l*m)*S,r[12]=w*S,r[13]=(d*v*o-g*p*o+g*a*f-n*v*f-d*a*y+n*p*y)*S,r[14]=(g*l*o-c*v*o-g*a*h+n*v*h+c*a*y-n*l*y)*S,r[15]=(c*p*o-d*l*o+d*a*h-n*p*h-c*a*f+n*l*f)*S,this},scale:function(e){var t=this.elements,r=e.x,i=e.y,n=e.z;return t[0]*=r,t[4]*=i,t[8]*=n,t[1]*=r,t[5]*=i,t[9]*=n,t[2]*=r,t[6]*=i,t[10]*=n,t[3]*=r,t[7]*=i,t[11]*=n,this},getMaxScaleOnAxis:function(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],r=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],i=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,r,i))},makeTranslation:function(e,t,r){return this.set(1,0,0,e,0,1,0,t,0,0,1,r,0,0,0,1),this},makeRotationX:function(e){var t=Math.cos(e),r=Math.sin(e);return this.set(1,0,0,0,0,t,-r,0,0,r,t,0,0,0,0,1),this},makeRotationY:function(e){var t=Math.cos(e),r=Math.sin(e);return this.set(t,0,r,0,0,1,0,0,-r,0,t,0,0,0,0,1),this},makeRotationZ:function(e){var t=Math.cos(e),r=Math.sin(e);return this.set(t,-r,0,0,r,t,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(e,t){var r=Math.cos(t),i=Math.sin(t),n=1-r,a=e.x,o=e.y,s=e.z,c=n*a,l=n*o;return this.set(c*a+r,c*o-i*s,c*s+i*o,0,c*o+i*s,l*o+r,l*s-i*a,0,c*s-i*o,l*s+i*a,n*s*s+r,0,0,0,0,1),this},makeScale:function(e,t,r){return this.set(e,0,0,0,0,t,0,0,0,0,r,0,0,0,0,1),this},makeShear:function(e,t,r){return this.set(1,t,r,0,e,1,r,0,e,t,1,0,0,0,0,1),this},compose:function(e,t,r){return this.makeRotationFromQuaternion(t),this.scale(r),this.setPosition(e),this},decompose:(h=new Vector3,u=new Matrix4,function decompose(e,t,r){var i=this.elements,n=h.set(i[0],i[1],i[2]).length(),a=h.set(i[4],i[5],i[6]).length(),o=h.set(i[8],i[9],i[10]).length();this.determinant()<0&&(n=-n),e.x=i[12],e.y=i[13],e.z=i[14],u.copy(this);var s=1/n,c=1/a,l=1/o;return u.elements[0]*=s,u.elements[1]*=s,u.elements[2]*=s,u.elements[4]*=c,u.elements[5]*=c,u.elements[6]*=c,u.elements[8]*=l,u.elements[9]*=l,u.elements[10]*=l,t.setFromRotationMatrix(u),r.x=n,r.y=a,r.z=o,this}),makePerspective:function(e,t,r,i,n,a){void 0===a&&console.warn("THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");var o=this.elements,s=2*n/(t-e),c=2*n/(r-i),l=(t+e)/(t-e),h=(r+i)/(r-i),u=-(a+n)/(a-n),d=-2*a*n/(a-n);return o[0]=s,o[4]=0,o[8]=l,o[12]=0,o[1]=0,o[5]=c,o[9]=h,o[13]=0,o[2]=0,o[6]=0,o[10]=u,o[14]=d,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this},makeOrthographic:function(e,t,r,i,n,a){var o=this.elements,s=1/(t-e),c=1/(r-i),l=1/(a-n),h=(t+e)*s,u=(r+i)*c,d=(a+n)*l;return o[0]=2*s,o[4]=0,o[8]=0,o[12]=-h,o[1]=0,o[5]=2*c,o[9]=0,o[13]=-u,o[2]=0,o[6]=0,o[10]=-2*l,o[14]=-d,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this},equals:function(e){for(var t=this.elements,r=e.elements,i=0;i<16;i++)if(t[i]!==r[i])return!1;return!0},fromArray:function(e,t){void 0===t&&(t=0);for(var r=0;r<16;r++)this.elements[r]=e[r+t];return this},toArray:function(e,t){void 0===e&&(e=[]),void 0===t&&(t=0);var r=this.elements;return e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8],e[t+9]=r[9],e[t+10]=r[10],e[t+11]=r[11],e[t+12]=r[12],e[t+13]=r[13],e[t+14]=r[14],e[t+15]=r[15],e}}),Object.assign(Quaternion,{slerp:function(e,t,r,i){return r.copy(e).slerp(t,i)},slerpFlat:function(e,t,r,i,n,a,o){var s=r[i+0],c=r[i+1],l=r[i+2],h=r[i+3],u=n[a+0],d=n[a+1],p=n[a+2],f=n[a+3];if(h!==f||s!==u||c!==d||l!==p){var m=1-o,g=s*u+c*d+l*p+h*f,v=0<=g?1:-1,y=1-g*g;if(y>Number.EPSILON){var x=Math.sqrt(y),b=Math.atan2(x,g*v);m=Math.sin(m*b)/x,o=Math.sin(o*b)/x}var M=o*v;if(s=s*m+u*M,c=c*m+d*M,l=l*m+p*M,h=h*m+f*M,m===1-o){var _=1/Math.sqrt(s*s+c*c+l*l+h*h);s*=_,c*=_,l*=_,h*=_}}e[t]=s,e[t+1]=c,e[t+2]=l,e[t+3]=h}}),Object.defineProperties(Quaternion.prototype,{x:{get:function(){return this._x},set:function(e){this._x=e,this.onChangeCallback()}},y:{get:function(){return this._y},set:function(e){this._y=e,this.onChangeCallback()}},z:{get:function(){return this._z},set:function(e){this._z=e,this.onChangeCallback()}},w:{get:function(){return this._w},set:function(e){this._w=e,this.onChangeCallback()}}}),Object.assign(Quaternion.prototype,{set:function(e,t,r,i){return this._x=e,this._y=t,this._z=r,this._w=i,this.onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._w)},copy:function(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this.onChangeCallback(),this},setFromEuler:function(e,t){if(!e||!e.isEuler)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");var r=e._x,i=e._y,n=e._z,a=e.order,o=Math.cos,s=Math.sin,c=o(r/2),l=o(i/2),h=o(n/2),u=s(r/2),d=s(i/2),p=s(n/2);return"XYZ"===a?(this._x=u*l*h+c*d*p,this._y=c*d*h-u*l*p,this._z=c*l*p+u*d*h,this._w=c*l*h-u*d*p):"YXZ"===a?(this._x=u*l*h+c*d*p,this._y=c*d*h-u*l*p,this._z=c*l*p-u*d*h,this._w=c*l*h+u*d*p):"ZXY"===a?(this._x=u*l*h-c*d*p,this._y=c*d*h+u*l*p,this._z=c*l*p+u*d*h,this._w=c*l*h-u*d*p):"ZYX"===a?(this._x=u*l*h-c*d*p,this._y=c*d*h+u*l*p,this._z=c*l*p-u*d*h,this._w=c*l*h+u*d*p):"YZX"===a?(this._x=u*l*h+c*d*p,this._y=c*d*h+u*l*p,this._z=c*l*p-u*d*h,this._w=c*l*h-u*d*p):"XZY"===a&&(this._x=u*l*h-c*d*p,this._y=c*d*h-u*l*p,this._z=c*l*p+u*d*h,this._w=c*l*h+u*d*p),!1!==t&&this.onChangeCallback(),this},setFromAxisAngle:function(e,t){var r=t/2,i=Math.sin(r);return this._x=e.x*i,this._y=e.y*i,this._z=e.z*i,this._w=Math.cos(r),this.onChangeCallback(),this},setFromRotationMatrix:function(e){var t,r=e.elements,i=r[0],n=r[4],a=r[8],o=r[1],s=r[5],c=r[9],l=r[2],h=r[6],u=r[10],d=i+s+u;return this._z=0<d?(t=.5/Math.sqrt(d+1),this._w=.25/t,this._x=(h-c)*t,this._y=(a-l)*t,(o-n)*t):s<i&&u<i?(t=2*Math.sqrt(1+i-s-u),this._w=(h-c)/t,this._x=.25*t,this._y=(n+o)/t,(a+l)/t):u<s?(t=2*Math.sqrt(1+s-i-u),this._w=(a-l)/t,this._x=(n+o)/t,this._y=.25*t,(c+h)/t):(t=2*Math.sqrt(1+u-i-s),this._w=(o-n)/t,this._x=(a+l)/t,this._y=(c+h)/t,.25*t),this.onChangeCallback(),this},setFromUnitVectors:(m=new Vector3,function setFromUnitVectors(e,t){return void 0===m&&(m=new Vector3),(f=e.dot(t)+1)<1e-6?(f=0,Math.abs(e.x)>Math.abs(e.z)?m.set(-e.y,e.x,0):m.set(0,-e.z,e.y)):m.crossVectors(e,t),this._x=m.x,this._y=m.y,this._z=m.z,this._w=f,this.normalize()}),inverse:function(){return this.conjugate().normalize()},conjugate:function(){return this._x*=-1,this._y*=-1,this._z*=-1,this.onChangeCallback(),this},dot:function(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w},lengthSq:function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w},length:function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},normalize:function(){var e=this.length();return this._w=0===e?(this._x=0,this._y=0,this._z=0,1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w*e),this.onChangeCallback(),this},multiply:function(e,t){return void 0!==t?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(e,t)):this.multiplyQuaternions(this,e)},premultiply:function(e){return this.multiplyQuaternions(e,this)},multiplyQuaternions:function(e,t){var r=e._x,i=e._y,n=e._z,a=e._w,o=t._x,s=t._y,c=t._z,l=t._w;return this._x=r*l+a*o+i*c-n*s,this._y=i*l+a*s+n*o-r*c,this._z=n*l+a*c+r*s-i*o,this._w=a*l-r*o-i*s-n*c,this.onChangeCallback(),this},slerp:function(e,t){if(0===t)return this;if(1===t)return this.copy(e);var r=this._x,i=this._y,n=this._z,a=this._w,o=a*e._w+r*e._x+i*e._y+n*e._z;if(o<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,o=-o):this.copy(e),1<=o)return this._w=a,this._x=r,this._y=i,this._z=n,this;var s=Math.sqrt(1-o*o);if(Math.abs(s)<.001)return this._w=.5*(a+this._w),this._x=.5*(r+this._x),this._y=.5*(i+this._y),this._z=.5*(n+this._z),this;var c=Math.atan2(s,o),l=Math.sin((1-t)*c)/s,h=Math.sin(t*c)/s;return this._w=a*l+this._w*h,this._x=r*l+this._x*h,this._y=i*l+this._y*h,this._z=n*l+this._z*h,this.onChangeCallback(),this},equals:function(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w},fromArray:function(e,t){return void 0===t&&(t=0),this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this.onChangeCallback(),this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e},onChange:function(e){return this.onChangeCallback=e,this},onChangeCallback:function(){}}),Object.assign(Vector3.prototype,{isVector3:!0,set:function(e,t,r){return this.x=e,this.y=t,this.z=r,this},setScalar:function(e){return this.x=e,this.y=e,this.z=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y,this.z)},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this)},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this)},subScalar:function(e){return this.x-=e,this.y-=e,this.z-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this},multiply:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(e,t)):(this.x*=e.x,this.y*=e.y,this.z*=e.z,this)},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this},multiplyVectors:function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this},applyEuler:(w=new Quaternion,function applyEuler(e){return e&&e.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(w.setFromEuler(e))}),applyAxisAngle:(_=new Quaternion,function applyAxisAngle(e,t){return this.applyQuaternion(_.setFromAxisAngle(e,t))}),applyMatrix3:function(e){var t=this.x,r=this.y,i=this.z,n=e.elements;return this.x=n[0]*t+n[3]*r+n[6]*i,this.y=n[1]*t+n[4]*r+n[7]*i,this.z=n[2]*t+n[5]*r+n[8]*i,this},applyMatrix4:function(e){var t=this.x,r=this.y,i=this.z,n=e.elements,a=1/(n[3]*t+n[7]*r+n[11]*i+n[15]);return this.x=(n[0]*t+n[4]*r+n[8]*i+n[12])*a,this.y=(n[1]*t+n[5]*r+n[9]*i+n[13])*a,this.z=(n[2]*t+n[6]*r+n[10]*i+n[14])*a,this},applyQuaternion:function(e){var t=this.x,r=this.y,i=this.z,n=e.x,a=e.y,o=e.z,s=e.w,c=s*t+a*i-o*r,l=s*r+o*t-n*i,h=s*i+n*r-a*t,u=-n*t-a*r-o*i;return this.x=c*s+u*-n+l*-o-h*-a,this.y=l*s+u*-a+h*-n-c*-o,this.z=h*s+u*-o+c*-a-l*-n,this},project:(M=new Matrix4,function project(e){return M.multiplyMatrices(e.projectionMatrix,M.getInverse(e.matrixWorld)),this.applyMatrix4(M)}),unproject:(b=new Matrix4,function unproject(e){return b.multiplyMatrices(e.matrixWorld,b.getInverse(e.projectionMatrix)),this.applyMatrix4(b)}),transformDirection:function(e){var t=this.x,r=this.y,i=this.z,n=e.elements;return this.x=n[0]*t+n[4]*r+n[8]*i,this.y=n[1]*t+n[5]*r+n[9]*i,this.z=n[2]*t+n[6]*r+n[10]*i,this.normalize()},divide:function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},divideScalar:function(e){return this.multiplyScalar(1/e)},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this},clampScalar:(y=new Vector3,x=new Vector3,function clampScalar(e,t){return y.set(e,e,e),x.set(t,t,t),this.clamp(y,x)}),clampLength:function(e,t){var r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(e,Math.min(t,r)))},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},manhattanLength:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length()||1)},setLength:function(e){return this.normalize().multiplyScalar(e)},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this},lerpVectors:function(e,t,r){return this.subVectors(t,e).multiplyScalar(r).add(e)},cross:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(e,t)):this.crossVectors(this,e)},crossVectors:function(e,t){var r=e.x,i=e.y,n=e.z,a=t.x,o=t.y,s=t.z;return this.x=i*s-n*o,this.y=n*a-r*s,this.z=r*o-i*a,this},projectOnVector:function(e){var t=e.dot(this)/e.lengthSq();return this.copy(e).multiplyScalar(t)},projectOnPlane:(g=new Vector3,function projectOnPlane(e){return g.copy(this).projectOnVector(e),this.sub(g)}),reflect:(t=new Vector3,function reflect(e){return this.sub(t.copy(e).multiplyScalar(2*this.dot(e)))}),angleTo:function(e){var t=this.dot(e)/Math.sqrt(this.lengthSq()*e.lengthSq());return Math.acos(Et.clamp(t,-1,1))},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,r=this.y-e.y,i=this.z-e.z;return t*t+r*r+i*i},manhattanDistanceTo:function(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)},setFromSpherical:function(e){var t=Math.sin(e.phi)*e.radius;return this.x=t*Math.sin(e.theta),this.y=Math.cos(e.phi)*e.radius,this.z=t*Math.cos(e.theta),this},setFromCylindrical:function(e){return this.x=e.radius*Math.sin(e.theta),this.y=e.y,this.z=e.radius*Math.cos(e.theta),this},setFromMatrixPosition:function(e){var t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this},setFromMatrixScale:function(e){var t=this.setFromMatrixColumn(e,0).length(),r=this.setFromMatrixColumn(e,1).length(),i=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=r,this.z=i,this},setFromMatrixColumn:function(e,t){return this.fromArray(e.elements,4*t)},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e},fromBufferAttribute:function(e,t,r){return void 0!==r&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}}),Object.assign(Matrix3.prototype,{isMatrix3:!0,set:function(e,t,r,i,n,a,o,s,c){var l=this.elements;return l[0]=e,l[1]=i,l[2]=o,l[3]=t,l[4]=n,l[5]=s,l[6]=r,l[7]=a,l[8]=c,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(e){var t=this.elements,r=e.elements;return t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],t[4]=r[4],t[5]=r[5],t[6]=r[6],t[7]=r[7],t[8]=r[8],this},setFromMatrix4:function(e){var t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this},applyToBufferAttribute:(T=new Vector3,function applyToBufferAttribute(e){for(var t=0,r=e.count;t<r;t++)T.x=e.getX(t),T.y=e.getY(t),T.z=e.getZ(t),T.applyMatrix3(this),e.setXYZ(t,T.x,T.y,T.z);return e}),multiply:function(e){return this.multiplyMatrices(this,e)},premultiply:function(e){return this.multiplyMatrices(e,this)},multiplyMatrices:function(e,t){var r=e.elements,i=t.elements,n=this.elements,a=r[0],o=r[3],s=r[6],c=r[1],l=r[4],h=r[7],u=r[2],d=r[5],p=r[8],f=i[0],m=i[3],g=i[6],v=i[1],y=i[4],x=i[7],b=i[2],M=i[5],_=i[8];return n[0]=a*f+o*v+s*b,n[3]=a*m+o*y+s*M,n[6]=a*g+o*x+s*_,n[1]=c*f+l*v+h*b,n[4]=c*m+l*y+h*M,n[7]=c*g+l*x+h*_,n[2]=u*f+d*v+p*b,n[5]=u*m+d*y+p*M,n[8]=u*g+d*x+p*_,this},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this},determinant:function(){var e=this.elements,t=e[0],r=e[1],i=e[2],n=e[3],a=e[4],o=e[5],s=e[6],c=e[7],l=e[8];return t*a*l-t*o*c-r*n*l+r*o*s+i*n*c-i*a*s},getInverse:function(e,t){e&&e.isMatrix4&&console.error("THREE.Matrix3: .getInverse() no longer takes a Matrix4 argument.");var r=e.elements,i=this.elements,n=r[0],a=r[1],o=r[2],s=r[3],c=r[4],l=r[5],h=r[6],u=r[7],d=r[8],p=d*c-l*u,f=l*h-d*s,m=u*s-c*h,g=n*p+a*f+o*m;if(0===g){var v="THREE.Matrix3: .getInverse() can't invert matrix, determinant is 0";if(!0===t)throw new Error(v);return console.warn(v),this.identity()}var y=1/g;return i[0]=p*y,i[1]=(o*u-d*a)*y,i[2]=(l*a-o*c)*y,i[3]=f*y,i[4]=(d*n-o*h)*y,i[5]=(o*s-l*n)*y,i[6]=m*y,i[7]=(a*h-u*n)*y,i[8]=(c*n-a*s)*y,this},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this},getNormalMatrix:function(e){return this.setFromMatrix4(e).getInverse(this).transpose()},transposeIntoArray:function(e){var t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this},setUvTransform:function(e,t,r,i,n,a,o){var s=Math.cos(n),c=Math.sin(n);this.set(r*s,r*c,-r*(s*a+c*o)+a+e,-i*c,i*s,-i*(-c*a+s*o)+o+t,0,0,1)},scale:function(e,t){var r=this.elements;return r[0]*=e,r[3]*=e,r[6]*=e,r[1]*=t,r[4]*=t,r[7]*=t,this},rotate:function(e){var t=Math.cos(e),r=Math.sin(e),i=this.elements,n=i[0],a=i[3],o=i[6],s=i[1],c=i[4],l=i[7];return i[0]=t*n+r*s,i[3]=t*a+r*c,i[6]=t*o+r*l,i[1]=-r*n+t*s,i[4]=-r*a+t*c,i[7]=-r*o+t*l,this},translate:function(e,t){var r=this.elements;return r[0]+=e*r[2],r[3]+=e*r[5],r[6]+=e*r[8],r[1]+=t*r[2],r[4]+=t*r[5],r[7]+=t*r[8],this},equals:function(e){for(var t=this.elements,r=e.elements,i=0;i<9;i++)if(t[i]!==r[i])return!1;return!0},fromArray:function(e,t){void 0===t&&(t=0);for(var r=0;r<9;r++)this.elements[r]=e[r+t];return this},toArray:function(e,t){void 0===e&&(e=[]),void 0===t&&(t=0);var r=this.elements;return e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8],e}});var St,At,Lt=0;function Texture(e,t,r,i,n,a,o,s,c,l){Object.defineProperty(this,"id",{value:Lt++}),this.uuid=Et.generateUUID(),this.name="",this.image=void 0!==e?e:Texture.DEFAULT_IMAGE,this.mipmaps=[],this.mapping=void 0!==t?t:Texture.DEFAULT_MAPPING,this.wrapS=void 0!==r?r:Ae,this.wrapT=void 0!==i?i:Ae,this.magFilter=void 0!==n?n:Be,this.minFilter=void 0!==a?a:De,this.anisotropy=void 0!==c?c:1,this.format=void 0!==o?o:Ze,this.type=void 0!==s?s:Ge,this.offset=new Vector2(0,0),this.repeat=new Vector2(1,1),this.center=new Vector2(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new Matrix3,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.encoding=void 0!==l?l:gt,this.version=0,this.onUpdate=null}function Vector4(e,t,r,i){this.x=e||0,this.y=t||0,this.z=r||0,this.w=void 0!==i?i:1}function WebGLRenderTarget(e,t,r){this.uuid=Et.generateUUID(),this.width=e,this.height=t,this.scissor=new Vector4(0,0,e,t),this.scissorTest=!1,this.viewport=new Vector4(0,0,e,t),void 0===(r=r||{}).minFilter&&(r.minFilter=Be),this.texture=new Texture(void 0,void 0,r.wrapS,r.wrapT,r.magFilter,r.minFilter,r.format,r.type,r.anisotropy,r.encoding),this.depthBuffer=void 0===r.depthBuffer||r.depthBuffer,this.stencilBuffer=void 0===r.stencilBuffer||r.stencilBuffer,this.depthTexture=void 0!==r.depthTexture?r.depthTexture:null}function WebGLRenderTargetCube(e,t,r){WebGLRenderTarget.call(this,e,t,r),this.activeCubeFace=0,this.activeMipMapLevel=0}function DataTexture(e,t,r,i,n,a,o,s,c,l,h,u){Texture.call(this,null,a,o,s,c,l,i,n,h,u),this.image={data:e,width:t,height:r},this.magFilter=void 0!==c?c:Ce,this.minFilter=void 0!==l?l:Ce,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}function CubeTexture(e,t,r,i,n,a,o,s,c,l){Texture.call(this,e=void 0!==e?e:[],t=void 0!==t?t:xe,r,i,n,a,o,s,c,l),this.flipY=!1}Texture.DEFAULT_IMAGE=void 0,Texture.DEFAULT_MAPPING=300,Object.defineProperty(Texture.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),Object.assign(Texture.prototype,EventDispatcher.prototype,{constructor:Texture,isTexture:!0,clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.name=e.name,this.image=e.image,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.encoding=e.encoding,this},toJSON:function(e){var t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.textures[this.uuid])return e.textures[this.uuid];var r={metadata:{version:4.5,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,mapping:this.mapping,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY};if(void 0!==this.image){var i=this.image;void 0===i.uuid&&(i.uuid=Et.generateUUID()),t||void 0!==e.images[i.uuid]||(e.images[i.uuid]={uuid:i.uuid,url:function getDataURL(e){var t;if(e instanceof HTMLCanvasElement)t=e;else{(t=document.createElementNS("http://www.w3.org/1999/xhtml","canvas")).width=e.width,t.height=e.height;var r=t.getContext("2d");e instanceof ImageData?r.putImageData(e,0,0):r.drawImage(e,0,0,e.width,e.height)}return 2048<t.width||2048<t.height?t.toDataURL("image/jpeg",.6):t.toDataURL("image/png")}(i)}),r.image=i.uuid}return t||(e.textures[this.uuid]=r),r},dispose:function(){this.dispatchEvent({type:"dispose"})},transformUv:function(e){if(300===this.mapping){if(e.applyMatrix3(this.matrix),e.x<0||1<e.x)switch(this.wrapS){case Se:e.x=e.x-Math.floor(e.x);break;case Ae:e.x=e.x<0?0:1;break;case Le:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||1<e.y)switch(this.wrapT){case Se:e.y=e.y-Math.floor(e.y);break;case Ae:e.y=e.y<0?0:1;break;case Le:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}this.flipY&&(e.y=1-e.y)}}}),Object.assign(Vector4.prototype,{isVector4:!0,set:function(e,t,r,i){return this.x=e,this.y=t,this.z=r,this.w=i,this},setScalar:function(e){return this.x=e,this.y=e,this.z=e,this.w=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setW:function(e){return this.w=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y,this.z,this.w)},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector4: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this)},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector4: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this)},subScalar:function(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},applyMatrix4:function(e){var t=this.x,r=this.y,i=this.z,n=this.w,a=e.elements;return this.x=a[0]*t+a[4]*r+a[8]*i+a[12]*n,this.y=a[1]*t+a[5]*r+a[9]*i+a[13]*n,this.z=a[2]*t+a[6]*r+a[10]*i+a[14]*n,this.w=a[3]*t+a[7]*r+a[11]*i+a[15]*n,this},divideScalar:function(e){return this.multiplyScalar(1/e)},setAxisAngleFromQuaternion:function(e){this.w=2*Math.acos(e.w);var t=Math.sqrt(1-e.w*e.w);return this.z=t<1e-4?(this.x=1,this.y=0):(this.x=e.x/t,this.y=e.y/t,e.z/t),this},setAxisAngleFromRotationMatrix:function(e){var t,r,i,n,a=e.elements,o=a[0],s=a[4],c=a[8],l=a[1],h=a[5],u=a[9],d=a[2],p=a[6],f=a[10];if(Math.abs(s-l)<.01&&Math.abs(c-d)<.01&&Math.abs(u-p)<.01){if(Math.abs(s+l)<.1&&Math.abs(c+d)<.1&&Math.abs(u+p)<.1&&Math.abs(o+h+f-3)<.1)return this.set(1,0,0,0),this;t=Math.PI;var m=(o+1)/2,g=(h+1)/2,v=(f+1)/2,y=(s+l)/4,x=(c+d)/4,b=(u+p)/4;return g<m&&v<m?n=m<.01?(r=0,i=.707106781):(i=y/(r=Math.sqrt(m)),x/r):v<g?n=g<.01?(i=0,r=.707106781):(r=y/(i=Math.sqrt(g)),b/i):v<.01?(i=r=.707106781,n=0):(r=x/(n=Math.sqrt(v)),i=b/n),this.set(r,i,n,t),this}var M=Math.sqrt((p-u)*(p-u)+(c-d)*(c-d)+(l-s)*(l-s));return Math.abs(M)<.001&&(M=1),this.x=(p-u)/M,this.y=(c-d)/M,this.z=(l-s)/M,this.w=Math.acos((o+h+f-1)/2),this},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this.w=Math.max(e.w,Math.min(t.w,this.w)),this},clampScalar:function clampScalar(e,t){return void 0===St&&(St=new Vector4,At=new Vector4),St.set(e,e,e,e),At.set(t,t,t,t),this.clamp(St,At)},clampLength:function(e,t){var r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(e,Math.min(t,r)))},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},manhattanLength:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)},normalize:function(){return this.divideScalar(this.length()||1)},setLength:function(e){return this.normalize().multiplyScalar(e)},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this},lerpVectors:function(e,t,r){return this.subVectors(t,e).multiplyScalar(r).add(e)},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e},fromBufferAttribute:function(e,t,r){return void 0!==r&&console.warn("THREE.Vector4: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}}),Object.assign(WebGLRenderTarget.prototype,EventDispatcher.prototype,{isWebGLRenderTarget:!0,setSize:function(e,t){this.width===e&&this.height===t||(this.width=e,this.height=t,this.dispose()),this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.width=e.width,this.height=e.height,this.viewport.copy(e.viewport),this.texture=e.texture.clone(),this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.depthTexture=e.depthTexture,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),((WebGLRenderTargetCube.prototype=Object.create(WebGLRenderTarget.prototype)).constructor=WebGLRenderTargetCube).prototype.isWebGLRenderTargetCube=!0,((DataTexture.prototype=Object.create(Texture.prototype)).constructor=DataTexture).prototype.isDataTexture=!0,((CubeTexture.prototype=Object.create(Texture.prototype)).constructor=CubeTexture).prototype.isCubeTexture=!0,Object.defineProperty(CubeTexture.prototype,"images",{get:function(){return this.image},set:function(e){this.image=e}});var Ct=new Texture,Pt=new CubeTexture;function UniformContainer(){this.seq=[],this.map={}}var Rt=[],Bt=[],It=new Float32Array(16),Dt=new Float32Array(9);function flatten(e,t,r){var i=e[0];if(i<=0||0<i)return e;var n=t*r,a=Rt[n];if(void 0===a&&(a=new Float32Array(n),Rt[n]=a),0!==t){i.toArray(a,0);for(var o=1,s=0;o!==t;++o)s+=r,e[o].toArray(a,s)}return a}function allocTexUnits(e,t){var r=Bt[t];void 0===r&&(r=new Int32Array(t),Bt[t]=r);for(var i=0;i!==t;++i)r[i]=e.allocTextureUnit();return r}function setValue1f(e,t){e.uniform1f(this.addr,t)}function setValue1i(e,t){e.uniform1i(this.addr,t)}function setValue2fv(e,t){void 0===t.x?e.uniform2fv(this.addr,t):e.uniform2f(this.addr,t.x,t.y)}function setValue3fv(e,t){void 0!==t.x?e.uniform3f(this.addr,t.x,t.y,t.z):void 0!==t.r?e.uniform3f(this.addr,t.r,t.g,t.b):e.uniform3fv(this.addr,t)}function setValue4fv(e,t){void 0===t.x?e.uniform4fv(this.addr,t):e.uniform4f(this.addr,t.x,t.y,t.z,t.w)}function setValue2fm(e,t){e.uniformMatrix2fv(this.addr,!1,t.elements||t)}function setValue3fm(e,t){void 0===t.elements?e.uniformMatrix3fv(this.addr,!1,t):(Dt.set(t.elements),e.uniformMatrix3fv(this.addr,!1,Dt))}function setValue4fm(e,t){void 0===t.elements?e.uniformMatrix4fv(this.addr,!1,t):(It.set(t.elements),e.uniformMatrix4fv(this.addr,!1,It))}function setValueT1(e,t,r){var i=r.allocTextureUnit();e.uniform1i(this.addr,i),r.setTexture2D(t||Ct,i)}function setValueT6(e,t,r){var i=r.allocTextureUnit();e.uniform1i(this.addr,i),r.setTextureCube(t||Pt,i)}function setValue2iv(e,t){e.uniform2iv(this.addr,t)}function setValue3iv(e,t){e.uniform3iv(this.addr,t)}function setValue4iv(e,t){e.uniform4iv(this.addr,t)}function setValue1fv(e,t){e.uniform1fv(this.addr,t)}function setValue1iv(e,t){e.uniform1iv(this.addr,t)}function setValueV2a(e,t){e.uniform2fv(this.addr,flatten(t,this.size,2))}function setValueV3a(e,t){e.uniform3fv(this.addr,flatten(t,this.size,3))}function setValueV4a(e,t){e.uniform4fv(this.addr,flatten(t,this.size,4))}function setValueM2a(e,t){e.uniformMatrix2fv(this.addr,!1,flatten(t,this.size,4))}function setValueM3a(e,t){e.uniformMatrix3fv(this.addr,!1,flatten(t,this.size,9))}function setValueM4a(e,t){e.uniformMatrix4fv(this.addr,!1,flatten(t,this.size,16))}function setValueT1a(e,t,r){var i=t.length,n=allocTexUnits(r,i);e.uniform1iv(this.addr,n);for(var a=0;a!==i;++a)r.setTexture2D(t[a]||Ct,n[a])}function setValueT6a(e,t,r){var i=t.length,n=allocTexUnits(r,i);e.uniform1iv(this.addr,n);for(var a=0;a!==i;++a)r.setTextureCube(t[a]||Pt,n[a])}function SingleUniform(e,t,r){this.id=e,this.addr=r,this.setValue=function getSingularSetter(e){switch(e){case 5126:return setValue1f;case 35664:return setValue2fv;case 35665:return setValue3fv;case 35666:return setValue4fv;case 35674:return setValue2fm;case 35675:return setValue3fm;case 35676:return setValue4fm;case 35678:case 36198:return setValueT1;case 35680:return setValueT6;case 5124:case 35670:return setValue1i;case 35667:case 35671:return setValue2iv;case 35668:case 35672:return setValue3iv;case 35669:case 35673:return setValue4iv}}(t.type)}function PureArrayUniform(e,t,r){this.id=e,this.addr=r,this.size=t.size,this.setValue=function getPureArraySetter(e){switch(e){case 5126:return setValue1fv;case 35664:return setValueV2a;case 35665:return setValueV3a;case 35666:return setValueV4a;case 35674:return setValueM2a;case 35675:return setValueM3a;case 35676:return setValueM4a;case 35678:return setValueT1a;case 35680:return setValueT6a;case 5124:case 35670:return setValue1iv;case 35667:case 35671:return setValue2iv;case 35668:case 35672:return setValue3iv;case 35669:case 35673:return setValue4iv}}(t.type)}function StructuredUniform(e){this.id=e,UniformContainer.call(this)}StructuredUniform.prototype.setValue=function(e,t){for(var r=this.seq,i=0,n=r.length;i!==n;++i){var a=r[i];a.setValue(e,t[a.id])}};var Gt=/([\w\d_]+)(\])?(\[|\.)?/g;function addUniform(e,t){e.seq.push(t),e.map[t.id]=t}function parseUniform(e,t,r){var i=e.name,n=i.length;for(Gt.lastIndex=0;;){var a=Gt.exec(i),o=Gt.lastIndex,s=a[1],c="]"===a[2],l=a[3];if(c&&(s|=0),void 0===l||"["===l&&o+2===n){addUniform(r,void 0===l?new SingleUniform(s,e,t):new PureArrayUniform(s,e,t));break}var h=r.map[s];void 0===h&&addUniform(r,h=new StructuredUniform(s)),r=h}}function WebGLUniforms(e,t,r){UniformContainer.call(this),this.renderer=r;for(var i=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),n=0;n<i;++n){var a=e.getActiveUniform(t,n),o=a.name;parseUniform(a,e.getUniformLocation(t,o),this)}}WebGLUniforms.prototype.setValue=function(e,t,r){var i=this.map[t];void 0!==i&&i.setValue(e,r,this.renderer)},WebGLUniforms.prototype.setOptional=function(e,t,r){var i=t[r];void 0!==i&&this.setValue(e,r,i)},WebGLUniforms.upload=function(e,t,r,i){for(var n=0,a=t.length;n!==a;++n){var o=t[n],s=r[o.id];!1!==s.needsUpdate&&o.setValue(e,s.value,i)}},WebGLUniforms.seqWithValue=function(e,t){for(var r=[],i=0,n=e.length;i!==n;++i){var a=e[i];a.id in t&&r.push(a)}return r};var Ut={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};function Color(e,t,r){return void 0===t&&void 0===r?this.set(e):this.setRGB(e,t,r)}Object.assign(Color.prototype,{isColor:!0,r:1,g:1,b:1,set:function(e){return e&&e.isColor?this.copy(e):"number"==typeof e?this.setHex(e):"string"==typeof e&&this.setStyle(e),this},setScalar:function(e){return this.r=e,this.g=e,this.b=e,this},setHex:function(e){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,this},setRGB:function(e,t,r){return this.r=e,this.g=t,this.b=r,this},setHSL:function(){function hue2rgb(e,t,r){return r<0&&(r+=1),1<r&&(r-=1),r<1/6?e+6*(t-e)*r:r<.5?t:r<2/3?e+6*(t-e)*(2/3-r):e}return function setHSL(e,t,r){if(e=Et.euclideanModulo(e,1),t=Et.clamp(t,0,1),r=Et.clamp(r,0,1),0===t)this.r=this.g=this.b=r;else{var i=r<=.5?r*(1+t):r+t-r*t,n=2*r-i;this.r=hue2rgb(n,i,e+1/3),this.g=hue2rgb(n,i,e),this.b=hue2rgb(n,i,e-1/3)}return this}}(),setStyle:function(t){function handleAlpha(e){void 0!==e&&parseFloat(e)<1&&console.warn("THREE.Color: Alpha component of "+t+" will be ignored.")}var e;if(e=/^((?:rgb|hsl)a?)\(\s*([^\)]*)\)/.exec(t)){var r,i=e[1],n=e[2];switch(i){case"rgb":case"rgba":if(r=/^(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(n))return this.r=Math.min(255,parseInt(r[1],10))/255,this.g=Math.min(255,parseInt(r[2],10))/255,this.b=Math.min(255,parseInt(r[3],10))/255,handleAlpha(r[5]),this;if(r=/^(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(n))return this.r=Math.min(100,parseInt(r[1],10))/100,this.g=Math.min(100,parseInt(r[2],10))/100,this.b=Math.min(100,parseInt(r[3],10))/100,handleAlpha(r[5]),this;break;case"hsl":case"hsla":if(r=/^([0-9]*\.?[0-9]+)\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(n)){var a=parseFloat(r[1])/360,o=parseInt(r[2],10)/100,s=parseInt(r[3],10)/100;return handleAlpha(r[5]),this.setHSL(a,o,s)}}}else if(e=/^\#([A-Fa-f0-9]+)$/.exec(t)){var c,l=(c=e[1]).length;if(3===l)return this.r=parseInt(c.charAt(0)+c.charAt(0),16)/255,this.g=parseInt(c.charAt(1)+c.charAt(1),16)/255,this.b=parseInt(c.charAt(2)+c.charAt(2),16)/255,this;if(6===l)return this.r=parseInt(c.charAt(0)+c.charAt(1),16)/255,this.g=parseInt(c.charAt(2)+c.charAt(3),16)/255,this.b=parseInt(c.charAt(4)+c.charAt(5),16)/255,this}t&&0<t.length&&(void 0!==(c=Ut[t])?this.setHex(c):console.warn("THREE.Color: Unknown color "+t));return this},clone:function(){return new this.constructor(this.r,this.g,this.b)},copy:function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this},copyGammaToLinear:function(e,t){return void 0===t&&(t=2),this.r=Math.pow(e.r,t),this.g=Math.pow(e.g,t),this.b=Math.pow(e.b,t),this},copyLinearToGamma:function(e,t){void 0===t&&(t=2);var r=0<t?1/t:1;return this.r=Math.pow(e.r,r),this.g=Math.pow(e.g,r),this.b=Math.pow(e.b,r),this},convertGammaToLinear:function(){var e=this.r,t=this.g,r=this.b;return this.r=e*e,this.g=t*t,this.b=r*r,this},convertLinearToGamma:function(){return this.r=Math.sqrt(this.r),this.g=Math.sqrt(this.g),this.b=Math.sqrt(this.b),this},getHex:function(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0},getHexString:function(){return("000000"+this.getHex().toString(16)).slice(-6)},getHSL:function(e){var t,r,i=e||{h:0,s:0,l:0},n=this.r,a=this.g,o=this.b,s=Math.max(n,a,o),c=Math.min(n,a,o),l=(c+s)/2;if(c===s)r=t=0;else{var h=s-c;switch(r=l<=.5?h/(s+c):h/(2-s-c),s){case n:t=(a-o)/h+(a<o?6:0);break;case a:t=(o-n)/h+2;break;case o:t=(n-a)/h+4}t/=6}return i.h=t,i.s=r,i.l=l,i},getStyle:function(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"},offsetHSL:function(e,t,r){var i=this.getHSL();return i.h+=e,i.s+=t,i.l+=r,this.setHSL(i.h,i.s,i.l),this},add:function(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this},addColors:function(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this},addScalar:function(e){return this.r+=e,this.g+=e,this.b+=e,this},sub:function(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this},multiply:function(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this},multiplyScalar:function(e){return this.r*=e,this.g*=e,this.b*=e,this},lerp:function(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this},equals:function(e){return e.r===this.r&&e.g===this.g&&e.b===this.b},fromArray:function(e,t){return void 0===t&&(t=0),this.r=e[t],this.g=e[t+1],this.b=e[t+2],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e},toJSON:function(){return this.getHex()}});var Ot,Vt,Ft={common:{diffuse:{value:new Color(15658734)},opacity:{value:1},map:{value:null},uvTransform:{value:new Matrix3},alphaMap:{value:null}},specularmap:{specularMap:{value:null}},envmap:{envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1}},emissivemap:{emissiveMap:{value:null}},bumpmap:{bumpMap:{value:null},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalScale:{value:new Vector2(1,1)}},displacementmap:{displacementMap:{value:null},displacementScale:{value:1},displacementBias:{value:0}},roughnessmap:{roughnessMap:{value:null}},metalnessmap:{metalnessMap:{value:null}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new Color(16777215)}},lights:{ambientLightColor:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{}}},spotShadowMap:{value:[]},spotShadowMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}}},points:{diffuse:{value:new Color(15658734)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},uvTransform:{value:new Matrix3}}},Nt={merge:function(e){for(var t={},r=0;r<e.length;r++){var i=this.clone(e[r]);for(var n in i)t[n]=i[n]}return t},clone:function(e){var t={};for(var r in e)for(var i in t[r]={},e[r]){var n=e[r][i];n&&(n.isColor||n.isMatrix3||n.isMatrix4||n.isVector2||n.isVector3||n.isVector4||n.isTexture)?t[r][i]=n.clone():Array.isArray(n)?t[r][i]=n.slice():t[r][i]=n}return t}},zt={alphamap_fragment:"#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vUv ).g;\n#endif\n",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif\n",alphatest_fragment:"#ifdef ALPHATEST\n\tif ( diffuseColor.a < ALPHATEST ) discard;\n#endif\n",aomap_fragment:"#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vUv2 ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_ENVMAP ) && defined( PHYSICAL )\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.specularRoughness );\n\t#endif\n#endif\n",aomap_pars_fragment:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",begin_vertex:"\nvec3 transformed = vec3( position );\n",beginnormal_vertex:"\nvec3 objectNormal = vec3( normal );\n",bsdfs:"float punctualLightIntensityToIrradianceFactor( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n\tif( decayExponent > 0.0 ) {\n#if defined ( PHYSICALLY_CORRECT_LIGHTS )\n\t\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\t\tfloat maxDistanceCutoffFactor = pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t\treturn distanceFalloff * maxDistanceCutoffFactor;\n#else\n\t\treturn pow( saturate( -lightDistance / cutoffDistance + 1.0 ), decayExponent );\n#endif\n\t}\n\treturn 1.0;\n}\nvec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 specularColor, const in float dotLH ) {\n\tfloat fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );\n\treturn ( 1.0 - specularColor ) * fresnel + specularColor;\n}\nfloat G_GGX_Smith( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\tfloat gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\treturn 1.0 / ( gl * gv );\n}\nfloat G_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\nvec3 BRDF_Specular_GGX( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\tfloat dotNL = saturate( dot( geometry.normal, incidentLight.direction ) );\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\tfloat D = D_GGX( alpha, dotNH );\n\treturn F * ( G * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE  = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS  = 0.5 / LUT_SIZE;\n\tfloat theta = acos( dot( N, V ) );\n\tvec2 uv = vec2(\n\t\tsqrt( saturate( roughness ) ),\n\t\tsaturate( theta / ( 0.5 * PI ) ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.86267 + (0.49788 + 0.01436 * y ) * y;\n\tfloat b = 3.45068 + (4.18814 + y) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = (x > 0.0) ? v : 0.5 * inversesqrt( 1.0 - x * x ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tvec3 result = vec3( LTC_ClippedSphereFormFactor( vectorFormFactor ) );\n\treturn result;\n}\nvec3 BRDF_Specular_GGX_Environment( const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\tvec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n\treturn specularColor * AB.x + AB.y;\n}\nfloat G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_Specular_BlinnPhong( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n}\nfloat GGXRoughnessToBlinnExponent( const in float ggxRoughness ) {\n\treturn ( 2.0 / pow2( ggxRoughness + 0.0001 ) - 2.0 );\n}\nfloat BlinnExponentToGGXRoughness( const in float blinnExponent ) {\n\treturn sqrt( 2.0 / ( blinnExponent + 2.0 ) );\n}\n",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vUv );\n\t\tvec2 dSTdy = dFdy( vUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {\n\t\tvec3 vSigmaX = vec3( dFdx( surf_pos.x ), dFdx( surf_pos.y ), dFdx( surf_pos.z ) );\n\t\tvec3 vSigmaY = vec3( dFdy( surf_pos.x ), dFdy( surf_pos.y ), dFdy( surf_pos.z ) );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 );\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif\n",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; ++ i ) {\n\t\tvec4 plane = clippingPlanes[ i ];\n\t\tif ( dot( vViewPosition, plane.xyz ) > plane.w ) discard;\n\t}\n\t\t\n\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\tbool clipped = true;\n\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; ++ i ) {\n\t\t\tvec4 plane = clippingPlanes[ i ];\n\t\t\tclipped = ( dot( vViewPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t}\n\t\tif ( clipped ) discard;\n\t\n\t#endif\n#endif\n",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES > 0\n\t#if ! defined( PHYSICAL ) && ! defined( PHONG )\n\t\tvarying vec3 vViewPosition;\n\t#endif\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif\n",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES > 0 && ! defined( PHYSICAL ) && ! defined( PHONG )\n\tvarying vec3 vViewPosition;\n#endif\n",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES > 0 && ! defined( PHYSICAL ) && ! defined( PHONG )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n",color_fragment:"#ifdef USE_COLOR\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment:"#ifdef USE_COLOR\n\tvarying vec3 vColor;\n#endif\n",color_pars_vertex:"#ifdef USE_COLOR\n\tvarying vec3 vColor;\n#endif",color_vertex:"#ifdef USE_COLOR\n\tvColor.xyz = color.xyz;\n#endif",common:"#define PI 3.14159265359\n#define PI2 6.28318530718\n#define PI_HALF 1.5707963267949\n#define RECIPROCAL_PI 0.31830988618\n#define RECIPROCAL_PI2 0.15915494\n#define LOG2 1.442695\n#define EPSILON 1e-6\n#define saturate(a) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat average( const in vec3 color ) { return dot( color, vec3( 0.3333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract(sin(sn) * c);\n}\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\nstruct GeometricContext {\n\tvec3 position;\n\tvec3 normal;\n\tvec3 viewDir;\n};\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nvec3 projectOnPlane(in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\tfloat distance = dot( planeNormal, point - pointOnPlane );\n\treturn - distance * planeNormal + point;\n}\nfloat sideOfPlane( in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn sign( dot( point - pointOnPlane, planeNormal ) );\n}\nvec3 linePlaneIntersect( in vec3 pointOnLine, in vec3 lineDirection, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn lineDirection * ( dot( planeNormal, pointOnPlane - pointOnLine ) / dot( planeNormal, lineDirection ) ) + pointOnLine;\n}\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nfloat linearToRelativeLuminance( const in vec3 color ) {\n\tvec3 weights = vec3( 0.2126, 0.7152, 0.0722 );\n\treturn dot( weights, color.rgb );\n}\n",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n#define cubeUV_textureSize (1024.0)\nint getFaceFromDirection(vec3 direction) {\n\tvec3 absDirection = abs(direction);\n\tint face = -1;\n\tif( absDirection.x > absDirection.z ) {\n\t\tif(absDirection.x > absDirection.y )\n\t\t\tface = direction.x > 0.0 ? 0 : 3;\n\t\telse\n\t\t\tface = direction.y > 0.0 ? 1 : 4;\n\t}\n\telse {\n\t\tif(absDirection.z > absDirection.y )\n\t\t\tface = direction.z > 0.0 ? 2 : 5;\n\t\telse\n\t\t\tface = direction.y > 0.0 ? 1 : 4;\n\t}\n\treturn face;\n}\n#define cubeUV_maxLods1  (log2(cubeUV_textureSize*0.25) - 1.0)\n#define cubeUV_rangeClamp (exp2((6.0 - 1.0) * 2.0))\nvec2 MipLevelInfo( vec3 vec, float roughnessLevel, float roughness ) {\n\tfloat scale = exp2(cubeUV_maxLods1 - roughnessLevel);\n\tfloat dxRoughness = dFdx(roughness);\n\tfloat dyRoughness = dFdy(roughness);\n\tvec3 dx = dFdx( vec * scale * dxRoughness );\n\tvec3 dy = dFdy( vec * scale * dyRoughness );\n\tfloat d = max( dot( dx, dx ), dot( dy, dy ) );\n\td = clamp(d, 1.0, cubeUV_rangeClamp);\n\tfloat mipLevel = 0.5 * log2(d);\n\treturn vec2(floor(mipLevel), fract(mipLevel));\n}\n#define cubeUV_maxLods2 (log2(cubeUV_textureSize*0.25) - 2.0)\n#define cubeUV_rcpTextureSize (1.0 / cubeUV_textureSize)\nvec2 getCubeUV(vec3 direction, float roughnessLevel, float mipLevel) {\n\tmipLevel = roughnessLevel > cubeUV_maxLods2 - 3.0 ? 0.0 : mipLevel;\n\tfloat a = 16.0 * cubeUV_rcpTextureSize;\n\tvec2 exp2_packed = exp2( vec2( roughnessLevel, mipLevel ) );\n\tvec2 rcp_exp2_packed = vec2( 1.0 ) / exp2_packed;\n\tfloat powScale = exp2_packed.x * exp2_packed.y;\n\tfloat scale = rcp_exp2_packed.x * rcp_exp2_packed.y * 0.25;\n\tfloat mipOffset = 0.75*(1.0 - rcp_exp2_packed.y) * rcp_exp2_packed.x;\n\tbool bRes = mipLevel == 0.0;\n\tscale =  bRes && (scale < a) ? a : scale;\n\tvec3 r;\n\tvec2 offset;\n\tint face = getFaceFromDirection(direction);\n\tfloat rcpPowScale = 1.0 / powScale;\n\tif( face == 0) {\n\t\tr = vec3(direction.x, -direction.z, direction.y);\n\t\toffset = vec2(0.0+mipOffset,0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 1) {\n\t\tr = vec3(direction.y, direction.x, direction.z);\n\t\toffset = vec2(scale+mipOffset, 0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 2) {\n\t\tr = vec3(direction.z, direction.x, direction.y);\n\t\toffset = vec2(2.0*scale+mipOffset, 0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 3) {\n\t\tr = vec3(direction.x, direction.z, direction.y);\n\t\toffset = vec2(0.0+mipOffset,0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\telse if( face == 4) {\n\t\tr = vec3(direction.y, direction.x, -direction.z);\n\t\toffset = vec2(scale+mipOffset, 0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\telse {\n\t\tr = vec3(direction.z, -direction.x, direction.y);\n\t\toffset = vec2(2.0*scale+mipOffset, 0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\tr = normalize(r);\n\tfloat texelOffset = 0.5 * cubeUV_rcpTextureSize;\n\tvec2 s = ( r.yz / abs( r.x ) + vec2( 1.0 ) ) * 0.5;\n\tvec2 base = offset + vec2( texelOffset );\n\treturn base + s * ( scale - 2.0 * texelOffset );\n}\n#define cubeUV_maxLods3 (log2(cubeUV_textureSize*0.25) - 3.0)\nvec4 textureCubeUV(vec3 reflectedDirection, float roughness ) {\n\tfloat roughnessVal = roughness* cubeUV_maxLods3;\n\tfloat r1 = floor(roughnessVal);\n\tfloat r2 = r1 + 1.0;\n\tfloat t = fract(roughnessVal);\n\tvec2 mipInfo = MipLevelInfo(reflectedDirection, r1, roughness);\n\tfloat s = mipInfo.y;\n\tfloat level0 = mipInfo.x;\n\tfloat level1 = level0 + 1.0;\n\tlevel1 = level1 > 5.0 ? 5.0 : level1;\n\tlevel0 += min( floor( s + 0.5 ), 5.0 );\n\tvec2 uv_10 = getCubeUV(reflectedDirection, r1, level0);\n\tvec4 color10 = envMapTexelToLinear(texture2D(envMap, uv_10));\n\tvec2 uv_20 = getCubeUV(reflectedDirection, r2, level0);\n\tvec4 color20 = envMapTexelToLinear(texture2D(envMap, uv_20));\n\tvec4 result = mix(color10, color20, t);\n\treturn vec4(result.rgb, 1.0);\n}\n#endif\n",defaultnormal_vertex:"vec3 transformedNormal = normalMatrix * objectNormal;\n#ifdef FLIP_SIDED\n\ttransformedNormal = - transformedNormal;\n#endif\n",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif\n",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, uv ).x * displacementScale + displacementBias );\n#endif\n",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vUv );\n\temissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif\n",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif\n",encodings_fragment:"  gl_FragColor = linearToOutputTexel( gl_FragColor );\n",encodings_pars_fragment:"\nvec4 LinearToLinear( in vec4 value ) {\n\treturn value;\n}\nvec4 GammaToLinear( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );\n}\nvec4 LinearToGamma( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );\n}\nvec4 sRGBToLinear( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );\n}\nvec4 LinearTosRGB( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.w );\n}\nvec4 RGBEToLinear( in vec4 value ) {\n\treturn vec4( value.rgb * exp2( value.a * 255.0 - 128.0 ), 1.0 );\n}\nvec4 LinearToRGBE( in vec4 value ) {\n\tfloat maxComponent = max( max( value.r, value.g ), value.b );\n\tfloat fExp = clamp( ceil( log2( maxComponent ) ), -128.0, 127.0 );\n\treturn vec4( value.rgb / exp2( fExp ), ( fExp + 128.0 ) / 255.0 );\n}\nvec4 RGBMToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.xyz * value.w * maxRange, 1.0 );\n}\nvec4 LinearToRGBM( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.x, max( value.g, value.b ) );\n\tfloat M      = clamp( maxRGB / maxRange, 0.0, 1.0 );\n\tM            = ceil( M * 255.0 ) / 255.0;\n\treturn vec4( value.rgb / ( M * maxRange ), M );\n}\nvec4 RGBDToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.rgb * ( ( maxRange / 255.0 ) / value.a ), 1.0 );\n}\nvec4 LinearToRGBD( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.x, max( value.g, value.b ) );\n\tfloat D      = max( maxRange / maxRGB, 1.0 );\n\tD            = min( floor( D ) / 255.0, 1.0 );\n\treturn vec4( value.rgb * ( D * ( 255.0 / maxRange ) ), D );\n}\nconst mat3 cLogLuvM = mat3( 0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969 );\nvec4 LinearToLogLuv( in vec4 value )  {\n\tvec3 Xp_Y_XYZp = value.rgb * cLogLuvM;\n\tXp_Y_XYZp = max(Xp_Y_XYZp, vec3(1e-6, 1e-6, 1e-6));\n\tvec4 vResult;\n\tvResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;\n\tfloat Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;\n\tvResult.w = fract(Le);\n\tvResult.z = (Le - (floor(vResult.w*255.0))/255.0)/255.0;\n\treturn vResult;\n}\nconst mat3 cLogLuvInverseM = mat3( 6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268 );\nvec4 LogLuvToLinear( in vec4 value ) {\n\tfloat Le = value.z * 255.0 + value.w;\n\tvec3 Xp_Y_XYZp;\n\tXp_Y_XYZp.y = exp2((Le - 127.0) / 2.0);\n\tXp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;\n\tXp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;\n\tvec3 vRGB = Xp_Y_XYZp.rgb * cLogLuvInverseM;\n\treturn vec4( max(vRGB, 0.0), 1.0 );\n}\n",envmap_fragment:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#elif defined( ENVMAP_TYPE_EQUIREC )\n\t\tvec2 sampleUV;\n\t\treflectVec = normalize( reflectVec );\n\t\tsampleUV.y = asin( clamp( reflectVec.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\t\tsampleUV.x = atan( reflectVec.z, reflectVec.x ) * RECIPROCAL_PI2 + 0.5;\n\t\tvec4 envColor = texture2D( envMap, sampleUV );\n\t#elif defined( ENVMAP_TYPE_SPHERE )\n\t\treflectVec = normalize( reflectVec );\n\t\tvec3 reflectView = normalize( ( viewMatrix * vec4( reflectVec, 0.0 ) ).xyz + vec3( 0.0, 0.0, 1.0 ) );\n\t\tvec4 envColor = texture2D( envMap, reflectView.xy * 0.5 + 0.5 );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\tenvColor = envMapTexelToLinear( envColor );\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif\n",envmap_pars_fragment:"#if defined( USE_ENVMAP ) || defined( PHYSICAL )\n\tuniform float reflectivity;\n\tuniform float envMapIntensity;\n#endif\n#ifdef USE_ENVMAP\n\t#if ! defined( PHYSICAL ) && ( defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) )\n\t\tvarying vec3 vWorldPosition;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\tuniform float flipEnvMap;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( PHYSICAL )\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif\n",envmap_pars_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif\n",envmap_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif\n",fog_vertex:"\n#ifdef USE_FOG\nfogDepth = -mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\n  varying float fogDepth;\n#endif\n",fog_fragment:"#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 ) );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, fogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif\n",fog_pars_fragment:"#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float fogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif\n",gradientmap_pars_fragment:"#ifdef TOON\n\tuniform sampler2D gradientMap;\n\tvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\t\tfloat dotNL = dot( normal, lightDirection );\n\t\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t\t#ifdef USE_GRADIENTMAP\n\t\t\treturn texture2D( gradientMap, coord ).rgb;\n\t\t#else\n\t\t\treturn ( coord.x < 0.7 ) ? vec3( 0.7 ) : vec3( 1.0 );\n\t\t#endif\n\t}\n#endif\n",lightmap_fragment:"#ifdef USE_LIGHTMAP\n\treflectedLight.indirectDiffuse += PI * texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n#endif\n",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_vertex:"vec3 diffuse = vec3( 1.0 );\nGeometricContext geometry;\ngeometry.position = mvPosition.xyz;\ngeometry.normal = normalize( transformedNormal );\ngeometry.viewDir = normalize( -mvPosition.xyz );\nGeometricContext backGeometry;\nbackGeometry.position = geometry.position;\nbackGeometry.normal = -geometry.normal;\nbackGeometry.viewDir = geometry.viewDir;\nvLightFront = vec3( 0.0 );\n#ifdef DOUBLE_SIDED\n\tvLightBack = vec3( 0.0 );\n#endif\nIncidentLight directLight;\nfloat dotNL;\nvec3 directLightColor_Diffuse;\n#if NUM_POINT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tgetPointDirectLightIrradiance( pointLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tgetSpotDirectLightIrradiance( spotLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_DIR_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tgetDirectionalDirectLightIrradiance( directionalLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\tvLightFront += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += getHemisphereLightIrradiance( hemisphereLights[ i ], backGeometry );\n\t\t#endif\n\t}\n#endif\n",lights_pars:"uniform vec3 ambientLightColor;\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treturn irradiance;\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalDirectLightIrradiance( const in DirectionalLight directionalLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tdirectLight.color = directionalLight.color;\n\t\tdirectLight.direction = directionalLight.direction;\n\t\tdirectLight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t\tfloat shadowCameraNear;\n\t\tfloat shadowCameraFar;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointDirectLightIrradiance( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tvec3 lVector = pointLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tdirectLight.color = pointLight.color;\n\t\tdirectLight.color *= punctualLightIntensityToIrradianceFactor( lightDistance, pointLight.distance, pointLight.decay );\n\t\tdirectLight.visible = ( directLight.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotDirectLightIrradiance( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight directLight  ) {\n\t\tvec3 lVector = spotLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tfloat angleCos = dot( directLight.direction, spotLight.direction );\n\t\tif ( angleCos > spotLight.coneCos ) {\n\t\t\tfloat spotEffect = smoothstep( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\t\tdirectLight.color = spotLight.color;\n\t\t\tdirectLight.color *= spotEffect * punctualLightIntensityToIrradianceFactor( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tdirectLight.visible = true;\n\t\t} else {\n\t\t\tdirectLight.color = vec3( 0.0 );\n\t\t\tdirectLight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltcMat;\tuniform sampler2D ltcMag;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in GeometricContext geometry ) {\n\t\tfloat dotNL = dot( geometry.normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tirradiance *= PI;\n\t\t#endif\n\t\treturn irradiance;\n\t}\n#endif\n#if defined( USE_ENVMAP ) && defined( PHYSICAL )\n\tvec3 getLightProbeIndirectIrradiance( const in GeometricContext geometry, const in int maxMIPLevel ) {\n\t\tvec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\n\t\t\tvec4 envMapColor = textureCubeUV( queryVec, 1.0 );\n\t\t#else\n\t\t\tvec4 envMapColor = vec4( 0.0 );\n\t\t#endif\n\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t}\n\tfloat getSpecularMIPLevel( const in float blinnShininessExponent, const in int maxMIPLevel ) {\n\t\tfloat maxMIPLevelScalar = float( maxMIPLevel );\n\t\tfloat desiredMIPLevel = maxMIPLevelScalar + 0.79248 - 0.5 * log2( pow2( blinnShininessExponent ) + 1.0 );\n\t\treturn clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );\n\t}\n\tvec3 getLightProbeIndirectRadiance( const in GeometricContext geometry, const in float blinnShininessExponent, const in int maxMIPLevel ) {\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( -geometry.viewDir, geometry.normal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( -geometry.viewDir, geometry.normal, refractionRatio );\n\t\t#endif\n\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\tfloat specularMIPLevel = getSpecularMIPLevel( blinnShininessExponent, maxMIPLevel );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\n\t\t\tvec4 envMapColor = textureCubeUV(queryReflectVec, BlinnExponentToGGXRoughness(blinnShininessExponent));\n\t\t#elif defined( ENVMAP_TYPE_EQUIREC )\n\t\t\tvec2 sampleUV;\n\t\t\tsampleUV.y = asin( clamp( reflectVec.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\t\t\tsampleUV.x = atan( reflectVec.z, reflectVec.x ) * RECIPROCAL_PI2 + 0.5;\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = texture2DLodEXT( envMap, sampleUV, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = texture2D( envMap, sampleUV, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_SPHERE )\n\t\t\tvec3 reflectView = normalize( ( viewMatrix * vec4( reflectVec, 0.0 ) ).xyz + vec3( 0.0,0.0,1.0 ) );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = texture2DLodEXT( envMap, reflectView.xy * 0.5 + 0.5, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = texture2D( envMap, reflectView.xy * 0.5 + 0.5, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#endif\n\t\treturn envMapColor.rgb * envMapIntensity;\n\t}\n#endif\n",lights_phong_fragment:"BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;\n",lights_phong_pars_fragment:"varying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\nstruct BlinnPhongMaterial {\n\tvec3\tdiffuseColor;\n\tvec3\tspecularColor;\n\tfloat\tspecularShininess;\n\tfloat\tspecularStrength;\n};\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\t#ifdef TOON\n\t\tvec3 irradiance = getGradientIrradiance( geometry.normal, directLight.direction ) * directLight.color;\n\t#else\n\t\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\t\tvec3 irradiance = dotNL * directLight.color;\n\t#endif\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong\n#define Material_LightProbeLOD( material )\t(0)\n",lights_physical_fragment:"PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nmaterial.specularRoughness = clamp( roughnessFactor, 0.04, 1.0 );\n#ifdef STANDARD\n\tmaterial.specularColor = mix( vec3( DEFAULT_SPECULAR_COEFFICIENT ), diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( MAXIMUM_SPECULAR_COEFFICIENT * pow2( reflectivity ) ), diffuseColor.rgb, metalnessFactor );\n\tmaterial.clearCoat = saturate( clearCoat );\tmaterial.clearCoatRoughness = clamp( clearCoatRoughness, 0.04, 1.0 );\n#endif\n",lights_physical_pars_fragment:"struct PhysicalMaterial {\n\tvec3\tdiffuseColor;\n\tfloat\tspecularRoughness;\n\tvec3\tspecularColor;\n\t#ifndef STANDARD\n\t\tfloat clearCoat;\n\t\tfloat clearCoatRoughness;\n\t#endif\n};\n#define MAXIMUM_SPECULAR_COEFFICIENT 0.16\n#define DEFAULT_SPECULAR_COEFFICIENT 0.04\nfloat clearCoatDHRApprox( const in float roughness, const in float dotNL ) {\n\treturn DEFAULT_SPECULAR_COEFFICIENT + ( 1.0 - DEFAULT_SPECULAR_COEFFICIENT ) * ( pow( 1.0 - dotNL, 5.0 ) * pow( 1.0 - roughness, 2.0 ) );\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometry.normal;\n\t\tvec3 viewDir = geometry.viewDir;\n\t\tvec3 position = geometry.position;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.specularRoughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos - halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos + halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos + halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos - halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tfloat norm = texture2D( ltcMag, uv ).a;\n\t\tvec4 t = texture2D( ltcMat, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3(   1,   0, t.y ),\n\t\t\tvec3(   0, t.z,   0 ),\n\t\t\tvec3( t.w,   0, t.x )\n\t\t);\n\t\treflectedLight.directSpecular += lightColor * material.specularColor * norm * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\t#ifndef STANDARD\n\t\tfloat clearCoatDHR = material.clearCoat * clearCoatDHRApprox( material.clearCoatRoughness, dotNL );\n\t#else\n\t\tfloat clearCoatDHR = 0.0;\n\t#endif\n\treflectedLight.directSpecular += ( 1.0 - clearCoatDHR ) * irradiance * BRDF_Specular_GGX( directLight, geometry, material.specularColor, material.specularRoughness );\n\treflectedLight.directDiffuse += ( 1.0 - clearCoatDHR ) * irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\t#ifndef STANDARD\n\t\treflectedLight.directSpecular += irradiance * material.clearCoat * BRDF_Specular_GGX( directLight, geometry, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearCoatRoughness );\n\t#endif\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 clearCoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t#ifndef STANDARD\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\t\tfloat dotNL = dotNV;\n\t\tfloat clearCoatDHR = material.clearCoat * clearCoatDHRApprox( material.clearCoatRoughness, dotNL );\n\t#else\n\t\tfloat clearCoatDHR = 0.0;\n\t#endif\n\treflectedLight.indirectSpecular += ( 1.0 - clearCoatDHR ) * radiance * BRDF_Specular_GGX_Environment( geometry, material.specularColor, material.specularRoughness );\n\t#ifndef STANDARD\n\t\treflectedLight.indirectSpecular += clearCoatRadiance * material.clearCoat * BRDF_Specular_GGX_Environment( geometry, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearCoatRoughness );\n\t#endif\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\n#define Material_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.specularRoughness )\n#define Material_ClearCoat_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.clearCoatRoughness )\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}\n",lights_template:"\nGeometricContext geometry;\ngeometry.position = - vViewPosition;\ngeometry.normal = normal;\ngeometry.viewDir = normalize( vViewPosition );\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointDirectLightIrradiance( pointLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( pointLight.shadow, directLight.visible ) ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotDirectLightIrradiance( spotLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( spotLight.shadow, directLight.visible ) ) ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( directionalLight.shadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\t#ifdef USE_LIGHTMAP\n\t\tvec3 lightMapIrradiance = texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tlightMapIrradiance *= PI;\n\t\t#endif\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t}\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( PHYSICAL ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tirradiance += getLightProbeIndirectIrradiance( geometry, 8 );\n\t#endif\n\tRE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\tvec3 radiance = getLightProbeIndirectRadiance( geometry, Material_BlinnShininessExponent( material ), 8 );\n\t#ifndef STANDARD\n\t\tvec3 clearCoatRadiance = getLightProbeIndirectRadiance( geometry, Material_ClearCoat_BlinnShininessExponent( material ), 8 );\n\t#else\n\t\tvec3 clearCoatRadiance = vec3( 0.0 );\n\t#endif\n\tRE_IndirectSpecular( radiance, clearCoatRadiance, geometry, material, reflectedLight );\n#endif\n",logdepthbuf_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tgl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment:"#ifdef USE_LOGDEPTHBUF\n\tuniform float logDepthBufFC;\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t#endif\n#endif\n",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t#endif\n\tuniform float logDepthBufFC;\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvFragDepth = 1.0 + gl_Position.w;\n\t#else\n\t\tgl_Position.z = log2( max( EPSILON, gl_Position.w + 1.0 ) ) * logDepthBufFC - 1.0;\n\t\tgl_Position.z *= gl_Position.w;\n\t#endif\n#endif\n",map_fragment:"#ifdef USE_MAP\n\tvec4 texelColor = texture2D( map, vUv );\n\ttexelColor = mapTexelToLinear( texelColor );\n\tdiffuseColor *= texelColor;\n#endif\n",map_pars_fragment:"#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n",map_particle_fragment:"#ifdef USE_MAP\n\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n\tvec4 mapTexel = texture2D( map, uv );\n\tdiffuseColor *= mapTexelToLinear( mapTexel );\n#endif\n",map_particle_pars_fragment:"#ifdef USE_MAP\n\tuniform mat3 uvTransform;\n\tuniform sampler2D map;\n#endif\n",metalnessmap_fragment:"float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif\n",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\n\tobjectNormal += ( morphNormal0 - normal ) * morphTargetInfluences[ 0 ];\n\tobjectNormal += ( morphNormal1 - normal ) * morphTargetInfluences[ 1 ];\n\tobjectNormal += ( morphNormal2 - normal ) * morphTargetInfluences[ 2 ];\n\tobjectNormal += ( morphNormal3 - normal ) * morphTargetInfluences[ 3 ];\n#endif\n",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n\t#ifndef USE_MORPHNORMALS\n\tuniform float morphTargetInfluences[ 8 ];\n\t#else\n\tuniform float morphTargetInfluences[ 4 ];\n\t#endif\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\n\ttransformed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];\n\ttransformed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];\n\ttransformed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];\n\ttransformed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];\n\t#ifndef USE_MORPHNORMALS\n\ttransformed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];\n\ttransformed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];\n\ttransformed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];\n\ttransformed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];\n\t#endif\n#endif\n",normal_fragment:"#ifdef FLAT_SHADED\n\tvec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );\n\tvec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal );\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t#endif\n#endif\n#ifdef USE_NORMALMAP\n\tnormal = perturbNormal2Arb( -vViewPosition, normal );\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );\n#endif\n",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n\tvec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm ) {\n\t\tvec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );\n\t\tvec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );\n\t\tvec2 st0 = dFdx( vUv.st );\n\t\tvec2 st1 = dFdy( vUv.st );\n\t\tvec3 S = normalize( q0 * st1.t - q1 * st0.t );\n\t\tvec3 T = normalize( -q0 * st1.s + q1 * st0.s );\n\t\tvec3 N = normalize( surf_norm );\n\t\tvec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\t\tmapN.xy = normalScale * mapN.xy;\n\t\tmat3 tsn = mat3( S, T, N );\n\t\treturn normalize( tsn * mapN );\n\t}\n#endif\n",packing:"vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 2.0 * rgb.xyz - 1.0;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nconst float ShiftRight8 = 1. / 256.;\nvec4 packDepthToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8;\treturn r * PackUpscale;\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n\treturn linearClipZ * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn (( near + viewZ ) * far ) / (( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * invClipZ - far );\n}\n",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif\n",project_vertex:"vec4 mvPosition = modelViewMatrix * vec4( transformed, 1.0 );\ngl_Position = projectionMatrix * mvPosition;\n",dithering_fragment:"#if defined( DITHERING )\n  gl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif\n",dithering_pars_fragment:"#if defined( DITHERING )\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif\n",roughnessmap_fragment:"float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vUv );\n\troughnessFactor *= texelRoughness.g;\n#endif\n",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHTS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHTS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHTS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHTS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tfloat texture2DShadowLerp( sampler2D depths, vec2 size, vec2 uv, float compare ) {\n\t\tconst vec2 offset = vec2( 0.0, 1.0 );\n\t\tvec2 texelSize = vec2( 1.0 ) / size;\n\t\tvec2 centroidUV = floor( uv * size + 0.5 ) / size;\n\t\tfloat lb = texture2DCompare( depths, centroidUV + texelSize * offset.xx, compare );\n\t\tfloat lt = texture2DCompare( depths, centroidUV + texelSize * offset.xy, compare );\n\t\tfloat rb = texture2DCompare( depths, centroidUV + texelSize * offset.yx, compare );\n\t\tfloat rt = texture2DCompare( depths, centroidUV + texelSize * offset.yy, compare );\n\t\tvec2 f = fract( uv * size + 0.5 );\n\t\tfloat a = mix( lb, lt, f.y );\n\t\tfloat b = mix( rb, rt, f.y );\n\t\tfloat c = mix( a, b, f.x );\n\t\treturn c;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tfloat shadow = 1.0;\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n\t\tbool inFrustum = all( inFrustumVec );\n\t\tbvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n\t\tbool frustumTest = all( frustumTestVec );\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tshadow = (\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn shadow;\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\tfloat dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );\t\tdp += shadowBias;\n\t\tvec3 bd3D = normalize( lightToPosition );\n\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t#endif\n\t}\n#endif\n",shadowmap_pars_vertex:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHTS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\t\tuniform mat4 spotShadowMatrix[ NUM_SPOT_LIGHTS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHTS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHTS ];\n\t#endif\n#endif\n",shadowmap_vertex:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tvSpotShadowCoord[ i ] = spotShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n#endif\n",shadowmask_pars_fragment:"float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\tDirectionalLight directionalLight;\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tshadow *= bool( directionalLight.shadow ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\tSpotLight spotLight;\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tshadow *= bool( spotLight.shadow ) ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t}\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\tPointLight pointLight;\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tshadow *= bool( pointLight.shadow ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t}\n\t#endif\n\t#endif\n\treturn shadow;\n}\n",skinbase_vertex:"#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\t#ifdef BONE_TEXTURE\n\t\tuniform sampler2D boneTexture;\n\t\tuniform int boneTextureSize;\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tfloat j = i * 4.0;\n\t\t\tfloat x = mod( j, float( boneTextureSize ) );\n\t\t\tfloat y = floor( j / float( boneTextureSize ) );\n\t\t\tfloat dx = 1.0 / float( boneTextureSize );\n\t\t\tfloat dy = 1.0 / float( boneTextureSize );\n\t\t\ty = dy * ( y + 0.5 );\n\t\t\tvec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\n\t\t\tvec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\n\t\t\tvec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\n\t\t\tvec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\n\t\t\tmat4 bone = mat4( v1, v2, v3, v4 );\n\t\t\treturn bone;\n\t\t}\n\t#else\n\t\tuniform mat4 boneMatrices[ MAX_BONES ];\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tmat4 bone = boneMatrices[ int(i) ];\n\t\t\treturn bone;\n\t\t}\n\t#endif\n#endif\n",skinning_vertex:"#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n#endif\n",skinnormal_vertex:"#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix  = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n#endif\n",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined( TONE_MAPPING )\n  gl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif\n",tonemapping_pars_fragment:"#ifndef saturate\n\t#define saturate(a) clamp( a, 0.0, 1.0 )\n#endif\nuniform float toneMappingExposure;\nuniform float toneMappingWhitePoint;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn toneMappingExposure * color;\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\n#define Uncharted2Helper( x ) max( ( ( x * ( 0.15 * x + 0.10 * 0.50 ) + 0.20 * 0.02 ) / ( x * ( 0.15 * x + 0.50 ) + 0.20 * 0.30 ) ) - 0.02 / 0.30, vec3( 0.0 ) )\nvec3 Uncharted2ToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( Uncharted2Helper( color ) / Uncharted2Helper( vec3( toneMappingWhitePoint ) ) );\n}\nvec3 OptimizedCineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\n",uv_pars_fragment:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvarying vec2 vUv;\n#endif",uv_pars_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvarying vec2 vUv;\n\tuniform mat3 uvTransform;\n#endif\n",uv_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n#endif",uv2_pars_fragment:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvarying vec2 vUv2;\n#endif",uv2_pars_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tattribute vec2 uv2;\n\tvarying vec2 vUv2;\n#endif",uv2_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvUv2 = uv2;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP )\n\tvec4 worldPosition = modelMatrix * vec4( transformed, 1.0 );\n#endif\n",cube_frag:"uniform samplerCube tCube;\nuniform float tFlip;\nuniform float opacity;\nvarying vec3 vWorldPosition;\nvoid main() {\n\tgl_FragColor = textureCube( tCube, vec3( tFlip * vWorldPosition.x, vWorldPosition.yz ) );\n\tgl_FragColor.a *= opacity;\n}\n",cube_vert:"varying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tvWorldPosition = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}\n",depth_frag:"#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <logdepthbuf_fragment>\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( gl_FragCoord.z ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( gl_FragCoord.z );\n\t#endif\n}\n",depth_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n}\n",distanceRGBA_frag:"#define DISTANCE\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\tgl_FragColor = packDepthToRGBA( dist );\n}\n",distanceRGBA_vert:"#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition.xyz;\n}\n",equirect_frag:"uniform sampler2D tEquirect;\nvarying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldPosition );\n\tvec2 sampleUV;\n\tsampleUV.y = asin( clamp( direction.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\tsampleUV.x = atan( direction.z, direction.x ) * RECIPROCAL_PI2 + 0.5;\n\tgl_FragColor = texture2D( tEquirect, sampleUV );\n}\n",equirect_vert:"varying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tvWorldPosition = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}\n",linedashed_frag:"uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",linedashed_vert:"uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <color_vertex>\n\tvLineDistance = scale * lineDistance;\n\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}\n",meshbasic_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\treflectedLight.indirectDiffuse += texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",meshbasic_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_ENVMAP\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}\n",meshlambert_frag:"uniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\nvarying vec3 vLightFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <bsdfs>\n#include <lights_pars>\n#include <fog_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <emissivemap_fragment>\n\treflectedLight.indirectDiffuse = getAmbientLightIrradiance( ambientLightColor );\n\t#include <lightmap_fragment>\n\treflectedLight.indirectDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb );\n\t#ifdef DOUBLE_SIDED\n\t\treflectedLight.directDiffuse = ( gl_FrontFacing ) ? vLightFront : vLightBack;\n\t#else\n\t\treflectedLight.directDiffuse = vLightFront;\n\t#endif\n\treflectedLight.directDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb ) * getShadowMask();\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n",meshlambert_vert:"#define LAMBERT\nvarying vec3 vLightFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <bsdfs>\n#include <lights_pars>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <lights_lambert_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_template>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",meshphysical_frag:"#define PHYSICAL\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifndef STANDARD\n\tuniform float clearCoat;\n\tuniform float clearCoatRoughness;\n#endif\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <cube_uv_reflection_fragment>\n#include <lights_pars>\n#include <lights_physical_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment>\n\t#include <emissivemap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_template>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n",meshphysical_vert:"#define PHYSICAL\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",normal_frag:"#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\nvoid main() {\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), opacity );\n}\n",normal_vert:"#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}\n",points_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <fog_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",points_vert:"uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <color_vertex>\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\t#ifdef USE_SIZEATTENUATION\n\t\tgl_PointSize = size * ( scale / - mvPosition.z );\n\t#else\n\t\tgl_PointSize = size;\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",shadow_frag:"uniform vec3 color;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\t#include <fog_fragment>\n}\n",shadow_vert:"#include <fog_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n"},Ht={basic:{uniforms:Nt.merge([Ft.common,Ft.specularmap,Ft.envmap,Ft.aomap,Ft.lightmap,Ft.fog]),vertexShader:zt.meshbasic_vert,fragmentShader:zt.meshbasic_frag},lambert:{uniforms:Nt.merge([Ft.common,Ft.specularmap,Ft.envmap,Ft.aomap,Ft.lightmap,Ft.emissivemap,Ft.fog,Ft.lights,{emissive:{value:new Color(0)}}]),vertexShader:zt.meshlambert_vert,fragmentShader:zt.meshlambert_frag},phong:{uniforms:Nt.merge([Ft.common,Ft.specularmap,Ft.envmap,Ft.aomap,Ft.lightmap,Ft.emissivemap,Ft.bumpmap,Ft.normalmap,Ft.displacementmap,Ft.gradientmap,Ft.fog,Ft.lights,{emissive:{value:new Color(0)},specular:{value:new Color(1118481)},shininess:{value:30}}]),vertexShader:zt.meshphong_vert,fragmentShader:zt.meshphong_frag},standard:{uniforms:Nt.merge([Ft.common,Ft.envmap,Ft.aomap,Ft.lightmap,Ft.emissivemap,Ft.bumpmap,Ft.normalmap,Ft.displacementmap,Ft.roughnessmap,Ft.metalnessmap,Ft.fog,Ft.lights,{emissive:{value:new Color(0)},roughness:{value:.5},metalness:{value:.5},envMapIntensity:{value:1}}]),vertexShader:zt.meshphysical_vert,fragmentShader:zt.meshphysical_frag},points:{uniforms:Nt.merge([Ft.points,Ft.fog]),vertexShader:zt.points_vert,fragmentShader:zt.points_frag},dashed:{uniforms:Nt.merge([Ft.common,Ft.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:zt.linedashed_vert,fragmentShader:zt.linedashed_frag},depth:{uniforms:Nt.merge([Ft.common,Ft.displacementmap]),vertexShader:zt.depth_vert,fragmentShader:zt.depth_frag},normal:{uniforms:Nt.merge([Ft.common,Ft.bumpmap,Ft.normalmap,Ft.displacementmap,{opacity:{value:1}}]),vertexShader:zt.normal_vert,fragmentShader:zt.normal_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:zt.cube_vert,fragmentShader:zt.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:zt.equirect_vert,fragmentShader:zt.equirect_frag},distanceRGBA:{uniforms:Nt.merge([Ft.common,Ft.displacementmap,{referencePosition:{value:new Vector3},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:zt.distanceRGBA_vert,fragmentShader:zt.distanceRGBA_frag},shadow:{uniforms:Nt.merge([Ft.lights,Ft.fog,{color:{value:new Color(0)},opacity:{value:1}}]),vertexShader:zt.shadow_vert,fragmentShader:zt.shadow_frag}};function Box2(e,t){this.min=void 0!==e?e:new Vector2(1/0,1/0),this.max=void 0!==t?t:new Vector2(-1/0,-1/0)}function WebGLFlareRenderer(e,x,b,M,a){var _,w,r,T,E,S,A,L;function init(){var e=new Float32Array([-1,-1,0,0,1,-1,1,0,1,1,1,1,-1,1,0,1]),t=new Uint16Array([0,1,2,0,2,3]);_=x.createBuffer(),w=x.createBuffer(),x.bindBuffer(x.ARRAY_BUFFER,_),x.bufferData(x.ARRAY_BUFFER,e,x.STATIC_DRAW),x.bindBuffer(x.ELEMENT_ARRAY_BUFFER,w),x.bufferData(x.ELEMENT_ARRAY_BUFFER,t,x.STATIC_DRAW),A=x.createTexture(),L=x.createTexture(),b.bindTexture(x.TEXTURE_2D,A),x.texImage2D(x.TEXTURE_2D,0,x.RGB,16,16,0,x.RGB,x.UNSIGNED_BYTE,null),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MAG_FILTER,x.NEAREST),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MIN_FILTER,x.NEAREST),b.bindTexture(x.TEXTURE_2D,L),x.texImage2D(x.TEXTURE_2D,0,x.RGBA,16,16,0,x.RGBA,x.UNSIGNED_BYTE,null),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MAG_FILTER,x.NEAREST),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MIN_FILTER,x.NEAREST),r={vertexShader:["uniform lowp int renderType;","uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","uniform sampler2D occlusionMap;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","varying float vVisibility;","void main() {","\tvUV = uv;","\tvec2 pos = position;","\tif ( renderType == 2 ) {","\t\tvec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) );","\t\tvisibility += texture2D( occlusionMap, vec2( 0.5, 0.1 ) );","\t\tvisibility += texture2D( occlusionMap, vec2( 0.9, 0.1 ) );","\t\tvisibility += texture2D( occlusionMap, vec2( 0.9, 0.5 ) );","\t\tvisibility += texture2D( occlusionMap, vec2( 0.9, 0.9 ) );","\t\tvisibility += texture2D( occlusionMap, vec2( 0.5, 0.9 ) );","\t\tvisibility += texture2D( occlusionMap, vec2( 0.1, 0.9 ) );","\t\tvisibility += texture2D( occlusionMap, vec2( 0.1, 0.5 ) );","\t\tvisibility += texture2D( occlusionMap, vec2( 0.5, 0.5 ) );","\t\tvVisibility =        visibility.r / 9.0;","\t\tvVisibility *= 1.0 - visibility.g / 9.0;","\t\tvVisibility *=       visibility.b / 9.0;","\t\tvVisibility *= 1.0 - visibility.a / 9.0;","\t\tpos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","\t\tpos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","\t}","\tgl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["uniform lowp int renderType;","uniform sampler2D map;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","varying float vVisibility;","void main() {","\tif ( renderType == 0 ) {","\t\tgl_FragColor = vec4( 1.0, 0.0, 1.0, 0.0 );","\t} else if ( renderType == 1 ) {","\t\tgl_FragColor = texture2D( map, vUV );","\t} else {","\t\tvec4 texture = texture2D( map, vUV );","\t\ttexture.a *= opacity * vVisibility;","\t\tgl_FragColor = texture;","\t\tgl_FragColor.rgb *= color;","\t}","}"].join("\n")},T=function createProgram(e){var t=x.createProgram(),r=x.createShader(x.FRAGMENT_SHADER),i=x.createShader(x.VERTEX_SHADER),n="precision "+a.precision+" float;\n";return x.shaderSource(r,n+e.fragmentShader),x.shaderSource(i,n+e.vertexShader),x.compileShader(r),x.compileShader(i),x.attachShader(t,r),x.attachShader(t,i),x.linkProgram(t),t}(r),E={vertex:x.getAttribLocation(T,"position"),uv:x.getAttribLocation(T,"uv")},S={renderType:x.getUniformLocation(T,"renderType"),map:x.getUniformLocation(T,"map"),occlusionMap:x.getUniformLocation(T,"occlusionMap"),opacity:x.getUniformLocation(T,"opacity"),color:x.getUniformLocation(T,"color"),scale:x.getUniformLocation(T,"scale"),rotation:x.getUniformLocation(T,"rotation"),screenPosition:x.getUniformLocation(T,"screenPosition")}}this.render=function(e,t,r,i){if(0!==e.length){var n=new Vector3,a=i.w/i.z,o=.5*i.z,s=.5*i.w,c=16/i.w,l=new Vector2(c*a,c),h=new Vector3(1,1,0),u=new Vector2(1,1),d=new Box2;d.min.set(i.x,i.y),d.max.set(i.x+(i.z-16),i.y+(i.w-16)),void 0===T&&init(),b.useProgram(T),b.initAttributes(),b.enableAttribute(E.vertex),b.enableAttribute(E.uv),b.disableUnusedAttributes(),x.uniform1i(S.occlusionMap,0),x.uniform1i(S.map,1),x.bindBuffer(x.ARRAY_BUFFER,_),x.vertexAttribPointer(E.vertex,2,x.FLOAT,!1,16,0),x.vertexAttribPointer(E.uv,2,x.FLOAT,!1,16,8),x.bindBuffer(x.ELEMENT_ARRAY_BUFFER,w),b.disable(x.CULL_FACE),b.buffers.depth.setMask(!1);for(var p=0,f=e.length;p<f;p++){c=16/i.w,l.set(c*a,c);var m=e[p];if(n.set(m.matrixWorld.elements[12],m.matrixWorld.elements[13],m.matrixWorld.elements[14]),n.applyMatrix4(r.matrixWorldInverse),n.applyMatrix4(r.projectionMatrix),h.copy(n),u.x=i.x+h.x*o+o-8,u.y=i.y+h.y*s+s-8,!0===d.containsPoint(u)){b.activeTexture(x.TEXTURE0),b.bindTexture(x.TEXTURE_2D,null),b.activeTexture(x.TEXTURE1),b.bindTexture(x.TEXTURE_2D,A),x.copyTexImage2D(x.TEXTURE_2D,0,x.RGB,u.x,u.y,16,16,0),x.uniform1i(S.renderType,0),x.uniform2f(S.scale,l.x,l.y),x.uniform3f(S.screenPosition,h.x,h.y,h.z),b.disable(x.BLEND),b.enable(x.DEPTH_TEST),x.drawElements(x.TRIANGLES,6,x.UNSIGNED_SHORT,0),b.activeTexture(x.TEXTURE0),b.bindTexture(x.TEXTURE_2D,L),x.copyTexImage2D(x.TEXTURE_2D,0,x.RGBA,u.x,u.y,16,16,0),x.uniform1i(S.renderType,1),b.disable(x.DEPTH_TEST),b.activeTexture(x.TEXTURE1),b.bindTexture(x.TEXTURE_2D,A),x.drawElements(x.TRIANGLES,6,x.UNSIGNED_SHORT,0),m.positionScreen.copy(h),m.customUpdateCallback?m.customUpdateCallback(m):m.updateLensFlares(),x.uniform1i(S.renderType,2),b.enable(x.BLEND);for(var g=0,v=m.lensFlares.length;g<v;g++){var y=m.lensFlares[g];.001<y.opacity&&.001<y.scale&&(h.x=y.x,h.y=y.y,h.z=y.z,c=y.size*y.scale/i.w,l.x=c*a,l.y=c,x.uniform3f(S.screenPosition,h.x,h.y,h.z),x.uniform2f(S.scale,l.x,l.y),x.uniform1f(S.rotation,y.rotation),x.uniform1f(S.opacity,y.opacity),x.uniform3f(S.color,y.color.r,y.color.g,y.color.b),b.setBlending(y.blending,y.blendEquation,y.blendSrc,y.blendDst),M.setTexture2D(y.texture,1),x.drawElements(x.TRIANGLES,6,x.UNSIGNED_SHORT,0))}}}b.enable(x.CULL_FACE),b.enable(x.DEPTH_TEST),b.buffers.depth.setMask(!0),b.reset()}}}function CanvasTexture(e,t,r,i,n,a,o,s,c){Texture.call(this,e,t,r,i,n,a,o,s,c),this.needsUpdate=!0}function WebGLSpriteRenderer(d,p,f,m,n){var g,v,y,x,b,M,_=new Vector3,w=new Quaternion,T=new Vector3;function init(){var e=new Float32Array([-.5,-.5,0,0,.5,-.5,1,0,.5,.5,1,1,-.5,.5,0,1]),t=new Uint16Array([0,1,2,0,2,3]);g=p.createBuffer(),v=p.createBuffer(),p.bindBuffer(p.ARRAY_BUFFER,g),p.bufferData(p.ARRAY_BUFFER,e,p.STATIC_DRAW),p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,v),p.bufferData(p.ELEMENT_ARRAY_BUFFER,t,p.STATIC_DRAW),y=function createProgram(){var e=p.createProgram(),t=p.createShader(p.VERTEX_SHADER),r=p.createShader(p.FRAGMENT_SHADER);return p.shaderSource(t,["precision "+n.precision+" float;","#define SHADER_NAME SpriteMaterial","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform float rotation;","uniform vec2 scale;","uniform vec2 uvOffset;","uniform vec2 uvScale;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","varying float fogDepth;","void main() {","\tvUV = uvOffset + uv * uvScale;","\tvec2 alignedPosition = position * scale;","\tvec2 rotatedPosition;","\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;","\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;","\tvec4 mvPosition;","\tmvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );","\tmvPosition.xy += rotatedPosition;","\tgl_Position = projectionMatrix * mvPosition;","\tfogDepth = - mvPosition.z;","}"].join("\n")),p.shaderSource(r,["precision "+n.precision+" float;","#define SHADER_NAME SpriteMaterial","uniform vec3 color;","uniform sampler2D map;","uniform float opacity;","uniform int fogType;","uniform vec3 fogColor;","uniform float fogDensity;","uniform float fogNear;","uniform float fogFar;","uniform float alphaTest;","varying vec2 vUV;","varying float fogDepth;","void main() {","\tvec4 texture = texture2D( map, vUV );","\tgl_FragColor = vec4( color * texture.xyz, texture.a * opacity );","\tif ( gl_FragColor.a < alphaTest ) discard;","\tif ( fogType > 0 ) {","\t\tfloat fogFactor = 0.0;","\t\tif ( fogType == 1 ) {","\t\t\tfogFactor = smoothstep( fogNear, fogFar, fogDepth );","\t\t} else {","\t\t\tconst float LOG2 = 1.442695;","\t\t\tfogFactor = exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 );","\t\t\tfogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );","\t\t}","\t\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );","\t}","}"].join("\n")),p.compileShader(t),p.compileShader(r),p.attachShader(e,t),p.attachShader(e,r),p.linkProgram(e),e}(),x={position:p.getAttribLocation(y,"position"),uv:p.getAttribLocation(y,"uv")},b={uvOffset:p.getUniformLocation(y,"uvOffset"),uvScale:p.getUniformLocation(y,"uvScale"),rotation:p.getUniformLocation(y,"rotation"),scale:p.getUniformLocation(y,"scale"),color:p.getUniformLocation(y,"color"),map:p.getUniformLocation(y,"map"),opacity:p.getUniformLocation(y,"opacity"),modelViewMatrix:p.getUniformLocation(y,"modelViewMatrix"),projectionMatrix:p.getUniformLocation(y,"projectionMatrix"),fogType:p.getUniformLocation(y,"fogType"),fogDensity:p.getUniformLocation(y,"fogDensity"),fogNear:p.getUniformLocation(y,"fogNear"),fogFar:p.getUniformLocation(y,"fogFar"),fogColor:p.getUniformLocation(y,"fogColor"),fogDepth:p.getUniformLocation(y,"fogDepth"),alphaTest:p.getUniformLocation(y,"alphaTest")};var r=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");r.width=8,r.height=8;var i=r.getContext("2d");i.fillStyle="white",i.fillRect(0,0,8,8),M=new CanvasTexture(r)}function painterSortStable(e,t){return e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:t.id-e.id}this.render=function(e,t,r){if(0!==e.length){void 0===y&&init(),f.useProgram(y),f.initAttributes(),f.enableAttribute(x.position),f.enableAttribute(x.uv),f.disableUnusedAttributes(),f.disable(p.CULL_FACE),f.enable(p.BLEND),p.bindBuffer(p.ARRAY_BUFFER,g),p.vertexAttribPointer(x.position,2,p.FLOAT,!1,16,0),p.vertexAttribPointer(x.uv,2,p.FLOAT,!1,16,8),p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,v),p.uniformMatrix4fv(b.projectionMatrix,!1,r.projectionMatrix.elements),f.activeTexture(p.TEXTURE0),p.uniform1i(b.map,0);var i=0,n=0,a=t.fog;a?(p.uniform3f(b.fogColor,a.color.r,a.color.g,a.color.b),a.isFog?(p.uniform1f(b.fogNear,a.near),p.uniform1f(b.fogFar,a.far),p.uniform1i(b.fogType,1),n=i=1):a.isFogExp2&&(p.uniform1f(b.fogDensity,a.density),p.uniform1i(b.fogType,2),n=i=2)):(p.uniform1i(b.fogType,0),n=i=0);for(var o=0,s=e.length;o<s;o++){(l=e[o]).modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,l.matrixWorld),l.z=-l.modelViewMatrix.elements[14]}e.sort(painterSortStable);var c=[];for(o=0,s=e.length;o<s;o++){var l,h=(l=e[o]).material;if(!1!==h.visible){l.onBeforeRender(d,t,r,void 0,h,void 0),p.uniform1f(b.alphaTest,h.alphaTest),p.uniformMatrix4fv(b.modelViewMatrix,!1,l.modelViewMatrix.elements),l.matrixWorld.decompose(_,w,T),c[0]=T.x,c[1]=T.y;var u=0;t.fog&&h.fog&&(u=n),i!==u&&(p.uniform1i(b.fogType,u),i=u),null!==h.map?(p.uniform2f(b.uvOffset,h.map.offset.x,h.map.offset.y),p.uniform2f(b.uvScale,h.map.repeat.x,h.map.repeat.y)):(p.uniform2f(b.uvOffset,0,0),p.uniform2f(b.uvScale,1,1)),p.uniform1f(b.opacity,h.opacity),p.uniform3f(b.color,h.color.r,h.color.g,h.color.b),p.uniform1f(b.rotation,h.rotation),p.uniform2fv(b.scale,c),f.setBlending(h.blending,h.blendEquation,h.blendSrc,h.blendDst,h.blendEquationAlpha,h.blendSrcAlpha,h.blendDstAlpha,h.premultipliedAlpha),f.buffers.depth.setTest(h.depthTest),f.buffers.depth.setMask(h.depthWrite),f.buffers.color.setMask(h.colorWrite),m.setTexture2D(h.map||M,0),p.drawElements(p.TRIANGLES,6,p.UNSIGNED_SHORT,0),l.onAfterRender(d,t,r,void 0,h,void 0)}}f.enable(p.CULL_FACE),f.reset()}}}Ht.physical={uniforms:Nt.merge([Ht.standard.uniforms,{clearCoat:{value:0},clearCoatRoughness:{value:0}}]),vertexShader:zt.meshphysical_vert,fragmentShader:zt.meshphysical_frag},Object.assign(Box2.prototype,{set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromPoints:function(e){this.makeEmpty();for(var t=0,r=e.length;t<r;t++)this.expandByPoint(e[t]);return this},setFromCenterAndSize:(Vt=new Vector2,function setFromCenterAndSize(e,t){var r=Vt.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(r),this.max.copy(e).add(r),this}),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this},isEmpty:function(){return this.max.x<this.min.x||this.max.y<this.min.y},getCenter:function(e){var t=e||new Vector2;return this.isEmpty()?t.set(0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)},getSize:function(e){var t=e||new Vector2;return this.isEmpty()?t.set(0,0):t.subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},containsPoint:function(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y)},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y},getParameter:function(e,t){return(t||new Vector2).set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y))},intersectsBox:function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y)},clampPoint:function(e,t){return(t||new Vector2).copy(e).clamp(this.min,this.max)},distanceToPoint:(Ot=new Vector2,function distanceToPoint(e){return Ot.copy(e).clamp(this.min,this.max).sub(e).length()}),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}),(CanvasTexture.prototype=Object.create(Texture.prototype)).constructor=CanvasTexture;var kt,jt,Wt,Xt,qt,Yt,Zt,Qt,Kt,Jt,$t,er,tr,rr,ir,nr,ar,or=0;function Material(){Object.defineProperty(this,"id",{value:or++}),this.uuid=Et.generateUUID(),this.name="",this.type="Material",this.fog=!0,this.lights=!0,this.blending=N,this.side=V,this.flatShading=!1,this.vertexColors=pe,this.opacity=1,this.transparent=!1,this.blendSrc=Z,this.blendDst=Q,this.blendEquation=S,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=ae,this.depthTest=!0,this.depthWrite=!0,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaTest=0,this.premultipliedAlpha=!1,this.overdraw=0,this.visible=!0,this.userData={},this.needsUpdate=!0}function MeshDepthMaterial(e){Material.call(this),this.type="MeshDepthMaterial",this.depthPacking=wt,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.setValues(e)}function MeshDistanceMaterial(e){Material.call(this),this.type="MeshDistanceMaterial",this.referencePosition=new Vector3,this.nearDistance=1,this.farDistance=1e3,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.fog=!1,this.lights=!1,this.setValues(e)}function Box3(e,t){this.min=void 0!==e?e:new Vector3(1/0,1/0,1/0),this.max=void 0!==t?t:new Vector3(-1/0,-1/0,-1/0)}function Sphere(e,t){this.center=void 0!==e?e:new Vector3,this.radius=void 0!==t?t:0}function Plane(e,t){this.normal=void 0!==e?e:new Vector3(1,0,0),this.constant=void 0!==t?t:0}function Frustum(e,t,r,i,n,a){this.planes=[void 0!==e?e:new Plane,void 0!==t?t:new Plane,void 0!==r?r:new Plane,void 0!==i?i:new Plane,void 0!==n?n:new Plane,void 0!==a?a:new Plane]}function WebGLShadowMap(x,m,e){for(var b=new Frustum,M=new Matrix4,_=new Vector2,w=new Vector2(e,e),T=new Vector3,E=new Vector3,y=1,S=2,t=1+(y|S),A=new Array(t),L=new Array(t),C={},P=[new Vector3(1,0,0),new Vector3(-1,0,0),new Vector3(0,0,1),new Vector3(0,0,-1),new Vector3(0,1,0),new Vector3(0,-1,0)],R=[new Vector3(0,1,0),new Vector3(0,1,0),new Vector3(0,1,0),new Vector3(0,1,0),new Vector3(0,0,1),new Vector3(0,0,-1)],B=[new Vector4,new Vector4,new Vector4,new Vector4,new Vector4,new Vector4],r=0;r!==t;++r){var i=0!=(r&y),n=0!=(r&S),a=new MeshDepthMaterial({depthPacking:Tt,morphTargets:i,skinning:n});A[r]=a;var o=new MeshDistanceMaterial({morphTargets:i,skinning:n});L[r]=o}var I=this;function getDepthMaterial(e,t,r,i,n,a){var o=e.geometry,s=null,c=A,l=e.customDepthMaterial;if(r&&(c=L,l=e.customDistanceMaterial),l)s=l;else{var h=!1;t.morphTargets&&(o&&o.isBufferGeometry?h=o.morphAttributes&&o.morphAttributes.position&&0<o.morphAttributes.position.length:o&&o.isGeometry&&(h=o.morphTargets&&0<o.morphTargets.length)),e.isSkinnedMesh&&!1===t.skinning&&console.warn("THREE.WebGLShadowMap: THREE.SkinnedMesh with material.skinning set to false:",e);var u=e.isSkinnedMesh&&t.skinning,d=0;h&&(d|=y),u&&(d|=S),s=c[d]}if(x.localClippingEnabled&&!0===t.clipShadows&&0!==t.clippingPlanes.length){var p=s.uuid,f=t.uuid,m=C[p];void 0===m&&(m={},C[p]=m);var g=m[f];void 0===g&&(g=s.clone(),m[f]=g),s=g}s.visible=t.visible,s.wireframe=t.wireframe;var v=t.side;return I.renderSingleSided&&v==q&&(v=V),I.renderReverseSided&&(v===V?v=X:v===X&&(v=V)),s.side=v,s.clipShadows=t.clipShadows,s.clippingPlanes=t.clippingPlanes,s.clipIntersection=t.clipIntersection,s.wireframeLinewidth=t.wireframeLinewidth,s.linewidth=t.linewidth,r&&s.isMeshDistanceMaterial&&(s.referencePosition.copy(i),s.nearDistance=n,s.farDistance=a),s}function renderObject(e,t,r,i){if(!1!==e.visible){if(e.layers.test(t.layers)&&(e.isMesh||e.isLine||e.isPoints)&&e.castShadow&&(!e.frustumCulled||b.intersectsObject(e))){e.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,e.matrixWorld);var n=m.update(e),a=e.material;if(Array.isArray(a))for(var o=n.groups,s=0,c=o.length;s<c;s++){var l=o[s],h=a[l.materialIndex];if(h&&h.visible){var u=getDepthMaterial(e,h,i,E,r.near,r.far);x.renderBufferDirect(r,null,n,u,e,l)}}else if(a.visible){u=getDepthMaterial(e,a,i,E,r.near,r.far);x.renderBufferDirect(r,null,n,u,e,null)}}for(var d=e.children,p=0,f=d.length;p<f;p++)renderObject(d[p],t,r,i)}}this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=O,this.renderReverseSided=!0,this.renderSingleSided=!0,this.render=function(e,t,r){if(!1!==I.enabled&&(!1!==I.autoUpdate||!1!==I.needsUpdate)&&0!==e.length){var i,n=x.context,a=x.state;a.disable(n.BLEND),a.buffers.color.setClear(1,1,1,1),a.buffers.depth.setTest(!0),a.setScissorTest(!1);for(var o=0,s=e.length;o<s;o++){var c=e[o],l=c.shadow,h=c&&c.isPointLight;if(void 0!==l){var u=l.camera;if(_.copy(l.mapSize),_.min(w),h){var d=_.x,p=_.y;B[0].set(2*d,p,d,p),B[1].set(0,p,d,p),B[2].set(3*d,p,d,p),B[3].set(d,p,d,p),B[4].set(3*d,0,d,p),B[5].set(d,0,d,p),_.x*=4,_.y*=2}if(null===l.map){var f={minFilter:Ce,magFilter:Ce,format:Ze};l.map=new WebGLRenderTarget(_.x,_.y,f),l.map.texture.name=c.name+".shadowMap",u.updateProjectionMatrix()}l.isSpotLightShadow&&l.update(c);var m=l.map,g=l.matrix;E.setFromMatrixPosition(c.matrixWorld),u.position.copy(E),h?(i=6,g.makeTranslation(-E.x,-E.y,-E.z)):(i=1,T.setFromMatrixPosition(c.target.matrixWorld),u.lookAt(T),u.updateMatrixWorld(),g.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),g.multiply(u.projectionMatrix),g.multiply(u.matrixWorldInverse)),x.setRenderTarget(m),x.clear();for(var v=0;v<i;v++){if(h){T.copy(u.position),T.add(P[v]),u.up.copy(R[v]),u.lookAt(T),u.updateMatrixWorld();var y=B[v];a.viewport(y)}M.multiplyMatrices(u.projectionMatrix,u.matrixWorldInverse),b.setFromMatrix(M),renderObject(t,r,u,h)}}else console.warn("THREE.WebGLShadowMap:",c,"has no shadow.")}I.needsUpdate=!1}}}function WebGLAttributes(o){var i={};return{get:function get(e){return e.isInterleavedBufferAttribute&&(e=e.data),i[e.uuid]},remove:function remove(e){e.isInterleavedBufferAttribute&&(e=e.data);var t=i[e.uuid];t&&(o.deleteBuffer(t.buffer),delete i[e.uuid])},update:function update(e,t){e.isInterleavedBufferAttribute&&(e=e.data);var r=i[e.uuid];void 0===r?i[e.uuid]=function createBuffer(e,t){var r=e.array,i=e.dynamic?o.DYNAMIC_DRAW:o.STATIC_DRAW,n=o.createBuffer();o.bindBuffer(t,n),o.bufferData(t,r,i),e.onUploadCallback();var a=o.FLOAT;return r instanceof Float32Array?a=o.FLOAT:r instanceof Float64Array?console.warn("THREE.WebGLAttributes: Unsupported data buffer format: Float64Array."):r instanceof Uint16Array?a=o.UNSIGNED_SHORT:r instanceof Int16Array?a=o.SHORT:r instanceof Uint32Array?a=o.UNSIGNED_INT:r instanceof Int32Array?a=o.INT:r instanceof Int8Array?a=o.BYTE:r instanceof Uint8Array&&(a=o.UNSIGNED_BYTE),{buffer:n,type:a,bytesPerElement:r.BYTES_PER_ELEMENT,version:e.version}}(e,t):r.version<e.version&&(function updateBuffer(e,t,r){var i=t.array,n=t.updateRange;o.bindBuffer(r,e),!1===t.dynamic?o.bufferData(r,i,o.STATIC_DRAW):-1===n.count?o.bufferSubData(r,0,i):0===n.count?console.error("THREE.WebGLObjects.updateBuffer: dynamic THREE.BufferAttribute marked as needsUpdate but updateRange.count is 0, ensure you are using set methods or updating manually."):(o.bufferSubData(r,n.offset*i.BYTES_PER_ELEMENT,i.subarray(n.offset,n.offset+n.count)),n.count=-1)}(r.buffer,e,t),r.version=e.version)}}}function Euler(e,t,r,i){this._x=e||0,this._y=t||0,this._z=r||0,this._order=i||Euler.DefaultOrder}function Layers(){this.mask=1}Object.assign(Material.prototype,EventDispatcher.prototype,{isMaterial:!0,onBeforeCompile:function(){},setValues:function(e){if(void 0!==e)for(var t in e){var r=e[t];if(void 0!==r)if("shading"!==t){var i=this[t];void 0!==i?i&&i.isColor?i.set(r):i&&i.isVector3&&r&&r.isVector3?i.copy(r):this[t]="overdraw"===t?Number(r):r:console.warn("THREE."+this.type+": '"+t+"' is not a property of this material.")}else console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=1===r;else console.warn("THREE.Material: '"+t+"' parameter is undefined.")}},toJSON:function(e){var t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{}});var r={metadata:{version:4.5,type:"Material",generator:"Material.toJSON"}};function extractFromCache(e){var t=[];for(var r in e){var i=e[r];delete i.metadata,t.push(i)}return t}if(r.uuid=this.uuid,r.type=this.type,""!==this.name&&(r.name=this.name),this.color&&this.color.isColor&&(r.color=this.color.getHex()),void 0!==this.roughness&&(r.roughness=this.roughness),void 0!==this.metalness&&(r.metalness=this.metalness),this.emissive&&this.emissive.isColor&&(r.emissive=this.emissive.getHex()),1!==this.emissiveIntensity&&(r.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(r.specular=this.specular.getHex()),void 0!==this.shininess&&(r.shininess=this.shininess),void 0!==this.clearCoat&&(r.clearCoat=this.clearCoat),void 0!==this.clearCoatRoughness&&(r.clearCoatRoughness=this.clearCoatRoughness),this.map&&this.map.isTexture&&(r.map=this.map.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(r.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(r.lightMap=this.lightMap.toJSON(e).uuid),this.bumpMap&&this.bumpMap.isTexture&&(r.bumpMap=this.bumpMap.toJSON(e).uuid,r.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(r.normalMap=this.normalMap.toJSON(e).uuid,r.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(r.displacementMap=this.displacementMap.toJSON(e).uuid,r.displacementScale=this.displacementScale,r.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(r.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(r.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(r.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(r.specularMap=this.specularMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(r.envMap=this.envMap.toJSON(e).uuid,r.reflectivity=this.reflectivity),this.gradientMap&&this.gradientMap.isTexture&&(r.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.size&&(r.size=this.size),void 0!==this.sizeAttenuation&&(r.sizeAttenuation=this.sizeAttenuation),this.blending!==N&&(r.blending=this.blending),!0===this.flatShading&&(r.flatShading=this.flatShading),this.side!==V&&(r.side=this.side),this.vertexColors!==pe&&(r.vertexColors=this.vertexColors),this.opacity<1&&(r.opacity=this.opacity),!0===this.transparent&&(r.transparent=this.transparent),r.depthFunc=this.depthFunc,r.depthTest=this.depthTest,r.depthWrite=this.depthWrite,0!==this.rotation&&(r.rotation=this.rotation),1!==this.linewidth&&(r.linewidth=this.linewidth),void 0!==this.dashSize&&(r.dashSize=this.dashSize),void 0!==this.gapSize&&(r.gapSize=this.gapSize),void 0!==this.scale&&(r.scale=this.scale),!0===this.dithering&&(r.dithering=!0),0<this.alphaTest&&(r.alphaTest=this.alphaTest),!0===this.premultipliedAlpha&&(r.premultipliedAlpha=this.premultipliedAlpha),!0===this.wireframe&&(r.wireframe=this.wireframe),1<this.wireframeLinewidth&&(r.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(r.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(r.wireframeLinejoin=this.wireframeLinejoin),!0===this.morphTargets&&(r.morphTargets=!0),!0===this.skinning&&(r.skinning=!0),!1===this.visible&&(r.visible=!1),"{}"!==JSON.stringify(this.userData)&&(r.userData=this.userData),t){var i=extractFromCache(e.textures),n=extractFromCache(e.images);0<i.length&&(r.textures=i),0<n.length&&(r.images=n)}return r},clone:function(){return(new this.constructor).copy(this)},copy:function(e){this.name=e.name,this.fog=e.fog,this.lights=e.lights,this.blending=e.blending,this.side=e.side,this.flatShading=e.flatShading,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.premultipliedAlpha=e.premultipliedAlpha,this.overdraw=e.overdraw,this.visible=e.visible,this.userData=JSON.parse(JSON.stringify(e.userData)),this.clipShadows=e.clipShadows,this.clipIntersection=e.clipIntersection;var t=e.clippingPlanes,r=null;if(null!==t){var i=t.length;r=new Array(i);for(var n=0;n!==i;++n)r[n]=t[n].clone()}return this.clippingPlanes=r,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),((MeshDepthMaterial.prototype=Object.create(Material.prototype)).constructor=MeshDepthMaterial).prototype.isMeshDepthMaterial=!0,MeshDepthMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.depthPacking=e.depthPacking,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this},((MeshDistanceMaterial.prototype=Object.create(Material.prototype)).constructor=MeshDistanceMaterial).prototype.isMeshDistanceMaterial=!0,MeshDistanceMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.referencePosition.copy(e.referencePosition),this.nearDistance=e.nearDistance,this.farDistance=e.farDistance,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this},Object.assign(Box3.prototype,{isBox3:!0,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromArray:function(e){for(var t=1/0,r=1/0,i=1/0,n=-1/0,a=-1/0,o=-1/0,s=0,c=e.length;s<c;s+=3){var l=e[s],h=e[s+1],u=e[s+2];l<t&&(t=l),h<r&&(r=h),u<i&&(i=u),n<l&&(n=l),a<h&&(a=h),o<u&&(o=u)}return this.min.set(t,r,i),this.max.set(n,a,o),this},setFromBufferAttribute:function(e){for(var t=1/0,r=1/0,i=1/0,n=-1/0,a=-1/0,o=-1/0,s=0,c=e.count;s<c;s++){var l=e.getX(s),h=e.getY(s),u=e.getZ(s);l<t&&(t=l),h<r&&(r=h),u<i&&(i=u),n<l&&(n=l),a<h&&(a=h),o<u&&(o=u)}return this.min.set(t,r,i),this.max.set(n,a,o),this},setFromPoints:function(e){this.makeEmpty();for(var t=0,r=e.length;t<r;t++)this.expandByPoint(e[t]);return this},setFromCenterAndSize:(qt=new Vector3,function setFromCenterAndSize(e,t){var r=qt.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(r),this.max.copy(e).add(r),this}),setFromObject:function(e){return this.makeEmpty(),this.expandByObject(e)},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this},isEmpty:function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},getCenter:function(e){var t=e||new Vector3;return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)},getSize:function(e){var t=e||new Vector3;return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},expandByObject:function(){var n,a,o,s=new Vector3;function traverse(e){var t=e.geometry;if(void 0!==t)if(t.isGeometry){var r=t.vertices;for(a=0,o=r.length;a<o;a++)s.copy(r[a]),s.applyMatrix4(e.matrixWorld),n.expandByPoint(s)}else if(t.isBufferGeometry){var i=t.attributes.position;if(void 0!==i)for(a=0,o=i.count;a<o;a++)s.fromBufferAttribute(i,a).applyMatrix4(e.matrixWorld),n.expandByPoint(s)}}return function expandByObject(e){return n=this,e.updateMatrixWorld(!0),e.traverse(traverse),this}}(),containsPoint:function(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z},getParameter:function(e,t){return(t||new Vector3).set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))},intersectsBox:function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)},intersectsSphere:(Xt=new Vector3,function intersectsSphere(e){return this.clampPoint(e.center,Xt),Xt.distanceToSquared(e.center)<=e.radius*e.radius}),intersectsPlane:function(e){var t,r;return r=0<e.normal.x?(t=e.normal.x*this.min.x,e.normal.x*this.max.x):(t=e.normal.x*this.max.x,e.normal.x*this.min.x),0<e.normal.y?(t+=e.normal.y*this.min.y,r+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,r+=e.normal.y*this.min.y),0<e.normal.z?(t+=e.normal.z*this.min.z,r+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,r+=e.normal.z*this.min.z),t<=e.constant&&r>=e.constant},clampPoint:function(e,t){return(t||new Vector3).copy(e).clamp(this.min,this.max)},distanceToPoint:(Wt=new Vector3,function distanceToPoint(e){return Wt.copy(e).clamp(this.min,this.max).sub(e).length()}),getBoundingSphere:(jt=new Vector3,function getBoundingSphere(e){var t=e||new Sphere;return this.getCenter(t.center),t.radius=.5*this.getSize(jt).length(),t}),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},applyMatrix4:(kt=[new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3],function applyMatrix4(e){return this.isEmpty()||(kt[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),kt[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),kt[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),kt[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),kt[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),kt[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),kt[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),kt[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(kt)),this}),translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}),Object.assign(Sphere.prototype,{set:function(e,t){return this.center.copy(e),this.radius=t,this},setFromPoints:(Yt=new Box3,function setFromPoints(e,t){var r=this.center;void 0!==t?r.copy(t):Yt.setFromPoints(e).getCenter(r);for(var i=0,n=0,a=e.length;n<a;n++)i=Math.max(i,r.distanceToSquared(e[n]));return this.radius=Math.sqrt(i),this}),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.center.copy(e.center),this.radius=e.radius,this},empty:function(){return this.radius<=0},containsPoint:function(e){return e.distanceToSquared(this.center)<=this.radius*this.radius},distanceToPoint:function(e){return e.distanceTo(this.center)-this.radius},intersectsSphere:function(e){var t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t},intersectsBox:function(e){return e.intersectsSphere(this)},intersectsPlane:function(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius},clampPoint:function(e,t){var r=this.center.distanceToSquared(e),i=t||new Vector3;return i.copy(e),r>this.radius*this.radius&&(i.sub(this.center).normalize(),i.multiplyScalar(this.radius).add(this.center)),i},getBoundingBox:function(e){var t=e||new Box3;return t.set(this.center,this.center),t.expandByScalar(this.radius),t},applyMatrix4:function(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this},translate:function(e){return this.center.add(e),this},equals:function(e){return e.center.equals(this.center)&&e.radius===this.radius}}),Object.assign(Plane.prototype,{set:function(e,t){return this.normal.copy(e),this.constant=t,this},setComponents:function(e,t,r,i){return this.normal.set(e,t,r),this.constant=i,this},setFromNormalAndCoplanarPoint:function(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this},setFromCoplanarPoints:(Jt=new Vector3,$t=new Vector3,function setFromCoplanarPoints(e,t,r){var i=Jt.subVectors(r,t).cross($t.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(i,e),this}),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.normal.copy(e.normal),this.constant=e.constant,this},normalize:function(){var e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this},negate:function(){return this.constant*=-1,this.normal.negate(),this},distanceToPoint:function(e){return this.normal.dot(e)+this.constant},distanceToSphere:function(e){return this.distanceToPoint(e.center)-e.radius},projectPoint:function(e,t){return(t||new Vector3).copy(this.normal).multiplyScalar(-this.distanceToPoint(e)).add(e)},intersectLine:(Kt=new Vector3,function intersectLine(e,t){var r=t||new Vector3,i=e.delta(Kt),n=this.normal.dot(i);if(0===n)return 0===this.distanceToPoint(e.start)?r.copy(e.start):void 0;var a=-(e.start.dot(this.normal)+this.constant)/n;return a<0||1<a?void 0:r.copy(i).multiplyScalar(a).add(e.start)}),intersectsLine:function(e){var t=this.distanceToPoint(e.start),r=this.distanceToPoint(e.end);return t<0&&0<r||r<0&&0<t},intersectsBox:function(e){return e.intersectsPlane(this)},intersectsSphere:function(e){return e.intersectsPlane(this)},coplanarPoint:function(e){return(e||new Vector3).copy(this.normal).multiplyScalar(-this.constant)},applyMatrix4:(Zt=new Vector3,Qt=new Matrix3,function applyMatrix4(e,t){var r=t||Qt.getNormalMatrix(e),i=this.coplanarPoint(Zt).applyMatrix4(e),n=this.normal.applyMatrix3(r).normalize();return this.constant=-i.dot(n),this}),translate:function(e){return this.constant-=e.dot(this.normal),this},equals:function(e){return e.normal.equals(this.normal)&&e.constant===this.constant}}),Object.assign(Frustum.prototype,{set:function(e,t,r,i,n,a){var o=this.planes;return o[0].copy(e),o[1].copy(t),o[2].copy(r),o[3].copy(i),o[4].copy(n),o[5].copy(a),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){for(var t=this.planes,r=0;r<6;r++)t[r].copy(e.planes[r]);return this},setFromMatrix:function(e){var t=this.planes,r=e.elements,i=r[0],n=r[1],a=r[2],o=r[3],s=r[4],c=r[5],l=r[6],h=r[7],u=r[8],d=r[9],p=r[10],f=r[11],m=r[12],g=r[13],v=r[14],y=r[15];return t[0].setComponents(o-i,h-s,f-u,y-m).normalize(),t[1].setComponents(o+i,h+s,f+u,y+m).normalize(),t[2].setComponents(o+n,h+c,f+d,y+g).normalize(),t[3].setComponents(o-n,h-c,f-d,y-g).normalize(),t[4].setComponents(o-a,h-l,f-p,y-v).normalize(),t[5].setComponents(o+a,h+l,f+p,y+v).normalize(),this},intersectsObject:(ir=new Sphere,function intersectsObject(e){var t=e.geometry;return null===t.boundingSphere&&t.computeBoundingSphere(),ir.copy(t.boundingSphere).applyMatrix4(e.matrixWorld),this.intersectsSphere(ir)}),intersectsSprite:(rr=new Sphere,function intersectsSprite(e){return rr.center.set(0,0,0),rr.radius=.7071067811865476,rr.applyMatrix4(e.matrixWorld),this.intersectsSphere(rr)}),intersectsSphere:function(e){for(var t=this.planes,r=e.center,i=-e.radius,n=0;n<6;n++){if(t[n].distanceToPoint(r)<i)return!1}return!0},intersectsBox:(er=new Vector3,tr=new Vector3,function intersectsBox(e){for(var t=this.planes,r=0;r<6;r++){var i=t[r];er.x=0<i.normal.x?e.min.x:e.max.x,tr.x=0<i.normal.x?e.max.x:e.min.x,er.y=0<i.normal.y?e.min.y:e.max.y,tr.y=0<i.normal.y?e.max.y:e.min.y,er.z=0<i.normal.z?e.min.z:e.max.z,tr.z=0<i.normal.z?e.max.z:e.min.z;var n=i.distanceToPoint(er),a=i.distanceToPoint(tr);if(n<0&&a<0)return!1}return!0}),containsPoint:function(e){for(var t=this.planes,r=0;r<6;r++)if(t[r].distanceToPoint(e)<0)return!1;return!0}}),Euler.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],Euler.DefaultOrder="XYZ",Object.defineProperties(Euler.prototype,{x:{get:function(){return this._x},set:function(e){this._x=e,this.onChangeCallback()}},y:{get:function(){return this._y},set:function(e){this._y=e,this.onChangeCallback()}},z:{get:function(){return this._z},set:function(e){this._z=e,this.onChangeCallback()}},order:{get:function(){return this._order},set:function(e){this._order=e,this.onChangeCallback()}}}),Object.assign(Euler.prototype,{isEuler:!0,set:function(e,t,r,i){return this._x=e,this._y=t,this._z=r,this._order=i||this._order,this.onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._order)},copy:function(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this.onChangeCallback(),this},setFromRotationMatrix:function(e,t,r){var i=Et.clamp,n=e.elements,a=n[0],o=n[4],s=n[8],c=n[1],l=n[5],h=n[9],u=n[2],d=n[6],p=n[10];return"XYZ"===(t=t||this._order)?(this._y=Math.asin(i(s,-1,1)),Math.abs(s)<.99999?(this._x=Math.atan2(-h,p),this._z=Math.atan2(-o,a)):(this._x=Math.atan2(d,l),this._z=0)):"YXZ"===t?(this._x=Math.asin(-i(h,-1,1)),Math.abs(h)<.99999?(this._y=Math.atan2(s,p),this._z=Math.atan2(c,l)):(this._y=Math.atan2(-u,a),this._z=0)):"ZXY"===t?(this._x=Math.asin(i(d,-1,1)),Math.abs(d)<.99999?(this._y=Math.atan2(-u,p),this._z=Math.atan2(-o,l)):(this._y=0,this._z=Math.atan2(c,a))):"ZYX"===t?(this._y=Math.asin(-i(u,-1,1)),Math.abs(u)<.99999?(this._x=Math.atan2(d,p),this._z=Math.atan2(c,a)):(this._x=0,this._z=Math.atan2(-o,l))):"YZX"===t?(this._z=Math.asin(i(c,-1,1)),Math.abs(c)<.99999?(this._x=Math.atan2(-h,l),this._y=Math.atan2(-u,a)):(this._x=0,this._y=Math.atan2(s,p))):"XZY"===t?(this._z=Math.asin(-i(o,-1,1)),Math.abs(o)<.99999?(this._x=Math.atan2(d,l),this._y=Math.atan2(s,a)):(this._x=Math.atan2(-h,p),this._y=0)):console.warn("THREE.Euler: .setFromRotationMatrix() given unsupported order: "+t),this._order=t,!1!==r&&this.onChangeCallback(),this},setFromQuaternion:(ar=new Matrix4,function setFromQuaternion(e,t,r){return ar.makeRotationFromQuaternion(e),this.setFromRotationMatrix(ar,t,r)}),setFromVector3:function(e,t){return this.set(e.x,e.y,e.z,t||this._order)},reorder:(nr=new Quaternion,function reorder(e){return nr.setFromEuler(this),this.setFromQuaternion(nr,e)}),equals:function(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order},fromArray:function(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this.onChangeCallback(),this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e},toVector3:function(e){return e?e.set(this._x,this._y,this._z):new Vector3(this._x,this._y,this._z)},onChange:function(e){return this.onChangeCallback=e,this},onChangeCallback:function(){}}),Object.assign(Layers.prototype,{set:function(e){this.mask=1<<e|0},enable:function(e){this.mask|=1<<e|0},toggle:function(e){this.mask^=1<<e|0},disable:function(e){this.mask&=~(1<<e|0)},test:function(e){return 0!=(this.mask&e.mask)}});var sr,cr,lr,hr,ur,dr,pr,fr,mr,gr,vr,yr,xr,br,Mr,_r,wr,Tr,Er,Sr=0;function Object3D(){Object.defineProperty(this,"id",{value:Sr++}),this.uuid=Et.generateUUID(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Object3D.DefaultUp.clone();var e=new Vector3,t=new Euler,r=new Quaternion,i=new Vector3(1,1,1);t.onChange(function onRotationChange(){r.setFromEuler(t,!1)}),r.onChange(function onQuaternionChange(){t.setFromQuaternion(r,void 0,!1)}),Object.defineProperties(this,{position:{enumerable:!0,value:e},rotation:{enumerable:!0,value:t},quaternion:{enumerable:!0,value:r},scale:{enumerable:!0,value:i},modelViewMatrix:{value:new Matrix4},normalMatrix:{value:new Matrix3}}),this.matrix=new Matrix4,this.matrixWorld=new Matrix4,this.matrixAutoUpdate=Object3D.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new Layers,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.userData={}}function Camera(){Object3D.call(this),this.type="Camera",this.matrixWorldInverse=new Matrix4,this.projectionMatrix=new Matrix4}function OrthographicCamera(e,t,r,i,n,a){Camera.call(this),this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=r,this.bottom=i,this.near=void 0!==n?n:.1,this.far=void 0!==a?a:2e3,this.updateProjectionMatrix()}function Face3(e,t,r,i,n,a){this.a=e,this.b=t,this.c=r,this.normal=i&&i.isVector3?i:new Vector3,this.vertexNormals=Array.isArray(i)?i:[],this.color=n&&n.isColor?n:new Color,this.vertexColors=Array.isArray(n)?n:[],this.materialIndex=void 0!==a?a:0}Object3D.DefaultUp=new Vector3(0,1,0),Object3D.DefaultMatrixAutoUpdate=!0,Object.assign(Object3D.prototype,EventDispatcher.prototype,{isObject3D:!0,onBeforeRender:function(){},onAfterRender:function(){},applyMatrix:function(e){this.matrix.multiplyMatrices(e,this.matrix),this.matrix.decompose(this.position,this.quaternion,this.scale)},applyQuaternion:function(e){return this.quaternion.premultiply(e),this},setRotationFromAxisAngle:function(e,t){this.quaternion.setFromAxisAngle(e,t)},setRotationFromEuler:function(e){this.quaternion.setFromEuler(e,!0)},setRotationFromMatrix:function(e){this.quaternion.setFromRotationMatrix(e)},setRotationFromQuaternion:function(e){this.quaternion.copy(e)},rotateOnAxis:(Tr=new Quaternion,function rotateOnAxis(e,t){return Tr.setFromAxisAngle(e,t),this.quaternion.multiply(Tr),this}),rotateOnWorldAxis:(wr=new Quaternion,function rotateOnWorldAxis(e,t){return wr.setFromAxisAngle(e,t),this.quaternion.premultiply(wr),this}),rotateX:(_r=new Vector3(1,0,0),function rotateX(e){return this.rotateOnAxis(_r,e)}),rotateY:(Mr=new Vector3(0,1,0),function rotateY(e){return this.rotateOnAxis(Mr,e)}),rotateZ:(br=new Vector3(0,0,1),function rotateZ(e){return this.rotateOnAxis(br,e)}),translateOnAxis:(xr=new Vector3,function translateOnAxis(e,t){return xr.copy(e).applyQuaternion(this.quaternion),this.position.add(xr.multiplyScalar(t)),this}),translateX:(yr=new Vector3(1,0,0),function translateX(e){return this.translateOnAxis(yr,e)}),translateY:(vr=new Vector3(0,1,0),function translateY(e){return this.translateOnAxis(vr,e)}),translateZ:(gr=new Vector3(0,0,1),function translateZ(e){return this.translateOnAxis(gr,e)}),localToWorld:function(e){return e.applyMatrix4(this.matrixWorld)},worldToLocal:(mr=new Matrix4,function worldToLocal(e){return e.applyMatrix4(mr.getInverse(this.matrixWorld))}),lookAt:(pr=new Matrix4,fr=new Vector3,function lookAt(e,t,r){e.isVector3?fr.copy(e):fr.set(e,t,r),this.isCamera?pr.lookAt(this.position,fr,this.up):pr.lookAt(fr,this.position,this.up),this.quaternion.setFromRotationMatrix(pr)}),add:function(e){if(1<arguments.length){for(var t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return e===this?console.error("THREE.Object3D.add: object can't be added as a child of itself.",e):e&&e.isObject3D?(null!==e.parent&&e.parent.remove(e),e.parent=this,e.dispatchEvent({type:"added"}),this.children.push(e)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this},remove:function(e){if(1<arguments.length){for(var t=0;t<arguments.length;t++)this.remove(arguments[t]);return this}var r=this.children.indexOf(e);return-1!==r&&(e.parent=null,e.dispatchEvent({type:"removed"}),this.children.splice(r,1)),this},getObjectById:function(e){return this.getObjectByProperty("id",e)},getObjectByName:function(e){return this.getObjectByProperty("name",e)},getObjectByProperty:function(e,t){if(this[e]===t)return this;for(var r=0,i=this.children.length;r<i;r++){var n=this.children[r].getObjectByProperty(e,t);if(void 0!==n)return n}},getWorldPosition:function(e){var t=e||new Vector3;return this.updateMatrixWorld(!0),t.setFromMatrixPosition(this.matrixWorld)},getWorldQuaternion:(ur=new Vector3,dr=new Vector3,function getWorldQuaternion(e){var t=e||new Quaternion;return this.updateMatrixWorld(!0),this.matrixWorld.decompose(ur,t,dr),t}),getWorldRotation:(hr=new Quaternion,function getWorldRotation(e){var t=e||new Euler;return this.getWorldQuaternion(hr),t.setFromQuaternion(hr,this.rotation.order,!1)}),getWorldScale:(cr=new Vector3,lr=new Quaternion,function getWorldScale(e){var t=e||new Vector3;return this.updateMatrixWorld(!0),this.matrixWorld.decompose(cr,lr,t),t}),getWorldDirection:(sr=new Quaternion,function getWorldDirection(e){var t=e||new Vector3;return this.getWorldQuaternion(sr),t.set(0,0,1).applyQuaternion(sr)}),raycast:function(){},traverse:function(e){e(this);for(var t=this.children,r=0,i=t.length;r<i;r++)t[r].traverse(e)},traverseVisible:function(e){if(!1!==this.visible){e(this);for(var t=this.children,r=0,i=t.length;r<i;r++)t[r].traverseVisible(e)}},traverseAncestors:function(e){var t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))},updateMatrix:function(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),e=!(this.matrixWorldNeedsUpdate=!1));for(var t=this.children,r=0,i=t.length;r<i;r++)t[r].updateMatrixWorld(e)},toJSON:function(r){var e=void 0===r||"string"==typeof r,t={};e&&(r={geometries:{},materials:{},textures:{},images:{}},t.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});var i={};function serialize(e,t){return void 0===e[t.uuid]&&(e[t.uuid]=t.toJSON(r)),t.uuid}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),!0===this.castShadow&&(i.castShadow=!0),!0===this.receiveShadow&&(i.receiveShadow=!0),!1===this.visible&&(i.visible=!1),"{}"!==JSON.stringify(this.userData)&&(i.userData=this.userData),i.matrix=this.matrix.toArray(),void 0!==this.geometry&&(i.geometry=serialize(r.geometries,this.geometry)),void 0!==this.material)if(Array.isArray(this.material)){for(var n=[],a=0,o=this.material.length;a<o;a++)n.push(serialize(r.materials,this.material[a]));i.material=n}else i.material=serialize(r.materials,this.material);if(0<this.children.length){i.children=[];for(a=0;a<this.children.length;a++)i.children.push(this.children[a].toJSON(r).object)}if(e){var s=extractFromCache(r.geometries),c=extractFromCache(r.materials),l=extractFromCache(r.textures),h=extractFromCache(r.images);0<s.length&&(t.geometries=s),0<c.length&&(t.materials=c),0<l.length&&(t.textures=l),0<h.length&&(t.images=h)}return t.object=i,t;function extractFromCache(e){var t=[];for(var r in e){var i=e[r];delete i.metadata,t.push(i)}return t}},clone:function(e){return(new this.constructor).copy(this,e)},copy:function(e,t){if(void 0===t&&(t=!0),this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.userData=JSON.parse(JSON.stringify(e.userData)),!0===t)for(var r=0;r<e.children.length;r++){var i=e.children[r];this.add(i.clone())}return this}}),Camera.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Camera,isCamera:!0,copy:function(e,t){return Object3D.prototype.copy.call(this,e,t),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this},getWorldDirection:(Er=new Quaternion,function getWorldDirection(e){var t=e||new Vector3;return this.getWorldQuaternion(Er),t.set(0,0,-1).applyQuaternion(Er)}),updateMatrixWorld:function(e){Object3D.prototype.updateMatrixWorld.call(this,e),this.matrixWorldInverse.getInverse(this.matrixWorld)},clone:function(){return(new this.constructor).copy(this)}}),OrthographicCamera.prototype=Object.assign(Object.create(Camera.prototype),{constructor:OrthographicCamera,isOrthographicCamera:!0,copy:function(e,t){return Camera.prototype.copy.call(this,e,t),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this},setViewOffset:function(e,t,r,i,n,a){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=r,this.view.offsetY=i,this.view.width=n,this.view.height=a,this.updateProjectionMatrix()},clearViewOffset:function(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()},updateProjectionMatrix:function(){var e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),r=(this.right+this.left)/2,i=(this.top+this.bottom)/2,n=r-e,a=r+e,o=i+t,s=i-t;if(null!==this.view&&this.view.enabled){var c=this.zoom/(this.view.width/this.view.fullWidth),l=this.zoom/(this.view.height/this.view.fullHeight),h=(this.right-this.left)/this.view.width,u=(this.top-this.bottom)/this.view.height;a=(n+=h*(this.view.offsetX/c))+h*(this.view.width/c),s=(o-=u*(this.view.offsetY/l))-u*(this.view.height/l)}this.projectionMatrix.makeOrthographic(n,a,o,s,this.near,this.far)},toJSON:function(e){var t=Object3D.prototype.toJSON.call(this,e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,null!==this.view&&(t.object.view=Object.assign({},this.view)),t}}),Object.assign(Face3.prototype,{clone:function(){return(new this.constructor).copy(this)},copy:function(e){this.a=e.a,this.b=e.b,this.c=e.c,this.normal.copy(e.normal),this.color.copy(e.color),this.materialIndex=e.materialIndex;for(var t=0,r=e.vertexNormals.length;t<r;t++)this.vertexNormals[t]=e.vertexNormals[t].clone();for(t=0,r=e.vertexColors.length;t<r;t++)this.vertexColors[t]=e.vertexColors[t].clone();return this}});var Ar,Lr,Cr,Pr,Rr,Br,Ir=0;function Geometry(){Object.defineProperty(this,"id",{value:Ir+=2}),this.uuid=Et.generateUUID(),this.name="",this.type="Geometry",this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.elementsNeedUpdate=!1,this.verticesNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.groupsNeedUpdate=!1}function BufferAttribute(e,t,r){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.uuid=Et.generateUUID(),this.name="",this.array=e,this.itemSize=t,this.count=void 0!==e?e.length/t:0,this.normalized=!0===r,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.onUploadCallback=function(){},this.version=0}function Int8BufferAttribute(e,t,r){BufferAttribute.call(this,new Int8Array(e),t,r)}function Uint8BufferAttribute(e,t,r){BufferAttribute.call(this,new Uint8Array(e),t,r)}function Uint8ClampedBufferAttribute(e,t,r){BufferAttribute.call(this,new Uint8ClampedArray(e),t,r)}function Int16BufferAttribute(e,t,r){BufferAttribute.call(this,new Int16Array(e),t,r)}function Uint16BufferAttribute(e,t,r){BufferAttribute.call(this,new Uint16Array(e),t,r)}function Int32BufferAttribute(e,t,r){BufferAttribute.call(this,new Int32Array(e),t,r)}function Uint32BufferAttribute(e,t,r){BufferAttribute.call(this,new Uint32Array(e),t,r)}function Float32BufferAttribute(e,t,r){BufferAttribute.call(this,new Float32Array(e),t,r)}function Float64BufferAttribute(e,t,r){BufferAttribute.call(this,new Float64Array(e),t,r)}function DirectGeometry(){this.indices=[],this.vertices=[],this.normals=[],this.colors=[],this.uvs=[],this.uvs2=[],this.groups=[],this.morphTargets={},this.skinWeights=[],this.skinIndices=[],this.boundingBox=null,this.boundingSphere=null,this.verticesNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.groupsNeedUpdate=!1}function arrayMax(e){if(0===e.length)return-1/0;for(var t=e[0],r=1,i=e.length;r<i;++r)e[r]>t&&(t=e[r]);return t}Object.assign(Geometry.prototype,EventDispatcher.prototype,{isGeometry:!0,applyMatrix:function(e){for(var t=(new Matrix3).getNormalMatrix(e),r=0,i=this.vertices.length;r<i;r++){this.vertices[r].applyMatrix4(e)}for(r=0,i=this.faces.length;r<i;r++){var n=this.faces[r];n.normal.applyMatrix3(t).normalize();for(var a=0,o=n.vertexNormals.length;a<o;a++)n.vertexNormals[a].applyMatrix3(t).normalize()}return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this.verticesNeedUpdate=!0,this.normalsNeedUpdate=!0,this},rotateX:(Br=new Matrix4,function rotateX(e){return Br.makeRotationX(e),this.applyMatrix(Br),this}),rotateY:(Rr=new Matrix4,function rotateY(e){return Rr.makeRotationY(e),this.applyMatrix(Rr),this}),rotateZ:(Pr=new Matrix4,function rotateZ(e){return Pr.makeRotationZ(e),this.applyMatrix(Pr),this}),translate:(Cr=new Matrix4,function translate(e,t,r){return Cr.makeTranslation(e,t,r),this.applyMatrix(Cr),this}),scale:(Lr=new Matrix4,function scale(e,t,r){return Lr.makeScale(e,t,r),this.applyMatrix(Lr),this}),lookAt:(Ar=new Object3D,function lookAt(e){Ar.lookAt(e),Ar.updateMatrix(),this.applyMatrix(Ar.matrix)}),fromBufferGeometry:function(e){var a=this,t=null!==e.index?e.index.array:void 0,r=e.attributes,i=r.position.array,o=void 0!==r.normal?r.normal.array:void 0,s=void 0!==r.color?r.color.array:void 0,c=void 0!==r.uv?r.uv.array:void 0,l=void 0!==r.uv2?r.uv2.array:void 0;void 0!==l&&(this.faceVertexUvs[1]=[]);for(var h=[],u=[],d=[],n=0,p=0;n<i.length;n+=3,p+=2)a.vertices.push(new Vector3(i[n],i[n+1],i[n+2])),void 0!==o&&h.push(new Vector3(o[n],o[n+1],o[n+2])),void 0!==s&&a.colors.push(new Color(s[n],s[n+1],s[n+2])),void 0!==c&&u.push(new Vector2(c[p],c[p+1])),void 0!==l&&d.push(new Vector2(l[p],l[p+1]));function addFace(e,t,r,i){var n=new Face3(e,t,r,void 0!==o?[h[e].clone(),h[t].clone(),h[r].clone()]:[],void 0!==s?[a.colors[e].clone(),a.colors[t].clone(),a.colors[r].clone()]:[],i);a.faces.push(n),void 0!==c&&a.faceVertexUvs[0].push([u[e].clone(),u[t].clone(),u[r].clone()]),void 0!==l&&a.faceVertexUvs[1].push([d[e].clone(),d[t].clone(),d[r].clone()])}var f=e.groups;if(0<f.length)for(n=0;n<f.length;n++)for(var m=f[n],g=m.start,v=(p=g,g+m.count);p<v;p+=3)void 0!==t?addFace(t[p],t[p+1],t[p+2],m.materialIndex):addFace(p,p+1,p+2,m.materialIndex);else if(void 0!==t)for(n=0;n<t.length;n+=3)addFace(t[n],t[n+1],t[n+2]);else for(n=0;n<i.length/3;n+=3)addFace(n,n+1,n+2);return this.computeFaceNormals(),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this},center:function(){this.computeBoundingBox();var e=this.boundingBox.getCenter().negate();return this.translate(e.x,e.y,e.z),e},normalize:function(){this.computeBoundingSphere();var e=this.boundingSphere.center,t=this.boundingSphere.radius,r=0===t?1:1/t,i=new Matrix4;return i.set(r,0,0,-r*e.x,0,r,0,-r*e.y,0,0,r,-r*e.z,0,0,0,1),this.applyMatrix(i),this},computeFaceNormals:function(){for(var e=new Vector3,t=new Vector3,r=0,i=this.faces.length;r<i;r++){var n=this.faces[r],a=this.vertices[n.a],o=this.vertices[n.b],s=this.vertices[n.c];e.subVectors(s,o),t.subVectors(a,o),e.cross(t),e.normalize(),n.normal.copy(e)}},computeVertexNormals:function(e){var t,r,i,n,a,o;for(void 0===e&&(e=!0),o=new Array(this.vertices.length),t=0,r=this.vertices.length;t<r;t++)o[t]=new Vector3;if(e){var s,c,l,h=new Vector3,u=new Vector3;for(i=0,n=this.faces.length;i<n;i++)a=this.faces[i],s=this.vertices[a.a],c=this.vertices[a.b],l=this.vertices[a.c],h.subVectors(l,c),u.subVectors(s,c),h.cross(u),o[a.a].add(h),o[a.b].add(h),o[a.c].add(h)}else for(this.computeFaceNormals(),i=0,n=this.faces.length;i<n;i++)o[(a=this.faces[i]).a].add(a.normal),o[a.b].add(a.normal),o[a.c].add(a.normal);for(t=0,r=this.vertices.length;t<r;t++)o[t].normalize();for(i=0,n=this.faces.length;i<n;i++){var d=(a=this.faces[i]).vertexNormals;3===d.length?(d[0].copy(o[a.a]),d[1].copy(o[a.b]),d[2].copy(o[a.c])):(d[0]=o[a.a].clone(),d[1]=o[a.b].clone(),d[2]=o[a.c].clone())}0<this.faces.length&&(this.normalsNeedUpdate=!0)},computeFlatVertexNormals:function(){var e,t,r;for(this.computeFaceNormals(),e=0,t=this.faces.length;e<t;e++){var i=(r=this.faces[e]).vertexNormals;3===i.length?(i[0].copy(r.normal),i[1].copy(r.normal),i[2].copy(r.normal)):(i[0]=r.normal.clone(),i[1]=r.normal.clone(),i[2]=r.normal.clone())}0<this.faces.length&&(this.normalsNeedUpdate=!0)},computeMorphNormals:function(){var e,t,r,i,n;for(r=0,i=this.faces.length;r<i;r++)for((n=this.faces[r]).__originalFaceNormal?n.__originalFaceNormal.copy(n.normal):n.__originalFaceNormal=n.normal.clone(),n.__originalVertexNormals||(n.__originalVertexNormals=[]),e=0,t=n.vertexNormals.length;e<t;e++)n.__originalVertexNormals[e]?n.__originalVertexNormals[e].copy(n.vertexNormals[e]):n.__originalVertexNormals[e]=n.vertexNormals[e].clone();var a=new Geometry;for(a.faces=this.faces,e=0,t=this.morphTargets.length;e<t;e++){if(!this.morphNormals[e]){this.morphNormals[e]={},this.morphNormals[e].faceNormals=[],this.morphNormals[e].vertexNormals=[];var o=this.morphNormals[e].faceNormals,s=this.morphNormals[e].vertexNormals;for(r=0,i=this.faces.length;r<i;r++)c=new Vector3,l={a:new Vector3,b:new Vector3,c:new Vector3},o.push(c),s.push(l)}var c,l,h=this.morphNormals[e];for(a.vertices=this.morphTargets[e].vertices,a.computeFaceNormals(),a.computeVertexNormals(),r=0,i=this.faces.length;r<i;r++)n=this.faces[r],c=h.faceNormals[r],l=h.vertexNormals[r],c.copy(n.normal),l.a.copy(n.vertexNormals[0]),l.b.copy(n.vertexNormals[1]),l.c.copy(n.vertexNormals[2])}for(r=0,i=this.faces.length;r<i;r++)(n=this.faces[r]).normal=n.__originalFaceNormal,n.vertexNormals=n.__originalVertexNormals},computeLineDistances:function(){for(var e=0,t=this.vertices,r=0,i=t.length;r<i;r++)0<r&&(e+=t[r].distanceTo(t[r-1])),this.lineDistances[r]=e},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new Box3),this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new Sphere),this.boundingSphere.setFromPoints(this.vertices)},merge:function(e,t,r){if(e&&e.isGeometry){var i,n=this.vertices.length,a=this.vertices,o=e.vertices,s=this.faces,c=e.faces,l=this.faceVertexUvs[0],h=e.faceVertexUvs[0],u=this.colors,d=e.colors;void 0===r&&(r=0),void 0!==t&&(i=(new Matrix3).getNormalMatrix(t));for(var p=0,f=o.length;p<f;p++){var m=o[p].clone();void 0!==t&&m.applyMatrix4(t),a.push(m)}for(p=0,f=d.length;p<f;p++)u.push(d[p].clone());for(p=0,f=c.length;p<f;p++){var g,v,y,x=c[p],b=x.vertexNormals,M=x.vertexColors;(g=new Face3(x.a+n,x.b+n,x.c+n)).normal.copy(x.normal),void 0!==i&&g.normal.applyMatrix3(i).normalize();for(var _=0,w=b.length;_<w;_++)v=b[_].clone(),void 0!==i&&v.applyMatrix3(i).normalize(),g.vertexNormals.push(v);g.color.copy(x.color);for(_=0,w=M.length;_<w;_++)y=M[_],g.vertexColors.push(y.clone());g.materialIndex=x.materialIndex+r,s.push(g)}for(p=0,f=h.length;p<f;p++){var T=h[p],E=[];if(void 0!==T){for(_=0,w=T.length;_<w;_++)E.push(T[_].clone());l.push(E)}}}else console.error("THREE.Geometry.merge(): geometry not an instance of THREE.Geometry.",e)},mergeMesh:function(e){e&&e.isMesh?(e.matrixAutoUpdate&&e.updateMatrix(),this.merge(e.geometry,e.matrix)):console.error("THREE.Geometry.mergeMesh(): mesh not an instance of THREE.Mesh.",e)},mergeVertices:function(){var e,t,r,i,n,a,o,s,c={},l=[],h=[],u=Math.pow(10,4);for(r=0,i=this.vertices.length;r<i;r++)e=this.vertices[r],void 0===c[t=Math.round(e.x*u)+"_"+Math.round(e.y*u)+"_"+Math.round(e.z*u)]?(c[t]=r,l.push(this.vertices[r]),h[r]=l.length-1):h[r]=h[c[t]];var d=[];for(r=0,i=this.faces.length;r<i;r++){(n=this.faces[r]).a=h[n.a],n.b=h[n.b],n.c=h[n.c],a=[n.a,n.b,n.c];for(var p=0;p<3;p++)if(a[p]===a[(p+1)%3]){d.push(r);break}}for(r=d.length-1;0<=r;r--){var f=d[r];for(this.faces.splice(f,1),o=0,s=this.faceVertexUvs.length;o<s;o++)this.faceVertexUvs[o].splice(f,1)}var m=this.vertices.length-l.length;return this.vertices=l,m},setFromPoints:function(e){this.vertices=[];for(var t=0,r=e.length;t<r;t++){var i=e[t];this.vertices.push(new Vector3(i.x,i.y,i.z||0))}return this},sortFacesByMaterialIndex:function(){for(var e=this.faces,t=e.length,r=0;r<t;r++)e[r]._id=r;e.sort(function materialIndexSort(e,t){return e.materialIndex-t.materialIndex});var i,n,a=this.faceVertexUvs[0],o=this.faceVertexUvs[1];a&&a.length===t&&(i=[]),o&&o.length===t&&(n=[]);for(r=0;r<t;r++){var s=e[r]._id;i&&i.push(a[s]),n&&n.push(o[s])}i&&(this.faceVertexUvs[0]=i),n&&(this.faceVertexUvs[1]=n)},toJSON:function(){var e={metadata:{version:4.5,type:"Geometry",generator:"Geometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),void 0!==this.parameters){var t=this.parameters;for(var r in t)void 0!==t[r]&&(e[r]=t[r]);return e}for(var i=[],n=0;n<this.vertices.length;n++){var a=this.vertices[n];i.push(a.x,a.y,a.z)}var o=[],s=[],c={},l=[],h={},u=[],d={};for(n=0;n<this.faces.length;n++){var p=this.faces[n],f=void 0!==this.faceVertexUvs[0][n],m=0<p.normal.length(),g=0<p.vertexNormals.length,v=1!==p.color.r||1!==p.color.g||1!==p.color.b,y=0<p.vertexColors.length,x=0;if(x=setBit(x=setBit(x=setBit(x=setBit(x=setBit(x=setBit(x=setBit(x=setBit(x,0,0),1,!0),2,!1),3,f),4,m),5,g),6,v),7,y),o.push(x),o.push(p.a,p.b,p.c),o.push(p.materialIndex),f){var b=this.faceVertexUvs[0][n];o.push(getUvIndex(b[0]),getUvIndex(b[1]),getUvIndex(b[2]))}if(m&&o.push(getNormalIndex(p.normal)),g){var M=p.vertexNormals;o.push(getNormalIndex(M[0]),getNormalIndex(M[1]),getNormalIndex(M[2]))}if(v&&o.push(getColorIndex(p.color)),y){var _=p.vertexColors;o.push(getColorIndex(_[0]),getColorIndex(_[1]),getColorIndex(_[2]))}}function setBit(e,t,r){return r?e|1<<t:e&~(1<<t)}function getNormalIndex(e){var t=e.x.toString()+e.y.toString()+e.z.toString();return void 0!==c[t]||(c[t]=s.length/3,s.push(e.x,e.y,e.z)),c[t]}function getColorIndex(e){var t=e.r.toString()+e.g.toString()+e.b.toString();return void 0!==h[t]||(h[t]=l.length,l.push(e.getHex())),h[t]}function getUvIndex(e){var t=e.x.toString()+e.y.toString();return void 0!==d[t]||(d[t]=u.length/2,u.push(e.x,e.y)),d[t]}return e.data={},e.data.vertices=i,e.data.normals=s,0<l.length&&(e.data.colors=l),0<u.length&&(e.data.uvs=[u]),e.data.faces=o,e},clone:function(){return(new Geometry).copy(this)},copy:function(e){var t,r,i,n,a,o;this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.name=e.name;var s=e.vertices;for(t=0,r=s.length;t<r;t++)this.vertices.push(s[t].clone());var c=e.colors;for(t=0,r=c.length;t<r;t++)this.colors.push(c[t].clone());var l=e.faces;for(t=0,r=l.length;t<r;t++)this.faces.push(l[t].clone());for(t=0,r=e.faceVertexUvs.length;t<r;t++){var h=e.faceVertexUvs[t];for(void 0===this.faceVertexUvs[t]&&(this.faceVertexUvs[t]=[]),i=0,n=h.length;i<n;i++){var u=h[i],d=[];for(a=0,o=u.length;a<o;a++){var p=u[a];d.push(p.clone())}this.faceVertexUvs[t].push(d)}}var f=e.morphTargets;for(t=0,r=f.length;t<r;t++){var m={};if(m.name=f[t].name,void 0!==f[t].vertices)for(m.vertices=[],i=0,n=f[t].vertices.length;i<n;i++)m.vertices.push(f[t].vertices[i].clone());if(void 0!==f[t].normals)for(m.normals=[],i=0,n=f[t].normals.length;i<n;i++)m.normals.push(f[t].normals[i].clone());this.morphTargets.push(m)}var g=e.morphNormals;for(t=0,r=g.length;t<r;t++){var v={};if(void 0!==g[t].vertexNormals)for(v.vertexNormals=[],i=0,n=g[t].vertexNormals.length;i<n;i++){var y=g[t].vertexNormals[i],x={};x.a=y.a.clone(),x.b=y.b.clone(),x.c=y.c.clone(),v.vertexNormals.push(x)}if(void 0!==g[t].faceNormals)for(v.faceNormals=[],i=0,n=g[t].faceNormals.length;i<n;i++)v.faceNormals.push(g[t].faceNormals[i].clone());this.morphNormals.push(v)}var b=e.skinWeights;for(t=0,r=b.length;t<r;t++)this.skinWeights.push(b[t].clone());var M=e.skinIndices;for(t=0,r=M.length;t<r;t++)this.skinIndices.push(M[t].clone());var _=e.lineDistances;for(t=0,r=_.length;t<r;t++)this.lineDistances.push(_[t]);var w=e.boundingBox;null!==w&&(this.boundingBox=w.clone());var T=e.boundingSphere;return null!==T&&(this.boundingSphere=T.clone()),this.elementsNeedUpdate=e.elementsNeedUpdate,this.verticesNeedUpdate=e.verticesNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.lineDistancesNeedUpdate=e.lineDistancesNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Object.defineProperty(BufferAttribute.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),Object.assign(BufferAttribute.prototype,{isBufferAttribute:!0,setArray:function(e){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.count=void 0!==e?e.length/this.itemSize:0,this.array=e},setDynamic:function(e){return this.dynamic=e,this},copy:function(e){return this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.dynamic=e.dynamic,this},copyAt:function(e,t,r){e*=this.itemSize,r*=t.itemSize;for(var i=0,n=this.itemSize;i<n;i++)this.array[e+i]=t.array[r+i];return this},copyArray:function(e){return this.array.set(e),this},copyColorsArray:function(e){for(var t=this.array,r=0,i=0,n=e.length;i<n;i++){var a=e[i];void 0===a&&(console.warn("THREE.BufferAttribute.copyColorsArray(): color is undefined",i),a=new Color),t[r++]=a.r,t[r++]=a.g,t[r++]=a.b}return this},copyIndicesArray:function(e){for(var t=this.array,r=0,i=0,n=e.length;i<n;i++){var a=e[i];t[r++]=a.a,t[r++]=a.b,t[r++]=a.c}return this},copyVector2sArray:function(e){for(var t=this.array,r=0,i=0,n=e.length;i<n;i++){var a=e[i];void 0===a&&(console.warn("THREE.BufferAttribute.copyVector2sArray(): vector is undefined",i),a=new Vector2),t[r++]=a.x,t[r++]=a.y}return this},copyVector3sArray:function(e){for(var t=this.array,r=0,i=0,n=e.length;i<n;i++){var a=e[i];void 0===a&&(console.warn("THREE.BufferAttribute.copyVector3sArray(): vector is undefined",i),a=new Vector3),t[r++]=a.x,t[r++]=a.y,t[r++]=a.z}return this},copyVector4sArray:function(e){for(var t=this.array,r=0,i=0,n=e.length;i<n;i++){var a=e[i];void 0===a&&(console.warn("THREE.BufferAttribute.copyVector4sArray(): vector is undefined",i),a=new Vector4),t[r++]=a.x,t[r++]=a.y,t[r++]=a.z,t[r++]=a.w}return this},set:function(e,t){return void 0===t&&(t=0),this.array.set(e,t),this},getX:function(e){return this.array[e*this.itemSize]},setX:function(e,t){return this.array[e*this.itemSize]=t,this},getY:function(e){return this.array[e*this.itemSize+1]},setY:function(e,t){return this.array[e*this.itemSize+1]=t,this},getZ:function(e){return this.array[e*this.itemSize+2]},setZ:function(e,t){return this.array[e*this.itemSize+2]=t,this},getW:function(e){return this.array[e*this.itemSize+3]},setW:function(e,t){return this.array[e*this.itemSize+3]=t,this},setXY:function(e,t,r){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=r,this},setXYZ:function(e,t,r,i){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=r,this.array[e+2]=i,this},setXYZW:function(e,t,r,i,n){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=r,this.array[e+2]=i,this.array[e+3]=n,this},onUpload:function(e){return this.onUploadCallback=e,this},clone:function(){return new this.constructor(this.array,this.itemSize).copy(this)}}),(Int8BufferAttribute.prototype=Object.create(BufferAttribute.prototype)).constructor=Int8BufferAttribute,(Uint8BufferAttribute.prototype=Object.create(BufferAttribute.prototype)).constructor=Uint8BufferAttribute,(Uint8ClampedBufferAttribute.prototype=Object.create(BufferAttribute.prototype)).constructor=Uint8ClampedBufferAttribute,(Int16BufferAttribute.prototype=Object.create(BufferAttribute.prototype)).constructor=Int16BufferAttribute,(Uint16BufferAttribute.prototype=Object.create(BufferAttribute.prototype)).constructor=Uint16BufferAttribute,(Int32BufferAttribute.prototype=Object.create(BufferAttribute.prototype)).constructor=Int32BufferAttribute,(Uint32BufferAttribute.prototype=Object.create(BufferAttribute.prototype)).constructor=Uint32BufferAttribute,(Float32BufferAttribute.prototype=Object.create(BufferAttribute.prototype)).constructor=Float32BufferAttribute,(Float64BufferAttribute.prototype=Object.create(BufferAttribute.prototype)).constructor=Float64BufferAttribute,Object.assign(DirectGeometry.prototype,{computeGroups:function(e){for(var t,r=[],i=void 0,n=e.faces,a=0;a<n.length;a++){var o=n[a];o.materialIndex!==i&&(i=o.materialIndex,void 0!==t&&(t.count=3*a-t.start,r.push(t)),t={start:3*a,materialIndex:i})}void 0!==t&&(t.count=3*a-t.start,r.push(t)),this.groups=r},fromGeometry:function(e){var t,r=e.faces,i=e.vertices,n=e.faceVertexUvs,a=n[0]&&0<n[0].length,o=n[1]&&0<n[1].length,s=e.morphTargets,c=s.length;if(0<c){t=[];for(var l=0;l<c;l++)t[l]=[];this.morphTargets.position=t}var h,u=e.morphNormals,d=u.length;if(0<d){h=[];for(l=0;l<d;l++)h[l]=[];this.morphTargets.normal=h}var p=e.skinIndices,f=e.skinWeights,m=p.length===i.length,g=f.length===i.length;for(l=0;l<r.length;l++){var v=r[l];this.vertices.push(i[v.a],i[v.b],i[v.c]);var y=v.vertexNormals;if(3===y.length)this.normals.push(y[0],y[1],y[2]);else{var x=v.normal;this.normals.push(x,x,x)}var b,M=v.vertexColors;if(3===M.length)this.colors.push(M[0],M[1],M[2]);else{var _=v.color;this.colors.push(_,_,_)}if(!0===a)void 0!==(b=n[0][l])?this.uvs.push(b[0],b[1],b[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv ",l),this.uvs.push(new Vector2,new Vector2,new Vector2));if(!0===o)void 0!==(b=n[1][l])?this.uvs2.push(b[0],b[1],b[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv2 ",l),this.uvs2.push(new Vector2,new Vector2,new Vector2));for(var w=0;w<c;w++){var T=s[w].vertices;t[w].push(T[v.a],T[v.b],T[v.c])}for(w=0;w<d;w++){var E=u[w].vertexNormals[l];h[w].push(E.a,E.b,E.c)}m&&this.skinIndices.push(p[v.a],p[v.b],p[v.c]),g&&this.skinWeights.push(f[v.a],f[v.b],f[v.c])}return this.computeGroups(e),this.verticesNeedUpdate=e.verticesNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,this}});var Dr,Gr,Ur,Or,Vr,Fr,Nr,zr,Hr,kr,jr,Wr,Xr,qr,Yr,Zr,Qr,Kr,Jr,$r,ei,ti,ri,ii,ni,ai,oi,si,ci,li,hi,ui,di,pi=1;function BufferGeometry(){Object.defineProperty(this,"id",{value:pi+=2}),this.uuid=Et.generateUUID(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0}}function BoxGeometry(e,t,r,i,n,a){Geometry.call(this),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:r,widthSegments:i,heightSegments:n,depthSegments:a},this.fromBufferGeometry(new BoxBufferGeometry(e,t,r,i,n,a)),this.mergeVertices()}function BoxBufferGeometry(e,t,r,i,n,a){BufferGeometry.call(this),this.type="BoxBufferGeometry",this.parameters={width:e,height:t,depth:r,widthSegments:i,heightSegments:n,depthSegments:a};var C=this;e=e||1,t=t||1,r=r||1,i=Math.floor(i)||1,n=Math.floor(n)||1,a=Math.floor(a)||1;var P=[],R=[],B=[],I=[],D=0,G=0;function buildPlane(e,t,r,i,n,a,o,s,c,l,h){var u,d,p=a/c,f=o/l,m=a/2,g=o/2,v=s/2,y=c+1,x=l+1,b=0,M=0,_=new Vector3;for(d=0;d<x;d++){var w=d*f-g;for(u=0;u<y;u++){var T=u*p-m;_[e]=T*i,_[t]=w*n,_[r]=v,R.push(_.x,_.y,_.z),_[e]=0,_[t]=0,_[r]=0<s?1:-1,B.push(_.x,_.y,_.z),I.push(u/c),I.push(1-d/l),b+=1}}for(d=0;d<l;d++)for(u=0;u<c;u++){var E=D+u+y*d,S=D+u+y*(d+1),A=D+(u+1)+y*(d+1),L=D+(u+1)+y*d;P.push(E,S,L),P.push(S,A,L),M+=6}C.addGroup(G,M,h),G+=M,D+=b}buildPlane("z","y","x",-1,-1,r,t,e,a,n,0),buildPlane("z","y","x",1,-1,r,t,-e,a,n,1),buildPlane("x","z","y",1,1,e,r,t,i,a,2),buildPlane("x","z","y",1,-1,e,r,-t,i,a,3),buildPlane("x","y","z",1,-1,e,t,r,i,n,4),buildPlane("x","y","z",-1,-1,e,t,-r,i,n,5),this.setIndex(P),this.addAttribute("position",new Float32BufferAttribute(R,3)),this.addAttribute("normal",new Float32BufferAttribute(B,3)),this.addAttribute("uv",new Float32BufferAttribute(I,2))}function PlaneGeometry(e,t,r,i){Geometry.call(this),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:r,heightSegments:i},this.fromBufferGeometry(new PlaneBufferGeometry(e,t,r,i)),this.mergeVertices()}function PlaneBufferGeometry(e,t,r,i){BufferGeometry.call(this),this.type="PlaneBufferGeometry",this.parameters={width:e,height:t,widthSegments:r,heightSegments:i};var n,a,o=(e=e||1)/2,s=(t=t||1)/2,c=Math.floor(r)||1,l=Math.floor(i)||1,h=c+1,u=l+1,d=e/c,p=t/l,f=[],m=[],g=[],v=[];for(a=0;a<u;a++){var y=a*p-s;for(n=0;n<h;n++){var x=n*d-o;m.push(x,-y,0),g.push(0,0,1),v.push(n/c),v.push(1-a/l)}}for(a=0;a<l;a++)for(n=0;n<c;n++){var b=n+h*a,M=n+h*(a+1),_=n+1+h*(a+1),w=n+1+h*a;f.push(b,M,w),f.push(M,_,w)}this.setIndex(f),this.addAttribute("position",new Float32BufferAttribute(m,3)),this.addAttribute("normal",new Float32BufferAttribute(g,3)),this.addAttribute("uv",new Float32BufferAttribute(v,2))}function MeshBasicMaterial(e){Material.call(this),this.type="MeshBasicMaterial",this.color=new Color(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=he,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.lights=!1,this.setValues(e)}function ShaderMaterial(e){Material.call(this),this.type="ShaderMaterial",this.defines={},this.uniforms={},this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},(this.index0AttributeName=void 0)!==e&&(void 0!==e.attributes&&console.error("THREE.ShaderMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e))}function Ray(e,t){this.origin=void 0!==e?e:new Vector3,this.direction=void 0!==t?t:new Vector3}function Line3(e,t){this.start=void 0!==e?e:new Vector3,this.end=void 0!==t?t:new Vector3}function Triangle(e,t,r){this.a=void 0!==e?e:new Vector3,this.b=void 0!==t?t:new Vector3,this.c=void 0!==r?r:new Vector3}function Mesh(e,t){Object3D.call(this),this.type="Mesh",this.geometry=void 0!==e?e:new BufferGeometry,this.material=void 0!==t?t:new MeshBasicMaterial({color:16777215*Math.random()}),this.drawMode=mt,this.updateMorphTargets()}function WebGLBackground(a,r,o,i){var s,c,l,h=new Color(0),u=0;function setClear(e,t){r.buffers.color.setClear(e.r,e.g,e.b,t,i)}return{getClearColor:function(){return h},setClearColor:function(e,t){h.set(e),setClear(h,u=void 0!==t?t:1)},getClearAlpha:function(){return u},setClearAlpha:function(e){setClear(h,u=e)},render:function render(e,t,r,i){var n=t.background;null===n?setClear(h,u):n&&n.isColor&&(setClear(n,1),i=!0),(a.autoClear||i)&&a.clear(a.autoClearColor,a.autoClearDepth,a.autoClearStencil),n&&n.isCubeTexture?(void 0===l&&((l=new Mesh(new BoxBufferGeometry(1,1,1),new ShaderMaterial({uniforms:Ht.cube.uniforms,vertexShader:Ht.cube.vertexShader,fragmentShader:Ht.cube.fragmentShader,side:X,depthTest:!0,depthWrite:!1,fog:!1}))).geometry.removeAttribute("normal"),l.geometry.removeAttribute("uv"),l.onBeforeRender=function(e,t,r){this.matrixWorld.copyPosition(r.matrixWorld)},o.update(l.geometry)),l.material.uniforms.tCube.value=n,e.push(l,l.geometry,l.material,0,null)):n&&n.isTexture&&(void 0===s&&(s=new OrthographicCamera(-1,1,1,-1,0,1),c=new Mesh(new PlaneBufferGeometry(2,2),new MeshBasicMaterial({depthTest:!1,depthWrite:!1,fog:!1})),o.update(c.geometry)),c.material.map=n,a.renderBufferDirect(s,null,c.geometry,c.material,c,null))}}}function painterSortStable(e,t){return e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.program&&t.program&&e.program!==t.program?e.program.id-t.program.id:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function reversePainterSortStable(e,t){return e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function WebGLRenderList(){var o=[],s=0,c=[],l=[];return{opaque:c,transparent:l,init:function init(){s=0,c.length=0,l.length=0},push:function push(e,t,r,i,n){var a=o[s];void 0===a?(a={id:e.id,object:e,geometry:t,material:r,program:r.program,renderOrder:e.renderOrder,z:i,group:n},o[s]=a):(a.id=e.id,a.object=e,a.geometry=t,a.material=r,a.program=r.program,a.renderOrder=e.renderOrder,a.z=i,a.group=n),(!0===r.transparent?l:c).push(a),s++},sort:function sort(){1<c.length&&c.sort(painterSortStable),1<l.length&&l.sort(reversePainterSortStable)}}}function WebGLRenderLists(){var n={};return{get:function get(e,t){var r=e.id+","+t.id,i=n[r];return void 0===i&&(i=new WebGLRenderList,n[r]=i),i},dispose:function dispose(){n={}}}}function absNumericalSort(e,t){return Math.abs(t[1])-Math.abs(e[1])}function WebGLMorphtargets(p){var f={},m=new Float32Array(8);return{update:function update(e,t,r,i){var n=e.morphTargetInfluences,a=n.length,o=f[t.id];if(void 0===o){o=[];for(var s=0;s<a;s++)o[s]=[s,0];f[t.id]=o}var c=r.morphTargets&&t.morphAttributes.position,l=r.morphNormals&&t.morphAttributes.normal;for(s=0;s<a;s++)0!==(h=o[s])[1]&&(c&&t.removeAttribute("morphTarget"+s),l&&t.removeAttribute("morphNormal"+s));for(s=0;s<a;s++)(h=o[s])[0]=s,h[1]=n[s];for(o.sort(absNumericalSort),s=0;s<8;s++){var h;if(h=o[s]){var u=h[0],d=h[1];if(d){c&&t.addAttribute("morphTarget"+s,c[u]),l&&t.addAttribute("morphNormal"+s,l[u]),m[s]=d;continue}}m[s]=0}i.getUniforms().setValue(p,"morphTargetInfluences",m)}}}function WebGLIndexedBufferRenderer(n,a,o){var s,c,l;this.setMode=function setMode(e){s=e},this.setIndex=function setIndex(e){c=e.type,l=e.bytesPerElement},this.render=function render(e,t){n.drawElements(s,t,c,e*l),o.calls++,o.vertices+=t,s===n.TRIANGLES?o.faces+=t/3:s===n.POINTS&&(o.points+=t)},this.renderInstances=function renderInstances(e,t,r){var i=a.get("ANGLE_instanced_arrays");null!==i?(i.drawElementsInstancedANGLE(s,r,c,t*l,e.maxInstancedCount),o.calls++,o.vertices+=r*e.maxInstancedCount,s===n.TRIANGLES?o.faces+=e.maxInstancedCount*r/3:s===n.POINTS&&(o.points+=e.maxInstancedCount*r)):console.error("THREE.WebGLIndexedBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.")}}function WebGLBufferRenderer(a,o,s){var c;this.setMode=function setMode(e){c=e},this.render=function render(e,t){a.drawArrays(c,e,t),s.calls++,s.vertices+=t,c===a.TRIANGLES?s.faces+=t/3:c===a.POINTS&&(s.points+=t)},this.renderInstances=function renderInstances(e,t,r){var i=o.get("ANGLE_instanced_arrays");if(null!==i){var n=e.attributes.position;n.isInterleavedBufferAttribute?(r=n.data.count,i.drawArraysInstancedANGLE(c,0,r,e.maxInstancedCount)):i.drawArraysInstancedANGLE(c,t,r,e.maxInstancedCount),s.calls++,s.vertices+=r*e.maxInstancedCount,c===a.TRIANGLES?s.faces+=e.maxInstancedCount*r/3:c===a.POINTS&&(s.points+=e.maxInstancedCount*r)}else console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.")}}function WebGLGeometries(u,d,a){var o={},p={};function onGeometryDispose(e){var t=e.target,r=o[t.id];for(var i in null!==r.index&&d.remove(r.index),r.attributes)d.remove(r.attributes[i]);t.removeEventListener("dispose",onGeometryDispose),delete o[t.id];var n=p[t.id];n&&(d.remove(n),delete p[t.id]),(n=p[r.id])&&(d.remove(n),delete p[r.id]),a.geometries--}return{get:function get(e,t){var r=o[t.id];return r||(t.addEventListener("dispose",onGeometryDispose),t.isBufferGeometry?r=t:t.isGeometry&&(void 0===t._bufferGeometry&&(t._bufferGeometry=(new BufferGeometry).setFromObject(e)),r=t._bufferGeometry),o[t.id]=r,a.geometries++,r)},update:function update(e){var t=e.index,r=e.attributes;for(var i in null!==t&&d.update(t,u.ELEMENT_ARRAY_BUFFER),r)d.update(r[i],u.ARRAY_BUFFER);var n=e.morphAttributes;for(var i in n)for(var a=n[i],o=0,s=a.length;o<s;o++)d.update(a[o],u.ARRAY_BUFFER)},getWireframeAttribute:function getWireframeAttribute(e){var t=p[e.id];if(t)return t;var r,i=[],n=e.index,a=e.attributes;if(null!==n)for(var o=0,s=(r=n.array).length;o<s;o+=3){var c=r[o+0],l=r[o+1],h=r[o+2];i.push(c,l,l,h,h,c)}else for(o=0,s=(r=a.position.array).length/3-1;o<s;o+=3)c=o+0,l=o+1,h=o+2,i.push(c,l,l,h,h,c);return t=new(65535<arrayMax(i)?Uint32BufferAttribute:Uint16BufferAttribute)(i,1),d.update(t,u.ELEMENT_ARRAY_BUFFER),p[e.id]=t}}}function UniformsCache(){var r={};return{get:function(e){if(void 0!==r[e.id])return r[e.id];var t;switch(e.type){case"DirectionalLight":t={direction:new Vector3,color:new Color,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new Vector2};break;case"SpotLight":t={position:new Vector3,direction:new Vector3,color:new Color,distance:0,coneCos:0,penumbraCos:0,decay:0,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new Vector2};break;case"PointLight":t={position:new Vector3,color:new Color,distance:0,decay:0,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new Vector2,shadowCameraNear:1,shadowCameraFar:1e3};break;case"HemisphereLight":t={direction:new Vector3,skyColor:new Color,groundColor:new Color};break;case"RectAreaLight":t={color:new Color,position:new Vector3,halfWidth:new Vector3,halfHeight:new Vector3}}return r[e.id]=t}}}function WebGLLights(){var M=new UniformsCache,_={hash:"",ambient:[0,0,0],directional:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotShadowMap:[],spotShadowMatrix:[],rectArea:[],point:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[]},w=new Vector3,T=new Matrix4,E=new Matrix4;return{setup:function setup(e,t,r){for(var i=0,n=0,a=0,o=0,s=0,c=0,l=0,h=0,u=r.matrixWorldInverse,d=0,p=e.length;d<p;d++){var f=e[d],m=f.color,g=f.intensity,v=f.distance,y=f.shadow&&f.shadow.map?f.shadow.map.texture:null;if(f.isAmbientLight)i+=m.r*g,n+=m.g*g,a+=m.b*g;else if(f.isDirectionalLight){if((b=M.get(f)).color.copy(f.color).multiplyScalar(f.intensity),b.direction.setFromMatrixPosition(f.matrixWorld),w.setFromMatrixPosition(f.target.matrixWorld),b.direction.sub(w),b.direction.transformDirection(u),b.shadow=f.castShadow,f.castShadow){var x=f.shadow;b.shadowBias=x.bias,b.shadowRadius=x.radius,b.shadowMapSize=x.mapSize}_.directionalShadowMap[o]=y,_.directionalShadowMatrix[o]=f.shadow.matrix,_.directional[o]=b,o++}else if(f.isSpotLight)(b=M.get(f)).position.setFromMatrixPosition(f.matrixWorld),b.position.applyMatrix4(u),b.color.copy(m).multiplyScalar(g),b.distance=v,b.direction.setFromMatrixPosition(f.matrixWorld),w.setFromMatrixPosition(f.target.matrixWorld),b.direction.sub(w),b.direction.transformDirection(u),b.coneCos=Math.cos(f.angle),b.penumbraCos=Math.cos(f.angle*(1-f.penumbra)),b.decay=0===f.distance?0:f.decay,b.shadow=f.castShadow,f.castShadow&&(x=f.shadow,b.shadowBias=x.bias,b.shadowRadius=x.radius,b.shadowMapSize=x.mapSize),_.spotShadowMap[c]=y,_.spotShadowMatrix[c]=f.shadow.matrix,_.spot[c]=b,c++;else if(f.isRectAreaLight)(b=M.get(f)).color.copy(m).multiplyScalar(g/(f.width*f.height)),b.position.setFromMatrixPosition(f.matrixWorld),b.position.applyMatrix4(u),E.identity(),T.copy(f.matrixWorld),T.premultiply(u),E.extractRotation(T),b.halfWidth.set(.5*f.width,0,0),b.halfHeight.set(0,.5*f.height,0),b.halfWidth.applyMatrix4(E),b.halfHeight.applyMatrix4(E),_.rectArea[l]=b,l++;else if(f.isPointLight)(b=M.get(f)).position.setFromMatrixPosition(f.matrixWorld),b.position.applyMatrix4(u),b.color.copy(f.color).multiplyScalar(f.intensity),b.distance=f.distance,b.decay=0===f.distance?0:f.decay,b.shadow=f.castShadow,f.castShadow&&(x=f.shadow,b.shadowBias=x.bias,b.shadowRadius=x.radius,b.shadowMapSize=x.mapSize,b.shadowCameraNear=x.camera.near,b.shadowCameraFar=x.camera.far),_.pointShadowMap[s]=y,_.pointShadowMatrix[s]=f.shadow.matrix,_.point[s]=b,s++;else if(f.isHemisphereLight){var b;(b=M.get(f)).direction.setFromMatrixPosition(f.matrixWorld),b.direction.transformDirection(u),b.direction.normalize(),b.skyColor.copy(f.color).multiplyScalar(g),b.groundColor.copy(f.groundColor).multiplyScalar(g),_.hemi[h]=b,h++}}_.ambient[0]=i,_.ambient[1]=n,_.ambient[2]=a,_.directional.length=o,_.spot.length=c,_.rectArea.length=l,_.point.length=s,_.hemi.length=h,_.hash=o+","+s+","+c+","+l+","+h+","+t.length},state:_}}function WebGLObjects(n,a){var o={};return{update:function update(e){var t=a.frame,r=e.geometry,i=n.get(e,r);return o[i.id]!==t&&(r.isGeometry&&i.updateFromObject(e),n.update(i),o[i.id]=t),i},clear:function clear(){o={}}}}function WebGLShader(e,t,r){var i=e.createShader(t);return e.shaderSource(i,r),e.compileShader(i),!1===e.getShaderParameter(i,e.COMPILE_STATUS)&&console.error("THREE.WebGLShader: Shader couldn't compile."),""!==e.getShaderInfoLog(i)&&console.warn("THREE.WebGLShader: gl.getShaderInfoLog()",t===e.VERTEX_SHADER?"vertex":"fragment",e.getShaderInfoLog(i),function addLineNumbers(e){for(var t=e.split("\n"),r=0;r<t.length;r++)t[r]=r+1+": "+t[r];return t.join("\n")}(r)),i}Object.assign(BufferGeometry.prototype,EventDispatcher.prototype,{isBufferGeometry:!0,getIndex:function(){return this.index},setIndex:function(e){Array.isArray(e)?this.index=new(65535<arrayMax(e)?Uint32BufferAttribute:Uint16BufferAttribute)(e,1):this.index=e},addAttribute:function(e,t){return t&&t.isBufferAttribute||t&&t.isInterleavedBufferAttribute?"index"===e?(console.warn("THREE.BufferGeometry.addAttribute: Use .setIndex() for index attribute."),void this.setIndex(t)):(this.attributes[e]=t,this):(console.warn("THREE.BufferGeometry: .addAttribute() now expects ( name, attribute )."),void this.addAttribute(e,new BufferAttribute(t,arguments[2])))},getAttribute:function(e){return this.attributes[e]},removeAttribute:function(e){return delete this.attributes[e],this},addGroup:function(e,t,r){this.groups.push({start:e,count:t,materialIndex:void 0!==r?r:0})},clearGroups:function(){this.groups=[]},setDrawRange:function(e,t){this.drawRange.start=e,this.drawRange.count=t},applyMatrix:function(e){var t=this.attributes.position;void 0!==t&&(e.applyToBufferAttribute(t),t.needsUpdate=!0);var r=this.attributes.normal;void 0!==r&&((new Matrix3).getNormalMatrix(e).applyToBufferAttribute(r),r.needsUpdate=!0);return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},rotateX:(Hr=new Matrix4,function rotateX(e){return Hr.makeRotationX(e),this.applyMatrix(Hr),this}),rotateY:(zr=new Matrix4,function rotateY(e){return zr.makeRotationY(e),this.applyMatrix(zr),this}),rotateZ:(Nr=new Matrix4,function rotateZ(e){return Nr.makeRotationZ(e),this.applyMatrix(Nr),this}),translate:(Fr=new Matrix4,function translate(e,t,r){return Fr.makeTranslation(e,t,r),this.applyMatrix(Fr),this}),scale:(Vr=new Matrix4,function scale(e,t,r){return Vr.makeScale(e,t,r),this.applyMatrix(Vr),this}),lookAt:(Or=new Object3D,function lookAt(e){Or.lookAt(e),Or.updateMatrix(),this.applyMatrix(Or.matrix)}),center:function(){this.computeBoundingBox();var e=this.boundingBox.getCenter().negate();return this.translate(e.x,e.y,e.z),e},setFromObject:function(e){var t=e.geometry;if(e.isPoints||e.isLine){var r=new Float32BufferAttribute(3*t.vertices.length,3),i=new Float32BufferAttribute(3*t.colors.length,3);if(this.addAttribute("position",r.copyVector3sArray(t.vertices)),this.addAttribute("color",i.copyColorsArray(t.colors)),t.lineDistances&&t.lineDistances.length===t.vertices.length){var n=new Float32BufferAttribute(t.lineDistances.length,1);this.addAttribute("lineDistance",n.copyArray(t.lineDistances))}null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone())}else e.isMesh&&t&&t.isGeometry&&this.fromGeometry(t);return this},setFromPoints:function(e){for(var t=[],r=0,i=e.length;r<i;r++){var n=e[r];t.push(n.x,n.y,n.z||0)}return this.addAttribute("position",new Float32BufferAttribute(t,3)),this},updateFromObject:function(e){var t,r=e.geometry;if(e.isMesh){var i=r.__directGeometry;if(!0===r.elementsNeedUpdate&&(i=void 0,r.elementsNeedUpdate=!1),void 0===i)return this.fromGeometry(r);i.verticesNeedUpdate=r.verticesNeedUpdate,i.normalsNeedUpdate=r.normalsNeedUpdate,i.colorsNeedUpdate=r.colorsNeedUpdate,i.uvsNeedUpdate=r.uvsNeedUpdate,i.groupsNeedUpdate=r.groupsNeedUpdate,r.verticesNeedUpdate=!1,r.normalsNeedUpdate=!1,r.colorsNeedUpdate=!1,r.uvsNeedUpdate=!1,r.groupsNeedUpdate=!1,r=i}return!0===r.verticesNeedUpdate&&(void 0!==(t=this.attributes.position)&&(t.copyVector3sArray(r.vertices),t.needsUpdate=!0),r.verticesNeedUpdate=!1),!0===r.normalsNeedUpdate&&(void 0!==(t=this.attributes.normal)&&(t.copyVector3sArray(r.normals),t.needsUpdate=!0),r.normalsNeedUpdate=!1),!0===r.colorsNeedUpdate&&(void 0!==(t=this.attributes.color)&&(t.copyColorsArray(r.colors),t.needsUpdate=!0),r.colorsNeedUpdate=!1),r.uvsNeedUpdate&&(void 0!==(t=this.attributes.uv)&&(t.copyVector2sArray(r.uvs),t.needsUpdate=!0),r.uvsNeedUpdate=!1),r.lineDistancesNeedUpdate&&(void 0!==(t=this.attributes.lineDistance)&&(t.copyArray(r.lineDistances),t.needsUpdate=!0),r.lineDistancesNeedUpdate=!1),r.groupsNeedUpdate&&(r.computeGroups(e.geometry),this.groups=r.groups,r.groupsNeedUpdate=!1),this},fromGeometry:function(e){return e.__directGeometry=(new DirectGeometry).fromGeometry(e),this.fromDirectGeometry(e.__directGeometry)},fromDirectGeometry:function(e){var t=new Float32Array(3*e.vertices.length);if(this.addAttribute("position",new BufferAttribute(t,3).copyVector3sArray(e.vertices)),0<e.normals.length){var r=new Float32Array(3*e.normals.length);this.addAttribute("normal",new BufferAttribute(r,3).copyVector3sArray(e.normals))}if(0<e.colors.length){var i=new Float32Array(3*e.colors.length);this.addAttribute("color",new BufferAttribute(i,3).copyColorsArray(e.colors))}if(0<e.uvs.length){var n=new Float32Array(2*e.uvs.length);this.addAttribute("uv",new BufferAttribute(n,2).copyVector2sArray(e.uvs))}if(0<e.uvs2.length){var a=new Float32Array(2*e.uvs2.length);this.addAttribute("uv2",new BufferAttribute(a,2).copyVector2sArray(e.uvs2))}if(0<e.indices.length){var o=new(65535<arrayMax(e.indices)?Uint32Array:Uint16Array)(3*e.indices.length);this.setIndex(new BufferAttribute(o,1).copyIndicesArray(e.indices))}for(var s in this.groups=e.groups,e.morphTargets){for(var c=[],l=e.morphTargets[s],h=0,u=l.length;h<u;h++){var d=l[h],p=new Float32BufferAttribute(3*d.length,3);c.push(p.copyVector3sArray(d))}this.morphAttributes[s]=c}if(0<e.skinIndices.length){var f=new Float32BufferAttribute(4*e.skinIndices.length,4);this.addAttribute("skinIndex",f.copyVector4sArray(e.skinIndices))}if(0<e.skinWeights.length){var m=new Float32BufferAttribute(4*e.skinWeights.length,4);this.addAttribute("skinWeight",m.copyVector4sArray(e.skinWeights))}return null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),this},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new Box3);var e=this.attributes.position;void 0!==e?this.boundingBox.setFromBufferAttribute(e):this.boundingBox.makeEmpty(),(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox: Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)},computeBoundingSphere:(Gr=new Box3,Ur=new Vector3,function computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new Sphere);var e=this.attributes.position;if(e){var t=this.boundingSphere.center;Gr.setFromBufferAttribute(e),Gr.getCenter(t);for(var r=0,i=0,n=e.count;i<n;i++)Ur.x=e.getX(i),Ur.y=e.getY(i),Ur.z=e.getZ(i),r=Math.max(r,t.distanceToSquared(Ur));this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}),computeFaceNormals:function(){},computeVertexNormals:function(){var e=this.index,t=this.attributes,r=this.groups;if(t.position){var i=t.position.array;if(void 0===t.normal)this.addAttribute("normal",new BufferAttribute(new Float32Array(i.length),3));else for(var n=t.normal.array,a=0,o=n.length;a<o;a++)n[a]=0;var s,c,l,h=t.normal.array,u=new Vector3,d=new Vector3,p=new Vector3,f=new Vector3,m=new Vector3;if(e){var g=e.array;0===r.length&&this.addGroup(0,g.length);for(var v=0,y=r.length;v<y;++v){var x=r[v],b=x.start;for(a=b,o=b+x.count;a<o;a+=3)s=3*g[a+0],c=3*g[a+1],l=3*g[a+2],u.fromArray(i,s),d.fromArray(i,c),p.fromArray(i,l),f.subVectors(p,d),m.subVectors(u,d),f.cross(m),h[s]+=f.x,h[s+1]+=f.y,h[s+2]+=f.z,h[c]+=f.x,h[c+1]+=f.y,h[c+2]+=f.z,h[l]+=f.x,h[l+1]+=f.y,h[l+2]+=f.z}}else for(a=0,o=i.length;a<o;a+=9)u.fromArray(i,a),d.fromArray(i,a+3),p.fromArray(i,a+6),f.subVectors(p,d),m.subVectors(u,d),f.cross(m),h[a]=f.x,h[a+1]=f.y,h[a+2]=f.z,h[a+3]=f.x,h[a+4]=f.y,h[a+5]=f.z,h[a+6]=f.x,h[a+7]=f.y,h[a+8]=f.z;this.normalizeNormals(),t.normal.needsUpdate=!0}},merge:function(e,t){if(e&&e.isBufferGeometry){void 0===t&&(t=0);var r=this.attributes;for(var i in r)if(void 0!==e.attributes[i])for(var n=r[i].array,a=e.attributes[i],o=a.array,s=0,c=a.itemSize*t;s<o.length;s++,c++)n[c]=o[s];return this}console.error("THREE.BufferGeometry.merge(): geometry not an instance of THREE.BufferGeometry.",e)},normalizeNormals:(Dr=new Vector3,function normalizeNormals(){for(var e=this.attributes.normal,t=0,r=e.count;t<r;t++)Dr.x=e.getX(t),Dr.y=e.getY(t),Dr.z=e.getZ(t),Dr.normalize(),e.setXYZ(t,Dr.x,Dr.y,Dr.z)}),toNonIndexed:function(){if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): Geometry is already non-indexed."),this;var e=new BufferGeometry,t=this.index.array,r=this.attributes;for(var i in r){for(var n=r[i],a=n.array,o=n.itemSize,s=new a.constructor(t.length*o),c=0,l=0,h=0,u=t.length;h<u;h++){c=t[h]*o;for(var d=0;d<o;d++)s[l++]=a[c++]}e.addAttribute(i,new BufferAttribute(s,o))}return e},toJSON:function(){var e={metadata:{version:4.5,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),void 0!==this.parameters){var t=this.parameters;for(var r in t)void 0!==t[r]&&(e[r]=t[r]);return e}e.data={attributes:{}};var i=this.index;if(null!==i){var n=Array.prototype.slice.call(i.array);e.data.index={type:i.array.constructor.name,array:n}}var a=this.attributes;for(var r in a){var o=a[r];n=Array.prototype.slice.call(o.array);e.data.attributes[r]={itemSize:o.itemSize,type:o.array.constructor.name,array:n,normalized:o.normalized}}var s=this.groups;0<s.length&&(e.data.groups=JSON.parse(JSON.stringify(s)));var c=this.boundingSphere;return null!==c&&(e.data.boundingSphere={center:c.center.toArray(),radius:c.radius}),e},clone:function(){return(new BufferGeometry).copy(this)},copy:function(e){var t,r,i;this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.name=e.name;var n=e.index;null!==n&&this.setIndex(n.clone());var a=e.attributes;for(t in a){var o=a[t];this.addAttribute(t,o.clone())}var s=e.morphAttributes;for(t in s){var c=[],l=s[t];for(r=0,i=l.length;r<i;r++)c.push(l[r].clone());this.morphAttributes[t]=c}var h=e.groups;for(r=0,i=h.length;r<i;r++){var u=h[r];this.addGroup(u.start,u.count,u.materialIndex)}var d=e.boundingBox;null!==d&&(this.boundingBox=d.clone());var p=e.boundingSphere;return null!==p&&(this.boundingSphere=p.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),(BoxGeometry.prototype=Object.create(Geometry.prototype)).constructor=BoxGeometry,(BoxBufferGeometry.prototype=Object.create(BufferGeometry.prototype)).constructor=BoxBufferGeometry,(PlaneGeometry.prototype=Object.create(Geometry.prototype)).constructor=PlaneGeometry,(PlaneBufferGeometry.prototype=Object.create(BufferGeometry.prototype)).constructor=PlaneBufferGeometry,((MeshBasicMaterial.prototype=Object.create(Material.prototype)).constructor=MeshBasicMaterial).prototype.isMeshBasicMaterial=!0,MeshBasicMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this},((ShaderMaterial.prototype=Object.create(Material.prototype)).constructor=ShaderMaterial).prototype.isShaderMaterial=!0,ShaderMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=Nt.clone(e.uniforms),this.defines=e.defines,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.lights=e.lights,this.clipping=e.clipping,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this.extensions=e.extensions,this},ShaderMaterial.prototype.toJSON=function(e){var t=Material.prototype.toJSON.call(this,e);return t.uniforms=this.uniforms,t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader,t},Object.assign(Ray.prototype,{set:function(e,t){return this.origin.copy(e),this.direction.copy(t),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this},at:function(e,t){return(t||new Vector3).copy(this.direction).multiplyScalar(e).add(this.origin)},lookAt:function(e){return this.direction.copy(e).sub(this.origin).normalize(),this},recast:($r=new Vector3,function recast(e){return this.origin.copy(this.at(e,$r)),this}),closestPointToPoint:function(e,t){var r=t||new Vector3;r.subVectors(e,this.origin);var i=r.dot(this.direction);return i<0?r.copy(this.origin):r.copy(this.direction).multiplyScalar(i).add(this.origin)},distanceToPoint:function(e){return Math.sqrt(this.distanceSqToPoint(e))},distanceSqToPoint:(Jr=new Vector3,function distanceSqToPoint(e){var t=Jr.subVectors(e,this.origin).dot(this.direction);return t<0?this.origin.distanceToSquared(e):(Jr.copy(this.direction).multiplyScalar(t).add(this.origin),Jr.distanceToSquared(e))}),distanceSqToSegment:(Zr=new Vector3,Qr=new Vector3,Kr=new Vector3,function distanceSqToSegment(e,t,r,i){Zr.copy(e).add(t).multiplyScalar(.5),Qr.copy(t).sub(e).normalize(),Kr.copy(this.origin).sub(Zr);var n,a,o,s,c=.5*e.distanceTo(t),l=-this.direction.dot(Qr),h=Kr.dot(this.direction),u=-Kr.dot(Qr),d=Kr.lengthSq(),p=Math.abs(1-l*l);if(0<p)if(a=l*h-u,s=c*p,0<=(n=l*u-h))if(-s<=a)if(a<=s){var f=1/p;o=(n*=f)*(n+l*(a*=f)+2*h)+a*(l*n+a+2*u)+d}else a=c,o=-(n=Math.max(0,-(l*a+h)))*n+a*(a+2*u)+d;else a=-c,o=-(n=Math.max(0,-(l*a+h)))*n+a*(a+2*u)+d;else o=a<=-s?-(n=Math.max(0,-(-l*c+h)))*n+(a=0<n?-c:Math.min(Math.max(-c,-u),c))*(a+2*u)+d:a<=s?(n=0,(a=Math.min(Math.max(-c,-u),c))*(a+2*u)+d):-(n=Math.max(0,-(l*c+h)))*n+(a=0<n?c:Math.min(Math.max(-c,-u),c))*(a+2*u)+d;else a=0<l?-c:c,o=-(n=Math.max(0,-(l*a+h)))*n+a*(a+2*u)+d;return r&&r.copy(this.direction).multiplyScalar(n).add(this.origin),i&&i.copy(Qr).multiplyScalar(a).add(Zr),o}),intersectSphere:(Yr=new Vector3,function intersectSphere(e,t){Yr.subVectors(e.center,this.origin);var r=Yr.dot(this.direction),i=Yr.dot(Yr)-r*r,n=e.radius*e.radius;if(n<i)return null;var a=Math.sqrt(n-i),o=r-a,s=r+a;return o<0&&s<0?null:o<0?this.at(s,t):this.at(o,t)}),intersectsSphere:function(e){return this.distanceToPoint(e.center)<=e.radius},distanceToPlane:function(e){var t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;var r=-(this.origin.dot(e.normal)+e.constant)/t;return 0<=r?r:null},intersectPlane:function(e,t){var r=this.distanceToPlane(e);return null===r?null:this.at(r,t)},intersectsPlane:function(e){var t=e.distanceToPoint(this.origin);return 0===t||e.normal.dot(this.direction)*t<0},intersectBox:function(e,t){var r,i,n,a,o,s,c=1/this.direction.x,l=1/this.direction.y,h=1/this.direction.z,u=this.origin;return i=0<=c?(r=(e.min.x-u.x)*c,(e.max.x-u.x)*c):(r=(e.max.x-u.x)*c,(e.min.x-u.x)*c),(a=0<=l?(n=(e.min.y-u.y)*l,(e.max.y-u.y)*l):(n=(e.max.y-u.y)*l,(e.min.y-u.y)*l))<r||i<n?null:((r<n||r!=r)&&(r=n),(a<i||i!=i)&&(i=a),(s=0<=h?(o=(e.min.z-u.z)*h,(e.max.z-u.z)*h):(o=(e.max.z-u.z)*h,(e.min.z-u.z)*h))<r||i<o?null:((r<o||r!=r)&&(r=o),(s<i||i!=i)&&(i=s),i<0?null:this.at(0<=r?r:i,t)))},intersectsBox:(qr=new Vector3,function intersectsBox(e){return null!==this.intersectBox(e,qr)}),intersectTriangle:(kr=new Vector3,jr=new Vector3,Wr=new Vector3,Xr=new Vector3,function intersectTriangle(e,t,r,i,n){jr.subVectors(t,e),Wr.subVectors(r,e),Xr.crossVectors(jr,Wr);var a,o=this.direction.dot(Xr);if(0<o){if(i)return null;a=1}else{if(!(o<0))return null;a=-1,o=-o}kr.subVectors(this.origin,e);var s=a*this.direction.dot(Wr.crossVectors(kr,Wr));if(s<0)return null;var c=a*this.direction.dot(jr.cross(kr));if(c<0)return null;if(o<s+c)return null;var l=-a*kr.dot(Xr);return l<0?null:this.at(l/o,n)}),applyMatrix4:function(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this},equals:function(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}}),Object.assign(Line3.prototype,{set:function(e,t){return this.start.copy(e),this.end.copy(t),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.start.copy(e.start),this.end.copy(e.end),this},getCenter:function(e){return(e||new Vector3).addVectors(this.start,this.end).multiplyScalar(.5)},delta:function(e){return(e||new Vector3).subVectors(this.end,this.start)},distanceSq:function(){return this.start.distanceToSquared(this.end)},distance:function(){return this.start.distanceTo(this.end)},at:function(e,t){var r=t||new Vector3;return this.delta(r).multiplyScalar(e).add(this.start)},closestPointToPointParameter:(ei=new Vector3,ti=new Vector3,function closestPointToPointParameter(e,t){ei.subVectors(e,this.start),ti.subVectors(this.end,this.start);var r=ti.dot(ti),i=ti.dot(ei)/r;return t&&(i=Et.clamp(i,0,1)),i}),closestPointToPoint:function(e,t,r){var i=this.closestPointToPointParameter(e,t),n=r||new Vector3;return this.delta(n).multiplyScalar(i).add(this.start)},applyMatrix4:function(e){return this.start.applyMatrix4(e),this.end.applyMatrix4(e),this},equals:function(e){return e.start.equals(this.start)&&e.end.equals(this.end)}}),Object.assign(Triangle,{normal:(oi=new Vector3,function normal(e,t,r,i){var n=i||new Vector3;n.subVectors(r,t),oi.subVectors(e,t),n.cross(oi);var a=n.lengthSq();return 0<a?n.multiplyScalar(1/Math.sqrt(a)):n.set(0,0,0)}),barycoordFromPoint:(ii=new Vector3,ni=new Vector3,ai=new Vector3,function barycoordFromPoint(e,t,r,i,n){ii.subVectors(i,t),ni.subVectors(r,t),ai.subVectors(e,t);var a=ii.dot(ii),o=ii.dot(ni),s=ii.dot(ai),c=ni.dot(ni),l=ni.dot(ai),h=a*c-o*o,u=n||new Vector3;if(0===h)return u.set(-2,-1,-1);var d=1/h,p=(c*s-o*l)*d,f=(a*l-o*s)*d;return u.set(1-p-f,f,p)}),containsPoint:(ri=new Vector3,function containsPoint(e,t,r,i){var n=Triangle.barycoordFromPoint(e,t,r,i,ri);return 0<=n.x&&0<=n.y&&n.x+n.y<=1})}),Object.assign(Triangle.prototype,{set:function(e,t,r){return this.a.copy(e),this.b.copy(t),this.c.copy(r),this},setFromPointsAndIndices:function(e,t,r,i){return this.a.copy(e[t]),this.b.copy(e[r]),this.c.copy(e[i]),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this},area:(ui=new Vector3,di=new Vector3,function area(){return ui.subVectors(this.c,this.b),di.subVectors(this.a,this.b),.5*ui.cross(di).length()}),midpoint:function(e){return(e||new Vector3).addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)},normal:function(e){return Triangle.normal(this.a,this.b,this.c,e)},plane:function(e){return(e||new Plane).setFromCoplanarPoints(this.a,this.b,this.c)},barycoordFromPoint:function(e,t){return Triangle.barycoordFromPoint(e,this.a,this.b,this.c,t)},containsPoint:function(e){return Triangle.containsPoint(e,this.a,this.b,this.c)},closestPointToPoint:(si=new Plane,ci=[new Line3,new Line3,new Line3],li=new Vector3,hi=new Vector3,function closestPointToPoint(e,t){var r=t||new Vector3,i=1/0;if(si.setFromCoplanarPoints(this.a,this.b,this.c),si.projectPoint(e,li),!0===this.containsPoint(li))r.copy(li);else{ci[0].set(this.a,this.b),ci[1].set(this.b,this.c),ci[2].set(this.c,this.a);for(var n=0;n<ci.length;n++){ci[n].closestPointToPoint(li,!0,hi);var a=li.distanceToSquared(hi);a<i&&(i=a,r.copy(hi))}}return r}),equals:function(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}),Mesh.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Mesh,isMesh:!0,setDrawMode:function(e){this.drawMode=e},copy:function(e){return Object3D.prototype.copy.call(this,e),this.drawMode=e.drawMode,void 0!==e.morphTargetInfluences&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),void 0!==e.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this},updateMorphTargets:function(){var e,t,r,i=this.geometry;if(i.isBufferGeometry){var n=i.morphAttributes,a=Object.keys(n);if(0<a.length){var o=n[a[0]];if(void 0!==o)for(this.morphTargetInfluences=[],this.morphTargetDictionary={},e=0,t=o.length;e<t;e++)r=o[e].name||String(e),this.morphTargetInfluences.push(0),this.morphTargetDictionary[r]=e}}else{var s=i.morphTargets;if(void 0!==s&&0<s.length)for(this.morphTargetInfluences=[],this.morphTargetDictionary={},e=0,t=s.length;e<t;e++)r=s[e].name||String(e),this.morphTargetInfluences.push(0),this.morphTargetDictionary[r]=e}},raycast:function(){var I=new Matrix4,D=new Ray,G=new Sphere,U=new Vector3,O=new Vector3,V=new Vector3,F=new Vector3,N=new Vector3,z=new Vector3,H=new Vector2,k=new Vector2,j=new Vector2,s=new Vector3,W=new Vector3,l=new Vector3;function uvIntersection(e,t,r,i,n,a,o){return Triangle.barycoordFromPoint(e,t,r,i,s),n.multiplyScalar(s.x),a.multiplyScalar(s.y),o.multiplyScalar(s.z),n.add(a).add(o),n.clone()}function checkIntersection(e,t,r,i,n,a,o,s){if(null===(t.side===X?i.intersectTriangle(o,a,n,!0,s):i.intersectTriangle(n,a,o,t.side!==q,s)))return null;l.copy(s),l.applyMatrix4(e.matrixWorld);var c=r.ray.origin.distanceTo(l);return c<r.near||c>r.far?null:{distance:c,point:l.clone(),object:e}}function checkBufferGeometryIntersection(e,t,r,i,n,a,o,s){U.fromBufferAttribute(i,a),O.fromBufferAttribute(i,o),V.fromBufferAttribute(i,s);var c=checkIntersection(e,e.material,t,r,U,O,V,W);return c&&(n&&(H.fromBufferAttribute(n,a),k.fromBufferAttribute(n,o),j.fromBufferAttribute(n,s),c.uv=uvIntersection(W,U,O,V,H,k,j)),c.face=new Face3(a,o,s,Triangle.normal(U,O,V)),c.faceIndex=a),c}return function raycast(e,t){var r,i=this.geometry,n=this.material,a=this.matrixWorld;if(void 0!==n&&(null===i.boundingSphere&&i.computeBoundingSphere(),G.copy(i.boundingSphere),G.applyMatrix4(a),!1!==e.ray.intersectsSphere(G)&&(I.getInverse(a),D.copy(e.ray).applyMatrix4(I),null===i.boundingBox||!1!==D.intersectsBox(i.boundingBox))))if(i.isBufferGeometry){var o,s,c,l,h,u=i.index,d=i.attributes.position,p=i.attributes.uv;if(null!==u)for(l=0,h=u.count;l<h;l+=3)o=u.getX(l),s=u.getX(l+1),c=u.getX(l+2),(r=checkBufferGeometryIntersection(this,e,D,d,p,o,s,c))&&(r.faceIndex=Math.floor(l/3),t.push(r));else if(void 0!==d)for(l=0,h=d.count;l<h;l+=3)(r=checkBufferGeometryIntersection(this,e,D,d,p,o=l,s=l+1,c=l+2))&&(r.index=o,t.push(r))}else if(i.isGeometry){var f,m,g,v,y=Array.isArray(n),x=i.vertices,b=i.faces,M=i.faceVertexUvs[0];0<M.length&&(v=M);for(var _=0,w=b.length;_<w;_++){var T=b[_],E=y?n[T.materialIndex]:n;if(void 0!==E){if(f=x[T.a],m=x[T.b],g=x[T.c],!0===E.morphTargets){var S=i.morphTargets,A=this.morphTargetInfluences;U.set(0,0,0),O.set(0,0,0),V.set(0,0,0);for(var L=0,C=S.length;L<C;L++){var P=A[L];if(0!==P){var R=S[L].vertices;U.addScaledVector(F.subVectors(R[T.a],f),P),O.addScaledVector(N.subVectors(R[T.b],m),P),V.addScaledVector(z.subVectors(R[T.c],g),P)}}U.add(f),O.add(m),V.add(g),f=U,m=O,g=V}if(r=checkIntersection(this,E,e,D,f,m,g,W)){if(v&&v[_]){var B=v[_];H.copy(B[0]),k.copy(B[1]),j.copy(B[2]),r.uv=uvIntersection(W,f,m,g,H,k,j)}r.face=T,r.faceIndex=_,t.push(r)}}}}}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}});var fi,mi,gi,vi,yi,xi,bi,Mi,_i,wi,Ti,Ei,Si,Ai,Li=0;function getEncodingComponents(e){switch(e){case gt:return["Linear","( value )"];case vt:return["sRGB","( value )"];case xt:return["RGBE","( value )"];case bt:return["RGBM","( value, 7.0 )"];case Mt:return["RGBM","( value, 16.0 )"];case _t:return["RGBD","( value, 256.0 )"];case yt:return["Gamma","( value, float( GAMMA_FACTOR ) )"];default:throw new Error("unsupported encoding: "+e)}}function getTexelDecodingFunction(e,t){var r=getEncodingComponents(t);return"vec4 "+e+"( vec4 value ) { return "+r[0]+"ToLinear"+r[1]+"; }"}function filterEmptyLine(e){return""!==e}function replaceLightNums(e,t){return e.replace(/NUM_DIR_LIGHTS/g,t.numDirLights).replace(/NUM_SPOT_LIGHTS/g,t.numSpotLights).replace(/NUM_RECT_AREA_LIGHTS/g,t.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,t.numPointLights).replace(/NUM_HEMI_LIGHTS/g,t.numHemiLights)}function parseIncludes(e){return e.replace(/^[ \t]*#include +<([\w\d.]+)>/gm,function replace(e,t){var r=zt[t];if(void 0===r)throw new Error("Can not resolve #include <"+t+">");return parseIncludes(r)})}function unrollLoops(e){return e.replace(/for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}/g,function replace(e,t,r,i){for(var n="",a=parseInt(t);a<parseInt(r);a++)n+=i.replace(/\[ i \]/g,"[ "+a+" ]");return n})}function WebGLProgram(e,t,r,i,n,a){var o=e.context,s=i.defines,c=n.vertexShader,l=n.fragmentShader,h="SHADOWMAP_TYPE_BASIC";a.shadowMapType===O?h="SHADOWMAP_TYPE_PCF":a.shadowMapType===R&&(h="SHADOWMAP_TYPE_PCF_SOFT");var u="ENVMAP_TYPE_CUBE",d="ENVMAP_MODE_REFLECTION",p="ENVMAP_BLENDING_MULTIPLY";if(a.envMap){switch(i.envMap.mapping){case xe:case be:u="ENVMAP_TYPE_CUBE";break;case Te:case Ee:u="ENVMAP_TYPE_CUBE_UV";break;case Me:case _e:u="ENVMAP_TYPE_EQUIREC";break;case we:u="ENVMAP_TYPE_SPHERE"}switch(i.envMap.mapping){case be:case _e:d="ENVMAP_MODE_REFRACTION"}switch(i.combine){case he:p="ENVMAP_BLENDING_MULTIPLY";break;case ue:p="ENVMAP_BLENDING_MIX";break;case de:p="ENVMAP_BLENDING_ADD"}}var f,m,g=0<e.gammaFactor?e.gammaFactor:1,v=function generateExtensions(e,t,r){return[(e=e||{}).derivatives||t.envMapCubeUV||t.bumpMap||t.normalMap||t.flatShading?"#extension GL_OES_standard_derivatives : enable":"",(e.fragDepth||t.logarithmicDepthBuffer)&&r.get("EXT_frag_depth")?"#extension GL_EXT_frag_depth : enable":"",e.drawBuffers&&r.get("WEBGL_draw_buffers")?"#extension GL_EXT_draw_buffers : require":"",(e.shaderTextureLOD||t.envMap)&&r.get("EXT_shader_texture_lod")?"#extension GL_EXT_shader_texture_lod : enable":""].filter(filterEmptyLine).join("\n")}(i.extensions,a,t),y=function generateDefines(e){var t=[];for(var r in e){var i=e[r];!1!==i&&t.push("#define "+r+" "+i)}return t.join("\n")}(s),x=o.createProgram();i.isRawShaderMaterial?(0<(f=[y].filter(filterEmptyLine).join("\n")).length&&(f+="\n"),0<(m=[v,y].filter(filterEmptyLine).join("\n")).length&&(m+="\n")):(f=["precision "+a.precision+" float;","precision "+a.precision+" int;","#define SHADER_NAME "+n.name,y,a.supportsVertexTextures?"#define VERTEX_TEXTURES":"","#define GAMMA_FACTOR "+g,"#define MAX_BONES "+a.maxBones,a.useFog&&a.fog?"#define USE_FOG":"",a.useFog&&a.fogExp?"#define FOG_EXP2":"",a.map?"#define USE_MAP":"",a.envMap?"#define USE_ENVMAP":"",a.envMap?"#define "+d:"",a.lightMap?"#define USE_LIGHTMAP":"",a.aoMap?"#define USE_AOMAP":"",a.emissiveMap?"#define USE_EMISSIVEMAP":"",a.bumpMap?"#define USE_BUMPMAP":"",a.normalMap?"#define USE_NORMALMAP":"",a.displacementMap&&a.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",a.specularMap?"#define USE_SPECULARMAP":"",a.roughnessMap?"#define USE_ROUGHNESSMAP":"",a.metalnessMap?"#define USE_METALNESSMAP":"",a.alphaMap?"#define USE_ALPHAMAP":"",a.vertexColors?"#define USE_COLOR":"",a.flatShading?"#define FLAT_SHADED":"",a.skinning?"#define USE_SKINNING":"",a.useVertexTexture?"#define BONE_TEXTURE":"",a.morphTargets?"#define USE_MORPHTARGETS":"",a.morphNormals&&!1===a.flatShading?"#define USE_MORPHNORMALS":"",a.doubleSided?"#define DOUBLE_SIDED":"",a.flipSided?"#define FLIP_SIDED":"","#define NUM_CLIPPING_PLANES "+a.numClippingPlanes,a.shadowMapEnabled?"#define USE_SHADOWMAP":"",a.shadowMapEnabled?"#define "+h:"",a.sizeAttenuation?"#define USE_SIZEATTENUATION":"",a.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",a.logarithmicDepthBuffer&&t.get("EXT_frag_depth")?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_COLOR","\tattribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(filterEmptyLine).join("\n"),m=[v,"precision "+a.precision+" float;","precision "+a.precision+" int;","#define SHADER_NAME "+n.name,y,a.alphaTest?"#define ALPHATEST "+a.alphaTest:"","#define GAMMA_FACTOR "+g,a.useFog&&a.fog?"#define USE_FOG":"",a.useFog&&a.fogExp?"#define FOG_EXP2":"",a.map?"#define USE_MAP":"",a.envMap?"#define USE_ENVMAP":"",a.envMap?"#define "+u:"",a.envMap?"#define "+d:"",a.envMap?"#define "+p:"",a.lightMap?"#define USE_LIGHTMAP":"",a.aoMap?"#define USE_AOMAP":"",a.emissiveMap?"#define USE_EMISSIVEMAP":"",a.bumpMap?"#define USE_BUMPMAP":"",a.normalMap?"#define USE_NORMALMAP":"",a.specularMap?"#define USE_SPECULARMAP":"",a.roughnessMap?"#define USE_ROUGHNESSMAP":"",a.metalnessMap?"#define USE_METALNESSMAP":"",a.alphaMap?"#define USE_ALPHAMAP":"",a.vertexColors?"#define USE_COLOR":"",a.gradientMap?"#define USE_GRADIENTMAP":"",a.flatShading?"#define FLAT_SHADED":"",a.doubleSided?"#define DOUBLE_SIDED":"",a.flipSided?"#define FLIP_SIDED":"","#define NUM_CLIPPING_PLANES "+a.numClippingPlanes,"#define UNION_CLIPPING_PLANES "+(a.numClippingPlanes-a.numClipIntersection),a.shadowMapEnabled?"#define USE_SHADOWMAP":"",a.shadowMapEnabled?"#define "+h:"",a.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",a.physicallyCorrectLights?"#define PHYSICALLY_CORRECT_LIGHTS":"",a.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",a.logarithmicDepthBuffer&&t.get("EXT_frag_depth")?"#define USE_LOGDEPTHBUF_EXT":"",a.envMap&&t.get("EXT_shader_texture_lod")?"#define TEXTURE_LOD_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;",a.toneMapping!==fe?"#define TONE_MAPPING":"",a.toneMapping!==fe?zt.tonemapping_pars_fragment:"",a.toneMapping!==fe?function getToneMappingFunction(e,t){var r;switch(t){case me:r="Linear";break;case ge:r="Reinhard";break;case ve:r="Uncharted2";break;case ye:r="OptimizedCineon";break;default:throw new Error("unsupported toneMapping: "+t)}return"vec3 "+e+"( vec3 color ) { return "+r+"ToneMapping( color ); }"}("toneMapping",a.toneMapping):"",a.dithering?"#define DITHERING":"",a.outputEncoding||a.mapEncoding||a.envMapEncoding||a.emissiveMapEncoding?zt.encodings_pars_fragment:"",a.mapEncoding?getTexelDecodingFunction("mapTexelToLinear",a.mapEncoding):"",a.envMapEncoding?getTexelDecodingFunction("envMapTexelToLinear",a.envMapEncoding):"",a.emissiveMapEncoding?getTexelDecodingFunction("emissiveMapTexelToLinear",a.emissiveMapEncoding):"",a.outputEncoding?function getTexelEncodingFunction(e,t){var r=getEncodingComponents(t);return"vec4 "+e+"( vec4 value ) { return LinearTo"+r[0]+r[1]+"; }"}("linearToOutputTexel",a.outputEncoding):"",a.depthPacking?"#define DEPTH_PACKING "+i.depthPacking:"","\n"].filter(filterEmptyLine).join("\n")),c=replaceLightNums(c=parseIncludes(c),a),l=replaceLightNums(l=parseIncludes(l),a),i.isShaderMaterial||(c=unrollLoops(c),l=unrollLoops(l));var b=f+c,M=m+l,_=WebGLShader(o,o.VERTEX_SHADER,b),w=WebGLShader(o,o.FRAGMENT_SHADER,M);o.attachShader(x,_),o.attachShader(x,w),void 0!==i.index0AttributeName?o.bindAttribLocation(x,0,i.index0AttributeName):!0===a.morphTargets&&o.bindAttribLocation(x,0,"position"),o.linkProgram(x);var T,E,S=o.getProgramInfoLog(x),A=o.getShaderInfoLog(_),L=o.getShaderInfoLog(w),C=!0,P=!0;return!1===o.getProgramParameter(x,o.LINK_STATUS)?(C=!1,console.error("THREE.WebGLProgram: shader error: ",o.getError(),"gl.VALIDATE_STATUS",o.getProgramParameter(x,o.VALIDATE_STATUS),"gl.getProgramInfoLog",S,A,L)):""!==S?console.warn("THREE.WebGLProgram: gl.getProgramInfoLog()",S):""!==A&&""!==L||(P=!1),P&&(this.diagnostics={runnable:C,material:i,programLog:S,vertexShader:{log:A,prefix:f},fragmentShader:{log:L,prefix:m}}),o.deleteShader(_),o.deleteShader(w),this.getUniforms=function(){return void 0===T&&(T=new WebGLUniforms(o,x,e)),T},this.getAttributes=function(){return void 0===E&&(E=function fetchAttributeLocations(e,t){for(var r={},i=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES),n=0;n<i;n++){var a=e.getActiveAttrib(t,n).name;r[a]=e.getAttribLocation(t,a)}return r}(o,x)),E},this.destroy=function(){o.deleteProgram(x),this.program=void 0},Object.defineProperties(this,{uniforms:{get:function(){return console.warn("THREE.WebGLProgram: .uniforms is now .getUniforms()."),this.getUniforms()}},attributes:{get:function(){return console.warn("THREE.WebGLProgram: .attributes is now .getAttributes()."),this.getAttributes()}}}),this.id=Li++,this.code=r,this.usedTimes=1,this.program=x,this.vertexShader=_,this.fragmentShader=w,this}function WebGLPrograms(u,c,d){var l=[],p={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"phong",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow"},a=["precision","supportsVertexTextures","map","mapEncoding","envMap","envMapMode","envMapEncoding","lightMap","aoMap","emissiveMap","emissiveMapEncoding","bumpMap","normalMap","displacementMap","specularMap","roughnessMap","metalnessMap","gradientMap","alphaMap","combine","vertexColors","fog","useFog","fogExp","flatShading","sizeAttenuation","logarithmicDepthBuffer","skinning","maxBones","useVertexTexture","morphTargets","morphNormals","maxMorphTargets","maxMorphNormals","premultipliedAlpha","numDirLights","numPointLights","numSpotLights","numHemiLights","numRectAreaLights","shadowMapEnabled","shadowMapType","toneMapping","physicallyCorrectLights","alphaTest","doubleSided","flipSided","numClippingPlanes","numClipIntersection","depthPacking","dithering"];function getTextureEncodingFromMap(e,t){var r;return e?e.isTexture?r=e.encoding:e.isWebGLRenderTarget&&(console.warn("THREE.WebGLPrograms.getTextureEncodingFromMap: don't use render targets as textures. Use their .texture property instead."),r=e.texture.encoding):r=gt,r===gt&&t&&(r=yt),r}this.getParameters=function(e,t,r,i,n,a,o){var s=p[e.type],c=o.isSkinnedMesh?function allocateBones(e){var t=e.skeleton.bones;if(d.floatVertexTextures)return 1024;var r=d.maxVertexUniforms,i=Math.floor((r-20)/4),n=Math.min(i,t.length);return n<t.length?(console.warn("THREE.WebGLRenderer: Skeleton has "+t.length+" bones. This GPU supports "+n+"."),0):n}(o):0,l=d.precision;null!==e.precision&&(l=d.getMaxPrecision(e.precision))!==e.precision&&console.warn("THREE.WebGLProgram.getParameters:",e.precision,"not supported, using",l,"instead.");var h=u.getRenderTarget();return{shaderID:s,precision:l,supportsVertexTextures:d.vertexTextures,outputEncoding:getTextureEncodingFromMap(h?h.texture:null,u.gammaOutput),map:!!e.map,mapEncoding:getTextureEncodingFromMap(e.map,u.gammaInput),envMap:!!e.envMap,envMapMode:e.envMap&&e.envMap.mapping,envMapEncoding:getTextureEncodingFromMap(e.envMap,u.gammaInput),envMapCubeUV:!!e.envMap&&(e.envMap.mapping===Te||e.envMap.mapping===Ee),lightMap:!!e.lightMap,aoMap:!!e.aoMap,emissiveMap:!!e.emissiveMap,emissiveMapEncoding:getTextureEncodingFromMap(e.emissiveMap,u.gammaInput),bumpMap:!!e.bumpMap,normalMap:!!e.normalMap,displacementMap:!!e.displacementMap,roughnessMap:!!e.roughnessMap,metalnessMap:!!e.metalnessMap,specularMap:!!e.specularMap,alphaMap:!!e.alphaMap,gradientMap:!!e.gradientMap,combine:e.combine,vertexColors:e.vertexColors,fog:!!i,useFog:e.fog,fogExp:i&&i.isFogExp2,flatShading:e.flatShading,sizeAttenuation:e.sizeAttenuation,logarithmicDepthBuffer:d.logarithmicDepthBuffer,skinning:e.skinning&&0<c,maxBones:c,useVertexTexture:d.floatVertexTextures,morphTargets:e.morphTargets,morphNormals:e.morphNormals,maxMorphTargets:u.maxMorphTargets,maxMorphNormals:u.maxMorphNormals,numDirLights:t.directional.length,numPointLights:t.point.length,numSpotLights:t.spot.length,numRectAreaLights:t.rectArea.length,numHemiLights:t.hemi.length,numClippingPlanes:n,numClipIntersection:a,dithering:e.dithering,shadowMapEnabled:u.shadowMap.enabled&&o.receiveShadow&&0<r.length,shadowMapType:u.shadowMap.type,toneMapping:u.toneMapping,physicallyCorrectLights:u.physicallyCorrectLights,premultipliedAlpha:e.premultipliedAlpha,alphaTest:e.alphaTest,doubleSided:e.side===q,flipSided:e.side===X,depthPacking:void 0!==e.depthPacking&&e.depthPacking}},this.getProgramCode=function(e,t){var r=[];if(t.shaderID?r.push(t.shaderID):(r.push(e.fragmentShader),r.push(e.vertexShader)),void 0!==e.defines)for(var i in e.defines)r.push(i),r.push(e.defines[i]);for(var n=0;n<a.length;n++)r.push(t[a[n]]);return r.push(e.onBeforeCompile.toString()),r.push(u.gammaOutput),r.join()},this.acquireProgram=function(e,t,r,i){for(var n,a=0,o=l.length;a<o;a++){var s=l[a];if(s.code===i){++(n=s).usedTimes;break}}return void 0===n&&(n=new WebGLProgram(u,c,i,e,t,r),l.push(n)),n},this.releaseProgram=function(e){if(0==--e.usedTimes){var t=l.indexOf(e);l[t]=l[l.length-1],l.pop(),e.destroy()}},this.programs=l}function WebGLTextures(f,n,m,g,v,y,x){var d="undefined"!=typeof WebGL2RenderingContext&&f instanceof window.WebGL2RenderingContext;function clampToMaxSize(e,t){if(e.width>t||e.height>t){var r=t/Math.max(e.width,e.height),i=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");return i.width=Math.floor(e.width*r),i.height=Math.floor(e.height*r),i.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,i.width,i.height),console.warn("THREE.WebGLRenderer: image is too big ("+e.width+"x"+e.height+"). Resized to "+i.width+"x"+i.height,e),i}return e}function isPowerOfTwo(e){return Et.isPowerOfTwo(e.width)&&Et.isPowerOfTwo(e.height)}function textureNeedsGenerateMipmaps(e,t){return e.generateMipmaps&&t&&e.minFilter!==Ce&&e.minFilter!==Be}function filterFallback(e){return e===Ce||e===Pe||e===Re?f.NEAREST:f.LINEAR}function onTextureDispose(e){var t=e.target;t.removeEventListener("dispose",onTextureDispose),function deallocateTexture(e){var t=g.get(e);if(e.image&&t.__image__webglTextureCube)f.deleteTexture(t.__image__webglTextureCube);else{if(void 0===t.__webglInit)return;f.deleteTexture(t.__webglTexture)}g.remove(e)}(t),x.textures--}function onRenderTargetDispose(e){var t=e.target;t.removeEventListener("dispose",onRenderTargetDispose),function deallocateRenderTarget(e){var t=g.get(e),r=g.get(e.texture);if(!e)return;void 0!==r.__webglTexture&&f.deleteTexture(r.__webglTexture);e.depthTexture&&e.depthTexture.dispose();if(e.isWebGLRenderTargetCube)for(var i=0;i<6;i++)f.deleteFramebuffer(t.__webglFramebuffer[i]),t.__webglDepthbuffer&&f.deleteRenderbuffer(t.__webglDepthbuffer[i]);else f.deleteFramebuffer(t.__webglFramebuffer),t.__webglDepthbuffer&&f.deleteRenderbuffer(t.__webglDepthbuffer);g.remove(e.texture),g.remove(e)}(t),x.textures--}function setTexture2D(e,t){var r=g.get(e);if(0<e.version&&r.__version!==e.version){var i=e.image;if(void 0===i)console.warn("THREE.WebGLRenderer: Texture marked for update but image is undefined",e);else{if(!1!==i.complete)return void function uploadTexture(e,t,r){void 0===e.__webglInit&&(e.__webglInit=!0,t.addEventListener("dispose",onTextureDispose),e.__webglTexture=f.createTexture(),x.textures++);m.activeTexture(f.TEXTURE0+r),m.bindTexture(f.TEXTURE_2D,e.__webglTexture),f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,t.flipY),f.pixelStorei(f.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),f.pixelStorei(f.UNPACK_ALIGNMENT,t.unpackAlignment);var i=clampToMaxSize(t.image,v.maxTextureSize);(function textureNeedsPowerOfTwo(e){return e.wrapS!==Ae||e.wrapT!==Ae||e.minFilter!==Ce&&e.minFilter!==Be})(t)&&!1===isPowerOfTwo(i)&&(i=function makePowerOfTwo(e){if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof ImageBitmap){var t=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");return t.width=Et.floorPowerOfTwo(e.width),t.height=Et.floorPowerOfTwo(e.height),t.getContext("2d").drawImage(e,0,0,t.width,t.height),console.warn("THREE.WebGLRenderer: image is not power of two ("+e.width+"x"+e.height+"). Resized to "+t.width+"x"+t.height,e),t}return e}(i));var n=isPowerOfTwo(i),a=y.convert(t.format),o=y.convert(t.type);setTextureParameters(f.TEXTURE_2D,t,n);var s,c=t.mipmaps;if(t.isDepthTexture){var l=f.DEPTH_COMPONENT;if(t.type===ze){if(!d)throw new Error("Float Depth Texture only supported in WebGL2.0");l=f.DEPTH_COMPONENT32F}else d&&(l=f.DEPTH_COMPONENT16);t.format===$e&&l===f.DEPTH_COMPONENT&&t.type!==Ve&&t.type!==Ne&&(console.warn("THREE.WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture."),t.type=Ve,o=y.convert(t.type)),t.format===et&&(l=f.DEPTH_STENCIL,t.type!==Xe&&(console.warn("THREE.WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture."),t.type=Xe,o=y.convert(t.type))),m.texImage2D(f.TEXTURE_2D,0,l,i.width,i.height,0,a,o,null)}else if(t.isDataTexture)if(0<c.length&&n){for(var h=0,u=c.length;h<u;h++)s=c[h],m.texImage2D(f.TEXTURE_2D,h,a,s.width,s.height,0,a,o,s.data);t.generateMipmaps=!1}else m.texImage2D(f.TEXTURE_2D,0,a,i.width,i.height,0,a,o,i.data);else if(t.isCompressedTexture)for(var h=0,u=c.length;h<u;h++)s=c[h],t.format!==Ze&&t.format!==Ye?-1<m.getCompressedTextureFormats().indexOf(a)?m.compressedTexImage2D(f.TEXTURE_2D,h,a,s.width,s.height,0,s.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):m.texImage2D(f.TEXTURE_2D,h,a,s.width,s.height,0,a,o,s.data);else if(0<c.length&&n){for(var h=0,u=c.length;h<u;h++)s=c[h],m.texImage2D(f.TEXTURE_2D,h,a,a,o,s);t.generateMipmaps=!1}else m.texImage2D(f.TEXTURE_2D,0,a,a,o,i);textureNeedsGenerateMipmaps(t,n)&&f.generateMipmap(f.TEXTURE_2D);e.__version=t.version,t.onUpdate&&t.onUpdate(t)}(r,e,t);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete",e)}}m.activeTexture(f.TEXTURE0+t),m.bindTexture(f.TEXTURE_2D,r.__webglTexture)}function setTextureParameters(e,t,r){var i;if(r?(f.texParameteri(e,f.TEXTURE_WRAP_S,y.convert(t.wrapS)),f.texParameteri(e,f.TEXTURE_WRAP_T,y.convert(t.wrapT)),f.texParameteri(e,f.TEXTURE_MAG_FILTER,y.convert(t.magFilter)),f.texParameteri(e,f.TEXTURE_MIN_FILTER,y.convert(t.minFilter))):(f.texParameteri(e,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(e,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),t.wrapS===Ae&&t.wrapT===Ae||console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping.",t),f.texParameteri(e,f.TEXTURE_MAG_FILTER,filterFallback(t.magFilter)),f.texParameteri(e,f.TEXTURE_MIN_FILTER,filterFallback(t.minFilter)),t.minFilter!==Ce&&t.minFilter!==Be&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter.",t)),i=n.get("EXT_texture_filter_anisotropic")){if(t.type===ze&&null===n.get("OES_texture_float_linear"))return;if(t.type===He&&null===n.get("OES_texture_half_float_linear"))return;(1<t.anisotropy||g.get(t).__currentAnisotropy)&&(f.texParameterf(e,i.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(t.anisotropy,v.getMaxAnisotropy())),g.get(t).__currentAnisotropy=t.anisotropy)}}function setupFrameBufferTexture(e,t,r,i){var n=y.convert(t.texture.format),a=y.convert(t.texture.type);m.texImage2D(i,0,n,t.width,t.height,0,n,a,null),f.bindFramebuffer(f.FRAMEBUFFER,e),f.framebufferTexture2D(f.FRAMEBUFFER,r,i,g.get(t.texture).__webglTexture,0),f.bindFramebuffer(f.FRAMEBUFFER,null)}function setupRenderBufferStorage(e,t){f.bindRenderbuffer(f.RENDERBUFFER,e),t.depthBuffer&&!t.stencilBuffer?(f.renderbufferStorage(f.RENDERBUFFER,f.DEPTH_COMPONENT16,t.width,t.height),f.framebufferRenderbuffer(f.FRAMEBUFFER,f.DEPTH_ATTACHMENT,f.RENDERBUFFER,e)):t.depthBuffer&&t.stencilBuffer?(f.renderbufferStorage(f.RENDERBUFFER,f.DEPTH_STENCIL,t.width,t.height),f.framebufferRenderbuffer(f.FRAMEBUFFER,f.DEPTH_STENCIL_ATTACHMENT,f.RENDERBUFFER,e)):f.renderbufferStorage(f.RENDERBUFFER,f.RGBA4,t.width,t.height),f.bindRenderbuffer(f.RENDERBUFFER,null)}function setupDepthRenderbuffer(e){var t=g.get(e),r=!0===e.isWebGLRenderTargetCube;if(e.depthTexture){if(r)throw new Error("target.depthTexture not supported in Cube render targets");!function setupDepthTexture(e,t){if(t&&t.isWebGLRenderTargetCube)throw new Error("Depth Texture with cube render targets is not supported");if(f.bindFramebuffer(f.FRAMEBUFFER,e),!t.depthTexture||!t.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");g.get(t.depthTexture).__webglTexture&&t.depthTexture.image.width===t.width&&t.depthTexture.image.height===t.height||(t.depthTexture.image.width=t.width,t.depthTexture.image.height=t.height,t.depthTexture.needsUpdate=!0),setTexture2D(t.depthTexture,0);var r=g.get(t.depthTexture).__webglTexture;if(t.depthTexture.format===$e)f.framebufferTexture2D(f.FRAMEBUFFER,f.DEPTH_ATTACHMENT,f.TEXTURE_2D,r,0);else{if(t.depthTexture.format!==et)throw new Error("Unknown depthTexture format");f.framebufferTexture2D(f.FRAMEBUFFER,f.DEPTH_STENCIL_ATTACHMENT,f.TEXTURE_2D,r,0)}}(t.__webglFramebuffer,e)}else if(r){t.__webglDepthbuffer=[];for(var i=0;i<6;i++)f.bindFramebuffer(f.FRAMEBUFFER,t.__webglFramebuffer[i]),t.__webglDepthbuffer[i]=f.createRenderbuffer(),setupRenderBufferStorage(t.__webglDepthbuffer[i],e)}else f.bindFramebuffer(f.FRAMEBUFFER,t.__webglFramebuffer),t.__webglDepthbuffer=f.createRenderbuffer(),setupRenderBufferStorage(t.__webglDepthbuffer,e);f.bindFramebuffer(f.FRAMEBUFFER,null)}this.setTexture2D=setTexture2D,this.setTextureCube=function setTextureCube(e,t){var r=g.get(e);if(6===e.image.length)if(0<e.version&&r.__version!==e.version){r.__image__webglTextureCube||(e.addEventListener("dispose",onTextureDispose),r.__image__webglTextureCube=f.createTexture(),x.textures++),m.activeTexture(f.TEXTURE0+t),m.bindTexture(f.TEXTURE_CUBE_MAP,r.__image__webglTextureCube),f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,e.flipY);for(var i=e&&e.isCompressedTexture,n=e.image[0]&&e.image[0].isDataTexture,a=[],o=0;o<6;o++)a[o]=i||n?n?e.image[o].image:e.image[o]:clampToMaxSize(e.image[o],v.maxCubemapSize);var s=isPowerOfTwo(a[0]),c=y.convert(e.format),l=y.convert(e.type);for(setTextureParameters(f.TEXTURE_CUBE_MAP,e,s),o=0;o<6;o++)if(i)for(var h,u=a[o].mipmaps,d=0,p=u.length;d<p;d++)h=u[d],e.format!==Ze&&e.format!==Ye?-1<m.getCompressedTextureFormats().indexOf(c)?m.compressedTexImage2D(f.TEXTURE_CUBE_MAP_POSITIVE_X+o,d,c,h.width,h.height,0,h.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):m.texImage2D(f.TEXTURE_CUBE_MAP_POSITIVE_X+o,d,c,h.width,h.height,0,c,l,h.data);else n?m.texImage2D(f.TEXTURE_CUBE_MAP_POSITIVE_X+o,0,c,a[o].width,a[o].height,0,c,l,a[o].data):m.texImage2D(f.TEXTURE_CUBE_MAP_POSITIVE_X+o,0,c,c,l,a[o]);textureNeedsGenerateMipmaps(e,s)&&f.generateMipmap(f.TEXTURE_CUBE_MAP),r.__version=e.version,e.onUpdate&&e.onUpdate(e)}else m.activeTexture(f.TEXTURE0+t),m.bindTexture(f.TEXTURE_CUBE_MAP,r.__image__webglTextureCube)},this.setTextureCubeDynamic=function setTextureCubeDynamic(e,t){m.activeTexture(f.TEXTURE0+t),m.bindTexture(f.TEXTURE_CUBE_MAP,g.get(e).__webglTexture)},this.setupRenderTarget=function setupRenderTarget(e){var t=g.get(e),r=g.get(e.texture);e.addEventListener("dispose",onRenderTargetDispose),r.__webglTexture=f.createTexture(),x.textures++;var i=!0===e.isWebGLRenderTargetCube,n=isPowerOfTwo(e);if(i){t.__webglFramebuffer=[];for(var a=0;a<6;a++)t.__webglFramebuffer[a]=f.createFramebuffer()}else t.__webglFramebuffer=f.createFramebuffer();if(i){for(m.bindTexture(f.TEXTURE_CUBE_MAP,r.__webglTexture),setTextureParameters(f.TEXTURE_CUBE_MAP,e.texture,n),a=0;a<6;a++)setupFrameBufferTexture(t.__webglFramebuffer[a],e,f.COLOR_ATTACHMENT0,f.TEXTURE_CUBE_MAP_POSITIVE_X+a);textureNeedsGenerateMipmaps(e.texture,n)&&f.generateMipmap(f.TEXTURE_CUBE_MAP),m.bindTexture(f.TEXTURE_CUBE_MAP,null)}else m.bindTexture(f.TEXTURE_2D,r.__webglTexture),setTextureParameters(f.TEXTURE_2D,e.texture,n),setupFrameBufferTexture(t.__webglFramebuffer,e,f.COLOR_ATTACHMENT0,f.TEXTURE_2D),textureNeedsGenerateMipmaps(e.texture,n)&&f.generateMipmap(f.TEXTURE_2D),m.bindTexture(f.TEXTURE_2D,null);e.depthBuffer&&setupDepthRenderbuffer(e)},this.updateRenderTargetMipmap=function updateRenderTargetMipmap(e){var t=e.texture;if(textureNeedsGenerateMipmaps(t,isPowerOfTwo(e))){var r=e.isWebGLRenderTargetCube?f.TEXTURE_CUBE_MAP:f.TEXTURE_2D,i=g.get(t).__webglTexture;m.bindTexture(r,i),f.generateMipmap(r),m.bindTexture(r,null)}}}function WebGLProperties(){var i={};return{get:function get(e){var t=e.uuid,r=i[t];return void 0===r&&(r={},i[t]=r),r},remove:function remove(e){delete i[e.uuid]},clear:function clear(){i={}}}}function WebGLState(h,r,c){var t=new function ColorBuffer(){var t=!1,a=new Vector4,r=null,o=new Vector4(0,0,0,0);return{setMask:function(e){r===e||t||(h.colorMask(e,e,e,e),r=e)},setLocked:function(e){t=e},setClear:function(e,t,r,i,n){!0===n&&(e*=i,t*=i,r*=i),a.set(e,t,r,i),!1===o.equals(a)&&(h.clearColor(e,t,r,i),o.copy(a))},reset:function(){t=!1,r=null,o.set(-1,0,0,0)}}},i=new function DepthBuffer(){var t=!1,r=null,i=null,n=null;return{setTest:function(e){e?enable(h.DEPTH_TEST):disable(h.DEPTH_TEST)},setMask:function(e){r===e||t||(h.depthMask(e),r=e)},setFunc:function(e){if(i!==e){if(e)switch(e){case re:h.depthFunc(h.NEVER);break;case ie:h.depthFunc(h.ALWAYS);break;case ne:h.depthFunc(h.LESS);break;case ae:h.depthFunc(h.LEQUAL);break;case oe:h.depthFunc(h.EQUAL);break;case se:h.depthFunc(h.GEQUAL);break;case ce:h.depthFunc(h.GREATER);break;case le:h.depthFunc(h.NOTEQUAL);break;default:h.depthFunc(h.LEQUAL)}else h.depthFunc(h.LEQUAL);i=e}},setLocked:function(e){t=e},setClear:function(e){n!==e&&(h.clearDepth(e),n=e)},reset:function(){t=!1,n=i=r=null}}},n=new function StencilBuffer(){var t=!1,r=null,i=null,n=null,a=null,o=null,s=null,c=null,l=null;return{setTest:function(e){e?enable(h.STENCIL_TEST):disable(h.STENCIL_TEST)},setMask:function(e){r===e||t||(h.stencilMask(e),r=e)},setFunc:function(e,t,r){i===e&&n===t&&a===r||(h.stencilFunc(e,t,r),i=e,n=t,a=r)},setOp:function(e,t,r){o===e&&s===t&&c===r||(h.stencilOp(e,t,r),o=e,s=t,c=r)},setLocked:function(e){t=e},setClear:function(e){l!==e&&(h.clearStencil(e),l=e)},reset:function(){t=!1,l=c=s=o=a=n=i=r=null}}},e=h.getParameter(h.MAX_VERTEX_ATTRIBS),a=new Uint8Array(e),o=new Uint8Array(e),s=new Uint8Array(e),l={},u=null,d=null,p=null,f=null,m=null,g=null,v=null,y=null,x=null,b=!1,M=null,_=null,w=null,T=null,E=null,S=h.getParameter(h.MAX_COMBINED_TEXTURE_IMAGE_UNITS),A=parseFloat(/^WebGL\ ([0-9])/.exec(h.getParameter(h.VERSION))[1]),L=1<=parseFloat(A),C=null,P={},R=new Vector4,B=new Vector4;function createTexture(e,t,r){var i=new Uint8Array(4),n=h.createTexture();h.bindTexture(e,n),h.texParameteri(e,h.TEXTURE_MIN_FILTER,h.NEAREST),h.texParameteri(e,h.TEXTURE_MAG_FILTER,h.NEAREST);for(var a=0;a<r;a++)h.texImage2D(t+a,0,h.RGBA,1,1,0,h.RGBA,h.UNSIGNED_BYTE,i);return n}var I={};function enable(e){!0!==l[e]&&(h.enable(e),l[e]=!0)}function disable(e){!1!==l[e]&&(h.disable(e),l[e]=!1)}function setBlending(e,t,r,i,n,a,o,s){if(e!==F?enable(h.BLEND):disable(h.BLEND),e!==j){if(e!==p||s!==b)switch(e){case z:s?(h.blendEquationSeparate(h.FUNC_ADD,h.FUNC_ADD),h.blendFuncSeparate(h.ONE,h.ONE,h.ONE,h.ONE)):(h.blendEquation(h.FUNC_ADD),h.blendFunc(h.SRC_ALPHA,h.ONE));break;case H:s?(h.blendEquationSeparate(h.FUNC_ADD,h.FUNC_ADD),h.blendFuncSeparate(h.ZERO,h.ZERO,h.ONE_MINUS_SRC_COLOR,h.ONE_MINUS_SRC_ALPHA)):(h.blendEquation(h.FUNC_ADD),h.blendFunc(h.ZERO,h.ONE_MINUS_SRC_COLOR));break;case k:s?(h.blendEquationSeparate(h.FUNC_ADD,h.FUNC_ADD),h.blendFuncSeparate(h.ZERO,h.SRC_COLOR,h.ZERO,h.SRC_ALPHA)):(h.blendEquation(h.FUNC_ADD),h.blendFunc(h.ZERO,h.SRC_COLOR));break;default:s?(h.blendEquationSeparate(h.FUNC_ADD,h.FUNC_ADD),h.blendFuncSeparate(h.ONE,h.ONE_MINUS_SRC_ALPHA,h.ONE,h.ONE_MINUS_SRC_ALPHA)):(h.blendEquationSeparate(h.FUNC_ADD,h.FUNC_ADD),h.blendFuncSeparate(h.SRC_ALPHA,h.ONE_MINUS_SRC_ALPHA,h.ONE,h.ONE_MINUS_SRC_ALPHA))}x=y=v=g=m=f=null}else n=n||t,a=a||r,o=o||i,t===f&&n===v||(h.blendEquationSeparate(c.convert(t),c.convert(n)),f=t,v=n),r===m&&i===g&&a===y&&o===x||(h.blendFuncSeparate(c.convert(r),c.convert(i),c.convert(a),c.convert(o)),m=r,g=i,y=a,x=o);p=e,b=s}function setFlipSided(e){M!==e&&(e?h.frontFace(h.CW):h.frontFace(h.CCW),M=e)}function setCullFace(e){e!==D?(enable(h.CULL_FACE),e!==_&&(e===G?h.cullFace(h.BACK):e===U?h.cullFace(h.FRONT):h.cullFace(h.FRONT_AND_BACK))):disable(h.CULL_FACE),_=e}function setPolygonOffset(e,t,r){e?(enable(h.POLYGON_OFFSET_FILL),T===t&&E===r||(h.polygonOffset(t,r),T=t,E=r)):disable(h.POLYGON_OFFSET_FILL)}function activeTexture(e){void 0===e&&(e=h.TEXTURE0+S-1),C!==e&&(h.activeTexture(e),C=e)}return I[h.TEXTURE_2D]=createTexture(h.TEXTURE_2D,h.TEXTURE_2D,1),I[h.TEXTURE_CUBE_MAP]=createTexture(h.TEXTURE_CUBE_MAP,h.TEXTURE_CUBE_MAP_POSITIVE_X,6),t.setClear(0,0,0,1),i.setClear(1),n.setClear(0),enable(h.DEPTH_TEST),i.setFunc(ae),setFlipSided(!1),setCullFace(G),enable(h.CULL_FACE),enable(h.BLEND),setBlending(N),{buffers:{color:t,depth:i,stencil:n},initAttributes:function initAttributes(){for(var e=0,t=a.length;e<t;e++)a[e]=0},enableAttribute:function enableAttribute(e){a[e]=1,0===o[e]&&(h.enableVertexAttribArray(e),o[e]=1),0!==s[e]&&(r.get("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(e,0),s[e]=0)},enableAttributeAndDivisor:function enableAttributeAndDivisor(e,t){a[e]=1,0===o[e]&&(h.enableVertexAttribArray(e),o[e]=1),s[e]!==t&&(r.get("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(e,t),s[e]=t)},disableUnusedAttributes:function disableUnusedAttributes(){for(var e=0,t=o.length;e!==t;++e)o[e]!==a[e]&&(h.disableVertexAttribArray(e),o[e]=0)},enable:enable,disable:disable,getCompressedTextureFormats:function getCompressedTextureFormats(){if(null===u&&(u=[],r.get("WEBGL_compressed_texture_pvrtc")||r.get("WEBGL_compressed_texture_s3tc")||r.get("WEBGL_compressed_texture_etc1")))for(var e=h.getParameter(h.COMPRESSED_TEXTURE_FORMATS),t=0;t<e.length;t++)u.push(e[t]);return u},useProgram:function useProgram(e){return d!==e&&(h.useProgram(e),d=e,!0)},setBlending:setBlending,setMaterial:function setMaterial(e){e.side===q?disable(h.CULL_FACE):enable(h.CULL_FACE),setFlipSided(e.side===X),!0===e.transparent?setBlending(e.blending,e.blendEquation,e.blendSrc,e.blendDst,e.blendEquationAlpha,e.blendSrcAlpha,e.blendDstAlpha,e.premultipliedAlpha):setBlending(F),i.setFunc(e.depthFunc),i.setTest(e.depthTest),i.setMask(e.depthWrite),t.setMask(e.colorWrite),setPolygonOffset(e.polygonOffset,e.polygonOffsetFactor,e.polygonOffsetUnits)},setFlipSided:setFlipSided,setCullFace:setCullFace,setLineWidth:function setLineWidth(e){e!==w&&(L&&h.lineWidth(e),w=e)},setPolygonOffset:setPolygonOffset,setScissorTest:function setScissorTest(e){e?enable(h.SCISSOR_TEST):disable(h.SCISSOR_TEST)},activeTexture:activeTexture,bindTexture:function bindTexture(e,t){null===C&&activeTexture();var r=P[C];void 0===r&&(r={type:void 0,texture:void 0},P[C]=r),r.type===e&&r.texture===t||(h.bindTexture(e,t||I[e]),r.type=e,r.texture=t)},compressedTexImage2D:function compressedTexImage2D(){try{h.compressedTexImage2D.apply(h,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texImage2D:function texImage2D(){try{h.texImage2D.apply(h,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},scissor:function scissor(e){!1===R.equals(e)&&(h.scissor(e.x,e.y,e.z,e.w),R.copy(e))},viewport:function viewport(e){!1===B.equals(e)&&(h.viewport(e.x,e.y,e.z,e.w),B.copy(e))},reset:function reset(){for(var e=0;e<o.length;e++)1===o[e]&&(h.disableVertexAttribArray(e),o[e]=0);l={},P={},_=M=p=d=C=u=null,t.reset(),i.reset(),n.reset()}}}function WebGLCapabilities(t,r,e){var i;function getMaxPrecision(e){if("highp"===e){if(0<t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT).precision&&0<t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT).precision)return"highp";e="mediump"}return"mediump"===e&&0<t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT).precision&&0<t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT).precision?"mediump":"lowp"}var n=void 0!==e.precision?e.precision:"highp",a=getMaxPrecision(n);a!==n&&(console.warn("THREE.WebGLRenderer:",n,"not supported, using",a,"instead."),n=a);var o=!0===e.logarithmicDepthBuffer,s=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),c=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),l=t.getParameter(t.MAX_TEXTURE_SIZE),h=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),u=t.getParameter(t.MAX_VERTEX_ATTRIBS),d=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),p=t.getParameter(t.MAX_VARYING_VECTORS),f=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),m=0<c,g=!!r.get("OES_texture_float");return{getMaxAnisotropy:function getMaxAnisotropy(){if(void 0!==i)return i;var e=r.get("EXT_texture_filter_anisotropic");return i=null!==e?t.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0},getMaxPrecision:getMaxPrecision,precision:n,logarithmicDepthBuffer:o,maxTextures:s,maxVertexTextures:c,maxTextureSize:l,maxCubemapSize:h,maxAttributes:u,maxVertexUniforms:d,maxVaryings:p,maxFragmentUniforms:f,vertexTextures:m,floatFragmentTextures:g,floatVertexTextures:m&&g}}function PerspectiveCamera(e,t,r,i){Camera.call(this),this.type="PerspectiveCamera",this.fov=void 0!==e?e:50,this.zoom=1,this.near=void 0!==r?r:.1,this.far=void 0!==i?i:2e3,this.focus=10,this.aspect=void 0!==t?t:1,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}function ArrayCamera(e){PerspectiveCamera.call(this),this.cameras=e||[]}function WebVRManager(i){var n=this,o=null,s=null;"undefined"!=typeof window&&"VRFrameData"in window&&(s=new window.VRFrameData);var c=new Matrix4,l=new Matrix4,h=new Matrix4,u=new PerspectiveCamera;u.bounds=new Vector4(0,0,.5,1),u.layers.enable(1);var d=new PerspectiveCamera;d.bounds=new Vector4(.5,0,.5,1),d.layers.enable(2);var a,p,f=new ArrayCamera([u,d]);function onVRDisplayPresentChange(){if(null!==o&&o.isPresenting){var e=o.getEyeParameters("left"),t=e.renderWidth,r=e.renderHeight;p=i.getPixelRatio(),a=i.getSize(),i.setDrawingBufferSize(2*t,r,1)}else n.enabled&&i.setDrawingBufferSize(a.width,a.height,p)}f.layers.enable(1),f.layers.enable(2),"undefined"!=typeof window&&window.addEventListener("vrdisplaypresentchange",onVRDisplayPresentChange,!1),this.enabled=!1,this.standing=!1,this.getDevice=function(){return o},this.setDevice=function(e){void 0!==e&&(o=e)},this.getCamera=function(e){if(null===o)return e;o.depthNear=e.near,o.depthFar=e.far,o.getFrameData(s);var t=s.pose;null!==t.position?e.position.fromArray(t.position):e.position.set(0,0,0),null!==t.orientation&&e.quaternion.fromArray(t.orientation),e.updateMatrixWorld();var r=o.stageParameters;if(this.standing&&r&&(l.fromArray(r.sittingToStandingTransform),h.getInverse(l),e.matrixWorld.multiply(l),e.matrixWorldInverse.multiply(h)),!1===o.isPresenting)return e;u.near=e.near,d.near=e.near,u.far=e.far,d.far=e.far,f.matrixWorld.copy(e.matrixWorld),f.matrixWorldInverse.copy(e.matrixWorldInverse),u.matrixWorldInverse.fromArray(s.leftViewMatrix),d.matrixWorldInverse.fromArray(s.rightViewMatrix),this.standing&&r&&(u.matrixWorldInverse.multiply(h),d.matrixWorldInverse.multiply(h));var i=e.parent;null!==i&&(c.getInverse(i.matrixWorld),u.matrixWorldInverse.multiply(c),d.matrixWorldInverse.multiply(c)),u.matrixWorld.getInverse(u.matrixWorldInverse),d.matrixWorld.getInverse(d.matrixWorldInverse),u.projectionMatrix.fromArray(s.leftProjectionMatrix),d.projectionMatrix.fromArray(s.rightProjectionMatrix),f.projectionMatrix.copy(u.projectionMatrix);var n=o.getLayers();if(n.length){var a=n[0];null!==a.leftBounds&&4===a.leftBounds.length&&u.bounds.fromArray(a.leftBounds),null!==a.rightBounds&&4===a.rightBounds.length&&d.bounds.fromArray(a.rightBounds)}return f},this.getStandingMatrix=function(){return l},this.submitFrame=function(){o&&o.isPresenting&&o.submitFrame()},this.dispose=function(){"undefined"!=typeof window&&window.removeEventListener("vrdisplaypresentchange",onVRDisplayPresentChange)}}function WebGLExtensions(r){var i={};return{get:function(e){if(void 0!==i[e])return i[e];var t;switch(e){case"WEBGL_depth_texture":t=r.getExtension("WEBGL_depth_texture")||r.getExtension("MOZ_WEBGL_depth_texture")||r.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":t=r.getExtension("EXT_texture_filter_anisotropic")||r.getExtension("MOZ_EXT_texture_filter_anisotropic")||r.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":t=r.getExtension("WEBGL_compressed_texture_s3tc")||r.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||r.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":t=r.getExtension("WEBGL_compressed_texture_pvrtc")||r.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;case"WEBGL_compressed_texture_etc1":t=r.getExtension("WEBGL_compressed_texture_etc1");break;default:t=r.getExtension(e)}return null===t&&console.warn("THREE.WebGLRenderer: "+e+" extension not supported."),i[e]=t}}}function WebGLClipping(){var h=this,u=null,d=0,p=!1,f=!1,m=new Plane,g=new Matrix3,v={value:null,needsUpdate:!1};function resetGlobalState(){v.value!==u&&(v.value=u,v.needsUpdate=0<d),h.numPlanes=d,h.numIntersection=0}function projectPlanes(e,t,r,i){var n=null!==e?e.length:0,a=null;if(0!==n){if(a=v.value,!0!==i||null===a){var o=r+4*n,s=t.matrixWorldInverse;g.getNormalMatrix(s),(null===a||a.length<o)&&(a=new Float32Array(o));for(var c=0,l=r;c!==n;++c,l+=4)m.copy(e[c]).applyMatrix4(s,g),m.normal.toArray(a,l),a[l+3]=m.constant}v.value=a,v.needsUpdate=!0}return h.numPlanes=n,a}this.uniform=v,this.numPlanes=0,this.numIntersection=0,this.init=function(e,t,r){var i=0!==e.length||t||0!==d||p;return p=t,u=projectPlanes(e,r,0),d=e.length,i},this.beginShadows=function(){f=!0,projectPlanes(null)},this.endShadows=function(){f=!1,resetGlobalState()},this.setState=function(e,t,r,i,n,a){if(!p||null===e||0===e.length||f&&!r)f?projectPlanes(null):resetGlobalState();else{var o=f?0:d,s=4*o,c=n.clippingState||null;v.value=c,c=projectPlanes(e,i,s,a);for(var l=0;l!==s;++l)c[l]=u[l];n.clippingState=c,this.numIntersection=t?this.numPlanes:0,this.numPlanes+=o}}}function WebGLUtils(r,i){return{convert:function convert(e){var t;if(e===Se)return r.REPEAT;if(e===Ae)return r.CLAMP_TO_EDGE;if(e===Le)return r.MIRRORED_REPEAT;if(e===Ce)return r.NEAREST;if(e===Pe)return r.NEAREST_MIPMAP_NEAREST;if(e===Re)return r.NEAREST_MIPMAP_LINEAR;if(e===Be)return r.LINEAR;if(e===Ie)return r.LINEAR_MIPMAP_NEAREST;if(e===De)return r.LINEAR_MIPMAP_LINEAR;if(e===Ge)return r.UNSIGNED_BYTE;if(e===ke)return r.UNSIGNED_SHORT_4_4_4_4;if(e===je)return r.UNSIGNED_SHORT_5_5_5_1;if(e===We)return r.UNSIGNED_SHORT_5_6_5;if(e===Ue)return r.BYTE;if(e===Oe)return r.SHORT;if(e===Ve)return r.UNSIGNED_SHORT;if(e===Fe)return r.INT;if(e===Ne)return r.UNSIGNED_INT;if(e===ze)return r.FLOAT;if(e===He&&null!==(t=i.get("OES_texture_half_float")))return t.HALF_FLOAT_OES;if(e===qe)return r.ALPHA;if(e===Ye)return r.RGB;if(e===Ze)return r.RGBA;if(e===Qe)return r.LUMINANCE;if(e===Ke)return r.LUMINANCE_ALPHA;if(e===$e)return r.DEPTH_COMPONENT;if(e===et)return r.DEPTH_STENCIL;if(e===S)return r.FUNC_ADD;if(e===A)return r.FUNC_SUBTRACT;if(e===L)return r.FUNC_REVERSE_SUBTRACT;if(e===B)return r.ZERO;if(e===I)return r.ONE;if(e===W)return r.SRC_COLOR;if(e===Y)return r.ONE_MINUS_SRC_COLOR;if(e===Z)return r.SRC_ALPHA;if(e===Q)return r.ONE_MINUS_SRC_ALPHA;if(e===K)return r.DST_ALPHA;if(e===J)return r.ONE_MINUS_DST_ALPHA;if(e===$)return r.DST_COLOR;if(e===ee)return r.ONE_MINUS_DST_COLOR;if(e===te)return r.SRC_ALPHA_SATURATE;if((e===tt||e===rt||e===it||e===nt)&&null!==(t=i.get("WEBGL_compressed_texture_s3tc"))){if(e===tt)return t.COMPRESSED_RGB_S3TC_DXT1_EXT;if(e===rt)return t.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(e===it)return t.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(e===nt)return t.COMPRESSED_RGBA_S3TC_DXT5_EXT}if((e===at||e===ot||e===st||e===ct)&&null!==(t=i.get("WEBGL_compressed_texture_pvrtc"))){if(e===at)return t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(e===ot)return t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(e===st)return t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(e===ct)return t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(e===lt&&null!==(t=i.get("WEBGL_compressed_texture_etc1")))return t.COMPRESSED_RGB_ETC1_WEBGL;if((e===C||e===P)&&null!==(t=i.get("EXT_blend_minmax"))){if(e===C)return t.MIN_EXT;if(e===P)return t.MAX_EXT}return e===Xe&&null!==(t=i.get("WEBGL_depth_texture"))?t.UNSIGNED_INT_24_8_WEBGL:0}}}function WebGLRenderer(e){console.log("THREE.WebGLRenderer","88");var n=void 0!==(e=e||{}).canvas?e.canvas:document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),t=void 0!==e.context?e.context:null,r=void 0!==e.alpha&&e.alpha,i=void 0===e.depth||e.depth,a=void 0===e.stencil||e.stencil,o=void 0!==e.antialias&&e.antialias,s=void 0===e.premultipliedAlpha||e.premultipliedAlpha,c=void 0!==e.preserveDrawingBuffer&&e.preserveDrawingBuffer,d=[],f=[],p=null,m=[],g=[];this.domElement=n,this.context=null,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.gammaInput=!1,this.gammaOutput=!1,this.physicallyCorrectLights=!1,this.toneMapping=me,this.toneMappingExposure=1,this.toneMappingWhitePoint=1,this.maxMorphTargets=8,this.maxMorphNormals=4;var w,T,y,E,x,l,S,A,v,b,M,h,u,L,C,P,_,R,B,I=this,D=!1,G=null,U=null,O=-1,V="",F=null,N=null,z=new Vector4,H=new Vector4,k=null,j=0,W=n.width,X=n.height,q=1,Y=new Vector4(0,0,W,X),Z=new Vector4(0,0,W,X),Q=!1,K=new Frustum,J=new WebGLClipping,$=!1,ee=!1,te=new Matrix4,re=new Vector3,ie={geometries:0,textures:0},ne={frame:0,calls:0,vertices:0,faces:0,points:0};function getTargetPixelRatio(){return null===G?q:1}this.info={render:ne,memory:ie,programs:null};try{var ae={alpha:r,depth:i,stencil:a,antialias:o,premultipliedAlpha:s,preserveDrawingBuffer:c};if(null===(w=t||n.getContext("webgl",ae)||n.getContext("experimental-webgl",ae)))throw null!==n.getContext("webgl")?"Error creating WebGL context with your selected attributes.":"Error creating WebGL context.";void 0===w.getShaderPrecisionFormat&&(w.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}}),n.addEventListener("webglcontextlost",onContextLost,!1),n.addEventListener("webglcontextrestored",onContextRestore,!1)}catch(e){console.error("THREE.WebGLRenderer: "+e)}function initGLContext(){(T=new WebGLExtensions(w)).get("WEBGL_depth_texture"),T.get("OES_texture_float"),T.get("OES_texture_float_linear"),T.get("OES_texture_half_float"),T.get("OES_texture_half_float_linear"),T.get("OES_standard_derivatives"),T.get("OES_element_index_uint"),T.get("ANGLE_instanced_arrays"),B=new WebGLUtils(w,T),y=new WebGLCapabilities(w,T,e),(E=new WebGLState(w,T,B)).scissor(H.copy(Z).multiplyScalar(q)),E.viewport(z.copy(Y).multiplyScalar(q)),x=new WebGLProperties,l=new WebGLTextures(w,T,E,x,y,B,ie),S=new WebGLAttributes(w),A=new WebGLGeometries(w,S,ie),v=new WebGLObjects(A,ne),L=new WebGLMorphtargets(w),M=new WebGLPrograms(I,T,y),b=new WebGLLights,h=new WebGLRenderLists,u=new WebGLBackground(I,E,A,s),C=new WebGLBufferRenderer(w,T,ne),P=new WebGLIndexedBufferRenderer(w,T,ne),_=new WebGLFlareRenderer(I,w,E,l,y),R=new WebGLSpriteRenderer(I,w,E,l,y),I.info.programs=M.programs,I.context=w,I.capabilities=y,I.extensions=T,I.properties=x,I.renderLists=h,I.state=E}initGLContext();var oe=new WebVRManager(I);this.vr=oe;var se=new WebGLShadowMap(I,v,y.maxTextureSize);function onContextLost(e){e.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),D=!0}function onContextRestore(){console.log("THREE.WebGLRenderer: Context Restored."),D=!1,initGLContext()}function onMaterialDispose(e){var t=e.target;t.removeEventListener("dispose",onMaterialDispose),function deallocateMaterial(e){releaseMaterialProgramReference(e),x.remove(e)}(t)}function releaseMaterialProgramReference(e){var t=x.get(e).program;(e.program=void 0)!==t&&M.releaseProgram(t)}this.shadowMap=se,this.getContext=function(){return w},this.getContextAttributes=function(){return w.getContextAttributes()},this.forceContextLoss=function(){var e=T.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){var e=T.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return q},this.setPixelRatio=function(e){void 0!==e&&(q=e,this.setSize(W,X,!1))},this.getSize=function(){return{width:W,height:X}},this.setSize=function(e,t,r){var i=oe.getDevice();i&&i.isPresenting?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):(W=e,X=t,n.width=e*q,n.height=t*q,!1!==r&&(n.style.width=e+"px",n.style.height=t+"px"),this.setViewport(0,0,e,t))},this.getDrawingBufferSize=function(){return{width:W*q,height:X*q}},this.setDrawingBufferSize=function(e,t,r){W=e,X=t,q=r,n.width=e*r,n.height=t*r,this.setViewport(0,0,e,t)},this.setViewport=function(e,t,r,i){Y.set(e,X-t-i,r,i),E.viewport(z.copy(Y).multiplyScalar(q))},this.setScissor=function(e,t,r,i){Z.set(e,X-t-i,r,i),E.scissor(H.copy(Z).multiplyScalar(q))},this.setScissorTest=function(e){E.setScissorTest(Q=e)},this.getClearColor=function(){return u.getClearColor()},this.setClearColor=function(){u.setClearColor.apply(u,arguments)},this.getClearAlpha=function(){return u.getClearAlpha()},this.setClearAlpha=function(){u.setClearAlpha.apply(u,arguments)},this.clear=function(e,t,r){var i=0;(void 0===e||e)&&(i|=w.COLOR_BUFFER_BIT),(void 0===t||t)&&(i|=w.DEPTH_BUFFER_BIT),(void 0===r||r)&&(i|=w.STENCIL_BUFFER_BIT),w.clear(i)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.clearTarget=function(e,t,r,i){this.setRenderTarget(e),this.clear(t,r,i)},this.dispose=function(){n.removeEventListener("webglcontextlost",onContextLost,!1),n.removeEventListener("webglcontextrestored",onContextRestore,!1),h.dispose(),oe.dispose()},this.renderBufferImmediate=function(e,t,r){E.initAttributes();var i=x.get(e);e.hasPositions&&!i.position&&(i.position=w.createBuffer()),e.hasNormals&&!i.normal&&(i.normal=w.createBuffer()),e.hasUvs&&!i.uv&&(i.uv=w.createBuffer()),e.hasColors&&!i.color&&(i.color=w.createBuffer());var n=t.getAttributes();if(e.hasPositions&&(w.bindBuffer(w.ARRAY_BUFFER,i.position),w.bufferData(w.ARRAY_BUFFER,e.positionArray,w.DYNAMIC_DRAW),E.enableAttribute(n.position),w.vertexAttribPointer(n.position,3,w.FLOAT,!1,0,0)),e.hasNormals){if(w.bindBuffer(w.ARRAY_BUFFER,i.normal),!r.isMeshPhongMaterial&&!r.isMeshStandardMaterial&&!r.isMeshNormalMaterial&&!0===r.flatShading)for(var a=0,o=3*e.count;a<o;a+=9){var s=e.normalArray,c=(s[a+0]+s[a+3]+s[a+6])/3,l=(s[a+1]+s[a+4]+s[a+7])/3,h=(s[a+2]+s[a+5]+s[a+8])/3;s[a+0]=c,s[a+1]=l,s[a+2]=h,s[a+3]=c,s[a+4]=l,s[a+5]=h,s[a+6]=c,s[a+7]=l,s[a+8]=h}w.bufferData(w.ARRAY_BUFFER,e.normalArray,w.DYNAMIC_DRAW),E.enableAttribute(n.normal),w.vertexAttribPointer(n.normal,3,w.FLOAT,!1,0,0)}e.hasUvs&&r.map&&(w.bindBuffer(w.ARRAY_BUFFER,i.uv),w.bufferData(w.ARRAY_BUFFER,e.uvArray,w.DYNAMIC_DRAW),E.enableAttribute(n.uv),w.vertexAttribPointer(n.uv,2,w.FLOAT,!1,0,0)),e.hasColors&&r.vertexColors!==pe&&(w.bindBuffer(w.ARRAY_BUFFER,i.color),w.bufferData(w.ARRAY_BUFFER,e.colorArray,w.DYNAMIC_DRAW),E.enableAttribute(n.color),w.vertexAttribPointer(n.color,3,w.FLOAT,!1,0,0)),E.disableUnusedAttributes(),w.drawArrays(w.TRIANGLES,0,e.count),e.count=0},this.renderBufferDirect=function(e,t,r,i,n,a){E.setMaterial(i);var o=setProgram(e,t,i,n),s=r.id+"_"+o.id+"_"+(!0===i.wireframe),c=!1;s!==V&&(V=s,c=!0),n.morphTargetInfluences&&(L.update(n,r,i,o),c=!0);var l,h=r.index,u=r.attributes.position,d=1;!0===i.wireframe&&(h=A.getWireframeAttribute(r),d=2);var p=C;null!==h&&(l=S.get(h),(p=P).setIndex(l)),c&&(!function setupVertexAttributes(e,t,r,i){if(r&&r.isInstancedBufferGeometry&&null===T.get("ANGLE_instanced_arrays"))return void console.error("THREE.WebGLRenderer.setupVertexAttributes: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");void 0===i&&(i=0);E.initAttributes();var n=r.attributes,a=t.getAttributes(),o=e.defaultAttributeValues;for(var s in a){var c=a[s];if(0<=c){var l=n[s];if(void 0!==l){var h=l.normalized,u=l.itemSize,d=S.get(l);if(void 0===d)continue;var p=d.buffer,f=d.type,m=d.bytesPerElement;if(l.isInterleavedBufferAttribute){var g=l.data,v=g.stride,y=l.offset;g&&g.isInstancedInterleavedBuffer?(E.enableAttributeAndDivisor(c,g.meshPerAttribute),void 0===r.maxInstancedCount&&(r.maxInstancedCount=g.meshPerAttribute*g.count)):E.enableAttribute(c),w.bindBuffer(w.ARRAY_BUFFER,p),w.vertexAttribPointer(c,u,f,h,v*m,(i*v+y)*m)}else l.isInstancedBufferAttribute?(E.enableAttributeAndDivisor(c,l.meshPerAttribute),void 0===r.maxInstancedCount&&(r.maxInstancedCount=l.meshPerAttribute*l.count)):E.enableAttribute(c),w.bindBuffer(w.ARRAY_BUFFER,p),w.vertexAttribPointer(c,u,f,h,0,i*u*m)}else if(void 0!==o){var x=o[s];if(void 0!==x)switch(x.length){case 2:w.vertexAttrib2fv(c,x);break;case 3:w.vertexAttrib3fv(c,x);break;case 4:w.vertexAttrib4fv(c,x);break;default:w.vertexAttrib1fv(c,x)}}}}E.disableUnusedAttributes()}(i,o,r),null!==h&&w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,l.buffer));var f=0;null!==h?f=h.count:void 0!==u&&(f=u.count);var m=r.drawRange.start*d,g=r.drawRange.count*d,v=null!==a?a.start*d:0,y=null!==a?a.count*d:1/0,x=Math.max(m,v),b=Math.min(f,m+g,v+y)-1,M=Math.max(0,b-x+1);if(0!==M){if(n.isMesh)if(!0===i.wireframe)E.setLineWidth(i.wireframeLinewidth*getTargetPixelRatio()),p.setMode(w.LINES);else switch(n.drawMode){case mt:p.setMode(w.TRIANGLES);break;case 1:p.setMode(w.TRIANGLE_STRIP);break;case 2:p.setMode(w.TRIANGLE_FAN)}else if(n.isLine){var _=i.linewidth;void 0===_&&(_=1),E.setLineWidth(_*getTargetPixelRatio()),n.isLineSegments?p.setMode(w.LINES):n.isLineLoop?p.setMode(w.LINE_LOOP):p.setMode(w.LINE_STRIP)}else n.isPoints&&p.setMode(w.POINTS);r&&r.isInstancedBufferGeometry?0<r.maxInstancedCount&&p.renderInstances(r,x,M):p.render(x,M)}};var ce,le,he,ue=!(this.compile=function(r,e){d.length=0,f.length=0,r.traverse(function(e){e.isLight&&(d.push(e),e.castShadow&&f.push(e))}),b.setup(d,f,e),r.traverse(function(e){if(e.material)if(Array.isArray(e.material))for(var t=0;t<e.material.length;t++)initMaterial(e.material[t],r.fog,e);else initMaterial(e.material,r.fog,e)})}),de=null;function loop(e){null!==de&&de(e);var t=oe.getDevice();t&&t.isPresenting?t.requestAnimationFrame(loop):window.requestAnimationFrame(loop)}function renderObjects(e,t,r,i){for(var n=0,a=e.length;n<a;n++){var o=e[n],s=o.object,c=o.geometry,l=void 0===i?o.material:i,h=o.group;if(r.isArrayCamera)for(var u=(N=r).cameras,d=0,p=u.length;d<p;d++){var f=u[d];if(s.layers.test(f.layers)){var m=f.bounds,g=m.x*W,v=m.y*X,y=m.z*W,x=m.w*X;E.viewport(z.set(g,v,y,x).multiplyScalar(q)),renderObject(s,t,f,c,l,h)}}else N=null,renderObject(s,t,r,c,l,h)}}function renderObject(e,t,r,i,n,a){if(e.onBeforeRender(I,t,r,i,n,a),e.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),e.isImmediateRenderObject){E.setMaterial(n);var o=setProgram(r,t.fog,n,e);V="",function renderObjectImmediate(e,t,r){e.render(function(e){I.renderBufferImmediate(e,t,r)})}(e,o,n)}else I.renderBufferDirect(r,t.fog,i,n,e,a);e.onAfterRender(I,t,r,i,n,a)}function initMaterial(e,t,r){var i=x.get(e),n=M.getParameters(e,b.state,f,t,J.numPlanes,J.numIntersection,r),a=M.getProgramCode(e,n),o=i.program,s=!0;if(void 0===o)e.addEventListener("dispose",onMaterialDispose);else if(o.code!==a)releaseMaterialProgramReference(e);else{if(void 0!==n.shaderID)return;s=!1}if(s){if(n.shaderID){var c=Ht[n.shaderID];i.shader={name:e.type,uniforms:Nt.clone(c.uniforms),vertexShader:c.vertexShader,fragmentShader:c.fragmentShader}}else i.shader={name:e.type,uniforms:e.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader};e.onBeforeCompile(i.shader),o=M.acquireProgram(e,i.shader,n,a),i.program=o,e.program=o}var l=o.getAttributes();if(e.morphTargets)for(var h=e.numSupportedMorphTargets=0;h<I.maxMorphTargets;h++)0<=l["morphTarget"+h]&&e.numSupportedMorphTargets++;if(e.morphNormals)for(h=e.numSupportedMorphNormals=0;h<I.maxMorphNormals;h++)0<=l["morphNormal"+h]&&e.numSupportedMorphNormals++;var u=i.shader.uniforms;(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(i.numClippingPlanes=J.numPlanes,i.numIntersection=J.numIntersection,u.clippingPlanes=J.uniform),i.fog=t,i.lightsHash=b.state.hash,e.lights&&(u.ambientLightColor.value=b.state.ambient,u.directionalLights.value=b.state.directional,u.spotLights.value=b.state.spot,u.rectAreaLights.value=b.state.rectArea,u.pointLights.value=b.state.point,u.hemisphereLights.value=b.state.hemi,u.directionalShadowMap.value=b.state.directionalShadowMap,u.directionalShadowMatrix.value=b.state.directionalShadowMatrix,u.spotShadowMap.value=b.state.spotShadowMap,u.spotShadowMatrix.value=b.state.spotShadowMatrix,u.pointShadowMap.value=b.state.pointShadowMap,u.pointShadowMatrix.value=b.state.pointShadowMatrix);var d=i.program.getUniforms(),p=WebGLUniforms.seqWithValue(d.seq,u);i.uniformsList=p}function setProgram(e,t,r,i){j=0;var n=x.get(r);if($&&(ee||e!==F)){var a=e===F&&r.id===O;J.setState(r.clippingPlanes,r.clipIntersection,r.clipShadows,e,n,a)}!1===r.needsUpdate&&(void 0===n.program?r.needsUpdate=!0:r.fog&&n.fog!==t?r.needsUpdate=!0:r.lights&&n.lightsHash!==b.state.hash?r.needsUpdate=!0:void 0===n.numClippingPlanes||n.numClippingPlanes===J.numPlanes&&n.numIntersection===J.numIntersection||(r.needsUpdate=!0)),r.needsUpdate&&(initMaterial(r,t,i),r.needsUpdate=!1);var o=!1,s=!1,c=!1,l=n.program,h=l.getUniforms(),u=n.shader.uniforms;if(E.useProgram(l.program)&&(c=s=o=!0),r.id!==O&&(O=r.id,s=!0),o||e!==F){if(h.setValue(w,"projectionMatrix",e.projectionMatrix),y.logarithmicDepthBuffer&&h.setValue(w,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),F!==(N||e)&&(F=N||e,c=s=!0),r.isShaderMaterial||r.isMeshPhongMaterial||r.isMeshStandardMaterial||r.envMap){var d=h.map.cameraPosition;void 0!==d&&d.setValue(w,re.setFromMatrixPosition(e.matrixWorld))}(r.isMeshPhongMaterial||r.isMeshLambertMaterial||r.isMeshBasicMaterial||r.isMeshStandardMaterial||r.isShaderMaterial||r.skinning)&&h.setValue(w,"viewMatrix",e.matrixWorldInverse)}if(r.skinning){h.setOptional(w,i,"bindMatrix"),h.setOptional(w,i,"bindMatrixInverse");var p=i.skeleton;if(p){var f=p.bones;if(y.floatVertexTextures){if(void 0===p.boneTexture){var m=Math.sqrt(4*f.length);m=Et.ceilPowerOfTwo(m),m=Math.max(m,4);var g=new Float32Array(m*m*4);g.set(p.boneMatrices);var v=new DataTexture(g,m,m,Ze,ze);p.boneMatrices=g,p.boneTexture=v,p.boneTextureSize=m}h.setValue(w,"boneTexture",p.boneTexture),h.setValue(w,"boneTextureSize",p.boneTextureSize)}else h.setOptional(w,p,"boneMatrices")}}return s&&(h.setValue(w,"toneMappingExposure",I.toneMappingExposure),h.setValue(w,"toneMappingWhitePoint",I.toneMappingWhitePoint),r.lights&&function markUniformsLightsNeedsUpdate(e,t){e.ambientLightColor.needsUpdate=t,e.directionalLights.needsUpdate=t,e.pointLights.needsUpdate=t,e.spotLights.needsUpdate=t,e.rectAreaLights.needsUpdate=t,e.hemisphereLights.needsUpdate=t}(u,c),t&&r.fog&&function refreshUniformsFog(e,t){e.fogColor.value=t.color,t.isFog?(e.fogNear.value=t.near,e.fogFar.value=t.far):t.isFogExp2&&(e.fogDensity.value=t.density)}(u,t),r.isMeshBasicMaterial?refreshUniformsCommon(u,r):r.isMeshLambertMaterial?(refreshUniformsCommon(u,r),function refreshUniformsLambert(e,t){t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap)}(u,r)):r.isMeshPhongMaterial?(refreshUniformsCommon(u,r),r.isMeshToonMaterial?function refreshUniformsToon(e,t){refreshUniformsPhong(e,t),t.gradientMap&&(e.gradientMap.value=t.gradientMap)}(u,r):refreshUniformsPhong(u,r)):r.isMeshStandardMaterial?(refreshUniformsCommon(u,r),r.isMeshPhysicalMaterial?function refreshUniformsPhysical(e,t){e.clearCoat.value=t.clearCoat,e.clearCoatRoughness.value=t.clearCoatRoughness,refreshUniformsStandard(e,t)}(u,r):refreshUniformsStandard(u,r)):r.isMeshDepthMaterial?(refreshUniformsCommon(u,r),function refreshUniformsDepth(e,t){t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(u,r)):r.isMeshDistanceMaterial?(refreshUniformsCommon(u,r),function refreshUniformsDistance(e,t){t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias);e.referencePosition.value.copy(t.referencePosition),e.nearDistance.value=t.nearDistance,e.farDistance.value=t.farDistance}(u,r)):r.isMeshNormalMaterial?(refreshUniformsCommon(u,r),function refreshUniformsNormal(e,t){t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale);t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale));t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(u,r)):r.isLineBasicMaterial?(!function refreshUniformsLine(e,t){e.diffuse.value=t.color,e.opacity.value=t.opacity}(u,r),r.isLineDashedMaterial&&function refreshUniformsDash(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}(u,r)):r.isPointsMaterial?function refreshUniformsPoints(e,t){if(e.diffuse.value=t.color,e.opacity.value=t.opacity,e.size.value=t.size*q,e.scale.value=.5*X,e.map.value=t.map,null!==t.map){if(!0===t.map.matrixAutoUpdate){var r=t.map.offset,i=t.map.repeat,n=t.map.rotation,a=t.map.center;t.map.matrix.setUvTransform(r.x,r.y,i.x,i.y,n,a.x,a.y)}e.uvTransform.value.copy(t.map.matrix)}}(u,r):r.isShadowMaterial&&(u.color.value=r.color,u.opacity.value=r.opacity),void 0!==u.ltcMat&&(u.ltcMat.value=Ft.LTC_MAT_TEXTURE),void 0!==u.ltcMag&&(u.ltcMag.value=Ft.LTC_MAG_TEXTURE),WebGLUniforms.upload(w,n.uniformsList,u,I)),h.setValue(w,"modelViewMatrix",i.modelViewMatrix),h.setValue(w,"normalMatrix",i.normalMatrix),h.setValue(w,"modelMatrix",i.matrixWorld),l}function refreshUniformsCommon(e,t){var r;if(e.opacity.value=t.opacity,t.color&&(e.diffuse.value=t.color),t.emissive&&e.emissive.value.copy(t.emissive).multiplyScalar(t.emissiveIntensity),t.map&&(e.map.value=t.map),t.alphaMap&&(e.alphaMap.value=t.alphaMap),t.specularMap&&(e.specularMap.value=t.specularMap),t.envMap&&(e.envMap.value=t.envMap,e.flipEnvMap.value=t.envMap&&t.envMap.isCubeTexture?-1:1,e.reflectivity.value=t.reflectivity,e.refractionRatio.value=t.refractionRatio),t.lightMap&&(e.lightMap.value=t.lightMap,e.lightMapIntensity.value=t.lightMapIntensity),t.aoMap&&(e.aoMap.value=t.aoMap,e.aoMapIntensity.value=t.aoMapIntensity),t.map?r=t.map:t.specularMap?r=t.specularMap:t.displacementMap?r=t.displacementMap:t.normalMap?r=t.normalMap:t.bumpMap?r=t.bumpMap:t.roughnessMap?r=t.roughnessMap:t.metalnessMap?r=t.metalnessMap:t.alphaMap?r=t.alphaMap:t.emissiveMap&&(r=t.emissiveMap),void 0!==r){if(r.isWebGLRenderTarget&&(r=r.texture),!0===r.matrixAutoUpdate){var i=r.offset,n=r.repeat,a=r.rotation,o=r.center;r.matrix.setUvTransform(i.x,i.y,n.x,n.y,a,o.x,o.y)}e.uvTransform.value.copy(r.matrix)}}function refreshUniformsPhong(e,t){e.specular.value=t.specular,e.shininess.value=Math.max(t.shininess,1e-4),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}function refreshUniformsStandard(e,t){e.roughness.value=t.roughness,e.metalness.value=t.metalness,t.roughnessMap&&(e.roughnessMap.value=t.roughnessMap),t.metalnessMap&&(e.metalnessMap.value=t.metalnessMap),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias),t.envMap&&(e.envMapIntensity.value=t.envMapIntensity)}this.animate=function(e){de=e,function start(){if(!ue){var e=oe.getDevice();e&&e.isPresenting?e.requestAnimationFrame(loop):window.requestAnimationFrame(loop),ue=!0}}()},this.render=function(e,t,r,i){if(t&&t.isCamera){if(!D){V="",O=-1,!(F=null)===e.autoUpdate&&e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),oe.enabled&&(t=oe.getCamera(t)),te.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),K.setFromMatrix(te),d.length=0,f.length=0,m.length=0,g.length=0,ee=this.localClippingEnabled,$=J.init(this.clippingPlanes,ee,t),(p=h.get(e,t)).init(),function projectObject(e,t,r){if(!1===e.visible)return;var i=e.layers.test(t.layers);if(i)if(e.isLight)d.push(e),e.castShadow&&f.push(e);else if(e.isSprite)e.frustumCulled&&!K.intersectsSprite(e)||m.push(e);else if(e.isLensFlare)g.push(e);else if(e.isImmediateRenderObject)r&&re.setFromMatrixPosition(e.matrixWorld).applyMatrix4(te),p.push(e,null,e.material,re.z,null);else if((e.isMesh||e.isLine||e.isPoints)&&(e.isSkinnedMesh&&e.skeleton.update(),!e.frustumCulled||K.intersectsObject(e))){r&&re.setFromMatrixPosition(e.matrixWorld).applyMatrix4(te);var n=v.update(e),a=e.material;if(Array.isArray(a))for(var o=n.groups,s=0,c=o.length;s<c;s++){var l=o[s],h=a[l.materialIndex];h&&h.visible&&p.push(e,n,h,re.z,l)}else a.visible&&p.push(e,n,a,re.z,null)}var u=e.children;for(var s=0,c=u.length;s<c;s++)projectObject(u[s],t,r)}(e,t,I.sortObjects),!0===I.sortObjects&&p.sort(),$&&J.beginShadows(),se.render(f,e,t),b.setup(d,f,t),$&&J.endShadows(),ne.frame++,ne.calls=0,ne.vertices=0,ne.faces=0,void(ne.points=0)===r&&(r=null),this.setRenderTarget(r),u.render(p,e,t,i);var n=p.opaque,a=p.transparent;if(e.overrideMaterial){var o=e.overrideMaterial;n.length&&renderObjects(n,e,t,o),a.length&&renderObjects(a,e,t,o)}else n.length&&renderObjects(n,e,t),a.length&&renderObjects(a,e,t);R.render(m,e,t),_.render(g,e,t,z),r&&l.updateRenderTargetMipmap(r),E.buffers.depth.setTest(!0),E.buffers.depth.setMask(!0),E.buffers.color.setMask(!0),E.setPolygonOffset(!1),oe.enabled&&oe.submitFrame()}}else console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.")},this.setFaceCulling=function(e,t){E.setCullFace(e),E.setFlipSided(0===t)},this.allocTextureUnit=function allocTextureUnit(){var e=j;return e>=y.maxTextures&&console.warn("THREE.WebGLRenderer: Trying to use "+e+" texture units while this GPU supports only "+y.maxTextures),j+=1,e},this.setTexture2D=(ce=!1,function setTexture2D(e,t){e&&e.isWebGLRenderTarget&&(ce||(console.warn("THREE.WebGLRenderer.setTexture2D: don't use render targets as textures. Use their .texture property instead."),ce=!0),e=e.texture),l.setTexture2D(e,t)}),this.setTexture=(le=!1,function setTexture(e,t){le||(console.warn("THREE.WebGLRenderer: .setTexture is deprecated, use setTexture2D instead."),le=!0),l.setTexture2D(e,t)}),this.setTextureCube=(he=!1,function setTextureCube(e,t){e&&e.isWebGLRenderTargetCube&&(he||(console.warn("THREE.WebGLRenderer.setTextureCube: don't use cube render targets as textures. Use their .texture property instead."),he=!0),e=e.texture),e&&e.isCubeTexture||Array.isArray(e.image)&&6===e.image.length?l.setTextureCube(e,t):l.setTextureCubeDynamic(e,t)}),this.getRenderTarget=function(){return G},this.setRenderTarget=function(e){(G=e)&&void 0===x.get(e).__webglFramebuffer&&l.setupRenderTarget(e);var t=null,r=!1;if(e){var i=x.get(e).__webglFramebuffer;e.isWebGLRenderTargetCube?(t=i[e.activeCubeFace],r=!0):t=i,z.copy(e.viewport),H.copy(e.scissor),k=e.scissorTest}else z.copy(Y).multiplyScalar(q),H.copy(Z).multiplyScalar(q),k=Q;if(U!==t&&(w.bindFramebuffer(w.FRAMEBUFFER,t),U=t),E.viewport(z),E.scissor(H),E.setScissorTest(k),r){var n=x.get(e.texture);w.framebufferTexture2D(w.FRAMEBUFFER,w.COLOR_ATTACHMENT0,w.TEXTURE_CUBE_MAP_POSITIVE_X+e.activeCubeFace,n.__webglTexture,e.activeMipMapLevel)}},this.readRenderTargetPixels=function(e,t,r,i,n,a){if(e&&e.isWebGLRenderTarget){var o=x.get(e).__webglFramebuffer;if(o){var s=!1;o!==U&&(w.bindFramebuffer(w.FRAMEBUFFER,o),s=!0);try{var c=e.texture,l=c.format,h=c.type;if(l!==Ze&&B.convert(l)!==w.getParameter(w.IMPLEMENTATION_COLOR_READ_FORMAT))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");if(!(h===Ge||B.convert(h)===w.getParameter(w.IMPLEMENTATION_COLOR_READ_TYPE)||h===ze&&(T.get("OES_texture_float")||T.get("WEBGL_color_buffer_float"))||h===He&&T.get("EXT_color_buffer_half_float")))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");w.checkFramebufferStatus(w.FRAMEBUFFER)===w.FRAMEBUFFER_COMPLETE?0<=t&&t<=e.width-i&&0<=r&&r<=e.height-n&&w.readPixels(t,r,i,n,B.convert(l),B.convert(h),a):console.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete.")}finally{s&&w.bindFramebuffer(w.FRAMEBUFFER,U)}}}else console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.")}}function FogExp2(e,t){this.name="",this.color=new Color(e),this.density=void 0!==t?t:25e-5}function Fog(e,t,r){this.name="",this.color=new Color(e),this.near=void 0!==t?t:1,this.far=void 0!==r?r:1e3}function Scene(){Object3D.call(this),this.type="Scene",this.background=null,this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0}function LensFlare(e,t,r,i,n){Object3D.call(this),this.lensFlares=[],this.positionScreen=new Vector3,(this.customUpdateCallback=void 0)!==e&&this.add(e,t,r,i,n)}function SpriteMaterial(e){Material.call(this),this.type="SpriteMaterial",this.color=new Color(16777215),this.map=null,this.rotation=0,this.fog=!1,this.lights=!1,this.setValues(e)}function Sprite(e){Object3D.call(this),this.type="Sprite",this.material=void 0!==e?e:new SpriteMaterial}function LOD(){Object3D.call(this),this.type="LOD",Object.defineProperties(this,{levels:{enumerable:!0,value:[]}})}function Skeleton(e,t){if(e=e||[],this.bones=e.slice(0),this.boneMatrices=new Float32Array(16*this.bones.length),void 0===t)this.calculateInverses();else if(this.bones.length===t.length)this.boneInverses=t.slice(0);else{console.warn("THREE.Skeleton boneInverses is the wrong length."),this.boneInverses=[];for(var r=0,i=this.bones.length;r<i;r++)this.boneInverses.push(new Matrix4)}}function Bone(){Object3D.call(this),this.type="Bone"}function SkinnedMesh(e,t){Mesh.call(this,e,t),this.type="SkinnedMesh",this.bindMode="attached",this.bindMatrix=new Matrix4,this.bindMatrixInverse=new Matrix4;var r=new Skeleton(this.initBones());this.bind(r,this.matrixWorld),this.normalizeSkinWeights()}function LineBasicMaterial(e){Material.call(this),this.type="LineBasicMaterial",this.color=new Color(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.lights=!1,this.setValues(e)}function Line(e,t,r){if(1===r)return console.warn("THREE.Line: parameter THREE.LinePieces no longer supported. Created THREE.LineSegments instead."),new LineSegments(e,t);Object3D.call(this),this.type="Line",this.geometry=void 0!==e?e:new BufferGeometry,this.material=void 0!==t?t:new LineBasicMaterial({color:16777215*Math.random()})}function LineSegments(e,t){Line.call(this,e,t),this.type="LineSegments"}function LineLoop(e,t){Line.call(this,e,t),this.type="LineLoop"}function PointsMaterial(e){Material.call(this),this.type="PointsMaterial",this.color=new Color(16777215),this.map=null,this.size=1,this.sizeAttenuation=!0,this.lights=!1,this.setValues(e)}function Points(e,t){Object3D.call(this),this.type="Points",this.geometry=void 0!==e?e:new BufferGeometry,this.material=void 0!==t?t:new PointsMaterial({color:16777215*Math.random()})}function Group(){Object3D.call(this),this.type="Group"}function VideoTexture(e,t,r,i,n,a,o,s,c){Texture.call(this,e,t,r,i,n,a,o,s,c),this.generateMipmaps=!1;var l=this;requestAnimationFrame(function update(){var e=l.image;e.readyState>=e.HAVE_CURRENT_DATA&&(l.needsUpdate=!0),requestAnimationFrame(update)})}function CompressedTexture(e,t,r,i,n,a,o,s,c,l,h,u){Texture.call(this,null,a,o,s,c,l,i,n,h,u),this.image={width:t,height:r},this.mipmaps=e,this.flipY=!1,this.generateMipmaps=!1}function DepthTexture(e,t,r,i,n,a,o,s,c,l){if((l=void 0!==l?l:$e)!==$e&&l!==et)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");void 0===r&&l===$e&&(r=Ve),void 0===r&&l===et&&(r=Xe),Texture.call(this,null,i,n,a,o,s,l,r,c),this.image={width:e,height:t},this.magFilter=void 0!==o?o:Ce,this.minFilter=void 0!==s?s:Ce,this.flipY=!1,this.generateMipmaps=!1}function WireframeGeometry(e){BufferGeometry.call(this),this.type="WireframeGeometry";var t,r,i,n,a,o,s,c,l,h,u=[],d=[0,0],p={},f=["a","b","c"];if(e&&e.isGeometry){var m=e.faces;for(t=0,i=m.length;t<i;t++){var g=m[t];for(r=0;r<3;r++)s=g[f[r]],c=g[f[(r+1)%3]],d[0]=Math.min(s,c),d[1]=Math.max(s,c),void 0===p[l=d[0]+","+d[1]]&&(p[l]={index1:d[0],index2:d[1]})}for(l in p)o=p[l],h=e.vertices[o.index1],u.push(h.x,h.y,h.z),h=e.vertices[o.index2],u.push(h.x,h.y,h.z)}else if(e&&e.isBufferGeometry){var v,y,x,b,M,_;if(h=new Vector3,null!==e.index){for(v=e.attributes.position,y=e.index,0===(x=e.groups).length&&(x=[{start:0,count:y.count,materialIndex:0}]),n=0,a=x.length;n<a;++n)for(i=(t=(b=x[n]).start)+b.count;t<i;t+=3)for(r=0;r<3;r++)s=y.getX(t+r),c=y.getX(t+(r+1)%3),d[0]=Math.min(s,c),d[1]=Math.max(s,c),void 0===p[l=d[0]+","+d[1]]&&(p[l]={index1:d[0],index2:d[1]});for(l in p)o=p[l],h.fromBufferAttribute(v,o.index1),u.push(h.x,h.y,h.z),h.fromBufferAttribute(v,o.index2),u.push(h.x,h.y,h.z)}else for(t=0,i=(v=e.attributes.position).count/3;t<i;t++)for(r=0;r<3;r++)M=3*t+r,h.fromBufferAttribute(v,M),u.push(h.x,h.y,h.z),_=3*t+(r+1)%3,h.fromBufferAttribute(v,_),u.push(h.x,h.y,h.z)}this.addAttribute("position",new Float32BufferAttribute(u,3))}function ParametricGeometry(e,t,r){Geometry.call(this),this.type="ParametricGeometry",this.parameters={func:e,slices:t,stacks:r},this.fromBufferGeometry(new ParametricBufferGeometry(e,t,r)),this.mergeVertices()}function ParametricBufferGeometry(e,t,r){BufferGeometry.call(this),this.type="ParametricBufferGeometry",this.parameters={func:e,slices:t,stacks:r};var i,n,a=[],o=[],s=[],c=[],l=new Vector3,h=new Vector3,u=new Vector3,d=new Vector3,p=new Vector3,f=t+1;for(i=0;i<=r;i++){var m=i/r;for(n=0;n<=t;n++){var g=n/t;h=e(g,m,h),o.push(h.x,h.y,h.z),0<=g-1e-5?(u=e(g-1e-5,m,u),d.subVectors(h,u)):(u=e(g+1e-5,m,u),d.subVectors(u,h)),0<=m-1e-5?(u=e(g,m-1e-5,u),p.subVectors(h,u)):(u=e(g,m+1e-5,u),p.subVectors(u,h)),l.crossVectors(d,p).normalize(),s.push(l.x,l.y,l.z),c.push(g,m)}}for(i=0;i<r;i++)for(n=0;n<t;n++){var v=i*f+n,y=i*f+n+1,x=(i+1)*f+n+1,b=(i+1)*f+n;a.push(v,y,b),a.push(y,x,b)}this.setIndex(a),this.addAttribute("position",new Float32BufferAttribute(o,3)),this.addAttribute("normal",new Float32BufferAttribute(s,3)),this.addAttribute("uv",new Float32BufferAttribute(c,2))}function PolyhedronGeometry(e,t,r,i){Geometry.call(this),this.type="PolyhedronGeometry",this.parameters={vertices:e,indices:t,radius:r,detail:i},this.fromBufferGeometry(new PolyhedronBufferGeometry(e,t,r,i)),this.mergeVertices()}function PolyhedronBufferGeometry(i,a,e,t){BufferGeometry.call(this),this.type="PolyhedronBufferGeometry",this.parameters={vertices:i,indices:a,radius:e,detail:t},e=e||1;var h=[],u=[];function subdivideFace(e,t,r,i){var n,a,o=Math.pow(2,i),s=[];for(n=0;n<=o;n++){s[n]=[];var c=e.clone().lerp(r,n/o),l=t.clone().lerp(r,n/o),h=o-n;for(a=0;a<=h;a++)s[n][a]=0===a&&n===o?c:c.clone().lerp(l,a/h)}for(n=0;n<o;n++)for(a=0;a<2*(o-n)-1;a++){var u=Math.floor(a/2);a%2==0?(pushVertex(s[n][u+1]),pushVertex(s[n+1][u]),pushVertex(s[n][u])):(pushVertex(s[n][u+1]),pushVertex(s[n+1][u+1]),pushVertex(s[n+1][u]))}}function pushVertex(e){h.push(e.x,e.y,e.z)}function getVertexByIndex(e,t){var r=3*e;t.x=i[r+0],t.y=i[r+1],t.z=i[r+2]}function correctUV(e,t,r,i){i<0&&1===e.x&&(u[t]=e.x-1),0===r.x&&0===r.z&&(u[t]=i/2/Math.PI+.5)}function azimuth(e){return Math.atan2(e.z,-e.x)}!function subdivide(e){for(var t=new Vector3,r=new Vector3,i=new Vector3,n=0;n<a.length;n+=3)getVertexByIndex(a[n+0],t),getVertexByIndex(a[n+1],r),getVertexByIndex(a[n+2],i),subdivideFace(t,r,i,e)}(t=t||0),function appplyRadius(e){for(var t=new Vector3,r=0;r<h.length;r+=3)t.x=h[r+0],t.y=h[r+1],t.z=h[r+2],t.normalize().multiplyScalar(e),h[r+0]=t.x,h[r+1]=t.y,h[r+2]=t.z}(e),function generateUVs(){for(var e=new Vector3,t=0;t<h.length;t+=3){e.x=h[t+0],e.y=h[t+1],e.z=h[t+2];var r=azimuth(e)/2/Math.PI+.5,i=(n=e,Math.atan2(-n.y,Math.sqrt(n.x*n.x+n.z*n.z))/Math.PI+.5);u.push(r,1-i)}var n;(function correctUVs(){for(var e=new Vector3,t=new Vector3,r=new Vector3,i=new Vector3,n=new Vector2,a=new Vector2,o=new Vector2,s=0,c=0;s<h.length;s+=9,c+=6){e.set(h[s+0],h[s+1],h[s+2]),t.set(h[s+3],h[s+4],h[s+5]),r.set(h[s+6],h[s+7],h[s+8]),n.set(u[c+0],u[c+1]),a.set(u[c+2],u[c+3]),o.set(u[c+4],u[c+5]),i.copy(e).add(t).add(r).divideScalar(3);var l=azimuth(i);correctUV(n,c+0,e,l),correctUV(a,c+2,t,l),correctUV(o,c+4,r,l)}})(),function correctSeam(){for(var e=0;e<u.length;e+=6){var t=u[e+0],r=u[e+2],i=u[e+4],n=Math.max(t,r,i),a=Math.min(t,r,i);.9<n&&a<.1&&(t<.2&&(u[e+0]+=1),r<.2&&(u[e+2]+=1),i<.2&&(u[e+4]+=1))}}()}(),this.addAttribute("position",new Float32BufferAttribute(h,3)),this.addAttribute("normal",new Float32BufferAttribute(h.slice(),3)),this.addAttribute("uv",new Float32BufferAttribute(u,2)),0===t?this.computeVertexNormals():this.normalizeNormals()}function TetrahedronGeometry(e,t){Geometry.call(this),this.type="TetrahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new TetrahedronBufferGeometry(e,t)),this.mergeVertices()}function TetrahedronBufferGeometry(e,t){PolyhedronBufferGeometry.call(this,[1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],[2,1,0,0,3,2,1,3,0,2,3,1],e,t),this.type="TetrahedronBufferGeometry",this.parameters={radius:e,detail:t}}function OctahedronGeometry(e,t){Geometry.call(this),this.type="OctahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new OctahedronBufferGeometry(e,t)),this.mergeVertices()}function OctahedronBufferGeometry(e,t){PolyhedronBufferGeometry.call(this,[1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2],e,t),this.type="OctahedronBufferGeometry",this.parameters={radius:e,detail:t}}function IcosahedronGeometry(e,t){Geometry.call(this),this.type="IcosahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new IcosahedronBufferGeometry(e,t)),this.mergeVertices()}function IcosahedronBufferGeometry(e,t){var r=(1+Math.sqrt(5))/2;PolyhedronBufferGeometry.call(this,[-1,r,0,1,r,0,-1,-r,0,1,-r,0,0,-1,r,0,1,r,0,-1,-r,0,1,-r,r,0,-1,r,0,1,-r,0,-1,-r,0,1],[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],e,t),this.type="IcosahedronBufferGeometry",this.parameters={radius:e,detail:t}}function DodecahedronGeometry(e,t){Geometry.call(this),this.type="DodecahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new DodecahedronBufferGeometry(e,t)),this.mergeVertices()}function DodecahedronBufferGeometry(e,t){var r=(1+Math.sqrt(5))/2,i=1/r;PolyhedronBufferGeometry.call(this,[-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-i,-r,0,-i,r,0,i,-r,0,i,r,-i,-r,0,-i,r,0,i,-r,0,i,r,0,-r,0,-i,r,0,-i,-r,0,i,r,0,i],[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9],e,t),this.type="DodecahedronBufferGeometry",this.parameters={radius:e,detail:t}}function TubeGeometry(e,t,r,i,n,a){Geometry.call(this),this.type="TubeGeometry",this.parameters={path:e,tubularSegments:t,radius:r,radialSegments:i,closed:n},void 0!==a&&console.warn("THREE.TubeGeometry: taper has been removed.");var o=new TubeBufferGeometry(e,t,r,i,n);this.tangents=o.tangents,this.normals=o.normals,this.binormals=o.binormals,this.fromBufferGeometry(o),this.mergeVertices()}function TubeBufferGeometry(o,s,c,l,e){BufferGeometry.call(this),this.type="TubeBufferGeometry",this.parameters={path:o,tubularSegments:s,radius:c,radialSegments:l,closed:e},s=s||64,c=c||1,l=l||8,e=e||!1;var h=o.computeFrenetFrames(s,e);this.tangents=h.tangents,this.normals=h.normals,this.binormals=h.binormals;var n,u,d=new Vector3,p=new Vector3,t=new Vector2,f=new Vector3,m=[],g=[],r=[],a=[];function generateSegment(e){f=o.getPointAt(e/s,f);var t=h.normals[e],r=h.binormals[e];for(u=0;u<=l;u++){var i=u/l*Math.PI*2,n=Math.sin(i),a=-Math.cos(i);p.x=a*t.x+n*r.x,p.y=a*t.y+n*r.y,p.z=a*t.z+n*r.z,p.normalize(),g.push(p.x,p.y,p.z),d.x=f.x+c*p.x,d.y=f.y+c*p.y,d.z=f.z+c*p.z,m.push(d.x,d.y,d.z)}}!function generateBufferData(){for(n=0;n<s;n++)generateSegment(n);generateSegment(!1===e?s:0),function generateUVs(){for(n=0;n<=s;n++)for(u=0;u<=l;u++)t.x=n/s,t.y=u/l,r.push(t.x,t.y)}(),function generateIndices(){for(u=1;u<=s;u++)for(n=1;n<=l;n++){var e=(l+1)*(u-1)+(n-1),t=(l+1)*u+(n-1),r=(l+1)*u+n,i=(l+1)*(u-1)+n;a.push(e,t,i),a.push(t,r,i)}}()}(),this.setIndex(a),this.addAttribute("position",new Float32BufferAttribute(m,3)),this.addAttribute("normal",new Float32BufferAttribute(g,3)),this.addAttribute("uv",new Float32BufferAttribute(r,2))}function TorusKnotGeometry(e,t,r,i,n,a,o){Geometry.call(this),this.type="TorusKnotGeometry",this.parameters={radius:e,tube:t,tubularSegments:r,radialSegments:i,p:n,q:a},void 0!==o&&console.warn("THREE.TorusKnotGeometry: heightScale has been deprecated. Use .scale( x, y, z ) instead."),this.fromBufferGeometry(new TorusKnotBufferGeometry(e,t,r,i,n,a)),this.mergeVertices()}function TorusKnotBufferGeometry(e,t,r,i,n,a){BufferGeometry.call(this),this.type="TorusKnotBufferGeometry",this.parameters={radius:e,tube:t,tubularSegments:r,radialSegments:i,p:n,q:a},e=e||1,t=t||.4,r=Math.floor(r)||64,i=Math.floor(i)||8,n=n||2,a=a||3;var o,s,c=[],l=[],h=[],u=[],d=new Vector3,p=new Vector3,f=new Vector3,m=new Vector3,g=new Vector3,v=new Vector3,y=new Vector3;for(o=0;o<=r;++o){var x=o/r*n*Math.PI*2;for(calculatePositionOnCurve(x,n,a,e,f),calculatePositionOnCurve(x+.01,n,a,e,m),v.subVectors(m,f),y.addVectors(m,f),g.crossVectors(v,y),y.crossVectors(g,v),g.normalize(),y.normalize(),s=0;s<=i;++s){var b=s/i*Math.PI*2,M=-t*Math.cos(b),_=t*Math.sin(b);d.x=f.x+(M*y.x+_*g.x),d.y=f.y+(M*y.y+_*g.y),d.z=f.z+(M*y.z+_*g.z),l.push(d.x,d.y,d.z),p.subVectors(d,f).normalize(),h.push(p.x,p.y,p.z),u.push(o/r),u.push(s/i)}}for(s=1;s<=r;s++)for(o=1;o<=i;o++){var w=(i+1)*(s-1)+(o-1),T=(i+1)*s+(o-1),E=(i+1)*s+o,S=(i+1)*(s-1)+o;c.push(w,T,S),c.push(T,E,S)}function calculatePositionOnCurve(e,t,r,i,n){var a=Math.cos(e),o=Math.sin(e),s=r/t*e,c=Math.cos(s);n.x=i*(2+c)*.5*a,n.y=i*(2+c)*o*.5,n.z=i*Math.sin(s)*.5}this.setIndex(c),this.addAttribute("position",new Float32BufferAttribute(l,3)),this.addAttribute("normal",new Float32BufferAttribute(h,3)),this.addAttribute("uv",new Float32BufferAttribute(u,2))}function TorusGeometry(e,t,r,i,n){Geometry.call(this),this.type="TorusGeometry",this.parameters={radius:e,tube:t,radialSegments:r,tubularSegments:i,arc:n},this.fromBufferGeometry(new TorusBufferGeometry(e,t,r,i,n)),this.mergeVertices()}function TorusBufferGeometry(e,t,r,i,n){BufferGeometry.call(this),this.type="TorusBufferGeometry",this.parameters={radius:e,tube:t,radialSegments:r,tubularSegments:i,arc:n},e=e||1,t=t||.4,r=Math.floor(r)||8,i=Math.floor(i)||6,n=n||2*Math.PI;var a,o,s=[],c=[],l=[],h=[],u=new Vector3,d=new Vector3,p=new Vector3;for(a=0;a<=r;a++)for(o=0;o<=i;o++){var f=o/i*n,m=a/r*Math.PI*2;d.x=(e+t*Math.cos(m))*Math.cos(f),d.y=(e+t*Math.cos(m))*Math.sin(f),d.z=t*Math.sin(m),c.push(d.x,d.y,d.z),u.x=e*Math.cos(f),u.y=e*Math.sin(f),p.subVectors(d,u).normalize(),l.push(p.x,p.y,p.z),h.push(o/i),h.push(a/r)}for(a=1;a<=r;a++)for(o=1;o<=i;o++){var g=(i+1)*a+o-1,v=(i+1)*(a-1)+o-1,y=(i+1)*(a-1)+o,x=(i+1)*a+o;s.push(g,v,x),s.push(v,y,x)}this.setIndex(s),this.addAttribute("position",new Float32BufferAttribute(c,3)),this.addAttribute("normal",new Float32BufferAttribute(l,3)),this.addAttribute("uv",new Float32BufferAttribute(h,2))}PerspectiveCamera.prototype=Object.assign(Object.create(Camera.prototype),{constructor:PerspectiveCamera,isPerspectiveCamera:!0,copy:function(e,t){return Camera.prototype.copy.call(this,e,t),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this},setFocalLength:function(e){var t=.5*this.getFilmHeight()/e;this.fov=2*Et.RAD2DEG*Math.atan(t),this.updateProjectionMatrix()},getFocalLength:function(){var e=Math.tan(.5*Et.DEG2RAD*this.fov);return.5*this.getFilmHeight()/e},getEffectiveFOV:function(){return 2*Et.RAD2DEG*Math.atan(Math.tan(.5*Et.DEG2RAD*this.fov)/this.zoom)},getFilmWidth:function(){return this.filmGauge*Math.min(this.aspect,1)},getFilmHeight:function(){return this.filmGauge/Math.max(this.aspect,1)},setViewOffset:function(e,t,r,i,n,a){this.aspect=e/t,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=r,this.view.offsetY=i,this.view.width=n,this.view.height=a,this.updateProjectionMatrix()},clearViewOffset:function(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()},updateProjectionMatrix:function(){var e=this.near,t=e*Math.tan(.5*Et.DEG2RAD*this.fov)/this.zoom,r=2*t,i=this.aspect*r,n=-.5*i,a=this.view;if(null!==this.view&&this.view.enabled){var o=a.fullWidth,s=a.fullHeight;n+=a.offsetX*i/o,t-=a.offsetY*r/s,i*=a.width/o,r*=a.height/s}var c=this.filmOffset;0!==c&&(n+=e*c/this.getFilmWidth()),this.projectionMatrix.makePerspective(n,n+i,t,t-r,e,this.far)},toJSON:function(e){var t=Object3D.prototype.toJSON.call(this,e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,null!==this.view&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}}),ArrayCamera.prototype=Object.assign(Object.create(PerspectiveCamera.prototype),{constructor:ArrayCamera,isArrayCamera:!0}),FogExp2.prototype.isFogExp2=!0,FogExp2.prototype.clone=function(){return new FogExp2(this.color.getHex(),this.density)},FogExp2.prototype.toJSON=function(){return{type:"FogExp2",color:this.color.getHex(),density:this.density}},Fog.prototype.isFog=!0,Fog.prototype.clone=function(){return new Fog(this.color.getHex(),this.near,this.far)},Fog.prototype.toJSON=function(){return{type:"Fog",color:this.color.getHex(),near:this.near,far:this.far}},Scene.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Scene,copy:function(e,t){return Object3D.prototype.copy.call(this,e,t),null!==e.background&&(this.background=e.background.clone()),null!==e.fog&&(this.fog=e.fog.clone()),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.autoUpdate=e.autoUpdate,this.matrixAutoUpdate=e.matrixAutoUpdate,this},toJSON:function(e){var t=Object3D.prototype.toJSON.call(this,e);return null!==this.background&&(t.object.background=this.background.toJSON(e)),null!==this.fog&&(t.object.fog=this.fog.toJSON()),t}}),LensFlare.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:LensFlare,isLensFlare:!0,copy:function(e){Object3D.prototype.copy.call(this,e),this.positionScreen.copy(e.positionScreen),this.customUpdateCallback=e.customUpdateCallback;for(var t=0,r=e.lensFlares.length;t<r;t++)this.lensFlares.push(e.lensFlares[t]);return this},add:function(e,t,r,i,n,a){void 0===t&&(t=-1),void 0===r&&(r=0),void 0===a&&(a=1),void 0===n&&(n=new Color(16777215)),void 0===i&&(i=N),r=Math.min(r,Math.max(0,r)),this.lensFlares.push({texture:e,size:t,distance:r,x:0,y:0,z:0,scale:1,rotation:0,opacity:a,color:n,blending:i})},updateLensFlares:function(){var e,t,r=this.lensFlares.length,i=2*-this.positionScreen.x,n=2*-this.positionScreen.y;for(e=0;e<r;e++)(t=this.lensFlares[e]).x=this.positionScreen.x+i*t.distance,t.y=this.positionScreen.y+n*t.distance,t.wantedRotation=t.x*Math.PI*.25,t.rotation+=.25*(t.wantedRotation-t.rotation)}}),((SpriteMaterial.prototype=Object.create(Material.prototype)).constructor=SpriteMaterial).prototype.isSpriteMaterial=!0,SpriteMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.rotation=e.rotation,this},Sprite.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Sprite,isSprite:!0,raycast:(fi=new Vector3,mi=new Vector3,gi=new Vector3,function raycast(e,t){mi.setFromMatrixPosition(this.matrixWorld),e.ray.closestPointToPoint(mi,fi),gi.setFromMatrixScale(this.matrixWorld);var r=gi.x*gi.y/4;if(!(mi.distanceToSquared(fi)>r)){var i=e.ray.origin.distanceTo(fi);i<e.near||i>e.far||t.push({distance:i,point:fi.clone(),face:null,object:this})}}),clone:function(){return new this.constructor(this.material).copy(this)}}),LOD.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:LOD,copy:function(e){Object3D.prototype.copy.call(this,e,!1);for(var t=e.levels,r=0,i=t.length;r<i;r++){var n=t[r];this.addLevel(n.object.clone(),n.distance)}return this},addLevel:function(e,t){void 0===t&&(t=0),t=Math.abs(t);for(var r=this.levels,i=0;i<r.length&&!(t<r[i].distance);i++);r.splice(i,0,{distance:t,object:e}),this.add(e)},getObjectForDistance:function(e){for(var t=this.levels,r=1,i=t.length;r<i&&!(e<t[r].distance);r++);return t[r-1].object},raycast:(xi=new Vector3,function raycast(e,t){xi.setFromMatrixPosition(this.matrixWorld);var r=e.ray.origin.distanceTo(xi);this.getObjectForDistance(r).raycast(e,t)}),update:(vi=new Vector3,yi=new Vector3,function update(e){var t=this.levels;if(1<t.length){vi.setFromMatrixPosition(e.matrixWorld),yi.setFromMatrixPosition(this.matrixWorld);var r=vi.distanceTo(yi);t[0].object.visible=!0;for(var i=1,n=t.length;i<n&&r>=t[i].distance;i++)t[i-1].object.visible=!1,t[i].object.visible=!0;for(;i<n;i++)t[i].object.visible=!1}}),toJSON:function(e){var t=Object3D.prototype.toJSON.call(this,e);t.object.levels=[];for(var r=this.levels,i=0,n=r.length;i<n;i++){var a=r[i];t.object.levels.push({object:a.object.uuid,distance:a.distance})}return t}}),Object.assign(Skeleton.prototype,{calculateInverses:function(){this.boneInverses=[];for(var e=0,t=this.bones.length;e<t;e++){var r=new Matrix4;this.bones[e]&&r.getInverse(this.bones[e].matrixWorld),this.boneInverses.push(r)}},pose:function(){var e,t,r;for(t=0,r=this.bones.length;t<r;t++)(e=this.bones[t])&&e.matrixWorld.getInverse(this.boneInverses[t]);for(t=0,r=this.bones.length;t<r;t++)(e=this.bones[t])&&(e.parent&&e.parent.isBone?(e.matrix.getInverse(e.parent.matrixWorld),e.matrix.multiply(e.matrixWorld)):e.matrix.copy(e.matrixWorld),e.matrix.decompose(e.position,e.quaternion,e.scale))},update:(bi=new Matrix4,Mi=new Matrix4,function update(){for(var e=this.bones,t=this.boneInverses,r=this.boneMatrices,i=this.boneTexture,n=0,a=e.length;n<a;n++){var o=e[n]?e[n].matrixWorld:Mi;bi.multiplyMatrices(o,t[n]),bi.toArray(r,16*n)}void 0!==i&&(i.needsUpdate=!0)}),clone:function(){return new Skeleton(this.bones,this.boneInverses)}}),Bone.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Bone,isBone:!0}),SkinnedMesh.prototype=Object.assign(Object.create(Mesh.prototype),{constructor:SkinnedMesh,isSkinnedMesh:!0,initBones:function(){var e,t,r,i,n=[];if(this.geometry&&void 0!==this.geometry.bones){for(r=0,i=this.geometry.bones.length;r<i;r++)t=this.geometry.bones[r],e=new Bone,n.push(e),e.name=t.name,e.position.fromArray(t.pos),e.quaternion.fromArray(t.rotq),void 0!==t.scl&&e.scale.fromArray(t.scl);for(r=0,i=this.geometry.bones.length;r<i;r++)-1!==(t=this.geometry.bones[r]).parent&&null!==t.parent&&void 0!==n[t.parent]?n[t.parent].add(n[r]):this.add(n[r])}return this.updateMatrixWorld(!0),n},bind:function(e,t){this.skeleton=e,void 0===t&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),t=this.matrixWorld),this.bindMatrix.copy(t),this.bindMatrixInverse.getInverse(t)},pose:function(){this.skeleton.pose()},normalizeSkinWeights:function(){var e,t;if(this.geometry&&this.geometry.isGeometry)for(t=0;t<this.geometry.skinWeights.length;t++){var r=this.geometry.skinWeights[t];(e=1/r.manhattanLength())!==1/0?r.multiplyScalar(e):r.set(1,0,0,0)}else if(this.geometry&&this.geometry.isBufferGeometry){var i=new Vector4,n=this.geometry.attributes.skinWeight;for(t=0;t<n.count;t++)i.x=n.getX(t),i.y=n.getY(t),i.z=n.getZ(t),i.w=n.getW(t),(e=1/i.manhattanLength())!==1/0?i.multiplyScalar(e):i.set(1,0,0,0),n.setXYZW(t,i.x,i.y,i.z,i.w)}},updateMatrixWorld:function(e){Mesh.prototype.updateMatrixWorld.call(this,e),"attached"===this.bindMode?this.bindMatrixInverse.getInverse(this.matrixWorld):"detached"===this.bindMode?this.bindMatrixInverse.getInverse(this.bindMatrix):console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)},clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),((LineBasicMaterial.prototype=Object.create(Material.prototype)).constructor=LineBasicMaterial).prototype.isLineBasicMaterial=!0,LineBasicMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.color.copy(e.color),this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this},Line.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Line,isLine:!0,raycast:(_i=new Matrix4,wi=new Ray,Ti=new Sphere,function raycast(e,t){var r=e.linePrecision,i=r*r,n=this.geometry,a=this.matrixWorld;if(null===n.boundingSphere&&n.computeBoundingSphere(),Ti.copy(n.boundingSphere),Ti.applyMatrix4(a),!1!==e.ray.intersectsSphere(Ti)){_i.getInverse(a),wi.copy(e.ray).applyMatrix4(_i);var o=new Vector3,s=new Vector3,c=new Vector3,l=new Vector3,h=this&&this.isLineSegments?2:1;if(n.isBufferGeometry){var u=n.index,d=n.attributes.position.array;if(null!==u)for(var p=u.array,f=0,m=p.length-1;f<m;f+=h){var g=p[f],v=p[f+1];o.fromArray(d,3*g),s.fromArray(d,3*v),i<wi.distanceSqToSegment(o,s,l,c)||(l.applyMatrix4(this.matrixWorld),(b=e.ray.origin.distanceTo(l))<e.near||b>e.far||t.push({distance:b,point:c.clone().applyMatrix4(this.matrixWorld),index:f,face:null,faceIndex:null,object:this}))}else for(f=0,m=d.length/3-1;f<m;f+=h)o.fromArray(d,3*f),s.fromArray(d,3*f+3),i<wi.distanceSqToSegment(o,s,l,c)||(l.applyMatrix4(this.matrixWorld),(b=e.ray.origin.distanceTo(l))<e.near||b>e.far||t.push({distance:b,point:c.clone().applyMatrix4(this.matrixWorld),index:f,face:null,faceIndex:null,object:this}))}else if(n.isGeometry){var y=n.vertices,x=y.length;for(f=0;f<x-1;f+=h){var b;i<wi.distanceSqToSegment(y[f],y[f+1],l,c)||(l.applyMatrix4(this.matrixWorld),(b=e.ray.origin.distanceTo(l))<e.near||b>e.far||t.push({distance:b,point:c.clone().applyMatrix4(this.matrixWorld),index:f,face:null,faceIndex:null,object:this}))}}}}),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),LineSegments.prototype=Object.assign(Object.create(Line.prototype),{constructor:LineSegments,isLineSegments:!0}),LineLoop.prototype=Object.assign(Object.create(Line.prototype),{constructor:LineLoop,isLineLoop:!0}),((PointsMaterial.prototype=Object.create(Material.prototype)).constructor=PointsMaterial).prototype.isPointsMaterial=!0,PointsMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this},Points.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Points,isPoints:!0,raycast:(Ei=new Matrix4,Si=new Ray,Ai=new Sphere,function raycast(a,o){var s=this,e=this.geometry,c=this.matrixWorld,t=a.params.Points.threshold;if(null===e.boundingSphere&&e.computeBoundingSphere(),Ai.copy(e.boundingSphere),Ai.applyMatrix4(c),Ai.radius+=t,!1!==a.ray.intersectsSphere(Ai)){Ei.getInverse(c),Si.copy(a.ray).applyMatrix4(Ei);var r=t/((this.scale.x+this.scale.y+this.scale.z)/3),l=r*r,i=new Vector3;if(e.isBufferGeometry){var n=e.index,h=e.attributes.position.array;if(null!==n)for(var u=n.array,d=0,p=u.length;d<p;d++){var f=u[d];i.fromArray(h,3*f),testPoint(i,f)}else{d=0;for(var m=h.length/3;d<m;d++)i.fromArray(h,3*d),testPoint(i,d)}}else{var g=e.vertices;for(d=0,m=g.length;d<m;d++)testPoint(g[d],d)}}function testPoint(e,t){var r=Si.distanceSqToPoint(e);if(r<l){var i=Si.closestPointToPoint(e);i.applyMatrix4(c);var n=a.ray.origin.distanceTo(i);if(n<a.near||n>a.far)return;o.push({distance:n,distanceToRay:Math.sqrt(r),point:i.clone(),index:t,face:null,object:s})}}}),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),Group.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Group}),(VideoTexture.prototype=Object.create(Texture.prototype)).constructor=VideoTexture,((CompressedTexture.prototype=Object.create(Texture.prototype)).constructor=CompressedTexture).prototype.isCompressedTexture=!0,((DepthTexture.prototype=Object.create(Texture.prototype)).constructor=DepthTexture).prototype.isDepthTexture=!0,(WireframeGeometry.prototype=Object.create(BufferGeometry.prototype)).constructor=WireframeGeometry,(ParametricGeometry.prototype=Object.create(Geometry.prototype)).constructor=ParametricGeometry,(ParametricBufferGeometry.prototype=Object.create(BufferGeometry.prototype)).constructor=ParametricBufferGeometry,(PolyhedronGeometry.prototype=Object.create(Geometry.prototype)).constructor=PolyhedronGeometry,(PolyhedronBufferGeometry.prototype=Object.create(BufferGeometry.prototype)).constructor=PolyhedronBufferGeometry,(TetrahedronGeometry.prototype=Object.create(Geometry.prototype)).constructor=TetrahedronGeometry,(TetrahedronBufferGeometry.prototype=Object.create(PolyhedronBufferGeometry.prototype)).constructor=TetrahedronBufferGeometry,(OctahedronGeometry.prototype=Object.create(Geometry.prototype)).constructor=OctahedronGeometry,(OctahedronBufferGeometry.prototype=Object.create(PolyhedronBufferGeometry.prototype)).constructor=OctahedronBufferGeometry,(IcosahedronGeometry.prototype=Object.create(Geometry.prototype)).constructor=IcosahedronGeometry,(IcosahedronBufferGeometry.prototype=Object.create(PolyhedronBufferGeometry.prototype)).constructor=IcosahedronBufferGeometry,(DodecahedronGeometry.prototype=Object.create(Geometry.prototype)).constructor=DodecahedronGeometry,(DodecahedronBufferGeometry.prototype=Object.create(PolyhedronBufferGeometry.prototype)).constructor=DodecahedronBufferGeometry,(TubeGeometry.prototype=Object.create(Geometry.prototype)).constructor=TubeGeometry,(TubeBufferGeometry.prototype=Object.create(BufferGeometry.prototype)).constructor=TubeBufferGeometry,(TorusKnotGeometry.prototype=Object.create(Geometry.prototype)).constructor=TorusKnotGeometry,(TorusKnotBufferGeometry.prototype=Object.create(BufferGeometry.prototype)).constructor=TorusKnotBufferGeometry,(TorusGeometry.prototype=Object.create(Geometry.prototype)).constructor=TorusGeometry,(TorusBufferGeometry.prototype=Object.create(BufferGeometry.prototype)).constructor=TorusBufferGeometry;var Ci={area:function(e){for(var t=e.length,r=0,i=t-1,n=0;n<t;i=n++)r+=e[i].x*e[n].y-e[n].x*e[i].y;return.5*r},triangulate:function(){function snip(e,t,r,i,n,a){var o,s,c,l,h,u,d,p,f,m,g,v,y,x,b,M,_;if(s=e[a[t]].x,c=e[a[t]].y,l=e[a[r]].x,h=e[a[r]].y,u=e[a[i]].x,(l-s)*((d=e[a[i]].y)-c)-(h-c)*(u-s)<=0)return!1;for(m=u-l,g=d-h,v=s-u,y=c-d,x=l-s,b=h-c,o=0;o<n;o++)if(p=e[a[o]].x,f=e[a[o]].y,!(p===s&&f===c||p===l&&f===h||p===u&&f===d)&&(M=x*(f-c)-b*(p-s),_=v*(f-d)-y*(p-u),m*(f-h)-g*(p-l)>=-Number.EPSILON&&_>=-Number.EPSILON&&M>=-Number.EPSILON))return!1;return!0}return function triangulate(e,t){var r=e.length;if(r<3)return null;var i,n,a,o=[],s=[],c=[];if(0<Ci.area(e))for(n=0;n<r;n++)s[n]=n;else for(n=0;n<r;n++)s[n]=r-1-n;var l=r,h=2*l;for(n=l-1;2<l;){if(h--<=0)return console.warn("THREE.ShapeUtils: Unable to triangulate polygon! in triangulate()"),t?c:o;if(l<=(i=n)&&(i=0),l<=(n=i+1)&&(n=0),l<=(a=n+1)&&(a=0),snip(e,i,n,a,l,s)){var u,d,p,f,m;for(u=s[i],d=s[n],p=s[a],o.push([e[u],e[d],e[p]]),c.push([s[i],s[n],s[a]]),m=(f=n)+1;m<l;f++,m++)s[f]=s[m];h=2*--l}}return t?c:o}}(),triangulateShape:function(e,t){function removeDupEndPts(e){var t=e.length;2<t&&e[t-1].equals(e[0])&&e.pop()}function point_in_segment_2D_colin(e,t,r){return e.x!==t.x?e.x<t.x?e.x<=r.x&&r.x<=t.x:t.x<=r.x&&r.x<=e.x:e.y<t.y?e.y<=r.y&&r.y<=t.y:t.y<=r.y&&r.y<=e.y}function intersect_segments_2D(e,t,r,i,n){var a=t.x-e.x,o=t.y-e.y,s=i.x-r.x,c=i.y-r.y,l=e.x-r.x,h=e.y-r.y,u=o*s-a*c,d=o*l-a*h;if(Math.abs(u)>Number.EPSILON){var p;if(0<u){if(d<0||u<d)return[];if((p=c*l-s*h)<0||u<p)return[]}else{if(0<d||d<u)return[];if(0<(p=c*l-s*h)||p<u)return[]}if(0===p)return!n||0!==d&&d!==u?[e]:[];if(p===u)return!n||0!==d&&d!==u?[t]:[];if(0===d)return[r];if(d===u)return[i];var f=p/u;return[{x:e.x+f*a,y:e.y+f*o}]}if(0!==d||c*l!=s*h)return[];var m,g,v,y,x,b,M,_,w=0===a&&0===o,T=0===s&&0===c;return w&&T?e.x!==r.x||e.y!==r.y?[]:[e]:w?point_in_segment_2D_colin(r,i,e)?[e]:[]:T?point_in_segment_2D_colin(e,t,r)?[r]:[]:(_=0!==a?(y=e.x<t.x?(v=(m=e).x,(g=t).x):(v=(m=t).x,(g=e).x),r.x<i.x?(M=(x=r).x,(b=i).x):(M=(x=i).x,(b=r).x)):(y=e.y<t.y?(v=(m=e).y,(g=t).y):(v=(m=t).y,(g=e).y),r.y<i.y?(M=(x=r).y,(b=i).y):(M=(x=i).y,(b=r).y)),v<=M?y<M?[]:y===M?n?[]:[x]:y<=_?[x,g]:[x,b]:_<v?[]:v===_?n?[]:[m]:y<=_?[m,g]:[m,b])}function isPointInsideAngle(e,t,r,i){var n=t.x-e.x,a=t.y-e.y,o=r.x-e.x,s=r.y-e.y,c=i.x-e.x,l=i.y-e.y,h=n*s-a*o,u=n*l-a*c;if(Math.abs(h)>Number.EPSILON){var d=c*s-l*o;return 0<h?0<=u&&0<=d:0<=u||0<=d}return 0<u}removeDupEndPts(e),t.forEach(removeDupEndPts);for(var r,i,n,a,o,s,c={},l=e.concat(),h=0,u=t.length;h<u;h++)Array.prototype.push.apply(l,t[h]);for(r=0,i=l.length;r<i;r++)void 0!==c[o=l[r].x+":"+l[r].y]&&console.warn("THREE.ShapeUtils: Duplicate point",o,r),c[o]=r;var d=function removeHoles(e,o){var l,h=e.concat();function isCutLineInsideAngles(e,t){var r=h.length-1,i=e-1;i<0&&(i=r);var n=e+1;r<n&&(n=0);var a=isPointInsideAngle(h[e],h[i],h[n],l[t]);if(!a)return!1;var o=l.length-1,s=t-1;s<0&&(s=o);var c=t+1;return o<c&&(c=0),!!(a=isPointInsideAngle(l[t],l[s],l[c],h[e]))}function intersectsShapeEdge(e,t){var r,i;for(r=0;r<h.length;r++)if(i=r+1,i%=h.length,0<intersect_segments_2D(e,t,h[r],h[i],!0).length)return!0;return!1}var s=[];function intersectsHoleEdge(e,t){var r,i,n,a;for(r=0;r<s.length;r++)for(i=o[s[r]],n=0;n<i.length;n++)if(a=n+1,a%=i.length,0<intersect_segments_2D(e,t,i[n],i[a],!0).length)return!0;return!1}for(var t,r,i,n,a,c,u,d,p,f,m=[],g=0,v=o.length;g<v;g++)s.push(g);for(var y=0,x=2*s.length;0<s.length;){if(--x<0){console.log('THREE.ShapeUtils: Infinite Loop! Holes left:" + indepHoles.length + ", Probably Hole outside Shape!');break}for(r=y;r<h.length;r++){for(i=h[r],t=-1,g=0;g<s.length;g++)if(a=s[g],void 0===m[c=i.x+":"+i.y+":"+a]){l=o[a];for(var b=0;b<l.length;b++)if(n=l[b],isCutLineInsideAngles(r,b)&&!intersectsShapeEdge(i,n)&&!intersectsHoleEdge(i,n)){t=b,s.splice(g,1),u=h.slice(0,r+1),d=h.slice(r),p=l.slice(t),f=l.slice(0,t+1),h=u.concat(p).concat(f).concat(d),y=r;break}if(0<=t)break;m[c]=!0}if(0<=t)break}}return h}(e,t),p=Ci.triangulate(d,!1);for(r=0,i=p.length;r<i;r++)for(a=p[r],n=0;n<3;n++)void 0!==(s=c[o=a[n].x+":"+a[n].y])&&(a[n]=s);return p.concat()},isClockWise:function(e){return Ci.area(e)<0}};function ExtrudeGeometry(e,t){Geometry.call(this),this.type="ExtrudeGeometry",this.parameters={shapes:e,options:t},this.fromBufferGeometry(new ExtrudeBufferGeometry(e,t)),this.mergeVertices()}function ExtrudeBufferGeometry(e,t){void 0!==e&&(BufferGeometry.call(this),this.type="ExtrudeBufferGeometry",e=Array.isArray(e)?e:[e],this.addShapeList(e,t),this.computeVertexNormals())}function TextGeometry(e,t){Geometry.call(this),this.type="TextGeometry",this.parameters={text:e,parameters:t},this.fromBufferGeometry(new TextBufferGeometry(e,t)),this.mergeVertices()}function TextBufferGeometry(e,t){var r=(t=t||{}).font;if(!r||!r.isFont)return console.error("THREE.TextGeometry: font parameter is not an instance of THREE.Font."),new Geometry;var i=r.generateShapes(e,t.size,t.curveSegments);t.amount=void 0!==t.height?t.height:50,void 0===t.bevelThickness&&(t.bevelThickness=10),void 0===t.bevelSize&&(t.bevelSize=8),void 0===t.bevelEnabled&&(t.bevelEnabled=!1),ExtrudeBufferGeometry.call(this,i,t),this.type="TextBufferGeometry"}function SphereGeometry(e,t,r,i,n,a,o){Geometry.call(this),this.type="SphereGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:r,phiStart:i,phiLength:n,thetaStart:a,thetaLength:o},this.fromBufferGeometry(new SphereBufferGeometry(e,t,r,i,n,a,o)),this.mergeVertices()}function SphereBufferGeometry(e,t,r,i,n,a,o){BufferGeometry.call(this),this.type="SphereBufferGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:r,phiStart:i,phiLength:n,thetaStart:a,thetaLength:o},e=e||1,t=Math.max(3,Math.floor(t)||8),r=Math.max(2,Math.floor(r)||6),i=void 0!==i?i:0,n=void 0!==n?n:2*Math.PI;var s,c,l=(a=void 0!==a?a:0)+(o=void 0!==o?o:Math.PI),h=0,u=[],d=new Vector3,p=new Vector3,f=[],m=[],g=[],v=[];for(c=0;c<=r;c++){var y=[],x=c/r;for(s=0;s<=t;s++){var b=s/t;d.x=-e*Math.cos(i+b*n)*Math.sin(a+x*o),d.y=e*Math.cos(a+x*o),d.z=e*Math.sin(i+b*n)*Math.sin(a+x*o),m.push(d.x,d.y,d.z),p.set(d.x,d.y,d.z).normalize(),g.push(p.x,p.y,p.z),v.push(b,1-x),y.push(h++)}u.push(y)}for(c=0;c<r;c++)for(s=0;s<t;s++){var M=u[c][s+1],_=u[c][s],w=u[c+1][s],T=u[c+1][s+1];(0!==c||0<a)&&f.push(M,_,T),(c!==r-1||l<Math.PI)&&f.push(_,w,T)}this.setIndex(f),this.addAttribute("position",new Float32BufferAttribute(m,3)),this.addAttribute("normal",new Float32BufferAttribute(g,3)),this.addAttribute("uv",new Float32BufferAttribute(v,2))}function RingGeometry(e,t,r,i,n,a){Geometry.call(this),this.type="RingGeometry",this.parameters={innerRadius:e,outerRadius:t,thetaSegments:r,phiSegments:i,thetaStart:n,thetaLength:a},this.fromBufferGeometry(new RingBufferGeometry(e,t,r,i,n,a)),this.mergeVertices()}function RingBufferGeometry(e,t,r,i,n,a){BufferGeometry.call(this),this.type="RingBufferGeometry",this.parameters={innerRadius:e,outerRadius:t,thetaSegments:r,phiSegments:i,thetaStart:n,thetaLength:a},e=e||.5,t=t||1,n=void 0!==n?n:0,a=void 0!==a?a:2*Math.PI,r=void 0!==r?Math.max(3,r):8;var o,s,c,l=[],h=[],u=[],d=[],p=e,f=(t-e)/(i=void 0!==i?Math.max(1,i):1),m=new Vector3,g=new Vector2;for(s=0;s<=i;s++){for(c=0;c<=r;c++)o=n+c/r*a,m.x=p*Math.cos(o),m.y=p*Math.sin(o),h.push(m.x,m.y,m.z),u.push(0,0,1),g.x=(m.x/t+1)/2,g.y=(m.y/t+1)/2,d.push(g.x,g.y);p+=f}for(s=0;s<i;s++){var v=s*(r+1);for(c=0;c<r;c++){var y=o=c+v,x=o+r+1,b=o+r+2,M=o+1;l.push(y,x,M),l.push(x,b,M)}}this.setIndex(l),this.addAttribute("position",new Float32BufferAttribute(h,3)),this.addAttribute("normal",new Float32BufferAttribute(u,3)),this.addAttribute("uv",new Float32BufferAttribute(d,2))}function LatheGeometry(e,t,r,i){Geometry.call(this),this.type="LatheGeometry",this.parameters={points:e,segments:t,phiStart:r,phiLength:i},this.fromBufferGeometry(new LatheBufferGeometry(e,t,r,i)),this.mergeVertices()}function LatheBufferGeometry(e,t,r,i){BufferGeometry.call(this),this.type="LatheBufferGeometry",this.parameters={points:e,segments:t,phiStart:r,phiLength:i},t=Math.floor(t)||12,r=r||0,i=i||2*Math.PI,i=Et.clamp(i,0,2*Math.PI);var n,a,o,s=[],c=[],l=[],h=1/t,u=new Vector3,d=new Vector2;for(a=0;a<=t;a++){var p=r+a*h*i,f=Math.sin(p),m=Math.cos(p);for(o=0;o<=e.length-1;o++)u.x=e[o].x*f,u.y=e[o].y,u.z=e[o].x*m,c.push(u.x,u.y,u.z),d.x=a/t,d.y=o/(e.length-1),l.push(d.x,d.y)}for(a=0;a<t;a++)for(o=0;o<e.length-1;o++){var g=n=o+a*e.length,v=n+e.length,y=n+e.length+1,x=n+1;s.push(g,v,x),s.push(v,y,x)}if(this.setIndex(s),this.addAttribute("position",new Float32BufferAttribute(c,3)),this.addAttribute("uv",new Float32BufferAttribute(l,2)),this.computeVertexNormals(),i===2*Math.PI){var b=this.attributes.normal.array,M=new Vector3,_=new Vector3,w=new Vector3;for(n=t*e.length*3,o=a=0;a<e.length;a++,o+=3)M.x=b[o+0],M.y=b[o+1],M.z=b[o+2],_.x=b[n+o+0],_.y=b[n+o+1],_.z=b[n+o+2],w.addVectors(M,_).normalize(),b[o+0]=b[n+o+0]=w.x,b[o+1]=b[n+o+1]=w.y,b[o+2]=b[n+o+2]=w.z}}function ShapeGeometry(e,t){Geometry.call(this),this.type="ShapeGeometry","object"==typeof t&&(console.warn("THREE.ShapeGeometry: Options parameter has been removed."),t=t.curveSegments),this.parameters={shapes:e,curveSegments:t},this.fromBufferGeometry(new ShapeBufferGeometry(e,t)),this.mergeVertices()}function ShapeBufferGeometry(e,f){BufferGeometry.call(this),this.type="ShapeBufferGeometry",this.parameters={shapes:e,curveSegments:f},f=f||12;var m=[],g=[],v=[],y=[],t=0,x=0;if(!1===Array.isArray(e))addShape(e);else for(var r=0;r<e.length;r++)addShape(e[r]),this.addGroup(t,x,r),t+=x,x=0;function addShape(e){var t,r,i,n=g.length/3,a=e.extractPoints(f),o=a.shape,s=a.holes;if(!1===Ci.isClockWise(o))for(o=o.reverse(),t=0,r=s.length;t<r;t++)i=s[t],!0===Ci.isClockWise(i)&&(s[t]=i.reverse());var c=Ci.triangulateShape(o,s);for(t=0,r=s.length;t<r;t++)i=s[t],o=o.concat(i);for(t=0,r=o.length;t<r;t++){var l=o[t];g.push(l.x,l.y,0),v.push(0,0,1),y.push(l.x,l.y)}for(t=0,r=c.length;t<r;t++){var h=c[t],u=h[0]+n,d=h[1]+n,p=h[2]+n;m.push(u,d,p),x+=3}}this.setIndex(m),this.addAttribute("position",new Float32BufferAttribute(g,3)),this.addAttribute("normal",new Float32BufferAttribute(v,3)),this.addAttribute("uv",new Float32BufferAttribute(y,2))}function EdgesGeometry(e,t){BufferGeometry.call(this),this.type="EdgesGeometry",this.parameters={thresholdAngle:t},t=void 0!==t?t:1;var r,i,n,a,o=[],s=Math.cos(Et.DEG2RAD*t),c=[0,0],l={},h=["a","b","c"];e.isBufferGeometry?(a=new Geometry).fromBufferGeometry(e):a=e.clone(),a.mergeVertices(),a.computeFaceNormals();for(var u=a.vertices,d=a.faces,p=0,f=d.length;p<f;p++)for(var m=d[p],g=0;g<3;g++)r=m[h[g]],i=m[h[(g+1)%3]],c[0]=Math.min(r,i),c[1]=Math.max(r,i),void 0===l[n=c[0]+","+c[1]]?l[n]={index1:c[0],index2:c[1],face1:p,face2:void 0}:l[n].face2=p;for(n in l){var v=l[n];if(void 0===v.face2||d[v.face1].normal.dot(d[v.face2].normal)<=s){var y=u[v.index1];o.push(y.x,y.y,y.z),y=u[v.index2],o.push(y.x,y.y,y.z)}}this.addAttribute("position",new Float32BufferAttribute(o,3))}function CylinderGeometry(e,t,r,i,n,a,o,s){Geometry.call(this),this.type="CylinderGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:r,radialSegments:i,heightSegments:n,openEnded:a,thetaStart:o,thetaLength:s},this.fromBufferGeometry(new CylinderBufferGeometry(e,t,r,i,n,a,o,s)),this.mergeVertices()}function CylinderBufferGeometry(v,y,x,b,M,e,_,w){BufferGeometry.call(this),this.type="CylinderBufferGeometry",this.parameters={radiusTop:v,radiusBottom:y,height:x,radialSegments:b,heightSegments:M,openEnded:e,thetaStart:_,thetaLength:w};var T=this;v=void 0!==v?v:1,y=void 0!==y?y:1,x=x||1,b=Math.floor(b)||8,M=Math.floor(M)||1,e=void 0!==e&&e,_=void 0!==_?_:0,w=void 0!==w?w:2*Math.PI;var E=[],S=[],A=[],L=[],C=0,P=[],R=x/2,B=0;function generateCap(e){var t,r,i,n=new Vector2,a=new Vector3,o=0,s=!0===e?v:y,c=!0===e?1:-1;for(r=C,t=1;t<=b;t++)S.push(0,R*c,0),A.push(0,c,0),L.push(.5,.5),C++;for(i=C,t=0;t<=b;t++){var l=t/b*w+_,h=Math.cos(l),u=Math.sin(l);a.x=s*u,a.y=R*c,a.z=s*h,S.push(a.x,a.y,a.z),A.push(0,c,0),n.x=.5*h+.5,n.y=.5*u*c+.5,L.push(n.x,n.y),C++}for(t=0;t<b;t++){var d=r+t,p=i+t;!0===e?E.push(p,p+1,d):E.push(p+1,p,d),o+=3}T.addGroup(B,o,!0===e?1:2),B+=o}!function generateTorso(){var e,t,r=new Vector3,i=new Vector3,n=0,a=(y-v)/x;for(t=0;t<=M;t++){var o=[],s=t/M,c=s*(y-v)+v;for(e=0;e<=b;e++){var l=e/b,h=l*w+_,u=Math.sin(h),d=Math.cos(h);i.x=c*u,i.y=-s*x+R,i.z=c*d,S.push(i.x,i.y,i.z),r.set(u,a,d).normalize(),A.push(r.x,r.y,r.z),L.push(l,1-s),o.push(C++)}P.push(o)}for(e=0;e<b;e++)for(t=0;t<M;t++){var p=P[t][e],f=P[t+1][e],m=P[t+1][e+1],g=P[t][e+1];E.push(p,f,g),E.push(f,m,g),n+=6}T.addGroup(B,n,0),B+=n}(),!1===e&&(0<v&&generateCap(!0),0<y&&generateCap(!1)),this.setIndex(E),this.addAttribute("position",new Float32BufferAttribute(S,3)),this.addAttribute("normal",new Float32BufferAttribute(A,3)),this.addAttribute("uv",new Float32BufferAttribute(L,2))}function ConeGeometry(e,t,r,i,n,a,o){CylinderGeometry.call(this,0,e,t,r,i,n,a,o),this.type="ConeGeometry",this.parameters={radius:e,height:t,radialSegments:r,heightSegments:i,openEnded:n,thetaStart:a,thetaLength:o}}function ConeBufferGeometry(e,t,r,i,n,a,o){CylinderBufferGeometry.call(this,0,e,t,r,i,n,a,o),this.type="ConeBufferGeometry",this.parameters={radius:e,height:t,radialSegments:r,heightSegments:i,openEnded:n,thetaStart:a,thetaLength:o}}function CircleGeometry(e,t,r,i){Geometry.call(this),this.type="CircleGeometry",this.parameters={radius:e,segments:t,thetaStart:r,thetaLength:i},this.fromBufferGeometry(new CircleBufferGeometry(e,t,r,i)),this.mergeVertices()}function CircleBufferGeometry(e,t,r,i){BufferGeometry.call(this),this.type="CircleBufferGeometry",this.parameters={radius:e,segments:t,thetaStart:r,thetaLength:i},e=e||1,t=void 0!==t?Math.max(3,t):8,r=void 0!==r?r:0,i=void 0!==i?i:2*Math.PI;var n,a,o=[],s=[],c=[],l=[],h=new Vector3,u=new Vector2;for(s.push(0,0,0),c.push(0,0,1),l.push(.5,.5),a=0,n=3;a<=t;a++,n+=3){var d=r+a/t*i;h.x=e*Math.cos(d),h.y=e*Math.sin(d),s.push(h.x,h.y,h.z),c.push(0,0,1),u.x=(s[n]/e+1)/2,u.y=(s[n+1]/e+1)/2,l.push(u.x,u.y)}for(n=1;n<=t;n++)o.push(n,n+1,0);this.setIndex(o),this.addAttribute("position",new Float32BufferAttribute(s,3)),this.addAttribute("normal",new Float32BufferAttribute(c,3)),this.addAttribute("uv",new Float32BufferAttribute(l,2))}(ExtrudeGeometry.prototype=Object.create(Geometry.prototype)).constructor=ExtrudeGeometry,((ExtrudeBufferGeometry.prototype=Object.create(BufferGeometry.prototype)).constructor=ExtrudeBufferGeometry).prototype.getArrays=function(){var e=this.getAttribute("position"),t=e?Array.prototype.slice.call(e.array):[],r=this.getAttribute("uv"),i=r?Array.prototype.slice.call(r.array):[],n=this.index;return{position:t,uv:i,index:n?Array.prototype.slice.call(n.array):[]}},ExtrudeBufferGeometry.prototype.addShapeList=function(e,t){var r=e.length;t.arrays=this.getArrays();for(var i=0;i<r;i++){var n=e[i];this.addShape(n,t)}this.setIndex(t.arrays.index),this.addAttribute("position",new Float32BufferAttribute(t.arrays.position,3)),this.addAttribute("uv",new Float32BufferAttribute(t.arrays.uv,2))},ExtrudeBufferGeometry.prototype.addShape=function(e,i){var t,r,n,a,o,s,c,l,h=i.arrays?i.arrays:this.getArrays(),u=h.position,d=h.index,p=h.uv,f=[],m=void 0!==i.amount?i.amount:100,g=void 0!==i.bevelThickness?i.bevelThickness:6,y=void 0!==i.bevelSize?i.bevelSize:g-2,x=void 0!==i.bevelSegments?i.bevelSegments:3,b=void 0===i.bevelEnabled||i.bevelEnabled,M=void 0!==i.curveSegments?i.curveSegments:12,_=void 0!==i.steps?i.steps:1,w=i.extrudePath,T=!1,E=void 0!==i.UVGenerator?i.UVGenerator:ExtrudeGeometry.WorldUVGenerator;w&&(t=w.getSpacedPoints(_),b=!(T=!0),r=void 0!==i.frames?i.frames:w.computeFrenetFrames(_,!1),n=new Vector3,a=new Vector3,o=new Vector3),b||(y=g=x=0);var S=this,A=e.extractPoints(M),L=A.shape,C=A.holes;if(!Ci.isClockWise(L))for(L=L.reverse(),c=0,l=C.length;c<l;c++)s=C[c],Ci.isClockWise(s)&&(C[c]=s.reverse());var P=Ci.triangulateShape(L,C),R=L;for(c=0,l=C.length;c<l;c++)s=C[c],L=L.concat(s);function scalePt2(e,t,r){return t||console.error("THREE.ExtrudeGeometry: vec does not exist"),t.clone().multiplyScalar(r).add(e)}var B,I,D,G,U,O,V=L.length,F=P.length;function getBevelVec(e,t,r){var i,n,a,o=e.x-t.x,s=e.y-t.y,c=r.x-e.x,l=r.y-e.y,h=o*o+s*s,u=o*l-s*c;if(Math.abs(u)>Number.EPSILON){var d=Math.sqrt(h),p=Math.sqrt(c*c+l*l),f=t.x-s/d,m=t.y+o/d,g=((r.x-l/p-f)*l-(r.y+c/p-m)*c)/(o*l-s*c),v=(i=f+o*g-e.x)*i+(n=m+s*g-e.y)*n;if(v<=2)return new Vector2(i,n);a=Math.sqrt(v/2)}else{var y=!1;o>Number.EPSILON?c>Number.EPSILON&&(y=!0):o<-Number.EPSILON?c<-Number.EPSILON&&(y=!0):Math.sign(s)===Math.sign(l)&&(y=!0),a=y?(i=-s,n=o,Math.sqrt(h)):(i=o,n=s,Math.sqrt(h/2))}return new Vector2(i/a,n/a)}for(var N=[],z=0,H=R.length,k=H-1,j=z+1;z<H;z++,k++,j++)k===H&&(k=0),j===H&&(j=0),N[z]=getBevelVec(R[z],R[k],R[j]);var W,X,q=[],Y=N.concat();for(c=0,l=C.length;c<l;c++){for(s=C[c],W=[],z=0,k=(H=s.length)-1,j=z+1;z<H;z++,k++,j++)k===H&&(k=0),j===H&&(j=0),W[z]=getBevelVec(s[z],s[k],s[j]);q.push(W),Y=Y.concat(W)}for(B=0;B<x;B++){for(D=B/x,G=g*Math.cos(D*Math.PI/2),I=y*Math.sin(D*Math.PI/2),z=0,H=R.length;z<H;z++)v((U=scalePt2(R[z],N[z],I)).x,U.y,-G);for(c=0,l=C.length;c<l;c++)for(s=C[c],W=q[c],z=0,H=s.length;z<H;z++)v((U=scalePt2(s[z],W[z],I)).x,U.y,-G)}for(I=y,z=0;z<V;z++)U=b?scalePt2(L[z],Y[z],I):L[z],T?(a.copy(r.normals[0]).multiplyScalar(U.x),n.copy(r.binormals[0]).multiplyScalar(U.y),o.copy(t[0]).add(a).add(n),v(o.x,o.y,o.z)):v(U.x,U.y,0);for(X=1;X<=_;X++)for(z=0;z<V;z++)U=b?scalePt2(L[z],Y[z],I):L[z],T?(a.copy(r.normals[X]).multiplyScalar(U.x),n.copy(r.binormals[X]).multiplyScalar(U.y),o.copy(t[X]).add(a).add(n),v(o.x,o.y,o.z)):v(U.x,U.y,m/_*X);for(B=x-1;0<=B;B--){for(D=B/x,G=g*Math.cos(D*Math.PI/2),I=y*Math.sin(D*Math.PI/2),z=0,H=R.length;z<H;z++)v((U=scalePt2(R[z],N[z],I)).x,U.y,m+G);for(c=0,l=C.length;c<l;c++)for(s=C[c],W=q[c],z=0,H=s.length;z<H;z++)U=scalePt2(s[z],W[z],I),T?v(U.x,U.y+t[_-1].y,t[_-1].x+G):v(U.x,U.y,m+G)}function sidewalls(e,t){var r,i;for(z=e.length;0<=--z;){(i=(r=z)-1)<0&&(i=e.length-1);var n=0,a=_+2*x;for(n=0;n<a;n++){var o=V*n,s=V*(n+1);f4(t+r+o,t+i+o,t+i+s,t+r+s)}}}function v(e,t,r){f.push(e),f.push(t),f.push(r)}function f3(e,t,r){addVertex(e),addVertex(t),addVertex(r);var i=u.length/3,n=E.generateTopUV(S,u,i-3,i-2,i-1);addUV(n[0]),addUV(n[1]),addUV(n[2])}function f4(e,t,r,i){addVertex(e),addVertex(t),addVertex(i),addVertex(t),addVertex(r),addVertex(i);var n=u.length/3,a=E.generateSideWallUV(S,u,n-6,n-3,n-2,n-1);addUV(a[0]),addUV(a[1]),addUV(a[3]),addUV(a[1]),addUV(a[2]),addUV(a[3])}function addVertex(e){d.push(u.length/3),u.push(f[3*e+0]),u.push(f[3*e+1]),u.push(f[3*e+2])}function addUV(e){p.push(e.x),p.push(e.y)}!function buildLidFaces(){var e=u.length/3;if(b){var t=0,r=V*t;for(z=0;z<F;z++)f3((O=P[z])[2]+r,O[1]+r,O[0]+r);for(r=V*(t=_+2*x),z=0;z<F;z++)f3((O=P[z])[0]+r,O[1]+r,O[2]+r)}else{for(z=0;z<F;z++)f3((O=P[z])[2],O[1],O[0]);for(z=0;z<F;z++)f3((O=P[z])[0]+V*_,O[1]+V*_,O[2]+V*_)}S.addGroup(e,u.length/3-e,void 0!==i.material?i.material:0)}(),function buildSideFaces(){var e=u.length/3,t=0;for(sidewalls(R,t),t+=R.length,c=0,l=C.length;c<l;c++)sidewalls(s=C[c],t),t+=s.length;S.addGroup(e,u.length/3-e,void 0!==i.extrudeMaterial?i.extrudeMaterial:1)}(),i.arrays||(this.setIndex(d),this.addAttribute("position",new Float32BufferAttribute(u,3)),this.addAttribute("uv",new Float32BufferAttribute(i.arrays.uv,2)))},ExtrudeGeometry.WorldUVGenerator={generateTopUV:function(e,t,r,i,n){var a=t[3*r],o=t[3*r+1],s=t[3*i],c=t[3*i+1],l=t[3*n],h=t[3*n+1];return[new Vector2(a,o),new Vector2(s,c),new Vector2(l,h)]},generateSideWallUV:function(e,t,r,i,n,a){var o=t[3*r],s=t[3*r+1],c=t[3*r+2],l=t[3*i],h=t[3*i+1],u=t[3*i+2],d=t[3*n],p=t[3*n+1],f=t[3*n+2],m=t[3*a],g=t[3*a+1],v=t[3*a+2];return Math.abs(s-h)<.01?[new Vector2(o,1-c),new Vector2(l,1-u),new Vector2(d,1-f),new Vector2(m,1-v)]:[new Vector2(s,1-c),new Vector2(h,1-u),new Vector2(p,1-f),new Vector2(g,1-v)]}},(TextGeometry.prototype=Object.create(Geometry.prototype)).constructor=TextGeometry,(TextBufferGeometry.prototype=Object.create(ExtrudeBufferGeometry.prototype)).constructor=TextBufferGeometry,(SphereGeometry.prototype=Object.create(Geometry.prototype)).constructor=SphereGeometry,(SphereBufferGeometry.prototype=Object.create(BufferGeometry.prototype)).constructor=SphereBufferGeometry,(RingGeometry.prototype=Object.create(Geometry.prototype)).constructor=RingGeometry,(RingBufferGeometry.prototype=Object.create(BufferGeometry.prototype)).constructor=RingBufferGeometry,(LatheGeometry.prototype=Object.create(Geometry.prototype)).constructor=LatheGeometry,(LatheBufferGeometry.prototype=Object.create(BufferGeometry.prototype)).constructor=LatheBufferGeometry,(ShapeGeometry.prototype=Object.create(Geometry.prototype)).constructor=ShapeGeometry,(ShapeBufferGeometry.prototype=Object.create(BufferGeometry.prototype)).constructor=ShapeBufferGeometry,(EdgesGeometry.prototype=Object.create(BufferGeometry.prototype)).constructor=EdgesGeometry,(CylinderGeometry.prototype=Object.create(Geometry.prototype)).constructor=CylinderGeometry,(CylinderBufferGeometry.prototype=Object.create(BufferGeometry.prototype)).constructor=CylinderBufferGeometry,(ConeGeometry.prototype=Object.create(CylinderGeometry.prototype)).constructor=ConeGeometry,(ConeBufferGeometry.prototype=Object.create(CylinderBufferGeometry.prototype)).constructor=ConeBufferGeometry,(CircleGeometry.prototype=Object.create(Geometry.prototype)).constructor=CircleGeometry,(CircleBufferGeometry.prototype=Object.create(BufferGeometry.prototype)).constructor=CircleBufferGeometry;var Pi=Object.freeze({WireframeGeometry:WireframeGeometry,ParametricGeometry:ParametricGeometry,ParametricBufferGeometry:ParametricBufferGeometry,TetrahedronGeometry:TetrahedronGeometry,TetrahedronBufferGeometry:TetrahedronBufferGeometry,OctahedronGeometry:OctahedronGeometry,OctahedronBufferGeometry:OctahedronBufferGeometry,IcosahedronGeometry:IcosahedronGeometry,IcosahedronBufferGeometry:IcosahedronBufferGeometry,DodecahedronGeometry:DodecahedronGeometry,DodecahedronBufferGeometry:DodecahedronBufferGeometry,PolyhedronGeometry:PolyhedronGeometry,PolyhedronBufferGeometry:PolyhedronBufferGeometry,TubeGeometry:TubeGeometry,TubeBufferGeometry:TubeBufferGeometry,TorusKnotGeometry:TorusKnotGeometry,TorusKnotBufferGeometry:TorusKnotBufferGeometry,TorusGeometry:TorusGeometry,TorusBufferGeometry:TorusBufferGeometry,TextGeometry:TextGeometry,TextBufferGeometry:TextBufferGeometry,SphereGeometry:SphereGeometry,SphereBufferGeometry:SphereBufferGeometry,RingGeometry:RingGeometry,RingBufferGeometry:RingBufferGeometry,PlaneGeometry:PlaneGeometry,PlaneBufferGeometry:PlaneBufferGeometry,LatheGeometry:LatheGeometry,LatheBufferGeometry:LatheBufferGeometry,ShapeGeometry:ShapeGeometry,ShapeBufferGeometry:ShapeBufferGeometry,ExtrudeGeometry:ExtrudeGeometry,ExtrudeBufferGeometry:ExtrudeBufferGeometry,EdgesGeometry:EdgesGeometry,ConeGeometry:ConeGeometry,ConeBufferGeometry:ConeBufferGeometry,CylinderGeometry:CylinderGeometry,CylinderBufferGeometry:CylinderBufferGeometry,CircleGeometry:CircleGeometry,CircleBufferGeometry:CircleBufferGeometry,BoxGeometry:BoxGeometry,BoxBufferGeometry:BoxBufferGeometry});function ShadowMaterial(e){Material.call(this),this.type="ShadowMaterial",this.color=new Color(0),this.opacity=1,this.lights=!0,this.transparent=!0,this.setValues(e)}function RawShaderMaterial(e){ShaderMaterial.call(this,e),this.type="RawShaderMaterial"}function MeshStandardMaterial(e){Material.call(this),this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new Color(16777215),this.roughness=.5,this.metalness=.5,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Color(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapIntensity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function MeshPhysicalMaterial(e){MeshStandardMaterial.call(this),this.defines={PHYSICAL:""},this.type="MeshPhysicalMaterial",this.reflectivity=.5,this.clearCoat=0,this.clearCoatRoughness=0,this.setValues(e)}function MeshPhongMaterial(e){Material.call(this),this.type="MeshPhongMaterial",this.color=new Color(16777215),this.specular=new Color(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Color(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=he,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function MeshToonMaterial(e){MeshPhongMaterial.call(this),this.defines={TOON:""},this.type="MeshToonMaterial",this.gradientMap=null,this.setValues(e)}function MeshNormalMaterial(e){Material.call(this),this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function MeshLambertMaterial(e){Material.call(this),this.type="MeshLambertMaterial",this.color=new Color(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Color(0),this.emissiveIntensity=1,this.emissiveMap=null,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=he,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function LineDashedMaterial(e){LineBasicMaterial.call(this),this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(e)}((ShadowMaterial.prototype=Object.create(Material.prototype)).constructor=ShadowMaterial).prototype.isShadowMaterial=!0,((RawShaderMaterial.prototype=Object.create(ShaderMaterial.prototype)).constructor=RawShaderMaterial).prototype.isRawShaderMaterial=!0,((MeshStandardMaterial.prototype=Object.create(Material.prototype)).constructor=MeshStandardMaterial).prototype.isMeshStandardMaterial=!0,MeshStandardMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapIntensity=e.envMapIntensity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},((MeshPhysicalMaterial.prototype=Object.create(MeshStandardMaterial.prototype)).constructor=MeshPhysicalMaterial).prototype.isMeshPhysicalMaterial=!0,MeshPhysicalMaterial.prototype.copy=function(e){return MeshStandardMaterial.prototype.copy.call(this,e),this.defines={PHYSICAL:""},this.reflectivity=e.reflectivity,this.clearCoat=e.clearCoat,this.clearCoatRoughness=e.clearCoatRoughness,this},((MeshPhongMaterial.prototype=Object.create(Material.prototype)).constructor=MeshPhongMaterial).prototype.isMeshPhongMaterial=!0,MeshPhongMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},((MeshToonMaterial.prototype=Object.create(MeshPhongMaterial.prototype)).constructor=MeshToonMaterial).prototype.isMeshToonMaterial=!0,MeshToonMaterial.prototype.copy=function(e){return MeshPhongMaterial.prototype.copy.call(this,e),this.gradientMap=e.gradientMap,this},((MeshNormalMaterial.prototype=Object.create(Material.prototype)).constructor=MeshNormalMaterial).prototype.isMeshNormalMaterial=!0,MeshNormalMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},((MeshLambertMaterial.prototype=Object.create(Material.prototype)).constructor=MeshLambertMaterial).prototype.isMeshLambertMaterial=!0,MeshLambertMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},((LineDashedMaterial.prototype=Object.create(LineBasicMaterial.prototype)).constructor=LineDashedMaterial).prototype.isLineDashedMaterial=!0,LineDashedMaterial.prototype.copy=function(e){return LineBasicMaterial.prototype.copy.call(this,e),this.scale=e.scale,this.dashSize=e.dashSize,this.gapSize=e.gapSize,this};var Ri=Object.freeze({ShadowMaterial:ShadowMaterial,SpriteMaterial:SpriteMaterial,RawShaderMaterial:RawShaderMaterial,ShaderMaterial:ShaderMaterial,PointsMaterial:PointsMaterial,MeshPhysicalMaterial:MeshPhysicalMaterial,MeshStandardMaterial:MeshStandardMaterial,MeshPhongMaterial:MeshPhongMaterial,MeshToonMaterial:MeshToonMaterial,MeshNormalMaterial:MeshNormalMaterial,MeshLambertMaterial:MeshLambertMaterial,MeshDepthMaterial:MeshDepthMaterial,MeshDistanceMaterial:MeshDistanceMaterial,MeshBasicMaterial:MeshBasicMaterial,LineDashedMaterial:LineDashedMaterial,LineBasicMaterial:LineBasicMaterial,Material:Material}),Bi={enabled:!1,files:{},add:function(e,t){!1!==this.enabled&&(this.files[e]=t)},get:function(e){if(!1!==this.enabled)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}};function LoadingManager(e,t,r){var i=this,n=!1,a=0,o=0,s=void 0;this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=r,this.itemStart=function(e){o++,!1===n&&void 0!==i.onStart&&i.onStart(e,a,o),n=!0},this.itemEnd=function(e){a++,void 0!==i.onProgress&&i.onProgress(e,a,o),a===o&&(n=!1,void 0!==i.onLoad&&i.onLoad())},this.itemError=function(e){void 0!==i.onError&&i.onError(e)},this.resolveURL=function(e){return s?s(e):e},this.setURLModifier=function(e){s=e}}var Ii=new LoadingManager,Di={};function FileLoader(e){this.manager=void 0!==e?e:Ii}function CompressedTextureLoader(e){this.manager=void 0!==e?e:Ii,this._parser=null}function DataTextureLoader(e){this.manager=void 0!==e?e:Ii,this._parser=null}function ImageLoader(e){this.manager=void 0!==e?e:Ii}function CubeTextureLoader(e){this.manager=void 0!==e?e:Ii}function TextureLoader(e){this.manager=void 0!==e?e:Ii}function Light(e,t){Object3D.call(this),this.type="Light",this.color=new Color(e),this.intensity=void 0!==t?t:1,this.receiveShadow=void 0}function HemisphereLight(e,t,r){Light.call(this,e,r),this.type="HemisphereLight",this.castShadow=void 0,this.position.copy(Object3D.DefaultUp),this.updateMatrix(),this.groundColor=new Color(t)}function LightShadow(e){this.camera=e,this.bias=0,this.radius=1,this.mapSize=new Vector2(512,512),this.map=null,this.matrix=new Matrix4}function SpotLightShadow(){LightShadow.call(this,new PerspectiveCamera(50,1,.5,500))}function SpotLight(e,t,r,i,n,a){Light.call(this,e,t),this.type="SpotLight",this.position.copy(Object3D.DefaultUp),this.updateMatrix(),this.target=new Object3D,Object.defineProperty(this,"power",{get:function(){return this.intensity*Math.PI},set:function(e){this.intensity=e/Math.PI}}),this.distance=void 0!==r?r:0,this.angle=void 0!==i?i:Math.PI/3,this.penumbra=void 0!==n?n:0,this.decay=void 0!==a?a:1,this.shadow=new SpotLightShadow}function PointLight(e,t,r,i){Light.call(this,e,t),this.type="PointLight",Object.defineProperty(this,"power",{get:function(){return 4*this.intensity*Math.PI},set:function(e){this.intensity=e/(4*Math.PI)}}),this.distance=void 0!==r?r:0,this.decay=void 0!==i?i:1,this.shadow=new LightShadow(new PerspectiveCamera(90,1,.5,500))}function DirectionalLightShadow(){LightShadow.call(this,new OrthographicCamera(-5,5,5,-5,.5,500))}function DirectionalLight(e,t){Light.call(this,e,t),this.type="DirectionalLight",this.position.copy(Object3D.DefaultUp),this.updateMatrix(),this.target=new Object3D,this.shadow=new DirectionalLightShadow}function AmbientLight(e,t){Light.call(this,e,t),this.type="AmbientLight",this.castShadow=void 0}function RectAreaLight(e,t,r,i){Light.call(this,e,t),this.type="RectAreaLight",this.position.set(0,1,0),this.updateMatrix(),this.width=void 0!==r?r:10,this.height=void 0!==i?i:10}Object.assign(FileLoader.prototype,{load:function(o,e,t,r){void 0===o&&(o=""),void 0!==this.path&&(o=this.path+o),o=this.manager.resolveURL(o);var s=this,i=Bi.get(o);if(void 0!==i)return s.manager.itemStart(o),setTimeout(function(){e&&e(i),s.manager.itemEnd(o)},0),i;if(void 0===Di[o]){var n=o.match(/^data:(.*?)(;base64)?,(.*)$/);if(n){var a=n[1],c=!!n[2],l=n[3];l=window.decodeURIComponent(l),c&&(l=window.atob(l));try{var h,u=(this.responseType||"").toLowerCase();switch(u){case"arraybuffer":case"blob":for(var d=new Uint8Array(l.length),p=0;p<l.length;p++)d[p]=l.charCodeAt(p);h="blob"===u?new Blob([d.buffer],{type:a}):d.buffer;break;case"document":var f=new DOMParser;h=f.parseFromString(l,a);break;case"json":h=JSON.parse(l);break;default:h=l}window.setTimeout(function(){e&&e(h),s.manager.itemEnd(o)},0)}catch(e){window.setTimeout(function(){r&&r(e),s.manager.itemEnd(o),s.manager.itemError(o)},0)}}else{Di[o]=[],Di[o].push({onLoad:e,onProgress:t,onError:r});var m=new XMLHttpRequest;for(var g in m.open("GET",o,!0),m.addEventListener("load",function(e){var t=e.target.response;Bi.add(o,t);var r=Di[o];if(delete Di[o],200===this.status){for(var i=0,n=r.length;i<n;i++){(a=r[i]).onLoad&&a.onLoad(t)}s.manager.itemEnd(o)}else if(0===this.status){console.warn("THREE.FileLoader: HTTP Status 0 received.");for(i=0,n=r.length;i<n;i++){(a=r[i]).onLoad&&a.onLoad(t)}s.manager.itemEnd(o)}else{for(i=0,n=r.length;i<n;i++){var a;(a=r[i]).onError&&a.onError(e)}s.manager.itemEnd(o),s.manager.itemError(o)}},!1),m.addEventListener("progress",function(e){for(var t=Di[o],r=0,i=t.length;r<i;r++){var n=t[r];n.onProgress&&n.onProgress(e)}},!1),m.addEventListener("error",function(e){var t=Di[o];delete Di[o];for(var r=0,i=t.length;r<i;r++){var n=t[r];n.onError&&n.onError(e)}s.manager.itemEnd(o),s.manager.itemError(o)},!1),void 0!==this.responseType&&(m.responseType=this.responseType),void 0!==this.withCredentials&&(m.withCredentials=this.withCredentials),m.overrideMimeType&&m.overrideMimeType(void 0!==this.mimeType?this.mimeType:"text/plain"),this.requestHeader)m.setRequestHeader(g,this.requestHeader[g]);m.send(null)}return s.manager.itemStart(o),m}Di[o].push({onLoad:e,onProgress:t,onError:r})},setPath:function(e){return this.path=e,this},setResponseType:function(e){return this.responseType=e,this},setWithCredentials:function(e){return this.withCredentials=e,this},setMimeType:function(e){return this.mimeType=e,this},setRequestHeader:function(e){return this.requestHeader=e,this}}),Object.assign(CompressedTextureLoader.prototype,{load:function(e,a,t,i){var o=this,s=[],c=new CompressedTexture;c.image=s;var n=new FileLoader(this.manager);function loadTexture(r){n.load(e[r],function(e){var t=o._parser(e,!0);s[r]={width:t.width,height:t.height,format:t.format,mipmaps:t.mipmaps},6===(l+=1)&&(1===t.mipmapCount&&(c.minFilter=Be),c.format=t.format,c.needsUpdate=!0,a&&a(c))},t,i)}if(n.setPath(this.path),n.setResponseType("arraybuffer"),Array.isArray(e))for(var l=0,r=0,h=e.length;r<h;++r)loadTexture(r);else n.load(e,function(e){var t=o._parser(e,!0);if(t.isCubemap)for(var r=t.mipmaps.length/t.mipmapCount,i=0;i<r;i++){s[i]={mipmaps:[]};for(var n=0;n<t.mipmapCount;n++)s[i].mipmaps.push(t.mipmaps[i*t.mipmapCount+n]),s[i].format=t.format,s[i].width=t.width,s[i].height=t.height}else c.image.width=t.width,c.image.height=t.height,c.mipmaps=t.mipmaps;1===t.mipmapCount&&(c.minFilter=Be),c.format=t.format,c.needsUpdate=!0,a&&a(c)},t,i);return c},setPath:function(e){return this.path=e,this}}),Object.assign(DataTextureLoader.prototype,{load:function(e,r,t,i){var n=this,a=new DataTexture,o=new FileLoader(this.manager);return o.setResponseType("arraybuffer"),o.load(e,function(e){var t=n._parser(e);t&&(void 0!==t.image?a.image=t.image:void 0!==t.data&&(a.image.width=t.width,a.image.height=t.height,a.image.data=t.data),a.wrapS=void 0!==t.wrapS?t.wrapS:Ae,a.wrapT=void 0!==t.wrapT?t.wrapT:Ae,a.magFilter=void 0!==t.magFilter?t.magFilter:Be,a.minFilter=void 0!==t.minFilter?t.minFilter:De,a.anisotropy=void 0!==t.anisotropy?t.anisotropy:1,void 0!==t.format&&(a.format=t.format),void 0!==t.type&&(a.type=t.type),void 0!==t.mipmaps&&(a.mipmaps=t.mipmaps),1===t.mipmapCount&&(a.minFilter=Be),a.needsUpdate=!0,r&&r(a,t))},t,i),a}}),Object.assign(ImageLoader.prototype,{crossOrigin:"Anonymous",load:function(t,e,r,i){void 0===t&&(t=""),void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);var n=this,a=Bi.get(t);if(void 0!==a)return n.manager.itemStart(t),setTimeout(function(){e&&e(a),n.manager.itemEnd(t)},0),a;var o=document.createElementNS("http://www.w3.org/1999/xhtml","img");return o.addEventListener("load",function(){Bi.add(t,this),e&&e(this),n.manager.itemEnd(t)},!1),o.addEventListener("error",function(e){i&&i(e),n.manager.itemEnd(t),n.manager.itemError(t)},!1),"data:"!==t.substr(0,5)&&void 0!==this.crossOrigin&&(o.crossOrigin=this.crossOrigin),n.manager.itemStart(t),o.src=t,o},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this}}),Object.assign(CubeTextureLoader.prototype,{crossOrigin:"Anonymous",load:function(e,r,t,i){var n=new CubeTexture,a=new ImageLoader(this.manager);a.setCrossOrigin(this.crossOrigin),a.setPath(this.path);var o=0;function loadTexture(t){a.load(e[t],function(e){n.images[t]=e,6===++o&&(n.needsUpdate=!0,r&&r(n))},void 0,i)}for(var s=0;s<e.length;++s)loadTexture(s);return n},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this}}),Object.assign(TextureLoader.prototype,{crossOrigin:"Anonymous",load:function(t,r,e,i){var n=new ImageLoader(this.manager);n.setCrossOrigin(this.crossOrigin),n.setPath(this.path);var a=new Texture;return a.image=n.load(t,function(){var e=0<t.search(/\.(jpg|jpeg)$/)||0===t.search(/^data\:image\/jpeg/);a.format=e?Ye:Ze,a.needsUpdate=!0,void 0!==r&&r(a)},e,i),a},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this}}),Light.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Light,isLight:!0,copy:function(e){return Object3D.prototype.copy.call(this,e),this.color.copy(e.color),this.intensity=e.intensity,this},toJSON:function(e){var t=Object3D.prototype.toJSON.call(this,e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,void 0!==this.groundColor&&(t.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(t.object.distance=this.distance),void 0!==this.angle&&(t.object.angle=this.angle),void 0!==this.decay&&(t.object.decay=this.decay),void 0!==this.penumbra&&(t.object.penumbra=this.penumbra),void 0!==this.shadow&&(t.object.shadow=this.shadow.toJSON()),t}}),HemisphereLight.prototype=Object.assign(Object.create(Light.prototype),{constructor:HemisphereLight,isHemisphereLight:!0,copy:function(e){return Light.prototype.copy.call(this,e),this.groundColor.copy(e.groundColor),this}}),Object.assign(LightShadow.prototype,{copy:function(e){return this.camera=e.camera.clone(),this.bias=e.bias,this.radius=e.radius,this.mapSize.copy(e.mapSize),this},clone:function(){return(new this.constructor).copy(this)},toJSON:function(){var e={};return 0!==this.bias&&(e.bias=this.bias),1!==this.radius&&(e.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}),SpotLightShadow.prototype=Object.assign(Object.create(LightShadow.prototype),{constructor:SpotLightShadow,isSpotLightShadow:!0,update:function(e){var t=this.camera,r=2*Et.RAD2DEG*e.angle,i=this.mapSize.width/this.mapSize.height,n=e.distance||t.far;r===t.fov&&i===t.aspect&&n===t.far||(t.fov=r,t.aspect=i,t.far=n,t.updateProjectionMatrix())}}),SpotLight.prototype=Object.assign(Object.create(Light.prototype),{constructor:SpotLight,isSpotLight:!0,copy:function(e){return Light.prototype.copy.call(this,e),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}),PointLight.prototype=Object.assign(Object.create(Light.prototype),{constructor:PointLight,isPointLight:!0,copy:function(e){return Light.prototype.copy.call(this,e),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}}),DirectionalLightShadow.prototype=Object.assign(Object.create(LightShadow.prototype),{constructor:DirectionalLightShadow}),DirectionalLight.prototype=Object.assign(Object.create(Light.prototype),{constructor:DirectionalLight,isDirectionalLight:!0,copy:function(e){return Light.prototype.copy.call(this,e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}),AmbientLight.prototype=Object.assign(Object.create(Light.prototype),{constructor:AmbientLight,isAmbientLight:!0}),RectAreaLight.prototype=Object.assign(Object.create(Light.prototype),{constructor:RectAreaLight,isRectAreaLight:!0,copy:function(e){return Light.prototype.copy.call(this,e),this.width=e.width,this.height=e.height,this},toJSON:function(e){var t=Light.prototype.toJSON.call(this,e);return t.object.width=this.width,t.object.height=this.height,t}});var Gi,Ui={arraySlice:function(e,t,r){return Ui.isTypedArray(e)?new e.constructor(e.subarray(t,void 0!==r?r:e.length)):e.slice(t,r)},convertArray:function(e,t,r){return!e||!r&&e.constructor===t?e:"number"==typeof t.BYTES_PER_ELEMENT?new t(e):Array.prototype.slice.call(e)},isTypedArray:function(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)},getKeyframeOrder:function(r){for(var e=r.length,t=new Array(e),i=0;i!==e;++i)t[i]=i;return t.sort(function compareTime(e,t){return r[e]-r[t]}),t},sortedArray:function(e,t,r){for(var i=e.length,n=new e.constructor(i),a=0,o=0;o!==i;++a)for(var s=r[a]*t,c=0;c!==t;++c)n[o++]=e[s+c];return n},flattenJSON:function(e,t,r,i){for(var n=1,a=e[0];void 0!==a&&void 0===a[i];)a=e[n++];if(void 0!==a){var o=a[i];if(void 0!==o)if(Array.isArray(o))for(;void 0!==(o=a[i])&&(t.push(a.time),r.push.apply(r,o)),void 0!==(a=e[n++]););else if(void 0!==o.toArray)for(;void 0!==(o=a[i])&&(t.push(a.time),o.toArray(r,r.length)),void 0!==(a=e[n++]););else for(;void 0!==(o=a[i])&&(t.push(a.time),r.push(o)),void 0!==(a=e[n++]););}}};function Interpolant(e,t,r,i){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=void 0!==i?i:new t.constructor(r),this.sampleValues=t,this.valueSize=r}function CubicInterpolant(e,t,r,i){Interpolant.call(this,e,t,r,i),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0}function LinearInterpolant(e,t,r,i){Interpolant.call(this,e,t,r,i)}function DiscreteInterpolant(e,t,r,i){Interpolant.call(this,e,t,r,i)}function KeyframeTrackConstructor(e,t,r,i){if(void 0===e)throw new Error("track name is undefined");if(void 0===t||0===t.length)throw new Error("no keyframes in track named "+e);this.name=e,this.times=Ui.convertArray(t,this.TimeBufferType),this.values=Ui.convertArray(r,this.ValueBufferType),this.setInterpolation(i||this.DefaultInterpolation),this.validate(),this.optimize()}function VectorKeyframeTrack(e,t,r,i){KeyframeTrackConstructor.call(this,e,t,r,i)}function QuaternionLinearInterpolant(e,t,r,i){Interpolant.call(this,e,t,r,i)}function QuaternionKeyframeTrack(e,t,r,i){KeyframeTrackConstructor.call(this,e,t,r,i)}function NumberKeyframeTrack(e,t,r,i){KeyframeTrackConstructor.call(this,e,t,r,i)}function StringKeyframeTrack(e,t,r,i){KeyframeTrackConstructor.call(this,e,t,r,i)}function BooleanKeyframeTrack(e,t,r){KeyframeTrackConstructor.call(this,e,t,r)}function ColorKeyframeTrack(e,t,r,i){KeyframeTrackConstructor.call(this,e,t,r,i)}function KeyframeTrack(e,t,r,i){KeyframeTrackConstructor.apply(this,e,t,r,i)}function AnimationClip(e,t,r){this.name=e,this.tracks=r,this.duration=void 0!==t?t:-1,this.uuid=Et.generateUUID(),this.duration<0&&this.resetDuration(),this.optimize()}function MaterialLoader(e){this.manager=void 0!==e?e:Ii,this.textures={}}function BufferGeometryLoader(e){this.manager=void 0!==e?e:Ii}Object.assign(Interpolant.prototype,{evaluate:function(e){var t=this.parameterPositions,r=this._cachedIndex,i=t[r],n=t[r-1];e:{t:{var a;r:{i:if(!(e<i)){for(var o=r+2;;){if(void 0===i){if(e<n)break i;return r=t.length,this._cachedIndex=r,this.afterEnd_(r-1,e,n)}if(r===o)break;if(n=i,e<(i=t[++r]))break t}a=t.length;break r}if(n<=e)break e;var s=t[1];e<s&&(r=2,n=s);for(o=r-2;;){if(void 0===n)return this._cachedIndex=0,this.beforeStart_(0,e,i);if(r===o)break;if(i=n,(n=t[--r-1])<=e)break t}a=r,r=0}for(;r<a;){var c=r+a>>>1;e<t[c]?a=c:r=c+1}if(i=t[r],void 0===(n=t[r-1]))return this._cachedIndex=0,this.beforeStart_(0,e,i);if(void 0===i)return r=t.length,this._cachedIndex=r,this.afterEnd_(r-1,n,e)}this._cachedIndex=r,this.intervalChanged_(r,n,i)}return this.interpolate_(r,n,e,i)},settings:null,DefaultSettings_:{},getSettings_:function(){return this.settings||this.DefaultSettings_},copySampleValue_:function(e){for(var t=this.resultBuffer,r=this.sampleValues,i=this.valueSize,n=e*i,a=0;a!==i;++a)t[a]=r[n+a];return t},interpolate_:function(){throw new Error("call to abstract method")},intervalChanged_:function(){}}),Object.assign(Interpolant.prototype,{beforeStart_:Interpolant.prototype.copySampleValue_,afterEnd_:Interpolant.prototype.copySampleValue_}),CubicInterpolant.prototype=Object.assign(Object.create(Interpolant.prototype),{constructor:CubicInterpolant,DefaultSettings_:{endingStart:dt,endingEnd:dt},intervalChanged_:function(e,t,r){var i=this.parameterPositions,n=e-2,a=e+1,o=i[n],s=i[a];if(void 0===o)switch(this.getSettings_().endingStart){case pt:n=e,o=2*t-r;break;case ft:o=t+i[n=i.length-2]-i[n+1];break;default:n=e,o=r}if(void 0===s)switch(this.getSettings_().endingEnd){case pt:a=e,s=2*r-t;break;case ft:s=r+i[a=1]-i[0];break;default:a=e-1,s=t}var c=.5*(r-t),l=this.valueSize;this._weightPrev=c/(t-o),this._weightNext=c/(s-r),this._offsetPrev=n*l,this._offsetNext=a*l},interpolate_:function(e,t,r,i){for(var n=this.resultBuffer,a=this.sampleValues,o=this.valueSize,s=e*o,c=s-o,l=this._offsetPrev,h=this._offsetNext,u=this._weightPrev,d=this._weightNext,p=(r-t)/(i-t),f=p*p,m=f*p,g=-u*m+2*u*f-u*p,v=(1+u)*m+(-1.5-2*u)*f+(-.5+u)*p+1,y=(-1-d)*m+(1.5+d)*f+.5*p,x=d*m-d*f,b=0;b!==o;++b)n[b]=g*a[l+b]+v*a[c+b]+y*a[s+b]+x*a[h+b];return n}}),LinearInterpolant.prototype=Object.assign(Object.create(Interpolant.prototype),{constructor:LinearInterpolant,interpolate_:function(e,t,r,i){for(var n=this.resultBuffer,a=this.sampleValues,o=this.valueSize,s=e*o,c=s-o,l=(r-t)/(i-t),h=1-l,u=0;u!==o;++u)n[u]=a[c+u]*h+a[s+u]*l;return n}}),DiscreteInterpolant.prototype=Object.assign(Object.create(Interpolant.prototype),{constructor:DiscreteInterpolant,interpolate_:function(e){return this.copySampleValue_(e-1)}}),Gi={TimeBufferType:Float32Array,ValueBufferType:Float32Array,DefaultInterpolation:ut,InterpolantFactoryMethodDiscrete:function(e){return new DiscreteInterpolant(this.times,this.values,this.getValueSize(),e)},InterpolantFactoryMethodLinear:function(e){return new LinearInterpolant(this.times,this.values,this.getValueSize(),e)},InterpolantFactoryMethodSmooth:function(e){return new CubicInterpolant(this.times,this.values,this.getValueSize(),e)},setInterpolation:function(e){var t;switch(e){case ht:t=this.InterpolantFactoryMethodDiscrete;break;case ut:t=this.InterpolantFactoryMethodLinear;break;case 2302:t=this.InterpolantFactoryMethodSmooth}if(void 0!==t)this.createInterpolant=t;else{var r="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(e===this.DefaultInterpolation)throw new Error(r);this.setInterpolation(this.DefaultInterpolation)}console.warn("THREE.KeyframeTrackPrototype:",r)}},getInterpolation:function(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return ht;case this.InterpolantFactoryMethodLinear:return ut;case this.InterpolantFactoryMethodSmooth:return 2302}},getValueSize:function(){return this.values.length/this.times.length},shift:function(e){if(0!==e)for(var t=this.times,r=0,i=t.length;r!==i;++r)t[r]+=e;return this},scale:function(e){if(1!==e)for(var t=this.times,r=0,i=t.length;r!==i;++r)t[r]*=e;return this},trim:function(e,t){for(var r=this.times,i=r.length,n=0,a=i-1;n!==i&&r[n]<e;)++n;for(;-1!==a&&r[a]>t;)--a;if(++a,0!==n||a!==i){a<=n&&(n=(a=Math.max(a,1))-1);var o=this.getValueSize();this.times=Ui.arraySlice(r,n,a),this.values=Ui.arraySlice(this.values,n*o,a*o)}return this},validate:function(){var e=!0,t=this.getValueSize();t-Math.floor(t)!=0&&(console.error("THREE.KeyframeTrackPrototype: Invalid value size in track.",this),e=!1);var r=this.times,i=this.values,n=r.length;0===n&&(console.error("THREE.KeyframeTrackPrototype: Track is empty.",this),e=!1);for(var a=null,o=0;o!==n;o++){var s=r[o];if("number"==typeof s&&isNaN(s)){console.error("THREE.KeyframeTrackPrototype: Time is not a valid number.",this,o,s),e=!1;break}if(null!==a&&s<a){console.error("THREE.KeyframeTrackPrototype: Out of order keys.",this,o,s,a),e=!1;break}a=s}if(void 0!==i&&Ui.isTypedArray(i)){o=0;for(var c=i.length;o!==c;++o){var l=i[o];if(isNaN(l)){console.error("THREE.KeyframeTrackPrototype: Value is not a valid number.",this,o,l),e=!1;break}}}return e},optimize:function(){for(var e=this.times,t=this.values,r=this.getValueSize(),i=2302===this.getInterpolation(),n=1,a=e.length-1,o=1;o<a;++o){var s=!1,c=e[o];if(c!==e[o+1]&&(1!==o||c!==c[0]))if(i)s=!0;else for(var l=o*r,h=l-r,u=l+r,d=0;d!==r;++d){var p=t[l+d];if(p!==t[h+d]||p!==t[u+d]){s=!0;break}}if(s){if(o!==n){e[n]=e[o];var f=o*r,m=n*r;for(d=0;d!==r;++d)t[m+d]=t[f+d]}++n}}if(0<a){e[n]=e[a];for(f=a*r,m=n*r,d=0;d!==r;++d)t[m+d]=t[f+d];++n}return n!==e.length&&(this.times=Ui.arraySlice(e,0,n),this.values=Ui.arraySlice(t,0,n*r)),this}},VectorKeyframeTrack.prototype=Object.assign(Object.create(Gi),{constructor:VectorKeyframeTrack,ValueTypeName:"vector"}),QuaternionLinearInterpolant.prototype=Object.assign(Object.create(Interpolant.prototype),{constructor:QuaternionLinearInterpolant,interpolate_:function(e,t,r,i){for(var n=this.resultBuffer,a=this.sampleValues,o=this.valueSize,s=e*o,c=(r-t)/(i-t),l=s+o;s!==l;s+=4)Quaternion.slerpFlat(n,0,a,s-o,a,s,c);return n}}),QuaternionKeyframeTrack.prototype=Object.assign(Object.create(Gi),{constructor:QuaternionKeyframeTrack,ValueTypeName:"quaternion",DefaultInterpolation:ut,InterpolantFactoryMethodLinear:function(e){return new QuaternionLinearInterpolant(this.times,this.values,this.getValueSize(),e)},InterpolantFactoryMethodSmooth:void 0}),NumberKeyframeTrack.prototype=Object.assign(Object.create(Gi),{constructor:NumberKeyframeTrack,ValueTypeName:"number"}),StringKeyframeTrack.prototype=Object.assign(Object.create(Gi),{constructor:StringKeyframeTrack,ValueTypeName:"string",ValueBufferType:Array,DefaultInterpolation:ht,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0}),BooleanKeyframeTrack.prototype=Object.assign(Object.create(Gi),{constructor:BooleanKeyframeTrack,ValueTypeName:"bool",ValueBufferType:Array,DefaultInterpolation:ht,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0}),ColorKeyframeTrack.prototype=Object.assign(Object.create(Gi),{constructor:ColorKeyframeTrack,ValueTypeName:"color"}),(KeyframeTrack.prototype=Gi).constructor=KeyframeTrack,Object.assign(KeyframeTrack,{parse:function(e){if(void 0===e.type)throw new Error("track type undefined, can not parse");var t=KeyframeTrack._getTrackTypeForValueTypeName(e.type);if(void 0===e.times){var r=[],i=[];Ui.flattenJSON(e.keys,r,i,"value"),e.times=r,e.values=i}return void 0!==t.parse?t.parse(e):new t(e.name,e.times,e.values,e.interpolation)},toJSON:function(e){var t,r=e.constructor;if(void 0!==r.toJSON)t=r.toJSON(e);else{t={name:e.name,times:Ui.convertArray(e.times,Array),values:Ui.convertArray(e.values,Array)};var i=e.getInterpolation();i!==e.DefaultInterpolation&&(t.interpolation=i)}return t.type=e.ValueTypeName,t},_getTrackTypeForValueTypeName:function(e){switch(e.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return NumberKeyframeTrack;case"vector":case"vector2":case"vector3":case"vector4":return VectorKeyframeTrack;case"color":return ColorKeyframeTrack;case"quaternion":return QuaternionKeyframeTrack;case"bool":case"boolean":return BooleanKeyframeTrack;case"string":return StringKeyframeTrack}throw new Error("Unsupported typeName: "+e)}}),Object.assign(AnimationClip,{parse:function(e){for(var t=[],r=e.tracks,i=1/(e.fps||1),n=0,a=r.length;n!==a;++n)t.push(KeyframeTrack.parse(r[n]).scale(i));return new AnimationClip(e.name,e.duration,t)},toJSON:function(e){for(var t=[],r=e.tracks,i={name:e.name,duration:e.duration,tracks:t},n=0,a=r.length;n!==a;++n)t.push(KeyframeTrack.toJSON(r[n]));return i},CreateFromMorphTargetSequence:function(e,t,r,i){for(var n=t.length,a=[],o=0;o<n;o++){var s=[],c=[];s.push((o+n-1)%n,o,(o+1)%n),c.push(0,1,0);var l=Ui.getKeyframeOrder(s);s=Ui.sortedArray(s,1,l),c=Ui.sortedArray(c,1,l),i||0!==s[0]||(s.push(n),c.push(c[0])),a.push(new NumberKeyframeTrack(".morphTargetInfluences["+t[o].name+"]",s,c).scale(1/r))}return new AnimationClip(e,-1,a)},findByName:function(e,t){var r=e;if(!Array.isArray(e)){var i=e;r=i.geometry&&i.geometry.animations||i.animations}for(var n=0;n<r.length;n++)if(r[n].name===t)return r[n];return null},CreateClipsFromMorphTargetSequences:function(e,t,r){for(var i={},n=/^([\w-]*?)([\d]+)$/,a=0,o=e.length;a<o;a++){var s=e[a],c=s.name.match(n);if(c&&1<c.length){var l=i[u=c[1]];l||(i[u]=l=[]),l.push(s)}}var h=[];for(var u in i)h.push(AnimationClip.CreateFromMorphTargetSequence(u,i[u],t,r));return h},parseAnimation:function(e,t){if(!e)return console.error("THREE.AnimationClip: No animation in JSONLoader data."),null;for(var r=function(e,t,r,i,n){if(0!==r.length){var a=[],o=[];Ui.flattenJSON(r,a,o,i),0!==a.length&&n.push(new e(t,a,o))}},i=[],n=e.name||"default",a=e.length||-1,o=e.fps||30,s=e.hierarchy||[],c=0;c<s.length;c++){var l=s[c].keys;if(l&&0!==l.length)if(l[0].morphTargets){for(var h={},u=0;u<l.length;u++)if(l[u].morphTargets)for(var d=0;d<l[u].morphTargets.length;d++)h[l[u].morphTargets[d]]=-1;for(var p in h){var f=[],m=[];for(d=0;d!==l[u].morphTargets.length;++d){var g=l[u];f.push(g.time),m.push(g.morphTarget===p?1:0)}i.push(new NumberKeyframeTrack(".morphTargetInfluence["+p+"]",f,m))}a=h.length*(o||1)}else{var v=".bones["+t[c].name+"]";r(VectorKeyframeTrack,v+".position",l,"pos",i),r(QuaternionKeyframeTrack,v+".quaternion",l,"rot",i),r(VectorKeyframeTrack,v+".scale",l,"scl",i)}}return 0===i.length?null:new AnimationClip(n,a,i)}}),Object.assign(AnimationClip.prototype,{resetDuration:function(){for(var e=0,t=0,r=this.tracks.length;t!==r;++t){var i=this.tracks[t];e=Math.max(e,i.times[i.times.length-1])}this.duration=e},trim:function(){for(var e=0;e<this.tracks.length;e++)this.tracks[e].trim(0,this.duration);return this},optimize:function(){for(var e=0;e<this.tracks.length;e++)this.tracks[e].optimize();return this}}),Object.assign(MaterialLoader.prototype,{load:function(e,t,r,i){var n=this;new FileLoader(n.manager).load(e,function(e){t(n.parse(JSON.parse(e)))},r,i)},setTextures:function(e){this.textures=e},parse:function(e){var t=this.textures;function getTexture(e){return void 0===t[e]&&console.warn("THREE.MaterialLoader: Undefined texture",e),t[e]}var r=new Ri[e.type];if(void 0!==e.uuid&&(r.uuid=e.uuid),void 0!==e.name&&(r.name=e.name),void 0!==e.color&&r.color.setHex(e.color),void 0!==e.roughness&&(r.roughness=e.roughness),void 0!==e.metalness&&(r.metalness=e.metalness),void 0!==e.emissive&&r.emissive.setHex(e.emissive),void 0!==e.specular&&r.specular.setHex(e.specular),void 0!==e.shininess&&(r.shininess=e.shininess),void 0!==e.clearCoat&&(r.clearCoat=e.clearCoat),void 0!==e.clearCoatRoughness&&(r.clearCoatRoughness=e.clearCoatRoughness),void 0!==e.uniforms&&(r.uniforms=e.uniforms),void 0!==e.vertexShader&&(r.vertexShader=e.vertexShader),void 0!==e.fragmentShader&&(r.fragmentShader=e.fragmentShader),void 0!==e.vertexColors&&(r.vertexColors=e.vertexColors),void 0!==e.fog&&(r.fog=e.fog),void 0!==e.flatShading&&(r.flatShading=e.flatShading),void 0!==e.blending&&(r.blending=e.blending),void 0!==e.side&&(r.side=e.side),void 0!==e.opacity&&(r.opacity=e.opacity),void 0!==e.transparent&&(r.transparent=e.transparent),void 0!==e.alphaTest&&(r.alphaTest=e.alphaTest),void 0!==e.depthTest&&(r.depthTest=e.depthTest),void 0!==e.depthWrite&&(r.depthWrite=e.depthWrite),void 0!==e.colorWrite&&(r.colorWrite=e.colorWrite),void 0!==e.wireframe&&(r.wireframe=e.wireframe),void 0!==e.wireframeLinewidth&&(r.wireframeLinewidth=e.wireframeLinewidth),void 0!==e.wireframeLinecap&&(r.wireframeLinecap=e.wireframeLinecap),void 0!==e.wireframeLinejoin&&(r.wireframeLinejoin=e.wireframeLinejoin),void 0!==e.rotation&&(r.rotation=e.rotation),1!==e.linewidth&&(r.linewidth=e.linewidth),void 0!==e.dashSize&&(r.dashSize=e.dashSize),void 0!==e.gapSize&&(r.gapSize=e.gapSize),void 0!==e.scale&&(r.scale=e.scale),void 0!==e.skinning&&(r.skinning=e.skinning),void 0!==e.morphTargets&&(r.morphTargets=e.morphTargets),void 0!==e.dithering&&(r.dithering=e.dithering),void 0!==e.visible&&(r.visible=e.visible),void 0!==e.userData&&(r.userData=e.userData),void 0!==e.shading&&(r.flatShading=1===e.shading),void 0!==e.size&&(r.size=e.size),void 0!==e.sizeAttenuation&&(r.sizeAttenuation=e.sizeAttenuation),void 0!==e.map&&(r.map=getTexture(e.map)),void 0!==e.alphaMap&&(r.alphaMap=getTexture(e.alphaMap),r.transparent=!0),void 0!==e.bumpMap&&(r.bumpMap=getTexture(e.bumpMap)),void 0!==e.bumpScale&&(r.bumpScale=e.bumpScale),void 0!==e.normalMap&&(r.normalMap=getTexture(e.normalMap)),void 0!==e.normalScale){var i=e.normalScale;!1===Array.isArray(i)&&(i=[i,i]),r.normalScale=(new Vector2).fromArray(i)}return void 0!==e.displacementMap&&(r.displacementMap=getTexture(e.displacementMap)),void 0!==e.displacementScale&&(r.displacementScale=e.displacementScale),void 0!==e.displacementBias&&(r.displacementBias=e.displacementBias),void 0!==e.roughnessMap&&(r.roughnessMap=getTexture(e.roughnessMap)),void 0!==e.metalnessMap&&(r.metalnessMap=getTexture(e.metalnessMap)),void 0!==e.emissiveMap&&(r.emissiveMap=getTexture(e.emissiveMap)),void 0!==e.emissiveIntensity&&(r.emissiveIntensity=e.emissiveIntensity),void 0!==e.specularMap&&(r.specularMap=getTexture(e.specularMap)),void 0!==e.envMap&&(r.envMap=getTexture(e.envMap)),void 0!==e.reflectivity&&(r.reflectivity=e.reflectivity),void 0!==e.lightMap&&(r.lightMap=getTexture(e.lightMap)),void 0!==e.lightMapIntensity&&(r.lightMapIntensity=e.lightMapIntensity),void 0!==e.aoMap&&(r.aoMap=getTexture(e.aoMap)),void 0!==e.aoMapIntensity&&(r.aoMapIntensity=e.aoMapIntensity),void 0!==e.gradientMap&&(r.gradientMap=getTexture(e.gradientMap)),r}}),Object.assign(BufferGeometryLoader.prototype,{load:function(e,t,r,i){var n=this;new FileLoader(n.manager).load(e,function(e){t(n.parse(JSON.parse(e)))},r,i)},parse:function(e){var t=new BufferGeometry,r=e.data.index;if(void 0!==r){var i=new Hi[r.type](r.array);t.setIndex(new BufferAttribute(i,1))}var n=e.data.attributes;for(var a in n){var o=n[a];i=new Hi[o.type](o.array);t.addAttribute(a,new BufferAttribute(i,o.itemSize,o.normalized))}var s=e.data.groups||e.data.drawcalls||e.data.offsets;if(void 0!==s)for(var c=0,l=s.length;c!==l;++c){var h=s[c];t.addGroup(h.start,h.count,h.materialIndex)}var u=e.data.boundingSphere;if(void 0!==u){var d=new Vector3;void 0!==u.center&&d.fromArray(u.center),t.boundingSphere=new Sphere(d,u.radius)}return t}});var Oi,Vi,Fi,Ni,zi,Hi={Int8Array:Int8Array,Uint8Array:Uint8Array,Uint8ClampedArray:"undefined"!=typeof Uint8ClampedArray?Uint8ClampedArray:Uint8Array,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array};function Loader(){this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){}}function JSONLoader(e){"boolean"==typeof e&&(console.warn("THREE.JSONLoader: showStatus parameter has been removed from constructor."),e=void 0),this.manager=void 0!==e?e:Ii,this.withCredentials=!1}function ObjectLoader(e){this.manager=void 0!==e?e:Ii,this.texturePath=""}Loader.Handlers={handlers:[],add:function(e,t){this.handlers.push(e,t)},get:function(e){for(var t=this.handlers,r=0,i=t.length;r<i;r+=2){var n=t[r],a=t[r+1];if(n.test(e))return a}return null}},Object.assign(Loader.prototype,{crossOrigin:void 0,extractUrlBase:function(e){var t=e.split("/");return 1===t.length?"./":(t.pop(),t.join("/")+"/")},initMaterials:function(e,t,r){for(var i=[],n=0;n<e.length;++n)i[n]=this.createMaterial(e[n],t,r);return i},createMaterial:(Oi={NoBlending:F,NormalBlending:N,AdditiveBlending:z,SubtractiveBlending:H,MultiplyBlending:k,CustomBlending:j},Vi=new Color,Fi=new TextureLoader,Ni=new MaterialLoader,function createMaterial(e,l,h){var u={};function loadTexture(e,t,r,i,n){var a,o=l+e,s=Loader.Handlers.get(o);a=null!==s?s.load(o):(Fi.setCrossOrigin(h),Fi.load(o)),void 0!==t&&(a.repeat.fromArray(t),1!==t[0]&&(a.wrapS=Se),1!==t[1]&&(a.wrapT=Se)),void 0!==r&&a.offset.fromArray(r),void 0!==i&&("repeat"===i[0]&&(a.wrapS=Se),"mirror"===i[0]&&(a.wrapS=Le),"repeat"===i[1]&&(a.wrapT=Se),"mirror"===i[1]&&(a.wrapT=Le)),void 0!==n&&(a.anisotropy=n);var c=Et.generateUUID();return u[c]=a,c}var t={uuid:Et.generateUUID(),type:"MeshLambertMaterial"};for(var r in e){var i=e[r];switch(r){case"DbgColor":case"DbgIndex":case"opticalDensity":case"illumination":break;case"DbgName":t.name=i;break;case"blending":t.blending=Oi[i];break;case"colorAmbient":case"mapAmbient":console.warn("THREE.Loader.createMaterial:",r,"is no longer supported.");break;case"colorDiffuse":t.color=Vi.fromArray(i).getHex();break;case"colorSpecular":t.specular=Vi.fromArray(i).getHex();break;case"colorEmissive":t.emissive=Vi.fromArray(i).getHex();break;case"specularCoef":t.shininess=i;break;case"shading":"basic"===i.toLowerCase()&&(t.type="MeshBasicMaterial"),"phong"===i.toLowerCase()&&(t.type="MeshPhongMaterial"),"standard"===i.toLowerCase()&&(t.type="MeshStandardMaterial");break;case"mapDiffuse":t.map=loadTexture(i,e.mapDiffuseRepeat,e.mapDiffuseOffset,e.mapDiffuseWrap,e.mapDiffuseAnisotropy);break;case"mapDiffuseRepeat":case"mapDiffuseOffset":case"mapDiffuseWrap":case"mapDiffuseAnisotropy":break;case"mapEmissive":t.emissiveMap=loadTexture(i,e.mapEmissiveRepeat,e.mapEmissiveOffset,e.mapEmissiveWrap,e.mapEmissiveAnisotropy);break;case"mapEmissiveRepeat":case"mapEmissiveOffset":case"mapEmissiveWrap":case"mapEmissiveAnisotropy":break;case"mapLight":t.lightMap=loadTexture(i,e.mapLightRepeat,e.mapLightOffset,e.mapLightWrap,e.mapLightAnisotropy);break;case"mapLightRepeat":case"mapLightOffset":case"mapLightWrap":case"mapLightAnisotropy":break;case"mapAO":t.aoMap=loadTexture(i,e.mapAORepeat,e.mapAOOffset,e.mapAOWrap,e.mapAOAnisotropy);break;case"mapAORepeat":case"mapAOOffset":case"mapAOWrap":case"mapAOAnisotropy":break;case"mapBump":t.bumpMap=loadTexture(i,e.mapBumpRepeat,e.mapBumpOffset,e.mapBumpWrap,e.mapBumpAnisotropy);break;case"mapBumpScale":t.bumpScale=i;break;case"mapBumpRepeat":case"mapBumpOffset":case"mapBumpWrap":case"mapBumpAnisotropy":break;case"mapNormal":t.normalMap=loadTexture(i,e.mapNormalRepeat,e.mapNormalOffset,e.mapNormalWrap,e.mapNormalAnisotropy);break;case"mapNormalFactor":t.normalScale=[i,i];break;case"mapNormalRepeat":case"mapNormalOffset":case"mapNormalWrap":case"mapNormalAnisotropy":break;case"mapSpecular":t.specularMap=loadTexture(i,e.mapSpecularRepeat,e.mapSpecularOffset,e.mapSpecularWrap,e.mapSpecularAnisotropy);break;case"mapSpecularRepeat":case"mapSpecularOffset":case"mapSpecularWrap":case"mapSpecularAnisotropy":break;case"mapMetalness":t.metalnessMap=loadTexture(i,e.mapMetalnessRepeat,e.mapMetalnessOffset,e.mapMetalnessWrap,e.mapMetalnessAnisotropy);break;case"mapMetalnessRepeat":case"mapMetalnessOffset":case"mapMetalnessWrap":case"mapMetalnessAnisotropy":break;case"mapRoughness":t.roughnessMap=loadTexture(i,e.mapRoughnessRepeat,e.mapRoughnessOffset,e.mapRoughnessWrap,e.mapRoughnessAnisotropy);break;case"mapRoughnessRepeat":case"mapRoughnessOffset":case"mapRoughnessWrap":case"mapRoughnessAnisotropy":break;case"mapAlpha":t.alphaMap=loadTexture(i,e.mapAlphaRepeat,e.mapAlphaOffset,e.mapAlphaWrap,e.mapAlphaAnisotropy);break;case"mapAlphaRepeat":case"mapAlphaOffset":case"mapAlphaWrap":case"mapAlphaAnisotropy":break;case"flipSided":t.side=X;break;case"doubleSided":t.side=q;break;case"transparency":console.warn("THREE.Loader.createMaterial: transparency has been renamed to opacity"),t.opacity=i;break;case"depthTest":case"depthWrite":case"colorWrite":case"opacity":case"reflectivity":case"transparent":case"visible":case"wireframe":t[r]=i;break;case"vertexColors":!0===i&&(t.vertexColors=E),"face"===i&&(t.vertexColors=1);break;default:console.error("THREE.Loader.createMaterial: Unsupported",r,i)}}return"MeshBasicMaterial"===t.type&&delete t.emissive,"MeshPhongMaterial"!==t.type&&delete t.specular,t.opacity<1&&(t.transparent=!0),Ni.setTextures(u),Ni.parse(t)})}),Object.assign(JSONLoader.prototype,{load:function(a,o,e,t){var s=this,c=this.texturePath&&"string"==typeof this.texturePath?this.texturePath:Loader.prototype.extractUrlBase(a),r=new FileLoader(this.manager);r.setWithCredentials(this.withCredentials),r.load(a,function(e){var t=JSON.parse(e),r=t.metadata;if(void 0!==r){var i=r.type;if(void 0!==i){if("object"===i.toLowerCase())return void console.error("THREE.JSONLoader: "+a+" should be loaded with THREE.ObjectLoader instead.");if("scene"===i.toLowerCase())return void console.error("THREE.JSONLoader: "+a+" should be loaded with THREE.SceneLoader instead.")}}var n=s.parse(t,c);o(n.geometry,n.materials)},e,t)},setTexturePath:function(e){this.texturePath=e},parse:function(e,t){void 0!==e.data&&(e=e.data),void 0!==e.scale?e.scale=1/e.scale:e.scale=1;var r=new Geometry;return function parseModel(e,t){function isBitSet(e,t){return e&1<<t}var r,i,n,a,o,s,c,l,h,u,d,p,f,m,g,v,y,x,b,M,_,w,T,E,S,A=e.faces,L=e.vertices,C=e.normals,P=e.colors,R=e.scale,B=0;if(void 0!==e.uvs){for(r=0;r<e.uvs.length;r++)e.uvs[r].length&&B++;for(r=0;r<B;r++)t.faceVertexUvs[r]=[]}for(a=0,o=L.length;a<o;)(x=new Vector3).x=L[a++]*R,x.y=L[a++]*R,x.z=L[a++]*R,t.vertices.push(x);for(a=0,o=A.length;a<o;)if(d=isBitSet(u=A[a++],0),p=isBitSet(u,1),f=isBitSet(u,3),m=isBitSet(u,4),g=isBitSet(u,5),v=isBitSet(u,6),y=isBitSet(u,7),d){if((M=new Face3).a=A[a],M.b=A[a+1],M.c=A[a+3],(_=new Face3).a=A[a+1],_.b=A[a+2],_.c=A[a+3],a+=4,p&&(h=A[a++],M.materialIndex=h,_.materialIndex=h),n=t.faces.length,f)for(r=0;r<B;r++)for(E=e.uvs[r],t.faceVertexUvs[r][n]=[],t.faceVertexUvs[r][n+1]=[],i=0;i<4;i++)S=new Vector2(E[2*(l=A[a++])],E[2*l+1]),2!==i&&t.faceVertexUvs[r][n].push(S),0!==i&&t.faceVertexUvs[r][n+1].push(S);if(m&&(c=3*A[a++],M.normal.set(C[c++],C[c++],C[c]),_.normal.copy(M.normal)),g)for(r=0;r<4;r++)c=3*A[a++],T=new Vector3(C[c++],C[c++],C[c]),2!==r&&M.vertexNormals.push(T),0!==r&&_.vertexNormals.push(T);if(v&&(w=P[s=A[a++]],M.color.setHex(w),_.color.setHex(w)),y)for(r=0;r<4;r++)w=P[s=A[a++]],2!==r&&M.vertexColors.push(new Color(w)),0!==r&&_.vertexColors.push(new Color(w));t.faces.push(M),t.faces.push(_)}else{if((b=new Face3).a=A[a++],b.b=A[a++],b.c=A[a++],p&&(h=A[a++],b.materialIndex=h),n=t.faces.length,f)for(r=0;r<B;r++)for(E=e.uvs[r],t.faceVertexUvs[r][n]=[],i=0;i<3;i++)S=new Vector2(E[2*(l=A[a++])],E[2*l+1]),t.faceVertexUvs[r][n].push(S);if(m&&(c=3*A[a++],b.normal.set(C[c++],C[c++],C[c])),g)for(r=0;r<3;r++)c=3*A[a++],T=new Vector3(C[c++],C[c++],C[c]),b.vertexNormals.push(T);if(v&&(s=A[a++],b.color.setHex(P[s])),y)for(r=0;r<3;r++)s=A[a++],b.vertexColors.push(new Color(P[s]));t.faces.push(b)}}(e,r),function parseSkin(e,t){var r=void 0!==e.influencesPerVertex?e.influencesPerVertex:2;if(e.skinWeights)for(var i=0,n=e.skinWeights.length;i<n;i+=r){var a=e.skinWeights[i],o=1<r?e.skinWeights[i+1]:0,s=2<r?e.skinWeights[i+2]:0,c=3<r?e.skinWeights[i+3]:0;t.skinWeights.push(new Vector4(a,o,s,c))}if(e.skinIndices)for(i=0,n=e.skinIndices.length;i<n;i+=r){var l=e.skinIndices[i],h=1<r?e.skinIndices[i+1]:0,u=2<r?e.skinIndices[i+2]:0,d=3<r?e.skinIndices[i+3]:0;t.skinIndices.push(new Vector4(l,h,u,d))}t.bones=e.bones,t.bones&&0<t.bones.length&&(t.skinWeights.length!==t.skinIndices.length||t.skinIndices.length!==t.vertices.length)&&console.warn("When skinning, number of vertices ("+t.vertices.length+"), skinIndices ("+t.skinIndices.length+"), and skinWeights ("+t.skinWeights.length+") should match.")}(e,r),function parseMorphing(e,t){var r=e.scale;if(void 0!==e.morphTargets)for(var i=0,n=e.morphTargets.length;i<n;i++){t.morphTargets[i]={},t.morphTargets[i].name=e.morphTargets[i].name,t.morphTargets[i].vertices=[];for(var a=t.morphTargets[i].vertices,o=e.morphTargets[i].vertices,s=0,c=o.length;s<c;s+=3){var l=new Vector3;l.x=o[s]*r,l.y=o[s+1]*r,l.z=o[s+2]*r,a.push(l)}}if(void 0!==e.morphColors&&0<e.morphColors.length){console.warn('THREE.JSONLoader: "morphColors" no longer supported. Using them as face colors.');var h=t.faces,u=e.morphColors[0].colors;for(i=0,n=h.length;i<n;i++)h[i].color.fromArray(u,3*i)}}(e,r),function parseAnimations(e,t){var r=[],i=[];void 0!==e.animation&&i.push(e.animation),void 0!==e.animations&&(e.animations.length?i=i.concat(e.animations):i.push(e.animations));for(var n=0;n<i.length;n++){var a=AnimationClip.parseAnimation(i[n],t.bones);a&&r.push(a)}if(t.morphTargets){var o=AnimationClip.CreateClipsFromMorphTargetSequences(t.morphTargets,10);r=r.concat(o)}0<r.length&&(t.animations=r)}(e,r),r.computeFaceNormals(),r.computeBoundingSphere(),void 0===e.materials||0===e.materials.length?{geometry:r}:{geometry:r,materials:Loader.prototype.initMaterials(e.materials,t,this.crossOrigin)}}}),Object.assign(ObjectLoader.prototype,{load:function(i,n,e,a){""===this.texturePath&&(this.texturePath=i.substring(0,i.lastIndexOf("/")+1));var o=this;new FileLoader(o.manager).load(i,function(e){var t=null;try{t=JSON.parse(e)}catch(e){return void 0!==a&&a(e),void console.error("THREE:ObjectLoader: Can't parse "+i+".",e.message)}var r=t.metadata;void 0!==r&&void 0!==r.type&&"geometry"!==r.type.toLowerCase()?o.parse(t,n):console.error("THREE.ObjectLoader: Can't load "+i+". Use THREE.JSONLoader instead.")},e,a)},setTexturePath:function(e){this.texturePath=e},setCrossOrigin:function(e){this.crossOrigin=e},parse:function(e,t){var r=this.parseGeometries(e.geometries),i=this.parseImages(e.images,function(){void 0!==t&&t(o)}),n=this.parseTextures(e.textures,i),a=this.parseMaterials(e.materials,n),o=this.parseObject(e.object,r,a);return e.animations&&(o.animations=this.parseAnimations(e.animations)),void 0!==e.images&&0!==e.images.length||void 0!==t&&t(o),o},parseGeometries:function(e){var t={};if(void 0!==e)for(var r=new JSONLoader,i=new BufferGeometryLoader,n=0,a=e.length;n<a;n++){var o,s=e[n];switch(s.type){case"PlaneGeometry":case"PlaneBufferGeometry":o=new Pi[s.type](s.width,s.height,s.widthSegments,s.heightSegments);break;case"BoxGeometry":case"BoxBufferGeometry":case"CubeGeometry":o=new Pi[s.type](s.width,s.height,s.depth,s.widthSegments,s.heightSegments,s.depthSegments);break;case"CircleGeometry":case"CircleBufferGeometry":o=new Pi[s.type](s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CylinderGeometry":case"CylinderBufferGeometry":o=new Pi[s.type](s.radiusTop,s.radiusBottom,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);break;case"ConeGeometry":case"ConeBufferGeometry":o=new Pi[s.type](s.radius,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);break;case"SphereGeometry":case"SphereBufferGeometry":o=new Pi[s.type](s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"DodecahedronGeometry":case"DodecahedronBufferGeometry":case"IcosahedronGeometry":case"IcosahedronBufferGeometry":case"OctahedronGeometry":case"OctahedronBufferGeometry":case"TetrahedronGeometry":case"TetrahedronBufferGeometry":o=new Pi[s.type](s.radius,s.detail);break;case"RingGeometry":case"RingBufferGeometry":o=new Pi[s.type](s.innerRadius,s.outerRadius,s.thetaSegments,s.phiSegments,s.thetaStart,s.thetaLength);break;case"TorusGeometry":case"TorusBufferGeometry":o=new Pi[s.type](s.radius,s.tube,s.radialSegments,s.tubularSegments,s.arc);break;case"TorusKnotGeometry":case"TorusKnotBufferGeometry":o=new Pi[s.type](s.radius,s.tube,s.tubularSegments,s.radialSegments,s.p,s.q);break;case"LatheGeometry":case"LatheBufferGeometry":o=new Pi[s.type](s.points,s.segments,s.phiStart,s.phiLength);break;case"PolyhedronGeometry":case"PolyhedronBufferGeometry":o=new Pi[s.type](s.vertices,s.indices,s.radius,s.details);break;case"BufferGeometry":o=i.parse(s);break;case"Geometry":o=r.parse(s,this.texturePath).geometry;break;default:console.warn('THREE.ObjectLoader: Unsupported geometry type "'+s.type+'"');continue}o.uuid=s.uuid,void 0!==s.name&&(o.name=s.name),t[s.uuid]=o}return t},parseMaterials:function(e,t){var r={};if(void 0!==e){var i=new MaterialLoader;i.setTextures(t);for(var n=0,a=e.length;n<a;n++){var o=e[n];if("MultiMaterial"===o.type){for(var s=[],c=0;c<o.materials.length;c++)s.push(i.parse(o.materials[c]));r[o.uuid]=s}else r[o.uuid]=i.parse(o)}}return r},parseAnimations:function(e){for(var t=[],r=0;r<e.length;r++){var i=AnimationClip.parse(e[r]);t.push(i)}return t},parseImages:function(e,t){var r=this,i={};function loadImage(e){return r.manager.itemStart(e),n.load(e,function(){r.manager.itemEnd(e)},void 0,function(){r.manager.itemEnd(e),r.manager.itemError(e)})}if(void 0!==e&&0<e.length){var n=new ImageLoader(new LoadingManager(t));n.setCrossOrigin(this.crossOrigin);for(var a=0,o=e.length;a<o;a++){var s=e[a],c=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(s.url)?s.url:r.texturePath+s.url;i[s.uuid]=loadImage(c)}}return i},parseTextures:function(e,t){function parseConstant(e,t){return"number"==typeof e?e:(console.warn("THREE.ObjectLoader.parseTexture: Constant should be in numeric form.",e),t[e])}var r={};if(void 0!==e)for(var i=0,n=e.length;i<n;i++){var a=e[i];void 0===a.image&&console.warn('THREE.ObjectLoader: No "image" specified for',a.uuid),void 0===t[a.image]&&console.warn("THREE.ObjectLoader: Undefined image",a.image);var o=new Texture(t[a.image]);o.needsUpdate=!0,o.uuid=a.uuid,void 0!==a.name&&(o.name=a.name),void 0!==a.mapping&&(o.mapping=parseConstant(a.mapping,ki)),void 0!==a.offset&&o.offset.fromArray(a.offset),void 0!==a.repeat&&o.repeat.fromArray(a.repeat),void 0!==a.center&&o.center.fromArray(a.center),void 0!==a.rotation&&(o.rotation=a.rotation),void 0!==a.wrap&&(o.wrapS=parseConstant(a.wrap[0],ji),o.wrapT=parseConstant(a.wrap[1],ji)),void 0!==a.minFilter&&(o.minFilter=parseConstant(a.minFilter,Wi)),void 0!==a.magFilter&&(o.magFilter=parseConstant(a.magFilter,Wi)),void 0!==a.anisotropy&&(o.anisotropy=a.anisotropy),void 0!==a.flipY&&(o.flipY=a.flipY),r[a.uuid]=o}return r},parseObject:(zi=new Matrix4,function parseObject(e,t,a){var r;function getGeometry(e){return void 0===t[e]&&console.warn("THREE.ObjectLoader: Undefined geometry",e),t[e]}function getMaterial(e){if(void 0!==e){if(Array.isArray(e)){for(var t=[],r=0,i=e.length;r<i;r++){var n=e[r];void 0===a[n]&&console.warn("THREE.ObjectLoader: Undefined material",n),t.push(a[n])}return t}return void 0===a[e]&&console.warn("THREE.ObjectLoader: Undefined material",e),a[e]}}switch(e.type){case"Scene":r=new Scene,void 0!==e.background&&Number.isInteger(e.background)&&(r.background=new Color(e.background)),void 0!==e.fog&&("Fog"===e.fog.type?r.fog=new Fog(e.fog.color,e.fog.near,e.fog.far):"FogExp2"===e.fog.type&&(r.fog=new FogExp2(e.fog.color,e.fog.density)));break;case"PerspectiveCamera":r=new PerspectiveCamera(e.fov,e.aspect,e.near,e.far),void 0!==e.focus&&(r.focus=e.focus),void 0!==e.zoom&&(r.zoom=e.zoom),void 0!==e.filmGauge&&(r.filmGauge=e.filmGauge),void 0!==e.filmOffset&&(r.filmOffset=e.filmOffset),void 0!==e.view&&(r.view=Object.assign({},e.view));break;case"OrthographicCamera":r=new OrthographicCamera(e.left,e.right,e.top,e.bottom,e.near,e.far);break;case"AmbientLight":r=new AmbientLight(e.color,e.intensity);break;case"DirectionalLight":r=new DirectionalLight(e.color,e.intensity);break;case"PointLight":r=new PointLight(e.color,e.intensity,e.distance,e.decay);break;case"RectAreaLight":r=new RectAreaLight(e.color,e.intensity,e.width,e.height);break;case"SpotLight":r=new SpotLight(e.color,e.intensity,e.distance,e.angle,e.penumbra,e.decay);break;case"HemisphereLight":r=new HemisphereLight(e.color,e.groundColor,e.intensity);break;case"SkinnedMesh":console.warn("THREE.ObjectLoader.parseObject() does not support SkinnedMesh yet.");case"Mesh":var i=getGeometry(e.geometry),n=getMaterial(e.material);r=i.bones&&0<i.bones.length?new SkinnedMesh(i,n):new Mesh(i,n);break;case"LOD":r=new LOD;break;case"Line":r=new Line(getGeometry(e.geometry),getMaterial(e.material),e.mode);break;case"LineLoop":r=new LineLoop(getGeometry(e.geometry),getMaterial(e.material));break;case"LineSegments":r=new LineSegments(getGeometry(e.geometry),getMaterial(e.material));break;case"PointCloud":case"Points":r=new Points(getGeometry(e.geometry),getMaterial(e.material));break;case"Sprite":r=new Sprite(getMaterial(e.material));break;case"Group":r=new Group;break;default:r=new Object3D}if(r.uuid=e.uuid,void 0!==e.name&&(r.name=e.name),void 0!==e.matrix?(zi.fromArray(e.matrix),zi.decompose(r.position,r.quaternion,r.scale)):(void 0!==e.position&&r.position.fromArray(e.position),void 0!==e.rotation&&r.rotation.fromArray(e.rotation),void 0!==e.quaternion&&r.quaternion.fromArray(e.quaternion),void 0!==e.scale&&r.scale.fromArray(e.scale)),void 0!==e.castShadow&&(r.castShadow=e.castShadow),void 0!==e.receiveShadow&&(r.receiveShadow=e.receiveShadow),e.shadow&&(void 0!==e.shadow.bias&&(r.shadow.bias=e.shadow.bias),void 0!==e.shadow.radius&&(r.shadow.radius=e.shadow.radius),void 0!==e.shadow.mapSize&&r.shadow.mapSize.fromArray(e.shadow.mapSize),void 0!==e.shadow.camera&&(r.shadow.camera=this.parseObject(e.shadow.camera))),void 0!==e.visible&&(r.visible=e.visible),void 0!==e.userData&&(r.userData=e.userData),void 0!==e.children)for(var o=e.children,s=0;s<o.length;s++)r.add(this.parseObject(o[s],t,a));if("LOD"===e.type)for(var c=e.levels,l=0;l<c.length;l++){var h=c[l],u=r.getObjectByProperty("uuid",h.object);void 0!==u&&r.addLevel(u,h.distance)}return r})});var ki={UVMapping:300,CubeReflectionMapping:xe,CubeRefractionMapping:be,EquirectangularReflectionMapping:Me,EquirectangularRefractionMapping:_e,SphericalReflectionMapping:we,CubeUVReflectionMapping:Te,CubeUVRefractionMapping:Ee},ji={RepeatWrapping:Se,ClampToEdgeWrapping:Ae,MirroredRepeatWrapping:Le},Wi={NearestFilter:Ce,NearestMipMapNearestFilter:Pe,NearestMipMapLinearFilter:Re,LinearFilter:Be,LinearMipMapNearestFilter:Ie,LinearMipMapLinearFilter:De};function CatmullRom(e,t,r,i,n){var a=.5*(i-t),o=.5*(n-r),s=e*e;return(2*r-2*i+a+o)*(e*s)+(-3*r+3*i-2*a-o)*s+a*e+r}function QuadraticBezier(e,t,r,i){return function QuadraticBezierP0(e,t){var r=1-e;return r*r*t}(e,t)+function QuadraticBezierP1(e,t){return 2*(1-e)*e*t}(e,r)+function QuadraticBezierP2(e,t){return e*e*t}(e,i)}function CubicBezier(e,t,r,i,n){return function CubicBezierP0(e,t){var r=1-e;return r*r*r*t}(e,t)+function CubicBezierP1(e,t){var r=1-e;return 3*r*r*e*t}(e,r)+function CubicBezierP2(e,t){return 3*(1-e)*e*e*t}(e,i)+function CubicBezierP3(e,t){return e*e*e*t}(e,n)}function Curve(){this.type="Curve",this.arcLengthDivisions=200}function LineCurve(e,t){Curve.call(this),this.type="LineCurve",this.v1=e||new Vector2,this.v2=t||new Vector2}function CurvePath(){Curve.call(this),this.type="CurvePath",this.curves=[],this.autoClose=!1}function EllipseCurve(e,t,r,i,n,a,o,s){Curve.call(this),this.type="EllipseCurve",this.aX=e||0,this.aY=t||0,this.xRadius=r||1,this.yRadius=i||1,this.aStartAngle=n||0,this.aEndAngle=a||2*Math.PI,this.aClockwise=o||!1,this.aRotation=s||0}function SplineCurve(e){Curve.call(this),this.type="SplineCurve",this.points=e||[]}function CubicBezierCurve(e,t,r,i){Curve.call(this),this.type="CubicBezierCurve",this.v0=e||new Vector2,this.v1=t||new Vector2,this.v2=r||new Vector2,this.v3=i||new Vector2}function QuadraticBezierCurve(e,t,r){Curve.call(this),this.type="QuadraticBezierCurve",this.v0=e||new Vector2,this.v1=t||new Vector2,this.v2=r||new Vector2}Object.assign(Curve.prototype,{getPoint:function(){return console.warn("THREE.Curve: .getPoint() not implemented."),null},getPointAt:function(e,t){var r=this.getUtoTmapping(e);return this.getPoint(r,t)},getPoints:function(e){void 0===e&&(e=5);for(var t=[],r=0;r<=e;r++)t.push(this.getPoint(r/e));return t},getSpacedPoints:function(e){void 0===e&&(e=5);for(var t=[],r=0;r<=e;r++)t.push(this.getPointAt(r/e));return t},getLength:function(){var e=this.getLengths();return e[e.length-1]},getLengths:function(e){if(void 0===e&&(e=this.arcLengthDivisions),this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var t,r,i=[],n=this.getPoint(0),a=0;for(i.push(0),r=1;r<=e;r++)a+=(t=this.getPoint(r/e)).distanceTo(n),i.push(a),n=t;return this.cacheArcLengths=i},updateArcLengths:function(){this.needsUpdate=!0,this.getLengths()},getUtoTmapping:function(e,t){var r,i=this.getLengths(),n=0,a=i.length;r=t||e*i[a-1];for(var o,s=0,c=a-1;s<=c;)if((o=i[n=Math.floor(s+(c-s)/2)]-r)<0)s=n+1;else{if(!(0<o)){c=n;break}c=n-1}if(i[n=c]===r)return n/(a-1);var l=i[n];return(n+(r-l)/(i[n+1]-l))/(a-1)},getTangent:function(e){var t=e-1e-4,r=e+1e-4;t<0&&(t=0),1<r&&(r=1);var i=this.getPoint(t);return this.getPoint(r).clone().sub(i).normalize()},getTangentAt:function(e){var t=this.getUtoTmapping(e);return this.getTangent(t)},computeFrenetFrames:function(e,t){var r,i,n,a=new Vector3,o=[],s=[],c=[],l=new Vector3,h=new Matrix4;for(r=0;r<=e;r++)i=r/e,o[r]=this.getTangentAt(i),o[r].normalize();s[0]=new Vector3,c[0]=new Vector3;var u=Number.MAX_VALUE,d=Math.abs(o[0].x),p=Math.abs(o[0].y),f=Math.abs(o[0].z);for(d<=u&&(u=d,a.set(1,0,0)),p<=u&&(u=p,a.set(0,1,0)),f<=u&&a.set(0,0,1),l.crossVectors(o[0],a).normalize(),s[0].crossVectors(o[0],l),c[0].crossVectors(o[0],s[0]),r=1;r<=e;r++)s[r]=s[r-1].clone(),c[r]=c[r-1].clone(),l.crossVectors(o[r-1],o[r]),l.length()>Number.EPSILON&&(l.normalize(),n=Math.acos(Et.clamp(o[r-1].dot(o[r]),-1,1)),s[r].applyMatrix4(h.makeRotationAxis(l,n))),c[r].crossVectors(o[r],s[r]);if(!0===t)for(n=Math.acos(Et.clamp(s[0].dot(s[e]),-1,1)),n/=e,0<o[0].dot(l.crossVectors(s[0],s[e]))&&(n=-n),r=1;r<=e;r++)s[r].applyMatrix4(h.makeRotationAxis(o[r],n*r)),c[r].crossVectors(o[r],s[r]);return{tangents:o,normals:s,binormals:c}},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}}),((LineCurve.prototype=Object.create(Curve.prototype)).constructor=LineCurve).prototype.isLineCurve=!0,LineCurve.prototype.getPoint=function(e,t){var r=t||new Vector2;return 1===e?r.copy(this.v2):(r.copy(this.v2).sub(this.v1),r.multiplyScalar(e).add(this.v1)),r},LineCurve.prototype.getPointAt=function(e,t){return this.getPoint(e,t)},LineCurve.prototype.getTangent=function(){return this.v2.clone().sub(this.v1).normalize()},LineCurve.prototype.copy=function(e){return Curve.prototype.copy.call(this,e),this.v1.copy(e.v1),this.v2.copy(e.v2),this},CurvePath.prototype=Object.assign(Object.create(Curve.prototype),{constructor:CurvePath,add:function(e){this.curves.push(e)},closePath:function(){var e=this.curves[0].getPoint(0),t=this.curves[this.curves.length-1].getPoint(1);e.equals(t)||this.curves.push(new LineCurve(t,e))},getPoint:function(e){for(var t=e*this.getLength(),r=this.getCurveLengths(),i=0;i<r.length;){if(r[i]>=t){var n=r[i]-t,a=this.curves[i],o=a.getLength(),s=0===o?0:1-n/o;return a.getPointAt(s)}i++}return null},getLength:function(){var e=this.getCurveLengths();return e[e.length-1]},updateArcLengths:function(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()},getCurveLengths:function(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;for(var e=[],t=0,r=0,i=this.curves.length;r<i;r++)t+=this.curves[r].getLength(),e.push(t);return this.cacheLengths=e},getSpacedPoints:function(e){void 0===e&&(e=40);for(var t=[],r=0;r<=e;r++)t.push(this.getPoint(r/e));return this.autoClose&&t.push(t[0]),t},getPoints:function(e){e=e||12;for(var t,r=[],i=0,n=this.curves;i<n.length;i++)for(var a=n[i],o=a&&a.isEllipseCurve?2*e:a&&a.isLineCurve?1:a&&a.isSplineCurve?e*a.points.length:e,s=a.getPoints(o),c=0;c<s.length;c++){var l=s[c];t&&t.equals(l)||(r.push(l),t=l)}return this.autoClose&&1<r.length&&!r[r.length-1].equals(r[0])&&r.push(r[0]),r},copy:function(e){Curve.prototype.copy.call(this,e),this.curves=[];for(var t=0,r=e.curves.length;t<r;t++){var i=e.curves[t];this.curves.push(i.clone())}return this.autoClose=e.autoClose,this}}),((EllipseCurve.prototype=Object.create(Curve.prototype)).constructor=EllipseCurve).prototype.isEllipseCurve=!0,EllipseCurve.prototype.getPoint=function(e,t){for(var r=t||new Vector2,i=2*Math.PI,n=this.aEndAngle-this.aStartAngle,a=Math.abs(n)<Number.EPSILON;n<0;)n+=i;for(;i<n;)n-=i;n<Number.EPSILON&&(n=a?0:i),!0!==this.aClockwise||a||(n===i?n=-i:n-=i);var o=this.aStartAngle+e*n,s=this.aX+this.xRadius*Math.cos(o),c=this.aY+this.yRadius*Math.sin(o);if(0!==this.aRotation){var l=Math.cos(this.aRotation),h=Math.sin(this.aRotation),u=s-this.aX,d=c-this.aY;s=u*l-d*h+this.aX,c=u*h+d*l+this.aY}return r.set(s,c)},EllipseCurve.prototype.copy=function(e){return Curve.prototype.copy.call(this,e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this},((SplineCurve.prototype=Object.create(Curve.prototype)).constructor=SplineCurve).prototype.isSplineCurve=!0,SplineCurve.prototype.getPoint=function(e,t){var r=t||new Vector2,i=this.points,n=(i.length-1)*e,a=Math.floor(n),o=n-a,s=i[0===a?a:a-1],c=i[a],l=i[a>i.length-2?i.length-1:a+1],h=i[a>i.length-3?i.length-1:a+2];return r.set(CatmullRom(o,s.x,c.x,l.x,h.x),CatmullRom(o,s.y,c.y,l.y,h.y)),r},SplineCurve.prototype.copy=function(e){Curve.prototype.copy.call(this,e),this.points=[];for(var t=0,r=e.points.length;t<r;t++){var i=e.points[t];this.points.push(i.clone())}return this},((CubicBezierCurve.prototype=Object.create(Curve.prototype)).constructor=CubicBezierCurve).prototype.isCubicBezierCurve=!0,CubicBezierCurve.prototype.getPoint=function(e,t){var r=t||new Vector2,i=this.v0,n=this.v1,a=this.v2,o=this.v3;return r.set(CubicBezier(e,i.x,n.x,a.x,o.x),CubicBezier(e,i.y,n.y,a.y,o.y)),r},CubicBezierCurve.prototype.copy=function(e){return Curve.prototype.copy.call(this,e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this},((QuadraticBezierCurve.prototype=Object.create(Curve.prototype)).constructor=QuadraticBezierCurve).prototype.isQuadraticBezierCurve=!0,QuadraticBezierCurve.prototype.getPoint=function(e,t){var r=t||new Vector2,i=this.v0,n=this.v1,a=this.v2;return r.set(QuadraticBezier(e,i.x,n.x,a.x),QuadraticBezier(e,i.y,n.y,a.y)),r},QuadraticBezierCurve.prototype.copy=function(e){return Curve.prototype.copy.call(this,e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this};var Xi,qi=Object.assign(Object.create(CurvePath.prototype),{setFromPoints:function(e){this.moveTo(e[0].x,e[0].y);for(var t=1,r=e.length;t<r;t++)this.lineTo(e[t].x,e[t].y)},moveTo:function(e,t){this.currentPoint.set(e,t)},lineTo:function(e,t){var r=new LineCurve(this.currentPoint.clone(),new Vector2(e,t));this.curves.push(r),this.currentPoint.set(e,t)},quadraticCurveTo:function(e,t,r,i){var n=new QuadraticBezierCurve(this.currentPoint.clone(),new Vector2(e,t),new Vector2(r,i));this.curves.push(n),this.currentPoint.set(r,i)},bezierCurveTo:function(e,t,r,i,n,a){var o=new CubicBezierCurve(this.currentPoint.clone(),new Vector2(e,t),new Vector2(r,i),new Vector2(n,a));this.curves.push(o),this.currentPoint.set(n,a)},splineThru:function(e){var t=new SplineCurve([this.currentPoint.clone()].concat(e));this.curves.push(t),this.currentPoint.copy(e[e.length-1])},arc:function(e,t,r,i,n,a){var o=this.currentPoint.x,s=this.currentPoint.y;this.absarc(e+o,t+s,r,i,n,a)},absarc:function(e,t,r,i,n,a){this.absellipse(e,t,r,r,i,n,a)},ellipse:function(e,t,r,i,n,a,o,s){var c=this.currentPoint.x,l=this.currentPoint.y;this.absellipse(e+c,t+l,r,i,n,a,o,s)},absellipse:function(e,t,r,i,n,a,o,s){var c=new EllipseCurve(e,t,r,i,n,a,o,s);if(0<this.curves.length){var l=c.getPoint(0);l.equals(this.currentPoint)||this.lineTo(l.x,l.y)}this.curves.push(c);var h=c.getPoint(1);this.currentPoint.copy(h)},copy:function(e){return CurvePath.prototype.copy.call(this,e),this.currentPoint.copy(e.currentPoint),this}});function Path(e){CurvePath.call(this),this.type="Path",this.currentPoint=new Vector2,e&&this.setFromPoints(e)}function Shape(e){Path.call(this,e),this.type="Shape",this.holes=[]}function ShapePath(){this.type="ShapePath",this.subPaths=[],this.currentPath=null}function Font(e){this.type="Font",this.data=e}function FontLoader(e){this.manager=void 0!==e?e:Ii}(Path.prototype=qi).constructor=Path,Shape.prototype=Object.assign(Object.create(qi),{constructor:Shape,getPointsHoles:function(e){for(var t=[],r=0,i=this.holes.length;r<i;r++)t[r]=this.holes[r].getPoints(e);return t},extractPoints:function(e){return{shape:this.getPoints(e),holes:this.getPointsHoles(e)}},copy:function(e){Path.prototype.copy.call(this,e),this.holes=[];for(var t=0,r=e.holes.length;t<r;t++){var i=e.holes[t];this.holes.push(i.clone())}return this}}),Object.assign(ShapePath.prototype,{moveTo:function(e,t){this.currentPath=new Path,this.subPaths.push(this.currentPath),this.currentPath.moveTo(e,t)},lineTo:function(e,t){this.currentPath.lineTo(e,t)},quadraticCurveTo:function(e,t,r,i){this.currentPath.quadraticCurveTo(e,t,r,i)},bezierCurveTo:function(e,t,r,i,n,a){this.currentPath.bezierCurveTo(e,t,r,i,n,a)},splineThru:function(e){this.currentPath.splineThru(e)},toShapes:function(e,t){function toShapesNoHoles(e){for(var t=[],r=0,i=e.length;r<i;r++){var n=e[r],a=new Shape;a.curves=n.curves,t.push(a)}return t}function isPointInsidePolygon(e,t){for(var r=t.length,i=!1,n=r-1,a=0;a<r;n=a++){var o=t[n],s=t[a],c=s.x-o.x,l=s.y-o.y;if(Math.abs(l)>Number.EPSILON){if(l<0&&(o=t[a],c=-c,s=t[n],l=-l),e.y<o.y||e.y>s.y)continue;if(e.y===o.y){if(e.x===o.x)return!0}else{var h=l*(e.x-o.x)-c*(e.y-o.y);if(0===h)return!0;if(h<0)continue;i=!i}}else{if(e.y!==o.y)continue;if(s.x<=e.x&&e.x<=o.x||o.x<=e.x&&e.x<=s.x)return!0}}return i}var r=Ci.isClockWise,i=this.subPaths;if(0===i.length)return[];if(!0===t)return toShapesNoHoles(i);var n,a,o,s=[];if(1===i.length)return a=i[0],(o=new Shape).curves=a.curves,s.push(o),s;var c=!r(i[0].getPoints());c=e?!c:c;var l,h,u=[],d=[],p=[],f=0;d[f]=void 0,p[f]=[];for(var m=0,g=i.length;m<g;m++)n=r(l=(a=i[m]).getPoints()),(n=e?!n:n)?(!c&&d[f]&&f++,d[f]={s:new Shape,p:l},d[f].s.curves=a.curves,c&&f++,p[f]=[]):p[f].push({h:a,p:l[0]});if(!d[0])return toShapesNoHoles(i);if(1<d.length){for(var v=!1,y=[],x=0,b=d.length;x<b;x++)u[x]=[];for(x=0,b=d.length;x<b;x++)for(var M=p[x],_=0;_<M.length;_++){for(var w=M[_],T=!0,E=0;E<d.length;E++)isPointInsidePolygon(w.p,d[E].p)&&(x!==E&&y.push({froms:x,tos:E,hole:_}),T?(T=!1,u[E].push(w)):v=!0);T&&u[x].push(w)}0<y.length&&(v||(p=u))}m=0;for(var S=d.length;m<S;m++){o=d[m].s,s.push(o);for(var A=0,L=(h=p[m]).length;A<L;A++)o.holes.push(h[A].h)}return s}}),Object.assign(Font.prototype,{isFont:!0,generateShapes:function(e,h,w){function createPath(e,t,r,i){var n=T.glyphs[e]||T.glyphs["?"];if(n){var a,o,s,c,l,h,u,d,p,f,m,g=new ShapePath,v=[];if(n.o)for(var y=n._cachedOutline||(n._cachedOutline=n.o.split(" ")),x=0,b=y.length;x<b;){switch(y[x++]){case"m":a=y[x++]*t+r,o=y[x++]*t+i,g.moveTo(a,o);break;case"l":a=y[x++]*t+r,o=y[x++]*t+i,g.lineTo(a,o);break;case"q":if(s=y[x++]*t+r,c=y[x++]*t+i,u=y[x++]*t+r,d=y[x++]*t+i,g.quadraticCurveTo(u,d,s,c),m=v[v.length-1]){l=m.x,h=m.y;for(var M=1;M<=w;M++){QuadraticBezier(_=M/w,l,u,s),QuadraticBezier(_,h,d,c)}}break;case"b":if(s=y[x++]*t+r,c=y[x++]*t+i,u=y[x++]*t+r,d=y[x++]*t+i,p=y[x++]*t+r,f=y[x++]*t+i,g.bezierCurveTo(u,d,p,f,s,c),m=v[v.length-1]){l=m.x,h=m.y;for(M=1;M<=w;M++){var _;CubicBezier(_=M/w,l,u,p,s),CubicBezier(_,h,d,f,c)}}}}return{offsetX:n.ha*t,path:g}}}void 0===h&&(h=100),void 0===w&&(w=4);for(var T=this.data,t=function createPaths(e){for(var t=String(e).split(""),r=h/T.resolution,i=(T.boundingBox.yMax-T.boundingBox.yMin+T.underlineThickness)*r,n=0,a=0,o=[],s=0;s<t.length;s++){var c=t[s];if("\n"===c)n=0,a-=i;else{var l=createPath(c,r,n,a);n+=l.offsetX,o.push(l.path)}}return o}(e),r=[],i=0,n=t.length;i<n;i++)Array.prototype.push.apply(r,t[i].toShapes());return r}}),Object.assign(FontLoader.prototype,{load:function(e,i,t,r){var n=this,a=new FileLoader(this.manager);a.setPath(this.path),a.load(e,function(t){var r;try{r=JSON.parse(t)}catch(e){console.warn("THREE.FontLoader: typeface.js support is being deprecated. Use typeface.json instead."),r=JSON.parse(t.substring(65,t.length-2))}var e=n.parse(r);i&&i(e)},t,r)},parse:function(e){return new Font(e)},setPath:function(e){return this.path=e,this}});var Yi,Zi,Qi,Ki,Ji,$i,en,tn,rn,nn,an,on,sn,cn,ln,hn,un,dn,pn,fn,mn,gn,vn,yn,xn,bn,Mn,_n,wn,Tn,En,Sn,An,Ln,Cn,Pn,Rn,Bn,In,Dn={getContext:function(){return void 0===Xi&&(Xi=new(window.AudioContext||window.webkitAudioContext)),Xi},setContext:function(e){Xi=e}};function AudioLoader(e){this.manager=void 0!==e?e:Ii}function StereoCamera(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new PerspectiveCamera,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new PerspectiveCamera,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1}function CubeCamera(e,t,r){Object3D.call(this),this.type="CubeCamera";var n=new PerspectiveCamera(90,1,e,t);n.up.set(0,-1,0),n.lookAt(new Vector3(1,0,0)),this.add(n);var a=new PerspectiveCamera(90,1,e,t);a.up.set(0,-1,0),a.lookAt(new Vector3(-1,0,0)),this.add(a);var o=new PerspectiveCamera(90,1,e,t);o.up.set(0,0,1),o.lookAt(new Vector3(0,1,0)),this.add(o);var s=new PerspectiveCamera(90,1,e,t);s.up.set(0,0,-1),s.lookAt(new Vector3(0,-1,0)),this.add(s);var c=new PerspectiveCamera(90,1,e,t);c.up.set(0,-1,0),c.lookAt(new Vector3(0,0,1)),this.add(c);var l=new PerspectiveCamera(90,1,e,t);l.up.set(0,-1,0),l.lookAt(new Vector3(0,0,-1)),this.add(l);var i={format:Ye,magFilter:Be,minFilter:Be};this.renderTarget=new WebGLRenderTargetCube(r,r,i),this.renderTarget.texture.name="CubeCamera",this.update=function(e,t){null===this.parent&&this.updateMatrixWorld();var r=this.renderTarget,i=r.texture.generateMipmaps;r.texture.generateMipmaps=!1,r.activeCubeFace=0,e.render(t,n,r),r.activeCubeFace=1,e.render(t,a,r),r.activeCubeFace=2,e.render(t,o,r),r.activeCubeFace=3,e.render(t,s,r),r.activeCubeFace=4,e.render(t,c,r),r.texture.generateMipmaps=i,r.activeCubeFace=5,e.render(t,l,r),e.setRenderTarget(null)},this.clear=function(e,t,r,i){for(var n=this.renderTarget,a=0;a<6;a++)n.activeCubeFace=a,e.setRenderTarget(n),e.clear(t,r,i);e.setRenderTarget(null)}}function AudioListener(){Object3D.call(this),this.type="AudioListener",this.context=Dn.getContext(),this.gain=this.context.createGain(),this.gain.connect(this.context.destination),this.filter=null}function Audio(e){Object3D.call(this),this.type="Audio",this.context=e.context,this.gain=this.context.createGain(),this.gain.connect(e.getInput()),this.autoplay=!1,this.buffer=null,this.loop=!1,this.startTime=0,this.offset=0,this.playbackRate=1,this.isPlaying=!1,this.hasPlaybackControl=!0,this.sourceType="empty",this.filters=[]}function PositionalAudio(e){Audio.call(this,e),this.panner=this.context.createPanner(),this.panner.connect(this.gain)}function AudioAnalyser(e,t){this.analyser=e.context.createAnalyser(),this.analyser.fftSize=void 0!==t?t:2048,this.data=new Uint8Array(this.analyser.frequencyBinCount),e.getOutput().connect(this.analyser)}function PropertyMixer(e,t,r){this.binding=e,this.valueSize=r;var i,n=Float64Array;switch(t){case"quaternion":i=this._slerp;break;case"string":case"bool":n=Array,i=this._select;break;default:i=this._lerp}this.buffer=new n(4*r),this._mixBufferRegion=i,this.cumulativeWeight=0,this.useCount=0,this.referenceCount=0}function Composite(e,t,r){var i=r||PropertyBinding.parseTrackName(t);this._targetGroup=e,this._bindings=e.subscribe_(t,i)}function PropertyBinding(e,t,r){this.path=t,this.parsedPath=r||PropertyBinding.parseTrackName(t),this.node=PropertyBinding.findNode(e,this.parsedPath.nodeName)||e,this.rootNode=e}function AnimationObjectGroup(){this.uuid=Et.generateUUID(),this._objects=Array.prototype.slice.call(arguments),this.nCachedObjects_=0;var e={};this._indicesByUUID=e;for(var t=0,r=arguments.length;t!==r;++t)e[arguments[t].uuid]=t;this._paths=[],this._parsedPaths=[],this._bindings=[],this._bindingsIndicesByPath={};var i=this;this.stats={objects:{get total(){return i._objects.length},get inUse(){return this.total-i.nCachedObjects_}},get bindingsPerObject(){return i._bindings.length}}}function AnimationAction(e,t,r){this._mixer=e,this._clip=t,this._localRoot=r||null;for(var i=t.tracks,n=i.length,a=new Array(n),o={endingStart:dt,endingEnd:dt},s=0;s!==n;++s){var c=i[s].createInterpolant(null);(a[s]=c).settings=o}this._interpolantSettings=o,this._interpolants=a,this._propertyBindings=new Array(n),this._cacheIndex=null,this._byClipCacheIndex=null,this._timeScaleInterpolant=null,this._weightInterpolant=null,this.loop=2201,this._loopCount=-1,this._startTime=null,this.time=0,this.timeScale=1,this._effectiveTimeScale=1,this.weight=1,this._effectiveWeight=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}function AnimationMixer(e){this._root=e,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}function Uniform(e){"string"==typeof e&&(console.warn("THREE.Uniform: Type parameter is no longer needed."),e=arguments[1]),this.value=e}function InstancedBufferGeometry(){BufferGeometry.call(this),this.type="InstancedBufferGeometry",this.maxInstancedCount=void 0}function InterleavedBufferAttribute(e,t,r,i){this.uuid=Et.generateUUID(),this.data=e,this.itemSize=t,this.offset=r,this.normalized=!0===i}function InterleavedBuffer(e,t){this.uuid=Et.generateUUID(),this.array=e,this.stride=t,this.count=void 0!==e?e.length/t:0,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.onUploadCallback=function(){},this.version=0}function InstancedInterleavedBuffer(e,t,r){InterleavedBuffer.call(this,e,t),this.meshPerAttribute=r||1}function InstancedBufferAttribute(e,t,r){BufferAttribute.call(this,e,t),this.meshPerAttribute=r||1}function Raycaster(e,t,r,i){this.ray=new Ray(e,t),this.near=r||0,this.far=i||1/0,this.params={Mesh:{},Line:{},LOD:{},Points:{threshold:1},Sprite:{}},Object.defineProperties(this.params,{PointCloud:{get:function(){return console.warn("THREE.Raycaster: params.PointCloud has been renamed to params.Points."),this.Points}}})}function ascSort(e,t){return e.distance-t.distance}function intersectObject(e,t,r,i){if(!1!==e.visible&&(e.raycast(t,r),!0===i))for(var n=e.children,a=0,o=n.length;a<o;a++)intersectObject(n[a],t,r,!0)}function Clock(e){this.autoStart=void 0===e||e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}function Spherical(e,t,r){return this.radius=void 0!==e?e:1,this.phi=void 0!==t?t:0,this.theta=void 0!==r?r:0,this}function Cylindrical(e,t,r){return this.radius=void 0!==e?e:1,this.theta=void 0!==t?t:0,this.y=void 0!==r?r:0,this}function ImmediateRenderObject(e){Object3D.call(this),this.material=e,this.render=function(){}}function VertexNormalsHelper(e,t,r,i){this.object=e,this.size=void 0!==t?t:1;var n=void 0!==r?r:16711680,a=void 0!==i?i:1,o=0,s=this.object.geometry;s&&s.isGeometry?o=3*s.faces.length:s&&s.isBufferGeometry&&(o=s.attributes.normal.count);var c=new BufferGeometry,l=new Float32BufferAttribute(2*o*3,3);c.addAttribute("position",l),LineSegments.call(this,c,new LineBasicMaterial({color:n,linewidth:a})),this.matrixAutoUpdate=!1,this.update()}function SpotLightHelper(e,t){Object3D.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=t;for(var r=new BufferGeometry,i=[0,0,0,0,0,1,0,0,0,1,0,1,0,0,0,-1,0,1,0,0,0,0,1,1,0,0,0,0,-1,1],n=0,a=1;n<32;n++,a++){var o=n/32*Math.PI*2,s=a/32*Math.PI*2;i.push(Math.cos(o),Math.sin(o),1,Math.cos(s),Math.sin(s),1)}r.addAttribute("position",new Float32BufferAttribute(i,3));var c=new LineBasicMaterial({fog:!1});this.cone=new LineSegments(r,c),this.add(this.cone),this.update()}function SkeletonHelper(e){for(var t=function getBoneList(e){var t=[];e&&e.isBone&&t.push(e);for(var r=0;r<e.children.length;r++)t.push.apply(t,getBoneList(e.children[r]));return t}(e),r=new BufferGeometry,i=[],n=[],a=new Color(0,0,1),o=new Color(0,1,0),s=0;s<t.length;s++){var c=t[s];c.parent&&c.parent.isBone&&(i.push(0,0,0),i.push(0,0,0),n.push(a.r,a.g,a.b),n.push(o.r,o.g,o.b))}r.addAttribute("position",new Float32BufferAttribute(i,3)),r.addAttribute("color",new Float32BufferAttribute(n,3));var l=new LineBasicMaterial({vertexColors:E,depthTest:!1,depthWrite:!1,transparent:!0});LineSegments.call(this,r,l),this.root=e,this.bones=t,this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1}function PointLightHelper(e,t,r){this.light=e,this.light.updateMatrixWorld(),this.color=r;var i=new SphereBufferGeometry(t,4,2),n=new MeshBasicMaterial({wireframe:!0,fog:!1});Mesh.call(this,i,n),this.matrix=this.light.matrixWorld,this.matrixAutoUpdate=!1,this.update()}function RectAreaLightHelper(e,t){Object3D.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=t;var r=new LineBasicMaterial({fog:!1}),i=new BufferGeometry;i.addAttribute("position",new BufferAttribute(new Float32Array(15),3)),this.line=new Line(i,r),this.add(this.line),this.update()}function HemisphereLightHelper(e,t,r){Object3D.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=r;var i=new OctahedronBufferGeometry(t);i.rotateY(.5*Math.PI),this.material=new MeshBasicMaterial({wireframe:!0,fog:!1}),void 0===this.color&&(this.material.vertexColors=E);var n=i.getAttribute("position"),a=new Float32Array(3*n.count);i.addAttribute("color",new BufferAttribute(a,3)),this.add(new Mesh(i,this.material)),this.update()}function GridHelper(e,t,r,i){e=e||10,t=t||10,r=new Color(void 0!==r?r:4473924),i=new Color(void 0!==i?i:8947848);for(var n=t/2,a=e/t,o=e/2,s=[],c=[],l=0,h=0,u=-o;l<=t;l++,u+=a){s.push(-o,0,u,o,0,u),s.push(u,0,-o,u,0,o);var d=l===n?r:i;d.toArray(c,h),h+=3,d.toArray(c,h),h+=3,d.toArray(c,h),h+=3,d.toArray(c,h),h+=3}var p=new BufferGeometry;p.addAttribute("position",new Float32BufferAttribute(s,3)),p.addAttribute("color",new Float32BufferAttribute(c,3));var f=new LineBasicMaterial({vertexColors:E});LineSegments.call(this,p,f)}function PolarGridHelper(e,t,r,i,n,a){e=e||10,t=t||16,r=r||8,i=i||64,n=new Color(void 0!==n?n:4473924),a=new Color(void 0!==a?a:8947848);var o,s,c,l,h,u,d,p=[],f=[];for(l=0;l<=t;l++)c=l/t*(2*Math.PI),o=Math.sin(c)*e,s=Math.cos(c)*e,p.push(0,0,0),p.push(o,0,s),d=1&l?n:a,f.push(d.r,d.g,d.b),f.push(d.r,d.g,d.b);for(l=0;l<=r;l++)for(d=1&l?n:a,u=e-e/r*l,h=0;h<i;h++)c=h/i*(2*Math.PI),o=Math.sin(c)*u,s=Math.cos(c)*u,p.push(o,0,s),f.push(d.r,d.g,d.b),c=(h+1)/i*(2*Math.PI),o=Math.sin(c)*u,s=Math.cos(c)*u,p.push(o,0,s),f.push(d.r,d.g,d.b);var m=new BufferGeometry;m.addAttribute("position",new Float32BufferAttribute(p,3)),m.addAttribute("color",new Float32BufferAttribute(f,3));var g=new LineBasicMaterial({vertexColors:E});LineSegments.call(this,m,g)}function FaceNormalsHelper(e,t,r,i){this.object=e,this.size=void 0!==t?t:1;var n=void 0!==r?r:16776960,a=void 0!==i?i:1,o=0,s=this.object.geometry;s&&s.isGeometry?o=s.faces.length:console.warn("THREE.FaceNormalsHelper: only THREE.Geometry is supported. Use THREE.VertexNormalsHelper, instead.");var c=new BufferGeometry,l=new Float32BufferAttribute(2*o*3,3);c.addAttribute("position",l),LineSegments.call(this,c,new LineBasicMaterial({color:n,linewidth:a})),this.matrixAutoUpdate=!1,this.update()}function DirectionalLightHelper(e,t,r){Object3D.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=r,void 0===t&&(t=1);var i=new BufferGeometry;i.addAttribute("position",new Float32BufferAttribute([-t,t,0,t,t,0,t,-t,0,-t,-t,0,-t,t,0],3));var n=new LineBasicMaterial({fog:!1});this.lightPlane=new Line(i,n),this.add(this.lightPlane),(i=new BufferGeometry).addAttribute("position",new Float32BufferAttribute([0,0,0,0,0,1],3)),this.targetLine=new Line(i,n),this.add(this.targetLine),this.update()}function CameraHelper(e){var t=new BufferGeometry,r=new LineBasicMaterial({color:16777215,vertexColors:1}),i=[],n=[],a={},o=new Color(16755200),s=new Color(16711680),c=new Color(43775),l=new Color(16777215),h=new Color(3355443);function addLine(e,t,r){addPoint(e,r),addPoint(t,r)}function addPoint(e,t){i.push(0,0,0),n.push(t.r,t.g,t.b),void 0===a[e]&&(a[e]=[]),a[e].push(i.length/3-1)}addLine("n1","n2",o),addLine("n2","n4",o),addLine("n4","n3",o),addLine("n3","n1",o),addLine("f1","f2",o),addLine("f2","f4",o),addLine("f4","f3",o),addLine("f3","f1",o),addLine("n1","f1",o),addLine("n2","f2",o),addLine("n3","f3",o),addLine("n4","f4",o),addLine("p","n1",s),addLine("p","n2",s),addLine("p","n3",s),addLine("p","n4",s),addLine("u1","u2",c),addLine("u2","u3",c),addLine("u3","u1",c),addLine("c","t",l),addLine("p","c",h),addLine("cn1","cn2",h),addLine("cn3","cn4",h),addLine("cf1","cf2",h),addLine("cf3","cf4",h),t.addAttribute("position",new Float32BufferAttribute(i,3)),t.addAttribute("color",new Float32BufferAttribute(n,3)),LineSegments.call(this,t,r),this.camera=e,this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=a,this.update()}function BoxHelper(e,t){this.object=e,void 0===t&&(t=16776960);var r=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),i=new Float32Array(24),n=new BufferGeometry;n.setIndex(new BufferAttribute(r,1)),n.addAttribute("position",new BufferAttribute(i,3)),LineSegments.call(this,n,new LineBasicMaterial({color:t})),this.matrixAutoUpdate=!1,this.update()}function Box3Helper(e,t){this.type="Box3Helper",this.box=e;var r=void 0!==t?t:16776960,i=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),n=new BufferGeometry;n.setIndex(new BufferAttribute(i,1)),n.addAttribute("position",new Float32BufferAttribute([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1],3)),LineSegments.call(this,n,new LineBasicMaterial({color:r})),this.geometry.computeBoundingSphere()}function PlaneHelper(e,t,r){this.type="PlaneHelper",this.plane=e,this.size=void 0===t?1:t;var i=void 0!==r?r:16776960,n=new BufferGeometry;n.addAttribute("position",new Float32BufferAttribute([1,-1,1,-1,1,1,-1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,0,0,1,0,0,0],3)),n.computeBoundingSphere(),Line.call(this,n,new LineBasicMaterial({color:i}));var a=new BufferGeometry;a.addAttribute("position",new Float32BufferAttribute([1,1,1,-1,1,1,-1,-1,1,1,1,1,-1,-1,1,1,-1,1],3)),a.computeBoundingSphere(),this.add(new Mesh(a,new MeshBasicMaterial({color:i,opacity:.2,transparent:!0,depthWrite:!1})))}function ArrowHelper(e,t,r,i,n,a){Object3D.call(this),void 0===i&&(i=16776960),void 0===r&&(r=1),void 0===n&&(n=.2*r),void 0===a&&(a=.2*n),void 0===Pn&&((Pn=new BufferGeometry).addAttribute("position",new Float32BufferAttribute([0,0,0,0,1,0],3)),(Rn=new CylinderBufferGeometry(0,.5,1,5,1)).translate(0,-.5,0)),this.position.copy(t),this.line=new Line(Pn,new LineBasicMaterial({color:i})),this.line.matrixAutoUpdate=!1,this.add(this.line),this.cone=new Mesh(Rn,new MeshBasicMaterial({color:i})),this.cone.matrixAutoUpdate=!1,this.add(this.cone),this.setDirection(e),this.setLength(r,n,a)}function AxesHelper(e){var t=[0,0,0,e=e||1,0,0,0,0,0,0,e,0,0,0,0,0,0,e],r=new BufferGeometry;r.addAttribute("position",new Float32BufferAttribute(t,3)),r.addAttribute("color",new Float32BufferAttribute([1,0,0,1,.6,0,0,1,0,.6,1,0,0,0,1,0,.6,1],3));var i=new LineBasicMaterial({vertexColors:E});LineSegments.call(this,r,i)}function CubicPoly(){var n=0,a=0,o=0,s=0;function init(e,t,r,i){o=-3*(n=e)+3*t-2*(a=r)-i,s=2*e-2*t+r+i}return{initCatmullRom:function(e,t,r,i,n){init(t,r,n*(r-e),n*(i-t))},initNonuniformCatmullRom:function(e,t,r,i,n,a,o){var s=(t-e)/n-(r-e)/(n+a)+(r-t)/a,c=(r-t)/a-(i-t)/(a+o)+(i-r)/o;init(t,r,s*=a,c*=a)},calc:function(e){var t=e*e;return n+a*e+o*t+s*(t*e)}}}Object.assign(AudioLoader.prototype,{load:function(e,t,r,i){var n=new FileLoader(this.manager);n.setResponseType("arraybuffer"),n.load(e,function(e){Dn.getContext().decodeAudioData(e,function(e){t(e)})},r,i)}}),Object.assign(StereoCamera.prototype,{update:(rn=new Matrix4,nn=new Matrix4,function update(e){if(Yi!==this||Zi!==e.focus||Qi!==e.fov||Ki!==e.aspect*this.aspect||Ji!==e.near||$i!==e.far||en!==e.zoom||tn!==this.eyeSep){Yi=this,Zi=e.focus,Qi=e.fov,Ki=e.aspect*this.aspect,Ji=e.near,$i=e.far,en=e.zoom;var t,r,i=e.projectionMatrix.clone(),n=(tn=this.eyeSep/2)*Ji/Zi,a=Ji*Math.tan(Et.DEG2RAD*Qi*.5)/en;nn.elements[12]=-tn,rn.elements[12]=tn,t=-a*Ki+n,r=a*Ki+n,i.elements[0]=2*Ji/(r-t),i.elements[8]=(r+t)/(r-t),this.cameraL.projectionMatrix.copy(i),t=-a*Ki-n,r=a*Ki-n,i.elements[0]=2*Ji/(r-t),i.elements[8]=(r+t)/(r-t),this.cameraR.projectionMatrix.copy(i)}this.cameraL.matrixWorld.copy(e.matrixWorld).multiply(nn),this.cameraR.matrixWorld.copy(e.matrixWorld).multiply(rn)})}),(CubeCamera.prototype=Object.create(Object3D.prototype)).constructor=CubeCamera,AudioListener.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:AudioListener,getInput:function(){return this.gain},removeFilter:function(){null!==this.filter&&(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination),this.gain.connect(this.context.destination),this.filter=null)},getFilter:function(){return this.filter},setFilter:function(e){null!==this.filter?(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination)):this.gain.disconnect(this.context.destination),this.filter=e,this.gain.connect(this.filter),this.filter.connect(this.context.destination)},getMasterVolume:function(){return this.gain.gain.value},setMasterVolume:function(e){this.gain.gain.value=e},updateMatrixWorld:(an=new Vector3,on=new Quaternion,sn=new Vector3,cn=new Vector3,function updateMatrixWorld(e){Object3D.prototype.updateMatrixWorld.call(this,e);var t=this.context.listener,r=this.up;this.matrixWorld.decompose(an,on,sn),cn.set(0,0,-1).applyQuaternion(on),t.positionX?(t.positionX.setValueAtTime(an.x,this.context.currentTime),t.positionY.setValueAtTime(an.y,this.context.currentTime),t.positionZ.setValueAtTime(an.z,this.context.currentTime),t.forwardX.setValueAtTime(cn.x,this.context.currentTime),t.forwardY.setValueAtTime(cn.y,this.context.currentTime),t.forwardZ.setValueAtTime(cn.z,this.context.currentTime),t.upX.setValueAtTime(r.x,this.context.currentTime),t.upY.setValueAtTime(r.y,this.context.currentTime),t.upZ.setValueAtTime(r.z,this.context.currentTime)):(t.setPosition(an.x,an.y,an.z),t.setOrientation(cn.x,cn.y,cn.z,r.x,r.y,r.z))})}),Audio.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Audio,getOutput:function(){return this.gain},setNodeSource:function(e){return this.hasPlaybackControl=!1,this.sourceType="audioNode",this.source=e,this.connect(),this},setBuffer:function(e){return this.buffer=e,this.sourceType="buffer",this.autoplay&&this.play(),this},play:function(){if(!0!==this.isPlaying){if(!1!==this.hasPlaybackControl){var e=this.context.createBufferSource();return e.buffer=this.buffer,e.loop=this.loop,e.onended=this.onEnded.bind(this),e.playbackRate.setValueAtTime(this.playbackRate,this.startTime),this.startTime=this.context.currentTime,e.start(this.startTime,this.offset),this.isPlaying=!0,this.source=e,this.connect()}console.warn("THREE.Audio: this Audio has no playback control.")}else console.warn("THREE.Audio: Audio is already playing.")},pause:function(){if(!1!==this.hasPlaybackControl)return!0===this.isPlaying&&(this.source.stop(),this.offset+=(this.context.currentTime-this.startTime)*this.playbackRate,this.isPlaying=!1),this;console.warn("THREE.Audio: this Audio has no playback control.")},stop:function(){if(!1!==this.hasPlaybackControl)return this.source.stop(),this.offset=0,this.isPlaying=!1,this;console.warn("THREE.Audio: this Audio has no playback control.")},connect:function(){if(0<this.filters.length){this.source.connect(this.filters[0]);for(var e=1,t=this.filters.length;e<t;e++)this.filters[e-1].connect(this.filters[e]);this.filters[this.filters.length-1].connect(this.getOutput())}else this.source.connect(this.getOutput());return this},disconnect:function(){if(0<this.filters.length){this.source.disconnect(this.filters[0]);for(var e=1,t=this.filters.length;e<t;e++)this.filters[e-1].disconnect(this.filters[e]);this.filters[this.filters.length-1].disconnect(this.getOutput())}else this.source.disconnect(this.getOutput());return this},getFilters:function(){return this.filters},setFilters:function(e){return e||(e=[]),!0===this.isPlaying?(this.disconnect(),this.filters=e,this.connect()):this.filters=e,this},getFilter:function(){return this.getFilters()[0]},setFilter:function(e){return this.setFilters(e?[e]:[])},setPlaybackRate:function(e){if(!1!==this.hasPlaybackControl)return this.playbackRate=e,!0===this.isPlaying&&this.source.playbackRate.setValueAtTime(this.playbackRate,this.context.currentTime),this;console.warn("THREE.Audio: this Audio has no playback control.")},getPlaybackRate:function(){return this.playbackRate},onEnded:function(){this.isPlaying=!1},getLoop:function(){return!1===this.hasPlaybackControl?(console.warn("THREE.Audio: this Audio has no playback control."),!1):this.loop},setLoop:function(e){if(!1!==this.hasPlaybackControl)return this.loop=e,!0===this.isPlaying&&(this.source.loop=this.loop),this;console.warn("THREE.Audio: this Audio has no playback control.")},getVolume:function(){return this.gain.gain.value},setVolume:function(e){return this.gain.gain.value=e,this}}),PositionalAudio.prototype=Object.assign(Object.create(Audio.prototype),{constructor:PositionalAudio,getOutput:function(){return this.panner},getRefDistance:function(){return this.panner.refDistance},setRefDistance:function(e){this.panner.refDistance=e},getRolloffFactor:function(){return this.panner.rolloffFactor},setRolloffFactor:function(e){this.panner.rolloffFactor=e},getDistanceModel:function(){return this.panner.distanceModel},setDistanceModel:function(e){this.panner.distanceModel=e},getMaxDistance:function(){return this.panner.maxDistance},setMaxDistance:function(e){this.panner.maxDistance=e},updateMatrixWorld:(ln=new Vector3,function updateMatrixWorld(e){Object3D.prototype.updateMatrixWorld.call(this,e),ln.setFromMatrixPosition(this.matrixWorld),this.panner.setPosition(ln.x,ln.y,ln.z)})}),Object.assign(AudioAnalyser.prototype,{getFrequencyData:function(){return this.analyser.getByteFrequencyData(this.data),this.data},getAverageFrequency:function(){for(var e=0,t=this.getFrequencyData(),r=0;r<t.length;r++)e+=t[r];return e/t.length}}),Object.assign(PropertyMixer.prototype,{accumulate:function(e,t){var r=this.buffer,i=this.valueSize,n=e*i+i,a=this.cumulativeWeight;if(0===a){for(var o=0;o!==i;++o)r[n+o]=r[o];a=t}else{var s=t/(a+=t);this._mixBufferRegion(r,n,0,s,i)}this.cumulativeWeight=a},apply:function(e){var t=this.valueSize,r=this.buffer,i=e*t+t,n=this.cumulativeWeight,a=this.binding;if(this.cumulativeWeight=0,n<1){var o=3*t;this._mixBufferRegion(r,i,o,1-n,t)}for(var s=t,c=t+t;s!==c;++s)if(r[s]!==r[s+t]){a.setValue(r,i);break}},saveOriginalState:function(){var e=this.binding,t=this.buffer,r=this.valueSize,i=3*r;e.getValue(t,i);for(var n=r,a=i;n!==a;++n)t[n]=t[i+n%r];this.cumulativeWeight=0},restoreOriginalState:function(){var e=3*this.valueSize;this.binding.setValue(this.buffer,e)},_select:function(e,t,r,i,n){if(.5<=i)for(var a=0;a!==n;++a)e[t+a]=e[r+a]},_slerp:function(e,t,r,i){Quaternion.slerpFlat(e,t,e,t,e,r,i)},_lerp:function(e,t,r,i,n){for(var a=1-i,o=0;o!==n;++o){var s=t+o;e[s]=e[s]*a+e[r+o]*i}}}),Object.assign(Composite.prototype,{getValue:function(e,t){this.bind();var r=this._targetGroup.nCachedObjects_,i=this._bindings[r];void 0!==i&&i.getValue(e,t)},setValue:function(e,t){for(var r=this._bindings,i=this._targetGroup.nCachedObjects_,n=r.length;i!==n;++i)r[i].setValue(e,t)},bind:function(){for(var e=this._bindings,t=this._targetGroup.nCachedObjects_,r=e.length;t!==r;++t)e[t].bind()},unbind:function(){for(var e=this._bindings,t=this._targetGroup.nCachedObjects_,r=e.length;t!==r;++t)e[t].unbind()}}),Object.assign(PropertyBinding,{Composite:Composite,create:function(e,t,r){return e&&e.isAnimationObjectGroup?new PropertyBinding.Composite(e,t,r):new PropertyBinding(e,t,r)},sanitizeNodeName:function(e){return e.replace(/\s/g,"_").replace(/[^\w-]/g,"")},parseTrackName:(hn=new RegExp("^"+/((?:[\w-]+[\/:])*)/.source+/([\w-\.]+)?/.source+/(?:\.([\w-]+)(?:\[(.+)\])?)?/.source+/\.([\w-]+)(?:\[(.+)\])?/.source+"$"),un=["material","materials","bones"],function(e){var t=hn.exec(e);if(!t)throw new Error("PropertyBinding: Cannot parse trackName: "+e);var r={nodeName:t[2],objectName:t[3],objectIndex:t[4],propertyName:t[5],propertyIndex:t[6]},i=r.nodeName&&r.nodeName.lastIndexOf(".");if(void 0!==i&&-1!==i){var n=r.nodeName.substring(i+1);-1!==un.indexOf(n)&&(r.nodeName=r.nodeName.substring(0,i),r.objectName=n)}if(null===r.propertyName||0===r.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+e);return r}),findNode:function(e,n){if(!n||""===n||"root"===n||"."===n||-1===n||n===e.name||n===e.uuid)return e;if(e.skeleton){var t=function(e){for(var t=0;t<e.bones.length;t++){var r=e.bones[t];if(r.name===n)return r}return null}(e.skeleton);if(t)return t}if(e.children){var a=function(e){for(var t=0;t<e.length;t++){var r=e[t];if(r.name===n||r.uuid===n)return r;var i=a(r.children);if(i)return i}return null},r=a(e.children);if(r)return r}return null}}),Object.assign(PropertyBinding.prototype,{_getValue_unavailable:function(){},_setValue_unavailable:function(){},BindingType:{Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},Versioning:{None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},GetterByBindingType:[function getValue_direct(e,t){e[t]=this.node[this.propertyName]},function getValue_array(e,t){for(var r=this.resolvedProperty,i=0,n=r.length;i!==n;++i)e[t++]=r[i]},function getValue_arrayElement(e,t){e[t]=this.resolvedProperty[this.propertyIndex]},function getValue_toArray(e,t){this.resolvedProperty.toArray(e,t)}],SetterByBindingTypeAndVersioning:[[function setValue_direct(e,t){this.targetObject[this.propertyName]=e[t]},function setValue_direct_setNeedsUpdate(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.needsUpdate=!0},function setValue_direct_setMatrixWorldNeedsUpdate(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}],[function setValue_array(e,t){for(var r=this.resolvedProperty,i=0,n=r.length;i!==n;++i)r[i]=e[t++]},function setValue_array_setNeedsUpdate(e,t){for(var r=this.resolvedProperty,i=0,n=r.length;i!==n;++i)r[i]=e[t++];this.targetObject.needsUpdate=!0},function setValue_array_setMatrixWorldNeedsUpdate(e,t){for(var r=this.resolvedProperty,i=0,n=r.length;i!==n;++i)r[i]=e[t++];this.targetObject.matrixWorldNeedsUpdate=!0}],[function setValue_arrayElement(e,t){this.resolvedProperty[this.propertyIndex]=e[t]},function setValue_arrayElement_setNeedsUpdate(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.needsUpdate=!0},function setValue_arrayElement_setMatrixWorldNeedsUpdate(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}],[function setValue_fromArray(e,t){this.resolvedProperty.fromArray(e,t)},function setValue_fromArray_setNeedsUpdate(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.needsUpdate=!0},function setValue_fromArray_setMatrixWorldNeedsUpdate(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.matrixWorldNeedsUpdate=!0}]],getValue:function getValue_unbound(e,t){this.bind(),this.getValue(e,t)},setValue:function getValue_unbound(e,t){this.bind(),this.setValue(e,t)},bind:function(){var e=this.node,t=this.parsedPath,r=t.objectName,i=t.propertyName,n=t.propertyIndex;if(e||(e=PropertyBinding.findNode(this.rootNode,t.nodeName)||this.rootNode,this.node=e),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,e){if(r){var a=t.objectIndex;switch(r){case"materials":if(!e.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!e.material.materials)return void console.error("THREE.PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);e=e.material.materials;break;case"bones":if(!e.skeleton)return void console.error("THREE.PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);e=e.skeleton.bones;for(var o=0;o<e.length;o++)if(e[o].name===a){a=o;break}break;default:if(void 0===e[r])return void console.error("THREE.PropertyBinding: Can not bind to objectName of node undefined.",this);e=e[r]}if(void 0!==a){if(void 0===e[a])return void console.error("THREE.PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,e);e=e[a]}}var s=e[i];if(void 0!==s){var c=this.Versioning.None;void 0!==e.needsUpdate?(c=this.Versioning.NeedsUpdate,this.targetObject=e):void 0!==e.matrixWorldNeedsUpdate&&(c=this.Versioning.MatrixWorldNeedsUpdate,this.targetObject=e);var l=this.BindingType.Direct;if(void 0!==n){if("morphTargetInfluences"===i){if(!e.geometry)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);if(e.geometry.isBufferGeometry){if(!e.geometry.morphAttributes)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);for(o=0;o<this.node.geometry.morphAttributes.position.length;o++)if(e.geometry.morphAttributes.position[o].name===n){n=o;break}}else{if(!e.geometry.morphTargets)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphTargets.",this);for(o=0;o<this.node.geometry.morphTargets.length;o++)if(e.geometry.morphTargets[o].name===n){n=o;break}}}l=this.BindingType.ArrayElement,this.resolvedProperty=s,this.propertyIndex=n}else void 0!==s.fromArray&&void 0!==s.toArray?(l=this.BindingType.HasFromToArray,this.resolvedProperty=s):Array.isArray(s)?(l=this.BindingType.EntireArray,this.resolvedProperty=s):this.propertyName=i;this.getValue=this.GetterByBindingType[l],this.setValue=this.SetterByBindingTypeAndVersioning[l][c]}else{var h=t.nodeName;console.error("THREE.PropertyBinding: Trying to update property for track: "+h+"."+i+" but it wasn't found.",e)}}else console.error("THREE.PropertyBinding: Trying to update node for track: "+this.path+" but it wasn't found.")},unbind:function(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}),Object.assign(PropertyBinding.prototype,{_getValue_unbound:PropertyBinding.prototype.getValue,_setValue_unbound:PropertyBinding.prototype.setValue}),Object.assign(AnimationObjectGroup.prototype,{isAnimationObjectGroup:!0,add:function(){for(var e=this._objects,t=e.length,r=this.nCachedObjects_,i=this._indicesByUUID,n=this._paths,a=this._parsedPaths,o=this._bindings,s=o.length,c=0,l=arguments.length;c!==l;++c){var h=arguments[c],u=h.uuid,d=i[u],p=void 0;if(void 0===d){d=t++,i[u]=d,e.push(h);for(var f=0,m=s;f!==m;++f)o[f].push(new PropertyBinding(h,n[f],a[f]))}else if(d<r){p=e[d];var g=--r,v=e[g];e[i[v.uuid]=d]=v,e[i[u]=g]=h;for(f=0,m=s;f!==m;++f){var y=o[f],x=y[g],b=y[d];y[d]=x,void 0===b&&(b=new PropertyBinding(h,n[f],a[f])),y[g]=b}}else e[d]!==p&&console.error("THREE.AnimationObjectGroup: Different objects with the same UUID detected. Clean the caches or recreate your infrastructure when reloading scenes.")}this.nCachedObjects_=r},remove:function(){for(var e=this._objects,t=this.nCachedObjects_,r=this._indicesByUUID,i=this._bindings,n=i.length,a=0,o=arguments.length;a!==o;++a){var s=arguments[a],c=s.uuid,l=r[c];if(void 0!==l&&t<=l){var h=t++,u=e[h];e[r[u.uuid]=l]=u,e[r[c]=h]=s;for(var d=0,p=n;d!==p;++d){var f=i[d],m=f[h],g=f[l];f[l]=m,f[h]=g}}}this.nCachedObjects_=t},uncache:function(){for(var e=this._objects,t=e.length,r=this.nCachedObjects_,i=this._indicesByUUID,n=this._bindings,a=n.length,o=0,s=arguments.length;o!==s;++o){var c=arguments[o].uuid,l=i[c];if(void 0!==l)if(delete i[c],l<r){var h=--r,u=e[h],d=e[v=--t];e[i[u.uuid]=l]=u,e[i[d.uuid]=h]=d,e.pop();for(var p=0,f=a;p!==f;++p){var m=(y=n[p])[h],g=y[v];y[l]=m,y[h]=g,y.pop()}}else{var v;e[i[(d=e[v=--t]).uuid]=l]=d,e.pop();for(p=0,f=a;p!==f;++p){var y;(y=n[p])[l]=y[v],y.pop()}}}this.nCachedObjects_=r},subscribe_:function(e,t){var r=this._bindingsIndicesByPath,i=r[e],n=this._bindings;if(void 0!==i)return n[i];var a=this._paths,o=this._parsedPaths,s=this._objects,c=s.length,l=this.nCachedObjects_,h=new Array(c);i=n.length,r[e]=i,a.push(e),o.push(t),n.push(h);for(var u=l,d=s.length;u!==d;++u){var p=s[u];h[u]=new PropertyBinding(p,e,t)}return h},unsubscribe_:function(e){var t=this._bindingsIndicesByPath,r=t[e];if(void 0!==r){var i=this._paths,n=this._parsedPaths,a=this._bindings,o=a.length-1,s=a[o];a[t[e[o]]=r]=s,a.pop(),n[r]=n[o],n.pop(),i[r]=i[o],i.pop()}}}),Object.assign(AnimationAction.prototype,{play:function(){return this._mixer._activateAction(this),this},stop:function(){return this._mixer._deactivateAction(this),this.reset()},reset:function(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()},isRunning:function(){return this.enabled&&!this.paused&&0!==this.timeScale&&null===this._startTime&&this._mixer._isActiveAction(this)},isScheduled:function(){return this._mixer._isActiveAction(this)},startAt:function(e){return this._startTime=e,this},setLoop:function(e,t){return this.loop=e,this.repetitions=t,this},setEffectiveWeight:function(e){return this.weight=e,this._effectiveWeight=this.enabled?e:0,this.stopFading()},getEffectiveWeight:function(){return this._effectiveWeight},fadeIn:function(e){return this._scheduleFading(e,0,1)},fadeOut:function(e){return this._scheduleFading(e,1,0)},crossFadeFrom:function(e,t,r){if(e.fadeOut(t),this.fadeIn(t),r){var i=this._clip.duration,n=e._clip.duration,a=n/i,o=i/n;e.warp(1,a,t),this.warp(o,1,t)}return this},crossFadeTo:function(e,t,r){return e.crossFadeFrom(this,t,r)},stopFading:function(){var e=this._weightInterpolant;return null!==e&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this},setEffectiveTimeScale:function(e){return this.timeScale=e,this._effectiveTimeScale=this.paused?0:e,this.stopWarping()},getEffectiveTimeScale:function(){return this._effectiveTimeScale},setDuration:function(e){return this.timeScale=this._clip.duration/e,this.stopWarping()},syncWith:function(e){return this.time=e.time,this.timeScale=e.timeScale,this.stopWarping()},halt:function(e){return this.warp(this._effectiveTimeScale,0,e)},warp:function(e,t,r){var i=this._mixer,n=i.time,a=this._timeScaleInterpolant,o=this.timeScale;null===a&&(a=i._lendControlInterpolant(),this._timeScaleInterpolant=a);var s=a.parameterPositions,c=a.sampleValues;return s[0]=n,s[1]=n+r,c[0]=e/o,c[1]=t/o,this},stopWarping:function(){var e=this._timeScaleInterpolant;return null!==e&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this},getMixer:function(){return this._mixer},getClip:function(){return this._clip},getRoot:function(){return this._localRoot||this._mixer._root},_update:function(e,t,r,i){if(this.enabled){var n=this._startTime;if(null!==n){var a=(e-n)*r;if(a<0||0===r)return;this._startTime=null,t=r*a}t*=this._updateTimeScale(e);var o=this._updateTime(t),s=this._updateWeight(e);if(0<s)for(var c=this._interpolants,l=this._propertyBindings,h=0,u=c.length;h!==u;++h)c[h].evaluate(o),l[h].accumulate(i,s)}else this._updateWeight(e)},_updateWeight:function(e){var t=0;if(this.enabled){t=this.weight;var r=this._weightInterpolant;if(null!==r){var i=r.evaluate(e)[0];t*=i,e>r.parameterPositions[1]&&(this.stopFading(),0===i&&(this.enabled=!1))}}return this._effectiveWeight=t},_updateTimeScale:function(e){var t=0;if(!this.paused){t=this.timeScale;var r=this._timeScaleInterpolant;if(null!==r)t*=r.evaluate(e)[0],e>r.parameterPositions[1]&&(this.stopWarping(),0===t?this.paused=!0:this.timeScale=t)}return this._effectiveTimeScale=t},_updateTime:function(e){var t=this.time+e;if(0===e)return t;var r=this._clip.duration,i=this.loop,n=this._loopCount;if(2200===i){-1===n&&(this._loopCount=0,this._setEndings(!0,!0,!1));e:{if(r<=t)t=r;else{if(!(t<0))break e;t=0}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this._mixer.dispatchEvent({type:"finished",action:this,direction:e<0?-1:1})}}else{var a=2202===i;if(-1===n&&(0<=e?(n=0,this._setEndings(!0,0===this.repetitions,a)):this._setEndings(0===this.repetitions,!0,a)),r<=t||t<0){var o=Math.floor(t/r);t-=r*o,n+=Math.abs(o);var s=this.repetitions-n;if(s<0)this.clampWhenFinished?this.paused=!0:this.enabled=!1,t=0<e?r:0,this._mixer.dispatchEvent({type:"finished",action:this,direction:0<e?1:-1});else{if(0===s){var c=e<0;this._setEndings(c,!c,a)}else this._setEndings(!1,!1,a);this._loopCount=n,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:o})}}if(a&&1==(1&n))return r-(this.time=t)}return this.time=t},_setEndings:function(e,t,r){var i=this._interpolantSettings;i.endingEnd=r?i.endingStart=pt:(i.endingStart=e?this.zeroSlopeAtStart?pt:dt:ft,t?this.zeroSlopeAtEnd?pt:dt:ft)},_scheduleFading:function(e,t,r){var i=this._mixer,n=i.time,a=this._weightInterpolant;null===a&&(a=i._lendControlInterpolant(),this._weightInterpolant=a);var o=a.parameterPositions,s=a.sampleValues;return o[0]=n,s[0]=t,o[1]=n+e,s[1]=r,this}}),Object.assign(AnimationMixer.prototype,EventDispatcher.prototype,{_bindAction:function(e,t){var r=e._localRoot||this._root,i=e._clip.tracks,n=i.length,a=e._propertyBindings,o=e._interpolants,s=r.uuid,c=this._bindingsByRootAndName,l=c[s];void 0===l&&(l={},c[s]=l);for(var h=0;h!==n;++h){var u=i[h],d=u.name,p=l[d];if(void 0!==p)a[h]=p;else{if(void 0!==(p=a[h])){null===p._cacheIndex&&(++p.referenceCount,this._addInactiveBinding(p,s,d));continue}var f=t&&t._propertyBindings[h].binding.parsedPath;++(p=new PropertyMixer(PropertyBinding.create(r,d,f),u.ValueTypeName,u.getValueSize())).referenceCount,this._addInactiveBinding(p,s,d),a[h]=p}o[h].resultBuffer=p.buffer}},_activateAction:function(e){if(!this._isActiveAction(e)){if(null===e._cacheIndex){var t=(e._localRoot||this._root).uuid,r=e._clip.uuid,i=this._actionsByClip[r];this._bindAction(e,i&&i.knownActions[0]),this._addInactiveAction(e,r,t)}for(var n=e._propertyBindings,a=0,o=n.length;a!==o;++a){var s=n[a];0==s.useCount++&&(this._lendBinding(s),s.saveOriginalState())}this._lendAction(e)}},_deactivateAction:function(e){if(this._isActiveAction(e)){for(var t=e._propertyBindings,r=0,i=t.length;r!==i;++r){var n=t[r];0==--n.useCount&&(n.restoreOriginalState(),this._takeBackBinding(n))}this._takeBackAction(e)}},_initMemoryManager:function(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;var e=this;this.stats={actions:{get total(){return e._actions.length},get inUse(){return e._nActiveActions}},bindings:{get total(){return e._bindings.length},get inUse(){return e._nActiveBindings}},controlInterpolants:{get total(){return e._controlInterpolants.length},get inUse(){return e._nActiveControlInterpolants}}}},_isActiveAction:function(e){var t=e._cacheIndex;return null!==t&&t<this._nActiveActions},_addInactiveAction:function(e,t,r){var i=this._actions,n=this._actionsByClip,a=n[t];if(void 0===a)a={knownActions:[e],actionByRoot:{}},e._byClipCacheIndex=0,n[t]=a;else{var o=a.knownActions;e._byClipCacheIndex=o.length,o.push(e)}e._cacheIndex=i.length,i.push(e),a.actionByRoot[r]=e},_removeInactiveAction:function(e){var t=this._actions,r=t[t.length-1],i=e._cacheIndex;t[r._cacheIndex=i]=r,t.pop(),e._cacheIndex=null;var n=e._clip.uuid,a=this._actionsByClip,o=a[n],s=o.knownActions,c=s[s.length-1],l=e._byClipCacheIndex;s[c._byClipCacheIndex=l]=c,s.pop(),e._byClipCacheIndex=null,delete o.actionByRoot[(e._localRoot||this._root).uuid],0===s.length&&delete a[n],this._removeInactiveBindingsForAction(e)},_removeInactiveBindingsForAction:function(e){for(var t=e._propertyBindings,r=0,i=t.length;r!==i;++r){var n=t[r];0==--n.referenceCount&&this._removeInactiveBinding(n)}},_lendAction:function(e){var t=this._actions,r=e._cacheIndex,i=this._nActiveActions++,n=t[i];t[e._cacheIndex=i]=e,t[n._cacheIndex=r]=n},_takeBackAction:function(e){var t=this._actions,r=e._cacheIndex,i=--this._nActiveActions,n=t[i];t[e._cacheIndex=i]=e,t[n._cacheIndex=r]=n},_addInactiveBinding:function(e,t,r){var i=this._bindingsByRootAndName,n=i[t],a=this._bindings;void 0===n&&(n={},i[t]=n),(n[r]=e)._cacheIndex=a.length,a.push(e)},_removeInactiveBinding:function(e){var t=this._bindings,r=e.binding,i=r.rootNode.uuid,n=r.path,a=this._bindingsByRootAndName,o=a[i],s=t[t.length-1],c=e._cacheIndex;t[s._cacheIndex=c]=s,t.pop(),delete o[n];e:{for(var l in o)break e;delete a[i]}},_lendBinding:function(e){var t=this._bindings,r=e._cacheIndex,i=this._nActiveBindings++,n=t[i];t[e._cacheIndex=i]=e,t[n._cacheIndex=r]=n},_takeBackBinding:function(e){var t=this._bindings,r=e._cacheIndex,i=--this._nActiveBindings,n=t[i];t[e._cacheIndex=i]=e,t[n._cacheIndex=r]=n},_lendControlInterpolant:function(){var e=this._controlInterpolants,t=this._nActiveControlInterpolants++,r=e[t];return void 0===r&&(e[(r=new LinearInterpolant(new Float32Array(2),new Float32Array(2),1,this._controlInterpolantsResultBuffer)).__cacheIndex=t]=r),r},_takeBackControlInterpolant:function(e){var t=this._controlInterpolants,r=e.__cacheIndex,i=--this._nActiveControlInterpolants,n=t[i];t[e.__cacheIndex=i]=e,t[n.__cacheIndex=r]=n},_controlInterpolantsResultBuffer:new Float32Array(1),clipAction:function(e,t){var r=t||this._root,i=r.uuid,n="string"==typeof e?AnimationClip.findByName(r,e):e,a=null!==n?n.uuid:e,o=this._actionsByClip[a],s=null;if(void 0!==o){var c=o.actionByRoot[i];if(void 0!==c)return c;s=o.knownActions[0],null===n&&(n=s._clip)}if(null===n)return null;var l=new AnimationAction(this,n,t);return this._bindAction(l,s),this._addInactiveAction(l,a,i),l},existingAction:function(e,t){var r=t||this._root,i=r.uuid,n="string"==typeof e?AnimationClip.findByName(r,e):e,a=n?n.uuid:e,o=this._actionsByClip[a];return void 0!==o&&o.actionByRoot[i]||null},stopAllAction:function(){var e=this._actions,t=this._nActiveActions,r=this._bindings,i=this._nActiveBindings;this._nActiveActions=0;for(var n=this._nActiveBindings=0;n!==t;++n)e[n].reset();for(n=0;n!==i;++n)r[n].useCount=0;return this},update:function(e){e*=this.timeScale;for(var t=this._actions,r=this._nActiveActions,i=this.time+=e,n=Math.sign(e),a=this._accuIndex^=1,o=0;o!==r;++o){t[o]._update(i,e,n,a)}var s=this._bindings,c=this._nActiveBindings;for(o=0;o!==c;++o)s[o].apply(a);return this},getRoot:function(){return this._root},uncacheClip:function(e){var t=this._actions,r=e.uuid,i=this._actionsByClip,n=i[r];if(void 0!==n){for(var a=n.knownActions,o=0,s=a.length;o!==s;++o){var c=a[o];this._deactivateAction(c);var l=c._cacheIndex,h=t[t.length-1];c._cacheIndex=null,c._byClipCacheIndex=null,t[h._cacheIndex=l]=h,t.pop(),this._removeInactiveBindingsForAction(c)}delete i[r]}},uncacheRoot:function(e){var t=e.uuid,r=this._actionsByClip;for(var i in r){var n=r[i].actionByRoot[t];void 0!==n&&(this._deactivateAction(n),this._removeInactiveAction(n))}var a=this._bindingsByRootAndName[t];if(void 0!==a)for(var o in a){var s=a[o];s.restoreOriginalState(),this._removeInactiveBinding(s)}},uncacheAction:function(e,t){var r=this.existingAction(e,t);null!==r&&(this._deactivateAction(r),this._removeInactiveAction(r))}}),Uniform.prototype.clone=function(){return new Uniform(void 0===this.value.clone?this.value:this.value.clone())},InstancedBufferGeometry.prototype=Object.assign(Object.create(BufferGeometry.prototype),{constructor:InstancedBufferGeometry,isInstancedBufferGeometry:!0,copy:function(e){return BufferGeometry.prototype.copy.call(this,e),this.maxInstancedCount=e.maxInstancedCount,this},clone:function(){return(new this.constructor).copy(this)}}),Object.defineProperties(InterleavedBufferAttribute.prototype,{count:{get:function(){return this.data.count}},array:{get:function(){return this.data.array}}}),Object.assign(InterleavedBufferAttribute.prototype,{isInterleavedBufferAttribute:!0,setX:function(e,t){return this.data.array[e*this.data.stride+this.offset]=t,this},setY:function(e,t){return this.data.array[e*this.data.stride+this.offset+1]=t,this},setZ:function(e,t){return this.data.array[e*this.data.stride+this.offset+2]=t,this},setW:function(e,t){return this.data.array[e*this.data.stride+this.offset+3]=t,this},getX:function(e){return this.data.array[e*this.data.stride+this.offset]},getY:function(e){return this.data.array[e*this.data.stride+this.offset+1]},getZ:function(e){return this.data.array[e*this.data.stride+this.offset+2]},getW:function(e){return this.data.array[e*this.data.stride+this.offset+3]},setXY:function(e,t,r){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=r,this},setXYZ:function(e,t,r,i){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=r,this.data.array[e+2]=i,this},setXYZW:function(e,t,r,i,n){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=r,this.data.array[e+2]=i,this.data.array[e+3]=n,this}}),Object.defineProperty(InterleavedBuffer.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),Object.assign(InterleavedBuffer.prototype,{isInterleavedBuffer:!0,setArray:function(e){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.count=void 0!==e?e.length/this.stride:0,this.array=e},setDynamic:function(e){return this.dynamic=e,this},copy:function(e){return this.array=new e.array.constructor(e.array),this.count=e.count,this.stride=e.stride,this.dynamic=e.dynamic,this},copyAt:function(e,t,r){e*=this.stride,r*=t.stride;for(var i=0,n=this.stride;i<n;i++)this.array[e+i]=t.array[r+i];return this},set:function(e,t){return void 0===t&&(t=0),this.array.set(e,t),this},clone:function(){return(new this.constructor).copy(this)},onUpload:function(e){return this.onUploadCallback=e,this}}),InstancedInterleavedBuffer.prototype=Object.assign(Object.create(InterleavedBuffer.prototype),{constructor:InstancedInterleavedBuffer,isInstancedInterleavedBuffer:!0,copy:function(e){return InterleavedBuffer.prototype.copy.call(this,e),this.meshPerAttribute=e.meshPerAttribute,this}}),InstancedBufferAttribute.prototype=Object.assign(Object.create(BufferAttribute.prototype),{constructor:InstancedBufferAttribute,isInstancedBufferAttribute:!0,copy:function(e){return BufferAttribute.prototype.copy.call(this,e),this.meshPerAttribute=e.meshPerAttribute,this}}),Object.assign(Raycaster.prototype,{linePrecision:1,set:function(e,t){this.ray.set(e,t)},setFromCamera:function(e,t){t&&t.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(t.matrixWorld),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(this.ray.origin).normalize()):t&&t.isOrthographicCamera?(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld)):console.error("THREE.Raycaster: Unsupported camera type.")},intersectObject:function(e,t){var r=[];return intersectObject(e,this,r,t),r.sort(ascSort),r},intersectObjects:function(e,t){var r=[];if(!1===Array.isArray(e))return console.warn("THREE.Raycaster.intersectObjects: objects is not an Array."),r;for(var i=0,n=e.length;i<n;i++)intersectObject(e[i],this,r,t);return r.sort(ascSort),r}}),Object.assign(Clock.prototype,{start:function(){this.startTime=("undefined"==typeof performance?Date:performance).now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0},stop:function(){this.getElapsedTime(),this.running=!1,this.autoStart=!1},getElapsedTime:function(){return this.getDelta(),this.elapsedTime},getDelta:function(){var e=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){var t=("undefined"==typeof performance?Date:performance).now();e=(t-this.oldTime)/1e3,this.oldTime=t,this.elapsedTime+=e}return e}}),Object.assign(Spherical.prototype,{set:function(e,t,r){return this.radius=e,this.phi=t,this.theta=r,this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.radius=e.radius,this.phi=e.phi,this.theta=e.theta,this},makeSafe:function(){return this.phi=Math.max(1e-6,Math.min(Math.PI-1e-6,this.phi)),this},setFromVector3:function(e){return this.radius=e.length(),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(e.x,e.z),this.phi=Math.acos(Et.clamp(e.y/this.radius,-1,1))),this}}),Object.assign(Cylindrical.prototype,{set:function(e,t,r){return this.radius=e,this.theta=t,this.y=r,this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.radius=e.radius,this.theta=e.theta,this.y=e.y,this},setFromVector3:function(e){return this.radius=Math.sqrt(e.x*e.x+e.z*e.z),this.theta=Math.atan2(e.x,e.z),this.y=e.y,this}}),((ImmediateRenderObject.prototype=Object.create(Object3D.prototype)).constructor=ImmediateRenderObject).prototype.isImmediateRenderObject=!0,((VertexNormalsHelper.prototype=Object.create(LineSegments.prototype)).constructor=VertexNormalsHelper).prototype.update=(dn=new Vector3,pn=new Vector3,fn=new Matrix3,function update(){var e=["a","b","c"];this.object.updateMatrixWorld(!0),fn.getNormalMatrix(this.object.matrixWorld);var t=this.object.matrixWorld,r=this.geometry.attributes.position,i=this.object.geometry;if(i&&i.isGeometry)for(var n=i.vertices,a=i.faces,o=0,s=0,c=a.length;s<c;s++)for(var l=a[s],h=0,u=l.vertexNormals.length;h<u;h++){var d=n[l[e[h]]],p=l.vertexNormals[h];dn.copy(d).applyMatrix4(t),pn.copy(p).applyMatrix3(fn).normalize().multiplyScalar(this.size).add(dn),r.setXYZ(o,dn.x,dn.y,dn.z),o+=1,r.setXYZ(o,pn.x,pn.y,pn.z),o+=1}else if(i&&i.isBufferGeometry){var f=i.attributes.position,m=i.attributes.normal;for(h=o=0,u=f.count;h<u;h++)dn.set(f.getX(h),f.getY(h),f.getZ(h)).applyMatrix4(t),pn.set(m.getX(h),m.getY(h),m.getZ(h)),pn.applyMatrix3(fn).normalize().multiplyScalar(this.size).add(dn),r.setXYZ(o,dn.x,dn.y,dn.z),o+=1,r.setXYZ(o,pn.x,pn.y,pn.z),o+=1}r.needsUpdate=!0}),((SpotLightHelper.prototype=Object.create(Object3D.prototype)).constructor=SpotLightHelper).prototype.dispose=function(){this.cone.geometry.dispose(),this.cone.material.dispose()},SpotLightHelper.prototype.update=(mn=new Vector3,gn=new Vector3,function update(){this.light.updateMatrixWorld();var e=this.light.distance?this.light.distance:1e3,t=e*Math.tan(this.light.angle);this.cone.scale.set(t,t,e),mn.setFromMatrixPosition(this.light.matrixWorld),gn.setFromMatrixPosition(this.light.target.matrixWorld),this.cone.lookAt(gn.sub(mn)),void 0!==this.color?this.cone.material.color.set(this.color):this.cone.material.color.copy(this.light.color)}),((SkeletonHelper.prototype=Object.create(LineSegments.prototype)).constructor=SkeletonHelper).prototype.updateMatrixWorld=(vn=new Vector3,yn=new Matrix4,xn=new Matrix4,function updateMatrixWorld(e){var t=this.bones,r=this.geometry,i=r.getAttribute("position");xn.getInverse(this.root.matrixWorld);for(var n=0,a=0;n<t.length;n++){var o=t[n];o.parent&&o.parent.isBone&&(yn.multiplyMatrices(xn,o.matrixWorld),vn.setFromMatrixPosition(yn),i.setXYZ(a,vn.x,vn.y,vn.z),yn.multiplyMatrices(xn,o.parent.matrixWorld),vn.setFromMatrixPosition(yn),i.setXYZ(a+1,vn.x,vn.y,vn.z),a+=2)}r.getAttribute("position").needsUpdate=!0,Object3D.prototype.updateMatrixWorld.call(this,e)}),((PointLightHelper.prototype=Object.create(Mesh.prototype)).constructor=PointLightHelper).prototype.dispose=function(){this.geometry.dispose(),this.material.dispose()},PointLightHelper.prototype.update=function(){void 0!==this.color?this.material.color.set(this.color):this.material.color.copy(this.light.color)},((RectAreaLightHelper.prototype=Object.create(Object3D.prototype)).constructor=RectAreaLightHelper).prototype.dispose=function(){this.children[0].geometry.dispose(),this.children[0].material.dispose()},RectAreaLightHelper.prototype.update=function(){var e=.5*this.light.width,t=.5*this.light.height,r=this.line.geometry.attributes.position,i=r.array;i[0]=e,i[1]=-t,i[2]=0,i[3]=e,i[4]=t,i[5]=0,i[6]=-e,i[7]=t,i[8]=0,i[9]=-e,i[10]=-t,i[11]=0,i[12]=e,i[13]=-t,i[14]=0,r.needsUpdate=!0,void 0!==this.color?this.line.material.color.set(this.color):this.line.material.color.copy(this.light.color)},((HemisphereLightHelper.prototype=Object.create(Object3D.prototype)).constructor=HemisphereLightHelper).prototype.dispose=function(){this.children[0].geometry.dispose(),this.children[0].material.dispose()},HemisphereLightHelper.prototype.update=(bn=new Vector3,Mn=new Color,_n=new Color,function update(){var e=this.children[0];if(void 0!==this.color)this.material.color.set(this.color);else{var t=e.geometry.getAttribute("color");Mn.copy(this.light.color),_n.copy(this.light.groundColor);for(var r=0,i=t.count;r<i;r++){var n=r<i/2?Mn:_n;t.setXYZ(r,n.r,n.g,n.b)}t.needsUpdate=!0}e.lookAt(bn.setFromMatrixPosition(this.light.matrixWorld).negate())}),(GridHelper.prototype=Object.create(LineSegments.prototype)).constructor=GridHelper,(PolarGridHelper.prototype=Object.create(LineSegments.prototype)).constructor=PolarGridHelper,((FaceNormalsHelper.prototype=Object.create(LineSegments.prototype)).constructor=FaceNormalsHelper).prototype.update=(wn=new Vector3,Tn=new Vector3,En=new Matrix3,function update(){this.object.updateMatrixWorld(!0),En.getNormalMatrix(this.object.matrixWorld);for(var e=this.object.matrixWorld,t=this.geometry.attributes.position,r=this.object.geometry,i=r.vertices,n=r.faces,a=0,o=0,s=n.length;o<s;o++){var c=n[o],l=c.normal;wn.copy(i[c.a]).add(i[c.b]).add(i[c.c]).divideScalar(3).applyMatrix4(e),Tn.copy(l).applyMatrix3(En).normalize().multiplyScalar(this.size).add(wn),t.setXYZ(a,wn.x,wn.y,wn.z),a+=1,t.setXYZ(a,Tn.x,Tn.y,Tn.z),a+=1}t.needsUpdate=!0}),((DirectionalLightHelper.prototype=Object.create(Object3D.prototype)).constructor=DirectionalLightHelper).prototype.dispose=function(){this.lightPlane.geometry.dispose(),this.lightPlane.material.dispose(),this.targetLine.geometry.dispose(),this.targetLine.material.dispose()},DirectionalLightHelper.prototype.update=(Sn=new Vector3,An=new Vector3,Ln=new Vector3,function update(){Sn.setFromMatrixPosition(this.light.matrixWorld),An.setFromMatrixPosition(this.light.target.matrixWorld),Ln.subVectors(An,Sn),this.lightPlane.lookAt(Ln),void 0!==this.color?(this.lightPlane.material.color.set(this.color),this.targetLine.material.color.set(this.color)):(this.lightPlane.material.color.copy(this.light.color),this.targetLine.material.color.copy(this.light.color)),this.targetLine.lookAt(Ln),this.targetLine.scale.z=Ln.length()}),((CameraHelper.prototype=Object.create(LineSegments.prototype)).constructor=CameraHelper).prototype.update=function(){var c,l,h=new Vector3,u=new Camera;function setPoint(e,t,r,i){h.set(t,r,i).unproject(u);var n=l[e];if(void 0!==n)for(var a=c.getAttribute("position"),o=0,s=n.length;o<s;o++)a.setXYZ(n[o],h.x,h.y,h.z)}return function update(){c=this.geometry,l=this.pointMap;u.projectionMatrix.copy(this.camera.projectionMatrix),setPoint("c",0,0,-1),setPoint("t",0,0,1),setPoint("n1",-1,-1,-1),setPoint("n2",1,-1,-1),setPoint("n3",-1,1,-1),setPoint("n4",1,1,-1),setPoint("f1",-1,-1,1),setPoint("f2",1,-1,1),setPoint("f3",-1,1,1),setPoint("f4",1,1,1),setPoint("u1",.7,1.1,-1),setPoint("u2",-.7,1.1,-1),setPoint("u3",0,2,-1),setPoint("cf1",-1,0,1),setPoint("cf2",1,0,1),setPoint("cf3",0,-1,1),setPoint("cf4",0,1,1),setPoint("cn1",-1,0,-1),setPoint("cn2",1,0,-1),setPoint("cn3",0,-1,-1),setPoint("cn4",0,1,-1),c.getAttribute("position").needsUpdate=!0}}(),((BoxHelper.prototype=Object.create(LineSegments.prototype)).constructor=BoxHelper).prototype.update=(Cn=new Box3,function update(e){if(void 0!==e&&console.warn("THREE.BoxHelper: .update() has no longer arguments."),void 0!==this.object&&Cn.setFromObject(this.object),!Cn.isEmpty()){var t=Cn.min,r=Cn.max,i=this.geometry.attributes.position,n=i.array;n[0]=r.x,n[1]=r.y,n[2]=r.z,n[3]=t.x,n[4]=r.y,n[5]=r.z,n[6]=t.x,n[7]=t.y,n[8]=r.z,n[9]=r.x,n[10]=t.y,n[11]=r.z,n[12]=r.x,n[13]=r.y,n[14]=t.z,n[15]=t.x,n[16]=r.y,n[17]=t.z,n[18]=t.x,n[19]=t.y,n[20]=t.z,n[21]=r.x,n[22]=t.y,n[23]=t.z,i.needsUpdate=!0,this.geometry.computeBoundingSphere()}}),BoxHelper.prototype.setFromObject=function(e){return this.object=e,this.update(),this},((Box3Helper.prototype=Object.create(LineSegments.prototype)).constructor=Box3Helper).prototype.updateMatrixWorld=function(e){var t=this.box;t.isEmpty()||(t.getCenter(this.position),t.getSize(this.scale),this.scale.multiplyScalar(.5),Object3D.prototype.updateMatrixWorld.call(this,e))},((PlaneHelper.prototype=Object.create(Line.prototype)).constructor=PlaneHelper).prototype.updateMatrixWorld=function(e){var t=-this.plane.constant;Math.abs(t)<1e-8&&(t=1e-8),this.scale.set(.5*this.size,.5*this.size,t),this.lookAt(this.plane.normal),Object3D.prototype.updateMatrixWorld.call(this,e)},((ArrowHelper.prototype=Object.create(Object3D.prototype)).constructor=ArrowHelper).prototype.setDirection=(In=new Vector3,function setDirection(e){.99999<e.y?this.quaternion.set(0,0,0,1):e.y<-.99999?this.quaternion.set(1,0,0,0):(In.set(e.z,0,-e.x).normalize(),Bn=Math.acos(e.y),this.quaternion.setFromAxisAngle(In,Bn))}),ArrowHelper.prototype.setLength=function(e,t,r){void 0===t&&(t=.2*e),void 0===r&&(r=.2*t),this.line.scale.set(1,Math.max(0,e-t),1),this.line.updateMatrix(),this.cone.scale.set(r,t,r),this.cone.position.y=e,this.cone.updateMatrix()},ArrowHelper.prototype.setColor=function(e){this.line.material.color.copy(e),this.cone.material.color.copy(e)},(AxesHelper.prototype=Object.create(LineSegments.prototype)).constructor=AxesHelper;var Gn=new Vector3,Un=new CubicPoly,On=new CubicPoly,Vn=new CubicPoly;function CatmullRomCurve3(e,t,r,i){Curve.call(this),this.type="CatmullRomCurve3",this.points=e||[],this.closed=t||!1,this.curveType=r||"centripetal",this.tension=i||.5}function CubicBezierCurve3(e,t,r,i){Curve.call(this),this.type="CubicBezierCurve3",this.v0=e||new Vector3,this.v1=t||new Vector3,this.v2=r||new Vector3,this.v3=i||new Vector3}function QuadraticBezierCurve3(e,t,r){Curve.call(this),this.type="QuadraticBezierCurve3",this.v0=e||new Vector3,this.v1=t||new Vector3,this.v2=r||new Vector3}function LineCurve3(e,t){Curve.call(this),this.type="LineCurve3",this.v1=e||new Vector3,this.v2=t||new Vector3}function ArcCurve(e,t,r,i,n,a){EllipseCurve.call(this,e,t,r,r,i,n,a),this.type="ArcCurve"}((CatmullRomCurve3.prototype=Object.create(Curve.prototype)).constructor=CatmullRomCurve3).prototype.isCatmullRomCurve3=!0,CatmullRomCurve3.prototype.getPoint=function(e,t){var r,i,n,a,o=t||new Vector3,s=this.points,c=s.length,l=(c-(this.closed?0:1))*e,h=Math.floor(l),u=l-h;if(this.closed?h+=0<h?0:(Math.floor(Math.abs(h)/s.length)+1)*s.length:0===u&&h===c-1&&(h=c-2,u=1),r=this.closed||0<h?s[(h-1)%c]:(Gn.subVectors(s[0],s[1]).add(s[0]),Gn),i=s[h%c],n=s[(h+1)%c],a=this.closed||h+2<c?s[(h+2)%c]:(Gn.subVectors(s[c-1],s[c-2]).add(s[c-1]),Gn),"centripetal"===this.curveType||"chordal"===this.curveType){var d="chordal"===this.curveType?.5:.25,p=Math.pow(r.distanceToSquared(i),d),f=Math.pow(i.distanceToSquared(n),d),m=Math.pow(n.distanceToSquared(a),d);f<1e-4&&(f=1),p<1e-4&&(p=f),m<1e-4&&(m=f),Un.initNonuniformCatmullRom(r.x,i.x,n.x,a.x,p,f,m),On.initNonuniformCatmullRom(r.y,i.y,n.y,a.y,p,f,m),Vn.initNonuniformCatmullRom(r.z,i.z,n.z,a.z,p,f,m)}else"catmullrom"===this.curveType&&(Un.initCatmullRom(r.x,i.x,n.x,a.x,this.tension),On.initCatmullRom(r.y,i.y,n.y,a.y,this.tension),Vn.initCatmullRom(r.z,i.z,n.z,a.z,this.tension));return o.set(Un.calc(u),On.calc(u),Vn.calc(u)),o},CatmullRomCurve3.prototype.copy=function(e){Curve.prototype.copy.call(this,e),this.points=[];for(var t=0,r=e.points.length;t<r;t++){var i=e.points[t];this.points.push(i.clone())}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this},((CubicBezierCurve3.prototype=Object.create(Curve.prototype)).constructor=CubicBezierCurve3).prototype.isCubicBezierCurve3=!0,CubicBezierCurve3.prototype.getPoint=function(e,t){var r=t||new Vector3,i=this.v0,n=this.v1,a=this.v2,o=this.v3;return r.set(CubicBezier(e,i.x,n.x,a.x,o.x),CubicBezier(e,i.y,n.y,a.y,o.y),CubicBezier(e,i.z,n.z,a.z,o.z)),r},CubicBezierCurve3.prototype.copy=function(e){return Curve.prototype.copy.call(this,e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this},((QuadraticBezierCurve3.prototype=Object.create(Curve.prototype)).constructor=QuadraticBezierCurve3).prototype.isQuadraticBezierCurve3=!0,QuadraticBezierCurve3.prototype.getPoint=function(e,t){var r=t||new Vector3,i=this.v0,n=this.v1,a=this.v2;return r.set(QuadraticBezier(e,i.x,n.x,a.x),QuadraticBezier(e,i.y,n.y,a.y),QuadraticBezier(e,i.z,n.z,a.z)),r},QuadraticBezierCurve3.prototype.copy=function(e){return Curve.prototype.copy.call(this,e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this},((LineCurve3.prototype=Object.create(Curve.prototype)).constructor=LineCurve3).prototype.isLineCurve3=!0,LineCurve3.prototype.getPoint=function(e,t){var r=t||new Vector3;return 1===e?r.copy(this.v2):(r.copy(this.v2).sub(this.v1),r.multiplyScalar(e).add(this.v1)),r},LineCurve3.prototype.getPointAt=function(e,t){return this.getPoint(e,t)},LineCurve3.prototype.copy=function(e){return Curve.prototype.copy.call(this,e),this.v1.copy(e.v1),this.v2.copy(e.v2),this},((ArcCurve.prototype=Object.create(EllipseCurve.prototype)).constructor=ArcCurve).prototype.isArcCurve=!0;var Fn={createMultiMaterialObject:function(e,t){for(var r=new Group,i=0,n=t.length;i<n;i++)r.add(new Mesh(e,t[i]));return r},detach:function(e,t,r){e.applyMatrix(t.matrixWorld),t.remove(e),r.add(e)},attach:function(e,t,r){e.applyMatrix((new Matrix4).getInverse(r.matrixWorld)),t.remove(e),r.add(e)}};var Nn;function ClosedSplineCurve3(e){console.warn("THREE.ClosedSplineCurve3 has been deprecated. Use THREE.CatmullRomCurve3 instead."),CatmullRomCurve3.call(this,e),this.type="catmullrom",this.closed=!0}function SplineCurve3(e){console.warn("THREE.SplineCurve3 has been deprecated. Use THREE.CatmullRomCurve3 instead."),CatmullRomCurve3.call(this,e),this.type="catmullrom"}function Spline(e){console.warn("THREE.Spline has been removed. Use THREE.CatmullRomCurve3 instead."),CatmullRomCurve3.call(this,e),this.type="catmullrom"}Curve.create=function(e,t){return console.log("THREE.Curve.create() has been deprecated"),e.prototype=Object.create(Curve.prototype),(e.prototype.constructor=e).prototype.getPoint=t,e},Object.assign(CurvePath.prototype,{createPointsGeometry:function(e){console.warn("THREE.CurvePath: .createPointsGeometry() has been removed. Use new THREE.Geometry().setFromPoints( points ) instead.");var t=this.getPoints(e);return this.createGeometry(t)},createSpacedPointsGeometry:function(e){console.warn("THREE.CurvePath: .createSpacedPointsGeometry() has been removed. Use new THREE.Geometry().setFromPoints( points ) instead.");var t=this.getSpacedPoints(e);return this.createGeometry(t)},createGeometry:function(e){console.warn("THREE.CurvePath: .createGeometry() has been removed. Use new THREE.Geometry().setFromPoints( points ) instead.");for(var t=new Geometry,r=0,i=e.length;r<i;r++){var n=e[r];t.vertices.push(new Vector3(n.x,n.y,n.z||0))}return t}}),Object.assign(Path.prototype,{fromPoints:function(e){console.warn("THREE.Path: .fromPoints() has been renamed to .setFromPoints()."),this.setFromPoints(e)}}),ClosedSplineCurve3.prototype=Object.create(CatmullRomCurve3.prototype),SplineCurve3.prototype=Object.create(CatmullRomCurve3.prototype),Spline.prototype=Object.create(CatmullRomCurve3.prototype),Object.assign(Spline.prototype,{initFromArray:function(){console.error("THREE.Spline: .initFromArray() has been removed.")},getControlPointsArray:function(){console.error("THREE.Spline: .getControlPointsArray() has been removed.")},reparametrizeByArcLength:function(){console.error("THREE.Spline: .reparametrizeByArcLength() has been removed.")}}),GridHelper.prototype.setColors=function(){console.error("THREE.GridHelper: setColors() has been deprecated, pass them in the constructor instead.")},SkeletonHelper.prototype.update=function(){console.error("THREE.SkeletonHelper: update() no longer needs to be called.")},Object.assign(Box2.prototype,{center:function(e){return console.warn("THREE.Box2: .center() has been renamed to .getCenter()."),this.getCenter(e)},empty:function(){return console.warn("THREE.Box2: .empty() has been renamed to .isEmpty()."),this.isEmpty()},isIntersectionBox:function(e){return console.warn("THREE.Box2: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},size:function(e){return console.warn("THREE.Box2: .size() has been renamed to .getSize()."),this.getSize(e)}}),Object.assign(Box3.prototype,{center:function(e){return console.warn("THREE.Box3: .center() has been renamed to .getCenter()."),this.getCenter(e)},empty:function(){return console.warn("THREE.Box3: .empty() has been renamed to .isEmpty()."),this.isEmpty()},isIntersectionBox:function(e){return console.warn("THREE.Box3: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},isIntersectionSphere:function(e){return console.warn("THREE.Box3: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(e)},size:function(e){return console.warn("THREE.Box3: .size() has been renamed to .getSize()."),this.getSize(e)}}),Line3.prototype.center=function(e){return console.warn("THREE.Line3: .center() has been renamed to .getCenter()."),this.getCenter(e)},Object.assign(Et,{random16:function(){return console.warn("THREE.Math: .random16() has been deprecated. Use Math.random() instead."),Math.random()},nearestPowerOfTwo:function(e){return console.warn("THREE.Math: .nearestPowerOfTwo() has been renamed to .floorPowerOfTwo()."),Et.floorPowerOfTwo(e)},nextPowerOfTwo:function(e){return console.warn("THREE.Math: .nextPowerOfTwo() has been renamed to .ceilPowerOfTwo()."),Et.ceilPowerOfTwo(e)}}),Object.assign(Matrix3.prototype,{flattenToArrayOffset:function(e,t){return console.warn("THREE.Matrix3: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(e,t)},multiplyVector3:function(e){return console.warn("THREE.Matrix3: .multiplyVector3() has been removed. Use vector.applyMatrix3( matrix ) instead."),e.applyMatrix3(this)},multiplyVector3Array:function(){console.error("THREE.Matrix3: .multiplyVector3Array() has been removed.")},applyToBuffer:function(e){return console.warn("THREE.Matrix3: .applyToBuffer() has been removed. Use matrix.applyToBufferAttribute( attribute ) instead."),this.applyToBufferAttribute(e)},applyToVector3Array:function(){console.error("THREE.Matrix3: .applyToVector3Array() has been removed.")}}),Object.assign(Matrix4.prototype,{extractPosition:function(e){return console.warn("THREE.Matrix4: .extractPosition() has been renamed to .copyPosition()."),this.copyPosition(e)},flattenToArrayOffset:function(e,t){return console.warn("THREE.Matrix4: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(e,t)},getPosition:function getPosition(){return void 0===Nn&&(Nn=new Vector3),console.warn("THREE.Matrix4: .getPosition() has been removed. Use Vector3.setFromMatrixPosition( matrix ) instead."),Nn.setFromMatrixColumn(this,3)},setRotationFromQuaternion:function(e){return console.warn("THREE.Matrix4: .setRotationFromQuaternion() has been renamed to .makeRotationFromQuaternion()."),this.makeRotationFromQuaternion(e)},multiplyToArray:function(){console.warn("THREE.Matrix4: .multiplyToArray() has been removed.")},multiplyVector3:function(e){return console.warn("THREE.Matrix4: .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},multiplyVector4:function(e){return console.warn("THREE.Matrix4: .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},multiplyVector3Array:function(){console.error("THREE.Matrix4: .multiplyVector3Array() has been removed.")},rotateAxis:function(e){console.warn("THREE.Matrix4: .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead."),e.transformDirection(this)},crossVector:function(e){return console.warn("THREE.Matrix4: .crossVector() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},translate:function(){console.error("THREE.Matrix4: .translate() has been removed.")},rotateX:function(){console.error("THREE.Matrix4: .rotateX() has been removed.")},rotateY:function(){console.error("THREE.Matrix4: .rotateY() has been removed.")},rotateZ:function(){console.error("THREE.Matrix4: .rotateZ() has been removed.")},rotateByAxis:function(){console.error("THREE.Matrix4: .rotateByAxis() has been removed.")},applyToBuffer:function(e){return console.warn("THREE.Matrix4: .applyToBuffer() has been removed. Use matrix.applyToBufferAttribute( attribute ) instead."),this.applyToBufferAttribute(e)},applyToVector3Array:function(){console.error("THREE.Matrix4: .applyToVector3Array() has been removed.")},makeFrustum:function(e,t,r,i,n,a){return console.warn("THREE.Matrix4: .makeFrustum() has been removed. Use .makePerspective( left, right, top, bottom, near, far ) instead."),this.makePerspective(e,t,i,r,n,a)}}),Plane.prototype.isIntersectionLine=function(e){return console.warn("THREE.Plane: .isIntersectionLine() has been renamed to .intersectsLine()."),this.intersectsLine(e)},Quaternion.prototype.multiplyVector3=function(e){return console.warn("THREE.Quaternion: .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead."),e.applyQuaternion(this)},Object.assign(Ray.prototype,{isIntersectionBox:function(e){return console.warn("THREE.Ray: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},isIntersectionPlane:function(e){return console.warn("THREE.Ray: .isIntersectionPlane() has been renamed to .intersectsPlane()."),this.intersectsPlane(e)},isIntersectionSphere:function(e){return console.warn("THREE.Ray: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(e)}}),Object.assign(Shape.prototype,{extractAllPoints:function(e){return console.warn("THREE.Shape: .extractAllPoints() has been removed. Use .extractPoints() instead."),this.extractPoints(e)},extrude:function(e){return console.warn("THREE.Shape: .extrude() has been removed. Use ExtrudeGeometry() instead."),new ExtrudeGeometry(this,e)},makeGeometry:function(e){return console.warn("THREE.Shape: .makeGeometry() has been removed. Use ShapeGeometry() instead."),new ShapeGeometry(this,e)}}),Object.assign(Vector2.prototype,{fromAttribute:function(e,t,r){return console.warn("THREE.Vector2: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(e,t,r)},distanceToManhattan:function(e){return console.warn("THREE.Vector2: .distanceToManhattan() has been renamed to .manhattanDistanceTo()."),this.manhattanDistanceTo(e)},lengthManhattan:function(){return console.warn("THREE.Vector2: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()}}),Object.assign(Vector3.prototype,{setEulerFromRotationMatrix:function(){console.error("THREE.Vector3: .setEulerFromRotationMatrix() has been removed. Use Euler.setFromRotationMatrix() instead.")},setEulerFromQuaternion:function(){console.error("THREE.Vector3: .setEulerFromQuaternion() has been removed. Use Euler.setFromQuaternion() instead.")},getPositionFromMatrix:function(e){return console.warn("THREE.Vector3: .getPositionFromMatrix() has been renamed to .setFromMatrixPosition()."),this.setFromMatrixPosition(e)},getScaleFromMatrix:function(e){return console.warn("THREE.Vector3: .getScaleFromMatrix() has been renamed to .setFromMatrixScale()."),this.setFromMatrixScale(e)},getColumnFromMatrix:function(e,t){return console.warn("THREE.Vector3: .getColumnFromMatrix() has been renamed to .setFromMatrixColumn()."),this.setFromMatrixColumn(t,e)},applyProjection:function(e){return console.warn("THREE.Vector3: .applyProjection() has been removed. Use .applyMatrix4( m ) instead."),this.applyMatrix4(e)},fromAttribute:function(e,t,r){return console.warn("THREE.Vector3: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(e,t,r)},distanceToManhattan:function(e){return console.warn("THREE.Vector3: .distanceToManhattan() has been renamed to .manhattanDistanceTo()."),this.manhattanDistanceTo(e)},lengthManhattan:function(){return console.warn("THREE.Vector3: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()}}),Object.assign(Vector4.prototype,{fromAttribute:function(e,t,r){return console.warn("THREE.Vector4: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(e,t,r)},lengthManhattan:function(){return console.warn("THREE.Vector4: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()}}),Geometry.prototype.computeTangents=function(){console.warn("THREE.Geometry: .computeTangents() has been removed.")},Object.assign(Object3D.prototype,{getChildByName:function(e){return console.warn("THREE.Object3D: .getChildByName() has been renamed to .getObjectByName()."),this.getObjectByName(e)},renderDepth:function(){console.warn("THREE.Object3D: .renderDepth has been removed. Use .renderOrder, instead.")},translate:function(e,t){return console.warn("THREE.Object3D: .translate() has been removed. Use .translateOnAxis( axis, distance ) instead."),this.translateOnAxis(t,e)}}),Object.defineProperties(Object3D.prototype,{eulerOrder:{get:function(){return console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order},set:function(e){console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order=e}},useQuaternion:{get:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")},set:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")}}}),Object.defineProperties(LOD.prototype,{objects:{get:function(){return console.warn("THREE.LOD: .objects has been renamed to .levels."),this.levels}}}),Object.defineProperty(Skeleton.prototype,"useVertexTexture",{get:function(){console.warn("THREE.Skeleton: useVertexTexture has been removed.")},set:function(){console.warn("THREE.Skeleton: useVertexTexture has been removed.")}}),Object.defineProperty(Curve.prototype,"__arcLengthDivisions",{get:function(){return console.warn("THREE.Curve: .__arcLengthDivisions is now .arcLengthDivisions."),this.arcLengthDivisions},set:function(e){console.warn("THREE.Curve: .__arcLengthDivisions is now .arcLengthDivisions."),this.arcLengthDivisions=e}}),PerspectiveCamera.prototype.setLens=function(e,t){console.warn("THREE.PerspectiveCamera.setLens is deprecated. Use .setFocalLength and .filmGauge for a photographic setup."),void 0!==t&&(this.filmGauge=t),this.setFocalLength(e)},Object.defineProperties(Light.prototype,{onlyShadow:{set:function(){console.warn("THREE.Light: .onlyShadow has been removed.")}},shadowCameraFov:{set:function(e){console.warn("THREE.Light: .shadowCameraFov is now .shadow.camera.fov."),this.shadow.camera.fov=e}},shadowCameraLeft:{set:function(e){console.warn("THREE.Light: .shadowCameraLeft is now .shadow.camera.left."),this.shadow.camera.left=e}},shadowCameraRight:{set:function(e){console.warn("THREE.Light: .shadowCameraRight is now .shadow.camera.right."),this.shadow.camera.right=e}},shadowCameraTop:{set:function(e){console.warn("THREE.Light: .shadowCameraTop is now .shadow.camera.top."),this.shadow.camera.top=e}},shadowCameraBottom:{set:function(e){console.warn("THREE.Light: .shadowCameraBottom is now .shadow.camera.bottom."),this.shadow.camera.bottom=e}},shadowCameraNear:{set:function(e){console.warn("THREE.Light: .shadowCameraNear is now .shadow.camera.near."),this.shadow.camera.near=e}},shadowCameraFar:{set:function(e){console.warn("THREE.Light: .shadowCameraFar is now .shadow.camera.far."),this.shadow.camera.far=e}},shadowCameraVisible:{set:function(){console.warn("THREE.Light: .shadowCameraVisible has been removed. Use new THREE.CameraHelper( light.shadow.camera ) instead.")}},shadowBias:{set:function(e){console.warn("THREE.Light: .shadowBias is now .shadow.bias."),this.shadow.bias=e}},shadowDarkness:{set:function(){console.warn("THREE.Light: .shadowDarkness has been removed.")}},shadowMapWidth:{set:function(e){console.warn("THREE.Light: .shadowMapWidth is now .shadow.mapSize.width."),this.shadow.mapSize.width=e}},shadowMapHeight:{set:function(e){console.warn("THREE.Light: .shadowMapHeight is now .shadow.mapSize.height."),this.shadow.mapSize.height=e}}}),Object.defineProperties(BufferAttribute.prototype,{length:{get:function(){return console.warn("THREE.BufferAttribute: .length has been deprecated. Use .count instead."),this.array.length}}}),Object.assign(BufferGeometry.prototype,{addIndex:function(e){console.warn("THREE.BufferGeometry: .addIndex() has been renamed to .setIndex()."),this.setIndex(e)},addDrawCall:function(e,t,r){void 0!==r&&console.warn("THREE.BufferGeometry: .addDrawCall() no longer supports indexOffset."),console.warn("THREE.BufferGeometry: .addDrawCall() is now .addGroup()."),this.addGroup(e,t)},clearDrawCalls:function(){console.warn("THREE.BufferGeometry: .clearDrawCalls() is now .clearGroups()."),this.clearGroups()},computeTangents:function(){console.warn("THREE.BufferGeometry: .computeTangents() has been removed.")},computeOffsets:function(){console.warn("THREE.BufferGeometry: .computeOffsets() has been removed.")}}),Object.defineProperties(BufferGeometry.prototype,{drawcalls:{get:function(){return console.error("THREE.BufferGeometry: .drawcalls has been renamed to .groups."),this.groups}},offsets:{get:function(){return console.warn("THREE.BufferGeometry: .offsets has been renamed to .groups."),this.groups}}}),Object.defineProperties(Uniform.prototype,{dynamic:{set:function(){console.warn("THREE.Uniform: .dynamic has been removed. Use object.onBeforeRender() instead.")}},onUpdate:{value:function(){return console.warn("THREE.Uniform: .onUpdate() has been removed. Use object.onBeforeRender() instead."),this}}}),Object.defineProperties(Material.prototype,{wrapAround:{get:function(){console.warn("THREE.Material: .wrapAround has been removed.")},set:function(){console.warn("THREE.Material: .wrapAround has been removed.")}},wrapRGB:{get:function(){return console.warn("THREE.Material: .wrapRGB has been removed."),new Color}},shading:{get:function(){console.error("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead.")},set:function(e){console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=1===e}}}),Object.defineProperties(MeshPhongMaterial.prototype,{metal:{get:function(){return console.warn("THREE.MeshPhongMaterial: .metal has been removed. Use THREE.MeshStandardMaterial instead."),!1},set:function(){console.warn("THREE.MeshPhongMaterial: .metal has been removed. Use THREE.MeshStandardMaterial instead")}}}),Object.defineProperties(ShaderMaterial.prototype,{derivatives:{get:function(){return console.warn("THREE.ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives},set:function(e){console.warn("THREE. ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives=e}}}),Object.assign(WebGLRenderer.prototype,{getCurrentRenderTarget:function(){return console.warn("THREE.WebGLRenderer: .getCurrentRenderTarget() is now .getRenderTarget()."),this.getRenderTarget()},getMaxAnisotropy:function(){return console.warn("THREE.WebGLRenderer: .getMaxAnisotropy() is now .capabilities.getMaxAnisotropy()."),this.capabilities.getMaxAnisotropy()},getPrecision:function(){return console.warn("THREE.WebGLRenderer: .getPrecision() is now .capabilities.precision."),this.capabilities.precision},resetGLState:function(){return console.warn("THREE.WebGLRenderer: .resetGLState() is now .state.reset()."),this.state.reset()},supportsFloatTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsFloatTextures() is now .extensions.get( 'OES_texture_float' )."),this.extensions.get("OES_texture_float")},supportsHalfFloatTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsHalfFloatTextures() is now .extensions.get( 'OES_texture_half_float' )."),this.extensions.get("OES_texture_half_float")},supportsStandardDerivatives:function(){return console.warn("THREE.WebGLRenderer: .supportsStandardDerivatives() is now .extensions.get( 'OES_standard_derivatives' )."),this.extensions.get("OES_standard_derivatives")},supportsCompressedTextureS3TC:function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTextureS3TC() is now .extensions.get( 'WEBGL_compressed_texture_s3tc' )."),this.extensions.get("WEBGL_compressed_texture_s3tc")},supportsCompressedTexturePVRTC:function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTexturePVRTC() is now .extensions.get( 'WEBGL_compressed_texture_pvrtc' )."),this.extensions.get("WEBGL_compressed_texture_pvrtc")},supportsBlendMinMax:function(){return console.warn("THREE.WebGLRenderer: .supportsBlendMinMax() is now .extensions.get( 'EXT_blend_minmax' )."),this.extensions.get("EXT_blend_minmax")},supportsVertexTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsVertexTextures() is now .capabilities.vertexTextures."),this.capabilities.vertexTextures},supportsInstancedArrays:function(){return console.warn("THREE.WebGLRenderer: .supportsInstancedArrays() is now .extensions.get( 'ANGLE_instanced_arrays' )."),this.extensions.get("ANGLE_instanced_arrays")},enableScissorTest:function(e){console.warn("THREE.WebGLRenderer: .enableScissorTest() is now .setScissorTest()."),this.setScissorTest(e)},initMaterial:function(){console.warn("THREE.WebGLRenderer: .initMaterial() has been removed.")},addPrePlugin:function(){console.warn("THREE.WebGLRenderer: .addPrePlugin() has been removed.")},addPostPlugin:function(){console.warn("THREE.WebGLRenderer: .addPostPlugin() has been removed.")},updateShadowMap:function(){console.warn("THREE.WebGLRenderer: .updateShadowMap() has been removed.")}}),Object.defineProperties(WebGLRenderer.prototype,{shadowMapEnabled:{get:function(){return this.shadowMap.enabled},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapEnabled is now .shadowMap.enabled."),this.shadowMap.enabled=e}},shadowMapType:{get:function(){return this.shadowMap.type},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapType is now .shadowMap.type."),this.shadowMap.type=e}},shadowMapCullFace:{get:function(){return this.shadowMap.cullFace},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapCullFace is now .shadowMap.cullFace."),this.shadowMap.cullFace=e}}}),Object.defineProperties(WebGLShadowMap.prototype,{cullFace:{get:function(){return this.renderReverseSided?U:G},set:function(e){var t=e!==G;console.warn("WebGLRenderer: .shadowMap.cullFace is deprecated. Set .shadowMap.renderReverseSided to "+t+"."),this.renderReverseSided=t}}}),Object.defineProperties(WebGLRenderTarget.prototype,{wrapS:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS},set:function(e){console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS=e}},wrapT:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT},set:function(e){console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT=e}},magFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter},set:function(e){console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter=e}},minFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter},set:function(e){console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter=e}},anisotropy:{get:function(){return console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy},set:function(e){console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy=e}},offset:{get:function(){return console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset},set:function(e){console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset=e}},repeat:{get:function(){return console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat},set:function(e){console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat=e}},format:{get:function(){return console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format},set:function(e){console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format=e}},type:{get:function(){return console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type},set:function(e){console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type=e}},generateMipmaps:{get:function(){return console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps},set:function(e){console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps=e}}}),Audio.prototype.load=function(e){console.warn("THREE.Audio: .load has been deprecated. Use THREE.AudioLoader instead.");var t=this;return(new AudioLoader).load(e,function(e){t.setBuffer(e)}),this},AudioAnalyser.prototype.getData=function(){return console.warn("THREE.AudioAnalyser: .getData() is now .getFrequencyData()."),this.getFrequencyData()},CubeCamera.prototype.updateCubeMap=function(e,t){return console.warn("THREE.CubeCamera: .updateCubeMap() is now .update()."),this.update(e,t)};var zn={merge:function(e,t,r){var i;console.warn("THREE.GeometryUtils: .merge() has been moved to Geometry. Use geometry.merge( geometry2, matrix, materialIndexOffset ) instead."),t.isMesh&&(t.matrixAutoUpdate&&t.updateMatrix(),i=t.matrix,t=t.geometry),e.merge(t,i,r)},center:function(e){return console.warn("THREE.GeometryUtils: .center() has been moved to Geometry. Use geometry.center() instead."),e.center()}},Hn={crossOrigin:void 0,loadTexture:function(e,t,r,i){console.warn("THREE.ImageUtils.loadTexture has been deprecated. Use THREE.TextureLoader() instead.");var n=new TextureLoader;n.setCrossOrigin(this.crossOrigin);var a=n.load(e,r,void 0,i);return t&&(a.mapping=t),a},loadTextureCube:function(e,t,r,i){console.warn("THREE.ImageUtils.loadTextureCube has been deprecated. Use THREE.CubeTextureLoader() instead.");var n=new CubeTextureLoader;n.setCrossOrigin(this.crossOrigin);var a=n.load(e,r,void 0,i);return t&&(a.mapping=t),a},loadCompressedTexture:function(){console.error("THREE.ImageUtils.loadCompressedTexture has been removed. Use THREE.DDSLoader instead.")},loadCompressedTextureCube:function(){console.error("THREE.ImageUtils.loadCompressedTextureCube has been removed. Use THREE.DDSLoader instead.")}};e.WebGLRenderTargetCube=WebGLRenderTargetCube,e.WebGLRenderTarget=WebGLRenderTarget,e.WebGLRenderer=WebGLRenderer,e.ShaderLib=Ht,e.UniformsLib=Ft,e.UniformsUtils=Nt,e.ShaderChunk=zt,e.FogExp2=FogExp2,e.Fog=Fog,e.Scene=Scene,e.LensFlare=LensFlare,e.Sprite=Sprite,e.LOD=LOD,e.SkinnedMesh=SkinnedMesh,e.Skeleton=Skeleton,e.Bone=Bone,e.Mesh=Mesh,e.LineSegments=LineSegments,e.LineLoop=LineLoop,e.Line=Line,e.Points=Points,e.Group=Group,e.VideoTexture=VideoTexture,e.DataTexture=DataTexture,e.CompressedTexture=CompressedTexture,e.CubeTexture=CubeTexture,e.CanvasTexture=CanvasTexture,e.DepthTexture=DepthTexture,e.Texture=Texture,e.CompressedTextureLoader=CompressedTextureLoader,e.DataTextureLoader=DataTextureLoader,e.CubeTextureLoader=CubeTextureLoader,e.TextureLoader=TextureLoader,e.ObjectLoader=ObjectLoader,e.MaterialLoader=MaterialLoader,e.BufferGeometryLoader=BufferGeometryLoader,e.DefaultLoadingManager=Ii,e.LoadingManager=LoadingManager,e.JSONLoader=JSONLoader,e.ImageLoader=ImageLoader,e.FontLoader=FontLoader,e.FileLoader=FileLoader,e.Loader=Loader,e.Cache=Bi,e.AudioLoader=AudioLoader,e.SpotLightShadow=SpotLightShadow,e.SpotLight=SpotLight,e.PointLight=PointLight,e.RectAreaLight=RectAreaLight,e.HemisphereLight=HemisphereLight,e.DirectionalLightShadow=DirectionalLightShadow,e.DirectionalLight=DirectionalLight,e.AmbientLight=AmbientLight,e.LightShadow=LightShadow,e.Light=Light,e.StereoCamera=StereoCamera,e.PerspectiveCamera=PerspectiveCamera,e.OrthographicCamera=OrthographicCamera,e.CubeCamera=CubeCamera,e.ArrayCamera=ArrayCamera,e.Camera=Camera,e.AudioListener=AudioListener,e.PositionalAudio=PositionalAudio,e.AudioContext=Dn,e.AudioAnalyser=AudioAnalyser,e.Audio=Audio,e.VectorKeyframeTrack=VectorKeyframeTrack,e.StringKeyframeTrack=StringKeyframeTrack,e.QuaternionKeyframeTrack=QuaternionKeyframeTrack,e.NumberKeyframeTrack=NumberKeyframeTrack,e.ColorKeyframeTrack=ColorKeyframeTrack,e.BooleanKeyframeTrack=BooleanKeyframeTrack,e.PropertyMixer=PropertyMixer,e.PropertyBinding=PropertyBinding,e.KeyframeTrack=KeyframeTrack,e.AnimationUtils=Ui,e.AnimationObjectGroup=AnimationObjectGroup,e.AnimationMixer=AnimationMixer,e.AnimationClip=AnimationClip,e.Uniform=Uniform,e.InstancedBufferGeometry=InstancedBufferGeometry,e.BufferGeometry=BufferGeometry,e.Geometry=Geometry,e.InterleavedBufferAttribute=InterleavedBufferAttribute,e.InstancedInterleavedBuffer=InstancedInterleavedBuffer,e.InterleavedBuffer=InterleavedBuffer,e.InstancedBufferAttribute=InstancedBufferAttribute,e.Face3=Face3,e.Object3D=Object3D,e.Raycaster=Raycaster,e.Layers=Layers,e.EventDispatcher=EventDispatcher,e.Clock=Clock,e.QuaternionLinearInterpolant=QuaternionLinearInterpolant,e.LinearInterpolant=LinearInterpolant,e.DiscreteInterpolant=DiscreteInterpolant,e.CubicInterpolant=CubicInterpolant,e.Interpolant=Interpolant,e.Triangle=Triangle,e.Math=Et,e.Spherical=Spherical,e.Cylindrical=Cylindrical,e.Plane=Plane,e.Frustum=Frustum,e.Sphere=Sphere,e.Ray=Ray,e.Matrix4=Matrix4,e.Matrix3=Matrix3,e.Box3=Box3,e.Box2=Box2,e.Line3=Line3,e.Euler=Euler,e.Vector4=Vector4,e.Vector3=Vector3,e.Vector2=Vector2,e.Quaternion=Quaternion,e.Color=Color,e.ImmediateRenderObject=ImmediateRenderObject,e.VertexNormalsHelper=VertexNormalsHelper,e.SpotLightHelper=SpotLightHelper,e.SkeletonHelper=SkeletonHelper,e.PointLightHelper=PointLightHelper,e.RectAreaLightHelper=RectAreaLightHelper,e.HemisphereLightHelper=HemisphereLightHelper,e.GridHelper=GridHelper,e.PolarGridHelper=PolarGridHelper,e.FaceNormalsHelper=FaceNormalsHelper,e.DirectionalLightHelper=DirectionalLightHelper,e.CameraHelper=CameraHelper,e.BoxHelper=BoxHelper,e.Box3Helper=Box3Helper,e.PlaneHelper=PlaneHelper,e.ArrowHelper=ArrowHelper,e.AxesHelper=AxesHelper,e.CatmullRomCurve3=CatmullRomCurve3,e.CubicBezierCurve3=CubicBezierCurve3,e.QuadraticBezierCurve3=QuadraticBezierCurve3,e.LineCurve3=LineCurve3,e.ArcCurve=ArcCurve,e.EllipseCurve=EllipseCurve,e.SplineCurve=SplineCurve,e.CubicBezierCurve=CubicBezierCurve,e.QuadraticBezierCurve=QuadraticBezierCurve,e.LineCurve=LineCurve,e.Shape=Shape,e.Path=Path,e.ShapePath=ShapePath,e.Font=Font,e.CurvePath=CurvePath,e.Curve=Curve,e.ShapeUtils=Ci,e.SceneUtils=Fn,e.WebGLUtils=WebGLUtils,e.WireframeGeometry=WireframeGeometry,e.ParametricGeometry=ParametricGeometry,e.ParametricBufferGeometry=ParametricBufferGeometry,e.TetrahedronGeometry=TetrahedronGeometry,e.TetrahedronBufferGeometry=TetrahedronBufferGeometry,e.OctahedronGeometry=OctahedronGeometry,e.OctahedronBufferGeometry=OctahedronBufferGeometry,e.IcosahedronGeometry=IcosahedronGeometry,e.IcosahedronBufferGeometry=IcosahedronBufferGeometry,e.DodecahedronGeometry=DodecahedronGeometry,e.DodecahedronBufferGeometry=DodecahedronBufferGeometry,e.PolyhedronGeometry=PolyhedronGeometry,e.PolyhedronBufferGeometry=PolyhedronBufferGeometry,e.TubeGeometry=TubeGeometry,e.TubeBufferGeometry=TubeBufferGeometry,e.TorusKnotGeometry=TorusKnotGeometry,e.TorusKnotBufferGeometry=TorusKnotBufferGeometry,e.TorusGeometry=TorusGeometry,e.TorusBufferGeometry=TorusBufferGeometry,e.TextGeometry=TextGeometry,e.TextBufferGeometry=TextBufferGeometry,e.SphereGeometry=SphereGeometry,e.SphereBufferGeometry=SphereBufferGeometry,e.RingGeometry=RingGeometry,e.RingBufferGeometry=RingBufferGeometry,e.PlaneGeometry=PlaneGeometry,e.PlaneBufferGeometry=PlaneBufferGeometry,e.LatheGeometry=LatheGeometry,e.LatheBufferGeometry=LatheBufferGeometry,e.ShapeGeometry=ShapeGeometry,e.ShapeBufferGeometry=ShapeBufferGeometry,e.ExtrudeGeometry=ExtrudeGeometry,e.ExtrudeBufferGeometry=ExtrudeBufferGeometry,e.EdgesGeometry=EdgesGeometry,e.ConeGeometry=ConeGeometry,e.ConeBufferGeometry=ConeBufferGeometry,e.CylinderGeometry=CylinderGeometry,e.CylinderBufferGeometry=CylinderBufferGeometry,e.CircleGeometry=CircleGeometry,e.CircleBufferGeometry=CircleBufferGeometry,e.BoxGeometry=BoxGeometry,e.BoxBufferGeometry=BoxBufferGeometry,e.ShadowMaterial=ShadowMaterial,e.SpriteMaterial=SpriteMaterial,e.RawShaderMaterial=RawShaderMaterial,e.ShaderMaterial=ShaderMaterial,e.PointsMaterial=PointsMaterial,e.MeshPhysicalMaterial=MeshPhysicalMaterial,e.MeshStandardMaterial=MeshStandardMaterial,e.MeshPhongMaterial=MeshPhongMaterial,e.MeshToonMaterial=MeshToonMaterial,e.MeshNormalMaterial=MeshNormalMaterial,e.MeshLambertMaterial=MeshLambertMaterial,e.MeshDepthMaterial=MeshDepthMaterial,e.MeshDistanceMaterial=MeshDistanceMaterial,e.MeshBasicMaterial=MeshBasicMaterial,e.LineDashedMaterial=LineDashedMaterial,e.LineBasicMaterial=LineBasicMaterial,e.Material=Material,e.Float64BufferAttribute=Float64BufferAttribute,e.Float32BufferAttribute=Float32BufferAttribute,e.Uint32BufferAttribute=Uint32BufferAttribute,e.Int32BufferAttribute=Int32BufferAttribute,e.Uint16BufferAttribute=Uint16BufferAttribute,e.Int16BufferAttribute=Int16BufferAttribute,e.Uint8ClampedBufferAttribute=Uint8ClampedBufferAttribute,e.Uint8BufferAttribute=Uint8BufferAttribute,e.Int8BufferAttribute=Int8BufferAttribute,e.BufferAttribute=BufferAttribute,e.REVISION="88",e.MOUSE={LEFT:0,MIDDLE:1,RIGHT:2},e.CullFaceNone=D,e.CullFaceBack=G,e.CullFaceFront=U,e.CullFaceFrontBack=3,e.FrontFaceDirectionCW=0,e.FrontFaceDirectionCCW=1,e.BasicShadowMap=0,e.PCFShadowMap=O,e.PCFSoftShadowMap=R,e.FrontSide=V,e.BackSide=X,e.DoubleSide=q,e.FlatShading=1,e.SmoothShading=2,e.NoColors=pe,e.FaceColors=1,e.VertexColors=E,e.NoBlending=F,e.NormalBlending=N,e.AdditiveBlending=z,e.SubtractiveBlending=H,e.MultiplyBlending=k,e.CustomBlending=j,e.AddEquation=S,e.SubtractEquation=A,e.ReverseSubtractEquation=L,e.MinEquation=C,e.MaxEquation=P,e.ZeroFactor=B,e.OneFactor=I,e.SrcColorFactor=W,e.OneMinusSrcColorFactor=Y,e.SrcAlphaFactor=Z,e.OneMinusSrcAlphaFactor=Q,e.DstAlphaFactor=K,e.OneMinusDstAlphaFactor=J,e.DstColorFactor=$,e.OneMinusDstColorFactor=ee,e.SrcAlphaSaturateFactor=te,e.NeverDepth=re,e.AlwaysDepth=ie,e.LessDepth=ne,e.LessEqualDepth=ae,e.EqualDepth=oe,e.GreaterEqualDepth=se,e.GreaterDepth=ce,e.NotEqualDepth=le,e.MultiplyOperation=he,e.MixOperation=ue,e.AddOperation=de,e.NoToneMapping=fe,e.LinearToneMapping=me,e.ReinhardToneMapping=ge,e.Uncharted2ToneMapping=ve,e.CineonToneMapping=ye,e.UVMapping=300,e.CubeReflectionMapping=xe,e.CubeRefractionMapping=be,e.EquirectangularReflectionMapping=Me,e.EquirectangularRefractionMapping=_e,e.SphericalReflectionMapping=we,e.CubeUVReflectionMapping=Te,e.CubeUVRefractionMapping=Ee,e.RepeatWrapping=Se,e.ClampToEdgeWrapping=Ae,e.MirroredRepeatWrapping=Le,e.NearestFilter=Ce,e.NearestMipMapNearestFilter=Pe,e.NearestMipMapLinearFilter=Re,e.LinearFilter=Be,e.LinearMipMapNearestFilter=Ie,e.LinearMipMapLinearFilter=De,e.UnsignedByteType=Ge,e.ByteType=Ue,e.ShortType=Oe,e.UnsignedShortType=Ve,e.IntType=Fe,e.UnsignedIntType=Ne,e.FloatType=ze,e.HalfFloatType=He,e.UnsignedShort4444Type=ke,e.UnsignedShort5551Type=je,e.UnsignedShort565Type=We,e.UnsignedInt248Type=Xe,e.AlphaFormat=qe,e.RGBFormat=Ye,e.RGBAFormat=Ze,e.LuminanceFormat=Qe,e.LuminanceAlphaFormat=Ke,e.RGBEFormat=Je,e.DepthFormat=$e,e.DepthStencilFormat=et,e.RGB_S3TC_DXT1_Format=tt,e.RGBA_S3TC_DXT1_Format=rt,e.RGBA_S3TC_DXT3_Format=it,e.RGBA_S3TC_DXT5_Format=nt,e.RGB_PVRTC_4BPPV1_Format=at,e.RGB_PVRTC_2BPPV1_Format=ot,e.RGBA_PVRTC_4BPPV1_Format=st,e.RGBA_PVRTC_2BPPV1_Format=ct,e.RGB_ETC1_Format=lt,e.LoopOnce=2200,e.LoopRepeat=2201,e.LoopPingPong=2202,e.InterpolateDiscrete=ht,e.InterpolateLinear=ut,e.InterpolateSmooth=2302,e.ZeroCurvatureEnding=dt,e.ZeroSlopeEnding=pt,e.WrapAroundEnding=ft,e.TrianglesDrawMode=mt,e.TriangleStripDrawMode=1,e.TriangleFanDrawMode=2,e.LinearEncoding=gt,e.sRGBEncoding=vt,e.GammaEncoding=yt,e.RGBEEncoding=xt,e.LogLuvEncoding=3003,e.RGBM7Encoding=bt,e.RGBM16Encoding=Mt,e.RGBDEncoding=_t,e.BasicDepthPacking=wt,e.RGBADepthPacking=Tt,e.CubeGeometry=BoxGeometry,e.Face4=function Face4(e,t,r,i,n,a,o){return console.warn("THREE.Face4 has been removed. A THREE.Face3 will be created instead."),new Face3(e,t,r,n,a,o)},e.LineStrip=0,e.LinePieces=1,e.MeshFaceMaterial=function MeshFaceMaterial(e){return console.warn("THREE.MeshFaceMaterial has been removed. Use an Array instead."),e},e.MultiMaterial=function MultiMaterial(e){return void 0===e&&(e=[]),console.warn("THREE.MultiMaterial has been removed. Use an Array instead."),e.isMultiMaterial=!0,(e.materials=e).clone=function(){return e.slice()},e},e.PointCloud=function PointCloud(e,t){return console.warn("THREE.PointCloud has been renamed to THREE.Points."),new Points(e,t)},e.Particle=function Particle(e){return console.warn("THREE.Particle has been renamed to THREE.Sprite."),new Sprite(e)},e.ParticleSystem=function ParticleSystem(e,t){return console.warn("THREE.ParticleSystem has been renamed to THREE.Points."),new Points(e,t)},e.PointCloudMaterial=function PointCloudMaterial(e){return console.warn("THREE.PointCloudMaterial has been renamed to THREE.PointsMaterial."),new PointsMaterial(e)},e.ParticleBasicMaterial=function ParticleBasicMaterial(e){return console.warn("THREE.ParticleBasicMaterial has been renamed to THREE.PointsMaterial."),new PointsMaterial(e)},e.ParticleSystemMaterial=function ParticleSystemMaterial(e){return console.warn("THREE.ParticleSystemMaterial has been renamed to THREE.PointsMaterial."),new PointsMaterial(e)},e.Vertex=function Vertex(e,t,r){return console.warn("THREE.Vertex has been removed. Use THREE.Vector3 instead."),new Vector3(e,t,r)},e.DynamicBufferAttribute=function DynamicBufferAttribute(e,t){return console.warn("THREE.DynamicBufferAttribute has been removed. Use new THREE.BufferAttribute().setDynamic( true ) instead."),new BufferAttribute(e,t).setDynamic(!0)},e.Int8Attribute=function Int8Attribute(e,t){return console.warn("THREE.Int8Attribute has been removed. Use new THREE.Int8BufferAttribute() instead."),new Int8BufferAttribute(e,t)},e.Uint8Attribute=function Uint8Attribute(e,t){return console.warn("THREE.Uint8Attribute has been removed. Use new THREE.Uint8BufferAttribute() instead."),new Uint8BufferAttribute(e,t)},e.Uint8ClampedAttribute=function Uint8ClampedAttribute(e,t){return console.warn("THREE.Uint8ClampedAttribute has been removed. Use new THREE.Uint8ClampedBufferAttribute() instead."),new Uint8ClampedBufferAttribute(e,t)},e.Int16Attribute=function Int16Attribute(e,t){return console.warn("THREE.Int16Attribute has been removed. Use new THREE.Int16BufferAttribute() instead."),new Int16BufferAttribute(e,t)},e.Uint16Attribute=function Uint16Attribute(e,t){return console.warn("THREE.Uint16Attribute has been removed. Use new THREE.Uint16BufferAttribute() instead."),new Uint16BufferAttribute(e,t)},e.Int32Attribute=function Int32Attribute(e,t){return console.warn("THREE.Int32Attribute has been removed. Use new THREE.Int32BufferAttribute() instead."),new Int32BufferAttribute(e,t)},e.Uint32Attribute=function Uint32Attribute(e,t){return console.warn("THREE.Uint32Attribute has been removed. Use new THREE.Uint32BufferAttribute() instead."),new Uint32BufferAttribute(e,t)},e.Float32Attribute=function Float32Attribute(e,t){return console.warn("THREE.Float32Attribute has been removed. Use new THREE.Float32BufferAttribute() instead."),new Float32BufferAttribute(e,t)},e.Float64Attribute=function Float64Attribute(e,t){return console.warn("THREE.Float64Attribute has been removed. Use new THREE.Float64BufferAttribute() instead."),new Float64BufferAttribute(e,t)},e.ClosedSplineCurve3=ClosedSplineCurve3,e.SplineCurve3=SplineCurve3,e.Spline=Spline,e.AxisHelper=function AxisHelper(e){return console.warn("THREE.AxisHelper has been renamed to THREE.AxesHelper."),new AxesHelper(e)},e.BoundingBoxHelper=function BoundingBoxHelper(e,t){return console.warn("THREE.BoundingBoxHelper has been deprecated. Creating a THREE.BoxHelper instead."),new BoxHelper(e,t)},e.EdgesHelper=function EdgesHelper(e,t){return console.warn("THREE.EdgesHelper has been removed. Use THREE.EdgesGeometry instead."),new LineSegments(new EdgesGeometry(e.geometry),new LineBasicMaterial({color:void 0!==t?t:16777215}))},e.WireframeHelper=function WireframeHelper(e,t){return console.warn("THREE.WireframeHelper has been removed. Use THREE.WireframeGeometry instead."),new LineSegments(new WireframeGeometry(e.geometry),new LineBasicMaterial({color:void 0!==t?t:16777215}))},e.XHRLoader=function XHRLoader(e){return console.warn("THREE.XHRLoader has been renamed to THREE.FileLoader."),new FileLoader(e)},e.BinaryTextureLoader=function BinaryTextureLoader(e){return console.warn("THREE.BinaryTextureLoader has been renamed to THREE.DataTextureLoader."),new DataTextureLoader(e)},e.GeometryUtils=zn,e.ImageUtils=Hn,e.Projector=function Projector(){console.error("THREE.Projector has been moved to /examples/js/renderers/Projector.js."),this.projectVector=function(e,t){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(t)},this.unprojectVector=function(e,t){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(t)},this.pickingRay=function(){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")}},e.CanvasRenderer=function CanvasRenderer(){console.error("THREE.CanvasRenderer has been moved to /examples/js/renderers/CanvasRenderer.js"),this.domElement=document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),this.clear=function(){},this.render=function(){},this.setClearColor=function(){},this.setSize=function(){}},Object.defineProperty(e,"__esModule",{value:!0})});
THREE.OrbitControls=function(e,t){var o,n,a,i,s;this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.target=new THREE.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.25,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=function(){return p.phi},this.getAzimuthalAngle=function(){return p.theta},this.saveState=function(){r.target0.copy(r.target),r.position0.copy(r.object.position),r.zoom0=r.object.zoom},this.reset=function(){r.target.copy(r.target0),r.object.position.copy(r.position0),r.object.zoom=r.zoom0,r.object.updateProjectionMatrix(),r.dispatchEvent(c),r.update(),m=d.NONE},this.update=(o=new THREE.Vector3,n=(new THREE.Quaternion).setFromUnitVectors(e.up,new THREE.Vector3(0,1,0)),a=n.clone().inverse(),i=new THREE.Vector3,s=new THREE.Quaternion,function update(){var e=r.object.position;return o.copy(e).sub(r.target),o.applyQuaternion(n),p.setFromVector3(o),r.autoRotate&&m===d.NONE&&rotateLeft(function getAutoRotationAngle(){return 2*Math.PI/60/60*r.autoRotateSpeed}()),p.theta+=E.theta,p.phi+=E.phi,p.theta=Math.max(r.minAzimuthAngle,Math.min(r.maxAzimuthAngle,p.theta)),p.phi=Math.max(r.minPolarAngle,Math.min(r.maxPolarAngle,p.phi)),p.makeSafe(),p.radius*=b,p.radius=Math.max(r.minDistance,Math.min(r.maxDistance,p.radius)),r.target.add(T),o.setFromSpherical(p),o.applyQuaternion(a),e.copy(r.target).add(o),r.object.lookAt(r.target),!0===r.enableDamping?(E.theta*=1-r.dampingFactor,E.phi*=1-r.dampingFactor):E.set(0,0,0),b=1,T.set(0,0,0),!(!(g||i.distanceToSquared(r.object.position)>h||8*(1-s.dot(r.object.quaternion))>h)||(r.dispatchEvent(c),i.copy(r.object.position),s.copy(r.object.quaternion),g=!1))}),this.dispose=function(){r.domElement.removeEventListener("contextmenu",onContextMenu,!1),r.domElement.removeEventListener("mousedown",onMouseDown,!1),r.domElement.removeEventListener("wheel",onMouseWheel,!1),r.domElement.removeEventListener("touchstart",onTouchStart,!1),r.domElement.removeEventListener("touchend",onTouchEnd,!1),r.domElement.removeEventListener("touchmove",onTouchMove,!1),document.removeEventListener("mousemove",onMouseMove,!1),document.removeEventListener("mouseup",onMouseUp,!1),window.removeEventListener("keydown",onKeyDown,!1)};var r=this,c={type:"change"},u={type:"start"},l={type:"end"},d={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},m=d.NONE,h=1e-6,p=new THREE.Spherical,E=new THREE.Spherical,b=1,T=new THREE.Vector3,g=!1,f=new THREE.Vector2,v=new THREE.Vector2,y=new THREE.Vector2,R=new THREE.Vector2,O=new THREE.Vector2,M=new THREE.Vector2,w=new THREE.Vector2,H=new THREE.Vector2,P=new THREE.Vector2;function getZoomScale(){return Math.pow(.95,r.zoomSpeed)}function rotateLeft(e){E.theta-=e}function rotateUp(e){E.phi-=e}var j,C,D,L=(j=new THREE.Vector3,function panLeft(e,t){j.setFromMatrixColumn(t,0),j.multiplyScalar(-e),T.add(j)}),S=(C=new THREE.Vector3,function panUp(e,t){C.setFromMatrixColumn(t,1),C.multiplyScalar(e),T.add(C)}),A=(D=new THREE.Vector3,function pan(e,t){var o=r.domElement===document?r.domElement.body:r.domElement;if(r.object.isPerspectiveCamera){var n=r.object.position;D.copy(n).sub(r.target);var a=D.length();a*=Math.tan(r.object.fov/2*Math.PI/180),L(2*e*a/o.clientHeight,r.object.matrix),S(2*t*a/o.clientHeight,r.object.matrix)}else r.object.isOrthographicCamera?(L(e*(r.object.right-r.object.left)/r.object.zoom/o.clientWidth,r.object.matrix),S(t*(r.object.top-r.object.bottom)/r.object.zoom/o.clientHeight,r.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),r.enablePan=!1)});function dollyIn(e){r.object.isPerspectiveCamera?b/=e:r.object.isOrthographicCamera?(r.object.zoom=Math.max(r.minZoom,Math.min(r.maxZoom,r.object.zoom*e)),r.object.updateProjectionMatrix(),g=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),r.enableZoom=!1)}function dollyOut(e){r.object.isPerspectiveCamera?b*=e:r.object.isOrthographicCamera?(r.object.zoom=Math.max(r.minZoom,Math.min(r.maxZoom,r.object.zoom/e)),r.object.updateProjectionMatrix(),g=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),r.enableZoom=!1)}function onMouseDown(e){if(!1!==r.enabled){switch(e.preventDefault(),e.button){case r.mouseButtons.ORBIT:if(!1===r.enableRotate)return;!function handleMouseDownRotate(e){f.set(e.clientX,e.clientY)}(e),m=d.ROTATE;break;case r.mouseButtons.ZOOM:if(!1===r.enableZoom)return;!function handleMouseDownDolly(e){w.set(e.clientX,e.clientY)}(e),m=d.DOLLY;break;case r.mouseButtons.PAN:if(!1===r.enablePan)return;!function handleMouseDownPan(e){R.set(e.clientX,e.clientY)}(e),m=d.PAN}m!==d.NONE&&(document.addEventListener("mousemove",onMouseMove,!1),document.addEventListener("mouseup",onMouseUp,!1),r.dispatchEvent(u))}}function onMouseMove(e){if(!1!==r.enabled)switch(e.preventDefault(),m){case d.ROTATE:if(!1===r.enableRotate)return;!function handleMouseMoveRotate(e){v.set(e.clientX,e.clientY),y.subVectors(v,f);var t=r.domElement===document?r.domElement.body:r.domElement;rotateLeft(2*Math.PI*y.x/t.clientWidth*r.rotateSpeed),rotateUp(2*Math.PI*y.y/t.clientHeight*r.rotateSpeed),f.copy(v),r.update()}(e);break;case d.DOLLY:if(!1===r.enableZoom)return;!function handleMouseMoveDolly(e){H.set(e.clientX,e.clientY),P.subVectors(H,w),0<P.y?dollyIn(getZoomScale()):P.y<0&&dollyOut(getZoomScale()),w.copy(H),r.update()}(e);break;case d.PAN:if(!1===r.enablePan)return;!function handleMouseMovePan(e){O.set(e.clientX,e.clientY),M.subVectors(O,R),A(M.x,M.y),R.copy(O),r.update()}(e)}}function onMouseUp(e){!1!==r.enabled&&(document.removeEventListener("mousemove",onMouseMove,!1),document.removeEventListener("mouseup",onMouseUp,!1),r.dispatchEvent(l),m=d.NONE)}function onMouseWheel(e){!1===r.enabled||!1===r.enableZoom||m!==d.NONE&&m!==d.ROTATE||(e.preventDefault(),e.stopPropagation(),function handleMouseWheel(e){e.deltaY<0?dollyOut(getZoomScale()):0<e.deltaY&&dollyIn(getZoomScale()),r.update()}(e),r.dispatchEvent(u),r.dispatchEvent(l))}function onKeyDown(e){!1!==r.enabled&&!1!==r.enableKeys&&!1!==r.enablePan&&function handleKeyDown(e){switch(e.keyCode){case r.keys.UP:A(0,r.keyPanSpeed),r.update();break;case r.keys.BOTTOM:A(0,-r.keyPanSpeed),r.update();break;case r.keys.LEFT:A(r.keyPanSpeed,0),r.update();break;case r.keys.RIGHT:A(-r.keyPanSpeed,0),r.update()}}(e)}function onTouchStart(e){if(!1!==r.enabled){switch(e.touches.length){case 1:if(!1===r.enableRotate)return;!function handleTouchStartRotate(e){f.set(e.touches[0].pageX,e.touches[0].pageY)}(e),m=d.TOUCH_ROTATE;break;case 2:if(!1===r.enableZoom)return;!function handleTouchStartDolly(e){var t=e.touches[0].pageX-e.touches[1].pageX,o=e.touches[0].pageY-e.touches[1].pageY,n=Math.sqrt(t*t+o*o);w.set(0,n)}(e),m=d.TOUCH_DOLLY;break;case 3:if(!1===r.enablePan)return;!function handleTouchStartPan(e){R.set(e.touches[0].pageX,e.touches[0].pageY)}(e),m=d.TOUCH_PAN;break;default:m=d.NONE}m!==d.NONE&&r.dispatchEvent(u)}}function onTouchMove(e){if(!1!==r.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:if(!1===r.enableRotate)return;if(m!==d.TOUCH_ROTATE)return;!function handleTouchMoveRotate(e){v.set(e.touches[0].pageX,e.touches[0].pageY),y.subVectors(v,f);var t=r.domElement===document?r.domElement.body:r.domElement;rotateLeft(2*Math.PI*y.x/t.clientWidth*r.rotateSpeed),rotateUp(2*Math.PI*y.y/t.clientHeight*r.rotateSpeed),f.copy(v),r.update()}(e);break;case 2:if(!1===r.enableZoom)return;if(m!==d.TOUCH_DOLLY)return;!function handleTouchMoveDolly(e){var t=e.touches[0].pageX-e.touches[1].pageX,o=e.touches[0].pageY-e.touches[1].pageY,n=Math.sqrt(t*t+o*o);H.set(0,n),P.subVectors(H,w),0<P.y?dollyOut(getZoomScale()):P.y<0&&dollyIn(getZoomScale()),w.copy(H),r.update()}(e);break;case 3:if(!1===r.enablePan)return;if(m!==d.TOUCH_PAN)return;!function handleTouchMovePan(e){O.set(e.touches[0].pageX,e.touches[0].pageY),M.subVectors(O,R),A(M.x,M.y),R.copy(O),r.update()}(e);break;default:m=d.NONE}}function onTouchEnd(e){!1!==r.enabled&&(r.dispatchEvent(l),m=d.NONE)}function onContextMenu(e){!1!==r.enabled&&e.preventDefault()}r.domElement.addEventListener("contextmenu",onContextMenu,!1),r.domElement.addEventListener("mousedown",onMouseDown,!1),r.domElement.addEventListener("wheel",onMouseWheel,!1),r.domElement.addEventListener("touchstart",onTouchStart,!1),r.domElement.addEventListener("touchend",onTouchEnd,!1),r.domElement.addEventListener("touchmove",onTouchMove,!1),window.addEventListener("keydown",onKeyDown,!1),this.update()},THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.OrbitControls.prototype.constructor=THREE.OrbitControls,Object.defineProperties(THREE.OrbitControls.prototype,{center:{get:function(){return console.warn("THREE.OrbitControls: .center has been renamed to .target"),this.target}},noZoom:{get:function(){return console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),!this.enableZoom},set:function(e){console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),this.enableZoom=!e}},noRotate:{get:function(){return console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),!this.enableRotate},set:function(e){console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),this.enableRotate=!e}},noPan:{get:function(){return console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),!this.enablePan},set:function(e){console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),this.enablePan=!e}},noKeys:{get:function(){return console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),!this.enableKeys},set:function(e){console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),this.enableKeys=!e}},staticMoving:{get:function(){return console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),!this.enableDamping},set:function(e){console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),this.enableDamping=!e}},dynamicDampingFactor:{get:function(){return console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor},set:function(e){console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor=e}}});
/* Chart interface logic for Duet Web Control
 * 
 * written by Christian Hammacher (c) 2016-2017
 * 
 * licensed under the terms of the GPL v3
 * see http://www.gnu.org/licenses/gpl-3.0.html
 */

// Temperature chart options
var maxTemperatureSamples = 1000;

var tempChart;
var tempChartOptions = 	{
	// This array should hold maxHeaters + maxTempSensors items
	colors: ["#0000FF", "#FF0000", "#00DD00", "#FFA000", "#FF00FF", "#337AB7", "#000000", "#E0E000",							// Heater colors
			"#AEAEAE", "#BC0000", "#00CB00", "#0000DC", "#FEABEF", "#A0A000", "#DDDD00", "#00BDBD", "#CCBBAA", "#AA00AA"],		// Virtual heater colors
	grid: {
		borderWidth: 0
	},
	xaxis: {
		show: false
		/*labelWidth: 0,
		labelHeight: 0,
		tickSize: 30000,
		tickFormatter: function() { return ""; },
		reserveSpace: false*/
	},
	yaxis: {
		min: 0,
		max: 280
	}
};

var recordedTemperatures, extraSensorVisibility;
var maxLayerTime = 0;
var refreshTempChart = false;

// Print chart options
var printChart;
var printChartOptions =	{
	colors: ["#EDC240"],
	grid: {
		borderWidth: 0,
		hoverable: true,
		clickable: true
	},
	pan: {
		interactive: true
	},
	series: {
		lines: {
			show: true
		},
		points: {
			show: true
		}
	},
	xaxis: {
		min: 1,
		tickDecimals: 0,
	},
	yaxis: {
		min: 0,
		max: 30,
		ticks: 5,
		tickDecimals: 0,
		tickFormatter: function(val) {
			if (!val) {
				return "";
			} else {
				return formatTime(val);
			}
		}
	},
	zoom: {
		interactive: true
	}
};

var refreshPrintChart = false;
var layerData;


/* Temperature chart */

function recordCurrentTemperatures(temps) {
	var timeNow = (new Date()).getTime();

	// Add temperatures for each heater
	// Also cut off the last one if there are too many temperature samples
	for(var heater = 0; heater < maxHeaters; heater++) {
		if (heater < temps.length && heatersInUse[heater]) {
			recordedTemperatures[heater].push([timeNow, temps[heater]]);
		} else {
			recordedTemperatures[heater].push([]);
		}

		if (recordedTemperatures[heater].length > maxTemperatureSamples) {
			recordedTemperatures[heater].shift();
		}
	}
}

function recordExtraTemperatures(temps) {
	var timeNow = (new Date()).getTime();

	// Add dashed series for each temperature sensor
	for(var i = 0; i < maxTempSensors; i++)
	{
		if (i < temps.length) {
			recordedTemperatures[maxHeaters + i].data.push([timeNow, temps[i].temp]);
		} else {
			recordedTemperatures[maxHeaters + i].data.push([]);
		}

		if (recordedTemperatures[maxHeaters + i].data.length > maxTemperatureSamples) {
			recordedTemperatures[maxHeaters + i].data.shift();
		}
	}
}

function drawTemperatureChart() {
	// Only draw the chart if it's possible
	if ($("#chart_temp").width() === 0) {
		refreshTempChart = true;
		return;
	}

	// Check if we need to recreate the chart
	var recreateChart = false;
	if (tempLimit != tempChartOptions.yaxis.max) {
		tempChartOptions.yaxis.max = tempLimit;
		recreateChart = true;
	}

	// Draw it
	if (tempChart == undefined || recreateChart) {
		tempChart = $.plot("#chart_temp", recordedTemperatures, tempChartOptions);
	} else {
		tempChart.setData(recordedTemperatures);
		tempChart.setupGrid();
		tempChart.draw();
	}

	refreshTempChart = false;
}

function setExtraTemperatureVisibility(sensor, visible) {
	// Update visibility
	recordedTemperatures[maxHeaters + sensor].dashes.show = visible;

	// Save state
	extraSensorVisibility[sensor] = visible;
	setLocalSetting("extraSensorVisibility", extraSensorVisibility);
}


/* Print statistics chart */

function addLayerData(lastLayerTime, filamentUsed, updateGui) {
	layerData.push([layerData.length + 1, lastLayerTime, filamentUsed]);
	if (lastLayerTime > maxLayerTime) {
		maxLayerTime = lastLayerTime;
	}

	if (updateGui) {
		$("#td_last_layertime").html(formatTime(lastLayerTime)).addClass("layer-done-animation");
		setTimeout(function() {
			$("#td_last_layertime").removeClass("layer-done-animation");
		}, 2000);

		drawPrintChart();
	}
}

function drawPrintChart() {
	// Only draw the chart if it's possible
	if ($("#chart_print").width() === 0) {
		refreshPrintChart = true;
		return;
	}

	// Find absolute maximum values for the X axis
	var maxX = 25, maxPanX = 25;
	if (layerData.length < 21) {
		maxX = maxPanX = 20;
	} else if (layerData.length < 25) {
		maxX = maxPanX = layerData.length;
	} else {
		maxPanX = layerData.length;
	}
	printChartOptions.xaxis.max = maxX;
	printChartOptions.xaxis.panRange = [1, maxPanX];
	printChartOptions.xaxis.zoomRange = [25, maxPanX];

	// Find max visible value for Y axis
	var maxY = 30;
	if (layerData.length > 1) {
		var firstLayerToCheck = (layerData.length > 26) ? layerData.length - 25 : 1;
		for(var i = firstLayerToCheck; i < layerData.length; i++) {
			var layerVal = layerData[i][1] * 1.1;
			if (maxY < layerVal) {
				maxY = layerVal;
			}
		}
	}
	printChartOptions.yaxis.max = maxY;
	printChartOptions.yaxis.panRange = [0, (maxLayerTime < maxY) ? maxY : maxLayerTime];
	printChartOptions.yaxis.zoomRange = [30, (maxLayerTime < maxY) ? maxY : maxLayerTime];

	// Update chart and pan to the right
	printChart = $.plot("#chart_print", [layerData], printChartOptions);
	printChart.pan({ left: 99999 });
	refreshPrintChart = false;

	// Add hover events to chart
	$("#chart_print").unbind("plothover").bind("plothover", function(e, pos, item) {
		if (item) {
			// Get layer number and time used
			var layer = item.datapoint[0];
			var timeUsed = item.datapoint[1];

			// Get filament usage
			var filamentUsed;
			if (layer > 1) {
				filamentUsed = layerData[layer - 1][2] - layerData[layer - 2][2];
			} else {
				filamentUsed = layerData[layer - 1][2];
			}

			// Build tool tip
			var toolTip =	"<center><strong>" + T("Layer {0}", layer) + "</strong></center><br/>";
			toolTip +=		T("Time: {0}", formatTime(timeUsed)) + "<br/>";
			toolTip +=		T("Filament usage: {0} mm", filamentUsed.toFixed(1));

			// Show it
			$("#layer_tooltip").html(toolTip).css({top: item.pageY + 5, left: item.pageX + 5}).fadeIn(200);
		} else {
			$("#layer_tooltip").hide();
		}
	});
}


/* Common functions */

function resizeCharts() {
	var contentHeight = $("#table_tools").height();
	if (!$("#div_heaters").hasClass("hidden")) {
		contentHeight = $("#table_heaters").height();
	} else if (!$("#div_extra").hasClass("hidden")) {
		contentHeight = $("#table_extra").height();
	}

	var statusHeight = 0;
	$("#div_status table").each(function() {
		statusHeight += $(this).outerHeight();
	});

	var max = (contentHeight > statusHeight) ? contentHeight : statusHeight;
	var padding = $("#chart_temp").parent().outerHeight() - $("#chart_temp").height();
	max -= padding;

	if (max > 0) {
		$("#chart_temp").css("height", max);
	}

	if (refreshTempChart) {
		drawTemperatureChart();
	}
	if (refreshPrintChart) {
		drawPrintChart();
	}
}

$(".panel-chart").resize(function() {
	resizeCharts();
});

function resetChartData() {
	// Initialize visibility states of the extra temperature sensors
	extraSensorVisibility = getLocalSetting("extraSensorVisibility", null);
	if (extraSensorVisibility == null || extraSensorVisibility.length < maxTempSensors) {
		extraSensorVisibility = [];
		for(var i = 0; i < maxTempSensors; i++) {
			// Don't show any extra temperatures in the chart by default
			extraSensorVisibility.push(false);
		}
	}

	// Reset data of the temperature chart
	recordedTemperatures = [];
	for(var i = 0; i < maxHeaters; i++) {
		recordedTemperatures.push([]);
	}

	for(var i = 0; i < maxTempSensors; i++) {
		recordedTemperatures.push({
			dashes: { show: extraSensorVisibility[i] },
			lines: { show: false },
			data: []
		});

		$("#table_extra tr input[type='checkbox']").eq(i).prop("checked", extraSensorVisibility[i]);
	}

	// Reset data of the layer chart
	layerData = [];
	maxLayerTime = 0;
}
/* Communication routines between RepRapFirmware and Duet Web Control
 * 
 * written by Christian Hammacher (c) 2016-2018
 * 
 * licensed under the terms of the GPL v3
 * see http://www.gnu.org/licenses/gpl-3.0.html
 */


var ajaxPrefix = "";					// Host to use for AJAX requests + "?" char or empty if running on a webserver
var defaultPassword = "reprap";			// Default password that is used when a new connection is established
var sessionPassword = defaultPassword	// The actual password of the board
var reconnectInterval = 1000;			// Interval in which DWC attempts to reconnect to the firmware
var sessionTimeout = 8000;				// Time in ms before RepRapFirmware kills our session

var isConnected = false;				// Are we connected?
var firstConnect = true;				// Are we trying to connect for the first time?
var justConnected = false;				// Have we just connected?

var reconnectingAfterHalt = false;		// Are we trying to reconnect after a firmware halt?
var reconnectingAfterUpdate = false;	// Are we trying to reconnect after a firmware update?
var resetConfirmationShown = false;		// Have we shown a prompt to send a reset code yet?

var updateTaskLive = false;				// Are status responses being polled?
var stopUpdating = false;				// This will be true if status updates should be no longer polled
var extendedStatusCounter = 0;			// Counts the number of regular status updates so extended ones are polled from time to time
var lastStatusResponse;					// Contains the last available status response (rr_status)
var zTriggerHeight = 0.0;				// Trigger height of the Z-probe (only used for OEM)

var configResponse;						// Contains the last rr_config response (if any)
var configFile;							// This is a cached copy of the machine's config.g file

var ajaxRequests = [];					// List of all outstanding AJAX requests
var lastSentGCode, lastGCodeFromInput;	// The last sent G-code

var vendor = undefined;					// For OEM functionality
var calibrationWebcamSource = "", calibrationWebcamEmbedded = false;
var hideLastExtruderDrive = false;

var compatibilityMode = false;			// TEMPORARY: Compatibility mode for latest official RRF 2.01


/* AJAX Events */

$(document).ajaxSend(function(event, jqxhr, xhrsettings) {
	xhrsettings.sendTime = new Date();
	ajaxRequests.push(jqxhr);
});

$(document).ajaxComplete(function(event, jqxhr, xhrsettings) {
	ajaxRequests = $.grep(ajaxRequests, function(item) { item != jqxhr; });
});

$(document).ajaxError(function(event, jqxhr, xhrsettings, thrownError) {
	if (thrownError == "abort") {
		// Ignore this error if this request was cancelled intentionally
		return;
	}

	if (isConnected) {
		// If we get a 401, that means that the session has timed out.
		// In this case attempt to reconnect with the last set password
		if (jqxhr.status == 401) {
			reconnectAfterTimeout();
			return;
		}

		// Resend this request if it timed out. This may be necessary for DuetWiFi
		// Also check for empty responses, although not every browser reports an
		// error in this case. However if we get one, treat it as a timeout.
		var response = jqxhr.responseText || jqxhr.responseJSON;
		if (thrownError == "timeout" || typeof app !== "undefined" || (thrownError == "" && response == undefined)) {
			if (!xhrsettings.hasOwnProperty("retryCount")) {
				xhrsettings.retryCount = 1;
			} else {
				xhrsettings.retryCount++;
			}

			if (xhrsettings.retryCount <= settings.maxRetries) {
				var retryInterval = sessionTimeout / (settings.maxRetries + 1);
				var timeSinceSend = new Date() - xhrsettings.sendTime;
				if (timeSinceSend < retryInterval) {
					// The time difference between sending and this error is very low,
					// wait a while longer before retrying
					setTimeout(function() {
						$.ajax(xhrsettings);
					}, retryInterval - timeSinceSend);
				} else {
					// This request timed out after a while, retry now
					$.ajax(xhrsettings);
				}
				return;
			}
		}

		// Disconnect and display the error message
		disconnect(false);
		$("#span_reconnect_title").text(T("Connection Lost"));
		$("#span_reconnect_reason").text(errorToDescription(thrownError, ""));
		$("#modal_reconnecting").modal("show");

		if (response != undefined) {
			// Bad JSON response, don't do anything else
			$("#modal_reconnecting p:last-child").text(T("Please reload the web interface to proceed."))
			console.log("Error! The following JSON response could not be parsed:");
			console.log(response);
		} else {
			// Other error (probably timeout), try to reconnect
			setStatusLabel("Reconnecting", "warning");
			connect(sessionPassword, false);
		}
	}
});


/* Connect / Disconnect */

$(".btn-connect").click(function(e) {
	if (!$(this).hasClass("disabled")) {
		if (!isConnected) {
			// Attempt to connect with the last-known password first
			connect(sessionPassword, true);
		} else {
			disconnect(true);
		}
	}
	e.preventDefault();
});

function connect(password, regularConnect) {
	if (regularConnect) {
		$("#main_content").css("cursor", "wait");

		setStatusLabel("Connecting", "warning");
		$(".btn-connect > span:not(.glyphicon)").text(T("Connecting..."));
		$(".btn-connect > span.glyphicon").removeClass("glyphicon-log-in").addClass("glyphicon-transfer");
		$("a.btn-connect").removeClass("list-group-item-info").addClass("list-group-item-warning disabled");
		$("button.btn-connect").removeClass("btn-info").addClass("btn-warning disabled");

		closeAllNotifications();

		// If we are running on localhost, ask for a destination
		if (location.host == "") {
			showHostPrompt();
			return;
		}
	}

	$.ajax(ajaxPrefix + "rr_connect?password=" + password + "&time=" + encodeURIComponent(timeToStr(new Date())), {
		dataType: "json",
		global: false,
		error: function(jqXHR, textStatus, errorThrown) {
			if (regularConnect && location.host == "") {
				$("#main_content").css("cursor", "");
				setStatusLabel("Disconnected", "idle");
				$(".btn-connect > span:not(.glyphicon)").text(T("Connect"));
				$(".btn-connect > span.glyphicon").removeClass("glyphicon-transfer").addClass("glyphicon-log-in");
				$("a.btn-connect").removeClass("list-group-item-warning disabled").addClass("list-group-item-info");
				$("button.btn-connect").removeClass("btn-warning disabled").addClass("btn-info");
				showMessage("danger", T("Error"), T("Could not establish a connection to the Duet firmware! Please check your settings and try again."), 0, false);
			} else {
				if (!reconnectingAfterUpdate) {
					$("#span_reconnect_reason").text(errorToDescription(textStatus, errorThrown));
				}
				if (regularConnect) {
					$("#span_reconnect_title").text(T("Failed to connect"));
					$("#modal_reconnecting").modal("show");
				}

				setTimeout(function() {
					connect(password, false);
				}, reconnectInterval);
			}
		},
		success: function(response) {
			if (response.err == 2) {				// Looks like the firmware ran out of HTTP sessions
				$("#span_reconnect_reason").text(T("No more HTTP sessions available"));
				if (regularConnect) {
					$("#span_reconnect_title").text(T("Failed to connect"));
					$("#modal_reconnecting").modal("show");
				}

				setTimeout(function() {
					connect(password, false);
				}, reconnectInterval);
			} else {
				$("#modal_reconnecting").modal("hide");

				if (response.err == 0) {		// Connection established
					sessionPassword = password;
					postConnect(response);
				} else {						// Invalid password
					showPasswordPrompt();
					if (!firstConnect) {
						showMessage("danger", T("Error"), T("Invalid password!"));
					}
				}
				firstConnect = false;
			}
		}
	});
}

function postConnect(response) {
	if (response.hasOwnProperty("sessionTimeout")) {
		sessionTimeout = response.sessionTimeout;
		$.ajaxSetup({ timeout: sessionTimeout / (settings.maxRetries + 1) });
	}
	if (response.hasOwnProperty("boardType")) {
		setBoardType(response.boardType);
	}

	$("#main_content").css("cursor", "");
	log("success", "<strong>" + T("Connection established!") + "</strong>");
	if (location.host == "") {
		setLocalSetting("lastHost", $("#input_host").val());
	}

	isConnected = justConnected = true;
	extendedStatusCounter = settings.extendedStatusInterval; // ask for extended status response on first poll

	loadThemes();
	getOemFeatures();
	updateFilaments();

	if (needsInitialSettingsUpload) {
		uploadTextFile("0:/www/dwc.json", JSON.stringify(settings), undefined, false);
	}

	startUpdates();
	if (currentPage == "settings") {
		getConfigResponse();
	}

	$(".btn-connect > span:not(.glyphicon)").text(T("Disconnect"));
	$(".btn-connect > span.glyphicon").removeClass("glyphicon-transfer").addClass("glyphicon-log-out");
	$("a.btn-connect").removeClass("list-group-item-warning disabled").addClass("list-group-item-success");
	$("button.btn-connect").removeClass("btn-warning disabled").addClass("btn-success");

	enableControls();
	validateAddTool();
}

function disconnect(sendDisconnect) {
	if (isConnected) {
		log("danger", "<strong>" + T("Disconnected.") + "</strong>");
	}
	isConnected = false;

	$(".btn-connect > span:not(.glyphicon)").text(T("Connect"));
	$(".btn-connect > span.glyphicon").removeClass("glyphicon-log-out").addClass("glyphicon-log-in");
	$("a.btn-connect").removeClass("list-group-item-success").addClass("list-group-item-info");
	$("button.btn-connect").removeClass("btn-success").addClass("btn-info");

	if (sendDisconnect) {
		$.ajax(ajaxPrefix + "rr_disconnect", { dataType: "json", global: false });
	}

	ajaxRequests.forEach(function(request) {
		request.abort();
	});
	ajaxRequests = [];
	updateTaskLive = false;

	resetGuiData();
	resetGui();
	updateGui();

	disableControls();
	validateAddTool();
	setToolMapping([]);
}

function errorToDescription(textStatus, errorThrown) {
	if (errorThrown != "" && textStatus != errorThrown) {
		return errorThrown;
	}

	switch (textStatus) {
		case "timeout": return  T("Request Timeout");
		case "error": return T("Host unreachable");
		case "abort": return T("Request aborted");
		case "parsererror": return T("Invalid Response");
		case "": return T("Communication Error");
		default: return T("Unknown ({0})", textStatus);
	}
}


/* Status updates */

function startUpdates() {
	stopUpdating = false;
	if (!updateTaskLive) {
		updateStatus();
	}
}

function stopUpdates() {
	stopUpdating = updateTaskLive;
}

function updateStatus() {
	if (stopUpdating) {
		updateTaskLive = false;
		return;
	}
	updateTaskLive = true;

	var machinePropsVisible = (currentPage == "settings") && $("#page_machine").hasClass("active");
	var ajaxRequest = "rr_status";
	if (extendedStatusCounter >= settings.extendedStatusInterval || machinePropsVisible && (!isProcessing || extendedStatusCounter > 1)) {
		extendedStatusCounter = 0;
		ajaxRequest += "?type=2";
	} else if (isProcessing) {
		ajaxRequest += "?type=3";
	} else {
		ajaxRequest += "?type=1";
	}
	extendedStatusCounter++;

	$.ajax(ajaxPrefix + ajaxRequest, {
		dataType: "json",
		success: function(status) {
			// Don't process this one if we're no longer connected
			if (!isConnected) {
				return;
			}
			var needGuiUpdate = false;

			/*** Extended status response ***/

			// Cold Extrusion + Retraction Temperatures
			if (status.hasOwnProperty("coldExtrudeTemp")) {
				coldExtrudeTemp = status.coldExtrudeTemp;
			}
			if (status.hasOwnProperty("coldRetractTemp")) {
				coldRetractTemp = status.coldRetractTemp;
			}

			// Compensation type
			if (status.hasOwnProperty("compensation"))
			{
				$(".compensation").removeClass("hidden");
				$("#span_compensation").text(T(status.compensation));
			}

			// Temperature limit
			if (status.hasOwnProperty("tempLimit")) {
				tempLimit = status.tempLimit;
			}

			// Endstops
			if (status.hasOwnProperty("endstops")) {
				for(var i = 0; i <= maxDrives; i++) {
					var displayText;
					if ((status.endstops & (1 << i)) != 0) {
						displayText = T("Yes");
					} else {
						displayText = T("No");
					}

					$("#table_drives > tbody > tr").eq(i).children().eq(1).text(displayText);
				}
			}

			// Geometry
			if (status.hasOwnProperty("geometry")) {
				setGeometry(status.geometry);
			}

			// Axis names
			if (status.hasOwnProperty("axisNames") && status.axisNames != axisNames.join("")) {
				axisNames = status.axisNames.split("");
				needGuiUpdate = true;
			}

			// Number of volumes
			if (status.hasOwnProperty("volumes")) {
				setVolumes(status.volumes);
			}

			// Bitmap of mounted volumes
			if (status.hasOwnProperty("mountedVolumes")) {
				setMountedVolumes(status.mountedVolumes);
			}

			// Bitmap of configurable fans
			if (status.hasOwnProperty("controllableFans")) {
				if (controllableFans != status.controllableFans) {
					controllableFans = status.controllableFans;
					for(var i = 0; i < maxFans; i++) {
						setFanVisibility(i, (controllableFans & (1 << i)) != 0);
					}
				}
			} else if (configResponse == undefined) {
				// For legacy firmware versions download the config response. It will tell us if a DueX is attached
				getConfigResponse();
			}

			// Fan Names
			if (status.params.hasOwnProperty("fanNames") && (lastStatusResponse == undefined || !arraysEqual(status.params.fanNames, fanNames))) {
				fanNames = status.params.fanNames;
				needGuiUpdate = true;
			}

			// Machine Mode
			if (status.hasOwnProperty("mode")) {
				$("#span_mode").removeClass("hidden");
				$("#span_mode > span").text(status.mode);
			}

			// Machine Name
			if (status.hasOwnProperty("name")) {
				setMachineName(status.name);
			}

			// Probe Parameters (maybe hide probe info for type 0 someday?)
			if (status.hasOwnProperty("probe")) {
				probeTriggerValue = status.probe.threshold;
				probeSlowDownValue = probeTriggerValue * 0.9;	// see Platform::Stopped in dc42/ch firmware forks

				var probeType;
				switch (status.probe.type) {
					case 0:
						probeType = T("Z Switch (0)");
						break;
					case 1:
						probeType = T("Unmodulated (1)");
						break;
					case 2:
						probeType = T("Modulated (2)");
						break;
					case 3:
						probeType = T("Alternative (3)");
						break;
					case 4:
						probeType = T("E0 Switch (4)");
						break;
					case 5:
						probeType = T("Digital Switch (5)");
						break;
					case 6:
						probeType = T("E1 Switch (6)");
						break;
					case 7:
						probeType = T("Z Switch (7)");
						break;
					case 8:
						probeType = T("Digital Switch (8)");
						break;
					default:
						probeType = T("Unknown ({0})", status.probe.type);
						break;
				}
				$("#dd_probe_type").text(probeType);
				$("#dd_probe_height").text(T("{0} mm", status.probe.height));
				$("#dd_probe_trigger_value").text(probeTriggerValue);

				zTriggerHeight = status.probe.height;
				$("#span_probe_height").text(T("{0} mm", zTriggerHeight.toFixed(2)));
			}

			// Tool Mapping
			if (status.hasOwnProperty("tools")) {
				needGuiUpdate |= setToolMapping(status.tools);
			}

			// Heater name
			if (status.temps.hasOwnProperty("names") && (lastStatusResponse == undefined || !arraysEqual(status.temps.names, heaterNames))) {
				heaterNames = status.temps.names;
				needGuiUpdate = true;
			}

			// MCU temperature
			if (status.hasOwnProperty("mcutemp")) {
				if (lastStatusResponse == undefined) {
					$(".mcutemp").removeClass("hidden");
				}
				$("td.mcutemp").text(status.mcutemp.cur).prop("title", T("Minimum: {0} Â°C Maximum: {1} Â°C", status.mcutemp.min, status.mcutemp.max));
			}

			// Input voltage
			if (status.hasOwnProperty("vin")) {
				$(".vin").removeClass("hidden");
				$("#td_vin").html(T("{0} V", status.vin.cur.toFixed(1)));
				$("#td_vin").prop("title", T("Minimum: {0} V Maximum: {1} V", status.vin.min.toFixed(1), status.vin.max.toFixed(1)));
			}

			// Requested and top speeds
			if (status.hasOwnProperty("speeds")) {
				$(".speeds").removeClass("hidden");
				$(".req-speed").text(T("{0} mm/s", status.speeds.requested));
				$(".top-speed").text(T("{0} mm/s", status.speeds.top));
			}

			/*** Default status response ***/

			// Status
			var processing = false, paused = false;
			switch (status.status) {
				case 'F':	// Flashing new firmware
					setStatusLabel("Updating", "success");
					break;

				case 'O':	// Off
					setStatusLabel("off", "danger");
					break;

				case 'H':	// Halted
					setStatusLabel("Halted", "danger");
					break;

				case 'D':	// Pausing / Decelerating
					setStatusLabel("Pausing", "warning");
					processing = true;
					paused = true;
					break;

				case 'S':	// Paused / Stopped
					setStatusLabel("Paused", "info");
					processing = true;
					paused = true;
					break;

				case 'R':	// Resuming
					setStatusLabel("Resuming", "warning");
					processing = true;
					paused = true;
					break;

				case 'P':	// Processing
					setStatusLabel("Processing", "success");
					processing = true;
					break;

				case 'M':	// Simulating
					setStatusLabel("Simulating", "success");
					processing = true;
					break;

				case 'B':	// Busy
					setStatusLabel("Busy", "warning");
					break;

				case 'T':	// Changing tool
					processing = isProcessing;
					setStatusLabel("Changing Tool", "primary");
					break;

				case 'I':	// Idle
					setStatusLabel("Idle", "default");
					break;
			}
			setJobStatus(processing);
			setPauseStatus(paused);

			// Update file lists of the visible page after the first status response
			if (justConnected) {
				if (currentPage == "files") {
					updateGCodeFiles();
				} else if (currentPage == "control" || currentPage == "macros") {
					updateMacroFiles();
				} else if (currentPage == "filaments") {
					updateFilaments();
				} else if (currentPage == "settings") {
					if ($("#page_sysedit").hasClass("active")) {
						updateSysFiles();
					} else if ($("#page_display").hasClass("active")) {
						updateDisplayFiles();
					}
				}

				justConnected = false;
			}

			// Set homed axes
			if (lastStatusResponse == undefined || !arraysEqual(status.coords.axesHomed, lastStatusResponse.coords.axesHomed)) {
				setAxesHomed(status.coords.axesHomed);
			}

			// Update extruder drives
			if (status.coords.extr.length != numExtruderDrives) {
				numExtruderDrives = status.coords.extr.length;
				needGuiUpdate = true;
			}

			for(var i = 0; i < numExtruderDrives; i++) {
				$("td[data-extruder='" + i + "']").html(status.coords.extr[i].toFixed(1));
			}
			if (numExtruderDrives > 0) {
				$("#td_extr_total").html(status.coords.extr.reduce(function(a, b) { return a + b; }));
			} else {
				$("#td_extr_total").html(T("n/a"));
			}

			// Axis coordinates
			if (status.hasOwnProperty("axes") && status.axes != numAxes)
			{
				numAxes = status.axes;
				needGuiUpdate = true;
			}

			for(var i = 0; i < status.coords.xyz.length; i++) {
				$("td[data-axis='" + i + "']").html(status.coords.xyz[i].toFixed(2));
			}

			if (geometry == "delta" && axisNames.indexOf("X") != -1 && !status.coords.axesHomed[axisNames.indexOf("X")]) {
				// Override XYZ coordinates on a Delta with 'n/a' if the axes are not homed
				$("td[data-axis='" + axisNames.indexOf("X") + "']").html(T("n/a"));
				$("td[data-axis='" + axisNames.indexOf("Y") + "']").html(T("n/a"));
				$("td[data-axis='" + axisNames.indexOf("Z") + "']").html(T("n/a"));

				// Set message box coordinates
				$(".msgbox-x").text("X=" + T("n/a"));
				$(".msgbox-y").text("Y=" + T("n/a"));
				$(".msgbox-z").text("Z=" + T("n/a"));
				$(".msgbox-a").text("A=" + T("n/a"));
			} else {
				var x = (axisNames.indexOf("X") == -1) ? T("n/a") : status.coords.xyz[axisNames.indexOf("X")].toFixed(2);
				var y = (axisNames.indexOf("Y") == -1) ? T("n/a") : status.coords.xyz[axisNames.indexOf("Y")].toFixed(2);
				var z = (axisNames.indexOf("Z") == -1) ? T("n/a") : status.coords.xyz[axisNames.indexOf("Z")].toFixed(2);
				var aIndex = axisNames.indexOf("A");
				var a = (aIndex == -1 || status.coords.xyz.length <= aIndex) ? T("n/a") : status.coords.xyz[aIndex].toFixed(2);
				$(".msgbox-x").text("X=" + x);
				$(".msgbox-y").text("Y=" + y);
				$(".msgbox-z").text("Z=" + z);
				$(".msgbox-a").text("A=" + a);
			}

			// Current Tool
			if (lastStatusResponse != undefined && lastStatusResponse.currentTool != status.currentTool) {
				setCurrentTool(status.currentTool);
			}

			// Manage Tool selection on Settings -> Tools page
			if (lastStatusResponse != undefined && lastStatusResponse.currentTool != status.currentTool) {
				var btn = $("div.panel-body[data-tool='" + lastStatusResponse.currentTool + "'] > button.btn-select-tool");
				btn.attr("title", T("Select this tool"));
				btn.find("span:last-child").text(T("Select"));
				btn.find("span.glyphicon").removeClass("glyphicon-remove").addClass("glyphicon-pencil");

				btn = $("div.panel-body[data-tool='" + status.currentTool + "'] > button.btn-select-tool");
				btn.attr("title", T("Select this tool"));
				btn.find("span.glyphicon").removeClass("glyphicon-remove").addClass("glyphicon-pencil");
				btn.find("span:last-child").text(T("Deselect"));
			}

			// Output
			if (status.hasOwnProperty("output")) {
				if (status.output.hasOwnProperty("beepDuration") && status.output.hasOwnProperty("beepFrequency")) {
					beep(status.output.beepFrequency, status.output.beepDuration);
				}
				if (status.output.hasOwnProperty("message")) {
					showMessage("info", T("Message from Duet firmware"), status.output.message, settings.autoCloseUserMessages ? settings.notificationTimeout : 0);
				}
				if (status.output.hasOwnProperty("msgBox")) {
					updateMessageBox(status.output.msgBox);
				} else {
					closeMessageBox();
				}
			} else {
				closeMessageBox();
			}

			// ATX Power
			if (lastStatusResponse == undefined || status.params.atxPower != lastStatusResponse.params.atxPower) {
				setATXPower(status.params.atxPower);
			}

			// Fan Control
			var fanValues = (status.params.fanPercent.constructor === Array) ? status.params.fanPercent : [status.params.fanPercent];

			if ($("tr[data-fan='tool'] button.fan-visibility").hasClass("active") && fanValues.length > 0) {
				// Set Tool fan value
				var toolFan = 0;
				var tool = getTool(status.currentTool);
				if (tool != undefined && tool.hasOwnProperty("fans")) {
					for(var fan = 0; fan < Math.min(maxFans, fanValues.length); fan++) {
						if ((tool.fans & (1 << fan)) != 0) {
							toolFan = fan;
							break;
						}
					}
				}

				if (fanSliderActive != "tool" && (lastStatusResponse == undefined || $("tr[data-fan='tool'] .fan-slider > input").slider("getValue") != fanValues[toolFan])) {
					$("tr[data-fan='tool'] .fan-slider > input").slider("setValue", fanValues[toolFan]);
				}
			}

			for(var fan = 0; fan < Math.min(maxFans, fanValues.length); fan++) {
				if (fan != fanSliderActive) {
					var fanValue = fanValues[fan] / 100.0;
					if (overriddenFanValues[fan] != undefined && overriddenFanValues[fan] != fanValue) {
						// Enforce overriden fan value
						sendGCode("M106 P" + fan + " S" + overriddenFanValues[fan]);
					} else if (lastStatusResponse == undefined || $("tr[data-fan='" + fan + "'] .fan-slider > input").slider("getValue") != fanValue * 100.0) {
						// Update slider value
						$("tr[data-fan='" + fan + "'] .fan-slider > input").slider("setValue", fanValue * 100.0);
					}
				}
			}

			// Speed Factor
			if (!speedSliderActive && (lastStatusResponse == undefined || $("#slider_speed").slider("getValue") != status.params.speedFactor)) {
				$("#slider_speed").slider("setValue", status.params.speedFactor);
			}
			if (!extrSliderActive) {
				for(var i = 0; i < status.params.extrFactors.length; i++) {
					var extrSlider = $("#slider_extr_" + i);
					if (lastStatusResponse == undefined || extrSlider.slider("getValue") != status.params.extrFactors) {
						extrSlider.slider("setValue", status.params.extrFactors[i]);
					}
				}
			}

			// Babystepping
			if (status.params.hasOwnProperty("babystep")) {
				$(".babystepping button").toggleClass("disabled", settings.babysteppingZ <= 0);
				$("#span_babystepping").text(T("{0} mm", status.params.babystep));
			} else {
				// Don't enable babystepping controls if the firmware doesn't support it
				$(".babystepping button").addClass("disabled");
			}

			// Fetch the last G-Code response from the server if there is anything new and we're not flashing new firmware
			if (lastStatusResponse == undefined || (status.status != 'F' && lastStatusResponse.seq != status.seq)) {
				$.ajax(ajaxPrefix + "rr_reply", {
					dataType: "html",
					success: function(response) {
						response = response.trim();

						// Deal with firmware responses that can be parsed
						if (!isProcessing && response != "") {
							// Is this a bed compensation report?
							if (response.indexOf("Bed equation fits points ") == 0) {
								var points = response.substr("Bed equation fits points ".length);
								points = JSON.parse("[" + points.split("] [").join("],[") + "]");
								showBedCompensation(points);
							}

							// Has grid-based probing finished? If so, attempt to get the P-parameter if present because represents the filename
							if (response.indexOf(" points probed, mean error ") != -1) {
								var csvFile = undefined;
								if (lastSentGCode.indexOf("G29") == 0) {
									var inQuotes = false, readingFilename = false;
									for(var i = 0; i < lastSentGCode.length; i++) {
										if (lastSentGCode[i] == '"') {
											inQuotes = !inQuotes;
										} else if (inQuotes) {
											if (readingFilename) {
												if (csvFile == undefined) {
													csvFile = lastSentGCode[i];
												} else {
													csvFile += lastSentGCode[i];
												}
											}
										} else if (lastSentGCode[i] == 'P') {
											readingFilename = true;
										}
									}

									if (csvFile != undefined && csvFile.indexOf("/") == -1) {
										csvFile = "0:/sys/" + csvFile;
									}
								}
								getHeightmap(csvFile);
							}

							// If an error is reported and we're trying to mount a volume, don't wait for it any longer
							if (mountRequested && (response.indexOf("Cannot initialise") != -1 || response.indexOf("Can't mount") != -1)) {
								mountRequested = false;
								changeGCodeVolume(currentGCodeVolume);
							}
						}
						if (lastSentGCode == "M561") {
							// We should not isplay the probe points if they are no longer valid
							clearBedPoints();
						}

						// Check if the reply contains a request to load a calibration stream (OEM)
						var oldResponse = response;
						response = response.replace(/\{UpdateCam\d*\}/g, "");
						var snapshotId = oldResponse.match(/\{UpdateCam(\d*)\}/);
						snapshotId = (snapshotId != null && snapshotId.length > 1) ? snapshotId[snapshotId.length - 1] : "";
						if (response != oldResponse) {
							updateCalibrationWebcam(false, snapshotId);
						} else {
							var camAddress = response.match(/\{CamAddress-(.+)\}/);
							if (camAddress != null && camAddress.length > 1) {
								calibrationWebcamSource = "http://" + camAddress[1];
								updateCalibrationWebcam(true);
							}
							response = response.replace(/\{CamAddress-.+\}/, "");
						}

						// Check if a reload of DWC / DWC settings has been requested
						if (response.match(/\{reloadDWC\}/) != null) {
							response = response.replace(/\{reloadDWC\}/, "");
							if (location.host != "") {
								location.reload();
							}
						} else if (response.match(/\{reloadSettings\}/) != null) {
							response = response.replace(/\{reloadSettings\}/, "");
							if (settings.settingsOnDuet) {
								// Reload the settings once again from the Duet
								loadSettings();
								showMessage("success", "", "<strong>" + T("Settings applied!") + "</strong>");
							}
						}

						// What kind of reply are we dealing with?
						if (response != "" || (lastSentGCode != "" && oldResponse == response)) {
							var style = "success", content = response;
							if (response.match("^Warning: ") != null) {
								style = "warning";
								content = content.replace(/Warning:/g, "<strong>Warning:</strong>");
							} else if (response.match("^Error: ") != null) {
								style = "danger";
								content = content.replace(/Error:/g, "<strong>Error:</strong>");
							} else if (response != "") {
								style = "info";
							}

							// Prepare line breaks for HTML
							lastSentGCode = lastSentGCode.trim().replace(/\n/g, "<br/>");
							content = content.replace(/\n/g, "<br/>");

							// Log this message in the G-Code console
							var prefix = (lastSentGCode != "") ? "<strong>" + lastSentGCode + "</strong><br/>" : "";
							log(style, prefix + "<span>" + content + "</span>");

							// If the console isn't visible, check if a notification can be displayed
							if (currentPage != "console") {
								if ((style == "success" && settings.showEmptyResponses) ||
									(style == "info" && settings.showInfoMessages) ||
									(style == "warning" && settings.showWarningMessages) ||
									(style == "danger" && settings.showErrorMessages))
								{
									if (response == "") {
										showMessage(style, "", "<strong>" + lastSentGCode + "</strong>");
									} else {
										showMessage(style, lastSentGCode, content);
									}
								}
							}

							// Close the scanner modal dialog if an error occurred
							if (style == "danger") {
								$("#modal_scanner").modal("hide");
							}

							// See if this code can be remembered and reset info about the last sent G-Code again
							if (lastSentGCode != "" && lastGCodeFromInput &&
								(style == "success" || style == "info") && rememberedGCodes.indexOf(lastSentGCode) == -1)
							{
								rememberedGCodes.push(lastSentGCode);
								saveGCodes();
								applyGCodes();
							}
						}
						lastSentGCode = "";
					}
				});
			}

			// Sensors
			setProbeValue(status.sensors.probeValue, status.sensors.probeSecondary);
			if (status.sensors.fanRPM.constructor == Array) {
				$("td.fan-rpm").html(status.sensors.fanRPM.join(" / "));
			} else {
				$("td.fan-rpm").html(status.sensors.fanRPM);
			}

			// Heated bed
			if (status.temps.hasOwnProperty("bed")) {
				var configuredBedHeater = (status.temps.bed.hasOwnProperty("heater")) ? status.temps.bed.heater : 0;
				if (bedHeater != configuredBedHeater) {
					bedHeater = configuredBedHeater;
					needGuiUpdate = true;
					setHeatersInUse();
				}

				setTemperatureInput("bed", status.temps.bed.active, true, true);
			} else if (bedHeater != -1) {
				bedHeater = -1;
				needGuiUpdate = true;
			}

			// Chamber
			if (status.temps.hasOwnProperty("chamber")) {
				var configuredChamberHeater = (status.temps.chamber.hasOwnProperty("heater")) ? status.temps.chamber.heater : maxHeaters;
				if (chamberHeater != configuredChamberHeater)
				{
					chamberHeater = configuredChamberHeater;
					needGuiUpdate = true;
					setHeatersInUse();
				}

				setTemperatureInput("chamber", status.temps.chamber.active, true, true);
			} else if (chamberHeater != -1) {
				chamberHeater = -1;
				needGuiUpdate = true;
			}

			// Dry Cabinet
			if (status.temps.hasOwnProperty("cabinet")) {
				if (cabinetHeater != status.temps.cabinet.heater)
				{
					cabinetHeater = status.temps.cabinet.heater;
					needGuiUpdate = true;
					setHeatersInUse();
				}

				setTemperatureInput("cabinet", status.temps.cabinet.active, true, true);
			} else if (cabinetHeater != -1) {
				cabinetHeater = -1;
				needGuiUpdate = true;
			}

			// Heater temperatures and states
			if (status.temps.hasOwnProperty("current") && status.temps.hasOwnProperty("state")) {
				// Set current temperatures and states
				for(var heater = 0; heater < status.temps.current.length; heater++) {
					if (heater == bedHeater) {
						setCurrentTemperature("bed", status.temps.current[heater]);
						setHeaterState("bed", status.temps.state[heater], status.currentTool);
					}
					if (heater == chamberHeater) {
						setCurrentTemperature("chamber", status.temps.current[heater]);
						setHeaterState("chamber", status.temps.state[heater], status.currentTool);
					}
					if (heater == cabinetHeater)
					{
						setCurrentTemperature("cabinet", status.temps.current[heater]);
						setHeaterState("cabinet", status.temps.state[heater], status.currentTool);
					}
					setCurrentTemperature(heater, status.temps.current[heater]);
					setHeaterState(heater, status.temps.state[heater], status.currentTool);
				}

				// Keep the temperature chart up-to-date
				recordCurrentTemperatures(status.temps.current);
			}

			// Active+Standby tool temperatures
			var currentToolTemps = undefined;
			if (status.temps.hasOwnProperty("tools") && toolMapping.length == status.temps.tools.active.length) {
				for(var toolIndex = 0; toolIndex < status.temps.tools.active.length; toolIndex++) {
					var toolNumber = toolMapping[toolIndex].number;
					for(var heaterIndex = 0; heaterIndex < status.temps.tools.active[toolIndex].length; heaterIndex++) {
						var heater = toolMapping[toolIndex].heaters[heaterIndex];
						setToolTemperatureInput(toolNumber, heater, status.temps.tools.active[toolIndex][heaterIndex], true);
						setToolTemperatureInput(toolNumber, heater, status.temps.tools.standby[toolIndex][heaterIndex], false);
					}
				}
			}

			// Extra temperatures
			if (status.temps.hasOwnProperty("extra")) {
				if (status.temps.extra.length != numTempSensors) {
					numTempSensors = status.temps.extra.length;
					needGuiUpdate = true;
				}

				for(var i = 0; i < status.temps.extra.length; i++) {
					var name = status.temps.extra[i].hasOwnProperty("name") ? status.temps.extra[i].name : "";
					if (lastStatusResponse == undefined || status.temps.extra.length != lastStatusResponse.temps.extra.length || status.temps.extra[i].name != lastStatusResponse.temps.extra[i].name) {
						if (name == "") {
							name = T("Sensor " + (i + 1));
						} else if (name.indexOf("[") != -1) {
							name = name.substr(0, name.indexOf("[")).trim();
						}
						$("#table_extra tr").eq(i + 1).children("th").text(name);
					}

					var unit = name.match(/\[(.*?)\]/);
					var value = status.temps.extra[i].temp.toFixed(1);
					if (unit == null) {
						value = T("{0} Â°C", value);
					} else {
						value = value + " " + unit[1];
					}

					$("#table_extra tr").eq(i + 1).children("td:last-child").text(value);
					if (name == "MCU") {
						$("td.mcutemp").text(value);
					}
				}
				recordExtraTemperatures(status.temps.extra);
			}

			// Scanner extension
			if (status.hasOwnProperty("scanner")) {
				// Toggle visibility of scanner controls
				if (lastStatusResponse == undefined || !lastStatusResponse.hasOwnProperty("scanner")) {
					$(".scan-control").removeClass("hidden");
					$("#div_content").resize();
				}

				// Enable scan controls only if the scanner is ready
				var enableScanControls = (status.scanner.status == "I");
				if (vendor == "diabase") {
					status.coords.axesHomed.forEach(function(isHomed) {
						enableScanControls &= (isHomed > 0);
					});
				}
				$("#btn_calibrate_scanner, #btn_start_scan, #btn_shutdown_scanner").toggleClass("disabled", !enableScanControls);

				// Update scan dialogs
				updateScannerDialogs(status.scanner);

				// Reload scans as soon as a 3D scan has finished
				var lastStatus = (lastStatusResponse == undefined || !lastStatusResponse.hasOwnProperty("scanner"))
									? "?" : lastStatusResponse.scanner.status;
				if (status.scanner.status == "I" && (lastStatus == "S" || lastStatus == "P" || lastStatus == "U")) {
					updateScanFiles();
				}
			} else if (lastStatusResponse != undefined && lastStatusResponse.hasOwnProperty("scanner")) {
				if (currentPage == "scanner") {
					showPage("control");
				}
				$(".scan-control").addClass("hidden");

				if ($("#modal_scanner").hasClass("in")) {
					$("#modal_scanner").modal("hide");
				}
				if ($("#modal_scanner_calibration").hasClass("in")) {
					$("#modal_scanner_calibration").modal("hide");
				}
			}

			// CNC Spindles
			if (status.hasOwnProperty("spindles")) {
				for(var i = spindleTools.length - 1; i >= status.spindles.length; i--) {
					needGuiUpdate = true;
					spindleTools[i] = -1;
				}

				for(var i = 0; i < status.spindles.length; i++) {
					if (i + 1 > spindleTools.length) {
						if (status.spindles[i].hasOwnProperty("tool")) {
							needGuiUpdate = true;
							spindleTools.push(status.spindles[i].tool);
							spindleCurrents.push(status.spindles[i].current);
							spindleActives.push(status.spindles[i].active);
						}
					} else {
						if (status.spindles[i].hasOwnProperty("tool") && spindleTools[i] != status.spindles[i].tool) {
							needGuiUpdate = true;
							spindleTools[i] = status.spindles[i].tool;
						}
						setSpindleCurrent(i, status.spindles[i].current);
						setSpindleInput(i, status.spindles[i].active);
					}
				}
			} else if (status.hasOwnProperty("spindle") && spindleTools.length > 0) {			// deprecated
				setSpindleCurrent(0, status.spindle.current);
				setSpindleInput(0, status.spindle.active);
			}

			/*** Print status response ***/

			if (status.hasOwnProperty("fractionPrinted") && fileInfo != undefined) {
				var jobJustFinished = false;
				if (!jobHasFinished) {
					var progress = 100, progressText = [];

					// Get the current layer progress text
					if (fileInfo.height > 0 && fileInfo.layerHeight > 0) {
						var numLayers;
						if (status.firstLayerHeight > 0) {
							numLayers = ((fileInfo.height - status.firstLayerHeight) / fileInfo.layerHeight) + 1;
						} else {
							numLayers = (fileInfo.height / fileInfo.layerHeight);
						}
						numLayers = numLayers.toFixed();
						progressText.push(T("Layer: {0} of {1}", status.currentLayer, numLayers));
					}

					// Try to calculate the progress by checking the filament usage
					if (fileInfo.filament.length > 0) {
						var totalFileFilament = (fileInfo.filament.reduce(function(a, b) { return a + b; })).toFixed(1);
						var totalRawFilament = (status.extrRaw.reduce(function(a, b) { return a + b; })).toFixed(1);
						progress = ((totalRawFilament / totalFileFilament) * 100.0).toFixed(1);

						var remainingFilament = (totalFileFilament - totalRawFilament);
						if (progress < 0) {
							progress = 0;
						} else if (progress > 100) {
							progress = 100;
							totalRawFilament = totalFileFilament;
							remainingFilament = 0;
							jobJustFinished = jobHasFinished = true;
						}
						progressText.push(T("Filament Usage: {0}mm of {1}mm", totalRawFilament, totalFileFilament));

						// TODO: Make this optional
						progressText[progressText.length - 1] += " " + T("({0}mm remaining)", remainingFilament.toFixed(1));

					}
					// Otherwise by comparing the current Z position to the total height
					else if (fileInfo.height > 0 && fileInfo.layerHeight > 0) {
						progress = ((status.coords.xyz[2] / fileInfo.height) * 100.0).toFixed(1);
						if (progress < 0) {
							progress = 0;
						} else if (progress > 100) {
							progress = 100;
							jobJustFinished = jobHasFinished = true;
						}
					}
					// Use the file-based progress as a fallback option
					else {
						progress = status.fractionPrinted;
						if (progress < 0) {
							progress = 100;
							jobJustFinished = jobHasFinished = true;
						}
					}

					setProgress(progress, T("Processing {0}, {1}% Complete", fileInfo.fileName, progress),
							(progressText.length > 0) ? progressText.reduce(function(a, b) { return a + ", " + b; }) : "");
				}

				// Print Chart
				if (status.currentLayer > 1) {
					var realPrintTime = (status.printDuration - status.warmUpDuration - status.firstLayerDuration);
					var totalFilamentUsage = status.coords.extr.reduce(function(a, b) { return a + b; });
					if (layerData.length == 0) {
						if (status.currentLayer > 2) {						// add avg values on reconnect
							var avgFilamentUsage = totalFilamentUsage / status.currentLayer;
							addLayerData(status.firstLayerDuration, avgFilamentUsage, false);
							realPrintTime -= status.currentLayerTime;

							var accFilamentUsage = avgFilamentUsage;
							for(var layer = 2; layer < status.currentLayer; layer++) {
								accFilamentUsage += avgFilamentUsage;
								addLayerData(realPrintTime / (status.currentLayer - 1), accFilamentUsage, false);
							}
							drawPrintChart();
						} else {											// else only the first layer is complete
							addLayerData(status.firstLayerDuration, totalFilamentUsage, true);
						}

						if (status.currentLayer == 2) {
							lastLayerPrintDuration = 0;
						} else {
							lastLayerPrintDuration = realPrintTime;
						}
					} else if (jobJustFinished || status.currentLayer - 1 > layerData.length) {
						addLayerData(realPrintTime - lastLayerPrintDuration, totalFilamentUsage, true);
						lastLayerPrintDuration = realPrintTime;
					}
				}

				// Warm-Up Time
				if (status.warmUpDuration > 0) {
					if (status.warmUpDuration < 0.5) {
						$("#td_warmup_time").html(T("none"));
					} else {
						$("#td_warmup_time").html(formatTime(status.warmUpDuration));
					}
				} else if (!jobHasFinished) {
					$("#td_warmup_time").html(T("n/a"));
				}

				// Current Layer Time
				if (!jobHasFinished) {
					if (status.currentLayerTime > 0 || status.currentLayer > 1) {
						currentLayerTime = status.currentLayerTime;
						$("#td_layertime").html(formatTime(status.currentLayerTime));
					} else if (status.firstLayerDuration > 0) {
						currentLayerTime = status.firstLayerDuration;
						$("#td_layertime").html(formatTime(status.firstLayerDuration));
					} else {
						$("#td_layertime").html(T("n/a"));
					}
				} else {
					$("#td_layertime").html(T("n/a"));
				}

				// Job Duration
				if (status.printDuration > 0) {
					$("#td_job_duration").html(formatTime(status.printDuration));
				} else if (!jobHasFinished) {
					$("#td_job_duration").html(T("n/a"));
				}

				// First Layer Height (maybe we need to update the layer height info)
				if (status.firstLayerHeight > 0 && $("#dd_layer_height").html().indexOf("/") == -1)
				{
					$("#dd_layer_height").html(T("{0} mm", status.firstLayerHeight) + " / " + $("#dd_layer_height").html());
				}

				// Estimations
				if (jobHasFinished) {
					["filament", "layer", "file"].forEach(function(id) {
						if ($("#tl_" + id).html() != T("n/a")) {
							$("#tl_" + id).html("00s");
							$("#et_" + id).html((new Date()).toLocaleTimeString());
						}
					});
				} else {
					if (fileInfo.filament.length > 0) {
						setTimeLeft("filament", status.timesLeft.filament);
					} else {
						setTimeLeft("filament", undefined);
					}
					setTimeLeft("file", status.timesLeft.file);
					if (fileInfo.height > 0) {
						setTimeLeft("layer", status.timesLeft.layer);
					} else {
						setTimeLeft("layer", undefined);
					}
				}
			}

			// Update the GUI when we have processed the whole status response
			if (needGuiUpdate) {
				updateGui();
				setCurrentTool(status.currentTool);
			}
			drawTemperatureChart();

			// Set timer for next status update
			if (status.status == 'F') {
				isConnected = updateTaskLive = false;

				// Ideally each update path should have its own status char, OTOH this should be sufficient for the moment
				if (uploadDWCFile != undefined && uploadDWSFile == undefined && uploadFirmwareFile == undefined) {
					log("info", "<strong>" + T("Updating Duet Web Control...") + "</strong>");
					showUpdateMessage(2);

					// Ask for page reload if DWC has been updated (wireless Duets, DWC on WiFi chip)
					setTimeout(reconnectAfterUpdate, settings.dwcReconnectDelay);
				} else if (uploadDWSFile != undefined && uploadDWCFile == undefined && uploadFirmwareFile == undefined) {
					log("info", "<strong>" + T("Updating Duet WiFi Server...") + "</strong>");
					showUpdateMessage(1);
					setTimeout(reconnectAfterUpdate, settings.dwsReconnectDelay);
				} else if (uploadFirmwareFile != undefined && uploadDWCFile == undefined && uploadDWSFile == undefined) {
					log("info", "<strong>" + T("Updating Firmware...") + "</strong>");
					showUpdateMessage(0);
					setTimeout(reconnectAfterUpdate, settings.updateReconnectDelay);
				} else if (uploadFirmwareFile != undefined || uploadDWCFile != undefined || uploadDWSFile != undefined) {
					var duration = 0;
					if (uploadDWCFile != undefined) { duration += settings.dwcReconnectDelay; }
					if (uploadDWSFile != undefined) { duration += settings.dwsReconnectDelay; }
					if (uploadFirmwareFile != undefined) { duration += settings.updateReconnectDelay; }

					log("info", "<strong>" + T("Updating Firmware...") + "</strong>");
					showUpdateMessage(3, duration);
					setTimeout(reconnectAfterUpdate, duration);
				} else if (!reconnectingAfterUpdate) {
					log("info", "<strong>" + T("Updating Firmware...") + "</strong>");

					disconnect(false);
					reconnectingAfterUpdate = true;
					$("#span_reconnect_title").text(T("Connection Lost"));
					$("#span_reconnect_reason").text(T("Firmware Update"));
					$("#modal_reconnecting").modal("show");
					setStatusLabel("Reconnecting", "warning");

					setTimeout(function() {
						// Wait a moment so that the firmware enters the updating mode...
						connect(sessionPassword, false);
					}, 2000);
				}
			} else if (status.status == 'H') {
				if (!reconnectingAfterHalt) {
					reconnectAfterHalt();
				} else {
					if (!resetConfirmationShown) {
						showConfirmationDialog(T("Perform firmware reset?"), T("The firmware still reports to be halted after an emergency stop. Would you like to reset your board now?"), function() {
							sendGCode("M999");
							reconnectAfterHalt();
						});
						resetConfirmationShown = true;
					}
				}
			} else {
				reconnectingAfterHalt = reconnectingAfterUpdate = resetConfirmationShown = false;
				setTimeout(updateStatus, settings.updateInterval);
			}

			// Save the last status response
			lastStatusResponse = status;
		}
	});
}

function reconnectAfterHalt() {
	isConnected = updateTaskLive = false;
	showHaltMessage();
	setTimeout(function() {
		reconnectingAfterHalt = true;
		connect(sessionPassword, false);
	}, settings.haltedReconnectDelay);
}

function reconnectAfterUpdate() {
	if ((uploadedDWC || uploadDWCFile != undefined) && location.host != "") {
		if (sessionPassword != defaultPassword) {
			connect(sessionPassword, false);

			showConfirmationDialog(T("Reload Page?"), T("You have just updated Duet Web Control. Would you like to reload the page now?"), function() {
				location.reload();
			});
		} else {
			location.reload();
		}
	} else {
		connect(sessionPassword, false);
	}
}

function reconnectAfterTimeout() {
	updateTaskLive = false;
	connect(sessionPassword, false);
}

function requestFileInfo() {
	$.ajax(ajaxPrefix + "rr_fileinfo", {
		dataType: "json",
		success: function(response) {
			if (isConnected && response.err == 2) {
				// The firmware is still busy parsing the file, so try again until it's ready
				setTimeout(function() {
					if (isConnected) {
						requestFileInfo();
					}
				}, 250);
			} else if (response.err == 0) {
				// File info is valid, use it
				fileInfo = response;

				$("#span_progress_left").html(T("Processing {0}", response.fileName));

				$("#dd_size").html(formatSize(response.size));
				$("#dd_height").html((response.height > 0) ? T("{0} mm", response.height) : T("n/a"));
				var layerHeight = (response.layerHeight > 0) ? T("{0} mm", response.layerHeight) : T("n/a");
				if (response.firstLayerHeight > 0) {
					$("#dd_layer_height").html(T("{0} mm", response.firstLayerHeight) + " / " + layerHeight);
				} else {
					$("#dd_layer_height").html(layerHeight);
				}

				if (response.filament.length == 0) {
					$("#dd_filament").html(T("n/a"));
				} else {
					var filament = T("{0} mm", response.filament.reduce(function(a, b) { return T("{0} mm", a) + ", " + b; }));
					$("#dd_filament").html(filament);
				}

				$("#dd_generatedby").html((response.generatedBy == "") ? T("n/a") : response.generatedBy);

				$("#td_job_duration").html(formatTime(response.printDuration));
			}
		}
	});
}

function getConfigResponse() {
	$.ajax(ajaxPrefix + "rr_config", {
		dataType: "json",
		success: function(response) {
			configResponse = response;

			$("#firmware_name").text(response.firmwareName);

			if (response.hasOwnProperty("firmwareElectronics")) {
				$("#tr_firmware_electronics").removeClass("hidden");
				$("#firmware_electronics").text(response.firmwareElectronics);

				if (lastStatusResponse != undefined && !lastStatusResponse.hasOwnProperty("controllableFans") && response.firmwareElectronics.indexOf("DueX") != -1) {
					controllableFans = 511; // we have 9 fans total with the DueX
					updateGui();
				}
			}

			if (response.hasOwnProperty("dwsVersion")) {
				$("#dws_version").text(response.dwsVersion);
			}

			$("#firmware_version").text(response.firmwareVersion + " (" + response.firmwareDate + ")");
			compatibilityMode = response.firmwareVersion == "2.01(RTOS)";

			var driveRows = $("#table_drives > tbody > tr");
			for(var drive = 0; drive < maxDrives; drive++) {
				if (lastStatusResponse != undefined && drive < lastStatusResponse.coords.xyz.length + lastStatusResponse.coords.extr.length) {
					var rowCells = driveRows.eq(drive).removeClass("hidden").children();
					rowCells.eq(2).text((drive < response.axisMins.length) ? T("{0} mm", response.axisMins[drive]) : T("n/a"));
					rowCells.eq(3).text((drive < response.axisMaxes.length) ? T("{0} mm", response.axisMaxes[drive]) : T("n/a"));
					rowCells.eq(4).text(T("{0} mm/s", response.minFeedrates[drive]));
					rowCells.eq(5).text(T("{0} mm/s", response.maxFeedrates[drive]));
					rowCells.eq(6).text(T("{0} mm/sÂ²", response.accelerations[drive]));
					rowCells.eq(7).text(response.hasOwnProperty("currents") ? T("{0} mA", response.currents[drive]) : T("n/a"));
				} else {
					driveRows.eq(drive).addClass("hidden");
				}
			}
			if (response.hasOwnProperty("idleCurrentFactor")) {
				$("#dd_idle_current").text(response.idleCurrentFactor.toFixed(0) + "%");
			}
			if (response.hasOwnProperty("idleTimeout")) {
				var idleTimeoutText = (response.idleTimeout == 0) ? T("never") : formatTime(response.idleTimeout);
				$("#dd_idle_timeout").text(idleTimeoutText);
			}
		}
	});
}

// Send G-Code directly to the firmware
function sendGCode(gcode, fromInput) {
	if (gcode == "") {
		return;
	}
	lastSentGCode = gcode;
	lastGCodeFromInput = fromInput;

	// Although rr_gcode gives us a JSON response, it doesn't provide any useful values for DWC.
	// We only need to worry about an AJAX error event, which is handled by the global AJAX error callback.
	$.ajax(ajaxPrefix + "rr_gcode?gcode=" + encodeURIComponent(gcode), {
		dataType: "json"
	});
}


// Theme support
function loadThemes() {
	$.ajax(ajaxPrefix + "rr_filelist?dir=0:/www/css", {
		dataType: "json",
		success: function(response) {
			if (response.hasOwnProperty("files")) {
				response.files.forEach(function(item) {
					var theme = item.name.match(/(.+)\.theme\.css/);
					if (item.type == "f" && theme != null) {
						theme = theme[1];
						if (theme != "bootstrap") {
							$("#dropdown_theme > ul").append('<li><a data-theme="' + theme + '" href="#">' + theme + '</a></li>');
						}
					}
				});
			}
		}
	});
}


// For OEM functionality
function getOemFeatures() {
	if (location.host == "") {
		return;
	}

	$.ajax(ajaxPrefix + "rr_download?name=0:/sys/oem.json", {
		dataType: "json",
		global: false,
		success: function(response) {
			if (response != "") {
				if (response.hasOwnProperty("spindleTool")) {
					spindleTools = [response.spindleTool];
				}

				if (response.hasOwnProperty("calibrationCamSource") && response.calibrationCamSource != "") {
					calibrationWebcamSource = response.calibrationCamSource;
					calibrationWebcamEmbedded = response.hasOwnProperty("calibrationCamEmbedded") && response.calibrationCamEmbedded;
				} else {
					calibrationWebcamSource = "";
				}
				updateCalibrationWebcam(true);

				hideLastExtruderDrive = response.hasOwnProperty("hideLastExtruderDrive") && response.hideLastExtruderDrive > 0;
				if (response.hasOwnProperty("vendor")) {
					setOem(response.vendor);
				}
			}
		}
	});
}

function setOem(oem) {
	vendor = oem;

	// Diabase Engineering
	if (oem == "diabase") {
		$(".diabase").removeClass("hidden");
		$(".no-diabase").addClass("hidden");

		$(".navbar-brand").prop("href", "https://www.diabasepe.com").prop("target", "_blank");
		$(".navbar-brand > img").removeClass("hidden").prop("src", "img/diabase_banner.png");

		$("#table_tools tr[data-heater='cabinet'] > th:first-child > a").text(T("Dry Cabinet"));
		$("#table_heaters tr[data-heater='cabinet'] > th:first-child > a").text(T("Dry Cabinet"));

		$("#img_crosshair").prop("src", "img/crosshair.png");
		$("#img_calibration_diagram").prop("src", "img/diabase_calibration_diagram.png");
	}

	// Update GUI just in case the response was received after the first status response
	if (toolMapping != undefined) {
		updateGui();
	}
}
/* File management logic for Duet Web Control
 * 
 * written by Christian Hammacher (c) 2016-2018
 * 
 * licensed under the terms of the GPL v2
 * see http://www.gnu.org/licenses/gpl-2.0.html
 */


var numVolumes, mountedVolumes, mountRequested;

var scansLoaded;

var currentGCodeVolume, changingGCodeVolume;
var currentGCodeDirectory, knownGCodeFiles, gcodeUpdateIndex, gcodeLastDirectory;
var cachedFileInfo;

var currentMacroDirectory, macroLastDirectoryRow, macroLastDirectoryItem, macrosLoaded;
var filamentsLoaded, filamentsExist;
var sysLoaded, displayLoaded;

var multiFileOperations, doingFileTask;
var downloadNotification, zipFile;


/* G-Code file info caching */

function loadFileCache() {
	cachedFileInfo = getLocalSetting("cachedFileInfo", {});
}

function saveFileCache() {
	setLocalSetting("cachedFileInfo", cachedFileInfo);
}

function getFileInfo(directory, filename, callback) {
	var path = directory + "/" + filename;
	var fileInfo = cachedFileInfo[path];
	if (fileInfo == undefined) {
		// Fileinfo is not available, query it from the board
		$.ajax(ajaxPrefix + "rr_fileinfo?name=" + encodeURIComponent(path), {
			dataType: "json",
			timeout: 0,
			success: function(response) {
				// Add response to cache list
				cachedFileInfo[path] = response;

				// We've got it
				callback(directory, filename, response);
			}
		});
	} else {
		// Fileinfo was queried before
		callback(directory, filename, fileInfo);
	}
}

function clearFileCache(filename) {
	if (filename == undefined) {
		cachedFileInfo = {};
		saveFileCache();
	} else {
		cachedFileInfo[filename] = undefined;
	}
}

function clearFileCacheDirectory(directory) {
	for(var path in cachedFileInfo) {
		// Delete cached file info from paths starting with the directory, but skip sub-directories
		if (path.indexOf(directory + "/") == 0 && path.substring(directory.length + 1).indexOf("/") == -1) {
			cachedFileInfo[path] = undefined;
		}
	}
}

function reloadFileCache(path) {
	cachedFileInfo[path] = undefined;
	$.ajax(ajaxPrefix + "rr_fileinfo?name=" + encodeURIComponent(path), {
		dataType: "json",
		timeout: 0,
		success: function(response) {
			cachedFileInfo[path] = response;
		}
	});
}


/* Scans */

$('a[href="#page_scanner"]').on('shown.bs.tab', function() {
	if (!scansLoaded) {
		updateScanFiles();
	}
});

$(".span-refresh-scans").click(function() {
	updateScanFiles();
	$(".span-refresh-scans").addClass("hidden");
});

$("#btn_calibrate_scanner").click(function() {
	if ($(this).hasClass("disabled")) {
		// Don't proceed if the button is disabled
		return;
	}

	if (vendor == "diabase") {
		$("#modal_calibrate").modal("show");
	} else {
		showConfirmationDialog(T("Calibrate Scanner"), T("Before you can calibrate the 3D scanner you need to place the object in the back-right corner. Do you want to continue?"), function() {
			// Send calibration G-code to the firmware
			sendGCode("M754");
		});
	}
});

$("#btn_calibrate_linear").click(function() {
	$("#modal_calibrate").modal("hide");
	sendGCode("M754 N0");
});

$("#btn_calibrate_rotary").click(function() {
	$("#modal_calibrate").modal("hide");
	sendGCode("M754 N1");
});

function addScanFile(filename, size, lastModified) {
	$("#page_scanner h1").addClass("hidden");
	$("#table_scan_files").removeClass("hidden");

	var row =	'<tr data-file="' + filename + '">';
	row +=		'<td><button class="btn btn-info btn-download-file btn-sm" title="' + T("Download this file") + '"><span class="glyphicon glyphicon-download-alt"></span></button></td>';
	row +=		'<td><button class="btn btn-danger btn-delete-file btn-sm" title="' + T("Delete this file") + '"><span class="glyphicon glyphicon-trash"></span></button></td>';
	row +=		'<td><a href="#" class="btn-download-file"><span class="glyphicon glyphicon-file"></span>' + filename + '</a></td>';
	row +=		'<td>' + formatSize(size) + '</td>';
	row +=		'<td>' + ((lastModified == undefined) ? T("unknown") : lastModified.toLocaleString()) + '</td>';
	row +=		'</tr>';
	$("#table_scan_files > tbody").append(row);
}

function updateScanFiles() {
	// Don't load anything if the scanner mode is disabled
	if ($(".scan-control").hasClass("hidden")) {
		return;
	}

	// Clear the file list
	scansLoaded = false;
	$("#table_scan_files > thead > tr > th:first-child").prop("colspan", 2);
	$("#table_scan_files > tbody").children().remove();
	$("#table_scan_files").addClass("hidden");
	$("#page_scanner h1").removeClass("hidden");
	if (isConnected) {
		$(".span-refresh-scans").addClass("hidden");

		// Is the macro volume mounted?
		if ((mountedVolumes & (1 << 0)) == 0) {
			$("#page_scanner h1").text(T("The current volume is not mounted"));
			return;
		}

		$("#page_scanner h1").text(T("loading"));
	} else {
		$("#page_scanner h1").text(T("Connect to your Duet to display scanned files"));
		return;
	}

	// Stop updates and requst files for /scans
	stopUpdates();
	getScanFiles(0);
}

function getScanFiles(first) {
	$.ajax(ajaxPrefix + "rr_filelist?dir=0:/scans&first=" + first, {
		dataType: "json",
		success: function(response) {
			if (isConnected) {
				if (response.hasOwnProperty("err")) {
					// don't proceed if the firmware has reported an error
					$("#page_scanner h1").text(T("Failed to retrieve files of this directory"));
					startUpdates();
				} else {
					// add the files
					for(var i = 0; i < response.files.length; i++) {
						if (response.files[i].type != 'd') {
							var lastModified = response.files[i].hasOwnProperty("date") ? strToTime(response.files[i].date) : undefined;
							addScanFile(response.files[i].name, response.files[i].size, lastModified);
						}
					}

					// see if there is more
					if (response.next != 0 && !compatibilityMode) {
						getScanFiles(response.next);
					} else {
						if (response.files.length == 0) {
							$("#page_scanner h1").text(T("No scans found"));
						}

						scanUpdateFinished();
						startUpdates();
					}
				}
			}
		}
	});
}

function scanUpdateFinished() {
	if (isConnected) {
		$(".span-refresh-scans").toggleClass("hidden", currentPage != "scanner");
		startUpdates();
	} else {
		$(".span-refresh-scans").addClass("hidden");
	}
	scansLoaded = true;
}

$("body").on("click", ".btn-download-file", function(e) {
	var filename = $(this).closest("tr").data("file");
	var filepath = getFilePath() + "/" + filename;

	// Should use a button link instead, but for some reason it isn't properly displayed with latest Bootstrap 3.3.7
	var elem = $('<a target="_blank" href="' + ajaxPrefix + 'rr_download?name=' + encodeURIComponent(filepath) + '" download="' + filename + '"></a>');
	elem.appendTo("body");
	elem[0].click();
	elem.remove();

	e.preventDefault();
});

$("body").on("click", ".btn-delete-file", function(e) {
	var row = $(this).closest("tr");
	var file = row.data("file");
	showConfirmationDialog(T("Delete File"), T("Are you sure you want to delete <strong>{0}</strong>?", file), function() {
		deletePath(file, row);
	});

	e.preventDefault();
});


/* G-Code Files */

// Volume support

function setVolumes(count) {
	if (count == numVolumes) {
		// Don't do anything unless the number has changed
		return;
	}

	$("#td_volume").toggleClass("hidden", count <= 1);
	$("#ul_volumes").children().remove();
	for(var i = 0; i < count; i++) {
		var isMounted = (mountedVolumes & (1 << i)) != 0;

		var item = 	'<li><a href="#" data-volume="' + i + '">';
		if (isMounted) {
			item +=	'<span class="glyphicon glyphicon-ok text-success"></span> ';
		} else {
			item +=	'<span class="glyphicon glyphicon-remove text-danger"></span> ';
		}
		item +=		'<span class="content">' + T("SD Card {0} ({1})", i, isMounted ? T("mounted") : T("not mounted")) + '</span>';
		item +=		'</a></li>';
		$("#ul_volumes").append(item);
	}

	numVolumes = count;
}

function setMountedVolumes(bitmap) {
	if (bitmap == mountedVolumes) {
		// Don't do anything unless the bitmap has changed
		return;
	}
	var oldBitmap = mountedVolumes;
	mountedVolumes = bitmap;

	if ((bitmap & (1 << 0)) != (oldBitmap & (1 << 0))) {
		// Update scanner
		updateScanFiles();

		// Update macros
		updateMacroFiles();

		// Update system files
		updateSysFiles();
	}

	for(var i = 0; i < numVolumes; i++) {
		// Update UI
		var item = $("[data-volume=" + i + "]");
		if ((bitmap & (1 << i)) != 0) {
			item.find("span.glyphicon").removeClass("glyphicon-remove text-danger").addClass("glyphicon-ok text-success");
			item.find("span.content").text(T("SD Card {0} ({1})", i, T("mounted")));
		} else {
			item.find("span.glyphicon").removeClass("glyphicon-ok text-success").addClass("glyphicon-remove text-danger");
			item.find("span.content").text(T("SD Card {0} ({1})", i, T("not mounted")));
		}

		// Check if the requested volume has been mounted
		if (mountRequested && (bitmap & (1 << i)) != (oldBitmap & (1 << i))) {
			mountRequested = false;
			changeGCodeVolume(i);
			return;
		}
	}

	// Is the current G-code volume still mounted?
	if ((bitmap & (1 << currentGCodeVolume)) == 0) {
		// No - find the first one that is mounted
		for(var i = 0; i < numVolumes; i++) {
			if ((bitmap & (1 << i)) != 0) {
				changeGCodeVolume(i);
				return;
			}
		}

		// No volume is mounted at all
		clearGCodeFiles();
	} else {
		// Has the current G-code volume been mounted again?
		if ((oldBitmap & (1 << currentGCodeVolume)) == 0) {
			// Yes - try to reload the files
			gcodeUpdateIndex = -1;
			if (currentPage == "files") {
				updateGCodeFiles();
			}
		}
	}
}

function changeGCodeVolume(volume) {
	currentGCodeVolume = volume;
	$("#btn_volume").removeClass("disabled");
	$("#btn_volume > span.content").text(T("SD Card {0}", volume));

	setGCodeDirectory((volume == 0) ? "0:/gcodes" : volume + ":");
	gcodeUpdateIndex = -1;
	updateGCodeFiles();
}

$("#ul_volumes").on("click", "a", function(e) {
	var volume = $(this).data("volume");
	if ((mountedVolumes & (1 << volume)) == 0) {
		// Volume is not mounted, try to mount it
		$("#btn_volume").addClass("disabled").children("span.content").text(T("Mounting..."));
		sendGCode("M21 P" + volume);
		mountRequested = true;
	} else {
		// Volume is mounted, change it
		changeGCodeVolume(volume);
	}

	e.preventDefault();
});


// File list implementation

$(".span-refresh-files").click(function() {
	clearFileCacheDirectory(currentGCodeDirectory);
	gcodeUpdateIndex = -1;
	updateGCodeFiles();
	$(".span-refresh-files").addClass("hidden");
});

$("body").on("click", "#ol_gcode_directory a", function(e) {
	setGCodeDirectory($(this).data("directory"));
	gcodeUpdateIndex = -1;
	updateGCodeFiles();
	e.preventDefault();
});

$("#btn_new_gcode_directory").click(function() {
	showTextInput(T("New directory"), T("Please enter a name:"), function(value) {
		if (filenameValid(value)) {
			$.ajax(ajaxPrefix + "rr_mkdir?dir=" + encodeURIComponent(currentGCodeDirectory + "/" + value), {
				dataType: "json",
				success: function(response) {
					if (response.err == 0) {
						gcodeUpdateIndex = -1;
						updateGCodeFiles();
					} else {
						showMessage("warning", T("Error"), T("Could not create this directory!"));
					}
				}
			});
		} else {
			showMessage("danger", T("Error"), T("The specified filename is invalid. It may not contain quotes, colons or (back)slashes."));
		}
	});
});

function setGCodeDirectory(directory) {
	currentGCodeDirectory = directory;
	var basePath = (currentGCodeVolume == 0) ? "0:/gcodes" : currentGCodeVolume + ":";
	var baseCaption = (currentGCodeVolume == 0) ? T("G-Codes Directory") : T("Root Directory");
	
	$("#ol_gcode_directory > li.content:not(:first-child)").remove();
	if (directory == basePath) {
		$("#ol_gcode_directory > li.content").replaceWith('<li class="active content"><span class="glyphicon glyphicon-folder-open"></span> ' + baseCaption + '</li>');
		$("#ol_gcode_directory > li:last-child").html('<span class="glyphicon glyphicon-level-up"></span> ' + T("Go Up"));
	} else {
		var listContent = '<li class="content"><a href="#" data-directory="' + basePath + '"><span class="glyphicon glyphicon-folder-open"></span> ' + baseCaption + '</a></li>';
		var directoryItems = directory.split("/"), directoryPath = basePath;
		for(var i = (currentGCodeVolume == 0) ? 2 : 1; i < directoryItems.length - 1; i++) {
			directoryPath += "/" + directoryItems[i];
			listContent += '<li class="active content"><a href="#" data-directory="' + directoryPath + '">' + directoryItems[i] + '</a></li>';
		}
		listContent += '<li class="active content">' + directoryItems[directoryItems.length -1] + '</li>';
		$("#ol_gcode_directory > li.content").replaceWith(listContent);
		$("#ol_gcode_directory > li:last-child").html('<a href="#" data-directory="' + directoryPath + '"><span class="glyphicon glyphicon-level-up"></span> ' + T("Go Up") + '</a>');
	}
}

function clearGCodeDirectory() {
	var baseCaption = (currentGCodeVolume == 0) ? T("G-Codes Directory") : T("Root Directory");
	$("#ol_gcode_directory > li.content:not(:first-child)").remove();
	$("#ol_gcode_directory > li.content").replaceWith('<li class="active content"><span class="glyphicon glyphicon-folder-open"></span> ' + baseCaption + '</li>');
}

function addGCodeFile(filename) {
	$("#page_files h1").addClass("hidden");
	$("#table_gcode_files").removeClass("hidden");

	var row =	'<tr draggable="true" data-file="' + filename + '">';
	row +=		'<td><input type="checkbox"></td>';
	row +=		'<td class="name"><span class="glyphicon glyphicon-asterisk"></span> ' + filename + '</td>';
	row +=		'<td class="size hidden-xs">' + T("loading") + '</td>';
	row +=		'<td class="last-modified hidden-xs hidden-sm">' + T("loading") + '</td>';
	row +=		'<td class="object-height">' + T("loading") + '</td>';
	row +=		'<td class="layer-height hidden-xs">' + T("loading") + '</td>';
	row +=		'<td class="filament-usage">' + T("loading") + '</td>';
	row +=		'<td class="generated-by hidden-xs hidden-sm">' + T("loading") + '</td>';
	row +=		'</tr>';
	return $(row).appendTo("#table_gcode_files > tbody");
}

function addGCodeDirectory(name) {
	$("#page_files h1").addClass("hidden");
	$("#table_gcode_files").removeClass("hidden");

	var row =	'<tr draggable="true" data-directory="' + name + '">';
	row +=		'<td><input type="checkbox"></td>';
	row +=		'<td colspan="7"><a href="#" class="a-gcode-directory"><span class="glyphicon glyphicon-folder-open"></span> ' + name + '</a></td>';
	row +=		'</tr>';

	var rowElem = $(row);
	rowElem[0].addEventListener("dragstart", fileDragStart, false);
	rowElem[0].addEventListener("dragend", fileDragEnd, false);

	if (gcodeLastDirectory == undefined) {
		var firstRow = $("#table_gcode_files > tbody > tr:first-child");
		if (firstRow.length == 0) {
			$("#table_gcode_files > tbody").append(rowElem);
		} else {
			rowElem.insertBefore(firstRow);
		}
	} else {
		rowElem.insertAfter(gcodeLastDirectory);
	}
	gcodeLastDirectory = rowElem;
}

function setGCodeFileItem(row, size, lastModified, height, firstLayerHeight, layerHeight, filamentUsage, generatedBy) {
	var lastModifiedValue = (lastModified == undefined) ? 0 : lastModified.getTime();

	// Make entry interactive and link the missing data attributes to it
	var linkCell = row.children().eq(1);
	linkCell.find("span").removeClass("glyphicon-asterisk").addClass("glyphicon-file");
	linkCell.html('<a href="#" class="a-gcode-file">' + linkCell.html() + '</a>');
	row.data("size", size);
	row.data("last-modified", lastModifiedValue);
	row.data("height", height);
	row.data("first-layer-height", firstLayerHeight);
	row.data("layer-height", layerHeight);
	row.data("filament-usage", filamentUsage);
	row.data("generated-by", generatedBy);

	// Add drag&drop handlers
	row[0].addEventListener("dragstart", fileDragStart, false);
	row[0].addEventListener("dragend", fileDragEnd, false);

	// Set size
	row.find(".size").text(formatSize(size));

	// Set last modified date
	row.find(".last-modified").text(((lastModified == undefined) ? T("n/a") : lastModified.toLocaleString()));

	// Set object height
	row.find(".object-height").text((height > 0) ? T("{0} mm", height) : T("n/a"));

	// Set layer height
	if (layerHeight > 0) {
		var lhText = (firstLayerHeight == undefined) ? (T("{0} mm", layerHeight)) : (firstLayerHeight + " / " + T("{0} mm", layerHeight));
		row.find(".layer-height").text(lhText);
	} else {
		row.find(".layer-height").text(T("n/a"));
	}

	// Set filament usage
	if (filamentUsage.length > 0) {
		var totalUsage = filamentUsage.reduce(function(a, b) { return a + b; }).toFixed(1) + " mm";
		if (filamentUsage.length == 1) {
			row.find(".filament-usage").text(totalUsage);
		} else {
			var individualUsage = T("{0} mm", filamentUsage.reduce(function(a, b) { return T("{0} mm", a) + ", " + b; }));
			var filaUsage = '<abbr class="filament-usage" title="' + individualUsage + '">' + totalUsage + "</abbr>";
			row.find(".filament-usage").html(filaUsage);
		}
	} else {
		row.find(".filament-usage").text(T("n/a"));
	}

	// Set slicer
	var slicer = generatedBy.match(/(.*\d\.\d)\s/);
	if (slicer == null) {
		slicer = generatedBy;
	} else {
		slicer = slicer[1];
	}
	slicer = slicer.replace(" Version", "");
	row.find(".generated-by").text((slicer != "") ? slicer : T("n/a"));
}

function clearGCodeFiles() {
	gcodeLastDirectory = undefined;
	
	$("#table_gcode_files > thead input[type='checkbox']:first-child").prop("checked", false);
	$("#table_gcode_files > tbody").children().remove();
	$("#table_gcode_files").addClass("hidden");
	$("#page_files h1").removeClass("hidden");
	if (isConnected) {
		if ((mountedVolumes & (1 << currentGCodeVolume)) == 0) {
			$("#page_files h1").text(T("The current volume is not mounted"));
		} else {
			$("#page_files h1").text(T("loading"));
		}
	} else {
		$("#page_files h1").text(T("Connect to your Duet to display G-Code files"));
	}
}

function updateGCodeFiles() {
	if (!isConnected) {
		gcodeUpdateIndex = -1;
		gcodeUpdateFinished();

		clearGCodeDirectory();
		clearGCodeFiles();
		return;
	}

	if (gcodeUpdateIndex == -1) {
		// Is the current volume mounted?
		if ((mountedVolumes & (1 << currentGCodeVolume)) == 0) {
			// No - stop here
			clearGCodeFiles();
			return;
		}

		// Yes - fetch the files in the current directory and proceed
		stopUpdates();
		$("#table_gcode_files").css("cursor", "wait");

		gcodeLastDirectory = undefined;
		clearGCodeFiles();

		gcodeUpdateIndex = 0;
		knownGCodeFiles = [];
		getGCodeFiles(0);
	} else if (gcodeUpdateIndex < knownGCodeFiles.length) {
		getFileInfo(currentGCodeDirectory, knownGCodeFiles[gcodeUpdateIndex], function(dir, filename, fileinfo) {
			if (!isConnected || dir != currentGCodeDirectory) {
				return;
			}
			gcodeUpdateIndex++;

			var row = $('#table_gcode_files > tbody > tr[data-file="' + filename + '"]');
			if (row.length > 0) {
				if (fileinfo.err == 0) {
					setGCodeFileItem(row, fileinfo.size, strToTime(fileinfo.lastModified), fileinfo.height, fileinfo.firstLayerHeight, fileinfo.layerHeight, fileinfo.filament, fileinfo.generatedBy);
				} else {
					setGCodeFileItem(row, 0, undefined, 0, 0, 0, [], "");
				}
			}

			if (currentPage == "files") {
				saveFileCache();
				if (gcodeUpdateIndex >= knownGCodeFiles.length) {
					gcodeUpdateFinished();
				} else {
					updateGCodeFiles();
				}
			} else {
				// Updates were suspended so that multiple sessions don't block each other. Resume status updats again
				startUpdates();
			}
		});
	}
}

function getGCodeFiles(first) {
	$.ajax(ajaxPrefix + "rr_files?dir=" + encodeURIComponent(currentGCodeDirectory) + "&first=" + first + "&flagDirs=1", {
		dataType: "json",
		success: function(response) {
			if (isConnected) {
				if (response.err != 0) {
					// don't proceed if the firmware has reported an error
					$("#page_files h1").text(T("Failed to retrieve files of this directory"));

					gcodeUpdateIndex = -1;
					gcodeUpdateFinished();
				} else {
					if (response.files.length == 0) {
						// no files found
						$("#page_files h1").text(T("No Files or Directories found"));
						gcodeUpdateFinished();
					} else {
						// add each file and directory
						for(var i = 0; i < response.files.length; i++) {
							if (response.files[i].indexOf("*") == 0) {
								addGCodeDirectory(response.files[i].substr(1));
							} else {
								knownGCodeFiles.push(response.files[i]);
								addGCodeFile(response.files[i]);
							}
						}

						// see if there are more
						if (response.next != 0) {
							getGCodeFiles(response.next);
						} else {
							// got everything, start fileinfo requests
							updateGCodeFiles();
						}
					}
				}
			}
		}
	});
}

function gcodeUpdateFinished() {
	var table = $("#table_gcode_files").css("cursor", "");
	sortTable(table);

	if (isConnected) {
		$(".span-refresh-files").toggleClass("hidden", currentPage != "files");
		startUpdates();
	} else {
		$(".span-refresh-files").addClass("hidden");
	}
}

$("body").on("click", ".a-gcode-directory", function(e) {
	setGCodeDirectory(currentGCodeDirectory + "/" + $(this).closest("tr").data("directory"));
	gcodeUpdateIndex = -1;
	updateGCodeFiles();
	e.preventDefault();
});

$("body").on("click", ".a-gcode-file", function(e) {
	var file = $(this).closest("tr").data("file");
	showConfirmationDialog(T("Run G-Code File"), T("Do you want to run <strong>{0}</strong>?", file), function() {
		waitingForJobStart = true;
		if (currentGCodeVolume != 0) {
			sendGCode('M32 "' + currentGCodeDirectory + "/" + file + '"');
		} else if (currentGCodeDirectory == "0:/gcodes") {
			sendGCode('M32 "' + file + '"');
		} else {
			sendGCode('M32 "' + currentGCodeDirectory.substring(10) + "/" + file + '"');
		}
	});
	e.preventDefault();
});


/* Macros */

$(".span-refresh-macros").click(function() {
	updateMacroFiles();
	$(".span-refresh-macros").addClass("hidden");
});

$("body").on("click", "#ol_macro_directory a", function(e) {
	setMacroDirectory($(this).data("directory"));
	updateMacroFiles();
	e.preventDefault();
});

function clearMacroDirectory() {
	$("#ol_macro_directory").children(":not(:last-child)").remove();
	$("#ol_macro_directory").prepend('<li class="active"><span class="glyphicon glyphicon-folder-open"></span> ' + T("Macros Directory") + '</li>');
}

function setMacroDirectory(directory) {
	currentMacroDirectory = directory;

	$("#ol_macro_directory").children(":not(:last-child)").remove();
	if (directory == "0:/macros") {
		$("#ol_macro_directory").prepend('<li class="active"><span class="glyphicon glyphicon-folder-open"></span> ' + T("Macros Directory") + '</li>');
		$("#ol_macro_directory li:last-child").html('<span class="glyphicon glyphicon-level-up"></span> ' + T("Go Up"));
	} else {
		var listContent = '<li><a href="#" data-directory="0:/macros"><span class="glyphicon glyphicon-folder-open"></span> ' + T("Macros Directory") + '</a></li>';
		var directoryItems = directory.split("/"), directoryPath = "0:/macros";
		for(var i = 2; i < directoryItems.length - 1; i++) {
			directoryPath += "/" + directoryItems[i];
			listContent += '<li class="active"><a href="#" data-directory="' + directoryPath + '">' + directoryItems[i] + '</a></li>';
		}
		listContent += '<li class="active">' + directoryItems[directoryItems.length -1] + '</li>';
		$("#ol_macro_directory").prepend(listContent);
		$("#ol_macro_directory li:last-child").html('<a href="#" data-directory="' + directoryPath + '"><span class="glyphicon glyphicon-level-up"></span> ' + T("Go Up") + '</a>');
	}
}

$("#a_new_macro_directory").click(function(e) {
	showTextInput(T("New directory"), T("Please enter a name:"), function(value) {
		if (filenameValid(value)) {
			$.ajax(ajaxPrefix + "rr_mkdir?dir=" + currentMacroDirectory + "/" + value, {
				dataType: "json",
				success: function(response) {
					if (response.err == 0) {
						updateMacroFiles();
					} else {
						showMessage("warning", T("Error"), T("Could not create this directory!"));
					}
				}
			});
		} else {
			showMessage("danger", T("Error"), T("The specified filename is invalid. It may not contain quotes, colons or (back)slashes."));
		}
	});
	e.preventDefault();
});

$("#a_new_macro_file").click(function(e) {
	showTextInput(T("New macro"), T("Please enter a filename:"), function(file) {
		if (filenameValid(file)) {
			showEditDialog(currentMacroDirectory + "/" + file, "", function(value) {
				uploadTextFile(currentMacroDirectory + "/" + file, value, updateMacroFiles);
			});
		} else {
			showMessage("danger", T("Error"), T("The specified filename is invalid. It may not contain quotes, colons or (back)slashes."));
		}
	});
	e.preventDefault();
});

function stripMacroFilename(filename) {
	var label = filename;

	// Remove G-code file ending from name
	var match = filename.match(/(.*)\.(g|gc|gcode)$/i);
	if (match != null) {
		label = match[1];
	}

	// Users may want to index their macros, so remove starting numbers
	match = label.match(/^\d+_(.*)/);
	if (match != null) {
		label = match[1];
	}

	return label;
}

function addMacroFile(filename, size, lastModified) {
	// Control Page
	if (currentMacroDirectory == "0:/macros") {
		var macroButton =	'<div class="btn-group">';
		macroButton +=		'<button class="btn btn-default btn-macro btn-sm" data-macro="0:/macros/' + filename + '">' +  stripMacroFilename(filename) + '</button>';
		macroButton +=		'</div>';

		$("#panel_macro_buttons h4").addClass("hidden");
		$("#panel_macro_buttons .btn-group-vertical").append(macroButton);
	}

	// Macro Page
	$("#page_macros h1").addClass("hidden");
	$("#table_macro_files").removeClass("hidden");

	var lastModifiedValue = (lastModified == undefined) ? 0 : lastModified.getTime();
	var row =	'<tr draggable="true" data-file="' + filename + '" data-size="' + size + '" data-last-modified="' + lastModifiedValue + '">';
	row +=		'<td><input type="checkbox"></td>';
	row +=		'<td><a href="#" class="a-macro-file"><span class="glyphicon glyphicon-file"></span> ' + filename + '</a></td>';
	row +=		'<td class="size">' + formatSize(size) + '</td>';
	row +=		'<td>' + ((lastModified == undefined) ? T("unknown") : lastModified.toLocaleString()) + '</td>';
	row +=		'</tr>\n';

	var rowElem = $(row);
	rowElem[0].addEventListener("dragstart", fileDragStart, false);
	rowElem[0].addEventListener("dragend", fileDragEnd, false);
	rowElem.appendTo("#table_macro_files > tbody");
}

function addMacroDirectory(name) {
	// Control Page
	if (currentMacroDirectory == "0:/macros") {
		$("#panel_macro_buttons h4").addClass("hidden");

		var button =	'<div class="btn-group">';
		button +=		'<button class="btn btn-info btn-macro btn-sm" data-directory="0:/macros/' + name + '" data-toggle="dropdown">' + name + ' <span class="caret"></span></button>';
		button +=		'<ul class="dropdown-menu"></ul>';
		button +=		'</div>';

		var buttonElem = $(button);
		if (macroLastDirectoryItem == undefined) {
			var firstButton = $("#panel_macro_buttons .btn-group-vertical > div:first-child");
			if (firstButton.length == 0) {
				$("#panel_macro_buttons .btn-group-vertical").append(buttonElem);
			} else {
				buttonElem.insertBefore(firstButton);
			}
		} else {
			buttonElem.insertAfter(macroLastDirectoryItem);
		}
		macroLastDirectoryItem = buttonElem;
	}

	// Macro Page
	$("#page_macros h1").addClass("hidden");
	$("#table_macro_files").removeClass("hidden");

	var row =	'<tr draggable="true" data-directory="' + name + '">';
	row +=		'<td><input type="checkbox"></td>';
	row +=		'<td colspan="3"><a href="#" class="a-macro-directory"><span class="glyphicon glyphicon-folder-open"></span> ' + name + '</a></td>';
	row +=		'<td class="hidden"></td>';
	row +=		'<td class="hidden"></td>';
	row +=		'</tr>\n';

	var rowElem = $(row);
	rowElem[0].addEventListener("dragstart", fileDragStart, false);
	rowElem[0].addEventListener("dragend", fileDragEnd, false);

	if (macroLastDirectoryRow == undefined) {
		var firstRow = $("#table_macro_files > tbody > tr:first-child");
		if (firstRow.length == 0) {
			$("#table_macro_files > tbody").append(rowElem);
		} else {
			rowElem.insertBefore(firstRow);
		}
	} else {
		rowElem.insertAfter(macroLastDirectoryRow);
	}
	macroLastDirectoryRow = rowElem;
}

function updateMacroFiles() {
	clearMacroFiles();
	if (!isConnected) {
		$(".span-refresh-macros").addClass("hidden");
		return;
	}

	// Is the macro volume mounted?
	if ((mountedVolumes & (1 << 0)) == 0) {
		// No - stop here
		clearMacroFiles();
		return;
	}

	// Yes - fetch the filelist for the current directory and proceed
	stopUpdates();
	getMacroFiles(0);
}

function getMacroFiles(first) {
	$.ajax(ajaxPrefix + "rr_filelist?dir=" + encodeURIComponent(currentMacroDirectory) + "&first=" + first, {
		dataType: "json",
		success: function(response) {
			if (isConnected) {
				if (response.hasOwnProperty("err")) {
					// don't proceed if the firmware has reported an error
					$("#page_macros h1").text(T("Failed to retrieve files of this directory"));
					if (currentMacroDirectory == "0:/macros") {
						$("#panel_macro_buttons h4").text(T("Failed to retrieve files of this directory"));
					}
					startUpdates();
				} else {
					// add macro files and directories
					for(var i = 0; i < response.files.length; i++) {
						if (response.files[i].type == 'd') {
							addMacroDirectory(response.files[i].name);
						} else {
							var lastModified = response.files[i].hasOwnProperty("date") ? strToTime(response.files[i].date) : undefined;
							addMacroFile(response.files[i].name, response.files[i].size, lastModified);
						}
					}

					// see if there is more
					if (response.next != 0 && !compatibilityMode) {
						getMacroFiles(response.next);
					} else {
						if (response.files.length == 0) {
							$("#page_macros h1").text(T("No Macro Files found"));
						}

						startUpdates();
						macroFilesLoaded();
					}
				}
			}
		}
	});
}

function macroFilesLoaded() {
	if (currentPage == "macros") {
		$(".span-refresh-macros").removeClass("hidden");
	}

	sortTable($("#table_macro_files"));
	if (currentMacroDirectory == "0:/macros") {
		var listitems = $("#panel_macro_buttons > div > div.btn-group-vertical").children("div.btn-group").get();
		listitems.sort(function(a, b) {
			var filename1 = $(a).children("button").data("macro") || $(a).children("button").data("directory");
			var filename2 = $(b).children("button").data("macro") || $(b).children("button").data("directory");
			var result = filename1.toUpperCase().localeCompare(filename2.toUpperCase());
			return ($(a).children("button").data("directory") != undefined) ? result - 1 : result;
		})
		$.each(listitems, function(idx, itm) { $("#panel_macro_buttons > div > div.btn-group-vertical").append(itm); });
	}

	macrosLoaded = true;
}

function clearMacroFiles() {
	// Control Page
	if (currentMacroDirectory == "0:/macros") {
		macroLastDirectoryItem = undefined;

		$("#panel_macro_buttons .btn-group-vertical").children().remove();
		if (!isConnected) {
			$("#panel_macro_buttons h4").text(T("Connect to your Duet to display Macro files"));
		} else if ((mountedVolumes & (1 << 0)) == 0) {
			$("#panel_macro_buttons h4").text(T("The first volume is not mounted"));
		} else {
			$("#panel_macro_buttons h4").text(T("Go to the Macros page to define your own actions"));
		}
		$("#panel_macro_buttons h4").removeClass("hidden");
	}

	// Macros Page
	macrosLoaded = false;
	macroLastDirectoryRow = undefined;

	$("#table_macro_files > thead input[type='checkbox']:first-child").prop("checked", false);
	$("#table_macro_files > tbody").children().remove();
	$("#table_macro_files").addClass("hidden");
	$("#page_macros h1").removeClass("hidden");
	if (isConnected) {
		if ((mountedVolumes & (1 << 0)) == 0) {
			$("#page_macros h1").text(T("The first volume is not mounted"));
		} else {
			$("#page_macros h1").text(T("loading"));
		}
	} else {
		$("#page_macros h1").text(T("Connect to your Duet to display Macro files"));
	}
}

$("body").on("click", ".btn-macro", function(e) {
	var directory = $(this).data("directory");
	if (directory != undefined) {
		var dropdown = $(this).parent().children("ul");
		dropdown.css("width", $(this).outerWidth());
		getMacroDropdown(directory, dropdown, 0);
		dropdown.dropdown();
	} else {
		sendGCode('M98 P"' + $(this).data("macro") + '"');
	}
	e.preventDefault();
});

function getMacroDropdown(directory, dropdown, first) {
	$.ajax(ajaxPrefix + "rr_filelist?dir=" + encodeURIComponent(directory) + "&first=" + first, {
		dataType: "json",
		success: function(response) {
			if (response.hasOwnProperty("err")) {
				dropdown.html('<li><a href="#" class="disabled" style="color:#777;">' + T("Failed to retrieve files of this directory") + '</a></li>');
			} else if (response.files.length == 0) {
				dropdown.html('<li><a href="#" class="disabled" style="color:#777;">' + T("No files found!") + '</a></li>');
			} else {
				// prepare drop-down content
				if (first == 0) {
					dropdown.html('<li class="static"><a href="#" class="disabled" style="color:#777;">' + directory + '</a></li><li class="divider"></li>');
				}

				// add the macro files and directories
				response.files.forEach(function(file) {
					if (file.type == 'd') {
						var item = $('<li class="bg-info"><a href="#" data-directory="' + directory + '/' + file.name + '">' + file.name + ' <span class="caret"></span></a></li>');
						item.find("a").click(function(e) {
							getMacroDropdown($(this).data("directory"), $(this).closest("ul"), 0);
							e.stopPropagation();
							e.preventDefault();
						});
						dropdown.append(item);
					} else {
						var item = $('<li><a href="#" data-macro="' + directory + '/' + file.name + '">' + stripMacroFilename(file.name) + '</a></li>');
						item.find("a").click(function(e) {
							sendGCode('M98 P"' + $(this).data("macro") + '"');
							e.preventDefault();
						});
						dropdown.append(item);
					}
				});

				// see if there is more
				if (response.next != 0 && !compatibilityMode) {
					getMacroDropdown(directory, dropdown, response.next);
				} else {
					var listitems = dropdown.children("li").get();
					listitems.sort(function(a, b) {
						var result = $(a).text().toUpperCase().localeCompare($(b).text().toUpperCase());
						if ($(a).hasClass("static")) {
							return result - 3;
						}
						if ($(a).hasClass("divider")) {
							return result - 2;
						}
						return ($(a).data("directory") != null) ? result - 1 : result;
					})
					$.each(listitems, function(idx, itm) { dropdown.append(itm); });
				}
			}
		}
	});
}

$("body").on("click", ".a-macro-directory", function(e) {
	setMacroDirectory(currentMacroDirectory + "/" + $(this).closest("tr").data("directory"));
	updateMacroFiles();
	e.preventDefault();
});

$("body").on("click", ".a-macro-file", function(e) {
	var file = $(this).closest("tr").data("file");
	showConfirmationDialog(T("Run Macro"), T("Do you want to run <strong>{0}</strong>?", file), function() {
		sendGCode('M98 P"' + currentMacroDirectory + "/" + file + '"');
	});
	e.preventDefault();
});


/* Filaments */

$(".span-refresh-filaments").click(function() {
	updateFilaments();
	$(".span-refresh-filaments").addClass("hidden");
});

$("#btn_new_filament").click(function() {
	showTextInput(T("New filament"), T("Please enter a name:"), function(value) {
		if (filenameValid(value)) {
			if (filamentsExist) {
				$.ajax(ajaxPrefix + "rr_mkdir?dir=" + encodeURIComponent("0:/filaments/" + value), {
					dataType: "json",
					success: function(response) {
						if (response.err == 0) {
							uploadTextFile("0:/filaments/" + value + "/load.g", "", undefined, false);
							uploadTextFile("0:/filaments/" + value + "/unload.g", "", undefined, false);
							updateFilaments();
						} else {
							showMessage("warning", T("Error"), T("Could not create this directory!"));
						}
					}
				});
			} else {
				$.ajax(ajaxPrefix + "rr_mkdir?dir=0:/filaments", {
					dataType: "json",
					success: function(response) {
						if (response.err == 0) {
							$.ajax(ajaxPrefix + "rr_mkdir?dir=" + encodeURIComponent("0:/filaments/" + value), {
								dataType: "json",
								success: function(response) {
									if (response.err == 0) {
										uploadTextFile("0:/filaments/" + value + "/load.g", "", undefined, false);
										uploadTextFile("0:/filaments/" + value + "/unload.g", "", undefined, false);
										updateFilaments();
									} else {
										showMessage("warning", T("Error"), T("Could not create this directory!"));
									}
								}
							});
						}
					}
				});
			}
		} else {
			showMessage("danger", T("Error"), T("The specified filename is invalid. It may not contain quotes, colons or (back)slashes."));
		}
	});
});

function updateFilaments() {
	clearFilaments();
	if (!isConnected) {
		$(".span-refresh-filaments").addClass("hidden");
		return;
	}

	// Is the macro volume mounted?
	if ((mountedVolumes & (1 << 0)) == 0) {
		// No - stop here
		clearFilaments();
		return;
	}

	// Yes - fetch the filelist for the current directory and proceed
	stopUpdates();
	getFilaments(0);
}

function getFilaments(first) {
	$.ajax(ajaxPrefix + "rr_filelist?dir=0:/filaments&first=" + first, {
		dataType: "json",
		success: function(response) {
			if (isConnected) {
				if (response.hasOwnProperty("err")) {
					// don't proceed if the firmware has reported an error
					filamentsExist = false;
					$("#page_filaments h1").text(T("Failed to retrieve Filaments"));
					startUpdates();
				} else {
					var files = response.files, filamentsAdded = 0;
					for(var i = 0; i < files.length; i++) {
						if (files[i].type == 'd') {
							var dateCreated = files[i].hasOwnProperty("date") ? strToTime(files[i].date) : undefined;
							addFilament(files[i].name, dateCreated);
							filamentsAdded++;
						}
					}

					if (response.next != 0 && !compatibilityMode) {
						getFilaments(response.next);
					} else {
						if (filamentsAdded == 0) {
							$("#page_filaments h1").text(T("No Filaments found"));
						} else {
							sortTable($("#table_filaments"));
						}

						if (currentPage == "filaments") {
							$(".span-refresh-filaments").removeClass("hidden");
						}

						filamentsLoaded = true;
						filamentsExist = true;
						startUpdates();
					}
				}
			}
		}
	});
}

function addFilament(name, dateCreated) {
	$("#page_filaments h1").addClass("hidden");
	$("#table_filaments").removeClass("hidden");

	var dateCreatedValue = (dateCreated == undefined) ? 0 : dateCreated.getTime();
	var row =	'<tr data-filament="' + name + '" data-date-created="' + dateCreatedValue + '">';
	row +=		'<td><input type="checkbox"></td>';
	row +=		'<td><a href="#" class="a-filament"><span class="glyphicon glyphicon-cd"></span> ' + name + '</a></td>';
	row +=		'<td>' + ((dateCreated == undefined) ? T("unknown") : dateCreated.toLocaleString()) + '</td>';
	row +=		'</tr>';
	$("#table_filaments > tbody").append(row);
}

function clearFilaments() {
	filamentsLoaded = false;
	filamentsExist = false;

	$("#table_filaments > thead input[type='checkbox']:first-child").prop("checked", false);
	$("#table_filaments > tbody").children().remove();
	$("#table_filaments").addClass("hidden");
	$("#page_filaments h1").removeClass("hidden");
	if (isConnected) {
		if ((mountedVolumes & (1 << 0)) == 0) {
			$("#page_filaments h1").text(T("The first volume is not mounted"));
		} else {
			$("#page_filaments h1").text(T("loading"));
		}
	} else {
		$("#page_filaments h1").text(T("Connect to your Duet to display Filaments"));
	}
}

$("#table_filaments > tbody").on("click", ".a-filament", function(e) {
	e.preventDefault();
});


/* System Editor */

$('a[href="#page_sysedit"]').on('shown.bs.tab', function() {
	if (!sysLoaded) {
		updateSysFiles();
	}
});

$("#a_new_sys_file").click(function() {
	showTextInput(T("New File"), T("Please enter a filename:"), function(file) {
		if (filenameValid(file)) {
			showEditDialog("0:/sys/" + file, "", function(value) {
				uploadTextFile("0:/sys/" + file, value, updateSysFiles);
			});
		} else {
			showMessage("danger", T("Error"), T("The specified filename is invalid. It may not contain quotes, colons or (back)slashes."));
		}
	});
});

$("#a_refresh_sys").click(function(e) {
	updateSysFiles();
	e.preventDefault();
});

function addSysFile(filename, size, lastModified) {
	$("#page_sysedit h1").addClass("hidden");
	$("#table_sys_files").removeClass("hidden");

	var lastModifiedValue = (lastModified == undefined) ? 0 : lastModified.getTime();
	var row =	'<tr data-file="' + filename + '" data-size="' + size + '" data-last-modified="' + lastModifiedValue + '">';
	row +=		'<td><input type="checkbox"></td>';
	row +=		'<td><a href="#"><span class="glyphicon glyphicon-file"></span> ' + filename + '</a></td>';
	row +=		'<td class="size">' + formatSize(size) + '</td>';
	row +=		'<td>' + ((lastModified == undefined) ? T("unknown") : lastModified.toLocaleString()) + '</td>';
	row +=		'</tr>';
	$("#table_sys_files > tbody").append(row);
}

function updateSysFiles() {
	// Clear the file list
	sysLoaded = false;
	$("#table_sys_files > tbody").children().remove();
	$("#table_sys_files").addClass("hidden");
	$("#page_sysedit h1").removeClass("hidden");
	if (isConnected) {
		$("#a_refresh_sys").addClass("hidden");

		// Is the macro volume mounted?
		if ((mountedVolumes & (1 << 0)) == 0) {
			$("#page_sysedit h1").text(T("The current volume is not mounted"));
			return;
		}

		$("#page_sysedit h1").text(T("loading"));
	} else {
		$("#page_sysedit h1").text(T("Connect to your Duet to display System files"));
		return;
	}

	// Don't request updates while loading the file list
	stopUpdates();
	getSysFiles(0);
}

function getSysFiles(first) {
	$.ajax(ajaxPrefix + "rr_filelist?dir=0:/sys&first=" + first, {
		dataType: "json",
		success: function(response) {
			if (isConnected) {
				if (response.hasOwnProperty("err")) {
					// don't proceed if the firmware has reported an error
					$("#page_sysedit h1").text(T("Failed to retrieve files of this directory"));
					startUpdates();
				} else {
					// add the files
					var files = response.files, filesAdded = 0;
					for(var i = 0; i < files.length; i++) {
						if (files[i].type != 'd') {
							var lastModified = files[i].hasOwnProperty("date") ? strToTime(files[i].date) : undefined;
							addSysFile(files[i].name, files[i].size, lastModified);
							filesAdded++;
						}
					}

					// see if there is more
					if (response.next != 0 && !compatibilityMode) {
						getSysFiles(response.next);
					} else {
						if (filesAdded == 0) {
							$("#page_sysedit h1").text(T("No System Files found"));
						} else {
							sortTable($("#table_sys_files"));
						}
						$("#a_refresh_sys").removeClass("hidden");

						sysLoaded = true;
						startUpdates();
					}
				}
			}
		}
	});
}

$("#table_sys_files").on("click", "tbody a", function(e) {
	var row = $(this).closest("tr");
	var file = row.data("file");
	if (file.match("\.g$") != null || file.match("\.txt$") != null || file.match("\.json$") != null) {
		// Edit .g, .txt and .json files
		editFile(getFilePath() + "/" + file, true, row.data("size"), function(newSize) {
			row.data("size", newSize).find(".size").text(formatSize(newSize));
			sortTable($("#table_sys_files"));
		});
	} else if (file.match("\.csv$") != null) {
		// Treat .csv files as heightmaps or open them in the editor if their header doesn't match
		getHeightmap(getFilePath() + "/" + file);
	} else {
		// Download every other file
		var elem = $('<a target="_blank" href="' + ajaxPrefix + 'rr_download?name=' + encodeURIComponent(getFilePath() + "/" + file) + '" download="' + file + '"></a>');
		elem.appendTo("body");
		elem[0].click();
		elem.remove();
	}
	e.preventDefault();
});


/* Display Editor */

$('a[href="#page_display"]').on('shown.bs.tab', function() {
	if (!displayLoaded) {
		updateDisplayFiles();
	}
});

$("#a_new_display_file").click(function() {
	showTextInput(T("New File"), T("Please enter a name for the display item:"), function(file) {
		if (filenameValid(file)) {
			showEditDialog("0:/menu/" + file, "", function(value) {
				uploadTextFile("0:/menu/" + file, value, updateDisplayFiles);
			});
		} else {
			showMessage("danger", T("Error"), T("The specified filename is invalid. It may not contain quotes, colons or (back)slashes."));
		}
	});
});

$("#a_refresh_display").click(function(e) {
	updateDisplayFiles();
	e.preventDefault();
});

function addDisplayFile(filename, size, lastModified) {
	$("#page_display h1").addClass("hidden");
	$("#table_display_files").removeClass("hidden");

	var lastModifiedValue = (lastModified == undefined) ? 0 : lastModified.getTime();
	var row =	'<tr data-file="' + filename + '" data-size="' + size + '" data-last-modified="' + lastModifiedValue + '">';
	row +=		'<td><input type="checkbox"></td>';
	row +=		'<td><a href="#"><span class="glyphicon glyphicon-file"></span> ' + filename + '</a></td>';
	row +=		'<td class="size">' + formatSize(size) + '</td>';
	row +=		'<td>' + ((lastModified == undefined) ? T("unknown") : lastModified.toLocaleString()) + '</td>';
	row +=		'</tr>';
	$("#table_display_files > tbody").append(row);
}

function updateDisplayFiles() {
	// Clear the file list
	displayLoaded = false;
	$("#table_display_files > tbody").children().remove();
	$("#table_display_files").addClass("hidden");
	$("#page_display h1").removeClass("hidden");
	if (isConnected) {
		$("#a_refresh_display").addClass("hidden");

		// Is the macro volume mounted?
		if ((mountedVolumes & (1 << 0)) == 0) {
			$("#page_display h1").text(T("The current volume is not mounted"));
			return;
		}

		$("#page_display h1").text(T("loading"));
	} else {
		$("#page_display h1").text(T("Connect to your Duet to show Display items"));
		return;
	}

	// Don't request updates while loading the file list
	stopUpdates();
	getDisplayFiles(0);
}

function getDisplayFiles(first) {
	$.ajax(ajaxPrefix + "rr_filelist?dir=0:/menu&first=" + first, {
		dataType: "json",
		success: function(response) {
			if (isConnected) {
				if (response.hasOwnProperty("err")) {
					// don't proceed if the firmware has reported an error
					$("#page_display h1").text(T("Failed to retrieve files of this directory"));
					startUpdates();
				} else {
					// add the files
					var files = response.files, filesAdded = 0;
					for(var i = 0; i < files.length; i++) {
						if (files[i].type != 'd') {
							var lastModified = files[i].hasOwnProperty("date") ? strToTime(files[i].date) : undefined;
							addDisplayFile(files[i].name, files[i].size, lastModified);
							filesAdded++;
						}
					}

					// see if there is more
					if (response.next != 0 && !compatibilityMode) {
						getDisplayFiles(response.next);
					} else {
						if (filesAdded == 0) {
							$("#page_display h1").text(T("No Display items found"));
						} else {
							sortTable($("#table_display_files"));
						}
						$("#a_refresh_display").removeClass("hidden");

						displayLoaded = true;
						startUpdates();
					}
				}
			}
		}
	});
}

$("#table_display_files").on("click", "tbody a", function(e) {
	// Edit menu items as text files
	var row = $(this).closest("tr");
	var file = row.data("file");
	editFile(getFilePath() + "/" + file, true, row.data("size"), function(newSize) {
		row.data("size", newSize).find(".size").text(formatSize(newSize));
		sortTable($("#table_display_files"));
	});

	e.preventDefault();
});


/* Drag & Drop */

var draggingObjects, dragImage;

function fileDragStart(e) {
	// Work out which elements shall be dragged
	draggingObjects = $(this);
	if ($(this).find("input[type='checkbox']").prop("checked")) {
		draggingObjects = $(this).closest("tbody").find("input[type='checkbox']:checked").parents("tr");
	}

	// Set an alternative drag image
	if (typeof e.dataTransfer.setDragImage === "function") {
		dragImage = draggingObjects.closest("table").clone();
		dragImage.children("thead").remove();

		if (draggingObjects.length == 1) {
			var file = draggingObjects.data("file");
			if (file != undefined) {
				dragImage.find('tr[data-file!="' + file + '"]').remove();
			} else {
				var directory = draggingObjects.data("directory");
				dragImage.find('tr[data-directory!="' + directory + '"]').remove();
			}
		} else {
			dragImage.find("input[type='checkbox']:not(:checked)").parents("tr").remove();
		}

		$(document.body).css("overflow", "none");
		dragImage.css({
			"top": (e.pageY - e.offsetY) + "px",
			"left": (e.pageX - e.offsetX) + "px",
			"opacity": 0.5,
			"position": "absolute",
			"pointerEvents": "none",
			"width": draggingObjects.closest("table").width()
		}).appendTo(document.body);

		e.dataTransfer.setDragImage(dragImage[0], e.offsetX, e.offsetY);
		setTimeout(function() {
			dragImage.remove();
			$(document.body).css("overflow", "");
		});
	}

	dobjs = draggingObjects;
	ev = e;
}

function fileDragEnd(e) {
	draggingObjects = undefined;
}

$(".table-files").on("dragover", "tr", function(e) {
	var row = $(e.target).closest("tr");
	if (draggingObjects != undefined && row != undefined) {
		var dir = row.data("directory");
		if (dir != undefined) {
			for(var i = 0; i < draggingObjects.length; i++) {
				if (dir == draggingObjects.eq(i).data("directory")) {
					return;
				}
			}

			e.stopPropagation();
			e.preventDefault();
		}
	}
});

$(".table-files").on("drop", "tr", function(e) {
	if (draggingObjects == undefined) {
		return;
	}

	var directory = $(e.target).closest("tr").data("directory");
	for(var i = 0; i < draggingObjects.length; i++) {
		var sourcePath = draggingObjects.eq(i).data("file");
		if (sourcePath == undefined) {
			sourcePath = draggingObjects.eq(i).data("directory");
		}

		var targetPath;
		if (currentPage == "files") {
			targetPath = currentGCodeDirectory + "/" + directory + "/" + sourcePath;
			sourcePath = currentGCodeDirectory + "/" + sourcePath;

			clearFileCache(sourcePath);
			clearFileCache(targetPath);
		} else {
			targetPath = currentMacroDirectory + "/" + directory + "/" + sourcePath;
			sourcePath = currentMacroDirectory + "/" + sourcePath;
		}

		moveFile(sourcePath, targetPath, undefined, undefined, draggingObjects.eq(i));
	}

	e.stopPropagation();
	e.preventDefault();
});

$("#ol_gcode_directory, #ol_macro_directory").on("dragover", "a", function(e) {
	if (draggingObjects != undefined) {
		e.stopPropagation();
		e.preventDefault();
	}
});

$("#ol_gcode_directory, #ol_macro_directory").on("drop", "a", function(e) {
	if (draggingObjects == undefined) {
		return;
	}

	var directory = $(e.target).data("directory");
	for(var i = 0; i < draggingObjects.length; i++) {
		var sourcePath = draggingObjects.eq(i).data("file");
		if (sourcePath == undefined) {
			sourcePath = draggingObjects.eq(i).data("directory");
		}

		var targetPath;
		if (currentPage == "files") {
			targetPath = directory + "/" + sourcePath;
			sourcePath = currentGCodeDirectory + "/" + sourcePath;

			clearFileCache(sourcePath);
			clearFileCache(targetPath);
		} else {
			targetPath = directory + "/" + sourcePath;
			sourcePath = currentMacroDirectory + "/" + sourcePath;
		}

		moveFile(sourcePath, targetPath, undefined, undefined, draggingObjects.eq(i));
	}
});


/* List Item Events */

$(".table-files > thead input[type='checkbox']:first-child").change(function(e) {
	$(this).closest("table").find("tbody > tr > td:first-child > input[type='checkbox']").prop("checked", $(this).prop("checked")).trigger("change");
});

$(".table-files").on("change", "td:first-child > input[type='checkbox']", function() {
	$(this).closest("tr").toggleClass("info", $(this).prop("checked"));
});

$(".table-files").on("click", "tr", function(e) {
	if ($(e.target).is("td")) {
		var row = $(e.target).closest("tr");
		var checkbox = row.find('input[type="checkbox"]');
		if (checkbox.length > 0) {
			// Toggle state of checkbox if available
			checkbox.prop("checked", !checkbox.prop("checked")).trigger("change");
		}
	}
});

$(".table-files").on("contextmenu", "tr", function(e) {
	if ($(e.target).closest("tbody").length > 0) {
		showContextMenu($(e.target).closest("tr"), e.clientX, e.clientY);
		e.stopPropagation();
	}
	e.preventDefault();
});

$(".table-files").on("dblclick", "tr", function(e) {
	if ($(e.target).is("td")) {
		var row = $(e.target).closest("tr");
		var link = row.find("a");
		if (link.length > 0) {
			// Simulate click on link when the row is double-clicked
			link.trigger("click");
		}
	}
});


/* Table Headers */

function loadTableSorting() {
	var tableSorting = getLocalSetting("tableSorting", null);
	if (tableSorting != null) {
		for(var tableId in tableSorting) {
			var tableHeader = $("#" + tableId).children("thead");
			tableHeader.find("span").removeClass("glyphicon").removeClass("glyphicon-sort-by-alphabet").removeClass("glyphicon glyphicon-sort-by-alphabet-alt");

			var link = tableHeader.find("a[data-attribute='" + tableSorting[tableId].column + "']");
			link.parent().find("span").addClass("glyphicon").addClass(tableSorting[tableId].ascending ? "glyphicon-sort-by-alphabet" : "glyphicon-sort-by-alphabet-alt");
		}
	}
}

$(".table-files > thead a").click(function(e) {
	// Determine in which way the column needs to be sorted
	var span = $(this).closest("th").children("span");
	var sortAscending = !span.hasClass("glyphicon-sort-by-alphabet");
	$(this).closest("tr").find("span").removeClass("glyphicon").removeClass("glyphicon-sort-by-alphabet").removeClass("glyphicon-sort-by-alphabet-alt");
	span.addClass("glyphicon").addClass(sortAscending ? "glyphicon-sort-by-alphabet" : "glyphicon-sort-by-alphabet-alt");

	// Do the actual sorting
	sortTable($(this).closest("table"));

	// Make sure we remember the last sorting order
	var tableSorting = getLocalSetting("tableSorting", {});
	tableSorting[$(this).closest("table").prop("id")] = { column: $(this).data("attribute"), ascending: sortAscending };
	setLocalSetting("tableSorting", tableSorting);

	$(this).blur();
	e.preventDefault();
});

function sortTable(table) {
	var sortingSpan = table.children("thead").find("span.glyphicon");
	var attribute = sortingSpan.parent().children("a").data("attribute");
	var ascending = sortingSpan.hasClass("glyphicon-sort-by-alphabet");

	var rows = table.children("tbody").children().detach();
	if (table.prop("id") == "table_filaments") {
		sortTableArray(rows, attribute, ascending);
	} else {
		var directories = rows.filter("[data-directory]");
		var files = rows.filter("[data-file]");

		sortTableArray(directories, (attribute == "filename") ? "directory" : attribute, ascending);
		sortTableArray(files, (attribute == "filename") ? "file" : attribute, ascending);

		rows = [];
		$.each(directories, function() { rows.push(this); });
		$.each(files, function() { rows.push(this); });
	}

	var body = table.children("tbody");
	$.each(rows, function() {
		$(this).appendTo(body);
	});
}

function sortTableArray(array, attribute, ascending) {
	array.sort(function(a, b) {
		var aVal = $(a).data(attribute), bVal = $(b).data(attribute);
		if (aVal == undefined && bVal == undefined) {
			return 0;
		}
		if (aVal == undefined && bVal != undefined) {
			return (ascending) ? -1 : 1;
		}
		if (aVal != undefined && bVal == undefined) {
			return (ascending) ? 1 : -1;
		}

		var result = (ascending) ? (aVal - bVal) : (bVal - aVal);
		if (isNaN(result)) {
			aVal = aVal.toString();
			bVal = bVal.toString();
			if (ascending) {
				return aVal.toLowerCase().localeCompare(bVal.toLowerCase());
			}
			return bVal.toLowerCase().localeCompare(aVal.toLowerCase());
		}
		return result;
	});
}


/* Context Menu */

var contextMenuShown = false, contextMenuTargets;

function hideContextMenu() {
	if (contextMenuShown) {
		$("#ul_file_contextmenu").hide();

		contextMenuTargets.closest("tbody").children("tr").removeClass("info");
		contextMenuTargets.closest("tbody").find("input[type='checkbox']:checked").parents("tr").addClass("info");
		contextMenuShown = false;
	}
}

function showContextMenu(target, x, y) {
	// Context menu isn't available on the Scans page (yet)
	if (currentPage == "scanner") {
		return;
	}

	// Hide context menu if it is already shown
	if (contextMenuShown) {
		hideContextMenu();
	}

	// Apply color to selected items
	contextMenuTargets = target;
	if (target.find("input[type='checkbox']").prop("checked")) {
		contextMenuTargets = target.closest("tbody").find("input[type='checkbox']:checked").parents("tr");
	} else {
		target.closest("tbody").children("tr").removeClass("info");
	}
	contextMenuTargets.addClass("info");

	// Decide which actions can be shown
	var contextMenu = $("#ul_file_contextmenu");
	contextMenu.children().removeClass("hidden");
	if (contextMenuTargets.length > 1) { contextMenu.children(".single").addClass("hidden"); }
	if (contextMenuTargets.length < 2) { contextMenu.children(".multi").addClass("hidden"); }
	if (contextMenuTargets.filter("[data-directory], [data-filament]").length > 0) { contextMenu.children(".file").addClass("hidden"); }
	if (contextMenuTargets.filter("[data-file]").length > 0) { contextMenu.children(".directory").addClass("hidden"); }
	if (contextMenuTargets.filter("[data-file$='.csv']").length == 0) { $("#a_context_view_heightmap").closest("li").addClass("hidden"); }
	if (currentPage != "files") { contextMenu.children(".gcode-action").addClass("hidden"); }
	if (currentPage != "macros") { contextMenu.children(".macro-action").addClass("hidden"); }
	if (currentPage != "filaments") { contextMenu.children(".filament-action").addClass("hidden"); }

	// Take care of the divider visibility
	var items = $("#ul_file_contextmenu").children();
	var isPrecededByAction = false;
	for(var i = 0; i < items.length; i++) {
		var item = items.eq(i);
		if (item.hasClass("divider")) {
			item.toggleClass("hidden", !isPrecededByAction);
			isPrecededByAction = false;
		} else {
			isPrecededByAction |= !item.hasClass("hidden");
		}
	}

	// Show it
	contextMenu.css({
		left: getMenuPosition(x, "width", "scrollLeft"),
		top: getMenuPosition(y, "height", "scrollTop")
	}).show();
	contextMenuShown = true;
}

function getMenuPosition(mouse, direction, scrollDir) {
	var win = $(window)[direction](),
		scroll = $(window)[scrollDir](),
		menu = $(settings.menuSelector)[direction](),
		position = mouse + scroll;

	// opening menu would pass the side of the page
	if (mouse + menu > win && menu < mouse) {
		position -= menu;
	}

	return position;
}

$("body").click(hideContextMenu).contextmenu(hideContextMenu);


/* Context Menu Actions */

$("#a_context_start").click(function(e) {
	var file = contextMenuTargets.data("file");
	waitingForJobStart = true;
	if (currentGCodeVolume != 0) {
		sendGCode('M32 "' + currentGCodeDirectory + "/" + file + '"');
	} else if (currentGCodeDirectory == "0:/gcodes") {
		sendGCode('M32 "' + file + '"');
	} else {
		sendGCode('M32 "' + currentGCodeDirectory.substring(10) + "/" + file + '"');
	}
	e.preventDefault();
});

$("#a_context_simulate").click(function(e) {
	var file = contextMenuTargets.data("file");
	waitingForJobStart = true;
	if (currentGCodeVolume != 0) {
		sendGCode('M37 P"' + currentGCodeDirectory + "/" + file + '"');
	} else if (currentGCodeDirectory == "0:/gcodes") {
		sendGCode('M37 P"' + file + '"');
	} else {
		sendGCode('M37 P"' + currentGCodeDirectory.substring(10) + "/" + file + '"');
	}
	e.preventDefault();
});

$("#a_context_run").click(function(e) {
	var file = contextMenuTargets.data("file");
	sendGCode('M98 P"' + currentMacroDirectory + "/" + file + '"');
	e.preventDefault();
});

$("#a_context_edit_load").click(function(e) {
	var filament = contextMenuTargets.data("filament");
	editFile("0:/filaments/" + filament + "/load.g", false);
	e.preventDefault();
});

$("#a_context_edit_config").click(function(e) {
	var filament = contextMenuTargets.data("filament");
	editFile("0:/filaments/" + filament + "/config.g", false);
	e.preventDefault();
});

$("#a_context_edit_unload").click(function(e) {
	var filament = contextMenuTargets.data("filament");
	editFile("0:/filaments/" + filament + "/unload.g", false);
	e.preventDefault();
});

$("#a_context_view_heightmap").click(function(e) {
	getHeightmap(getFilePath() + "/" + contextMenuTargets.data("file"));
	e.preventDefault();
});

$("#a_context_download_file").click(function(e) {
	var filename = contextMenuTargets.data("file");
	var filepath = getFilePath() + "/" + filename;

	// Should use a button link instead, but for some reason it isn't properly displayed with latest Bootstrap 3.3.7
	var elem = $('<a target="_blank" href="' + ajaxPrefix + 'rr_download?name=' + encodeURIComponent(filepath) + '" download="' + filename + '"></a>');
	elem.appendTo("body");
	elem[0].click();
	elem.remove();

	e.preventDefault();
});

$("#a_context_download_zip").click(function(e) {
	if (doingFileTask) {
		showMessage("warning", T("Download as ZIP"), T("Please wait until the pending operations have finished before you download more files"));
	} else {
		downloadNotification = showDownloadMessage();
		zipFile = new JSZip();

		var fileIndex = 1;
		$.each(contextMenuTargets, function() {
			var row = $(this);
			multiFileOperations.push({
				action: "download_zip",
				filename: row.data("file"),
				path: getFilePath() + "/" + row.data("file"),
				progress: fileIndex / contextMenuTargets.length * 100
			});
			fileIndex++;
		});
		doFileTask();
	}
	e.preventDefault();
});

$("#a_context_edit").click(function(e) {
	var file = getFilePath() + "/" + contextMenuTargets.data("file");
	editFile(file, true, contextMenuTargets.data("size"), function(newSize) {
		contextMenuTargets.data("size", newSize).find(".size").text(formatSize(newSize));
		sortTable(contextMenuTargets.closest("table"));

		if (currentPage == "files" && cachedFileInfo.hasOwnProperty(file)) {
			cachedFileInfo[file].size = newSize;
			saveFileCache();
		}
	});
	e.preventDefault();
});

$("#a_context_rename").click(function(e) {
	var oldFileName = contextMenuTargets.data("file");
	if (oldFileName == undefined) {
		oldFileName = contextMenuTargets.data("directory");
	}
	if (oldFileName == undefined) {
		oldFileName = contextMenuTargets.data("filament");
	}

	showTextInput(T("Rename File or Directory"), T("Please enter a new name:"), function(newFileName) {
		// Try to move that file
		var filePath = getFilePath();
		$.ajax(ajaxPrefix + "rr_move?old=" + encodeURIComponent(filePath + "/" + oldFileName) + "&new=" + encodeURIComponent(filePath + "/" + newFileName) + "&deleteexisting=no", {
			dataType: "json",
			success: function(response) {
				if (response.err == 0) {
					if (currentPage == "scans") {
						updateScanFiles();
					} else if (currentPage == "files") {
						clearFileCache(filePath + "/" + oldFileName);

						gcodeUpdateIndex = -1;
						updateGCodeFiles();
					} else if (currentPage == "macros") {
						updateMacroFiles();
					} else if (currentPage == "filaments") {
						updateFilaments();
					} else {
						updateSysFiles();
					}
				}
				// else an error is reported via rr_reply
			}
		});
	}, oldFileName);
	e.preventDefault();
});

$("#a_context_delete").click(function(e) {
	if (contextMenuTargets.length == 1) {
		var file = contextMenuTargets.data("file");
		if (file != undefined) {
			// Delete single file
			showConfirmationDialog(T("Delete File"), T("Are you sure you want to delete <strong>{0}</strong>?", file), function() {
				deletePath(file, contextMenuTargets);
			});
		} else {
			// Delete single directory
			var directory = contextMenuTargets.data("directory");
			if (directory != undefined) {
				deletePath(directory, contextMenuTargets);
			} else {
				// Delete single filament
				var filament = contextMenuTargets.data("filament");
				showConfirmationDialog(T("Delete Filament"), T("Are you sure you want to delete <strong>{0}</strong>?", filament), function() {
					deleteFilament(filament, contextMenuTargets);
				});
			}
		}
	} else {
		// Delete multiple items
		showConfirmationDialog(T("Delete multiple Items"), T("Are you sure you want to delete the selected items?"), function() {
			$.each(contextMenuTargets, function() {
				var row = $(this);

				var file = row.data("file");
				if (file != undefined) {
					deletePath(file, row);
				} else {
					var directory = row.data("directory");
					if (directory != undefined) {
						deletePath(directory, row);
					} else {
						var filament = row.data("filament");
						deleteFilament(filament, row);
					}
				}
			});
		});
	}
	e.preventDefault();
});


/* Common functions */

function deleteFilament(filament, elementToRemove) {
	multiFileOperations.push({
		action: "delete",
		elementToRemove: elementToRemove,
		filament: filament,
		type: "filament"
	});
	doFileTask();
}

function deletePath(filename, elementToRemove, type) {
	multiFileOperations.push({
		action: "delete",
		elementToRemove: elementToRemove,
		path: getFilePath() + "/" + filename,
		type: type
	});
	doFileTask();
}

function doFileTask() {
	if (doingFileTask || !isConnected) {
		return;
	}

	doingFileTask = (multiFileOperations.length > 0);
	if (doingFileTask) {
		var task = multiFileOperations.shift();
		if (task.action == "delete") {
			if (task.type == "filament") {
				$.ajax(ajaxPrefix + "rr_filelist?dir=" + encodeURIComponent("0:/filaments/" + task.filament), {
					dataType: "json",
					success: function(response) {
						if (isConnected) {
							if (response.hasOwnProperty("err")) {
								showMessage("warning", T("Warning"), T("Could not delete filament {0}", task.filament));
							} else {
								for(var i = 0; i < response.files.length; i++) {
									$.ajax(ajaxPrefix + "rr_delete?name=" + encodeURIComponent("0:/filaments/" + task.filament + "/" + response.files[i].name));
								}

								$.ajax(ajaxPrefix + "rr_delete?name=" + encodeURIComponent("0:/filaments/" + task.filament), {
									dataType: "json",
									success: function(response) {
										if (response.err == 0) {
											task.elementToRemove.remove();
											updateFilesConditionally();
										}
									}
								});
							}
						}
					}
				});
			} else {
				$.ajax(ajaxPrefix + "rr_delete?name=" + encodeURIComponent(task.path), {
					dataType: "json",
					success: function(response) {
						if (response.err == 0) {
							task.elementToRemove.remove()
							updateFilesConditionally();
						} else if (task.type == "file") {
							showMessage("warning", T("Deletion failed"), T("<strong>Warning:</strong> Could not delete file <strong>{0}</strong>!", file));
						} else if (task.type == "directory") {
							showMessage("warning", T("Deletion failed"), T("<strong>Warning:</strong> Could not delete directory <strong>{0}</strong>!<br/><br/>Perhaps it isn't empty?", directory));
						} else {

						}

						doingFileTask = false;
						doFileTask();
					}
				});
			}
		} else if (task.action == "move") {
			if (task.from == undefined || task.from.toUpperCase() == task.to.toUpperCase()) {
				// No need to rename the file or directory
				if (task.onSuccess != undefined) {
					task.onSuccess();
				}

				doingFileTask = false;
				doFileTask();
			} else {
				// File names are different, so attempt to move the old path to the new one
				$.ajax(ajaxPrefix + "rr_move?old=" + encodeURIComponent(task.from) + "&new=" + encodeURIComponent(task.to) + "&deleteexisting=yes", {
					dataType: "json",
					success: function(response) {
						if (response.err == 0) {
							// If that succeeds, return to the callback
							if (task.onSuccess != undefined) {
								task.onSuccess();
							}

							// Check if we need to remove an element
							if (task.elementToRemove != undefined) {
								task.elementToRemove.remove();
								updateFilesConditionally();
							}
						} else if (task.onError != undefined) {
							// Didn't work? Should never happen
							task.onError();
						}

						doingFileTask = false;
						doFileTask();
					}
				});
			}
		} else if (task.action == "download_zip") {
			// JQuery cannot retrieve binary data, use plain JS instead
			var xhr = new XMLHttpRequest();
			xhr.onreadystatechange = function() {
				if (isConnected && zipFile != undefined) {
					if (this.readyState == 4) {
						if (this.status == 200) {
							// Add incoming file blob
							zipFile.file(task.filename, this.response);
							downloadNotification.update("progress", task.progress);

							// See if we're done
							if (multiFileOperations.length == 0 || multiFileOperations[0].action != "download_zip") {
								if (JSZip.support.blob) {
									// Download as blob
									zipFile.generateAsync({ type: "blob" }).then(function (blob) {
										downloadNotification.close();
										downloadNotification = undefined;
										zipFile = undefined;

										saveAs(blob, "download.zip");
									});
								} else {
									// Download via data URI
									zipFile.generateAsync({ type: "base64" }).then(function (base64) {
										downloadNotification.close();
										downloadNotification = undefined;
										zipFile = undefined;

										window.location = "data:application/zip;base64," + base64;
									});
								}
							}
						}

						doingFileTask = false;
						doFileTask();
					}
				}
			}
			xhr.open('GET', ajaxPrefix + "rr_download?name=" + encodeURIComponent(task.path));
			xhr.responseType = 'arraybuffer';
			xhr.send();
		}
	}
}

var editFileNotification = undefined;
function editFile(file, editingFile, size, editCallback) {
	if (size != undefined && size > 1000000) {
		editFileNotification = showMessage("info", T("Downloading File"), T("This file is quite big. It may take a while before it is fully loaded..."), 0);
	}
	if (editingFile == undefined) { editingFile = true; }

	$.ajax(ajaxPrefix + "rr_download?name=" + encodeURIComponent(file), {
		dataType: "text",
		global: editingFile,
		error: editingFile ? undefined : function(jqXHR, textStatus, errorThrown) {
			if (editFileNotification != undefined) {
				editFileNotification.close();
				editFileNotification = undefined;
			}

			showEditDialog(file, "", function(value) {
				uploadTextFile(file, value, function() {
					if (editingFile) {
						if (editCallback != undefined) {
							editCallback(new Blob([value]).size);
						}
					} else {
						if (currentPage == "files") {
							updateGCodeFiles();
						} else if (currentPage == "macros") {
							updateMacroFiles();
						} else if (currentPage == "settings") {
							if ($("#page_sysedit").hasClass("active")) {
								updateSysFiles();
							} else {
								updateDisplayFiles();
							}
						}
					}
				});
			});
		},
		success: function(response) {
			if (editFileNotification != undefined) {
				editFileNotification.close();
				editFileNotification = undefined;
			}

			showEditDialog(file, response, function(value) {
				uploadTextFile(file, value, function() {
					if (editingFile) {
						if (editCallback != undefined) {
							editCallback(new Blob([value]).size);
						}
					} else {
						if (currentPage == "files") {
							updateGCodeFiles();
						} else if (currentPage == "macros") {
							updateMacroFiles();
						} else if (currentPage == "settings") {
							if ($("#page_sysedit").hasClass("active")) {
								updateSysFiles();
							} else {
								updateDisplayFiles();
							}
						}
					}
				});
			});
		},
		timeout: 0
	});
}

function filenameValid(name) {
	if (name.indexOf('"') != -1 || name.indexOf("'") != -1) {
		// Don't allow quotes in filenames
		return false;
	}

	if (name.indexOf("/") != -1 || name.indexOf("\"") != -1) {
		// Don't allow (back)slashes either
		return false;
	}

	if (name.indexOf(":") != -1) {
		// Colons should be avoided too
		return false;
	}

	return true;
}

function getFilePath() {
	if (currentPage == "scanner") {
		return "0:/scans";
	}

	if (currentPage == "files") {
		return currentGCodeDirectory;
	}

	if (currentPage == "macros") {
		return currentMacroDirectory;
	}

	if (currentPage == "filaments") {
		return "0:/filaments";
	}

	if ($("#page_sysedit").hasClass("active")) {
		return "0:/sys";
	}

	return "0:/menu";
}

function moveFile(from, to, onSuccess, onError, elementToRemove) {
	multiFileOperations.push({
		action: "move",
		from: from,
		to: to,
		onSuccess: onSuccess,
		onError: onError,
		elementToRemove: elementToRemove
	});
	doFileTask();
}

function resetFiles() {
	setVolumes(1);
	setMountedVolumes(1);
	mountRequested = false;

	//updateScanFiles();

	knownGCodeFiles = [];
	gcodeUpdateIndex = -1;
	currentGCodeVolume = 0;
	currentGCodeDirectory = "0:/gcodes";
	//updateGCodeFiles();

	currentMacroDirectory = "0:/macros";
	//updateMacroFiles();

	//updateFilaments();

	//updateSysFiles();
	//updateDisplayFiles();

	multiFileOperations = [];
	doingFileTask = false;

	downloadNotification = undefined;
	targetZipName = undefined;
	zipFile = undefined;
}

function updateFilesConditionally() {
	if (currentPage == "scanner") {
		if ($("#table_scan_files > tbody").children().length == 0) {
			updateScanFiles();
		}
	} else if (currentPage == "files") {
		if ($("#table_gcode_files > tbody").children().length == 0) {
			gcodeUpdateIndex = -1;
			updateGCodeFiles();
		}
	} else if (currentPage == "macros") {
		// Reload macros when no bulk operations are pending so that deleted files get updated on the main page
		if ($("#table_macro_files > tbody").children().length == 0 || multiFileOperations.length == 0) {
			updateMacroFiles();
		}
	} else if (currentPage == "settings") {
		if ($("#page_sysedit").hasClass("active")) {
			if ($("#table_sys_files > tbody").children().length == 0) {
				updateSysFiles();
			}
		} else {
			if ($("#table_display_files > tbody").children().length == 0) {
				updateDisplayFiles();
			}
		}
	}
}
/* Internationalization routines for Duet Web Control
 * 
 * written by Christian Hammacher (c) 2016-2017
 * 
 * licensed under the terms of the GPL v3
 * see http://www.gnu.org/licenses/gpl-3.0.html
 */


var showTranslationWarning = false;		// Set this to "true" if you want to look for missing translation entries

var translationData = undefined;


// Called to look up English strings and to translate them into the configured language.
// Variable arguments may be passed like T("Hello {0}, are you doing {1}?", "user", "well")
function T(text) {
	var entry = text;
	if (translationData != undefined) {
		// Generate a regex to check with
		text = text.replace(/{(\d+)}/g, "{\\d+}").replace("(", "\\(").replace(")", "\\)");
		text = text.replace("?", "[?]").replace(".", "[.]");
		var regex = new RegExp("^" + text + "$");

		// Get the translation node and see if we can find an entry
		var root = translationData.getElementsByTagName(settings.language).item(settings.language);
		if (root != null) {
			for(var i = 0; i < root.children.length; i++) {
				if (regex.test(root.children[i].attributes["t"].value)) {
					entry = root.children[i].textContent;
					break;
				}
			}

			// Log translation text if we couldn't find a suitable text
			if (showTranslationWarning && entry == text) {
				console.log("WARNING: Could not translate '" + entry + "'");
			}
		}
	}

	// Format it with the given arguments
	var args = arguments;
	return entry.replace(/{(\d+)}/g, function(match, number) {
		number = parseInt(number) + 1;
		return typeof args[number] != 'undefined' ? args[number] : match;
	});
}

// May be called only once on page load to translate the page
function translatePage() {
	if (translationData != undefined) {
		var root = translationData.getElementsByTagName(settings.language).item(settings.language);
		if (root != null) {
			// Translate HTML attributes
			translateEntries(root, $("p, span, strong, button, li.dropdown-header, select > option"), "textContent");
			translateEntries(root, $("th, td, dt"), "textContent");
			translateEntries(root, $("h1, h4, label, a, #div_content ol > li:first-child"), "textContent");
			translateEntries(root, $("#ol_gcode_directory > li:last-child, #ol_macro_directory > li:last-child"), "textContent");
			translateEntries(root, $("input[type='text']"), "placeholder");
			translateEntries(root, $("a, abbr, button, label, li, #chart_temp, input, td"), "title");
			translateEntries(root, $("img"), "alt");

			// This doesn't work with data attributes though
			$("button[data-content]").each(function() {
				$(this).attr("data-content", T($(this).attr("data-content")));
			});

			// Update SD Card button caption
			$("#btn_volume > span.content").text(T("SD Card {0}", currentGCodeVolume));

			// Set new language on Settings page
			$("#btn_language").data("language", settings.language).children("span:first-child").text(root.attributes["name"].value);
			$("html").attr("lang", settings.language);
		}
	}
}

function translateEntries(root, entries, key) {
	var doNodeCheck = (key == "textContent");
	$.each(entries, function() {
		// If this node has no children, we can safely use it
		if (!doNodeCheck || this.childNodes.length < 2) {
			translateEntry(root, this, key);
			// Otherwise we need to check for non-empty text nodes
		} else {
			for(var i = 0; i < this.childNodes.length; i++) {
				var val = this.childNodes[i][key];
				if (this.childNodes[i].nodeType == 3 && val != undefined && this.childNodes[i].childNodes.length == 0 && val.trim().length > 0) {
					translateEntry(root, this.childNodes[i], key);
				}
			}
		}
	});
}

function translateEntry(root, item, key) {
	if (item != undefined) {
		var originalText = item[key];
		if (originalText != undefined && originalText.trim() != "") {
			var text = originalText.trim();
			for(var i=0; i<root.children.length; i++) {
				var entry = root.children[i].attributes["t"].value;
				if (entry.indexOf("{") == -1 && entry == text) {
					item[key] = item[key].replace(text, root.children[i].textContent);
					return;
				}
			}

			// Log translation text if we couldn't find a suitable text
			if (showTranslationWarning) {
				console.log("WARNING: Could not translate static '" + text + "'");
			}
		}
	}
}
/* Main interface logic for Duet Web Control
 * 
 * written by Christian Hammacher (c) 2016-2018
 * 
 * licensed under the terms of the GPL v3
 * see http://www.gnu.org/licenses/gpl-3.0.html
 */

var machineName = "Duet Web Control";
var boardType = "unknown", allowCombinedFirmware = false;

var maxAxes = 9, maxExtruders = 9, maxDrives = 12, axisOrder = "XYZUVWABC";
var maxHeaters = 8, maxTempSensors = 10, maxFans = 9;
var probeSlowDownColor = "#FFFFE0", probeTriggerColor = "#FFF0F0";

var webcamUpdating = false, calibrationWebcamUpdating = false;

var fileInfo, currentLayerTime, lastLayerPrintDuration;
var isProcessing, isPaused, jobHasFinished, waitingForJobStart;

var geometry, probeSlowDownValue, probeTriggerValue;
var axisNames, numAxes, numExtruderDrives, numVolumes;
var heaterNames, bedHeater = 0, chamberHeater = -1, cabinetHeater = -1, numTempSensors;
var fanNames, controllableFans;
var coldExtrudeTemp, coldRetractTemp, tempLimit;

var toolMapping = undefined;
var spindleTools, spindleCurrents, spindleActives;

var currentPage = "control";


function resetGuiData() {
	setBoardType("unknown");
	setPauseStatus(false);
	setJobStatus(false);
	setGeometry("cartesian");

	justConnected = isUploading = updateTaskLive = false;
	resetConfirmationShown = false;
	stopUpdating = true;
	fileInfo = lastStatusResponse = configResponse = configFile = undefined;

	lastSentGCode = "";
	lastGCodeFromInput = false;

	probeSlowDownValue = probeTriggerValue = undefined;

	heaterNames = undefined;
	bedHeater = 0;
	chamberHeater = cabinetHeater = -1;
	numTempSensors = 0;

	axisNames = ["X", "Y", "Z", "U", "V", "W", "A", "B", "C"];
	numAxes = 3;			// only 3 are visible on load
	numExtruderDrives = 2;	// only 2 are visible on load

	fanNames = undefined;
	controllableFans = 0;

	coldExtrudeTemp = 160;
	coldRetractTemp = 90;
	tempLimit = 280;

	spindleTools = [];
	spindleCurrents = [];
	spindleActives = [];

	resetChartData();
	lastLayerPrintDuration = 0;

	setToolMapping([]);

	resetFiles();

	waitingForJobStart = false;
}

$(document).ready(function() {
	$('[data-min]').each(function() { $(this).attr("min", $(this).data("min")).attr("step", "any"); });
	$('[data-max]').each(function() { $(this).attr("max", $(this).data("max")).attr("step", "any"); });
	$('[data-toggle="popover"]').popover();
	$(".app-control").toggleClass("hidden", typeof app === "undefined");

	disableControls();
	resetGuiData();
	updateGui();

	loadSettings();
	loadFileCache();
	loadTableSorting();
	loadFanVisibility();
	loadGCodes();

	// NB: Recreating the typeahead instances is buggy. Do NOT attempt to do this!
	$(".gcode-input input").typeahead({
		autoSelect: false,
		fitToElement: true,
		source: function(arg, cb) { cb(rememberedGCodes); }
	});
});

function pageLoadComplete() {
	// Add link to GitHub, replace dash in Z-probe and log event
	$("#span_copyright").html($("#span_copyright").html().replace("Christian Hammacher", '<a href="https://github.com/chrishamm/DuetWebControl" target="_blank">Christian Hammacher</a>'));
	$("#th_probe").html(T("Z-Probe").replace("-", "-&#8203;"));
	log("info", "<strong>" + T("Page Load complete!") + "</strong>");

	// Try to connect once the page has been loaded provided this is not running on localhost
	connect(sessionPassword, true);

	// Check if this browser is supported and display a message if it is not
	var userAgent = navigator.userAgent.toLowerCase();
	var browserSupported = true;
	browserSupported &= (String.prototype.startsWith != undefined);
	browserSupported &= (userAgent.indexOf("webkit") != -1 || userAgent.indexOf("gecko") != -1);
	if (!browserSupported) {
		showMessage("warning", T("Unsupported browser"), "<strong>" + T("Warning") + ":</strong> " + T("Your browser is not officially supported. To achieve the best experience it is recommended to use either Mozilla Firefox, Google Chrome or Opera."), 0, true);
	}

	// Make sure the loaded JS matches the HTML version
	if (typeof dwcVersion != "undefined" && dwcVersion != $("#dwc_version").text()) {
		showMessage("warning", T("Version mismatch"), "<strong>" + T("Warning") + ":</strong> " + T("The versions of your HTML and JavaScript files do not match. This can lead to unpredictable behavior and other problems. Please install Duet Web Control once more and clear your browser cache."), 0, false);
	}
}

function updateGui() {
	// Visibility of the Extra temperatures panel
	if (numTempSensors == 0) {
		if (!$("#div_extra").hasClass("hidden")) {
			$("#div_extra").addClass("hidden");
			$("#div_tools").removeClass("hidden");
		}
	} else {
		$(".extra-temps").removeClass("hidden");
		for(var i = 0; i < maxTempSensors; i++) {
			$("#table_extra tr").eq(i + 1).toggleClass("hidden", i >= numTempSensors);
		}
	}

	// Tool entries in the Tools list
	$("#table_tools > tbody > tr[data-tool]").remove();
	if (isConnected) {
		var generatedHTML = "", toolIndex = 0;
		toolMapping.forEach(function(tool) {
			var toolName = tool.name;
			if (toolName == "") {
				toolName = T("Tool {0}", tool.number);
			}

			if (tool.heaters.length == 0) {
				var row = '<tr data-tool="' + tool.number + '">';
				row +=		'<th><a href="#"><span>' + toolName + '</span>';
				if (tool.hasOwnProperty("filament")) {
					row +=		'<span class="caret"></span>';
					if (tool.filament != "") {
						row +=	'</a><span class="text-muted">T' + tool.number + ' - ' + tool.filament + '</span>';
					} else {
						row +=	'</a><span class="text-muted">T' + tool.number + '</span>';
					}
				} else {
					row +=		'</a><span class="text-muted">T' + tool.number + '</span>';
				}
				row +=		'</th>';

				var spindleIndex = -1;
				for(var i = 0; i < spindleTools.length; i++) {
					if (spindleTools[i] == tool.number) {
						spindleIndex = i;
						break;
					}
				}

				if (spindleIndex >= 0) {
					row +=	'<td></td>';
					row +=	'<td><span class="spindle-current">' + T("{0} RPM", spindleCurrents[spindleIndex]) + '</span></td>';
					row +=	'<td class="input-td"><div class="input-group input-group-sm">';
					row +=		'<input type="number" class="form-control spindle-active" value="' + spindleActives[spindleIndex] + '">';
					row +=		'<span class="input-group-addon">RPM</span>';
					row +=	'</div></td>';
					row +=	'<td></td>';
				} else {
					row +=	'<td colspan="4"></td>';
				}
				row +=	'</tr>';
				generatedHTML += row;
			} else {
				var heaterIndex = 0;
				tool.heaters.forEach(function(heater) {
					var heaterName = (heaterNames == undefined || heaterNames[heater] == "") ? T("Heater {0}", heater) : heaterNames[heater];
					var heaterState, currentTemp, activeTemp, standbyTemp;
					if (lastStatusResponse != undefined) {
						if (lastStatusResponse.temps.hasOwnProperty("current") && lastStatusResponse.temps.hasOwnProperty("state")) {
							heaterState = getHeaterStateText(lastStatusResponse.temps.state[heater]);
							currentTemp = T("{0} Â°C", lastStatusResponse.temps.current[heater].toFixed(1));
						} else {
							if (heater == bedHeater && lastStatusResponse.temps.hasOwnProperty("bed")) {
								heaterState = getHeaterStateText(lastStatusResponse.temps.bed.state);
								currentTemp = T("{0} Â°C", lastStatusResponse.temps.bed.current.toFixed(1));
							} else if (heater == chamberHeater && lastStatusResponse.temps.hasOwnProperty("chamber")) {
								heaterState = getHeaterStateText(lastStatusResponse.temps.chamber.state);
								currentTemp = T("{0} Â°C", lastStatusResponse.temps.chamber.current.toFixed(1));
							} else if (heater == cabinetHeater && lastStatusResponse.temps.hasOwnProperty("cabinet")) {
								heaterState = getHeaterStateText(lastStatusResponse.temps.cabinet.state);
								currentTemp = T("{0} Â°C", lastStatusResponse.temps.cabinet.current.toFixed(1));
							} else if (heater < lastStatusResponse.temps.heads.state.length + 1) {
								heaterState = getHeaterStateText(lastStatusResponse.temps.heads.state[heater - 1]);
								currentTemp = T("{0} Â°C", lastStatusResponse.temps.heads.current[heater - 1].toFixed(1));
							} else {
								heaterState = currentTemp = T("n/a");
							}
						}

						if (toolIndex < lastStatusResponse.temps.tools.length) {
							activeTemp = lastStatusResponse.temps.tools.active[toolIndex][heaterIndex];
							standbyTemp = lastStatusResponse.temps.tools.standby[toolIndex][heaterIndex];
						} else {
							activeTemp = standbyTemp = 0;
						}
					} else {
						heaterState = currentTemp = T("n/a");
						activeTemp = standbyTemp = 0;
					}

					var row = '<tr data-tool="' + tool.number + '" data-heater="' + heater + '">';
					row +=		'<th><a href="#"><span>' + toolName + '</span>';
					if (tool.hasOwnProperty("filament")) {
						row +=		'<span class="caret"></span>';
						if (tool.filament != "") {
							row +=	'</a><span class="text-muted">T' + tool.number + ' - ' + tool.filament + '</span>';
						} else {
							row +=	'</a><span class="text-muted">T' + tool.number + '</span>';
						}
					} else {
						row +=		'</a><span class="text-muted">T' + tool.number + '</span>';
					}
					row +=		'</th>';
					row +=		'<th><a href="#" class="heater-' + heater + '">' + heaterName + '</a><span class="text-muted heater-state">' + heaterState + '</span></th>';
					row +=		'<td class="current">' + currentTemp + '</td>';
					row +=		'<td class="input-td"><div class="input-group input-group-sm">';
					row +=			'<input type="number" class="form-control" value="' + activeTemp + '" data-type="active" disabled>';
					row +=			'<div class="input-group-btn div-head-temp hidden-sm">';
					row +=				'<button type="button" class="btn btn-default dropdown-toggle btn-active-temp disabled" data-toggle="dropdown" aria-expanded="false"><span class="caret"></span></button>';
					row +=				'<ul class="dropdown-menu dropdown-menu-right ul-active-temp" role="menu"></ul>';
					row +=			'</div>';
					row +=		'</div></td>';
					row +=		'<td class="input-td"><div class="input-group input-group-sm">';
					row +=			'<input type="number" class="form-control standby-input" value="' + standbyTemp + '" data-type="standby" disabled>';
					row +=			'<div class="input-group-btn div-head-temp hidden-sm">';
					row +=				'<button type="button" class="btn btn-default dropdown-toggle btn-standby-temp disabled" data-toggle="dropdown" aria-expanded="false"><span class="caret"></span></button>';
					row +=				'<ul class="dropdown-menu dropdown-menu-right ul-standby-temp" role="menu"></ul>';
					row +=			'</div>';
					row +=		'</div></td>';
					row +=	'</tr>';
					generatedHTML += row;
					heaterIndex++;
				});
			}
			toolIndex++;
		});

		// Generate DOM element and remove redundant tool captions
		var toolRows = $(generatedHTML);
		var firstToolRow = undefined;
		toolRows.each(function() {
			if (firstToolRow == undefined) {
				firstToolRow = $(this);
			} else {
				if (firstToolRow.data("tool") == $(this).data("tool")) {
					$(this).children().first().remove();

					var firstTh = firstToolRow.children().first();
					firstTh.prop("rowspan", firstTh.prop("rowspan") + 1);
				} else {
					firstToolRow = $(this);
				}
			}
		});
		updateFixedToolTemps(toolRows);
		toolRows.prependTo("#table_tools > tbody");

		// Set current tool again
		if (lastStatusResponse != undefined) {
			setCurrentTool(lastStatusResponse.currentTool);
		}
	} else {
		var toolRows = $(initialTools);
		updateFixedToolTemps(toolRows);
		toolRows.prependTo("#table_tools > tbody");
	}

	// Bed heater
	$("tr[data-heater='bed']").toggleClass("hidden", bedHeater == -1);
	if (bedHeater != -1) {
		var heaterName = (heaterNames == undefined || heaterNames[bedHeater] == "") ? T("Heater {0}", bedHeater) : heaterNames[bedHeater];
		$("#table_tools tr[data-heater='bed'] > th:nth-child(2) > a").text(heaterName);
		$("#table_tools tr[data-heater='bed'] > th:nth-child(2) > a, #table_heaters tr[data-heater='bed'] > th:first-child > a").removeClass().addClass("heater-" + bedHeater);
	}

	// Chamber heater
	$("tr[data-heater='chamber']").toggleClass("hidden", chamberHeater == -1);
	if (chamberHeater != -1) {
		var heaterName = (heaterNames == undefined || heaterNames[chamberHeater] == "") ? T("Heater {0}", chamberHeater) : heaterNames[chamberHeater];
		$("#table_tools tr[data-heater='chamber'] > th:nth-child(2) > a").text(heaterName);
		$("#table_tools tr[data-heater='chamber'] > th:nth-child(2) > a, #table_heaters tr[data-heater='chamber'] > th:first-child > a").removeClass().addClass("heater-" + chamberHeater);
	}

	// Cabinet heater
	$("tr[data-heater='cabinet']").toggleClass("hidden", cabinetHeater == -1);
	if (cabinetHeater != -1) {
		var heaterName = (heaterNames == undefined || heaterNames[cabinetHeater] == "") ? T("Heater {0}", cabinetHeater) : heaterNames[cabinetHeater];
		$("#table_tools tr[data-heater='cabinet'] > th:nth-child(2) > a").text(heaterName);
		$("#table_tools tr[data-heater='cabinet'] > th:nth-child(2) > a, #table_heaters tr[data-heater='cabinet'] > th:first-child > a").removeClass().addClass("heater-" + cabinetHeater);
	}

	// Visibility of heater temperatures (deprecated)
	for(var i = 1; i < maxHeaters; i++) {
		var hideHeater = (i > 2 && !isConnected) || (getToolsByHeater(i).length == 0 && isConnected);
		$("#table_heaters tr[data-heater='" + i + "']").toggleClass("hidden", hideHeater);
	}

	// Update movement steps
	applyMovementSteps();

	// Visibility of axis positions in the Machine Status panel
	for(var i = 0; i < maxAxes; i++) {
		var isHidden = (i >= numAxes); // || (vendor == "diabase" && i < axisNames.length && "UVW".indexOf(axisNames[i]) != -1);

		var cells = $(".table-axis-positions [data-axis='" + i + "']");
		cells.toggleClass("hidden", isHidden);
		cells.css("border-right", (i + 1 < numAxes) ? "1px" : "0px");
	}

	// Visibility of additional axis control buttons
	$("#panel_extra_axes").toggleClass("hidden", numAxes <= 3);

	for(var i = 3; i < maxAxes; i++) {
		var isHidden = (i >= numAxes); // || (vendor == "diabase" && i < axisNames.length && "UVW".indexOf(axisNames[i]) != -1);

		var row = $("#table_move_axes > tbody > tr").eq(i - 3);
		if (isHidden) {
			row.addClass("hidden");
		} else {
			row.removeClass("hidden");
			if (i + 1 == numAxes) {
				row.find("div.btn-group").css("padding-bottom", "0px");
			} else {
				row.find("div.btn-group").removeAttr("style");
			}
		}
		$(".mobile-home-buttons [data-axis='" + i + "']").parent().toggleClass("hidden", isHidden);
	}

	// Update homed axes once more
	if (lastStatusResponse != undefined) {
		setAxesHomed(lastStatusResponse.coords.axesHomed);
	}

	// Fan Names
	for(var fan = 0; fan < maxFans; fan++) {
		var fanName = (fanNames == undefined || fanNames.length <= fan || fanNames[fan] == "") ? T("Fan {0}", fan) : fanNames[fan];
		$("tr[data-fan=" + fan + "] > td:first-child > button").text(fanName);
	}

	// Visibility of extrusion factor sliders
	var numExtrudersToShow = (isConnected && hideLastExtruderDrive) ? Math.max(numExtruderDrives - 1, 0) : numExtruderDrives;
	for(var i = 0; i < maxExtruders; i++) {
		if (i < numExtrudersToShow) {
			$(".extr-" + i).removeClass("hidden");
			$("#slider_extr_" + i).slider("relayout");
		} else {
			$(".extr-" + i).addClass("hidden");
		}
	}

	// Appearance of extruder drive cells + extrusion factor slider panel
	$("#th_extruder_drives, #panel_extrusion_factors").toggleClass("hidden", numExtruderDrives <= 0);
	for(var i = 0; i < maxExtruders; i++) {
		var cells = $("#table_extruder_positions [data-extruder='" + i + "']");
		cells.toggleClass("hidden", i >= numExtrudersToShow);
		cells.css("border-right", (i + 1 < numExtrudersToShow) ? "1px" : "0px");
	}

	// Rearrange extruder drive cells if neccessary. Only show total usage on md desktop if more than three extruders are in use
	if (numExtruderDrives <= 3) {
		$("#table_extruder_positions [data-extruder='total']").addClass("hidden-md");
		for(var i = 0; i < 3; i++) {
			$("#table_extruder_positions th[data-extruder='" + i + "']").removeClass("hidden-md").html(T("Drive {0}", i));
			$("#table_extruder_positions td[data-extruder='" + i + "']").removeClass("hidden-md");
		}
	} else {
		$("#table_extruder_positions [data-extruder='total']").removeClass("hidden-md");
		for(var i = 0; i < maxExtruders; i++) {
			$("#table_extruder_positions th[data-extruder='" + i + "']").addClass("hidden-md").html(T("D{0}", i));
			$("#table_extruder_positions td[data-extruder='" + i + "']").addClass("hidden-md");
		}
	}

	// Do some rearrangement if we have fewer than four extruders and fewer than five axes
	if ((numExtruderDrives <= 3 && numAxes <= 4) || vendor == "diabase") {
		$("#table_heaters .div-head-temp").removeClass("hidden-sm");
		$("#control_all_tools, #control_all_heaters").removeClass("hidden-sm");
		$("#div_tools_heaters").removeClass("col-sm-5").addClass("col-sm-6");
		$("#div_temp_chart").removeClass("col-lg-3").addClass("col-lg-5");
		$("#div_status").removeClass("col-sm-7 col-lg-5").addClass("col-sm-6 col-lg-3");
	} else {
		$("#table_heaters .div-head-temp").addClass("hidden-sm");
		$("#control_all_tools, #control_all_heaters").addClass("hidden-sm");
		$("#div_tools_heaters").removeClass("col-sm-6").addClass("col-sm-5");
		$("#div_temp_chart").removeClass("col-lg-5").addClass("col-lg-3");
		$("#div_status").removeClass("col-sm-6 col-lg-3").addClass("col-sm-7 col-lg-5");
	}

	// Charts
	resizeCharts();
	drawTemperatureChart();
	drawPrintChart();

	// Tool list on Calibration page (OEM)
	if (vendor == "diabase") {
		$("#table_calibration_tools > tbody").children().remove();
		for(var i = 0 ; i < toolMapping.length; i++) {
			var tool = toolMapping[i];
			if (!tool.hasOwnProperty("offsets")) {
				tool.offsets = [ 0.0, 0.0, 0.0 ];
			}

			var row = '<tr data-tool="' + tool.number + '">';
			row += '<td>' + ((tool.name == "") ? T("Tool {0}", tool.number) : tool.name) + '</td><td>';
			row += '<button class="btn btn-default tool-offset-up" data-axis="X"><span class="glyphicon glyphicon-arrow-left"></span> Left</button>';
			row += '<span>' + T("{0} mm", tool.offsets[0].toFixed(2)) + '</span>';
			row += '<button class="btn btn-default tool-offset-down" data-axis="X"><span class="glyphicon glyphicon-arrow-right"></span> Right</button>';
			row += '</td><td>';
			row += '<button class="btn btn-default tool-offset-up" data-axis="Y"><span class="glyphicon glyphicon-arrow-down"></span> Front</button>';
			row += '<span>' + T("{0} mm", tool.offsets[1].toFixed(2)) + '</span>';
			row += '<button class="btn btn-default tool-offset-down" data-axis="Y"><span class="glyphicon glyphicon-arrow-up"></span> Back</button>';
			row += '</td><td>';
			row += '<button class="btn btn-default tool-offset-up" data-axis="Z"><span class="glyphicon glyphicon-arrow-up"></span> Up</button>';
			if (i == 0) {
				row += '<span id="span_probe_height">' + T("{0} mm", zTriggerHeight.toFixed(2)) + '</span>';
			} else {
				row += '<span>' + T("{0} mm", tool.offsets[2].toFixed(2)) + '</span>';
			}
			row += '<button class="btn btn-default tool-offset-down" data-axis="Z"><span class="glyphicon glyphicon-arrow-down"></span> Down</button>';
			row += '</td><td>';
			row += '<button class="btn btn-success tool-calibrate"><span class="glyphicon glyphicon-screenshot"></span> ' + T("Calibrate") + '</button>';
			row += '</td><td>';
			row += '<button class="btn btn-info tool-set-offset"><span class="glyphicon glyphicon-ok"></span> ' + T("Set Offset") + '</button>';
			row += '</td></tr>';

			var rowElem = $("#table_calibration_tools > tbody").append(row);
			if (i == 0) {
				rowElem.find('button[data-axis="X"]').addClass("disabled");
				rowElem.find('button[data-axis="Y"]').addClass("disabled");
				rowElem.find('button.tool-calibrate').addClass("disabled");
			}
		}
	}

	// Tool list on Settings page
	$("#page_tools").children(":not(:first-child)").remove();
	for(var i = 0; i < toolMapping.length; i++) {
		if (toolMapping[i].name != "") {
			title = toolMapping[i].name + " (T" + toolMapping[i].number + ")";
		} else {
			title = T("Tool {0}", toolMapping[i].number);
		}

		var heaters;
		if (toolMapping[i].heaters.length == 0) {
			heaters = T("none");
		} else {
			heaters = toolMapping[i].heaters.reduce(function(a, b) { return a + ", " + b; });
		}

		var drives;
		if (toolMapping[i].drives.length == 0) {
			drives = T("none");
		} else {
			drives = toolMapping[i].drives.reduce(function(a, b) { return a + ", " + b; });
		}

		var div =	'<div class="col-xs-6 col-sm-6 col-md-3 col-lg-3"><div class="panel panel-default">';
		div +=		'<div class="panel-heading"><span>' + title + '</span></div>';
		div +=		'<div data-tool="' + toolMapping[i].number + '" class="panel-body"><dl>';
		if (toolMapping[i].hasOwnProperty("filament")) {
			var filament = (toolMapping[i].filament == "") ? T("none") : toolMapping[i].filament;
			div +=	'<dt>' + T("Filament:") + '</dt><dd class="filament">' + filament + '</dd>';
		}
		div +=		'<dt>' + T("Heaters:") + '</dt><dd>' + heaters + '</dd>';
		div +=		'<dt>' + T("Drives:") + '</dt><dd>' + drives + '</dd>';
		div +=		'</dl><div class="row"><div class="col-md-12 text-center">';
		if (lastStatusResponse != undefined && lastStatusResponse.currentTool == toolMapping[i].number) {
			div +=		'<button class="btn btn-success btn-select-tool" title="' + T("Deselect this tool") + '">';
			div +=		'<span class="glyphicon glyphicon-remove"></span> <span>' + T("Deselect") + '</span></button>';
		} else {
			div +=		'<button class="btn btn-success btn-select-tool" title="' + T("Select this tool") + '">';
			div +=		'<span class="glyphicon glyphicon-pencil"></span> <span>' + T("Select") + '</span></button>';
		}
		div +=		' <button class="btn btn-danger btn-remove-tool" title="' + T("Remove this tool") + '">';
		div +=		'<span class="glyphicon glyphicon-trash"></span> ' + T("Remove") + '</button>';
		div +=		'</div></div></div></div></div>';
		$("#page_tools").append(div);
	}
	validateAddTool();
}

function resetGui() {
	// Navbar
	setMachineName("Duet Web Control");
	setStatusLabel("Disconnected", "default");

	// Heater Temperatures
	$("#div_tools_heaters span.heater-state").text("");
	setCurrentTemperature("bed",  undefined);
	setTemperatureInput("bed", 0, true, false);
	setCurrentTemperature("chamber",  undefined);
	setTemperatureInput("chamber", 0, true, false);
	setCurrentTemperature("cabinet",  undefined);
	setTemperatureInput("cabinet", 0, true, false);
	for(var i = 1; i < maxHeaters; i++) {
		setCurrentTemperature(i, undefined);
		setTemperatureInput(i, 0, true, false);
		setTemperatureInput(i, 0, false, false);
	}

	// Status fields
	$("#span_mode").addClass("hidden");
	$("td[data-axis], td[data-extruder], .table-status td").text(T("n/a"));
	setProbeValue(-1, undefined);

	// Control page
	clearBedPoints();
	setAxesHomed([1, 1, 1]);
	setATXPower(false);
	$('#slider_fan_control_tool').slider("setValue", 35);
	$(".compensation").addClass("hidden");

	// Hide Scanner and Calibration pages
	$(".scan-control").addClass("hidden");
	$("#div_content").resize();
	if (currentPage == "scanner" || currentPage == "calibration") {
		showPage("control");
	}

	// Job Status
	$(".row-progress").addClass("hidden");
	setProgress(100, "", "");
	$("#div_process_another").addClass("hidden");
	$("#override_fan, #auto_sleep").prop("checked", false);
	$("#span_babystepping, #page_job dd, #panel_job_info table td, #table_estimations td").html(T("n/a"));

	// Fan Sliders
	for(var i = 0; i < maxFans; i++) {
		setFanVisibility(i, controllableFans & (1 << i));
	}
	$('#slider_fan_job_tool').slider("setValue", 35);
	
	$('#slider_speed').slider("setValue", 100);
	for(var extr = 1; extr <= maxExtruders; extr++) {
		$("#slider_extr_" + extr).slider("setValue", 100);
	}

	// G-Code Console is not cleared automatically

	// G-Code Files
	updateGCodeFiles();

	// Macro Files
	updateMacroFiles();

	// Filaments
	updateFilaments();

	// Settings
	$("#tr_firmware_electronics").addClass("hidden");
	$("#firmware_name, #firmware_electronics, #firmware_version, #dws_version").html(T("n/a"));
	$("#table_drives > tbody > tr > td:not(:first-child), #page_machine dd").html(T("n/a"));
	$("#table_drives > tbody > tr").removeClass("hidden");

	updateSysFiles();
	updateDisplayFiles();

	// Modal dialogs
	closeMessageBox();
	$(".modal").modal("hide");

	// Upload prompt
	$("#input_file_upload").val("");
}

function updateWebcam(externalTrigger) {
	if (externalTrigger && webcamUpdating) {
		// When the settings are applied, make sure this only runs once
		return;
	}

	if (settings.webcamURL == "") {
		webcamUpdating = false;
	} else if (settings.webcamEmbedded) {
		webcamUpdating = false;
		$("#ifm_webcam").attr("src", settings.webcamURL);
	} else if (settings.webcamInterval == 0) {
		webcamUpdating = false;
		$("#img_webcam").attr("src", settings.webcamURL);
	} else {
		var newURL = settings.webcamURL;
		if (settings.webcamFix) {
			newURL += "_" + Math.random();
		} else {
			if (newURL.indexOf("?") == -1) {
				newURL += "?dummy=" + Math.random();
			} else {
				newURL += "&dummy=" + Math.random();
			}
		}
		$("#img_webcam").attr("src", newURL);

		webcamUpdating = true;
		setTimeout(function() {
			updateWebcam(false);
		}, settings.webcamInterval);
	}
}

function updateCalibrationWebcam(externalTrigger, id) {
	if ((externalTrigger && calibrationWebcamUpdating) || calibrationWebcamSource == "") {
		return;
	}

	if (calibrationWebcamSource == "") {
		calibrationWebcamUpdating = false;
		$("#div_calibration_webcam").addClass("hidden");
	} else {
		$("#div_webcam_calibration").removeClass("hidden");
		$("#img_webcam_calibration").toggleClass("hidden", calibrationWebcamEmbedded);
		$("#div_ifm_webcam_calibration").toggleClass("hidden", !calibrationWebcamEmbedded);

		if (calibrationWebcamEmbedded) {
			$("#ifm_webcam_calibration").attr("src", calibrationWebcamSource);
		} else {
			var newURL = (id == undefined) ? calibrationWebcamSource : calibrationWebcamSource.replace(".", id + ".");
			if (settings.webcamInterval > 0) {
				if (settings.webcamFix) {
					newURL += "_" + Math.random();
				} else {
					if (newURL.indexOf("?") == -1) {
						newURL += "?dummy=" + Math.random();
					} else {
						newURL += "&dummy=" + Math.random();
					}
				}

				calibrationWebcamUpdating = true;
				setTimeout(function() {
					updateCalibrationWebcam(false);
				}, settings.webcamInterval);
			}
			$("#img_webcam_calibration").attr("src", newURL);
		}
	}
}

/* Dynamic GUI Events */

$("body").on("focus", "input[type='number']", function() {
	var input = $(this);
	setTimeout(function() {
		input.select();
	}, 10);
});

$("#div_tools_heaters").on("click", ".bed-temp", function(e) {
	var heater = $(this).closest("tr").data("heater");
	if (heater == "bed") {
		sendGCode("M140 S" + $(this).data("temp"));		// Set bed temperature
	} else if (heater == "chamber") {
		sendGCode("M141 S" + $(this).data("temp"));		// Set chamber temperature
	} else if (heater == "cabinet") {
		sendGCode("M141 P1 S" + $(this).data("temp"));	// Set cabinet temperature
	}
	e.preventDefault();
});

$("#div_tools_heaters div.panel-heading div.dropdown").on("click", ".heater-temp", function(e) {
	if (toolMapping != undefined) {
		var inputElement = $(this).closest("div.input-group").find("input");
		var activeOrStandby = (inputElement.data("type") == "active") ? "S" : "R";
		var temperature = $(this).data("temp");

		var gcode = "";
		for(var i = 0; i < toolMapping.length; i++) {
			var temps = [];
			toolMapping[i].heaters.forEach(function() { temps.push(temperature); });
			if (temps.length > 0) {
				var tempString = temps.reduce(function(a, b) { return a + ":" + b; });
				gcode += "G10 P" + toolMapping[i].number + " " + activeOrStandby + tempString + "\n";
			}
		}
		sendGCode(gcode);
	}

	e.preventDefault();
});

$("#page_settings").on("click", ".btn-select-tool", function(e) {
	var tool = $(this).closest("div.panel-body").data("tool");
	if (lastStatusResponse != undefined && lastStatusResponse.currentTool == tool) {
		changeTool(-1);
	} else {
		changeTool(tool);
	}
	e.preventDefault();
});

$("#page_settings").on("click", ".btn-remove-tool", function(e) {
	var tool = $(this).closest("div.panel-body").data("tool");
	showConfirmationDialog(T("Delete Tool"), T("Are you sure you wish to remove tool {0}?", tool), function() {
		sendGCode("M563 P" + tool + " D-1 H-1");
		extendedStatusCounter = settings.extendedStatusInterval;
	});
	e.preventDefault();
});

$("#table_extra input[type='checkbox']").change(function() {
	setExtraTemperatureVisibility($(this).closest("tr").data("sensor"), $(this).prop("checked"));
});

$("#table_heaters").on("click", ".heater-temp", function(e) {
	var inputElement = $(this).closest("div.input-group").find("input");
	var activeOrStandby = (inputElement.data("type") == "active") ? "S" : "R";
	var temperature = $(this).data("temp");
	var gcode = "";
	var heater = inputElement.closest("tr").data("heater");
	var currentTool = (lastStatusResponse == undefined) ? -1 : lastStatusResponse.currentTool;

	// 1. Is the active tool mapped to this heater?
	if (currentTool >= 0 && $.inArray(heater, getTool(currentTool).heaters) != -1) {
		// Yes - generate only one G10 code for it
		var type = inputElement.data("type");
		var temps = [];
		getTool(currentTool).heaters.forEach(function(h) {
			if (h == heater) {
				temps.push(temperature);
			} else {
				temps.push($("#table_heaters > tbody > tr[data-heater='" + h + "'] > td > input[data-type='" + type + "']").val());
			}
		});

		gcode = "G10 P" + currentTool + " " + activeOrStandby + temps.reduce(function(a, b) { return a + ":" + b; });
	} else {
		// 2. Is there a tool that is only mapped to this heater?
		var toolFound = false;
		getToolsByHeater(heater).forEach(function(tool) {
			var toolHeaters = getTool(tool).heaters;
			if (!toolFound && toolHeaters.length == 1) {
				// Yes - generate only one G10 code for this tool
				gcode = "G10 P" + tool + " " + activeOrStandby + temperature;
				toolFound = true;
			}
		});

		// 3. Is there at least one tool that is assigned to this heater at all?
		if (!toolFound) {
			var tools = getToolsByHeater(heater);
			if (tools.length > 0) {
				// Yes - use the first one to set the target temperature(s)
				var type = inputElement.data("type");
				var temps = [];
				getTool(tools[0]).heaters.forEach(function(h) {
					if (h == heater) {
						temps.push(temperature);
					} else {
						temps.push($("#table_heaters > tbody > tr[data-heater='" + h + "'] > td > input[data-type='" + type + "']").val());
					}
				});

				gcode = "G10 P" + tools[0] + " " + activeOrStandby + temps.reduce(function(a, b) { return a + ":" + b; });
			}
		}
	}

	sendGCode(gcode);
	e.preventDefault();
});

$("#table_tools").on("click", ".heater-temp", function(e) {
	var tool = $(this).closest("tr").data("tool");
	var heater = $(this).closest("tr").data("heater");
	var type = $(this).closest("div.input-group").find("input").data("type");
	var temperature = $(this).data("temp");

	var temps = [];
	getTool(tool).heaters.forEach(function(h) {
		if (h == heater) {
			temps.push(temperature);
		} else {
			var cell = $("#table_tools > tbody > tr[data-tool='" + tool + "'][data-heater='" + h + "'] > td");
			temps.push(cell.find("div > input[data-type='" + type + "']").val());
		}
	});

	var gcode = "G10 P" + tool  + " " + (type == "active" ? "S" : "R");
	gcode += temps.reduce(function(a, b) { return a + ":" + b; });
	sendGCode(gcode);

	if (windowIsXsSm()) {
		$(this).blur();
	} else {
		$(this).select();
	}
	e.preventDefault();
});

$("#table_tools").on("click", "tr > th:nth-child(2) > a", cbHeaterClick);

$("#table_tools").on("keydown", "tr > td > div > input", function(e) {
	// Ignore bed and chamber heaters. They're handled by a static event callback
	var heater = $(this).closest("tr").data("heater");
	if (heater == "bed" || heater == "chamber" || heater == "cabinet") {
		return;
	}

	// Has the user pressed enter or tab (on Android)?
	var enterKeyPressed = (e.which == 13);
	enterKeyPressed |= (e.which == 9 && windowIsXsSm());
	if (isConnected && enterKeyPressed) {
		var tool = $(this).closest("tr").data("tool");
		if ($(this).hasClass("spindle-active")) {
			// Call M3 to set the spindle RPM
			for(var i = 0; i < spindleTools.length; i++) {
				if (spindleTools[i] == tool) {
					if ($(this).val() >= 0) {
						sendGCode("M3 P" + i + " S" + $(this).val());
					} else {
						sendGCode("M4 P" + i + " S" + -$(this).val());
					}
				}
			}
		} else {
			// Set active or standby temperature
			var type = $(this).data("type");

			var temps = [];
			getTool(tool).heaters.forEach(function(h) {
				var cell = $("#table_tools > tbody > tr[data-tool='" + tool + "'][data-heater='" + h + "'] > td");
				temps.push(cell.find("div > input[data-type='" + type + "']").val());
			});

			var gcode = "G10 P" + tool  + " " + (type == "active" ? "S" : "R");
			gcode += temps.reduce(function(a, b) { return a + ":" + b; });
			sendGCode(gcode);
		}

		if (windowIsXsSm()) {
			$(this).blur();
		} else {
			$(this).select();
		}
		e.preventDefault();
	}
});

$("#table_tools").on("click", "tr > th:first-child > a", function(e) {
	// Ignore bed and chamber heaters. They're handled by a static event callback
	var heater = $(this).closest("tr").data("heater");
	if (heater == "bed" || heater == "chamber" || heater == "cabinet") {
		return;
	}

	// Ignore this if we're not connected
	if (!isConnected) {
		e.preventDefault();
		return;
	}

	// Get the associated tool and check if it allows the filament to be changed
	var currentTool = (lastStatusResponse == undefined) ? -1 : lastStatusResponse.currentTool;
	var tool = $(this).closest("tr").data("tool");
	if (getTool(tool).hasOwnProperty("filament")) {
		// Show popover for tools that are assigned to exactly one extruder and let the user decide what to do
		var popover = $(this).parent().children("div.popover");
		if (popover.length > 0) {
			$(this).popover("hide");
			$(this).blur();
		} else {
			if (lastPopover != undefined) {
				$(lastPopover).popover("hide");
				lastPopover = undefined;
			}
			var toolObj = getTool(tool);

			// make popover content
			var content = '';
			if (tool == currentTool) {
				content += '<a href="#" class="tool" data-tool="-1"><span class="glyphicon glyphicon-pause"></span> ' + T("Deselect Tool") + '</a>';
			} else {
				content += '<a href="#" class="tool" data-tool="' + tool + '"><span class="glyphicon glyphicon-play"></span> ' + T("Select Tool") + '</a>';
			}
			content += "<hr>";
			if (toolObj != undefined && toolObj.filament == "") {
				content += '<a href="#" class="load-filament"><span class="glyphicon glyphicon glyphicon-arrow-down"></span> ' + T("Load Filament") + '</a>';
			} else {
				content += '<a href="#" class="change-filament"><span class="glyphicon glyphicon-transfer"></span> ' + T("Change Filament") + '</a>';
				content += '</br>';
				content += '<a href="#" class="unload-filament"><span class="glyphicon glyphicon-arrow-up"></span> ' + T("Unload Filament") + '</a>';
			}

			// show it
			$(this).popover({
				content: content,
				html: true,
				trigger: "manual",
				placement: "bottom",
			}).popover("show");
		}
	} else {
		// Either activate or deactivate tool
		if (tool == currentTool) {
			changeTool(-1);
		} else {
			changeTool(tool);
		}

		$(this).blur();
	}
	e.preventDefault();
});

$("#table_calibration_tools").on("click", ".tool-offset-up", function(e) {
	if (!$(this).hasClass("disabled")) {
		var axis = $(this).data("axis");
		var changeTriggerHeight = (axis == "Z" && $(this).parents("tr").prop("rowIndex") == 1);
		if (changeTriggerHeight)
		{
			zTriggerHeight = Math.round((zTriggerHeight - 0.01) * 100) / 100;
			sendGCode("G31 Z" + zTriggerHeight.toFixed(2) + "\nM290 S-0.01\nM500 P31");
			$(this).parents("td").children("span").text(T("{0} mm", zTriggerHeight.toFixed(2)));
		}
		else
		{
			var toolNumber = $(this).parents("tr").data("tool");
			var tool = getTool($(this).parents("tr").data("tool"));
			if (tool.hasOwnProperty("offsets")) {
				var axisIndex = ((axis == "X") ? 0 : ((axis == "Y") ? 1 : 2));
				tool.offsets[axisIndex] = Math.round((tool.offsets[axisIndex] + 0.01) * 100) / 100;
				sendGCode("G10 P" + toolNumber + " " + axis + tool.offsets[axisIndex] + "\nM500 P31");
				$(this).parents("td").children("span").text(T("{0} mm", tool.offsets[axisIndex].toFixed(2)));
			}
		}
	}
});

$("#table_calibration_tools").on("click", ".tool-offset-down", function(e) {
	if (!$(this).hasClass("disabled")) {
		var axis = $(this).data("axis");
		var changeTriggerHeight = (axis == "Z" && $(this).parents("tr").prop("rowIndex") == 1);
		if (changeTriggerHeight)
		{
			zTriggerHeight = Math.round((zTriggerHeight + 0.01) * 100) / 100;
			sendGCode("G31 Z" + zTriggerHeight + "\nM290 S0.01\nM500 P31");
			$(this).parents("td").children("span").text(T("{0} mm", zTriggerHeight.toFixed(2)));
		}
		else
		{
			var toolNumber = $(this).parents("tr").data("tool");
			var tool = getTool(toolNumber);
			if (tool.hasOwnProperty("offsets")) {
				var axisIndex = ((axis == "X") ? 0 : ((axis == "Y") ? 1 : 2));
				tool.offsets[axisIndex] = Math.round((tool.offsets[axisIndex] - 0.01) * 100) / 100;
				sendGCode("G10 P" + toolNumber + " " + axis + tool.offsets[axisIndex] + "\nM500 P31");
				$(this).parents("td").children("span").text(T("{0} mm", tool.offsets[axisIndex].toFixed(2)));
			}
		}
	}
});

$("#table_calibration_tools").on("click", ".tool-calibrate", function(e) {
	if (!$(this).hasClass("disabled")) {
		var toolNumber = $(this).parents("tr").data("tool");
		showConfirmationDialog(T("Calibrate Tool"), T("Before you proceed please make sure that the calibration tool is installed. Continue?"),
			function() {
				sendGCode('M98 P"tcalibrate' + toolNumber + '.g"');
			}
		);
	}
});

$("#table_calibration_tools").on("click", ".tool-set-offset", function(e) {
	if (lastStatusResponse != undefined) {
		var toolNumber = $(this).parents("tr").data("tool");
		sendGCode("G10 P" + toolNumber + " X" + lastStatusResponse.coords.xyz[0] + " Y" + lastStatusResponse.coords.xyz[1] + "\nM500");

		$(this).closest("tr").find("td:nth-child(2) > span").text(T("{0} mm", lastStatusResponse.coords.xyz[0].toFixed(2)));
		$(this).closest("tr").find("td:nth-child(3) > span").text(T("{0} mm", lastStatusResponse.coords.xyz[1].toFixed(2)));
	}
});

$("body").on("click", ".load-filament", function(e) {
	showFilamentDialog($(this).closest("tr").data("tool"), false);
	e.preventDefault();
});

$("body").on("click", ".change-filament", function(e) {
	showFilamentDialog($(this).closest("tr").data("tool"), true);
	e.preventDefault();
});

$("body").on("click", ".unload-filament", function(e) {
	var tool = $(this).closest("tr").data("tool"), gcode = "";
	if (lastStatusResponse != undefined && lastStatusResponse.currentTool != tool) {
		gcode = "T" + tool + "\n";
	}
	gcode += "M702";
	sendGCode(gcode);

	e.preventDefault();
});

$("body").on("click", ".tool", function(e) {
	changeTool($(this).data("tool"));
	e.preventDefault();
});

$("body").on("click", "[data-gcode]", function(e) {
	if (isConnected && !$(this).hasClass("disabled")) {
		// If this G-Code isn't performed by a button, treat it as a manual input
		sendGCode($(this).data("gcode"), !($(this).is(".btn")));
	}
	e.preventDefault();
});

var lastPopover = undefined;
$("body").on("shown.bs.popover", function(e) {
	lastPopover = $(".popover");
});

$("body").on("blur", "#div_tools_heaters tr > th > a", function() {
	if (lastPopover != undefined) {
		lastPopover.popover("hide");
	}
});

$("body").on("hidden.bs.popover", function(e) {
	if (lastPopover != undefined) {
		$(lastPopover).popover("destroy");
		lastPopover = undefined;
	}
});


/* Static GUI Events */

$("#a_list_devices").click(function(e) {
	app.listDevices();
	e.preventDefault();
});

$("#a_mode").click(function(e) {
	if (vendor == "diabase") {
		var currentMode = $(this).children("span").children("span").text();
		if (currentMode == "FFF") {
			sendGCode("M453");			// switch to CNC mode
		} else {
			sendGCode("M451");			// switch to FFF mode
		}
	}
	// TODO: It would be good to know what kind of machine this is and what types of tools are actually configured
	// Unfortunately we can only assign spindles to tools but not laser cutters, hence clicking on this link does not do anything yet
	e.preventDefault();
});


$(".btn-cnc").click(function() {
	if (settings.showcnc) {
		showConfirmationDialog(T(" LASER "), T("Hardware LASER style?<br/><br/>Are you REALLY sure you want to do this?"), function() {
			sendGCode("M117 HAPPY LASER");
		});
	} else {
		sendGCode("M117 HAPPY LASER");
	}
});


$(".btn-laser").click(function() {
	if (settings.showlaser) {
		showConfirmationDialog(T(" CNC "), T("Hardware LASER style?<br/><br/>Are you REALLY sure you want to do this?"), function() {
			sendGCode("M98 P/macros/sys/laser.g);
		});
	} else {
		sendGCode("M117 HAPPY LASER");
	}
});


$(".a-tools, .a-heaters, .a-extra").click(function(e) {
	var showTools = $(this).hasClass("a-tools");
	var showHeaters = $(this).hasClass("a-heaters");
	var showExtra = $(this).hasClass("a-extra");
	$("#div_tools").toggleClass("hidden", !showTools);
	$("#div_heaters").toggleClass("hidden", !showHeaters);
	$("#div_extra").toggleClass("hidden", !showExtra);
	resizeCharts();
	e.preventDefault();
});

$(".heaters-off").click(function(e) {
	if (isConnected) {
		var gcode = "";

		// Turn off nozzle heaters
		if (toolMapping != undefined) {
			for(var i = 0; i < toolMapping.length; i++) {
				var temps = [];
				toolMapping[i].heaters.forEach(function() { temps.push("-273.15"); });
				if (temps.length > 0) {
					var tempString = temps.reduce(function(a, b) { return a + ":" + b; });
					gcode += "G10 P" + toolMapping[i].number + " R" + tempString + " S" + tempString + "\n";
				}
			}
		}

		// Turn off bed
		if (bedHeater != -1) {
			gcode += "M140 S-273.15\n";
		}

		// Turn off chamber
		if (chamberHeater != -1) {
			gcode += "M141 S-273.15\n";
		}

		// Turn off cabinet
		if (cabinetHeater != -1) {
			gcode += "M141 P1 S-273.15\n";
		}

		sendGCode(gcode);
	}
	e.preventDefault();
});

$("#a_download_text").click(function(e) {
	var textContent = "";
	$("#console_log > div.row").each(function() {
		var time = $(this).children().eq(0).text();
		var event = $(this).children().eq(1).children("strong").text();
		var response = $(this).children().eq(1).children("span").text();
		event = event.replace(/"/g,'""');
		response = response.replace(/"/g,'""');
		textContent += time + ": " + (response == "" ? event : (event + ": " + response)) + "\r\n";
	});

	var file = new File([textContent], "console.txt", {type: "text/plain;charset=utf-8"});
	saveAs(file);
	e.preventDefault();
});

$("#a_download_csv").click(function(e) {
	var csvContent = '"time","event","response"\r\n';
	$("#console_log > div.row").each(function() {
		var time = $(this).children().eq(0).text();
		var event = $(this).children().eq(1).children("strong").text();
		var response = $(this).children().eq(1).children("span").text();
		event = event.replace(/"/g,'""');
		response = response.replace(/"/g,'""');
		csvContent += '"' + time + '","' + event + '","' + response + '"\r\n';
	});

	var file = new File([csvContent], "console.csv", {type: "text/csv;charset=utf-8"});
	saveAs(file);
	e.preventDefault();
});

$("#a_webcam").click(function(e) {
	var panelContent= $("#panel_webcam > div.panel-body");
	if (panelContent.hasClass("hidden")) {
		$("#span_webcam").removeClass("glyphicon-menu-up").addClass("glyphicon-menu-down");
		panelContent.removeClass("hidden");
	} else {
		$("#span_webcam").removeClass("glyphicon-menu-down").addClass("glyphicon-menu-up");
		panelContent.addClass("hidden");
	}
	$(this).blur();
	e.preventDefault();
});

$("#img_webcam").click(function() {
	updateWebcam(true);
});

$("#img_webcam_calibration").click(function() {
	updateCalibrationWebcam(true);
});

$("#img_webcam_calibration").resize(function() {
	if (!calibrationWebcamEmbedded) {
		$("#img_crosshair").css("left", $(this).position().left + $(this).width() / 2 - $("#img_crosshair").width() / 2);
		$("#img_crosshair").css("top", $(this).position().top + $(this).height() / 2 - $("#img_crosshair").height() / 2);
	}
});

$("#ifm_webcam_calibration").resize(function() {
	if (calibrationWebcamEmbedded) {
		$("#img_crosshair").css("left", $("#div_ifm_webcam_calibration").position().left + $(this).width() / 2 - $("#img_crosshair").width() / 2);
		$("#img_crosshair").css("top", $("#div_ifm_webcam_calibration").position().top + $(this).height() / 2 - $("#img_crosshair").height() / 2);
	}
});

$("#btn_baby_down").click(function() {
	if (isConnected) {
		sendGCode("M290 S" + (-settings.babysteppingZ));
	}
});

$("#btn_baby_up").click(function() {
	if (isConnected) {
		sendGCode("M290 S" + (settings.babysteppingZ));
	}
});

$("#btn_calibrate_all").click(function() {
	showConfirmationDialog(T("Calibrate Tool"), T("Before you proceed please make sure that the calibration tool is installed. Continue?"),
		function() {
			sendGCode('M98 P"calibrate_all.g"');
		}
	);
});

$("#btn_cancel").click(function() {
	sendGCode("M0 H1");	// Stop / Cancel Job, but leave all the heaters on
	$(this).addClass("disabled");
});

$(".btn-emergency-stop").click(function() {
	if (settings.confirmStop) {
		showConfirmationDialog(T("Emergency STOP"), T("This will turn off everything and perform a software reset.<br/><br/>Are you REALLY sure you want to do this?"), function() {
			sendGCode("M112\nM999");
		});
	} else {
		sendGCode("M112\nM999");
	}
});

$("#btn_clear_log").click(function(e) {
	$("#console_log").html("");
	log("info", "<strong>" + T("Message Log cleared!") + "</strong>");
	e.preventDefault();
});

$('input[name="feed"]').parent().contextmenu(function(e) {
	showStepDialog("amount", $(this).index(), Math.abs($(this).children("input").prop("value")));
	e.preventDefault();
});

$('input[name="feedrate"]').parent().contextmenu(function(e) {
	showStepDialog("feedrate", $(this).index(), Math.abs($(this).children("input").prop("value")));
	e.preventDefault();
});

$("#btn_extrude").click(function(e) {
	var feedrate = $("#panel_extrude input[name=feedrate]:checked").val() * 60;
	var amount = $("#panel_extrude input[name=feed]:checked").val();
	var drive = $("#panel_extrude input[name='extruder']:checked").val();

	if (drive != "mix" && lastStatusResponse != undefined && !$("#div_extrude").hasClass("hidden")) {
		var amounts = [];
		var toolDrives = getTool(lastStatusResponse.currentTool).drives;
		for(var i = 0; i < toolDrives.length; i++) {
			if (drive == "all" || drive == toolDrives[i]) {
				amounts.push(amount);
			} else {
				amounts.push("0");
			}
		}
		amount = amounts.join(":");
	}

	sendGCode("M120\nM83\nG1 E" + amount + " F" + feedrate + "\nM121");
});

$("#btn_retract").click(function(e) {
	var feedrate = $("#panel_extrude input[name=feedrate]:checked").val() * 60;
	var amount = -$("#panel_extrude input[name=feed]:checked").val();
	var drive = $('input[name="extruder"]:checked').val();

	if (drive != "mix" && lastStatusResponse != undefined && !$("#div_extrude").hasClass("hidden")) {
		var amounts = [];
		var toolDrives = getTool(lastStatusResponse.currentTool).drives;
		for(var i = 0; i < toolDrives.length; i++) {
			if (drive == "all" || drive == toolDrives[i]) {
				amounts.push(amount);
			} else {
				amounts.push("0");
			}
		}
		amount = amounts.join(":");
	}

	sendGCode("M120\nM83\nG1 E" + amount + " F" + feedrate + "\nM121");
});

$(".btn-hide-info").click(function() {
	if ($(this).hasClass("active")) {
		$("#div_info_panels").addClass("hidden-sm");
		$("#div_content, #div_static_sidebar").addClass("content-collapsed-padding");
		setTimeout(function() {
			$(".btn-hide-info").removeClass("active");
		}, 100);
	} else {
		$("#div_info_panels").removeClass("hidden-sm");
		$("#div_content, #div_static_sidebar").removeClass("content-collapsed-padding");
		setTimeout(function() {
			$(".btn-hide-info").addClass("active");
		}, 100);
	}
	$(this).blur();
});

$("#table_move_head .btn-home[data-axis='0']").resize(function() {
	if (geometry != "delta") {
		var width = $(this).parent().width();
		if (width > 0) {
			$("#btn_homeall").css("min-width", width);
		}
	}
}).resize();

$("#btn_homeall").resize(function() {
	if (currentPage == "control") {
		// Ensure the Head Movement title is properly aligned in the center
		$(this).css("margin-right", $("#btn_bed_compensation").parent().width() - $(this).width() - 12);
	}
});

$(".btn-home").click(function(e) {
	if ($(this).data("axis") == "all") {
		sendGCode("G28");
	} else {
		var axisNumber = parseInt($(this).data("axis"));
		sendGCode("G28 " + axisNames[axisNumber]);
	}
	e.preventDefault();
});

$(".btn-move").click(function(e) {
	// Get the axis to move
	var axis = $(this).data("axis-letter");
	if (axis == undefined) {
		var axisNumber = parseInt($(this).data("axis"));
		axis = axisNames[axisNumber];
	}

	// Send a G-code
	var moveString = "M120\nG91\nG1 ";
	moveString += axis + $(this).data("amount");
	moveString += " F" + settings.moveFeedrate + "\nM121";
	sendGCode(moveString);
	e.preventDefault();
});

$("#page_control .btn-move").contextmenu(function(e) {
	var axis = axisOrder[$(this).data("axis")];
	var axisIndex = axisOrder.indexOf(axis);
	var cellIndex = ($(this).data("amount") < 0) ? $(this).index() : $(this).parent().children().length - $(this).index() - 1;
	showStepDialog("axis", cellIndex, Math.abs($(this).data("amount")), axisIndex);
	e.preventDefault();
});

$("#btn_pause").click(function() {
	if (isPaused) {
		sendGCode("M24");	// Resume
	} else if (isProcessing) {
		sendGCode("M25");	// Pause
	}
	$(this).addClass("disabled");
});

$("#btn_process_another").click(function() {
	if (isConnected) {
		sendGCode('M32 "' + $(this).data("file") + '"');
		$("#div_process_another").addClass("hidden");
	}
});

$(".gcode-input input").keydown(function(e) {
	var enterKeyPressed = (e.which == 13);
	enterKeyPressed |= (e.which == 9 && windowIsXsSm()); // need this for Android
	if (enterKeyPressed && $(this).typeahead("getActive") == $(this).val()) {
		$(this).closest("form").submit();
		e.preventDefault();
	}
});

$(".gcode-input").submit(function(e) {
	if (isConnected) {
		var gcode = $(this).find("input").val();
		if (settings.uppercaseGCode) {
			var gcodeToSend = "", inString = false;
			for(var i = 0; i < gcode.length; i++) {
				var chr = gcode[i];
				if (inString) {
					if (i < gcode.length - 1 && chr == '\\' && gcode[i + 1] == '"') {
						gcodeToSend += '\\"';
						i++;
					} else {
						if (chr == '"') {
							inString = false;
						}
						gcodeToSend += chr;
					}
				} else {
					if (chr == '"') {
						inString = true;
					}
					gcodeToSend += chr.toUpperCase();
				}
			}
			gcode = gcodeToSend;
		}
		sendGCode(gcode, true);
		$(this).find("input").select();
	}
	e.preventDefault();
});

$("#table_heaters > tbody > tr > td > div > input," +
  "#table_tools > tbody > tr[data-heater='bed'] > td > div > input," +
  "#table_tools > tbody > tr[data-heater='chamber'] > td > div > input," +
  "#table_tools > tbody > tr[data-heater='cabinet'] > td > div > input").keydown(function(e) {
	var enterKeyPressed = (e.which == 13);
	enterKeyPressed |= (e.which == 9 && windowIsXsSm()); // need this for Android
	if (isConnected && enterKeyPressed) {
		var heater = $(this).closest("tr").data("heater");
		var temperature = $(this).val();
		var gcode = "";

		// 1. Are we dealing with a bed or chamber heater?
		if (heater == "bed") {
			gcode = "M140 S" + temperature;
		} else if (heater == "chamber") {
			gcode = "M141 S" + temperature;
		} else if (heater == "cabinet") {
			gcode = "M141 P1 S" + temperature;
		} else {
			// 2. Is the active tool mapped to this heater?
			var activeOrStandby = ($(this).data("type") == "active") ? "S" : "R";
			var currentTool = (lastStatusResponse == undefined) ? -1 : lastStatusResponse.currentTool;
			if (currentTool >= 0 && $.inArray(heater, getTool(currentTool).heaters) != -1) {
				// Yes - generate only one G10 code for it
				var type = $(this).data("type");
				var temps = [];
				getTool(currentTool).heaters.forEach(function(h) {
					if (h == heater) {
						temps.push(temperature);
					} else {
						temps.push($("#table_heaters > tbody > tr[data-heater='" + h + "'] > td > input[data-type='" + type + "']").val());
					}
				});

				gcode = "G10 P" + currentTool + " " + activeOrStandby + temps.reduce(function(a, b) { return a + ":" + b; });
			} else {
				// 3. Is there a tool that is only mapped to this heater?
				var toolFound = false;
				getToolsByHeater(heater).forEach(function(tool) {
					var toolHeaters = getTool(tool).heaters;
					if (!toolFound && toolHeaters.length == 1) {
						// Yes - generate only one G10 code for this tool
						gcode = "G10 P" + tool + " " + activeOrStandby + temperature;
						toolFound = true;
					}
				});

				// 4. Is there at least one tool that is assigned to this heater at all?
				if (!toolFound) {
					var tools = getToolsByHeater(heater);
					if (tools.length > 0) {
						// Yes - use the first one to set the target temperature(s)
						var type = $(this).data("type");
						var temps = [];
						getTool(tools[0]).heaters.forEach(function(h) {
							if (h == heater) {
								temps.push(temperature);
							} else {
								temps.push($("#table_heaters > tbody > tr[data-heater='" + h + "'] > td > input[data-type='" + type + "']").val());
							}
						});

						gcode = "G10 P" + tools[0] + " " + activeOrStandby + temps.reduce(function(a, b) { return a + ":" + b; });
					}
				}
			}
		}
		sendGCode(gcode);

		if (windowIsXsSm()) {
			$(this).blur();
		} else {
			$(this).select();
		}
		e.preventDefault();
	}
});

$(".table-axis-positions td").click(function() {
	if (isConnected) {
		var axis = axisNames[$(this).data("axis")];
		showTextInput(T("Set {0} position", axis), T("Please enter a new position for the {0} axis:", axis), function(value) {
			if (!isNaN(value)) {
				sendGCode("G92 " + axis + value);
			}
		}, $(this).text());
	}
});

$(".all-temp-input").keydown(function(e) {
	if (isConnected && e.which == 13) {
		if (toolMapping != undefined) {
			var activeOrStandby = ($(this).data("type") == "active") ? "S" : "R";
			var temperature = $(this).val();

			var gcode = "";
			for(var i = 0; i < toolMapping.length; i++) {
				if ($.inArray(0, toolMapping[i].heaters) == -1 && toolMapping[i].heaters.length > 0) {
					// Make sure we don't set temperatures for the heated bed
					gcode += "G10 P" + toolMapping[i].number + " " + activeOrStandby + $(this).val() + "\n";
				}
			}
			sendGCode(gcode);
		}

		e.preventDefault();
	}
});

$("#div_content").resize(function() {
	// It doesn't always make sense to make the main content scrollable. Hence check if
	// a) this option is explicitly enabled
	// b) DWC is not running in a small window
	// c) the sidebar has enough space to be fully displayed
	if (!settings.scrollContent || windowIsXsSm() || $("#div_static_sidebar").first().offset().top + $("#div_static_sidebar").first().height() > $(window).height()) {
		$(this).css("height", "").css("min-height", "");
	} else {
		var height = "calc(100vh - " + $(this).offset().top + "px)";
		var minHeight = $("#div_static_sidebar").height() + "px";
		$(this).css("height", height).css("min-height", minHeight);

		if ($("body").height() > $(window).height()) {
			$(this).css("height", "").css("min-height", "");
		}
	}
});

$(".navbar-brand").click(function(e) {
	if ($(this).prop("href") == "#") {
		e.preventDefault();
	}
});

$(".navbar-brand.visible-xs > abbr").click(function(e) {
	showMessage("warning", T("Warning"), T("Some axes are not homed"));
	e.preventDefault();
});

$(".navlink").click(function(e) {
	$(this).blur();
	showPage($(this).data("target"));
	e.preventDefault();
});

$("#panel_control_misc label.btn").click(function() {
	if ($(this).find("input").val() == 1) {		// ATX on
		sendGCode("M80");
	} else {									// ATX off
		showConfirmationDialog(T("ATX Power"), T("Do you really want to turn off ATX power?<br/><br/>This will turn off all drives, heaters and fans."), function() {
			sendGCode("M81");
		});
	}
});

$("#panel_extrude label.btn").click(function() {
	$(this).parent().find("label.btn").removeClass("btn-primary").addClass("btn-default");
	$(this).removeClass("btn-default").addClass("btn-primary");
});

$("#table_heaters > tbody > tr > th > a," +
	"#table_tools > tbody > tr[data-heater='bed'] > th:first-child > a," +
	"#table_tools > tbody > tr[data-heater='chamber'] > th:first-child > a," +
	"#table_tools > tbody > tr[data-heater='cabinet'] > th:first-child > a").click(cbHeaterClick);


$("#check_heaters input[type='checkbox'], #check_drives input[type='checkbox']").change(function() {
	var isChecked = $(this).is(":checked");
	$(this).closest("label").toggleClass("btn-primary", isChecked).toggleClass("btn-default", !isChecked);

	validateAddTool();
});

$("#div_add_tool input[type='number']").on("input", function() {
	validateAddTool();
});

function validateAddTool() {
	var toolNumber = parseInt($("#input_tool_number").val());
	var disableButton =	(!isConnected) ||
		(isNaN(toolNumber) || toolNumber < 0 || toolNumber > 255) ||
		(toolMapping != undefined && getTool(toolNumber) != undefined);
	$("#btn_add_tool").toggleClass("disabled", disableButton);
}

$("#div_add_tool input[type='number']").keydown(function(e) {
	if (e.which == 13) {
		if (!$("#btn_add_tool").hasClass("disabled")) {
			$("#btn_add_tool").click();
		}
		e.preventDefault();
	}
});

$("#ul_control_dropdown_tools, #ul_control_dropdown_heaters").click(function(e) {
	$(this).find(".dropdown").removeClass("open");
	if ($(e.target).is("a")) {
		$(this).closest(".dropdown").removeClass("open");
	} else {
		e.stopPropagation();
	}
});

$("#ul_control_dropdown_tools .btn-active-temp, #ul_control_dropdown_tools .btn-standby-temp," +
	"#ul_control_dropdown_heaters .btn-active-temp, #ul_control_dropdown_heaters .btn-standby-temp").click(function(e) {
	$(this).parent().toggleClass("open");
	e.stopPropagation();
});

window.onerror = function (msg, url, lineNo, columnNo, error) {
	var errorMessage;
	if (msg.toLowerCase().indexOf("script error") == -1){
		errorMessage = [
			'Version: ' + $("#dwc_version").text(),
			'Message: ' + msg,
			'URL: ' + url,
			'Line: ' + lineNo + ":" + columnNo,
			'Error object: ' + JSON.stringify(error)
		].join("<br/>");
	} else {
		errorMessage = 'Script Error: See Browser Console for Detail (Version: ' + $("#dwc_version").text() + ')';
	}

	if (isConnected) {
		disconnect(true);
		showMessage("danger", T("JavaScript Error"), T("A JavaScript error has occurred so the web interface has closed the connection to your board. It is recommended to reload the web interface now. If this happens again, please contact the author and share this error message:") + "<br/><br/>" + errorMessage, 0, true, false);
	}

	return false;
};


/* Mixed events */

function cbHeaterClick(e) {
	if (isConnected && !$(this).hasClass("disabled") && lastStatusResponse != undefined) {
		var tool = $(this).closest("tr").data("tool");
		var heater = $(this).closest("tr").data("heater");
		if (tool != undefined) {
			// Heater clicked on Tools panel
			switch (lastStatusResponse.temps.state[heater])
			{
				case 0:	// Off
					changeTool(tool);													// Select associated tool
					break;
				case 1:	// Standby
					var active = [], standby = [], heaters = getTool(tool).heaters;
					for(var i = 0; i < heaters.length; i++) {
						active.push((heaters[i] == heater) ? -273.15 : $("#table_tools tr[data-tool=" + tool + "] input[data-type=\"active\"]").val());
						standby.push((heaters[i] == heater) ? -273.15 : $("#table_tools tr[data-tool=" + tool + "] input[data-type=\"standby\"]").val());
					}

					var sParam = active.join(function(a, b) { return a + ":" + b; });
					var rParam = standby.join(function(a, b) { return a + ":" + b; });
					sendGCode("G10 P" + tool + "S" + sParam + " R" + rParam);			// Turn off clicked heater
					break;
				case 2:	// Active
					changeTool(-1);														// Deselect current tool
					break;
				case 3:	// Fault
					showMessage("danger", T("Heater Fault"), T("<strong>Error:</strong> A heater fault has occured on this particular heater.<br/><br/>Please turn off your machine and check your wiring for loose connections."));
					break;
			}
		} else {
			// Heater clicked on Heaters panel
			if (heater == "bed") {
				switch (lastStatusResponse.temps.bed.state)
				{
					case 0:	// Off
						sendGCode("M140 S" + lastStatusResponse.temps.bed.active);		// Turn on bed heater
						break;
					case 1: // Standby
						sendGCode("M140 S-273.15");										// Turn off bed completely
						break;
					case 2: // Active
						sendGCode("M144");												// Put bed into standby mode
						break;
					case 3:	// Fault
						showMessage("danger", T("Heater Fault"), T("<strong>Error:</strong> A heater fault has occured on this particular heater.<br/><br/>Please turn off your machine and check your wiring for loose connections."));
						break;
				}
				$(this).blur();
			} else if (heater == "chamber") {
				var chamberState = lastStatusResponse.temps.chamber.state;
				if (chamberState == 3) {
					showMessage("danger", T("Heater Fault"), T("<strong>Error:</strong> A heater fault has occured on this particular heater.<br/><br/>Please turn off your machine and check your wiring for loose connections."));
				} else if (chamberState == 2) {
					sendGCode("M141 P0 S-273.15");										// Turn off chamber
				} else {
					sendGCode("M141 P0 S" + lastStatusResponse.temps.chamber.active);	// Turn on chamber
				}
				$(this).blur();
			} else if (heater == "cabinet") {
				var cabinetState = lastStatusResponse.temps.cabinet.state;
				if (cabinetState == 3) {
					showMessage("danger", T("Heater Fault"), T("<strong>Error:</strong> A heater fault has occured on this particular heater.<br/><br/>Please turn off your machine and check your wiring for loose connections."));
				} else if (cabinetState == 2) {
					sendGCode("M141 P1 S-273.15");										// Turn off cabinet
				} else {
					sendGCode("M141 P1 S" + lastStatusResponse.temps.cabinet.active);	// Turn on cabinet
				}
				$(this).blur();
			} else {
				var tools = getToolsByHeater(heater), hasToolSelected = false;
				tools.forEach(function(tool) {
					if (tool == lastStatusResponse.currentTool) {
						hasToolSelected = true;
					}
				});

				if (hasToolSelected) {
					changeTool(-1);
					$(this).blur();
				} else if (tools.length == 1) {
					if (lastStatusResponse.temps.state[heater] == 1) {
						var active = [], standby = [], heaters = getTool(tools[0]).heaters;
						for(var i = 0; i < heaters.length; i++) {
							active.push((heaters[i] == heater) ? -273.15 : $("#table_tools tr[data-tool=" + tool + "] input[data-type=\"active\"]").val());
							standby.push((heaters[i] == heater) ? -273.15 : $("#table_tools tr[data-tool=" + tool + "] input[data-type=\"standby\"]").val());
						}

						var sParam = active.join(function(a, b) { return a + ":" + b; });
						var rParam = standby.join(function(a, b) { return a + ":" + b; });
						sendGCode("G10 P" + tools[0] + "S" + sParam + " R" + rParam);	// Turn off associated heater
					} else {
						changeTool(tools[0]);											// Select tool
					}
					$(this).blur();
				} else if (tools.length > 0) {
					var popover = $(this).parent().children("div.popover");
					if (popover.length > 0) {
						$(this).popover("hide");
						$(this).blur();
					} else {
						var content = '<div class="btn-group-vertical btn-group-vertical-justified">';
						tools.forEach(function(toolNumber) {
							content += '<div class="btn-group"><a href="#" class="btn btn-default btn-sm tool" data-tool="' + toolNumber + '">T' + toolNumber + '</a></div>';
						});
						content += '</div>';

						$(this).popover({
							content: content,
							html: true,
							title: T("Select Tool"),
							trigger: "manual",
							placement: "bottom",
						}).popover("show");
					}
				}
			}

			$(this).blur();
		}
	}
	e.preventDefault();
}


/* GUI Helpers */

function addBedTemperature(temperature) {
	// Drop-Down item
	$(".ul-bed-temp").append('<li><a href="#" class="bed-temp" data-temp="' + temperature + '">' + T("{0} Â°C", temperature) + '</a></li>');
	$(".btn-bed-temp").removeClass("disabled");

	// Entry on Settings page
	var item =	'<li class="list-group-item col-md-6" data-temperature="' + temperature + '">' + T("{0} Â°C", temperature);
	item +=		'<button class="btn btn-danger btn-sm btn-delete-parent pull-right" title="' + T("Delete this temperature item") + '">';
	item +=		'<span class="glyphicon glyphicon-trash"></span></button></li>';
	$("#ul_bed_temps").append(item);
}

function addHeadTemperature(temperature, type) {
	// Drop-Down item
	$(".ul-" + type + "-temp").append('<li><a href="#" class="heater-temp" data-temp="' + temperature + '">' + T("{0} Â°C", temperature) + '</a></li>');
	$(".btn-" + type + "-temp").removeClass("disabled");

	// Entry on Settings page
	var item =	'<li class="list-group-item col-xs-6 col-lg-3" data-temperature="' + temperature + '">' + T("{0} Â°C", temperature);
	item +=		'<button class="btn btn-danger btn-sm btn-delete-parent pull-right" title="' + T("Delete this temperature item") + '">';
	item +=		'<span class="glyphicon glyphicon-trash"></span></button></li>';
	$("#ul_" + type + "_temps").append(item);
}

function changeTool(tool) {
	// Check if any tool change macros can be skipped
	var param = 7;
	if (!settings.doTfree) { param &= ~1; }
	if (!settings.doTpre) { param &= ~2; }
	if (!settings.doTpost) { param &= ~4; }

	// If all the macros shall be run, send only the T-code
	if (param == 7) {
		sendGCode("T" + tool);
	} else {
		sendGCode("T" + tool + " P" + param);
	}
}

function clearBedTemperatures() {
	$(".ul-bed-temp, #ul_bed_temps").html("");
	$(".btn-bed-temp").addClass("disabled");
}

function clearHeadTemperatures() {
	$(".ul-active-temp, .ul-standby-temp, #ul_active_temps, #ul_standby_temps").html("");
	$(".btn-active-temp, .btn-standby-temp").addClass("disabled");
}

function setAxesHomed(axes) {
	// Set button colors and prepare list of unhomed axes
	var unhomedAxes = "";
	for(var i = 0; i < Math.min(axes.length, axisNames.length); i++) {
		if (axes[i]) {
			$(".btn-home[data-axis='" + i + "']").removeClass("btn-warning").addClass("btn-primary");
		} else {
			unhomedAxes += ", " + axisNames[i];
			$(".btn-home[data-axis='" + i + "']").removeClass("btn-primary").addClass("btn-warning");
		}
	}

	// Set home alert visibility
	if (unhomedAxes == "") {
		$(".home-warning").addClass("hidden");
	} else {
		if (unhomedAxes.length > 3) {
			$("#unhomed_warning").html(T("The following axes are not homed: <strong>{0}</strong>", unhomedAxes.substring(2)));
		} else {
			$("#unhomed_warning").html(T("The following axis is not homed: <strong>{0}</strong>", unhomedAxes.substring(2)));
		}
		$(".home-warning").removeClass("hidden");
	}
}

function setATXPower(value) {
	$("input[name='atxPower']").prop("checked", false).parent().removeClass("active");
	$("input[name='atxPower'][value='" + (value ? "1" : "0") + "']").prop("checked", true).parent().addClass("active");
}

function setBoardType(type) {
	boardType = type;
	allowCombinedFirmware = false;
	controllableFans = 7;	// show first three fans

	var isWiFi, isDuetNG, isDuetMaestro;
	if (type.indexOf("duetwifi") == 0) {
		firmwareFileName = "DuetWiFiFirmware";
		allowCombinedFirmware = isWiFi = isDuetNG = true;
		isDuetMaestro = false;
	} else if (type.indexOf("duetethernet") == 0) {
		firmwareFileName = "DuetEthernetFirmware";
		isWiFi = false;
		allowCombinedFirmware = isDuetNG = true;
	} else if (type.indexOf("duetmaestro") == 0) {
		firmwareFileName = "DuetMaestroFirmware";
		isWiFi = isDuetNG = false;
		isDuetMaestro = true;
	} else if (type.indexOf("duet3") == 0 || type.indexOf("same70") == 0) {
		firmwareFileName = "Duet3Firmware";
		isWiFi = isDuetNG = true;
	} else {
		controllableFans = 1;
		firmwareFileName = "RepRapFirmware";
		isWiFi = isDuetNG = false;
	}

	for(var i = 0; i < maxFans; i++) {
		setFanVisibility(i, controllableFans & (1 << i));
	}

	$(".duet-ng").toggleClass("hidden", !isDuetNG);
	$(".wifi-setting").toggleClass("hidden", !isWiFi);

	$(".li-display").toggleClass("hidden", !isDuetMaestro);
	if (!isDuetMaestro && $("#page_display").hasClass("active")) {
		$("a[href='#page_general']").click();
	}
}

function setCurrentTemperature(heater, temperature) {
	// Set current heater temperature
	var tempCell = $("#div_tools_heaters tr[data-heater='" + heater + "'] > td.current");
	if (temperature == undefined) {
		tempCell.html(T("n/a"));
	} else if (temperature < -270) {
		tempCell.html(T("error"));
	} else if (vendor == "diabase" && heater == "cabinet") {
		tempCell.html(T("{0} %RH", temperature.toFixed(1)));
	} else {
		tempCell.html(T("{0} Â°C", temperature.toFixed(1)));
	}

	// Update Extrude+Retract buttons
	if (heater != "bed" && heater != "chamber" && heater != "cabinet" && lastStatusResponse != undefined) {
		if (lastStatusResponse.currentTool != -1) {
			var isActiveHead = false;
			getToolsByHeater(heater).forEach(function(tool) { if (tool == lastStatusResponse.currentTool) { isActiveHead = true; } });
			if (isActiveHead) {
				if (temperature >= coldRetractTemp) {
					$(".btn-retract").removeClass("disabled");
				} else {
					$(".btn-retract").addClass("disabled");
				}

				if (temperature >= coldExtrudeTemp) {
					$(".btn-extrude").removeClass("disabled");
				} else {
					$(".btn-extrude").addClass("disabled");
				}
			}
		} else {
			$(".btn-retract, .btn-extrude").addClass("disabled");
		}
	}
}

function setCurrentToolTemperature(tool, heater, temperature) {
	var tempCell = $("#table_tools tr[data-tool='" + tool + "'][data-heater='" + heater + "'] > td.current");
	if (temperature == undefined) {
		tempCell.html(T("n/a"));
	} else if (temperature < -270) {
		tempCell.html(T("error"));
	} else {
		tempCell.html(T("{0} Â°C", temperature.toFixed(1)));
	}
}

function setGeometry(g) {
	// The following may be extended in future versions
	if (g == "delta") {
		$("#btn_bed_compensation").text(T("Auto Delta Calibration"));
		$("#panel_head_movement .home-buttons div, #panel_head_movement div.home-buttons").addClass("hidden");
		$("#panel_head_movement td.home-buttons").css("padding-right", "0px");
		$("#btn_homeall").css("min-width", "");
	} else {
		$("#btn_bed_compensation").text(T("Auto Bed Compensation"));
		$("#panel_head_movement .home-buttons div, #panel_head_movement div.home-buttons").removeClass("hidden");
		$("#panel_head_movement td.home-buttons").css("padding-right", "");
		$("#btn_homeall").resize();
	}
	$("#dd_geometry").text(T(g.charAt(0).toUpperCase() + g.slice(1)));
	geometry = g;
}

function setHeaterState(heater, state, currentTool) {
	var statusText = getHeaterStateText(state);
	if (heater == "bed" || heater == "chamber" || heater == "cabinet") {
		$("#div_tools_heaters tr[data-heater='" + heater + "'] > th > span:last-child").text(statusText);
	} else {
		// Set status texts on Tools panel
		$("#table_tools > tbody > tr[data-heater='" + heater + "']").each(function() {
			$(this).find("span.heater-state").html(statusText);
		});

		// Set status texts on Heaters panel
		var tools = getToolsByHeater(heater);
		if (tools.length != 0) {
			var toolList = [];
			for(var i = 0; i < tools.length; i++) {
				toolList.push((tools[i] == currentTool) ? ("<u>T" + tools[i] + "</u>") : ("T" + tools[i]));
			}
			statusText += " (" + toolList.reduce(function(a, b) { return a + ", " + b; }) + ")";

			if (tools.length > 1) {
				$("#table_heaters > tbody > tr[data-heater='" + heater + "'] > th").find(".caret").removeClass("hidden");
			} else {
				$("#table_heaters > tbody > tr[data-heater='" + heater + "'] > th").find(".caret").addClass("hidden");
			}
		} else {
			$("#table_heaters tr > th:first-child").eq(heater).find(".caret").addClass("hidden");
		}
		$("#table_heaters > tbody > tr[data-heater='" + heater + "'] span.heater-state").html(statusText);
	}
}

function setPauseStatus(paused) {
	if (paused == isPaused) {
		return;
	}

	$("#div_cancel").toggleClass("hidden", !paused);
	if (paused) {
		$("#btn_cancel").removeClass("disabled");
		$("#btn_pause").removeClass("btn-warning disabled").addClass("btn-success").attr("title", T("Resume paused job (M24)"));
		$("#btn_pause > span.glyphicon").removeClass("glyphicon-pause").addClass("glyphicon-play");
		$("#btn_pause > span:last-child").text(T("Resume"));
	} else {
		$("#btn_pause").removeClass("btn-success").addClass("btn-warning").attr("title", T("Pause current job (M25)"));
		$("#btn_pause > span.glyphicon").removeClass("glyphicon-play").addClass("glyphicon-pause");
		$("#btn_pause > span:last-child").text(T("Pause Job"));
		if (isProcessing) {
			$("#btn_pause").removeClass("disabled");
		}
	}
	isPaused = paused;
}

function setJobStatus(processing) {
	if (processing == isProcessing) {
		return;
	}

	if (processing) {
		if (justConnected) {
			showPage("job");
		}

		layerData = [];
		currentLayerTime = maxLayerTime = lastLayerPrintDuration = 0;
		drawPrintChart();
		jobHasFinished = false;

		// Progress is set in the status response callback

		if (boardType.indexOf("duet0") == 0) {
			$(".btn-upload").addClass("disabled");
		}
		$("#page_general .btn-upload").removeClass("disabled");

		$("#btn_pause").removeClass("disabled");
		$("#div_process_another").addClass("hidden");
		$(".row-progress").removeClass("hidden");
		$("#td_last_layertime").html(T("n/a"));

		requestFileInfo();
	} else {
		$("#btn_pause").addClass("disabled");
		if (boardType.indexOf("duet0") == 0) {
			$(".btn-upload").toggleClass("disabled", !isConnected);
		}

		if (!isConnected || fileInfo == undefined) {
			$(".row-progress").addClass("hidden");
		}

		if (isConnected) {
			if ($("#auto_sleep").is(":checked")) {
				sendGCode("M1");
				$("#auto_sleep").prop("checked", false);
			}

			if (!jobHasFinished && currentLayerTime > 0) {
				addLayerData(currentLayerTime, lastStatusResponse.coords.extr.reduce(function(a, b) { return a + b; }), true);
				$("#td_layertime").html(T("n/a"));
			}
			jobHasFinished = true;

			if (fileInfo != undefined) {
				$("#div_process_another").removeClass("hidden");
				$("#btn_process_another").data("file", fileInfo.fileName);

				setProgress(100, T("Processed {0}, 100% Complete", fileInfo.fileName), undefined);
			} else {
				setProgress(100, T("Job Complete!"), undefined);
			}

			["filament", "layer", "file"].forEach(function(id) {
				if ($("#tl_" + id).html() != T("n/a")) {
					$("#tl_" + id).html("00s");
					$("#et_" + id).html((new Date()).toLocaleTimeString());
				}
			});

			// If a file job was simulated, update the file info once again
			if (lastStatusResponse != undefined && lastStatusResponse.status == 'M' && fileInfo != undefined) {
				var path = (fileInfo.fileName.indexOf(":") == -1) ? ("0:/gcodes/" + fileInfo.fileName) : fileInfo.fileName;
				reloadFileCache(path);
			}
		}

		fileInfo = undefined;
	}

	isProcessing = processing;
	$(".disable-processing").toggleClass("disabled", processing);

	if (waitingForJobStart && processing) {
		$("#modal_upload").modal("hide");
		showPage("job");
		waitingForJobStart = false;
	}
}

function setProbeValue(value, secondaryValue) {
	if (value < 0) {
		$("#td_probe, #dd_probe_current_value").html(T("n/a"));
	} else if (secondaryValue == undefined) {
		$("#td_probe, #dd_probe_current_value").html(value);
	} else {
		$("#td_probe, #dd_probe_current_value").html(value + " (" + secondaryValue.reduce(function(a, b) { return a + b; }) + ")");
	}

	if (probeTriggerValue != undefined && value > probeTriggerValue && !isProcessing) {
		$("#td_probe").css("background-color", probeTriggerColor);
	} else if (probeSlowDownValue != undefined && value > probeSlowDownValue && !isProcessing) {
		$("#td_probe").css("background-color", probeSlowDownColor);
	} else {
		$("#td_probe").css("background-color", "");
	}
}

function setProgress(progress, labelLeft, labelRight) {
	if (labelLeft != undefined) {
		$("#span_progress_left").text(labelLeft);
	}
	if (labelRight != undefined) {
		$("#span_progress_right").text(labelRight);
	}
	$("#progress").css("width", progress + "%");

	if (progress == 100) {
		Piecon.reset();
	} else {
		Piecon.setProgress(progress);
	}
}

function setStatusLabel(text, style) {
	text = T(text);
	$(".label-status").removeClass("label-default label-danger label-info label-warning label-success label-primary").addClass("label-" + style).text(text);
}

function setSpindleCurrent(spindle, current) {
	$("[data-tool=" + spindleTools[spindle] + "] .spindle-current").text(T("{0} RPM", current));
	spindleCurrents[spindle] = current;
}

function setSpindleInput(spindle, rpm) {
	var spindleInput = $("[data-tool=" + spindleTools[spindle] + "] .spindle-active");
	if (spindleInput.length > 0 && !spindleInput.is(":focus")) {
		spindleInput.val(rpm);
	}
	spindleActives[spindle] = rpm;
}

function setTemperatureInput(heater, value, active, setToolHeaters) {
	var prefix = (setToolHeaters) ? "" : "#table_heaters ";

	var tempInput = undefined;
	if (heater == "bed" || heater == "chamber" || heater == "cabinet") {
		tempInput = $(prefix + "tr[data-heater='" + heater + "'] input");
	} else {
		var activeOrStandby = (active) ? "active": "standby";
		tempInput = $(prefix + "tr[data-heater='" + heater + "'] input[data-type='" + activeOrStandby + "']");
	}

	if (tempInput != undefined) {
		// FIXME: This limits inputs to 0C. Maybe it should be configurable instead?
		tempInput.filter(":not(:focus)").val((value < 0) ? 0 : value);
	}
}

function setToolTemperatureInput(tool, heater, value, active) {
	// Update Heaters panel as well
	setTemperatureInput(heater, value, active, false);

	var tempInput = undefined;
	if (heater == "bed" || heater == "chamber" || heater == "cabinet") {
		tempInput = $("#table_tools tr[data-heater='" + heater + "'] input");
	} else {
		var activeOrStandby = (active) ? "active": "standby";
		tempInput = $("#table_tools tr[data-tool='" + tool + "'][data-heater='" + heater + "'] input[data-type='" + activeOrStandby + "']");
	}

	if (tempInput != undefined) {
		// FIXME: This limits inputs to 0C. Maybe it should be configurable instead?
		tempInput.filter(":not(:focus)").val((value < 0) ? 0 : value);
	}
}

function setTimeLeft(field, value) {
	if (value == undefined || (value == 0 && isProcessing)) {
		$("#et_" + field + ", #tl_" + field).html(T("n/a"));
	} else {
		// Estimate end time
		var now = new Date();
		var estEndTime = new Date(now.getTime() + value * 1000); // Date uses ms
		$("#et_" + field).html(estEndTime.toLocaleTimeString());

		// Estimate time left
		$("#tl_" + field).html(formatTime(value));
	}
}

function setMachineName(name) {
	if (name == machineName) {
		return;
	}

	$("#title, .machine-name").text(name);
	machineName = name;
}

function showPage(name) {
	$("#layer_tooltip").hide();

	$("#div_static_sidebar a, #section_navigation a, .page").removeClass("active");
	$("#div_static_sidebar a[data-target='" + name + "'], #page_" + name + ", #section_navigation a[data-target='" + name + "']").addClass("active");
	setTimeout(function() {
		if (slideout.isOpen()) {
			slideout.close();
		}
	}, 250);

	if (name != currentPage) {
		if (name == "control") {
			$("#page_control .table-fan-control input").slider("relayout");
			if (currentMacroDirectory == "0:/macros" && !macrosLoaded) {
				updateMacroFiles();
			}

			$("#div_info_panels").removeClass("hidden-xs");
			$("#div_content").removeClass("content-collapsed-padding-xs");
		} else {
			$("#div_info_panels").addClass("hidden-xs");
			$("#div_content").addClass("content-collapsed-padding-xs");
		}

		if (name == "job") {
			$("#slider_speed").slider("relayout");
			$("#page_job .table-fan-control input").slider("relayout");
			for(var extr = 0; extr < maxExtruders; extr++) {
				$("#slider_extr_" + extr).slider("relayout");
			}
			if (refreshPrintChart) {
				drawPrintChart();
			}
			waitingForJobStart = false;
		}

		if (name == "scanner") {
			if (scansLoaded) {
				$(".span-refresh-scans").removeClass("hidden");
			} else {
				updateScanFiles();
			}
		} else {
			$(".span-refresh-scans").addClass("hidden");
		}

		if (name == "console") {
			currentPage = "console";
			if (windowIsMdLg()) {
				$("#page_console input").focus();
			}
		}

		if (name == "files") {
			if (gcodeUpdateIndex == knownGCodeFiles.length) {
				$(".span-refresh-files").removeClass("hidden");
			} else {
				updateGCodeFiles();
			}
		} else {
			$(".span-refresh-files").addClass("hidden");
		}

		if (name == "macros" && isConnected) {
			if (macrosLoaded) {
				$(".span-refresh-macros").removeClass("hidden");
			} else {
				updateMacroFiles();
			}
		} else {
			$(".span-refresh-macros").addClass("hidden");
		}

		if (name == "filaments" && isConnected) {
			if (filamentsLoaded) {
				$(".span-refresh-filaments").removeClass("hidden");
			} else {
				updateFilaments();
			}
		} else {
			$(".span-refresh-filaments").addClass("hidden");
		}

		if (name == "calibration" && vendor == "diabase") {
			sendGCode("M118 P1 S\"IP\"");
			lastSentGCode = "";
		}

		if (name == "settings" && isConnected) {
			getConfigResponse();

			if ($("#page_ui").hasClass("active")) {
				$("#btn_clear_cache").toggleClass("disabled", $.isEmptyObject(cachedFileInfo));
			} else if ($("#page_sysedit").hasClass("active")) {
				if (sysLoaded) {
					$("#a_refresh_sys").removeClass("hidden");
				} else {
					updateSysFiles();
				}
			} else if ($("#page_display").hasClass("active")) {
				if (displayLoaded) {
					$("#a_refresh_display").removeClass("hidden");
				} else {
					updateDisplayFiles();
				}
			}
		}
	}

	currentPage = name;
}


/* Dynamic sidebar */

var slideout = new Slideout({
	"panel": document.getElementById("main_content"),
	"menu": document.getElementById("nav_sidebar"),
	"padding": 220,
	"tolerance": 70
});

$("#nav_sidebar").removeClass("hidden");

$("body").resize(function() {
	if (window.matchMedia('(min-width: 768px)').matches) {
		if (slideout.isOpen()) {
			// Close menu if the page width exceeds XS
			slideout.close();
		}
		slideout.disableTouch();
	} else {
		slideout.enableTouch();
	}
}).resize();

$("#btn_toggle_sidebar").click(function() {
	slideout.toggle();
});


/* Theme support */

function applyThemeColors() {
	// Update temp chart colors and repaint it
	for(var heater = 0; heater < maxHeaters; heater++) {
		tempChartOptions.colors[heater] = $(".heater-" + heater).css("color");
	}
	for(var tempSensor = 0; tempSensor < maxTempSensors; tempSensor++) {
		tempChartOptions.colors[maxHeaters + tempSensor] = $(".temp-sensor-" + tempSensor).css("color");
	}

	if (tempChart != undefined) {
		tempChart.destroy();
		tempChart = undefined;
		drawTemperatureChart();
	}

	// Update layer times chart
	printChartOptions.colors[0] = getColorFromCSS("chart-print-line");
	if (printChart != undefined) {
		printChart.destroy();
		printChart = undefined;
		drawPrintChart();
	}

	// Update background color for print chart tooltip
	if (settings.theme == "dark") {
		$("#layer_tooltip").css("background-color", $("#panel_job_info").css("background-color"));
	} else {
		$("#layer_tooltip").css("background-color", "");
	}

	// Update Z-probe colors
	probeSlowDownColor = getColorFromCSS("probe-slow-down");
	probeTriggerColor = getColorFromCSS("probe-trigger");
}

function getColorFromCSS(classname)
{
	var ghostSpan = $('<span class="hidden ' + classname + '"></span>');
	ghostSpan.appendTo("body");
	var color = ghostSpan.css("color");
	ghostSpan.remove();
	return color;
}

/* Piecon dynamic icon support */

Piecon.setOptions({
	color: "#0000ff",		// Pie chart color
	background: "#bbb",		// Empty pie chart color
	shadow: "#fff",			// Outer ring color
	fallback: "force"		// Toggles displaying percentage in the title bar (possible values - true, false, 'force')
});

/* Modal dialog functions for Duet Web Control
 * 
 * written by Christian Hammacher (c) 2016-2017
 * 
 * licensed under the terms of the GPL v3
 * see http://www.gnu.org/licenses/gpl-3.0.html
 */


/* Generic workarounds */

$(".modal").on("hidden.bs.modal", function() {
	// Bootstrap bug: Padding is added to the right, but never cleaned
	$("body").css("padding-right", "");
});


/* Confirmation Dialog */

function showConfirmationDialog(title, message, callback) {
	$("#modal_confirmation h4").html('<span class="glyphicon glyphicon-question-sign"></span> ' + title);
	$("#modal_confirmation p").html(message);
	$("#modal_confirmation button.btn-success").off().one("click", callback);
	$("#modal_confirmation").modal("show");
	$("#modal_confirmation .btn-success").focus();
}


/* Text Input Dialog */

function showTextInput(title, message, callback, text, emptyCallback) {
	$("#modal_textinput h4").html(title);
	$("#modal_textinput p").html(message);
	$("#modal_textinput input").val((text == undefined) ? "" : text);
	$("#modal_textinput form").off().submit(function(e) {
		$("#modal_textinput").modal("hide");
		var value = $("#modal_textinput input").val();
		if (value.trim() != "") {
			callback(value);
		} else if (emptyCallback != undefined) {
			emptyCallback();
		}
		e.preventDefault();
	});
	$("#modal_textinput").modal("show");
}

$("#modal_textinput").on("shown.bs.modal", function() {
	$("#modal_textinput input").focus();
});


/* Change Step Dialog */

var stepChangeType, stepChangeIndex, stepChangeAxisIndex;

function showStepDialog(type, index, currentValue, axisIndex) {
	stepChangeType = type;
	stepChangeIndex = index;
	stepChangeAxisIndex = axisIndex;

	$("#input_step_amount").val(currentValue);
	$("#input_step_amount_unit").text((type == "feedrate") ? T("mm/s") : T("mm"));
	$("#modal_change_step").modal("show");
}

$("#modal_change_step").on("shown.bs.modal", function() {
	$("#modal_change_step input").focus();
});

$("#modal_change_step form").submit(function(e) {
	if (stepChangeType == "axis") {
		settings.axisMoveSteps[stepChangeAxisIndex][stepChangeIndex] = $("#input_step_amount").val();
	} else if (stepChangeType == "amount") {
		settings.extruderAmounts[stepChangeIndex] = $("#input_step_amount").val();
	} else {
		settings.extruderFeedrates[stepChangeIndex] = $("#input_step_amount").val();
	}

	applyMovementSteps();
	$("#modal_change_step").modal("hide");

	e.preventDefault();
});


/* Host Prompt */

function showHostPrompt() {
	$('#input_host').val(getLocalSetting("lastHost", ""));
	$("#modal_host_input").modal("show");
}

$("#modal_host_input").on("shown.bs.modal", function() {
	$("#input_host").focus();
});

$("#form_host").submit(function(e) {
	$("#modal_host_input").off("hide.bs.modal").modal("hide");
	ajaxPrefix = settings.lastHost = $("#input_host").val();		// let the user decide if this shall be saved

	ajaxPrefix += "/";
	if (ajaxPrefix.indexOf("://") == -1) {
		// Prepend http prefix if no URI scheme is given
		ajaxPrefix = "http://" + ajaxPrefix;
	}

	connect(sessionPassword, false);
	e.preventDefault();
});


/* Password prompt */

function showPasswordPrompt() {
	$('#input_password').val("");
	$("#modal_pass_input").modal("show");
}

$("#form_password").submit(function(e) {
	$("#modal_pass_input").off("hide.bs.modal").modal("hide");
	connect($("#input_password").val(), false);
	e.preventDefault();
});

$("#modal_pass_input").on("shown.bs.modal", function() {
	$("#input_password").focus();
});


/* Filament Change Dialog */

var filamentChangeTool, changingFilament;

function showFilamentDialog(tool, changeFilament) {
	// make list of all available filaments
	$("#div_filaments").children().remove();
	$("#table_filaments > tbody > tr").each(function() {
		var filament = $(this).data("filament");
		var isLoaded = false;
		for(var i = 0; i < toolMapping.length; i++) {
			if (toolMapping[i].hasOwnProperty("filament") && toolMapping[i].filament == filament) {
				isLoaded = true;
				break;
			}
		}

		if (!isLoaded) {
			$("#div_filaments").append('<a href="#" class="a-load-filament list-group-item" data-filament="' + filament + '"><span class="glyphicon glyphicon-cd"></span> ' + filament + '</a>');
		}
	});

	// show notification or selection dialog
	if ($("#div_filaments").children().length == 0) {
		showMessage("warning", T("No Filaments"), T("There are no other filaments available to choose. Please go to the Filaments page and define more."));
	} else {
		filamentChangeTool = tool;
		changingFilament = changeFilament;
		$("#modal_change_filament").modal("show");
	}
}

$("body").on("click", ".a-load-filament", function(e) {
	$("#modal_change_filament").modal("hide");

	var gcode = "";
	if (lastStatusResponse != undefined && lastStatusResponse.currentTool != filamentChangeTool) {
		gcode = "T" + filamentChangeTool + "\n";
	}
	if (changingFilament) {
		gcode += "M702\n";
	}
	gcode += "M701 S\"" + $(this).data("filament") + "\"";
	if (!compatibilityMode) { gcode += "\nM703"; }
	sendGCode(gcode);

	e.preventDefault();
});


/* File Edit Dialog */

function showEditDialog(title, content, callback) {
	$("#modal_edit .modal-title").text(T("Editing {0}", title));
	var edit = $("#modal_edit textarea").val(content).get(0);
	edit.selectionStart = edit.selectionEnd = 0;
	$("#modal_edit").modal("show");
	$("#btn_save_file").off("click").click(function() {
		$("#modal_edit").modal("hide");
		callback($("#modal_edit textarea").val());
	});
}

$("#modal_edit").on("shown.bs.modal", function() {
	$("#modal_edit textarea").focus();
});

$("#modal_edit div.modal-content").resize(function() {
	var contentHeight = $(this).height();
	var headerHeight = $("#modal_edit div.modal-header").height();
	var footerHeight = $("#modal_edit div.modal-footer").height();
	$("#modal_edit div.modal-body").css("height", (contentHeight - headerHeight - footerHeight - 60) + "px");
});

$(document).delegate("#modal_edit textarea", "keydown", function(e) {
	var keyCode = e.keyCode || e.which;

	if (keyCode == 9) {
		e.preventDefault();
		var start = $(this).get(0).selectionStart;
		var end = $(this).get(0).selectionEnd;

		// set textarea value to: text before caret + tab + text after caret
		$(this).val($(this).val().substring(0, start)
				+ "\t"
				+ $(this).val().substring(end));

		// put caret at right position again
		$(this).get(0).selectionStart = $(this).get(0).selectionEnd = start + 1;
	}
});


/* Start Scan Dialog (proprietary) */

$("#btn_start_scan").click(function() {
	if (!$(this).hasClass("disabled")) {
		if (vendor == "diabase") {
			// Properietary implemenation with extra steps
			$("#modal_start_scan").modal("show");
		} else {
			// Basic open-source variant
			showTextInput(T("Start new 3D scan"), T("Please enter a name for the new scan:"), function(name) {
				if (filenameValid(name)) {
					// Let the firmware do the communication to the board
					sendGCode("M752 S360 P" + name);
				} else {
					showMessage("danger", T("Error"), T("The specified filename is invalid. It may not contain quotes, colons or (back)slashes."));
				}
			}, undefined, function() {
				showMessage("danger", T("Error"), T("The filename for a new scan must not be empty!"));
			});
		}
	}
});

$("input[name='scanMode']").change(function() {
	$(".scan-unit").text(($("input[name='scanMode']:checked").val() == 0) ? T("mm") : T("Â°"));
});

$("#modal_start_scan input").keyup(function() {
	$("#btn_start_scan_modal").toggleClass("disabled", $("#modal_start_scan input:invalid").length > 0);
});

$("#btn_toggle_laser").click(function(e) {
	if ($(this).hasClass("active")) {
		sendGCode("M755 P0");
		$(this).removeClass("active").children("span.content").text(T("Activate Laser"));
	} else {
		sendGCode("M755 P1")
		$(this).addClass("active").children("span.content").text(T("Deactivate Laser"));
	}

	$(this).blur();
	e.preventDefault();
});

$("#modal_start_scan form").submit(function(e) {
	if (!$("#btn_start_scan_modal").hasClass("disabled")) {
		// 1. Turn off the alignment laser if it is still active
		if ($("#btn_toggle_laser").hasClass("active")) {
			$("#btn_toggle_laser").removeClass("active").children("span.content").text(T("Activate Laser"));
			if (isConnected) {
				sendGCode("M755 P0");
			}
		}

		// 2. Start a new scan
		var filename = $("#input_scan_filename").val();
		var range = $("#input_scan_range").val();
		var resolution = $("#input_scan_resolution").val();
		var mode = $("input[name='scanMode']:checked").val();

		// 3. Check the filename and start a new scan
		if (filenameValid(filename)) {
			sendGCode("M752 S" + range + " R" + resolution + " N" + mode + " P\"" + filename + "\"");
		} else {
			showMessage("danger", T("Error"), T("The specified filename is invalid. It may not contain quotes, colons or (back)slashes."));
		}

		// 4. Hide the modal dialog
		$("#modal_start_scan").modal("hide");
	}

	e.preventDefault();
});

$("#modal_start_scan").on("hidden.bs.modal", function() {
	if ($("#btn_toggle_laser").hasClass("active")) {
		$("#btn_toggle_laser").removeClass("active").children("span.content").text(T("Activate Laser"));
		if (isConnected) {
			// Turn off laser again when the dialog is closed
			sendGCode("M755 P0");
		}
	}
});


/* Scanner Progress Dialogs */

function updateScannerDialogs(scanResponse) {
	var scanProgress = 100, postProcessingProgress = 100, uploadProgress = 100;

	if (scanResponse.status == "S" || scanResponse.status == "P" || scanResponse.status == "U") {
		// Scanner is active
		if (!$("#modal_scanner").hasClass("in")) {
			$("#btn_cancel_scan").removeClass("hidden").removeClass("disabled");
			$("#btn_close_scan").addClass("hidden");

			$("#modal_scanner .modal-title").text(T("Scanning..."));
			$("#p_scan_info").text(T("Please wait while a scan is being made. This may take a while..."));

			$("#modal_scanner").modal("show");
		}

		// Update progress
		if (scanResponse.status == "S") {
			scanProgress = scanResponse.progress;
			postProcessingProgress = 0;
			uploadProgress = 0;
		} else if (scanResponse.status == "P") {
			scanProgress = 100;
			postProcessingProgress = scanResponse.progress;
			uploadProgress = 0;
		} else if (scanResponse.status == "U") {
			scanProgress = 100;
			postProcessingProgress = 100;
			uploadProgress = scanResponse.progress;
			$("#btn_cancel_scan").addClass("disabled");
		}
	} else if (scanResponse.status == "C") {
		// Scanner calibration is running
		if (!$("#modal_scanner_calibration").hasClass("in")) {
			$("#btn_cancel_calibration").removeClass("disabled");
			$("#modal_scanner_calibration").modal("show");
		}

		// Update progress
		$("#progress_calibration").css("width", scanResponse.progress + "%");
		$("#span_calibration_progress").text(T("{0} %", scanResponse.progress));
	} else if (scanResponse.status == "I") {
		// Scanner is inactive
		if ($("#modal_scanner").hasClass("in") && $("#modal_scanner .modal-title").text() != T("Scan complete")) {
			$("#modal_scanner .modal-title").text(T("Scan complete"));
			$("#p_scan_info").text(T("Your 3D scan is now complete! You may download it from the file list next."));

			$("#btn_cancel_scan").addClass("hidden");
			$("#btn_close_scan").removeClass("hidden");

			updateScanFiles();
			$(".span-refresh-scans").addClass("hidden");
		}

		if ($("#modal_scanner_calibration").hasClass("in")) {
			$("#modal_scanner_calibration").modal("hide");
		}
	}

	// Update progress bars
	if ($("#modal_scanner").hasClass("in")) {
		$("#progress_scan").css("width", scanProgress + "%");
		$("#span_scan_progress").text(T("{0} %", scanProgress));

		$("#progress_scan_postprocessing").css("width", postProcessingProgress + "%");
		$("#span_scan_postprocessing_progress").text(T("{0} %", postProcessingProgress));

		$("#progress_scan_upload").css("width", uploadProgress + "%");
		$("#span_scan_upload_progress").text(T("{0} %", uploadProgress));
	}
}

$("#btn_cancel_scan").click(function() {
	if (!$(this).hasClass("disabled")) {
		sendGCode("M753");
		$("#modal_scanner").modal("hide");
	}
});

$("#btn_cancel_calibration").click(function() {
	if (!$(this).hasClass("disabled")) {
		sendGCode("M753");
		$(this).addClass("disabled");
	}
});


/* WiFi cam setup dialog (OEM) */

$("#modal_wifi_cam form").submit(function(e) {
	sendGCode("M118 P1 S\"WIFI " + $("#input_cam_ssid").val() + " " + $("#input_cam_password").val() + "\"");
	lastSentGCode = "";
	$("#modal_wifi_cam").modal("hide");
	e.preventDefault();
});


/* Message Box Dialog */

var messageBoxResponse = undefined;

function updateMessageBox(response) {
	var timeout = response.timeout;
	response.timeout = 0;

	var stringifiedResponse = JSON.stringify(response);
	if (stringifiedResponse != messageBoxResponse)
	{
		messageBoxResponse = stringifiedResponse;
		showMessageBox(response.msg, response.title, response.mode, timeout, response.controls);
	}
}

function closeMessageBox() {
	if (messageBoxResponse != undefined) {
		if ($("#modal_messagebox").hasClass("in")) {
			$("#modal_messagebox").modal("hide");
		}
		messageBoxResponse = undefined;
	}
}


var messageBoxTimer = undefined;

function showMessageBox(message, title, mode, timeout, controls) {
	// Display message, title and optionally show Z controls
	$("#h3_messagebox").html(message);
	$("#h4_messagebox_title").html(title);
	$("#modal_messagebox div.modal-header").toggleClass("hidden", title == "");

	// Toggle axis control visibility
	$("#div_x_controls").toggleClass("hidden", (controls & (1 << 0)) == 0);
	$("#div_y_controls").toggleClass("hidden", (controls & (1 << 1)) == 0);
	$("#div_z_controls").toggleClass("hidden", (controls & (1 << 2)) == 0);

	// Toggle button visibility
	$("#modal_messagebox div.modal-footer").toggleClass("hidden", mode == 0);
	$("#modal_messagebox [data-dismiss]").toggleClass("hidden", mode != 1);
	$("#btn_ack_messagebox").toggleClass("hidden", mode == 0 || mode == 1);
	$("#btn_cancel_messagebox").toggleClass("hidden", mode != 3);

	// Show message box
	var backdropValue = (mode != 1) ? "static" : "true";
	$("#modal_messagebox").modal({ backdrop: backdropValue });

	var data = $("#modal_messagebox").data("bs.modal");
	data.options.backdrop = backdropValue;
	$("#modal_messagebox").data("bs.modal", data);

	// Take care of the timeouts
	if (messageBoxTimer != undefined) {
		clearTimeout(messageBoxTimer);
	}
	if (timeout > 0) {
		messageBoxTimer = setTimeout(function() {
			messageBoxTimer = undefined;
			$("#modal_messagebox").modal("hide");
		}, timeout * 1000);
	}
}

$("#btn_ack_messagebox").click(function() {
	$("#modal_messagebox").modal("hide");
	sendGCode("M292");
});

$("#btn_cancel_messagebox").click(function() {
	$("#modal_messagebox").modal("hide");
	sendGCode("M292 P1");
});

$('#modal_messagebox').on("hide.bs.modal", function() {
	if (messageBoxTimer != undefined) {
		clearTimeout(messageBoxTimer);
		messageBoxTimer = undefined;
	}

	// FIXME: This is needed to ensure the backdrop always works as intended
	$('#modal_messagebox').removeData();
});

/* Set mesh grid area */

$("#a_define_mesh").click(function(e) {
	$("#div_mesh_x, #div_mesh_y").toggleClass("hidden", geometry == "delta");
	$("#div_mesh_delta").toggleClass("hidden", geometry != "delta");
	$("#modal_define_mesh").modal("show");
	e.preventDefault();
});


$("#modal_define_mesh form").submit(function(e) {
	if (geometry != "delta") {
		var minX = $("#input_mesh_x_min").val();
		var maxX = $("#input_mesh_x_max").val();
		var spacingX = $("#input_mesh_x_spacing").val();
		var minY = $("#input_mesh_y_min").val();
		var maxY = $("#input_mesh_y_max").val();
		var spacingY = $("#input_mesh_y_spacing").val();
		sendGCode("M557 X" + minX + ":" + maxX + " Y" + minY + ":" + maxY + " S" + spacingX + ":" + spacingY);
	} else {
		var radius = $("#input_mesh_radius").val();
		var spacing = $("#input_mesh_spacing").val();
		sendGCode("M557 R" + radius + " S" + spacing);
	}

	$("#modal_define_mesh").modal("hide");
	e.preventDefault();
});

/* Probe Cylinder (OEM) */

$("#a_probe_cylinder").click(function(e) {
	$("#modal_cylinder").modal("show");
	e.preventDefault();
});

$("#modal_cylinder form").submit(function(e) {
	sendGCode("G28 Z\nG92 Z" + ($("#input_cylinder_diameter").val() / 2));
	$("#modal_cylinder").modal("hide");
	e.preventDefault();
});
/* Notification subsystem for Duet Web Control
 * 
 * written by Christian Hammacher (c) 2016-2018
 * 
 * licensed under the terms of the GPL v3
 * see http://www.gnu.org/licenses/gpl-3.0.html
 */


$.notifyDefaults({
	animate: {
		enter: "animated fadeInDown",
		exit: "animated fadeOutDown"
	},
	placement: {
		from: "bottom",
		align: "center"
	},
	newest_on_top: true,
	template: '<div data-notify="container" class="col-xs-12 col-sm-12 col-md-8 col-lg-5 alert alert-{0}">' +
		'<button type="button" aria-hidden="true" class="close" data-notify="dismiss">Ã</button>' +
		'<span data-notify="icon"></span> ' +
		'<span data-notify="title">{1}</span> ' +
		'<span data-notify="message">{2}</span>' +
		'<div class="progress" data-notify="progressbar">' +
		'<div class="progress-bar progress-bar-{0}" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>' +
		'</div>' +
		'<a href="{3}" target="{4}" data-notify="url"></a>' +
		'</div>'
});

var openNotifications = [];
var openMessageNotifications = [];


function showDownloadMessage() {
	var notifySettings = { icon: "glyphicon glyphicon-compressed",
		title: "<strong>" + T("Downloading Files") + "</strong><br/><br/>",
		message: T("Please wait while the selected files are being downloaded...")
	};
	var options = { type: "info",
		allow_dismiss: false,
		delay: -1,
		showProgressbar: true
	};
	return $.notify(notifySettings, options);
}

function showHaltMessage() {
	// Display backdrop and hide it when ready
	$("#modal_backdrop").modal("show");
	setTimeout(function() {
		$("#modal_backdrop").modal("hide");
	}, settings.haltedReconnectDelay);

	// Display notification
	var notifySettings = { icon: "glyphicon glyphicon-flash",
		title: "<strong>" + T("Emergency STOP") + "</strong><br/><br/>",
		message: T("Please wait while the firmware is restarting..."),
		progress: settings.haltedReconnectDelay / 100,
	};
	var options = { type: "warning",
		allow_dismiss: false,
		delay: settings.haltedReconnectDelay,
		timeout: 1000,
		showProgressbar: true
	};
	var notification = $.notify(notifySettings, options);
	$(notification.$ele).css("z-index", 9999);
}

function showMessage(type, title, message, timeout, allowDismiss, regularNotification) {
	// Set default arguments
	if (allowDismiss == undefined) { allowDismiss = true; }
	if (type == "danger" && allowDismiss && !settings.autoCloseErrorMessages) {
		if (timeout == undefined) { timeout = 0; }
		if (regularNotification == undefined) { regularNotification = false; }
	} else {
		if (timeout == undefined) { timeout = settings.notificationTimeout; }
		if (regularNotification == undefined) { regularNotification = true; }
	}

	// Check if an HTML5 notification shall be displayed
	if (document.hidden && settings.useHtmlNotifications) {
		// HTML5 notifications expect plain strings. Remove potential styles first
		if (title.indexOf("<") != -1) { title = $("<span>" + title + "</span>").text(); }
		if (message.indexOf("<") != -1) { message = $("<span>" + message + "</span>").text(); }

		// Create new notification and display it
		var options = {
			body: message,
			icon: "favicon.ico",
			dir : "ltr",
			requireInteraction: allowDismiss
		};
		var notification = new Notification(title, options);
		if (allowDismiss) { notification.onclick = function() { this.close(); }; }
		if (timeout > 0) { setTimeout(function() { notification.close(); }, timeout); }
		return notification;
	}

	// Otherwise display a JQuery notification. Find a suitable icon first
	var icon = "glyphicon glyphicon-info-sign";
	if (type == "warning") {
		icon = "glyphicon glyphicon-warning-sign";
	} else if (type == "danger") {
		icon = "glyphicon glyphicon-exclamation-sign";
	}

	// Check if the title can be displayed as bold text
	if (title != "")
	{
		if (title.indexOf("<strong>") == -1)
		{
			title = "<strong>" + title + "</strong>";
		}
		title += "<br/><br/>";
	}

	// Create and show the notification
	var notifySettings = { icon: icon,
		title: title,
		message: message };
	var options = { type: type,
		allow_dismiss: allowDismiss,
		delay: timeout };
	var notification = $.notify(notifySettings, options);
	if (allowDismiss) {
		$(notification.$ele).click(function() {
			openNotifications = openNotifications.filter(function(notif) { return notif != notification; });
			openMessageNotifications = openMessageNotifications.filter(function(notif) { return notif != notification; });
			notification.close();
		});
	}

	// Make sure we don't display more notifications than allowed
	if (regularNotification && settings.maxNotifications >= 1) {
		if (timeout > 0) {
			setTimeout(function() {
				openNotifications = openNotifications.filter(function(notif) { return notif != notification; });
				openMessageNotifications = openMessageNotifications.filter(function(item) { return item != notification; });
			}, timeout);
		}
		while (openMessageNotifications.length >= settings.maxNotifications) {
			openMessageNotifications.shift().close();
		}
		openMessageNotifications.push(notification);
	}
	openNotifications.push(notification);

	return notification;
}

function showUpdateMessage(type, customTimeout) {
	// Determine the message and timespan for the notification
	var title, message, timeout;
	switch (type) {
		case 0: // Firmware
			title = T("Updating Firmware...");
			message = T("Please wait while the firmware is being updated...");
			timeout = settings.updateReconnectDelay;
			break;

		case 1: // Duet WiFi Server
			title = T("Updating WiFi Server...");
			message = T("Please wait while the Duet WiFi Server firmware is being updated...");
			timeout = settings.dwsReconnectDelay;
			break;

		case 2: // Duet Web Control
			title = T("Updating Web Interface...");
			message = T("Please wait while Duet Web Control is being updated...");
			timeout = settings.dwcReconnectDelay;
			break;

		case 3: // Multiple Updates
			title = T("Updating Firmware...");
			message = T("Please wait while multiple firmware updates are being installed...");
			timeout = customTimeout;
			break;

		default: // Unknown
			alert(T("Error! Unknown update parameter!"));
			return;
	}

	// Display backdrop and hide it when ready
	$("#modal_backdrop").modal("show");
	setTimeout(function() {
		$("#modal_backdrop").modal("hide");
	}, timeout);

	// Display notification
	var notifySettings = { icon: "glyphicon glyphicon-time",
		title: "<strong>" + title + "</strong><br/><br/>",
		message: message,
		progress: timeout / 100,
	};
	var options = { type: "success",
		allow_dismiss: false,
		delay: timeout,
		timeout: 1000,
		showProgressbar: true
	};
	var notification = $.notify(notifySettings, options);
	$(notification.$ele).css("z-index", 9999);
	return notification;
}

/*function closeNotifications() {
	openMessageNotifications.forEach(function(notification) {
		openNotifications = openNotifications.filter(function(notif) { return notif != notification; });
		notification.close();
	});
	openMessageNotifications = [];
}*/

function closeAllNotifications() {
	openNotifications.forEach(function(notification) {
		notification.close();
	});
	openNotifications = [];
	openMessageNotifications = [];
}
/* Settings management for Duet Web Control
 * 
 * written by Christian Hammacher (c) 2016-2018
 * 
 * licensed under the terms of the GPL v3
 * see http://www.gnu.org/licenses/gpl-3.0.html
 */


var settings = {
	updateInterval: 250,			// in ms
	extendedStatusInterval: 10,		// nth status request will include extended values
	maxRetries: 2,					// number of AJAX retries before the connection is terminated

	haltedReconnectDelay: 10000,	// in ms (increased from 5000 for Duet WiFi)
	updateReconnectDelay: 20000,	// in ms
	dwsReconnectDelay: 45000,		// in ms
	dwcReconnectDelay: 225000,		// in ms (only for SPIFFS updates)

	showConnect: false,				// whether the Connect button is shown on remote connections
	confirmStop: false,				// ask for confirmation when pressing Emergency STOP
	useKiB: true,					// display file sizes in KiB instead of KB
	theme: "default",				// name of the theme to use
	scrollContent: true,			// make the main content scrollable on md+ resolutions
	showFanControl: true,			// show fan sliders
	showFanRPM: false,				// show fan RPM in sensors
	showcnc: false,
	showlaser: false,
	settingsOnDuet: true,			// store the DWC settings on the Duet
	language: "en",

	moveFeedrate: 6000,				// in mm/min
	axisMoveSteps: [				// in mm
		[100, 50, 10, 1, 0.1],
		[100, 50, 10, 1, 0.1],
		[50, 25, 5, 0.5, 0.05],
		[100, 50, 10, 1, 0.1],
		[100, 50, 10, 1, 0.1],
		[100, 50, 10, 1, 0.1],
		[100, 50, 10, 1, 0.1],
		[100, 50, 10, 1, 0.1],
		[100, 50, 10, 1, 0.1],
	],
	extruderAmounts: [100, 50, 20, 10, 5, 1],	// in mm
	extruderFeedrates: [60, 30, 15, 5, 1],		// in mm/s
	babysteppingZ: 0.05,			// in mm
	showATXControl: false,			// show ATX control

	uppercaseGCode: true,			// convert G-Codes to upper-case before sending them

	doTfree: true,					// tool
	doTpre: true,					// change
	doTpost: true,					// options

	useHtmlNotifications: false,	// use HTML5-based notifications
	autoCloseUserMessages: false,	// whether M117 messages are automatically closed
	autoCloseErrorMessages: false,	// whether error messages by the firmware are automatically closed
	showEmptyResponses: false,		// show successful pop-up notification for G-codes that returned no response
	showInfoMessages: true,			// show info messages
	showWarningMessages: true,		// show warning messages
	showErrorMessages: true,		// show error messages
	notificationTimeout: 5000,		// timeout of pop-up notifications in ms
	maxNotifications: 3,			// maximum number of simultaneously opened notifications

	webcamURL: "",
	webcamInterval: 5000,			// in ms
	webcamFix: false,				// do not append extra HTTP qualifier when reloading images
	webcamEmbedded: false,			// use iframe to embed webcam stream
	webcamRotation: 0,
	webcamFlip: "none",

	defaultActiveTemps: [0, 180, 190, 200, 210, 220, 235],
	defaultStandbyTemps: [0, 95, 120, 140, 155, 170],
	defaultBedTemps: [0, 55, 60, 65, 90, 110, 120]
};
var needsInitialSettingsUpload = false;

var defaultSettings = jQuery.extend(true, {}, settings);		// need to do this to get a valid copy

var themeInclude;

var rememberedGCodes = ["M0", "M1", "M84", "M561"], defaultGCodes = rememberedGCodes.slice();


/* Safe wrappers for localStorage */

function getLocalSetting(key, defaultValue) {
	if (typeof localStorage === "undefined") {
		return defaultValue;
	}

	var value = localStorage.getItem(key);
	if (value == undefined || value.length == 0 ||
		(defaultValue != undefined && value.constructor !== defaultValue.constructor)) {
		return defaultValue;
	}
	return JSON.parse(value);
}

function setLocalSetting(key, value) {
	if (typeof localStorage !== "undefined") {
		localStorage.setItem(key, JSON.stringify(value));
	}
}

function removeLocalSetting(key) {
	if (typeof localStorage !== "undefined") {
		localStorage.removeItem(key);
	}
}


/* Setting methods */

function loadSettings() {
	// Delete cookie (usually not used unless a really old web interface version was used before)
	document.cookie = "settings=; expires=Thu, 01 Jan 1970 00:00:00 UTC";

	// Try to parse the stored settings (if any)
	var loadedSettings = getLocalSetting("settings", null);
	if (loadedSettings != null) {
		for(var key in settings) {
			// Try to copy each setting if their types are equal
			if (loadedSettings.hasOwnProperty(key) && loadedSettings[key] != null && settings[key].constructor === loadedSettings[key].constructor) {
				settings[key] = loadedSettings[key];
			}
		}

		// Backward-compatibility
		if (loadedSettings.hasOwnProperty("useDarkTheme")) {
			settings.theme = loadedSettings.useDarkTheme ? "dark" : "default";
		}
	}

	// Do NOT allow storage of the settings on the Duet if this is running on localhost
	if (location.host == "") {
		settings.settingsOnDuet = false;
		defaultSettings = jQuery.extend(true, {}, settings);
	}

	// See if we need to fetch the settings once again from the Duet
	if (settings.settingsOnDuet) {
		$.ajax(ajaxPrefix + "dwc.json", {
			type: "GET",
			dataType: "json",
			global: false,
			error: function(jqxhr, xhrsettings, thrownError) {
				needsInitialSettingsUpload = (jqxhr.status == 404);
				settingsLoaded();
			},
			success: function(response) {
				for(var key in settings) {
					// Try to copy each setting if their types are equal
					if (response.hasOwnProperty(key) && response[key] != null && settings[key].constructor === response[key].constructor) {
						settings[key] = response[key];
					}
				}
				settingsLoaded();
			}
		});
	} else {
		settingsLoaded();
	}
}

function settingsLoaded() {
	// Apply them
	applySettings();

	// Try to load the translation data
	if (translationData == undefined) {
		$.ajax("language.xml", {
			type: "GET",
			dataType: "xml",
			global: false,
			error: pageLoadComplete,
			success: function(response) {
				translationData = response;

				if (translationData.children == undefined) {
					// Internet Explorer and Edge cannot deal with XML files in the way we want.
					// Disable translations for those browsers.
					translationData = undefined;
					$("#dropdown_language, #label_language").addClass("hidden");
				} else {
					$("#dropdown_language ul > li:not(:first-child)").remove();
					for(var i = 0; i < translationData.children[0].children.length; i++) {
						var id = translationData.children[0].children[i].tagName;
						var name = translationData.children[0].children[i].attributes["name"].value;
						$("#dropdown_language ul").append('<li><a data-language="' + id + '" href="#">' + name + '</a></li>');
						if (settings.language == id) {
							$("#btn_language > span:first-child").text(name);
						}
					}
					translatePage();
				}
				pageLoadComplete();
			}
		});
	}
}

function applySettings() {
	/* Apply settings */

	// Show connect button
	$(".btn-connect").toggleClass("hidden", !settings.showConnect && location.host != "");

	// Set AJAX timeout
	if (settings.maxRetries > 50) { settings.maxRetries = 50; }
	$.ajaxSetup({ timeout: sessionTimeout / (settings.maxRetries + 1) });

	// Webcam
	if (settings.webcamURL != "") {
		$("#panel_webcam").removeClass("hidden");
		$("#img_webcam").toggleClass("hidden", settings.webcamEmbedded);
		$("#div_ifm_webcam").toggleClass("hidden", !settings.webcamEmbedded);

		$("#img_webcam, #ifm_webcam").toggleClass("rotate-90", settings.webcamRotation == 90);
		$("#img_webcam, #ifm_webcam").toggleClass("rotate-180", settings.webcamRotation == 180);
		$("#img_webcam, #ifm_webcam").toggleClass("rotate-270", settings.webcamRotation == 270);
		$("#img_webcam, #ifm_webcam").toggleClass("flip-x", settings.webcamFlip == "x" || settings.webcamFlip == "both");
		$("#img_webcam, #ifm_webcam").toggleClass("flip-y", settings.webcamFlip == "y" || settings.webcamFlip == "both");

		updateWebcam(true);
		updateCalibrationWebcam(true);
	} else {
		$("#panel_webcam").addClass("hidden");
	}

	// Movement steps
	applyMovementSteps();

	// Babystepping
	$("#btn_baby_down > span.content").text(T("{0} mm", (-settings.babysteppingZ)));
	$("#btn_baby_up > span.content").text(T("{0} mm ", "+" + settings.babysteppingZ));
	$(".babystepping").toggleClass("hidden", settings.babysteppingZ <= 0);

	// Show/Hide Fan Controls
	$(".fan-control").toggleClass("hidden", !settings.showFanControl);

	// Show/Hide Fan RPM
	$(".fan-rpm").toggleClass("hidden", !settings.showFanRPM);
	$("#th_probe, #td_probe").css("border-right", settings.showFanRPM ? "" : "0px");

	// Show/Hide ATX Power
	$(".atx-control").toggleClass("hidden", !settings.showATXControl);
	$("#panel_control_misc").toggleClass("hidden", !settings.showFanControl && !settings.showATXControl);

	// Apply or revoke theme
	if (themeInclude != undefined) {
		themeInclude.remove();
		themeInclude = undefined;
	}

	switch (settings.theme) {
		case "default":	// Default Bootstrap theme
			themeInclude = $('<link onload="applyThemeColors();" rel="stylesheet" href="css/bootstrap.theme.css" type="text/css"></link>');
			themeInclude.appendTo("head");
			break;

		case "none":	// No theme at all
			applyThemeColors();
			break;

		default:		// Custom theme
			themeInclude = $('<link onload="applyThemeColors();" rel="stylesheet" href="css/' + settings.theme + '.theme.css" type="text/css"></link>');
			themeInclude.appendTo("head");
			break;

	}

	// Make main content scrollable on md+ screens or restore default behavior
	$("#div_content").css("overflow-y", (settings.scrollContent) ? "auto" : "").resize();

	/* Set values on the Settings page */

	// Set input values
	for(var key in settings) {
		var element = $('[data-setting="' + key + '"]');
		if (element.length != 0) {
			var type = element.attr("type");
			if (type == "checkbox") {
				element.prop("checked", settings[key]);
			} else if (type == "number") {
				var factor = element.data("factor");
				if (factor == undefined) {
					factor = 1;
				}
				element.val(settings[key] / factor);
			} else if (type != "button") {
				element.val(settings[key]);
			}
		}
	}

	// Set theme selection
	$("#btn_theme").data("theme", settings.theme);
	var themeName = settings.theme == "default" ? "Bootstrap" : (settings.theme == "none" ? T("None") : settings.theme);
	$("#btn_theme > span:first-child").text(themeName);

	// Language is set in XML AJAX handler

	// Default head temperatures
	clearHeadTemperatures();
	settings.defaultActiveTemps.forEach(function(temp) {
		addHeadTemperature(temp, "active");
	});
	settings.defaultStandbyTemps.forEach(function(temp) {
		addHeadTemperature(temp, "standby");
	});

	// Default bed temperatures
	clearBedTemperatures();
	settings.defaultBedTemps.forEach(function(temp) {
		addBedTemperature(temp);
	});

	// Force GUI update to apply half Z movements in the axes
	updateGui();
}

function applyMovementSteps() {
	// Check values
	for(var axis = 0; axis < settings.axisMoveSteps.length; axis++) {
		if (settings.axisMoveSteps[axis].length < 5) {
			settings.axisMoveSteps[axis].splice(1, 0, (axis == 2) ? 25 : 50);
		}
	}

	// Axis apperance
	for(var i = 0; i < axisNames.length; i++) {
		// Set Home button names+titles
		var axis = axisNames[i];
		var axisIndex = axisOrder.indexOf(axis);
		$(".btn-home[data-axis='" + i + "']").text(T("Home " + axis)).prop("title", T("Home " + axis + " axis (G28 " + axis + ")"));

		// Set labels and values for decrease and increase buttons
		var buttonIndex = 0;
		$("#page_control a.btn-move[data-axis='" + i + "'][data-amount^='-']").each(function() {
			var decreaseVal = -settings.axisMoveSteps[axisIndex][buttonIndex++];
			$(this).data("amount", decreaseVal).contents().last().replaceWith(" " + axis + decreaseVal);
		});
		buttonIndex = 0;
		$("#modal_messagebox button.btn-move[data-axis-letter='" + axis + "'][data-amount^='-']").each(function() {
			var decreaseVal = -settings.axisMoveSteps[axisIndex][buttonIndex++];
			$(this).data("amount", decreaseVal).children("span:last-child").text(axis + decreaseVal);
		});
		buttonIndex = 0;
		$("#modal_start_scan button.btn-move[data-axis-letter='" + axis + "'][data-amount^='-']").each(function() {
			var decreaseVal = -settings.axisMoveSteps[axisIndex][buttonIndex++];
			$(this).data("amount", decreaseVal).children("span:last-child").text(axis + decreaseVal);
		});

		buttonIndex = settings.axisMoveSteps[axisIndex].length - 1;
		$("#page_control a.btn-move[data-axis='" + i + "']:not([data-amount^='-'])").each(function() {
			var increaseVal = settings.axisMoveSteps[axisIndex][buttonIndex--];
			$(this).data("amount", increaseVal).contents().first().replaceWith(axis + "+" + increaseVal + " ");
		});
		buttonIndex = settings.axisMoveSteps[axisIndex].length - 1;
		$("#modal_messagebox button.btn-move[data-axis-letter='" + axis + "']:not([data-amount^='-'])").each(function() {
			var increaseVal = settings.axisMoveSteps[axisIndex][buttonIndex--];
			$(this).data("amount", increaseVal).children("span:first-child").text(axis + "+" + increaseVal);
		});
		buttonIndex = settings.axisMoveSteps[axisIndex].length - 1;
		$("#modal_start_scan button.btn-move[data-axis-letter='" + axis + "']:not([data-amount^='-'])").each(function() {
			var increaseVal = settings.axisMoveSteps[axisIndex][buttonIndex--];
			$(this).data("amount", increaseVal).children("span:first-child").text(axis + "+" + increaseVal);
		});

		// Set headers for position cells in the Machine Status panel
		$(".table-axis-positions th[data-axis='" + i + "']").text(axisNames[i]);
	}

	// Extruder amounts
	var amountIndex = 0;
	$("#div_feed > div.btn-group > label").each(function() {
		var amount = settings.extruderAmounts[amountIndex++];
		$(this).children("input").prop("value", amount);
		$(this).children("span").text(amount);
	});

	// Extruder feedrates
	var feedrateIndex = 0;
	$("#div_feedrate > div.btn-group > label").each(function() {
		var feedrate = settings.extruderFeedrates[feedrateIndex++];
		$(this).children("input").prop("value", feedrate);
		$(this).children("span").text(feedrate);
	});
}

function saveSettings() {
	// Get input values
	for(var key in settings) {
		var element = $('[data-setting="' + key + '"]');
		if (element.length != 0) {
			var type = element.attr("type");
			if (type == "checkbox") {
				settings[key] = element.is(":checked");
			} else if (type == "number") {
				var min = element.data("min");
				var max = element.data("max");
				var factor = element.data("factor");
				if (factor == undefined) {
					factor = 1;
				}
				settings[key] = constrainSetting(element.val() * factor, defaultSettings[key], min, max);
			} else {
				settings[key] = element.val();
			}
		}
	}

	// Save theme
	settings.theme = $("#btn_theme").data("theme");

	// Save language
	if (settings.language != $("#btn_language").data("language")) {
		showMessage("success", T("Language has changed"), T("You have changed the current language. Please reload the web interface to apply this change."), 0);
	}
	settings.language = $("#btn_language").data("language");

	// G-Codes for autocompletion
	rememberedGCodes = [];
	$("#table_gcodes > tbody > tr").each(function() {
		rememberedGCodes.push($(this).find("th:eq(0)").text());
	});
	saveGCodes();

	// Default Heater Temperatures
	settings.defaultActiveTemps = [];
	$("#ul_active_temps > li").each(function() {
		settings.defaultActiveTemps.push($(this).data("temperature"));
	});
	settings.defaultActiveTemps = settings.defaultActiveTemps.sort(function(a, b) { return a - b; });
	settings.defaultStandbyTemps = [];
	$("#ul_standby_temps > li").each(function() {
		settings.defaultStandbyTemps.push($(this).data("temperature"));
	});
	settings.defaultStandbyTemps = settings.defaultStandbyTemps.sort(function(a, b) { return a - b; });

	// Default Bed Temperatures
	settings.defaultBedTemps = [];
	$("#ul_bed_temps > li").each(function() {
		settings.defaultBedTemps.push($(this).data("temperature"));
	});
	settings.defaultBedTemps = settings.defaultBedTemps.sort(function(a, b) { return a - b; });

	// Save Settings
	setLocalSetting("settings", settings);
	if (settings.settingsOnDuet) {
		uploadTextFile("0:/www/dwc.json", JSON.stringify(settings), function() {
			// Tell DWC clients to reload its config
			sendGCode("M118 P3 S\"{reloadSettings}\"", false);
		}, false);
	}
}

function constrainSetting(value, defaultValue, minValue, maxValue) {
	if (isNaN(value)) {
		return defaultValue;
	}
	if (value < minValue) {
		return minValue;
	}
	if (value > maxValue) {
		return maxValue;
	}

	return value;
}


/* Remembered G-Codes */

function loadGCodes() {
	rememberedGCodes = getLocalSetting("rememberedGCodes", defaultGCodes);
	applyGCodes();
}

function applyGCodes() {
	$("#table_gcodes > tbody").children().remove();
	for(var index in rememberedGCodes) {
		var item =  '<tr><th>' + rememberedGCodes[index] + '</th><td>';
		item += '<button class="btn btn-sm btn-danger btn-delete-parent" title="' + T("Delete this G-Code item") + '">';
		item += '<span class="glyphicon glyphicon-trash"></span></button></td></tr>';
		$("#table_gcodes > tbody").append(item);
	}
}

function saveGCodes() {
	setLocalSetting("rememberedGCodes", rememberedGCodes);
}


/* Setting events */

// Apply & Reset settings

$(".btn-reset-settings").click(function(e) {
	showConfirmationDialog(T("Reset Settings"), T("Are you sure you want to revert to Factory Settings?"), function() {
		if (defaultSettings.language != settings.language) {
			showMessage("info", T("Language has changed"), T("You have changed the current language. Please reload the web interface to apply this change."), 0);
		}

		settings = jQuery.extend(true, {}, defaultSettings);
		if (vendor != undefined) {
			$.ajax(ajaxPrefix + "dwc_factory.json", {
				type: "GET",
				dataType: "json",
				global: false,
				error: function(jqxhr, xhrsettings, thrownError) {
					settings = jQuery.extend(true, {}, defaultSettings);
					settingsLoaded();
				},
				success: function(response) {
					for(var key in settings) {
						// Try to copy each setting if their types are equal
						if (response.hasOwnProperty(key) && response[key] != null && settings[key].constructor === response[key].constructor) {
							settings[key] = response[key];
						}
					}
					settingsLoaded();
				}
			});
		} else {
			$("#btn_language").data("language", "en").children("span:first-child").text("English");
			$("#btn_theme").data("theme", "default").children("span:first-child").text(T("Bootstrap"));

			applySettings();
			saveSettings();
		}

		rememberedGCodes = jQuery.extend(true, {}, defaultGCodes);
		applyGCodes();
		saveGCodes();

		removeLocalSetting("extraSensorVisibility");
		resetChartData();

		removeLocalSetting("cachedFileInfo");
	});
	e.preventDefault();
});

$("#frm_settings").submit(function(e) {
	e.preventDefault();
	if ($(".btn-apply-settings").hasClass("disabled")) {
		return;
	}

	saveSettings();
	if (!settings.settingsOnDuet) {
		applySettings();
		showMessage("success", "", "<strong>" + T("Settings applied!") + "</strong>");
	}
	applyGCodes();
});

$("#frm_settings > ul > li a").on("shown.bs.tab", function(e) {
	$("#frm_settings > ul li").removeClass("active");
	var links = $('#frm_settings > ul > li a[href="' + $(this).attr("href") + '"]');
	$.each(links, function() {
		$(this).parent().addClass("active");
	});
});

// User Interface

$("#dropdown_theme > ul").on("click", "a", function(e) {
	$("#btn_theme > span:first-child").text($(this).text());
	$("#btn_theme").data("theme", $(this).data("theme"));
	e.preventDefault();
});

$("#dropdown_language > ul").on("click", "a", function(e) {
	$("#btn_language > span:first-child").text($(this).text());
	$("#btn_language").data("language", $(this).data("language"));
	e.preventDefault();
});

$('a[href="#page_ui"]').on('shown.bs.tab', function () {
	$("#btn_clear_cache").toggleClass("disabled", $.isEmptyObject(cachedFileInfo));
});

$("#btn_clear_cache").click(function(e) {
	gcodeUpdateIndex = -1;
	clearFileCache();
	$("#btn_clear_cache").addClass("disabled");
	e.preventDefault();
});

$("[data-setting='useHtmlNotifications']").change(function() {
	if ($(this).prop("checked")) {
		if (!("Notification" in window)) {
			// Don't allow this option to be set if the browser doesn't support it
			$(this).prop("checked", false);
			alert(T("This browser does not support desktop notification"));
		}
		else if (Notification.permission !== 'denied') {
			$(this).prop("checked", false);
			Notification.requestPermission(function(permission) {
				if (!('permission' in Notification)) {
					Notification.permission = permission;
				}

				if (permission === "granted") {
					// Don't allow this option to be set unless permission has been granted
					$("[data-setting='useHtmlNotifications']").prop("checked", true);
				}
			});
		}
	}
});

$("[data-setting='settingsOnDuet']").change(function() {
	$(".btn-apply-settings, .btn-reset-settings").toggleClass("disabled", !isConnected && $(this).is(":checked"));
});

// List Items

$("input[name='temp_selection']:radio").change(function() {
	if ($(this).val() == "active") {
		$("#ul_active_temps").removeClass("hidden");
		$("#ul_standby_temps").addClass("hidden");
	} else {
		$("#ul_standby_temps").removeClass("hidden");
		$("#ul_active_temps").addClass("hidden");
	}
});

$("#btn_add_head_temp").click(function(e) {
	var temperature = constrainSetting($("#input_add_head_temp").val(), 0, -273.15, 300);
	var type = $('input[name="temp_selection"]:checked').val();

	var item =	'<li class="list-group-item col-xs-6 col-lg-3" data-temperature="' + temperature + '">' + temperature + ' Â°C';
	item +=		'<button class="btn btn-danger btn-sm btn-delete-parent pull-right" title="' + T("Delete this temperature item") + '">';
	item +=		'<span class="glyphicon glyphicon-trash"></span></button></li>';
	$("#ul_" + type + "_temps").append(item);

	e.preventDefault();
});

$("#btn_add_bed_temp").click(function(e) {
	var temperature = constrainSetting($("#input_add_bed_temp").val(), 0, -273.15, 180);

	var item =	'<li class="list-group-item col-md-6" data-temperature="' + temperature + '">' + temperature + ' Â°C';
	item +=		'<button class="btn btn-danger btn-sm btn-delete-parent pull-right" title="' + T("Delete this temperature item") + '">';
	item +=		'<span class="glyphicon glyphicon-trash"></span></button></li>';
	$("#ul_bed_temps").append(item);

	e.preventDefault();
});

$("body").on("click", ".btn-delete-parent", function(e) {
	$(this).parents("tr, li").remove();
	e.preventDefault();
});

$("#page_listitems input").on("input", function() {
	$("#btn_add_head_temp").toggleClass("disabled", isNaN(parseFloat($("#input_add_head_temp").val())));
	$("#btn_add_bed_temp").toggleClass("disabled", isNaN(parseFloat($("#input_add_bed_temp").val())));
});

$("#page_listitems input").keydown(function(e) {
	if (e.which == 13) {
		var button = $(this).closest("div:not(.input-group):eq(0)").find("button");
		if (!button.hasClass("disabled")) {
			button.click();
		}
		e.preventDefault();
	}
});

// Machine Properties

$("#btn_fw_diagnostics").click(function() {
	if (isConnected) {
		sendGCode("M122");
		showPage("console");
	}
});

// Tools

$("#btn_add_tool").click(function(e) {
	var gcode = "M563 P" + $("#input_tool_number").val() + " S\"" + $("#input_tool_name").val() + "\"";

	var drives = $("input[name='tool_drives']:checked");
	if (drives.length > 0) {
		var driveList = [];
		drives.each(function() { driveList.push($(this).val()); });
		gcode += " D" + driveList.reduce(function(a, b) { return a + ":" + b; });
	}

	var heaters = $("input[name='tool_heaters']:checked");
	if (heaters.length > 0) {
		var heaterList = [];
		heaters.each(function() { heaterList.push($(this).val()); });
		gcode += " H" + heaterList.reduce(function(a, b) { return a + ":" + b; });
	}

	sendGCode(gcode);
	extendedStatusCounter = settings.extendedStatusInterval;

	e.preventDefault();
});

// Display toggle for settings sub-pages

$('a[href="#page_general"], a[href="#page_ui"], a[href="#page_listitems"]').on('shown.bs.tab', function () {
	$("#row_save_settings").removeClass("hidden");
});

$('a[href="#page_machine"], a[href="#page_tools"], a[href="#page_sysedit"], a[href="#page_display"]').on('shown.bs.tab', function () {
	$("#row_save_settings").addClass("hidden");
});

/* Slider implementation for the Duet Web Control
 * 
 * written by Christian Hammacher (c) 2016-2018
 * 
 * licensed under the terms of the GPL v3
 * see http://www.gnu.org/licenses/gpl-3.0.html
 */


var fanSliderActive = undefined, speedSliderActive = false, extrSliderActive = false;
var overriddenFanValues = [undefined, undefined, undefined, undefined, undefined, undefined, undefined, undefined, undefined];	// this must hold maxFans items


/* Fan Control */

for(var fan = -1; fan < maxFans; fan++) {
	var fanID = (fan == -1) ? "tool" : fan;
	$('#slider_fan_control_' + fanID).slider({
		enabled: false,
		id: "fan_control_" + fanID,
		min: 0,
		max: 100,
		step: 1,
		value: 35,
		tooltip: "always",
		formatter: function(value) {
			return value + " %";
		}
	}).on("slideStart", function() {
		fanSliderActive = $(this).parents("tr").data("fan");
	}).on("slideStop", function(slideEvt) {
		if (isConnected && !isNaN(slideEvt.value)) {
			var fanID = $(this).parents("tr").data("fan");
			var fanValue = slideEvt.value / 100.0;
			if (fanID == "tool") {
				// Generic tool fan is selected
				sendGCode("M106 S" + fanValue);
			} else {
				// Specific fan is selected
				if (overriddenFanValues[fanID] != undefined) {
					overriddenFanValues[fanID] = fanValue;
				}
				sendGCode("M106 P" + fanID + " S" + fanValue);
			}
			$("#slider_fan_job_" + fanID).slider("setValue", slideEvt.value);
		}
		fanSliderActive = undefined;
	});

	$('#slider_fan_job_' + fanID).slider({
		enabled: false,
		id: "fan_job_" + fanID,
		min: 0,
		max: 100,
		step: 1,
		value: 35,
		tooltip: "always",
		formatter: function(value) {
			return value + " %";
		}
	}).on("slideStart", function() {
		fanSliderActive = $(this).parents("tr").data("fan");
	}).on("slideStop", function(slideEvt) {
		if (isConnected && !isNaN(slideEvt.value)) {
			var fanID = $(this).parents("tr").data("fan");
			var fanValue = slideEvt.value / 100.0;
			if (fanID == "tool") {
				// Generic tool fan is selected
				sendGCode("M106 S" + fanValue);
			} else {
				// Specific fan is selected
				if (overriddenFanValues[fanID] != undefined) {
					overriddenFanValues[fanID] = fanValue;
				}
				sendGCode("M106 P" + fanID + " S" + fanValue);
			}
			$("#slider_fan_control_" + fanID).slider("setValue", slideEvt.value);
		}
		fanSliderActive = undefined;
	});
}

function setFanVisibility(fan, visible) {
	// set visibility of the corresponding control button
	$('.table-fan-control tr[data-fan="' + fan + '"]').toggleClass("hidden", !visible);

	// if this fan's value was being enforced, undo it
	setFanOverride(fan, undefined);
}

function setFanOverride(fan, overriddenValue) {
	// set model value
	overriddenFanValues[fan] = overriddenValue;

	// update UI
	var overridden = (overriddenValue != undefined);
	var toggleButton = $('.table-fan-control tr[data-fan="' + fan + '"] button.fan-override');
	toggleButton.toggleClass("btn-primary", overridden).toggleClass("btn-default", !overridden);
	toggleButton.toggleClass("active", overridden);
}

$("button.fan-visibility").click(function() {
	var fan = $(this).parents("tr").data("fan");
	setFanDisplayed(fan, !$(this).hasClass("active"));
});

$("button.fan-override").click(function() {
	if ($(this).hasClass("disabled")) {
		return;
	}

	var fan = $(this).parents("tr").data("fan");
	if (overriddenFanValues[fan] == undefined) {
		var sliderValue = $(this).parents("tr").find(".fan-slider > input").slider("getValue");
		setFanOverride(fan, sliderValue / 100.0);
	} else {
		setFanOverride(fan, undefined);
	}
});

function loadFanVisibility() {
	var fanVisibility = getLocalSetting("fanVisibility", null);
	if (fanVisibility != null) {
		for(var fan = 0; fan <= maxFans; fan++) {
			if (fan == 0) {
				setFanDisplayed("tool", (fanVisibility & 1) != 0);
			} else {
				setFanDisplayed(fan - 1, (fanVisibility & (1 << fan)) != 0);
			}
		}
	}
}

function setFanDisplayed(fan, show) {
	if (show) {
		$(".table-fan-control tr[data-fan='" + fan + "'] button.fan-visibility").removeClass("btn-default").addClass("btn-primary active");
		$(".table-fan-control tr[data-fan='" + fan + "'] button.fan-override").toggleClass("disabled", !isConnected);
		$(".table-fan-control tr[data-fan='" + fan + "'] > td:last-child").children().removeClass("hidden");

		// Restore correct value
		if (fan != "tool") {
			var fanValue = overriddenFanValues[fan];
			if (fanValue == undefined && lastStatusResponse != undefined) {
				// this is only called if the firmware reports fan values as an array
				fanValue = lastStatusResponse.params.fanPercent[fan] / 100.0;
			}

			if (fanValue != undefined) {
				$("tr[data-fan='" + fan + "'] .fan-slider > input").slider("setValue", fanValue * 100.0);
			}
		} else {
			$("tr[data-fan='tool'] .fan-slider > input").slider("relayout");
		}
	} else {
		$(".table-fan-control tr[data-fan='" + fan + "'] button.fan-visibility").removeClass("btn-primary active").addClass("btn-default");
		$(".table-fan-control tr[data-fan='" + fan + "'] button.fan-override").addClass("disabled");
		$(".table-fan-control tr[data-fan='" + fan + "'] > td:last-child").children().addClass("hidden");

		if (fan != "tool") {
			setFanOverride(fan, undefined);
		}
	}

	// Save the fan visibility states
	var visibilityBitmap = 0;
	for(var fan = 0; fan <= maxFans; fan++) {
		if (fan == 0) {
			if ($(".table-fan-control tr[data-fan='tool'] button.fan-visibility").hasClass("active")) {
				visibilityBitmap |= 1;
			}
		} else if ($(".table-fan-control tr[data-fan='" + (fan - 1) + "'] button.fan-visibility").hasClass("active")) {
			visibilityBitmap |= (1 << fan);
		}
	}
	setLocalSetting("fanVisibility", visibilityBitmap);
}


/* Extrusion Multiplier */

for(var extr = 0; extr < maxExtruders; extr++) {
	$('#slider_extr_' + extr).slider({
		enabled: false,
		id: "extr-" + extr,
		min: 50,
		max: 150,
		step: 1,
		value: 100,
		tooltip: "always",
		formatter: function(value) {
			return value + " %";
		}
	}).on("slideStart", function() {
		extrSliderActive = true;
	}).on("slideStop", function(slideEvt) {
		if (isConnected && !isNaN(slideEvt.value)) {
			sendGCode("M221 D" + $(this).data("drive") + " S" + slideEvt.value);
		}
		extrSliderActive = false;
	});
}


/* Speed slider */

$('#slider_speed').slider({
	enabled: false,
	id: "speed",
	min: 20,
	max: 300,
	step: 1,
	value: 100,
	tooltip: "always",
	formatter: function(value) {
		return value + " %";
	}
}).on("slideStart", function() {
	speedSliderActive = true;
}).on("slideStop", function(slideEvt) {
	if (isConnected && !isNaN(slideEvt.value)) {
		sendGCode("M220 S" + slideEvt.value);
	}
	speedSliderActive = false;
});
/* Upload handling for Duet Web Control
 * 
 * written by Christian Hammacher (c) 2016-2017
 * 
 * licensed under the terms of the GPL v3
 * see http://www.gnu.org/licenses/gpl-3.0.html
 */


var isUploading = false;					// Is a file upload in progress?

var uploadType, uploadFiles, uploadRows, uploadedFileCount;
var uploadTotalBytes, uploadedTotalBytes;
var uploadStartTime, uploadRequest, uploadFileSize, uploadFileName, uploadPosition;
var uploadedDWC, uploadIncludedConfig, uploadFirmwareFile, uploadDWCFile, uploadDWSFile, uploadDWSSFile;
var uploadHadError, uploadFilesSkipped, refreshSysFiles;

var firmwareFileName = "RepRapFirmware";	// Name of the firmware file without .bin extension
var targetFirmwareFileName = firmwareFileName;


function uploadTextFile(filename, content, callback, showNotification, configFileHandled) {
	if (showNotification == undefined) { showNotification = true; }
	if (configFileHandled == undefined) { configFileHandled = false; }

	// Move config.g to config.g.bak if it is overwritten
	if (filename == "0:/sys/config.g" && !configFileHandled && $("#table_sys_files tr[data-file='config.g']").length != 0) {
		$.ajax(ajaxPrefix + "rr_move?old=0:/sys/config.g&new=0:/sys/config.g.bak&deleteexisting=yes", {
			dataType: "json",
			success: function() {
				uploadTextFile(filename, content, callback, showNotification, true);
			}
		});
		return;
	}

	// Stop status updates as long as files are being transferred (should not be needed but leave it here because some users reported issues)
	stopUpdates();

	// Ideally we should use FileAPI here, but IE+Edge don't support it
	//var file = new File([content], filename, { type: "application/octet-stream" });
	var file = new Blob([content], { type: "application/octet-stream" });
	file.name = filename;
	file.lastModified = (new Date()).getTime();

	var uploadRequest = $.ajax(ajaxPrefix + "rr_upload?name=" + encodeURIComponent(filename) + "&time=" + encodeURIComponent(timeToStr(new Date())), {
		data: file,
		dataType: "json",
		processData: false,
		contentType: false,
		timeout: 0,
		type: "POST",
		global: false,
		error: function(jqXHR, textStatus, errorThrown) {
			if (errorThrown == "abort") {
				// Ignore this error if this request was cancelled intentionally
				return;
			}

			// Retry upload if this file is smaller than 1MiB
			if (file.size < 1048576) {
				if (!this.hasOwnProperty("retryCount")) {
					this.retryCount = 1;
				} else {
					this.retryCount++;
				}

				if (this.retryCount <= settings.maxRetries) {
					$.ajax(this);
					return;
				}
			}

			// Resume status updates and report and error if that failed
			startUpdates();
			showMessage("danger", T("Error"), T("Could not update file {0}!", filename));
			console.log("Text file upload failed!\nStatus: " + textStatus + "\nError: " + errorThrown);
		},
		success: function(response) {
			if (response.err == 0) {
				if (showNotification) {
					showMessage("success", T("File Updated"), T("The file {0} has been successfully uploaded.", filename));
					if (lastStatusResponse != undefined && lastStatusResponse.status == 'I') {
						if (filename.toLowerCase() == "0:/sys/config.g") {
							showConfirmationDialog(T("Reboot Duet?"), T("You have just uploaded a config file. Would you like to reboot your Duet now?"), function() {
								// Perform software reset
								sendGCode("M999");
							});
						}
					}
				}
			} else {
				showMessage("danger", T("Error"), T("Could not update file {0}!", filename));
			}

			startUpdates();
			if (callback != undefined) {
				callback();
			}
		}
	});
}

function startUpload(type, files, fromCallback) {
	// Unzip files if necessary
	if (type == "filament" || type == "macro" || type == "generic") {
		var containsZip = false;
		$.each(files, function() {
			if (this.name.toLowerCase().match("\\.zip$") != null) {
				uploadedDWC |= this.name.toLowerCase().match("^duetwebcontrol.*\\.zip") != null;

				var fileReader = new FileReader();
				fileReader.onload = (function(theFile) {
					return function(e) {
						try {
							var zipFile = new JSZip(), filesToUnpack = 0, filesUnpacked = 0;
							zipFile.loadAsync(e.target.result).then(function(zip) {
								var zipFiles = [];
								$.each(zip.files, function(index, zipEntry) {
									if (!zipEntry.dir && zipEntry.name.indexOf(".") != 0 && zipEntry.name.match("README") == null) {
										var zipName = zipEntry.name;
										if (type != "filament") {
											zipName = zipEntry.name.split("/");
											zipName = zipName[zipName.length - 1];
										}

										filesToUnpack++;
										zipEntry.async("arraybuffer").then(function(buffer) {
											// See above. FileAPI isn't supported by IE+Edge
											//var unpackedFile = new File([zipEntry.asArrayBuffer()], zipName, { type: "application/octet-stream", lastModified: zipEntry.date });
											var unpackedFile = new Blob([buffer], { type: "application/octet-stream" });
											unpackedFile.name = zipName;
											unpackedFile.lastModified = zipEntry.date;
											zipFiles.push(unpackedFile);

											filesUnpacked++;
											if (filesToUnpack == filesUnpacked) {
												// This had to be moved because the new JSZip API is completely async
												startUpload(type, zipFiles, true);
											}
										});
									}
								});

								if (zip.files.length == 0) {
									showMessage("warning", T("Error"), T("The archive {0} does not contain any files!", theFile.name));
								}
							});
						} catch(e) {
							console.log("ZIP error: " + e);
							showMessage("danger", T("Error"), T("Could not read contents of file {0}!", theFile.name));
						}
					}
				})(this);
				fileReader.readAsArrayBuffer(this);

				containsZip = true;
				return false;
			}
		});

		if (containsZip) {
			// We're relying on an async task which will trigger this method again when required
			return false;
		}
	}

	// Safety check for Upload and Start
	if (type == "start" && files.length > 1) {
		showMessage("warning", T("Error"), T("You can only upload and start one file at once!"));
		return false;
	}

	// Safety check for Filament uploads
	if (type == "filament") {
		var hadError = false;
		$.each(files, function() {
			if (this.name.indexOf("/") == -1) {
				showMessage("danger", T("Error"), T("You cannot upload single files. Please upload only ZIP files that contain at least one directory per filament configuration."));
				hadError = true;
				return false;
			}
		});
		if (hadError) {
			return false;
		}
	}

	// Initialize some values
	stopUpdates();
	isUploading = true;
	uploadType = type;
	uploadTotalBytes = uploadedTotalBytes = uploadedFileCount = 0;
	uploadFiles = files;
	$.each(files, function() {
		uploadTotalBytes += this.size;
	});
	uploadRows = [];
	if (!fromCallback) {
		uploadedDWC = false;
	}
	uploadIncludedConfig = false;
	uploadFirmwareFile = uploadDWCFile = uploadDWSFile = uploadDWSSFile = undefined;
	uploadFilesSkipped = uploadHadError = refreshSysFiles = false;

	// Reset modal dialog
	$("#modal_upload").data("backdrop", "static");
	$("#modal_upload .close, #modal_upload button[data-dismiss='modal']").addClass("hidden");
	$("#btn_cancel_upload, #modal_upload p").removeClass("hidden");
	$("#modal_upload h4").text(T("Uploading File(s), {0}% Complete", 0));

	// Add files to the table
	$("#table_upload_files > tbody").children().remove();
	$.each(files, function() {
		if (type == "generic") {
			// config and firmware files can be always uploaded
			uploadIncludedConfig |= (this.name == "config.g");
			if (this.name.toUpperCase().match("^" + firmwareFileName.toUpperCase() + ".*\.BIN") != null) {
				uploadFirmwareFile = this.name;
				targetFirmwareFileName = firmwareFileName;
			}
			else if (allowCombinedFirmware && this.name.toUpperCase().match("^DUET2COMBINEDFIRMWARE.*\.BIN") != null) {
				uploadFirmwareFile = this.name;
				targetFirmwareFileName = "Duet2CombinedFirmware";
			}

			// See if a new DWC version is being installed
			uploadedDWC |= this.name.indexOf("reprap.htm") != -1;

			// DuetWiFi-specific files can be used only on a Duet WiFi
			if (boardType.indexOf("duetwifi") == 0) {
				if (this.name.toUpperCase().match("^DUETWIFISOCKETSERVER.*\.BIN") != null) {
					uploadDWSSFile = this.name;
				} else if (this.name.toUpperCase().match("^DUETWIFISERVER.*\.BIN") != null) {
					uploadDWSFile = this.name;
				} else if (this.name.toUpperCase().match("^DUETWEBCONTROL.*\.BIN") != null) {
					uploadDWCFile = this.name;
				}
			}
		}

		var row = 	'<tr><td><span class="glyphicon glyphicon-asterisk"></span> ' + this.name + '</td>';
		row += 		'<td>' + formatSize(this.size) + '</td>';
		row +=		'<td><div class="progress"><div class="progress-bar progress-bar-info progress-bar-striped"><span></span></div></div></td></tr>';

		var rowElem = $(row);
		rowElem.appendTo("#table_upload_files > tbody");
		uploadRows.push(rowElem);
	});
	$("#modal_upload").modal("show");

	// Start file upload
	uploadNextFile();
}

function uploadNextFile() {
	// Prepare some upload values
	var file = uploadFiles[uploadedFileCount];
	uploadFileName = file.name;
	uploadFileSize = file.size;
	uploadStartTime = new Date();
	uploadPosition = 0;

	// Check if this file should be skipped
	if (uploadType == "generic") {
		var skipFile = false;

		if (!filenameValid(uploadFileName)) {
			// Skip files that contain invalid characters
			skipFile = true;
			showMessage("danger", T("Error"), T("The specified filename is invalid. It may not contain quotes, colons or (back)slashes."));
		} else if (boardType.indexOf("duetwifi") != 0) {
			var lcName = uploadFileName.toLowerCase();

			// Skip DuetWebControl*.bin on wired Duets
			if (lcName.match("^duetwebcontrol.*\\.bin") != null) {
				skipFile = true;
			}

			// Skip DuetWiFiServer*.bin and DuetWiFiSocketServer*.bin on wired Duets
			if (lcName.match("^duetwifiserver.*\\.bin") != null || lcName.match("^duetwifisocketserver.*\\.bin") != null) {
				skipFile = true;
			}
		}

		if (skipFile) {
			fileUploadSkipped();
			return;
		}
	}

	// Determine the right path
	var targetPath = "";
	switch (uploadType) {
		case "gcode":	// Upload G-Code
		case "start":	// Upload & Start G-Code
			targetPath = currentGCodeDirectory + "/" + uploadFileName;
			clearFileCache(targetPath);
			break;

		case "macro":	// Upload Macro
			targetPath = currentMacroDirectory + "/" + uploadFileName;
			break;

		case "filament": // Filament (only to sub-directories)
			targetPath = "0:/filaments/" + uploadFileName;
			break;

		case "menu":	// Upload Display items
			targetPath = "0:/menu/" + uploadFileName;
			break;

		default:		// Generic Upload (on the Settings page)
			var fileExts = uploadFileName.split('.');
			var fileExt = fileExts.pop().toLowerCase();
			if (fileExt == "gz") {
				// If this file was compressed, try to get the actual extension
				fileExt = fileExts.pop();
			}

			switch (fileExt) {
				case "ico":
				case "html":
				case "htm":
				case "xml":
					targetPath = "0:/www/" + uploadFileName;
					break;

				case "css":
				case "map":
					targetPath = "0:/www/css/" + uploadFileName;
					break;

				case "eot":
				case "svg":
				case "ttf":
				case "woff":
				case "woff2":
					targetPath = "0:/www/fonts/" + uploadFileName;
					break;

				case "jpeg":
				case "jpg":
				case "png":
					targetPath = "0:/www/img/" + uploadFileName;
					break;

				case "js":
					targetPath = "0:/www/js/" + uploadFileName;
					break;

				default:
					targetPath = "0:/sys/" + uploadFileName;
					refreshSysFiles = true;
					break;
			}
	}

	// Update the GUI
	uploadRows[uploadedFileCount].find(".progress-bar > span").text(T("Starting"));
	uploadRows[uploadedFileCount].find(".glyphicon").removeClass("glyphicon-asterisk").addClass("glyphicon-cloud-upload");

	// Begin another POST file upload
	uploadRequest = $.ajax(ajaxPrefix + "rr_upload?name=" + encodeURIComponent(targetPath) + "&time=" + encodeURIComponent(timeToStr(new Date(file.lastModified))), {
		data: file,
		dataType: "json",
		processData: false,
		contentType: false,
		timeout: 0,
		type: "POST",
		global: false,
		error: function(jqxhr, textStatus, errorThrown) {
			if (errorThrown == "abort") {
				// Ignore this error if this request was cancelled intentionally
				return;
			}

			// Retry upload if this file is smaller than 1MiB
			if (file.size < 1048576) {
				if (!this.hasOwnProperty("retryCount")) {
					this.retryCount = 1;
				} else {
					this.retryCount++;
				}

				if (this.retryCount <= settings.maxRetries) {
					uploadRows[uploadedFileCount].find(".progress-bar").removeClass("progress-bar-info").addClass("progress-bar-warning");
					uploadRows[uploadedFileCount].find(".progress-bar > span").text(T("Retrying"));

					$.ajax(this);
					return;
				}
			}

			// If that failed or if the file was bigger than 1MiB, report an error
			finishCurrentUpload(false);
		},
		success: function(data) {
			if (isUploading) {
				finishCurrentUpload(data.err == 0);
			}
		},
		xhr: function() {
			var xhr = new window.XMLHttpRequest();
			xhr.upload.addEventListener("progress", function(event) {
				if (isUploading && event.lengthComputable) {
					// Calculate current upload speed (Date is based on milliseconds)
					uploadSpeed = event.loaded / (((new Date()) - uploadStartTime) / 1000);

					// Update global progress
					uploadedTotalBytes += (event.loaded - uploadPosition);
					uploadPosition = event.loaded;

					var uploadTitle = T("Uploading File(s), {0}% Complete", ((uploadedTotalBytes / uploadTotalBytes) * 100).toFixed(0));
					if (uploadSpeed > 0) {
						uploadTitle += " (" + formatUploadSpeed(uploadSpeed) + ")";
					}
					$("#modal_upload h4").text(uploadTitle);

					// Update progress bar
					var progress = ((event.loaded / event.total) * 100).toFixed(0);
					uploadRows[uploadedFileCount].find(".progress-bar").css("width", progress + "%");
					uploadRows[uploadedFileCount].find(".progress-bar > span").text(progress + " %");
				}
			}, false);
			return xhr;
		}
	});
}

function finishCurrentUpload(success) {
	// Keep the progress updated
	if (!success) {
		uploadHadError = true;
		uploadedTotalBytes += (uploadFileSize - uploadPosition);
	}

	// Update glyphicon and progress bar
	uploadRows[uploadedFileCount].find(".glyphicon").removeClass("glyphicon-cloud-upload").addClass(success ? "glyphicon-ok" : "glyphicon-alert");
	uploadRows[uploadedFileCount].find(".progress-bar").removeClass("progress-bar-info progress-bar-warning").addClass(success ? "progress-bar-success" : "progress-bar-danger").css("width", "100%");
	uploadRows[uploadedFileCount].find(".progress-bar > span").text(success ? "100 %" : T("ERROR"));

	// Go on with upload logic if we're still busy
	if (isUploading) {
		uploadedFileCount++;
		if (uploadFiles.length > uploadedFileCount) {
			// Upload the next file
			uploadNextFile();
		} else {
			// No more files to upload - we're done
			finishUpload(!uploadHadError);
		}
	}
}

function fileUploadSkipped() {
	// Keep the progress updated
	uploadedTotalBytes += (uploadFileSize - uploadPosition);

	// Update glyphicon and progress bar
	uploadRows[uploadedFileCount].find(".glyphicon").removeClass("glyphicon-cloud-asterisk").addClass("glyphicon-warning-sign");
	uploadRows[uploadedFileCount].find(".progress-bar").removeClass("progress-bar-info").addClass("progress-bar-warning").css("width", "100%");
	uploadRows[uploadedFileCount].find(".progress-bar > span").text(T("SKIPPED"));

	// Go on with upload logic if we're still busy
	uploadFilesSkipped = true;
	if (isUploading) {
		uploadedFileCount++;
		if (uploadFiles.length > uploadedFileCount) {
			// Upload the next file
			uploadNextFile();
		} else {
			// No more files to upload - we're done
			finishUpload(true);
		}
	}
}

function cancelUpload() {
	isUploading = uploadFilesSkipped = false;
	finishCurrentUpload(false);
	uploadRequest.abort();
	finishUpload(false);
	$("#modal_upload h4").text(T("Upload Cancelled!"));
	startUpdates();
}

function finishUpload(success) {
	// Reset upload variables
	isUploading = false;
	$("#input_file_upload").val("");

	// Set some values in the modal dialog
	$("#modal_upload h4").text(T("Upload Complete!"));
	$("#btn_cancel_upload, #modal_upload p").addClass("hidden");
	$("#modal_upload .close, #modal_upload button[data-dismiss='modal']").removeClass("hidden");

	if (success) {
		// If everything went well, update the GUI immediately
		uploadHasFinished(true);
	} else {
		// In case an upload has been aborted, give the firmware some time to recover
		setTimeout(function() { uploadHasFinished(false); }, 1000);
	}
}

function uploadHasFinished(success) {
	// Make sure the G-Codes and Macro pages are updated
	if (uploadType == "gcode" || uploadType == "start") {
		gcodeUpdateIndex = -1;
		if (currentPage == "files") {
			updateGCodeFiles();
		}
	} else if (uploadType == "macro") {
		macroUpdateIndex = -1;
		if (currentPage == "control" || currentPage == "macros") {
			updateMacroFiles();
		}
	} else if (uploadType == "filament") {
		if (currentPage == "filaments") {
			updateFilaments();
		}
	} else if (uploadType == "menu") {
		updateDisplayFiles();
	} else if (refreshSysFiles) {
		updateSysFiles();
	}

	// Start polling again
	startUpdates();

	// Deal with different upload types
	if (success) {
		// Check if a job is supposed to be started
		if (uploadType == "start") {
			waitingForJobStart = true;
			sendGCode('M32 "' + currentGCodeDirectory + "/" + uploadFileName + '"');
		}

		// Ask for firmware/DWC update if it's safe to do
		else if (lastStatusResponse != undefined && (lastStatusResponse.status == 'I' || lastStatusResponse.status == 'O')) {
			// Test for firmware update before we test for a new config file, because a firmware update includes a reset
			if (uploadFirmwareFile != undefined && uploadDWSFile == undefined && uploadDWSSFile == undefined && uploadDWCFile == undefined) {
				$("#modal_upload").modal("hide");
				showConfirmationDialog(T("Perform Firmware Update?"), T("You have just uploaded a firmware file. Would you like to update your Duet now?"), startFirmwareUpdate);
			} else if ((uploadDWSFile != undefined || uploadDWSSFile != undefined) && uploadFirmwareFile == undefined && uploadDWCFile == undefined) {
				$("#modal_upload").modal("hide");
				showConfirmationDialog(T("Perform WiFi Server Update?"), T("You have just uploaded a Duet WiFi server firmware file. Would you like to install it now?"), startDWSUpdate);
			} else if (uploadDWCFile != undefined && uploadFirmwareFile == undefined && uploadDWSFile == undefined && uploadDWSSFile == undefined) {
				$("#modal_upload").modal("hide");
				showConfirmationDialog(T("Perform Duet Web Control Update?"), T("You have just uploaded a Duet Web Control package. Would you like to install it now?"), startDWCUpdate);
			} else if (uploadFirmwareFile != undefined || uploadDWSFile != undefined || uploadDWSSFile != undefined || uploadDWCFile != undefined) {
				$("#modal_upload").modal("hide");
				showConfirmationDialog(T("Perform Firmware Update?"), T("You have just uploaded multiple firmware files. Would you like to install them now?"), startFirmwareUpdates);
			} else if (uploadIncludedConfig) {
				$("#modal_upload").modal("hide");
				showConfirmationDialog(T("Reboot Duet?"), T("You have just uploaded a config file. Would you like to reboot your Duet now?"), function() {
					// Perform software reset
					sendGCode("M999");
				});
			} else if (uploadedDWC) {
				$("#modal_upload").modal("hide");

				if (sessionPassword != defaultPassword) {
					connect(sessionPassword, false);

					showConfirmationDialog(T("Reload Page?"), T("You have just updated Duet Web Control. Would you like to reload the page now?"), function() {
						sendGCode("M118 P3 S\"{reloadDWC}\"");
					});
				} else {
					sendGCode("M118 P3 S\"{reloadDWC}\"");
				}
			}
		}
	}
}

function startFirmwareUpdates() {
	var sParams = [], fwFile, dwsFile, dwcFile;
	if (uploadFirmwareFile != undefined) {
		fwFile = "0:/sys/" + uploadFirmwareFile;
		sParams.push("0");
	}
	if (uploadDWSSFile != undefined) {
		dwsFile = "0:/sys/" + uploadDWSSFile;
		sParams.push("1");
	} else if (uploadDWSFile != undefined) {
		dwsFile = "0:/sys/" + uploadDWSFile;
		sParams.push("1");
	}
	if (uploadDWCFile != undefined) {
		dwcFile = "0:/sys/" + uploadDWCFile;
		sParams.push("2");
	}

	// Stop status updates so the user doesn't see any potential error messages
	stopUpdates();

	// Move the file(s) into place
	moveFile(fwFile, "0:/sys/" + targetFirmwareFileName + ".bin", function() {
		moveFile(dwsFile, "0:/sys/DuetWiFiServer.bin", function() {
			moveFile(dwcFile, "0:/sys/DuetWebControl.bin", function() {
				// Initiate firmware updates
				var sParam = sParams.join(":");
				sendGCode("M997 S" + sParam);

				// Resume the status update loop
				startUpdates();
			}, startUpdates);
		}, startUpdates);
	}, startUpdates);
}

function startFirmwareUpdate() {
	// Stop status updates so the user doesn't see any potential error messages
	stopUpdates();

	// The filename is hardcoded in the firmware binary, so try to rename the uploaded file first
	moveFile("0:/sys/" + uploadFirmwareFile, "0:/sys/" + targetFirmwareFileName + ".bin", function() {
		// Rename succeeded and flashing can be performed now
		sendGCode("M997 S0");
		startUpdates();
	}, startUpdates);
}

function startDWSUpdate() {
	// Stop status updates so the user doesn't see any potential error messages
	stopUpdates();

	// We prefer DWSS over DWS. Move it into place and start the update
	if (uploadDWSSFile != undefined) {
		moveFile("0:/sys/" + uploadDWSSFile, "0:/sys/DuetWiFiServer.bin", function() {
			// Rename succeeded and flashing can be performed now
			sendGCode("M997 S1");
			startUpdates();
		}, startUpdates);
	} else {
		moveFile("0:/sys/" + uploadDWSFile, "0:/sys/DuetWiFiServer.bin", function() {
			// Rename succeeded and flashing can be performed now
			sendGCode("M997 S1");
			startUpdates();
		}, startUpdates);
	}
}

function startDWCUpdate() {
	// Stop status updates so the user doesn't see any potential error messages
	stopUpdates();

	// The filename is hardcoded in the firmware binary, so try to rename the uploaded file first
	moveFile("0:/sys/" + uploadDWCFile, "0:/sys/DuetWebControl.bin", function() {
		// Rename succeeded and flashing can be performed now
		sendGCode("M997 S2");
		startUpdates();
	}, startUpdates);
}


/* Upload events */

$("#btn_cancel_upload").click(function() {
	cancelUpload();
});

$(".btn-upload").click(function(e) {
	if (!$(this).is(".disabled")) {
		var type = $(this).data("type"), filter = "";
		if (type == "gcode" || type == "start") {
			filter = ".g,.gcode,.gc,.gco,.nc,.ngc,.tap";
		} else if (type == "filament") {
			filter = ".zip";
		} else if (type == "generic") {
			filter=".zip,.bin,.csv,.g,.json,.htm,.html,.ico,.xml,.css,.map,.js,.ttf,.eot,.svg,.woff,.woff2,.jpeg,.jpg,.png,.gz";
		}
		$("#input_file_upload").prop("accept", filter).data("type", type).click();
	}
	e.preventDefault();
});

["start", "gcode", "macro", "filament", "generic"].forEach(function(type) {
	var child = $(".btn-upload[data-type='" + type + "']");

	// Drag Enter
	child.on("dragover", function(e) {
		$(this).removeClass($(this).data("style")).addClass("btn-success");
		e.preventDefault();
		e.stopPropagation();
	});

	// Drag Leave
	child.on("dragleave", function(e) {
		$(this).removeClass("btn-success").addClass($(this).data("style"));
		e.preventDefault();
		e.stopPropagation();
	});

	// Drop
	child.on("drop", function(e) {
		$(this).removeClass("btn-success").addClass($(this).data("style"));
		e.preventDefault();
		e.stopPropagation();

		var files = e.originalEvent.dataTransfer.files;
		if (!$(this).hasClass("disabled") && files != null && files.length > 0) {
			// Start new file upload
			startUpload($(this).data("type"), files, false);
		}
	});
});

$("#input_file_upload").change(function(e) {
	if (this.files.length > 0) {
		// For POST uploads we need file blobs
		startUpload($(this).data("type"), this.files, false);
	}
});

$('#modal_upload').on('hidden.bs.modal', function (e) {
	if (uploadFilesSkipped) {
		showMessage("warning", T("Warning"), T("Some files were not uploaded because they were not suitable for your board."));
	}
})
/* Utility functions for Duet Web Control
 * 
 * written by Christian Hammacher (c) 2016-2017
 * 
 * licensed under the terms of the GPL v3
 * see http://www.gnu.org/licenses/gpl-3.0.html
 */

var heatersInUse;


/* Text formatting */

function formatUploadSpeed(bytesPerSec) {
	if (settings.useKiB) {
		if (bytesPerSec > 1073741824) {		// GiB
			return (bytesPerSec / 1073741824).toFixed(2) + " GiB/s";
		}
		if (bytesPerSec > 1048576) {		// MiB
			return (bytesPerSec / 1048576).toFixed(2) + " MiB/s";
		}
		if (bytesPerSec > 1024) {			// KiB
			return (bytesPerSec / 1024).toFixed(1) + " KiB/s";
		}
	} else {
		if (bytesPerSec > 1000000000) {		// GB
			return (bytesPerSec / 1000000000).toFixed(2) + " GB/s";
		}
		if (bytesPerSec > 1000000) {		// MB
			return (bytesPerSec / 1000000).toFixed(2) + " MB/s";
		}
		if (bytesPerSec > 1000) {			// KB
			return (bytesPerSec / 1000).toFixed(1) + " KB/s";
		}
	}
	return bytesPerSec.toFixed(1) + " B/s";
}

function formatSize(bytes) {
	if (settings.useKiB) {
		if (bytes > 1073741824) {	// GiB
			return (bytes / 1073741824).toFixed(1) + " GiB";
		}
		if (bytes > 1048576) {		// MiB
			return (bytes / 1048576).toFixed(1) + " MiB";
		}
		if (bytes > 1024) {			// KiB
			return (bytes / 1024).toFixed(1) + " KiB";
		}
	} else {
		if (bytes > 1000000000) {	// GB
			return (bytes / 1000000000).toFixed(1) + " GB";
		}
		if (bytes > 1000000) {		// MB
			return (bytes / 1000000).toFixed(1) + " MB";
		}
		if (bytes > 1000) {			// KB
			return (bytes / 1000).toFixed(1) + " KB";
		}
	}
	return bytes + " B";
}

function formatTime(value) {
	value = Math.round(value);
	if (value < 0) {
		value = 0;
	}

	var timeLeft = [], temp;
	if (value >= 3600) {
		temp = Math.floor(value / 3600);
		if (temp > 0) {
			timeLeft.push(temp + "h");
			value = value % 3600;
		}
	}
	if (value >= 60) {
		temp = Math.floor(value / 60);
		if (temp > 0) {
			timeLeft.push((temp > 9 ? temp : "0" + temp) + "m");
			value = value % 60;
		}
	}
	value = value.toFixed(0);
	timeLeft.push((value > 9 ? value : "0" + value) + "s");

	return timeLeft.reduce(function(a, b) { return a + " " + b; });
}

function timeToStr(time) {
	// Should return an ISO-like datetime string like "2016-10-24T15:39:09"
	// Cannot use toISOString() here because it doesn't output the localtime
	var result = "";
	result += time.getFullYear() + "-";
	result += (time.getMonth() + 1) + "-";
	result += time.getDate() + "T";
	result += time.getHours() + ":";
	result += time.getMinutes() + ":";
	result += time.getSeconds();
	return result;
}

function strToTime(str) {
	// Date.parse() doesn't always return correct dates.
	// Hence we must parse it using a regex here
	var re = /(\d+)-(\d+)-(\d+)T(\d+):(\d+):(\d+)/;
	var results;
	if ((results = re.exec(str)) != null) {
		var date = new Date();
		date.setFullYear(results[1]);
		date.setMonth(results[2] - 1);
		date.setDate(results[3]);
		date.setHours(results[4]);
		date.setMinutes(results[5]);
		date.setSeconds(results[6]);
		return date;
	}
	return undefined;
}

function getHeaterStateText(state) {
	switch (state) {
		case 0:
			return T("off");
		case 1:
			return T("standby");
		case 2:
			return T("active");
		case 3:
			return T("fault");
		case 4:
			return T("tuning");
	}
	return T("n/a");
}


/* CSV Parsing */

function parseCSV(str) {
    var arr = [];
    var quote = false;  // true means we're inside a quoted field

    // iterate over each character, keep track of current row and column (of the returned array)
    for (var row = col = c = 0; c < str.length; c++) {
        var cc = str[c], nc = str[c+1];        // current character, next character
		if (arr.length <= row) { arr.push([]); }
		if (arr[row].length <= col) { arr[row].push([""]); }

        // If the current character is a quotation mark, and we're inside a
        // quoted field, and the next character is also a quotation mark,
        // add a quotation mark to the current column and skip the next character
        if (cc == '"' && quote && nc == '"') { arr[row][col] += cc; ++c; continue; }

        // If it's just one quotation mark, begin/end quoted field
        if (cc == '"') { quote = !quote; continue; }

        // If it's a comma and we're not in a quoted field, move on to the next column
        if (cc == ',' && !quote) { ++col; continue; }

        // If it's a newline and we're not in a quoted field, move on to the next
        // row and move to column 0 of that new row
        if (cc == '\n' && !quote) { ++row; col = 0; continue; }

        // Otherwise, append the current character to the current column
        arr[row][col] += cc;
    }
    return arr;
}

function getCSVValue(csvArray, key) {
	if (csvArray.length > 1) {
		var index = csvArray[0].indexOf(key);
		if (index == -1) {
			return undefined;
		}
		return csvArray[1][index].trim();
	}
	return undefined;
}


/* Heaters */

function setHeatersInUse() {
	heatersInUse = [];
	for(var heater = 0; heater < maxHeaters; heater++) {
		var heaterAssigned = (heater == bedHeater);
		heaterAssigned |= (heater == chamberHeater);
		heaterAssigned |= (heater == cabinetHeater);
		heaterAssigned |= (getToolsByHeater(heater).length > 0);
		heatersInUse.push(heaterAssigned);
	}
}


/* Tool Mapping */

var initialTools = "";
$("#table_tools > tbody > tr[data-tool]").each(function() {
	initialTools += this.outerHTML;
});

function setToolMapping(mapping) {
	var mappingHasChanged = (toolMapping == undefined);
	if (!mappingHasChanged) {
		// Add missing fields in case we're talking with an older firmware version
		for(var i = 0; i < mapping.length; i++) {
			if (!mapping[i].hasOwnProperty("number")) {
				// This is rather ugly and should be never used
				mapping[i].number = i + 1;
			}

			if (!mapping[i].hasOwnProperty("name")) {
				mapping[i].name = "";
			}
		}

		// Compare the old tool mapping with the new one
		if (mapping.length != toolMapping.length) {
			mappingHasChanged = true;
		} else {
			for(var i = 0; i < mapping.length; i++) {
				// Stop immediately if anything significant has changed
				if (mapping[i].number != toolMapping[i].number ||
					mapping[i].name != toolMapping[i].name ||
					mapping[i].hasOwnProperty("filament") != toolMapping[i].hasOwnProperty("filament") ||
					mapping[i].heaters.toString() != toolMapping[i].heaters.toString() ||
					mapping[i].drives.toString() != toolMapping[i].drives.toString()
				) {
					mappingHasChanged = true;
					break;
				}

				// If only the filament has changed, update it
				if (mapping[i].hasOwnProperty("filament") && mapping[i].filament != toolMapping[i].filament) {
					setToolFilament(i, mapping[i].filament);
				}
			}
		}
	}

	// See if anything significant has changed
	if (mappingHasChanged) {
		toolMapping = mapping;
		setHeatersInUse();

		// TODO: The web interface has no idea which drive is assigned to which axis/extruder,
		// so the following cannot be fully implemented yet.

		/**
		// Find out which drives may be assigned to XYZ
		xyzAxisMapping = [[0], [1], [2]];
		if (toolMapping != undefined) {
			for(var i = 0; i < toolMapping.length; i++) {
				var tool = toolMapping[i];
				if (tool.hasOwnProperty("axisMap")) {
					for(var k = 0; k < tool.axisMap.length; i++) {
						for(var l = 0; l < tool.axisMap[k].length; l++) {
							var mappedDrive = tool.axisMap[k][l];
							if (xyzAxisMapping[k].indexOf(mappedDrive) == -1) {
								xyzAxisMapping[k].push(mappedDrive);
							}
						}
					}
				}
			}
		}

		// Adjust the column headers of the XYZ position to match this mapping
		if (axisMapping[0].length > 1) {
			var content = "X (";


			content += ")";
		} else {
			$("#th_x").text("X");
		}*/

		return true;
	}
	return false;
}

function setToolFilament(tool, filament) {
	toolMapping[tool].filament = filament;

	var label = "T" + toolMapping[tool].number + ((filament == "") ? "" : (" - " + filament));
	$("#table_tools tr[data-tool='" + toolMapping[tool].number + "'] > th:first-child > span.text-muted").text(label);

	var filamentLabel = (filament == "") ? T("none") : filament;
	$("#page_tools div[data-tool='" + toolMapping[tool].number + "'] dd.filament").text(filamentLabel);
}

function updateFixedToolTemps(rows) {
	settings.defaultActiveTemps.forEach(function(temp) {
		rows.find(".ul-active-temp").append('<li><a href="#" class="heater-temp" data-temp="' + temp + '">' + T("{0} Â°C", temp) + '</a></li>');
		rows.find(".btn-active-temp").removeClass("disabled");
	});

	settings.defaultStandbyTemps.forEach(function(temp) {
		rows.find(".ul-standby-temp").append('<li><a href="#" class="heater-temp" data-temp="' + temp + '">' + T("{0} Â°C", temp) + '</a></li>');
		rows.find(".btn-standby-temp").removeClass("disabled");
	});

	rows.find("input").prop("disabled", !isConnected);
}

function getTool(number) {
	if (toolMapping == undefined) {
		return undefined;
	}

	for(var i = 0; i < toolMapping.length; i++) {
		if (toolMapping[i].hasOwnProperty("number")) {
			if (toolMapping[i].number == number) {
				return toolMapping[i];
			}
		} else if (i + 1 == number) {
			return toolMapping[i];
		}
	}
	return undefined;
}

function getToolsByHeater(heater) {
	if (toolMapping == undefined) {
		return [];
	}

	var result = [];
	for(var i = 0; i < toolMapping.length; i++) {
		for(var k = 0; k < toolMapping[i].heaters.length; k++) {
			if (toolMapping[i].heaters[k] == heater) {
				if (toolMapping[i].hasOwnProperty("number")) {
					result.push(toolMapping[i].number);
				} else {
					result.push(i + 1);
				}
			}
		}
	}
	return result;
}

function setCurrentTool(toolNumber) {
	if (toolMapping == undefined) {
		return;
	}

	// Hide extruder drives that cannot be used
	var hideExtruderInputs = true;
	if (toolNumber >= 0) {
		var drives = getTool(toolNumber).drives;
		for(var i = 0; i < numExtruderDrives; i++) {
			var toolHasDrive = (drives.indexOf(i) != -1) || (i > 0 && vendor == "diabase");
			$("#div_extruders > div > .extr-" + i).toggleClass("hidden", !toolHasDrive);
		}

		hideExtruderInputs = (drives.length < 2) || (vendor == "diabase");
	}

	// Hide whole selection if there is no point showing it
	$("#div_extruders").toggleClass("hidden", hideExtruderInputs);
	if (hideExtruderInputs) {
		$("#div_feedrate, #div_feed").removeClass("col-lg-4").addClass("col-lg-5");
		$("#div_extrude").removeClass("col-lg-1").addClass("col-lg-2");
	} else {
		$("#div_feedrate, #div_feed").addClass("col-lg-4").removeClass("col-lg-5");
		$("#div_extrude").addClass("col-lg-1").removeClass("col-lg-2");

		// Select first available extruder
		if ($('input[name="extruder"]:checked').parent().hasClass("hidden")) {
			$("#div_extruders > div > label:not(.hidden):first-child").click();
		}
	}

	// Underline and highlight current tool
	$("#table_tools > tbody > tr").each(function() {
		$(this).toggleClass("active", $(this).data("tool") == toolNumber);
		$(this).find("th:first-child > a > span:first-child").css("text-decoration", ($(this).data("tool") == toolNumber) ? "underline" : "");
	});

	// Update tools on the Settings page
	$("#page_tools button.btn-select-tool").prop("title", T("Select this tool")).html('<span class="glyphicon glyphicon-pencil"></span> <span>' + T("Select") + '</span>');
	$("#page_tools div[data-tool='" + toolNumber + "'] button.btn-select-tool").prop("title", T("Deselect this tool")).html('<span class="glyphicon glyphicon-remove"></span> <span>' + T("Deselect") + '</span>');
}


/* Control state management */

function enableControls() {
	$(".table-axis-positions td").css("cursor", "pointer");
	$("nav input, #div_tools_heaters input, #div_content input").prop("disabled", false);		// Generic inputs
	$("#page_tools label").removeClass("disabled");												// and on Settings page
	$(".machine-button").removeClass("disabled");

	$(".btn-emergency-stop, .gcode-input button[type=submit], .gcode").removeClass("disabled");	// Navbar
	$(".bed-temp, .gcode, .heater-temp, .btn-upload").removeClass("disabled");					// List items and Upload buttons

	$(".mobile-home-buttons button, #btn_homeall, .table-move a").removeClass("disabled");		// Move buttons
	$("#btn_bed_dropdown").removeClass("disabled");												// Automatic Bed Compensation
	$("#panel_extrude label.btn, #panel_extrude button").removeClass("disabled");				// Extruder Control
	$("#panel_control_misc label.btn").removeClass("disabled");									// ATX Power
	for(var fan = -1; fan < maxFans; fan++) {
		var fanID = (fan == -1) ? "tool": fan;
		$("#slider_fan_control_" + fanID).slider("enable");										// Fan
		$("#slider_fan_job_" + fanID).slider("enable");											// Control
	}

	$("#page_scanner button").removeClass("disabled");											// Scanner
	$("#page_job .checkbox, #btn_baby_down, #btn_baby_up").removeClass("disabled");				// Job Control
	$(".table-fan-control tr > td:not(:first-child) > button").removeClass("disabled");			// Fan Control
	$("#slider_speed").slider("enable");														// Speed Factor
	for(var extr = 0; extr < maxExtruders; extr++) {
		$("#slider_extr_" + extr).slider("enable");												// Extrusion Factors
	}

	$(".online-control").removeClass("hidden");													// G-Code/Macro Files

	$('[data-setting="settingsOnDuet"]').prop("disabled", location.host == "");
	$(".btn-apply-settings, .btn-reset-settings").removeClass("disabled");						// Settings
}

function disableControls() {
	$(".table-axis-positions td").css("cursor", "");
	$("nav input, #div_tools_heaters input, #div_content input").prop("disabled", true);		// Generic inputs
	$("#page_general input, #page_ui input, #page_listitems input").prop("disabled", false);	// ... except ...
	$("#page_tools label").addClass("disabled");												// ... for Settings
	$(".machine-button").addClass("disabled");

	$(".btn-emergency-stop, .gcode-input button[type=submit], .gcode").addClass("disabled");	// Navbar
	$(".bed-temp, .gcode, .heater-temp, .btn-upload").addClass("disabled");						// List items and Upload buttons

	$(".mobile-home-buttons button, #btn_homeall, #table_move_head a").addClass("disabled");	// Move buttons
	$("#btn_bed_dropdown").addClass("disabled");												// Automatic Bed Compensation
	$("#panel_extrude label.btn, #panel_extrude button").addClass("disabled");					// Extruder Control
	$("#panel_control_misc label.btn").addClass("disabled");									// ATX Power
	for(var fan = -1; fan < maxFans; fan++) {
		var fanID = (fan == -1) ? "tool": fan;
		$("#slider_fan_control_" + fanID).slider("disable");									// Fan
		$("#slider_fan_job_" + fanID).slider("disable");										// Control
	}

	$("#page_scanner button").addClass("disabled");												// Scanner
	$("#btn_pause, #page_job .checkbox, #btn_baby_down, #btn_baby_up").addClass("disabled");	// Job Control
	$(".table-fan-control tr > td:not(:first-child) > button").addClass("disabled");			// Fan Control
	$("#slider_speed").slider("disable");														// Speed Factor
	for(var extr = 0; extr < maxExtruders; extr++) {
		$("#slider_extr_" + extr).slider("disable");											// Extrusion Factors
	}

	$(".online-control").addClass("hidden");													// G-Code/Macro Files

	$(".btn-apply-settings, .btn-reset-settings").toggleClass("disabled", $("[data-setting='settingsOnDuet']").is(":checked"));
}


/* Window size queries */

function windowIsXsSm() {
	return window.matchMedia('(max-width: 991px)').matches;
}

function windowIsMdLg() {
	return window.matchMedia('(min-width: 992px)').matches;
}


/* Misc */

function arraysEqual(a, b) {
	if (a != undefined && b != undefined && a.length == b.length) {
		for(var i = 0; i < a.length; i++) {
			if (a[i].constructor === Array && b[i].constructor === Array) {
				if (!arraysEqual(a[i], b[i])) {
					return false;
				}
			} else if (a[i] != b[i]) {
				return false;
			}
		}
		return true;
	}
	return false;
}

function log(style, message) {
	var entry =		'<div class="row alert-' + style + '">';
	entry +=		'<div class="col-xs-3 col-sm-2 col-md-2 col-lg-1 text-center"><strong>' + (new Date()).toLocaleTimeString() + '</strong></div>';
	entry +=		'<div class="col-xs-9 col-sm-10 col-md-10 col-lg-11">' + message + '</div></div>';
	$("#console_log").prepend(entry);
}

var audioContext = new (window.AudioContext || window.webkitAudioContext);
function beep(frequency, duration) {
	var oscillator = audioContext.createOscillator();

	oscillator.type = "sine";
	oscillator.frequency.value = frequency;
	oscillator.connect(audioContext.destination);
	oscillator.start();

	setTimeout(function() {
		oscillator.disconnect();
	}, duration);
}
/* 3D bed visualization for Duet Web Control
 * 
 * written by Christian Hammacher (c) 2016-2017
 * 
 * licensed under the terms of the GPL v3
 * see http://www.gnu.org/licenses/gpl-3.0.html
 */

var scaleZ = 0.5, maxVisualizationZ = 0.25, pointTolerance = 2.0;
var smallIndicatorRadius = 0.01, mediumIndicatorRadius = 0.02, bigIndicatorRadius = 0.05;
var indicatorColor = 0xFFFFFF, indicatorOpacity = 0.4, indicatorOpacityHighlighted = 1.0;

var colorScheme = "terrain";
var scene, camera, renderer, raycaster;
var meshGeometry, meshPlane, meshIndicators, lastIntersection;
var bedProbePoints, probePoints, probeXMin, probeXMax, probeYMin, probeYMax;


function testHeightmap() {
	var csv = 'RepRapFirmware height map file v1\nxmin,xmax,ymin,ymax,radius,spacing,xnum,ynum\n-140.00,140.10,-140.00,140.10,150.00,20.00,15,15\n0,0,0,0,0,-0.139,-0.188,-0.139,-0.202,-0.224,0,0,0,0,0\n0,0,0,-0.058,-0.066,-0.109,-0.141,-0.129,-0.186,-0.198,-0.191,-0.176,0,0,0\n0,0,0.013,-0.008,-0.053,-0.071,-0.087,-0.113,-0.162,-0.190,-0.199,-0.267,-0.237,0,0\n0,0.124,0.076,0.025,-0.026,-0.054,-0.078,-0.137,-0.127,-0.165,-0.201,-0.189,-0.227,-0.226,0\n0,0.198,0.120,0.047,0.089,-0.074,-0.097,-0.153,-0.188,-0.477,-0.190,-0.199,-0.237,-0.211,0\n0.312,0.229,0.198,0.098,0.097,0.004,-0.089,-0.516,-0.150,-0.209,-0.197,-0.183,-0.216,-0.296,-0.250\n0.287,0.263,0.292,0.100,0.190,0.015,-0.102,-0.039,-0.125,-0.149,-0.137,-0.198,-0.188,-0.220,-0.192\n0.378,0.289,0.328,0.172,0.133,0.078,-0.086,0.134,-0.100,-0.150,-0.176,-0.234,-0.187,-0.199,-0.221\n0.360,0.291,0.260,0.185,0.111,0.108,0.024,0.073,-0.024,-0.116,-0.187,-0.252,-0.201,-0.215,-0.187\n0.447,0.397,0.336,0.276,0.180,0.164,0.073,-0.050,-0.049,-0.109,-0.151,-0.172,-0.211,-0.175,-0.161\n0,0.337,0.289,0.227,0.179,0.127,0.086,0.034,-0.039,-0.060,-0.113,-0.108,-0.171,-0.153,0\n0,0.478,0.397,0.374,0.270,0.141,0.085,0.074,0.037,-0.048,-0.080,-0.187,-0.126,-0.175,0\n0,0,0.373,0.364,0.265,0.161,0.139,0.212,0.040,0.046,-0.008,-0.149,-0.115,0,0\n0,0,0,0.346,0.295,0.273,0.148,0.136,0.084,0.024,-0.055,-0.078,0,0,0\n0,0,0,0,0,0.240,0.178,0.084,0.090,0.004,0,0,0,0,0';

	// The first line is a comment generated by RepRapFirmware. Remove it
	csv = csv.substr(csv.indexOf("\n") + 1);

	// Convert the CSV text into an array that we can use
	var csvArray = parseCSV(csv);

	// Get the values that are interesting for us
	var probeRadius = parseFloat(getCSVValue(csvArray, "radius"));
	var xMin = parseFloat(getCSVValue(csvArray, "xmin"));
	var xMax = parseFloat(getCSVValue(csvArray, "xmax"));
	var yMin = parseFloat(getCSVValue(csvArray, "ymin"));
	var yMax = parseFloat(getCSVValue(csvArray, "ymax"));
	var spacing = parseFloat(getCSVValue(csvArray, "spacing"));

	// Convert each point to a vector
	var heightmap = [];
	for(var y = 2; y < csvArray.length; y++) {
		for(var x = 0; x < csvArray[y].length; x++) {
			var value = csvArray[y][x];
			if (value == "0") {
				heightmap.push([xMin + x * spacing, yMin + (y - 2) * spacing, NaN]);
			} else {
				var value = parseFloat(csvArray[y][x]);
				heightmap.push([xMin + x * spacing, yMin + (y - 2) * spacing, value]);
			}
		}
	}

	// Generate 3D mesh
	showHeightmap(heightmap, probeRadius, xMin, yMin);
}

function testBedCompensation(numPoints) {
	var testPoints;
	switch (numPoints) {
		case 3:
			testPoints = [[15.0, 15.0, 0.123], [15.0, 195.0, -0.243], [215.0, 105.0, 0.034]];
			setGeometry("cartesian");
			break;

		case 4:
			testPoints = [[15.0, 15.0, 0.015], [15.0, 185.0, -0.193], [175.0, 185.0, 0.156], [175.0, 15.0, 0.105]];
			setGeometry("cartesian");
			break;

		case 5:
			testPoints = [[15.0, 15.0, 0.007], [15.0, 185.0, -0.121], [175.0, 185.0, -0.019], [175.0, 15.0, 0.193], [95.0, 100.0, 0.05]];
			setGeometry("cartesian");
			break;

		case 7:
			testPoints = [[0.0, 84.0, 0.01], [73.53, -42.45, 0.125], [-73.53, -42.45, 0.25], [0.0, 42.4, 0.0], [36.72, -21.2, -0.125], [-36.72, -21.2, -0.25], [0.0, 0.0, 0.25]];
			setGeometry("delta");
			break;

		case 9:
			testPoints = [[15.0, 15.0, 0.034], [95.0, 15.0, 0.143], [175.0, 15.0, -0.123], [15.0, 100.0, 0.154], [95.0, 100.0, -0.252], [175.0, 100.0, -0.135], [15.0, 185.0, 0.234], [95.0, 185.0, -0.242], [175.0, 185.0, 0.123]];
			setGeometry("cartesian");
			break;

		case 10:
			testPoints = [[0,84.9,0],[49.9,68.69,0],[80.74,26.24,0],[80.74,-26.24,0],[49.9,-68.69,0],[0,-84.9,0],[-49.9,-68.69,0],[-80.74,-26.24,0],[-80.74,26.24,0],[-49.9,68.69,0],[0,0,0]];
			setGeometry("delta");
			break;

		case 17:
			testPoints = [[0,84.9,0.05630809461178765],[49.9,68.69,0.17599528333331518],[80.74,26.24,0.2594756296464064],[80.74,-26.24,0.015530445498113554],[49.9,-68.69,0.23133485970358503],[0,-84.9,0.21997378657053593],[-49.9,-68.69,0.11618119110103399],[-80.74,-26.24,0.2772662322205023],[-80.74,26.24,0.08411930426155993],[-49.9,68.69,0.01151950813684679],[0,42.4,0.131994449059145],[36.72,21.2,0.056566293905866843],[36.72,-21.2,0.25405071944089047],[0,-42.4,0.1763972630845728],[-36.72,-21.2,0.07603902615730086],[-36.72,21.2,0.12579173035981916],[0,0,0.08963820511571098]];
			setGeometry("delta");
			break;

		case 121:
			testPoints = [[-50,-50,0.12002740834777786],[-50,-40,-0.11153931027113302],[-50,-30,0.03726485452325734],[-50,-20,0.10955886411136477],[-50,-10,-0.04435246652525355],[-50,0,-0.0028156396602971867],[-50,10,-0.051632028852817126],[-50,20,-0.05794016520470719],[-50,30,-0.030471271734211446],[-50,40,-0.06971687368573451],[-50,50,-0.12195742398687667],[-40,-50,0.14254362562578415],[-40,-40,-0.08126858523700416],[-40,-30,-0.06198184729114495],[-40,-20,-0.037504449710496],[-40,-10,0.07361124455504224],[-40,0,-0.08754060897951484],[-40,10,0.035879996249150815],[-40,20,-0.09360238058545878],[-40,30,0.11442068820906585],[-40,40,-0.08363311975376284],[-40,50,0.043518350809534076],[-30,-50,-0.057116822070275464],[-30,-40,0.08955138441010302],[-30,-30,0.1185910894111243],[-30,-20,-0.07601355576245762],[-30,-10,-0.005618731185199488],[-30,0,-0.13563892359086296],[-30,10,0.09300977253840119],[-30,20,0.0165485225775021],[-30,30,0.1291417905009324],[-30,40,0.10952998968672502],[-30,50,0.03606211423795047],[-20,-50,0.054808296166161605],[-20,-40,-0.08239703812918384],[-20,-30,-0.029730835473283677],[-20,-20,0.11280340342421669],[-20,-10,-0.0134227744832083],[-20,0,-0.03363528493561929],[-20,10,-0.001022756045073314],[-20,20,0.03156257223821328],[-20,30,0.005150101179566757],[-20,40,0.1342733417639501],[-20,50,0.08662800628200462],[-10,-50,-0.11251500729320446],[-10,-40,-0.10152120320535729],[-10,-30,-0.13947973240148234],[-10,-20,-0.0055081718158396685],[-10,-10,0.012406068888191889],[-10,0,0.019127386274646805],[-10,10,-0.060339695184274754],[-10,20,0.09475372058120354],[-10,30,0.04504534407928413],[-10,40,0.09264861231075873],[-10,50,-0.12986678193884427],[0,-50,0.044021329858792965],[0,-40,0.12602510485509355],[0,-30,-0.1358244106091512],[0,-20,0.04885005208852744],[0,-10,-0.07742114874082186],[0,0,-0.002289637865387117],[0,10,-0.00815542589988023],[0,20,0.0011158536939211317],[0,30,0.10700301631570701],[0,40,-0.054518657864691365],[0,50,0.017084666415419524],[10,-50,-0.11298043262249217],[10,-40,-0.14008436368192323],[10,-30,-0.1271727984317276],[10,-20,0.06333304984467969],[10,-10,0.060342445616347384],[10,0,0.08104223768183395],[10,10,-0.0024036494807740502],[10,20,0.003092740116676751],[10,30,-0.016183497677099833],[10,40,-0.021855589456963597],[10,50,0.06043936839655179],[20,-50,0.11820755728621879],[20,-40,-0.01702291734385255],[20,-30,-0.06449113235394623],[20,-20,-0.14055632865897286],[20,-10,-0.01994879304716839],[20,0,0.003604964896454832],[20,10,-0.04220968285722817],[20,20,0.01872527251135445],[20,30,0.035094267945042175],[20,40,0.08625901330376684],[20,50,0.14685416531566567],[30,-50,0.11423465093082014],[30,-40,-0.010328196199440342],[30,-30,0.07359570163736166],[30,-20,-0.016141161970606156],[30,-10,-0.061684955393020456],[30,0,0.12939173181232735],[30,10,-0.02237449658065016],[30,20,-0.14749891451903582],[30,30,0.1473553275042116],[30,40,-0.050145519405154326],[30,50,0.04250744539879927],[40,-50,0.14224393364505666],[40,-40,0.037228715024125926],[40,-30,0.06499028067572622],[40,-20,0.061523275439891195],[40,-10,-0.011061591645928103],[40,0,0.061033484764153975],[40,10,0.1205016965624641],[40,20,0.023848178520022387],[40,30,-0.0021676609838422677],[40,40,-0.06590936366459543],[40,50,0.08999587447670003],[50,-50,-0.13398415024828852],[50,-40,0.09659652345656729],[50,-30,-0.12894582833974588],[50,-20,0.08685982032429304],[50,-10,0.0007890629119364334],[50,0,-0.06152535417010243],[50,10,0.13123240948087636],[50,20,-0.07158442576405022],[50,30,-0.14788950165050954],[50,40,-0.1278763640481279],[50,50,0.07007486386303274]];
			setGeometry("delta");
			break;
	}

	showBedCompensation(testPoints);
}

function getHeightmap(file) {
	if (!isConnected) {
		return;
	}

	if (file == undefined) {
		file = "0:/sys/heightmap.csv";
	}

	$.ajax(ajaxPrefix + "rr_download?name=" + encodeURIComponent(file), {
		dataType: "html",
		cache: false,
		global: false,
		error: function() {
			showMessage("warning", T("Failed to download height map"), T("Failed to download and process {0} from the SD card. Have you run G29 yet?"));
		},
		success: function(csv) {
			// Are we dealing with a proper heightmap file?
			var version = undefined;
			if (csv.indexOf("RepRapFirmware height map file v1") == 0) {
				version = 1;
			} else if (csv.indexOf("RepRapFirmware height map file v2") == 0) {
				version = 2;
			} else {
				// No - open it in the text editor
				showEditDialog(file, csv, function(value) {
					uploadTextFile(file, value, function() {
						if (currentPage == "files") {
							updateGCodeFiles();
						} else if (currentPage == "macros") {
							updateMacroFiles();
						} else if (currentPage == "settings") {
							updateSysFiles();
						}
					});
				});
				return;
			}

			// The first line is a comment generated by RepRapFirmware. Remove it
			csv = csv.substr(csv.indexOf("\n") + 1);

			// Convert the CSV text into an array that we can use
			var csvArray = parseCSV(csv);

			// Get the values that are interesting for us
			var probeRadius = parseFloat(getCSVValue(csvArray, "radius"));
			var xMin = parseFloat(getCSVValue(csvArray, "xmin"));
			//var xMax = parseFloat(getCSVValue(csvArray, "xmax"));		// unreliable!
			var yMin = parseFloat(getCSVValue(csvArray, "ymin"));
			//var yMax = parseFloat(getCSVValue(csvArray, "ymax"));		// unreliable!
			var xspacing, yspacing;
			if (version == 1) {
				xspacing = yspacing = parseFloat(getCSVValue(csvArray, "spacing"));
			} else {
				xspacing = parseFloat(getCSVValue(csvArray, "xspacing"));
				yspacing = parseFloat(getCSVValue(csvArray, "yspacing"));
			}

			// Convert each point to a vector and add it to the vector list
			var heightmap = [];
			for(var y = 2; y < csvArray.length; y++) {
				for(var x = 0; x < csvArray[y].length; x++) {
					var value = csvArray[y][x].trim();
					if (value == "0") {
						heightmap.push([xMin + x * xspacing, yMin + (y - 2) * yspacing, NaN]);
					} else {
						var value = parseFloat(csvArray[y][x]);
						heightmap.push([xMin + x * xspacing, yMin + (y - 2) * yspacing, value]);
					}
				}
			}

			// Generate and show 3D mesh
			try {
				// If we supply invalid values from the CSV file, this function will throw an error
				showHeightmap(heightmap, probeRadius, xMin, yMin);
			} catch (e) {
				this.error();
			}
		}
	});
}

function clearBedPoints() {
	$("#a_show_bed_points").parent().addClass("disabled");

	bedProbePoints = undefined;
}

function showBedCompensation(points) {
	$("#a_show_bed_points").parent().removeClass("disabled");

	bedProbePoints = points;
	showHeightmap(points);
}

function showHeightmap(points, probeRadius, xMin, yMin) {
	// Generate stats
	var xMax, yMax;
	var minDiff, maxDiff, numProbePoints = 0, rmsError = 0, meanError = 0;
	for(var i = 0; i < points.length; i++) {
		var z = points[i][2];
		if (!isNaN(z)) {
			var x = points[i][0];
			var y = points[i][1];
			if (xMin == undefined || xMin > x) { xMin = x; }
			if (xMax == undefined || xMax < x) { xMax = x; }
			if (yMin == undefined || yMin > y) { yMin = y; }
			if (yMax == undefined || yMax < y) { yMax = y; }

			numProbePoints++;
			meanError += z;
			rmsError += z * z;
			if (minDiff == undefined || minDiff > z) { minDiff = z; }
			if (maxDiff == undefined || maxDiff < z) { maxDiff = z; }
		}
	}

	if (numProbePoints > 0) {
		rmsError = Math.sqrt(((rmsError * numProbePoints) - (meanError * meanError))) / numProbePoints;
		meanError = meanError / numProbePoints;
	}

	// Try to prepare a mesh geometry for the final visualization
	probePoints = points;
	meshGeometry = generateMeshGeometry(points, probeRadius, xMin, xMax, yMin, yMax);
	if (meshGeometry == undefined) {
		showMessage("warning", T("Cannot generate 3D visualization"), T("Failed to generate mesh for bed points!"));
		return;
	}

	// Calculate probe area lengths and size
	var probeArea = NaN;
	if (xMin == undefined || xMax == undefined || yMin == undefined || yMax == undefined) {
		probeXMin = probeXMax = probeYMin = probeYMax = undefined;
	} else {
		probeXMin = xMin;
		probeXMax = xMax;
		probeYMin = yMin;
		probeYMax = yMax;
		probeArea = Math.abs((xMin - xMax) * (yMin - yMax));
	}

	if (probeRadius != undefined && geometry == "delta") {
		probeArea = probeRadius * probeRadius * Math.PI;
	}

	// Display them
	$("#num_probe_points").text(numProbePoints);
	$("#probing_radius").text((probeRadius == undefined) ? T("n/a") : T("{0} mm", probeRadius));
	$("#probe_area").text((isNaN(probeArea)) ? T("n/a") : T("{0} cmÂ²", (probeArea / 100).toFixed(1)));
	$("#max_deviations").text(T("{0} / {1} mm", (minDiff == undefined) ? T("n/a") : minDiff.toFixed(3), (maxDiff == undefined) ? T("n/a") : maxDiff.toFixed(3)));
	$("#mean_error").text(T("{0} mm", meanError.toFixed(3)));
	$("#rms_error").text(T("{0} mm", rmsError.toFixed(3)));

	// Show modal dialog
	$("#modal_bed").modal("show");
}

function getNearestZOnRing(points, x, y) {
	// Get point that is closest to X+Y
	var point, delta = undefined;
	for(var i = 0; i < points.length; i++) {
		var deltaNew = Math.sqrt(Math.pow(x - points[i][0], 2) + Math.pow(y - points[i][1], 2));
		if (delta == undefined || deltaNew < delta) {
			point = points[i];
			delta = deltaNew;
		}
	}

	// Return its Z value
	return (delta == undefined) ? NaN : point[2];
}

function getNearestZOnGrid(points, x, y, maxDelta) {
	// Get the point that is closest to X+Y
	var point, delta = undefined;
	for(var i = 0; i < points.length; i++) {
		var deltaNew = Math.sqrt(Math.pow(x - points[i][0], 2) + Math.pow(y - points[i][1], 2));
		if (delta == undefined || deltaNew < delta) {
			point = points[i];
			delta = deltaNew;
		}
	}

	// Check if we exceed the maximum allowed delta
	if (delta == undefined || (maxDelta != undefined && delta > maxDelta)) {
		return NaN;
	}

	// Otherwise return the closest Z coordinate of this point
	return point[2];
}

function generateMeshGeometry(probePoints, probeRadius, xMin, xMax, yMin, yMax) {
	/** Delta visualization for old-fashioned probe points **/

	if (geometry == "delta" && probePoints.length <= 17) {
		// Check if we need to set the probing radius
		if (probeRadius == undefined) {
			probeRadius = 0;
		}

		// If we have a reasonably small number of probe points, try to group them by their radii
		var radiiGroups = [], zeroPoint = undefined, probeRadius = 0;
		for(var i = 0; i < probePoints.length; i++) {
			var radius = Math.sqrt(Math.pow(probePoints[i][0], 2) + Math.pow(probePoints[i][1], 2));
			if (radius > 0) {
				var groupFound = false;
				for(var k = 0; k < radiiGroups.length; k++) {
					if (Math.abs(radiiGroups[k][0] - radius) < pointTolerance) {
						radiiGroups[k].push(probePoints[i]);
						groupFound = true;
						break;
					}
				}

				if (!groupFound) {
					radiiGroups.push([radius, probePoints[i]]);
				}

				if (radius > probeRadius) {
					probeRadius = radius;
				}
			} else {
				zeroPoint = probePoints[i];
			}
		}

		// Check if the determined groups are valid
		var groupingOkay = (zeroPoint != undefined) && (radiiGroups.length > 0);
		var maxPointsPerGroup = 1;
		for(var i = 0; i < radiiGroups.length; i++) {
			// Each group must have more than three entries
			if (radiiGroups[i].length < 4) {
				groupingOkay = false;
				break;
			}

			// Check how many max. points per group we have
			if (radiiGroups[i].length > maxPointsPerGroup + 1) {
				maxPointsPerGroup = radiiGroups[i].length - 1;
			}
		}

		// Everything OK - we can visualize a typical delta probe point grid
		if (groupingOkay) {
			radiiGroups = radiiGroups.sort(function(a, b) { return a[0] > b[0]; });

			// Generate a geometry with 3*maxPointsPerGroup points per circle segment, because the probe points on
			// the inner circle(s) are usually rotated by a certain amount
			var ringGeometry = new THREE.RingGeometry(0.000000001, 0.5, maxPointsPerGroup * 3, radiiGroups.length);

			for(var i = 0; i < ringGeometry.vertices.length; i++) {
				var vRadius = Math.sqrt(Math.pow(ringGeometry.vertices[i].x, 2) + Math.pow(ringGeometry.vertices[i].y, 2));
				if (vRadius < 0.0001) {
					// If the radius of this vertex is extremely small, treat it as the zero point
					ringGeometry.vertices[i].z = zeroPoint[2] * scaleZ;
				} else {
					var rGroupIndex = Math.round(vRadius / 0.25) - 1;
					if (rGroupIndex < 0 || rGroupIndex >= radiiGroups.length) {
						console.log("WARNING: Failed to find point group near vRadius=" + vRadius);
					} else {
						// Because extra segments are generated, the getNearestZ function tends to fail for extremely small Y
						// values. Hence we round it to 0 in this case to avoid interrupts of the grid surface
						var x = ringGeometry.vertices[i].x * probeRadius * 2;
						if (x > -0.0001 && x < 0.0001) { x = 0; }
						var y = ringGeometry.vertices[i].y * probeRadius * 2;
						if (y > -0.0001 && y < 0.0001) { y = 0; }
						ringGeometry.vertices[i].z = getNearestZOnRing(radiiGroups[rGroupIndex].slice(1), x, y) * scaleZ;
					}
				}
			}

			return ringGeometry;
		}
	}


	/** Cartesian 3-point and 5-point bed compensation **/

	if (geometry != "delta" && (probePoints.length == 3 || probePoints.length == 5)) {
		var planeGeometry = new THREE.Geometry();

		// Generate vertices
		for(var i = 0; i < probePoints.length; i++) {
			var x = (probePoints[i][0] - xMin) / (xMax - xMin) - 0.5;
			var y = (probePoints[i][1] - yMin) / (yMax - yMin) - 0.5;
			var z = probePoints[i][2] * scaleZ;

			planeGeometry.vertices.push(new THREE.Vector3(x, y, z));
		}

		// Generate faces
		if (probePoints.length == 3) {
			planeGeometry.faces.push(new THREE.Face3(0, 1, 2));
		} else {
			planeGeometry.faces.push(new THREE.Face3(0, 1, 4));
			planeGeometry.faces.push(new THREE.Face3(1, 2, 4));
			planeGeometry.faces.push(new THREE.Face3(2, 3, 4));
			planeGeometry.faces.push(new THREE.Face3(3, 0, 4));
		}

		return planeGeometry;
	}


	/** New grid-based compensation **/

	// Find out how many different X+Y coordinates are used
	var xPoints = [], yPoints = [];
	for(var i = 0; i < probePoints.length; i++) {
		var z = probePoints[i][2];
		if (!isNaN(z)) {
			var x = probePoints[i][0], y = probePoints[i][1];
			if (xPoints.indexOf(x) == -1) {
				xPoints.push(x);
			}
			if (yPoints.indexOf(y) == -1) {
				yPoints.push(y);
			}
		}
	}

	// Generate plane geometry for grid
	var width = (xMax - xMin);
	var height = (yMax - yMin);
	var planeWidth = (width < height) ? Math.abs(width / height) : 1.0;
	var planeHeight = (height < width) ? Math.abs(height / width) : 1.0;
	var planeGeometry = new THREE.PlaneGeometry(planeWidth, planeHeight, xPoints.length - 1, yPoints.length - 1);
	for(var i = planeGeometry.vertices.length - 1; i >= 0; i--) {
		var x = ((planeGeometry.vertices[i].x / planeWidth) + 0.5) * width + xMin;
		var y = ((planeGeometry.vertices[i].y / planeHeight) + 0.5) * height + yMin;
		var z = getNearestZOnGrid(probePoints, x, y) * scaleZ;

		planeGeometry.vertices[i].z = z;
	}

	// Add extra faces to each top row to avoid zig-zag lines
	var yCurrent = undefined;
	for(var i = 1; i < planeGeometry.vertices.length / 2; i++) {
		var vertex = planeGeometry.vertices[i];
		var prevVertex = planeGeometry.vertices[i - 1];
		if (!isNaN(prevVertex.z) && isNaN(vertex.z)) {
			var yPoint = vertex.y;
			if (yCurrent == undefined || yCurrent > yPoint) {
				// We are at the last defined point in this row
				yCurrent = yPoint;

				// Find the next two points below and below+right to this one
				var a = undefined, b;
				for(var k = i + 1; k < planeGeometry.vertices.length - 1; k++) {
					var nextVertex = planeGeometry.vertices[k];
					if (nextVertex.x == prevVertex.x && nextVertex.y == planeGeometry.vertices[k + 1].y) {
						a = k;
						b = k + 1;
						break;
					}
				}

				// If that succeeds add a new face
				if (a != undefined && !isNaN(planeGeometry.vertices[a].z) && !isNaN(planeGeometry.vertices[b].z)) {
					var face = new THREE.Face3(a, b, i - 1);
					planeGeometry.faces.push(face);
				}
			}
		}
	}

	// Add extra faces to each bottom row to avoid zig-zag lines
	var prevVertex = undefined;
	for(var i = Math.floor(planeGeometry.vertices.length / 2); i < planeGeometry.vertices.length; i++) {
		var vertex = planeGeometry.vertices[i];

		// Check if this is the first defined point in this row
		if (prevVertex != undefined && prevVertex.y == vertex.y && isNaN(prevVertex.z) && !isNaN(vertex.z)) {
			// Find the two points above and above+left to this one
			var a = undefined, b;
			for(var k = i - 1; k > 0; k--) {
				var prevVertex = planeGeometry.vertices[k];
				var prev2Vertex = planeGeometry.vertices[k - 1];
				if (prevVertex.x == vertex.x && prevVertex.y == planeGeometry.vertices[k - 1].y) {
					a = k - 1;
					b = k;
					break;
				}
			}

			// If that succeeds add a new face
			if (a != undefined && !isNaN(planeGeometry.vertices[a].z) && !isNaN(planeGeometry.vertices[b].z)) {
				var face = new THREE.Face3(a, b, i);
				planeGeometry.faces.push(face);
			}
		}
		prevVertex = vertex;
	}

	// Remove all the points and faces that have invalid values
	for(var i = planeGeometry.vertices.length - 1; i >= 0; i--) {
		if (isNaN(planeGeometry.vertices[i].z)) {
			// Remove and rearrange the associated face(s)
			for(var k = planeGeometry.faces.length - 1; k >= 0; k--) {
				var face = planeGeometry.faces[k];
				if (face.a == i || face.b == i || face.c == i) {
					planeGeometry.faces.splice(k, 1);
				} else {
					if (face.a > i) {
						face.a--;
					}
					if (face.b > i) {
						face.b--;
					}
					if (face.c > i) {
						face.c--;
					}
				}
			}

			// Remove this vertex
			planeGeometry.vertices.splice(i, 1);
		}
	}

	return planeGeometry;
}

function getColorByZ(modelZ) {
	var z = modelZ / scaleZ;

	// Terrain color scheme (i.e. from blue to red, asymmetric)
	if (colorScheme == "terrain") {
		z = Math.max(Math.min(z, maxVisualizationZ), -maxVisualizationZ);
		var hue = 240 - ((z + maxVisualizationZ) / maxVisualizationZ) * 120;
		return new THREE.Color("hsl(" + hue + ",100%,45%)");
	}

	// Default color scheme (i.e. the worse the redder, symmetric)
	var hue = 120 - Math.min(Math.abs(z), maxVisualizationZ) / maxVisualizationZ * 120;
	return new THREE.Color("hsl(" + hue + ",100%,45%)");
}

function setFaceColors(geometry) {
	for(var i = 0; i < geometry.faces.length; i++) {
		var face = geometry.faces[i];
		var a = getColorByZ(geometry.vertices[face.a].z);
		var b = getColorByZ(geometry.vertices[face.b].z);
		var c = getColorByZ(geometry.vertices[face.c].z);

		if (face.vertexColors.length < 3) {
			face.vertexColors = [a, b, c];
		} else {
			face.vertexColors[0].copy(a);
			face.vertexColors[1].copy(b);
			face.vertexColors[2].copy(c);
		}
	}
	geometry.colorsNeedUpdate = true;
}

function translateGridPoint(meshGeometry, vector) {
	var x, y, z = vector.z / scaleZ;
	if (meshGeometry.type == "PlaneGeometry") {
		x = (vector.x / meshGeometry.parameters.width + 0.5) * (probeXMax - probeXMin) + probeXMin;
		y = (vector.y / meshGeometry.parameters.height + 0.5) * (probeYMax - probeYMin) + probeYMin;
	} else if (meshGeometry.type == "Geometry") {
		x = (vector.x + 0.5) * (probeXMax - probeXMin) + probeXMin;
		y = (vector.y + 0.5) * (probeYMax - probeYMin) + probeYMin;
	} else {
		x = vector.x * (probeXMax - probeXMin) / 2;
		y = vector.y * (probeYMax - probeYMin) / 2;
	}

	return new THREE.Vector3(x, y, z);
}

function generateIndicators(meshGeometry) {
	var indicators = [], centerPointGenerated = false;

	for(var i = 0; i < meshGeometry.vertices.length; i++) {
		// Convert world coordinate to "real" probe coordinates
		var x = meshGeometry.vertices[i].x;
		var y = meshGeometry.vertices[i].y;
		var z = meshGeometry.vertices[i].z;
		var trueProbePoint = translateGridPoint(meshGeometry, new THREE.Vector3(x, y, z));

		// Skip center point if it already exists
		if (Math.sqrt(trueProbePoint.x*trueProbePoint.x + trueProbePoint.y*trueProbePoint.y) < pointTolerance) {
			if (centerPointGenerated) {
				continue;
			}
			centerPointGenerated = true;
		}

		// FIXME: Implement this for delta geometries as well
		if (meshGeometry.type != "RingGeometry") {
			// Calculate the actual height from the model.
			// Since we're using double precision this should be accurate enough
			trueProbePoint.z = z / scaleZ;
		}

		// If we have a close point, create a new indicator
		if (!isNaN(trueProbePoint.z)) {
			var radius =	(probePoints.length > 64) ? smallIndicatorRadius :
							(probePoints.length > 9) ? mediumIndicatorRadius :
							 bigIndicatorRadius;
			var sphereGeometry = new THREE.SphereGeometry(radius);
			sphereGeometry.applyMatrix(new THREE.Matrix4().makeTranslation(x, y, z));

			var material = new THREE.MeshBasicMaterial({ color: indicatorColor, opacity: indicatorOpacity, transparent: true });
			var sphere = new THREE.Mesh(sphereGeometry, material);
			sphere.coords = trueProbePoint;

			indicators.push(sphere);
		}
	}

	return indicators;
}

$("#modal_bed").on("shown.bs.modal", function () {
	if (meshGeometry == undefined) {
		// Don't proceed if we couldn't generate a mesh
		return;
	}

	// Get boundaries
	var width = $("#div_visualization").width();
	var height = $("#div_visualization").height();

	// Create THREE context
	scene = new THREE.Scene();

	camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
	camera.position.set(1.5, 1.5, 1.5);
	camera.up = new THREE.Vector3(0, 0, 1);

	renderer = new THREE.WebGLRenderer();
	renderer.setSize(width, height);

	// Allow grid to be moved and rotated by THREE OrbitControl
	var controls = new THREE.OrbitControls(camera, renderer.domElement);

	// Show legend+canvas div and insert WebGL element
	$("#div_visualization_placeholder").addClass("hidden");
	$("#div_visualization, #div_legend").removeClass("hidden");
	$("#div_visualization").html(renderer.domElement);
	$("#div_visualization > canvas").mousemove(canvasMouseMove).tooltip({ title: function() { return canvasTitle.split('\n').join("<br/>"); }, html: true, trigger: "manual" }).click(canvasClick);
	$("#modal_bed div.modal-content").resize();

	// Apply colors to geometry
	setFaceColors(meshGeometry);

	// Make 3D mesh
	var material = new THREE.MeshBasicMaterial({ vertexColors: THREE.VertexColors, side: THREE.DoubleSide });
	meshPlane = new THREE.Mesh(meshGeometry, material);
	scene.add(meshPlane);

	// Make indicators
	meshIndicators = generateIndicators(meshGeometry);
	meshIndicators.forEach(function(indicator) {
		scene.add(indicator);
	});

	// Make axis arrows
	var xMin = -0.6, yMin = -0.6;
	if (meshGeometry.hasOwnProperty("parameters") && meshGeometry.parameters.hasOwnProperty("width")) {
		xMin = meshGeometry.parameters.width * -0.5 - 0.1;
		yMin = meshGeometry.parameters.height * -0.5 - 0.1;
	}

	var xAxis = new THREE.ArrowHelper(new THREE.Vector3(1, 0, 0), new THREE.Vector3(xMin, yMin, 0), 0.5, 0xFF0000);
	var yAxis = new THREE.ArrowHelper(new THREE.Vector3(0, 1, 0), new THREE.Vector3(xMin, yMin, 0), 0.5, 0x00FF00);
	var zAxis = new THREE.ArrowHelper(new THREE.Vector3(0, 0, 1), new THREE.Vector3(xMin, yMin, 0), 0.5, 0x0000FF);
	scene.add(xAxis);
	scene.add(yAxis);
	scene.add(zAxis);

	// Make grid on XY plane
	var grid = new THREE.GridHelper(1.1, 15);
	grid.rotation.x = -Math.PI / 2;
	scene.add(grid);

	// Make raycaster
	raycaster = new THREE.Raycaster();

	// Render scene
	var render = function () {
		if (renderer != undefined) {
			requestAnimationFrame(render);
			renderer.render(scene, camera);
		}
	};
	render();
});

$("#modal_bed").on("hidden.bs.modal", function () {
	renderer.dispose();
	scene = camera = renderer = raycaster = undefined;

	$("#div_visualization").html("");
	$("#div_visualization_placeholder").removeClass("hidden");
	$("#div_visualization, #div_legend").addClass("hidden");
});

function canvasMouseMove(e) {
	if (e.pageX == undefined || probeXMin == undefined) {
		return;
	}

	// Try to get the Z value below the cursor
	// For that we need normalized X+Y coordinates between -1.0 and 1.0
	var mouse = new THREE.Vector2();
	var offset = $(this).offset();
	mouse.x = (e.pageX - offset.left) / $(this).width() * 2 - 1;
	mouse.y = -(e.pageY - offset.top) / $(this).height() * 2 + 1;

	// Is the cursor on a point indicator?
	raycaster.setFromCamera(mouse, camera);
	var intersection = raycaster.intersectObjects(meshIndicators);
	if (lastIntersection != undefined &&
		(intersection.length == 0 || intersection[0] != lastIntersection)) {
		lastIntersection.object.material.opacity = indicatorOpacity;
		lastIntersection = undefined;
	}

	var intersectionPoint = undefined;
	if (intersection.length > 0) {
		if (intersection[0] != lastIntersection) {
			lastIntersection = intersection[0];
			lastIntersection.object.material.opacity = indicatorOpacityHighlighted;
		}
		intersectionPoint = intersection[0].object.coords;
	}

	// Show the tooltip on md/lg devices and store it for xs/sm devices
	if (intersectionPoint == undefined) {
		updateCanvasTitle(undefined);
	} else {
		updateCanvasTitle(T("X: {0} mm\nY: {1} mm\nZ: {2} mm",
			intersectionPoint.x.toFixed(1), intersectionPoint.y.toFixed(1), intersectionPoint.z.toFixed(3)),
			e.pageX - offset.left, e.pageY - offset.top);
	}
}

var canvasTooltip, canvasTitle;
function updateCanvasTitle(title, x, y) {
	var canvas = $("#div_visualization > canvas");
	if (title == undefined) {
		// Remove title
		canvasTitle = undefined;

		// Hide tooltip if it exists
		if (canvasTooltip != undefined) {
			canvas.tooltip("hide");
			canvasTooltip = undefined;
		}
	} else {
		// Set title
		canvasTitle = title;

		// Show info on md/lg screens
		if (!windowIsXsSm()) {
			// Show tooltip
			if (canvasTooltip == undefined) {
				canvas.tooltip("show");
				canvasTooltip = $("#div_visualization > div.tooltip");
			}

			// Reposition tooltip
			canvasTooltip.css("left", x + 15 - canvasTooltip.outerWidth() / 2).css("top", y - canvasTooltip.outerHeight());
		}
	}
}

function canvasClick(e) {
	if (windowIsXsSm() && canvasTitle != undefined) {
		// Show message on xs/sm devices because the tooltip isn't really working there
		alert(canvasTitle);
	}
}

$("#modal_bed > div > div.modal-content").resize(function() {
	var contentHeight = $(this).height();
	var headerHeight = $("#modal_bed > div > div > div.modal-header").outerHeight();
	var footerHeight = $("#modal_bed > div > div > div.modal-footer").outerHeight();

	// Set body height
	var bodyHeight = contentHeight - headerHeight - footerHeight;
	$("#modal_bed > div > div > div.modal-body").css("height", bodyHeight);

	// Set canvas height
	var childrenHeight = 45; // top+bottom margins
	$("#modal_bed > div > div > div.modal-body").children().each(function() {
		if ($(this).children("#div_visualization").length == 0) {
			childrenHeight += $(this).outerHeight();
		}
	});

	var canvasHeight = bodyHeight - childrenHeight;
	$("#div_visualization, #div_legend").css("height", canvasHeight + "px");
	$("#div_visualization_placeholder > div").css("height", canvasHeight + "px").css("line-height", canvasHeight + "px");

	if (camera != undefined) {
		var canvasWidth = $("#div_visualization").width();

		camera.aspect = canvasWidth / canvasHeight;
		camera.updateProjectionMatrix();

		renderer.setSize(canvasWidth, canvasHeight);
	}

	// Resize and redraw legend canvas
	var canvas = document.getElementById("canvas_legend");
	canvas.height = canvasHeight;
	canvas.width = $("#canvas_legend").parent().width();
	canvas.style.width = canvas.width + "px";
	canvas.style.height = canvasHeight + "px";
	var legendWidth = canvas.width;
	var context = canvas.getContext("2d");

	// clear background
	context.rect(0, 0, legendWidth, canvasHeight);
	context.fillStyle = "black";
	context.fill();

	// annotations above gradient
	context.font = "14px Helvetica";
	context.textAlign = "center";
	context.fillStyle = "white";
	context.fillText(T("Scale:"), legendWidth / 2, 21);
	context.fillText(T("{0} mm", maxVisualizationZ), legendWidth / 2, 44);
	context.fillText(T("or more"), legendWidth / 2, 60);

	// scale gradient
	var showAxes = canvasHeight > 180;
	var scaleHeight = showAxes ? (canvasHeight - 139) : (canvasHeight - 96);
	if (colorScheme == "terrain") {
		scaleHeight -= 16;
	}

	var gradient = context.createLinearGradient(0, 66, 0, 66 + scaleHeight);
	if (colorScheme == "terrain") {
		gradient.addColorStop(0.0, "hsl(0,100%,45%)");
		gradient.addColorStop(0.25, "hsl(60,100%,45%)");
		gradient.addColorStop(0.5, "hsl(120,100%,45%)");
		gradient.addColorStop(0.75, "hsl(180,100%,45%)");
		gradient.addColorStop(1.0, "hsl(240,100%,45%)");
	} else {
		gradient.addColorStop(0.0, "hsl(0,100%,45%)");
		gradient.addColorStop(0.5, "hsl(60,100%,45%)");
		gradient.addColorStop(1.0, "hsl(120,100%,45%)");
	}
	context.fillStyle = gradient;
	context.fillRect(legendWidth / 2 - 12, 66, 24, scaleHeight);

	// annotation below gradient
	context.fillStyle = "white";
	if (colorScheme == "terrain") {
		context.fillText(T("{0} mm", -maxVisualizationZ), legendWidth / 2, scaleHeight + 82);
		context.fillText(T("or less"), legendWidth / 2, scaleHeight + 98);
		scaleHeight += 16;
	} else {
		context.fillText(T("{0} mm", "0.00"), legendWidth / 2, scaleHeight + 82);
	}

	// axes
	if (showAxes) {
		context.fillText(T("Axes:"), legendWidth / 2, scaleHeight + 109);
		context.font = "bold 14px Helvetica";
		context.fillStyle = "rgb(255,0,0)";
		context.fillText("X", legendWidth / 3, scaleHeight + 129);
		context.fillStyle = "rgb(0,255,0)";
		context.fillText("Y", legendWidth / 2, scaleHeight + 129);
		context.fillStyle = "rgb(0,0,255)";
		context.fillText("Z", 2 * legendWidth / 3, scaleHeight + 129);
	}
});

$("#btn_top_view").click(function() {
	camera.position.set(0, 0, 2);
	camera.rotation.set(0, 0, 0);
	camera.updateProjectionMatrix();
});

$("#a_show_bed_points").click(function(e) {
	if (bedProbePoints != undefined) {
		showBedCompensation(bedProbePoints);
	}
	e.preventDefault();
});

$("#a_show_heightmap").click(function(e) {
	getHeightmap();
	e.preventDefault();
});

$(".color-scheme").click(function(e) {
	colorScheme = $(this).data("scheme");

	setFaceColors(meshGeometry);
	$("#modal_bed > div > div.modal-content").resize();

	e.preventDefault();
});
